//! zinc
/*
区域采样工具
*/
library RegionUtils {
    public struct triangleXY [] {
        static real x = 0.0 , y = 0.0;
        // 在给定三角形区域内随机生成一个点
        // 参数说明:
        // @param ax,ay - 三角形顶点A的坐标
        // @param bx,by - 三角形顶点B的坐标
        // @param cx,cy - 三角形顶点C的坐标
        // 返回值:
        // 通过静态变量x,y返回随机生成的点坐标
        static method random (real ax,real ay,real bx,real by,real cx,real cy) {
            real rA = GetRandomReal(0,1.0);
            real rB = GetRandomReal(0,1.0);
            real abx = bx-ax, aby = by-ay;
            real acx = cx-ax, acy = cy-ay;
            if (rA + rB > 1.0) {
                rA = 1.0 - rA;
                rB = 1.0 - rB;
            }
            x = ax + rA * abx + rB * acx;
            y = ay + rA * aby + rB * acy;
        }
    }
    // 矩形区域内随机取点[内嵌一定范围]
    public function GetRectRandomInnerX ( rect r,real inner ) -> real {
        return GetRandomReal(GetRectMinX(r)+inner,GetRectMaxX(r)-inner);
    }
    // 矩形区域内随机取点[内嵌一定范围]
    public function GetRectRandomInnerY ( rect r,real inner ) -> real {
        return GetRandomReal(GetRectMinY(r)+inner,GetRectMaxY(r)-inner);
    }
    // 矩形区域内随机取点
    public function GetRectRandomX ( rect r ) -> real {
        return GetRandomReal(GetRectMinX(r),GetRectMaxX(r));
    }
    // 矩形区域内随机取点
    public function GetRectRandomY ( rect r ) -> real {
        return GetRandomReal(GetRectMinY(r),GetRectMaxY(r));
    }
}
//! endzinc
library YDWEMultiboardSetItemValueBJNull
function YDWEMultiboardSetItemValueBJNull takes multiboard mb, integer col, integer row, string val returns nothing
    local integer curRow = 0
    local integer curCol = 0
    local integer numRows = MultiboardGetRowCount(mb)
    local integer numCols = MultiboardGetColumnCount(mb)
    local multiboarditem mbitem = null
    // Loop over rows, using 1-based index
    loop
        set curRow = curRow + 1
        exitwhen curRow > numRows
        // Apply setting to the requested row, or all rows (if row is 0)
        if (row == 0 or row == curRow) then
            // Loop over columns, using 1-based index
            set curCol = 0
            loop
                set curCol = curCol + 1
                exitwhen curCol > numCols
                // Apply setting to the requested column, or all columns (if col is 0)
                if (col == 0 or col == curCol) then
                    set mbitem = MultiboardGetItem(mb, curRow - 1, curCol - 1)
                    call MultiboardSetItemValue(mbitem, val)
                    call MultiboardReleaseItem(mbitem)
                endif
            endloop
        endif
    endloop
    set mbitem = null
endfunction
endlibrary
library BzAPI
    //hardware
    native DzGetMouseTerrainX takes nothing returns real
    native DzGetMouseTerrainY takes nothing returns real
    native DzGetMouseTerrainZ takes nothing returns real
    native DzIsMouseOverUI takes nothing returns boolean
    native DzGetMouseX takes nothing returns integer
    native DzGetMouseY takes nothing returns integer
    native DzGetMouseXRelative takes nothing returns integer
    native DzGetMouseYRelative takes nothing returns integer
    native DzSetMousePos takes integer x, integer y returns nothing
    native DzTriggerRegisterMouseEvent takes trigger trig, integer btn, integer status, boolean sync, string func returns nothing
    native DzTriggerRegisterMouseEventByCode takes trigger trig, integer btn, integer status, boolean sync, code funcHandle returns nothing
    native DzTriggerRegisterKeyEvent takes trigger trig, integer key, integer status, boolean sync, string func returns nothing
    native DzTriggerRegisterKeyEventByCode takes trigger trig, integer key, integer status, boolean sync, code funcHandle returns nothing
    native DzTriggerRegisterMouseWheelEvent takes trigger trig, boolean sync, string func returns nothing
    native DzTriggerRegisterMouseWheelEventByCode takes trigger trig, boolean sync, code funcHandle returns nothing
    native DzTriggerRegisterMouseMoveEvent takes trigger trig, boolean sync, string func returns nothing
    native DzTriggerRegisterMouseMoveEventByCode takes trigger trig, boolean sync, code funcHandle returns nothing
    native DzGetTriggerKey takes nothing returns integer
    native DzGetWheelDelta takes nothing returns integer
    native DzIsKeyDown takes integer iKey returns boolean
    native DzGetTriggerKeyPlayer takes nothing returns player
    native DzGetWindowWidth takes nothing returns integer
    native DzGetWindowHeight takes nothing returns integer
    native DzGetWindowX takes nothing returns integer
    native DzGetWindowY takes nothing returns integer
    native DzTriggerRegisterWindowResizeEvent takes trigger trig, boolean sync, string func returns nothing
    native DzTriggerRegisterWindowResizeEventByCode takes trigger trig, boolean sync, code funcHandle returns nothing
    native DzIsWindowActive takes nothing returns boolean
    //plus
    native DzDestructablePosition takes destructable d, real x, real y returns nothing
    native DzSetUnitPosition takes unit whichUnit, real x, real y returns nothing
    native DzExecuteFunc takes string funcName returns nothing
    native DzGetUnitUnderMouse takes nothing returns unit
    native DzSetUnitTexture takes unit whichUnit, string path, integer texId returns nothing
    native DzSetMemory takes integer address, real value returns nothing
    native DzSetUnitID takes unit whichUnit, integer id returns nothing
    native DzSetUnitModel takes unit whichUnit, string path returns nothing
    native DzSetWar3MapMap takes string map returns nothing
    native DzGetLocale takes nothing returns string
    native DzGetUnitNeededXP takes unit whichUnit, integer level returns integer
    //sync
    native DzTriggerRegisterSyncData takes trigger trig, string prefix, boolean server returns nothing
    native DzSyncData takes string prefix, string data returns nothing
    native DzGetTriggerSyncPrefix takes nothing returns string
    native DzGetTriggerSyncData takes nothing returns string
    native DzGetTriggerSyncPlayer takes nothing returns player
    native DzSyncBuffer takes string prefix, string data, integer dataLen returns nothing
    //native DzGetPushContext takes nothing returns string
    native DzSyncDataImmediately takes string prefix, string data returns nothing 
    //gui
    native DzFrameHideInterface takes nothing returns nothing
    native DzFrameEditBlackBorders takes real upperHeight, real bottomHeight returns nothing
    native DzFrameGetPortrait takes nothing returns integer
    native DzFrameGetMinimap takes nothing returns integer
    native DzFrameGetCommandBarButton takes integer row, integer column returns integer
    native DzFrameGetHeroBarButton takes integer buttonId returns integer
    native DzFrameGetHeroHPBar takes integer buttonId returns integer
    native DzFrameGetHeroManaBar takes integer buttonId returns integer
    native DzFrameGetItemBarButton takes integer buttonId returns integer
    native DzFrameGetMinimapButton takes integer buttonId returns integer
    native DzFrameGetUpperButtonBarButton takes integer buttonId returns integer
    native DzFrameGetTooltip takes nothing returns integer
    native DzFrameGetChatMessage takes nothing returns integer
    native DzFrameGetUnitMessage takes nothing returns integer
    native DzFrameGetTopMessage takes nothing returns integer
    native DzGetColor takes integer r, integer g, integer b, integer a returns integer
    native DzFrameSetUpdateCallback takes string func returns nothing
    native DzFrameSetUpdateCallbackByCode takes code funcHandle returns nothing
    native DzFrameShow takes integer frame, boolean enable returns nothing
    native DzCreateFrame takes string frame, integer parent, integer id returns integer
    native DzCreateSimpleFrame takes string frame, integer parent, integer id returns integer
    native DzDestroyFrame takes integer frame returns nothing
    native DzLoadToc takes string fileName returns nothing
    native DzFrameSetPoint takes integer frame, integer point, integer relativeFrame, integer relativePoint, real x, real y returns nothing
    native DzFrameSetAbsolutePoint takes integer frame, integer point, real x, real y returns nothing
    native DzFrameClearAllPoints takes integer frame returns nothing
    native DzFrameSetEnable takes integer name, boolean enable returns nothing
    native DzFrameSetScript takes integer frame, integer eventId, string func, boolean sync returns nothing
    native DzFrameSetScriptByCode takes integer frame, integer eventId, code funcHandle, boolean sync returns nothing
    native DzGetTriggerUIEventPlayer takes nothing returns player
    native DzGetTriggerUIEventFrame takes nothing returns integer
    native DzFrameFindByName takes string name, integer id returns integer
    native DzSimpleFrameFindByName takes string name, integer id returns integer
    native DzSimpleFontStringFindByName takes string name, integer id returns integer
    native DzSimpleTextureFindByName takes string name, integer id returns integer
    native DzGetGameUI takes nothing returns integer
    native DzClickFrame takes integer frame returns nothing
    native DzSetCustomFovFix takes real value returns nothing
    native DzEnableWideScreen takes boolean enable returns nothing
    native DzFrameSetText takes integer frame, string text returns nothing
    native DzFrameGetText takes integer frame returns string
    native DzFrameSetTextSizeLimit takes integer frame, integer size returns nothing
    native DzFrameGetTextSizeLimit takes integer frame returns integer
    native DzFrameSetTextColor takes integer frame, integer color returns nothing
    native DzGetMouseFocus takes nothing returns integer
    native DzFrameSetAllPoints takes integer frame, integer relativeFrame returns boolean
    native DzFrameSetFocus takes integer frame, boolean enable returns boolean
    native DzFrameSetModel takes integer frame, string modelFile, integer modelType, integer flag returns nothing
    native DzFrameGetEnable takes integer frame returns boolean
    native DzFrameSetAlpha takes integer frame, integer alpha returns nothing
    native DzFrameGetAlpha takes integer frame returns integer
    native DzFrameSetAnimate takes integer frame, integer animId, boolean autocast returns nothing
    native DzFrameSetAnimateOffset takes integer frame, real offset returns nothing
    native DzFrameSetTexture takes integer frame, string texture, integer flag returns nothing
    native DzFrameSetScale takes integer frame, real scale returns nothing
    native DzFrameSetTooltip takes integer frame, integer tooltip returns nothing
    native DzFrameCageMouse takes integer frame, boolean enable returns nothing
    native DzFrameGetValue takes integer frame returns real
    native DzFrameSetMinMaxValue takes integer frame, real minValue, real maxValue returns nothing
    native DzFrameSetStepValue takes integer frame, real step returns nothing
    native DzFrameSetValue takes integer frame, real value returns nothing
    native DzFrameSetSize takes integer frame, real w, real h returns nothing
    native DzCreateFrameByTagName takes string frameType, string name, integer parent, string template, integer id returns integer
    native DzFrameSetVertexColor takes integer frame, integer color returns nothing
    native DzOriginalUIAutoResetPoint takes boolean enable returns nothing
    native DzFrameSetPriority takes integer frame, integer priority returns nothing
    native DzFrameSetParent takes integer frame, integer parent returns nothing
    native DzFrameGetHeight takes integer frame returns real
    native DzFrameSetFont takes integer frame, string fileName, real height, integer flag returns nothing
    native DzFrameGetParent takes integer frame returns integer
    native DzFrameSetTextAlignment takes integer frame, integer align returns nothing
    native DzFrameGetName takes integer frame returns string
    native DzGetClientWidth takes nothing returns integer
    native DzGetClientHeight takes nothing returns integer
    native DzFrameIsVisible takes integer frame returns boolean
        //显示/隐藏SimpleFrame
    //native DzSimpleFrameShow takes integer frame, boolean enable returns nothing
    // 追加文字（支持TextArea）
    native DzFrameAddText takes integer frame, string text returns nothing
    // 沉默单位-禁用技能
    native DzUnitSilence takes unit whichUnit, boolean disable returns nothing
    // 禁用攻击
    native DzUnitDisableAttack takes unit whichUnit, boolean disable returns nothing
    // 禁用道具
    native DzUnitDisableInventory takes unit whichUnit, boolean disable returns nothing
    // 刷新小地图
    native DzUpdateMinimap takes nothing returns nothing
    // 修改单位alpha
    native DzUnitChangeAlpha takes unit whichUnit, integer alpha, boolean forceUpdate returns nothing
    // 设置单位是否可以选中
    native DzUnitSetCanSelect takes unit whichUnit, boolean state returns nothing
    // 修改单位是否可以被设置为目标
    native DzUnitSetTargetable takes unit whichUnit, boolean state returns nothing
    // 保存内存数据
    native DzSaveMemoryCache takes string cache returns nothing
    // 读取内存数据
    native DzGetMemoryCache takes nothing returns string
    // 设置加速倍率
    native DzSetSpeed takes real ratio returns nothing
    // 转换世界坐标为屏幕坐标-异步
    native DzConvertWorldPosition takes real x, real y, real z, code callback returns boolean
    // 转换世界坐标为屏幕坐标-获取转换后的X坐标
    native DzGetConvertWorldPositionX takes nothing returns real
    // 转换世界坐标为屏幕坐标-获取转换后的Y坐标
    native DzGetConvertWorldPositionY takes nothing returns real
    // 创建command button
    native DzCreateCommandButton takes integer parent, string icon, string name, string desc returns integer
    function DzTriggerRegisterMouseEventTrg takes trigger trg, integer status, integer btn returns nothing
        if trg == null then
            return
        endif
        call DzTriggerRegisterMouseEvent(trg, btn, status, true, null)
    endfunction
    function DzTriggerRegisterKeyEventTrg takes trigger trg, integer status, integer btn returns nothing
        if trg == null then
            return
        endif
        call DzTriggerRegisterKeyEvent(trg, btn, status, true, null)
    endfunction
    function DzTriggerRegisterMouseMoveEventTrg takes trigger trg returns nothing
        if trg == null then
            return
        endif
        call DzTriggerRegisterMouseMoveEvent(trg, true, null)
    endfunction
    function DzTriggerRegisterMouseWheelEventTrg takes trigger trg returns nothing
        if trg == null then
            return
        endif
        call DzTriggerRegisterMouseWheelEvent(trg, true, null)
    endfunction
    function DzTriggerRegisterWindowResizeEventTrg takes trigger trg returns nothing
        if trg == null then
            return
        endif
        call DzTriggerRegisterWindowResizeEvent(trg, true, null)
    endfunction
    function DzF2I takes integer i returns integer
        return i
    endfunction
    function DzI2F takes integer i returns integer
        return i
    endfunction
    function DzK2I takes integer i returns integer
        return i
    endfunction
    function DzI2K takes integer i returns integer
        return i
    endfunction
    function DzTriggerRegisterMallItemSyncData takes trigger trig returns nothing
        call DzTriggerRegisterSyncData(trig, "DZMIA", true)
    endfunction
    //玩家消耗/使用商城道具事件
    function DzTriggerRegisterMallItemConsumeEvent takes trigger trig returns nothing
        call DzTriggerRegisterSyncData(trig, "DZMIC", true)
    endfunction
    //玩家删除商城道具事件
    function DzTriggerRegisterMallItemRemoveEvent takes trigger trig returns nothing
        call DzTriggerRegisterSyncData(trig, "DZMID", true)
    endfunction
    function DzGetTriggerMallItemPlayer takes nothing returns player
        return DzGetTriggerSyncPlayer()
    endfunction
    function DzGetTriggerMallItem takes nothing returns string
        return DzGetTriggerSyncData()
    endfunction
    
endlibrary
library DzAPI
    native DzAPI_Map_HasMallItem takes player whichPlayer, string key returns boolean
    native DzAPI_Map_GetMapLevel takes player whichPlayer returns integer
    // native DzAPI_Map_GetGuildName takes player whichPlayer returns string
    native RequestExtraIntegerData takes integer dataType, player whichPlayer, string param1, string param2, boolean param3, integer param4, integer param5, integer param6 returns integer
    native RequestExtraBooleanData takes integer dataType, player whichPlayer, string param1, string param2, boolean param3, integer param4, integer param5, integer param6 returns boolean
    native RequestExtraStringData takes integer dataType, player whichPlayer, string param1, string param2, boolean param3, integer param4, integer param5, integer param6 returns string
    native RequestExtraRealData takes integer dataType, player whichPlayer, string param1, string param2, boolean param3, integer param4, integer param5, integer param6 returns real
    
    // SaveServerValue,               //保存服务器存档
    function DzAPI_Map_SaveServerValue takes player whichPlayer, string key, string value returns boolean
        return RequestExtraBooleanData(4, whichPlayer, key, value, false, 0, 0, 0)
    endfunction
    // GetServerValue,                //读取服务器存档
    function DzAPI_Map_GetServerValue takes player whichPlayer, string key returns string
        return RequestExtraStringData(5, whichPlayer, key, null, false, 0, 0, 0)
    endfunction
    // GetGameStartTime,              //取游戏开始时间
    function DzAPI_Map_GetGameStartTime takes nothing returns integer
        return RequestExtraIntegerData(11, null, null, null, false, 0, 0, 0)
    endfunction
    // IsRPGLadder,                   //判断当前是否rpg天梯
    function DzAPI_Map_IsRPGLadder takes nothing returns boolean
        return RequestExtraBooleanData(12, null, null, null, false, 0, 0, 0)
    endfunction
    // GetMatchType,                  //获取匹配类型
    function DzAPI_Map_GetMatchType takes nothing returns integer
        return RequestExtraIntegerData(13, null, null, null, false, 0, 0, 0)
    endfunction
        // SetStat,                       //统计-提交地图数据
    function DzAPI_Map_Stat_SetStat takes player whichPlayer, string key, string value returns nothing
        call RequestExtraIntegerData(7, whichPlayer, key, value, false, 0, 0, 0)
    endfunction
    // SetLadderStat,                 //天梯-统计数据
    function DzAPI_Map_Ladder_SetStat takes player whichPlayer, string key, string value returns nothing
        call RequestExtraIntegerData(8, whichPlayer, key, value, false, 0, 0, 0)
    endfunction
    // SetLadderPlayerStat,           //天梯-统计数据
    function DzAPI_Map_Ladder_SetPlayerStat takes player whichPlayer, string key, string value returns nothing
        call RequestExtraIntegerData(9, whichPlayer, key, value, false, 0, 0, 0)
    endfunction
        // GetServerValueErrorCode,       //读取加载服务器存档时的错误码
    function DzAPI_Map_GetServerValueErrorCode takes player whichPlayer returns integer
        return RequestExtraIntegerData(6, whichPlayer, null, null, false, 0, 0, 0)
    endfunction
    // GetLadderLevel,                //提供给地图的接口，用与取天梯等级
    function DzAPI_Map_GetLadderLevel takes player whichPlayer returns integer
        return RequestExtraIntegerData(14, whichPlayer, null, null, false, 0, 0, 0)
    endfunction
    // PlayerIdentityType, // 获取玩家身份类型
    function KKApiPlayerIdentityType takes player whichPlayer, integer id returns boolean
        return RequestExtraBooleanData(92, whichPlayer, null, null, false, id, 0, 0)
    endfunction
    // IsRedVIP,                      //提供给地图的接口，用与判断是否红V
    function DzAPI_Map_IsRedVIP takes player whichPlayer returns boolean
        return KKApiPlayerIdentityType(whichPlayer, 4)
    endfunction
    // IsBlueVIP,                     //提供给地图的接口，用与判断是否蓝V
    function DzAPI_Map_IsBlueVIP takes player whichPlayer returns boolean
        return KKApiPlayerIdentityType(whichPlayer, 3)
    endfunction
    // GetLadderRank,                 //提供给地图的接口，用与取天梯排名
    function DzAPI_Map_GetLadderRank takes player whichPlayer returns integer
        return RequestExtraIntegerData(17, whichPlayer, null, null, false, 0, 0, 0)
    endfunction
    // GetMapLevelRank,               //提供给地图的接口，用与取地图等级排名
    function DzAPI_Map_GetMapLevelRank takes player whichPlayer returns integer
        return RequestExtraIntegerData(18, whichPlayer, null, null, false, 0, 0, 0)
    endfunction
    // GetGuildRole,                  //获取公会职责 Member=10 Admin=20 Leader=30
    function DzAPI_Map_GetGuildRole takes player whichPlayer returns integer
        return RequestExtraIntegerData(20, whichPlayer, null, null, false, 0, 0, 0)
    endfunction
    // IsRPGLobby,                    //检查是否大厅地图
    function DzAPI_Map_IsRPGLobby takes nothing returns boolean
        return RequestExtraBooleanData(10, null, null, null, false, 0, 0, 0)
    endfunction
    
    // MissionComplete,               //用作完成某个任务，发奖励
    function DzAPI_Map_MissionComplete takes player whichPlayer, string key, string value returns nothing
        call RequestExtraIntegerData(1, whichPlayer, key, value, false, 0, 0, 0)
    endfunction
    // GetActivityData,               //提供给地图的接口，用作取服务器上的活动数据
    function DzAPI_Map_GetActivityData takes nothing returns string
        return RequestExtraStringData(2, null, null, null, false, 0, 0, 0)
    endfunction
    // GetMapConfig,                  //获取地图配置
    function DzAPI_Map_GetMapConfig takes string key returns string
        return RequestExtraStringData(21, null, key, null, false, 0, 0, 0)
    endfunction
    // SavePublicArchive,             //保存服务器存档组
    function DzAPI_Map_SavePublicArchive takes player whichPlayer, string key, string value returns boolean
        return RequestExtraBooleanData(31, whichPlayer, key, value, false, 0, 0, 0)
    endfunction
    // GetPublicArchive,              //读取服务器存档组
    function DzAPI_Map_GetPublicArchive takes player whichPlayer, string key returns string
        return RequestExtraStringData(32, whichPlayer, key, null, false, 0, 0, 0)
    endfunction
    function DzAPI_Map_UseConsumablesItem takes player whichPlayer, string key returns nothing
        call RequestExtraIntegerData(33, whichPlayer, key, null, false, 0, 0, 0)
    endfunction
    // OrpgTrigger,                   //触发boss击杀
    function DzAPI_Map_OrpgTrigger takes player whichPlayer, string key returns nothing
        call RequestExtraIntegerData(28, whichPlayer, key, null, false, 0, 0, 0)
    endfunction
    // GetServerArchiveDrop,          //读取服务器掉落数据
    function DzAPI_Map_GetServerArchiveDrop takes player whichPlayer, string key returns string
        return RequestExtraStringData(27, whichPlayer, key, null, false, 0, 0, 0)
    endfunction
    // GetServerArchiveEquip,         //读取服务器装备数据
    function DzAPI_Map_GetServerArchiveEquip takes player whichPlayer, string key returns integer
        return RequestExtraIntegerData(26, whichPlayer, key, null, false, 0, 0, 0)
    endfunction
    function DzAPI_Map_GetPlatformVIP takes player whichPlayer returns integer
        return RequestExtraIntegerData(30, whichPlayer, null, null, false, 0, 0, 0)
    endfunction
    function DzAPI_Map_IsPlatformVIP takes player whichPlayer returns boolean
        return DzAPI_Map_GetPlatformVIP(whichPlayer) > 0
    endfunction
    function DzAPI_Map_Global_GetStoreString takes string key returns string
        return RequestExtraStringData(36, GetLocalPlayer(), key, null, false, 0, 0, 0)
    endfunction
    function DzAPI_Map_Global_StoreString takes string key, string value returns nothing
        call RequestExtraBooleanData(37, GetLocalPlayer(), key, value, false, 0, 0, 0)
    endfunction
    function DzAPI_Map_Global_ChangeMsg takes trigger trig returns nothing
        call DzTriggerRegisterSyncData(trig, "DZGAU", true)
    endfunction
    function DzAPI_Map_ServerArchive takes player whichPlayer, string key returns string
        return RequestExtraStringData(38, whichPlayer, key, null, false, 0, 0, 0)
    endfunction
    function DzAPI_Map_SaveServerArchive takes player whichPlayer, string key, string value returns nothing
        call RequestExtraBooleanData(39, whichPlayer, key, value, false, 0, 0, 0)
    endfunction
    function DzAPI_Map_IsRPGQuickMatch takes nothing returns boolean
        return RequestExtraBooleanData(40, null, null, null, false, 0, 0, 0)
    endfunction
    function DzAPI_Map_GetMallItemCount takes player whichPlayer, string key returns integer
        return RequestExtraIntegerData(41, whichPlayer, key, null, false, 0, 0, 0)
    endfunction
    function DzAPI_Map_ConsumeMallItem takes player whichPlayer, string key, integer count returns boolean
        return RequestExtraBooleanData(42, whichPlayer, key, null, false, count, 0, 0)
    endfunction
    function DzAPI_Map_EnablePlatformSettings takes player whichPlayer, integer option, boolean enable returns boolean
        return RequestExtraBooleanData(43, whichPlayer, null, null, enable, option, 0, 0)
    endfunction
    function GetPlayerServerValueSuccess takes player whichPlayer returns boolean
        if(DzAPI_Map_GetServerValueErrorCode(whichPlayer)==0)then
            return true
        else
            return false
        endif
    endfunction
    function DzAPI_Map_StoreIntegerEX takes player whichPlayer, string key, integer value returns nothing
        set key="I"+key
        call RequestExtraBooleanData(39, whichPlayer, key, I2S(value), false, 0, 0, 0)
        set key=null
        set whichPlayer=null
    endfunction
    function DzAPI_Map_GetStoredIntegerEX takes player whichPlayer, string key returns integer
        local integer value
        set key="I"+key
        set value=S2I(RequestExtraStringData(38, whichPlayer, key, null, false, 0, 0, 0))
        set key=null
        set whichPlayer=null
        return value
    endfunction
    function DzAPI_Map_StoreInteger takes player whichPlayer, string key, integer value returns nothing
        set key="I"+key
        call DzAPI_Map_SaveServerValue(whichPlayer,key,I2S(value))
        set key=null
        set whichPlayer=null
    endfunction
    function DzAPI_Map_GetStoredInteger takes player whichPlayer, string key returns integer
        local integer value
        set key="I"+key
        set value=S2I(DzAPI_Map_GetServerValue(whichPlayer,key))
        set key=null
        set whichPlayer=null
        return value
    endfunction
        function DzAPI_Map_CommentTotalCount1 takes player whichPlayer, integer id returns integer
            return RequestExtraIntegerData(52, whichPlayer, null, null, false, id, 0, 0)
    endfunction
    function DzAPI_Map_StoreReal takes player whichPlayer, string key, real value returns nothing
        set key="R"+key
        call DzAPI_Map_SaveServerValue(whichPlayer,key,R2S(value))
        set key=null
        set whichPlayer=null
    endfunction
    function DzAPI_Map_GetStoredReal takes player whichPlayer, string key returns real
        local real value
        set key="R"+key
        set value=S2R(DzAPI_Map_GetServerValue(whichPlayer,key))
        set key=null
        set whichPlayer=null
        return value
    endfunction
    function DzAPI_Map_StoreBoolean takes player whichPlayer, string key, boolean value returns nothing
        set key="B"+key
        if(value)then
            call DzAPI_Map_SaveServerValue(whichPlayer,key,"1")
        else
            call DzAPI_Map_SaveServerValue(whichPlayer,key,"0")
        endif
        set key=null
        set whichPlayer=null
    endfunction
    function DzAPI_Map_GetStoredBoolean takes player whichPlayer, string key returns boolean
        local boolean value
        set key="B"+key
        set key=DzAPI_Map_GetServerValue(whichPlayer,key)
        if(key=="1")then
            set value=true
        else
            set value=false
        endif
        set key=null
        set whichPlayer=null
        return value
    endfunction
    function DzAPI_Map_StoreString takes player whichPlayer, string key, string value returns nothing
        set key="S"+key
        call DzAPI_Map_SaveServerValue(whichPlayer,key,value)
        set key=null
        set whichPlayer=null
    endfunction
    function DzAPI_Map_GetStoredString takes player whichPlayer, string key returns string
        return DzAPI_Map_GetServerValue(whichPlayer,"S"+key)
    endfunction
    function DzAPI_Map_StoreStringEX takes player whichPlayer, string key, string value returns nothing
        set key="S"+key
        call RequestExtraBooleanData(39, whichPlayer,key,value,false,0,0,0)
        set key=null
        set whichPlayer=null
    endfunction
    function DzAPI_Map_GetStoredStringEX takes player whichPlayer, string key returns string
        return RequestExtraStringData(38, whichPlayer,"S"+key,null,false,0,0,0)
    endfunction
    function DzAPI_Map_GetStoredUnitType takes player whichPlayer, string key returns integer
        local integer value
        set key="I"+key
        set value=S2I(DzAPI_Map_GetServerValue(whichPlayer,key))
        set key=null
        set whichPlayer=null
        return value
    endfunction
    function DzAPI_Map_GetStoredAbilityId takes player whichPlayer, string key returns integer
        local integer value
        set key="I"+key
        set value=S2I(DzAPI_Map_GetServerValue(whichPlayer,key))
        set key=null
        set whichPlayer=null
        return value
    endfunction
    function DzAPI_Map_FlushStoredMission takes player whichPlayer, string key returns nothing
        call DzAPI_Map_SaveServerValue(whichPlayer,key,null)
        set key=null
        set whichPlayer=null
    endfunction
    function DzAPI_Map_Ladder_SubmitIntegerData takes player whichPlayer, string key, integer value returns nothing
        call DzAPI_Map_Ladder_SetStat(whichPlayer,key,I2S(value))
    endfunction
    function DzAPI_Map_Stat_SubmitUnitIdData takes player whichPlayer, string key,integer value returns nothing
        if(value==0)then
            //call DzAPI_Map_Ladder_SetStat(whichPlayer,key,"0")
        else
            call DzAPI_Map_Ladder_SetStat(whichPlayer,key,I2S(value))
        endif
    endfunction
    function DzAPI_Map_Stat_SubmitUnitData takes player whichPlayer, string key,unit value returns nothing
        call DzAPI_Map_Stat_SubmitUnitIdData(whichPlayer,key,GetUnitTypeId(value))
    endfunction
    function DzAPI_Map_Ladder_SubmitAblityIdData takes player whichPlayer, string key, integer value returns nothing
        if(value==0)then
            //call DzAPI_Map_Ladder_SetStat(whichPlayer,key,"0")
        else
            call DzAPI_Map_Ladder_SetStat(whichPlayer,key,I2S(value))
        endif
    endfunction
    function DzAPI_Map_Ladder_SubmitItemIdData takes player whichPlayer, string key, integer value returns nothing
        local string S
        if(value==0)then
            set S="0"
        else
            set S=I2S(value)
            call DzAPI_Map_Ladder_SetStat(whichPlayer,key,S)
        endif
        //call DzAPI_Map_Ladder_SetStat(whichPlayer,key,S)
        set S=null
        set whichPlayer=null
    endfunction
    function DzAPI_Map_Ladder_SubmitItemData takes player whichPlayer, string key, item value returns nothing
        call DzAPI_Map_Ladder_SubmitItemIdData(whichPlayer,key,GetItemTypeId(value))
    endfunction
    function DzAPI_Map_Ladder_SubmitBooleanData takes player whichPlayer, string key,boolean value returns nothing
        if(value)then
            call DzAPI_Map_Ladder_SetStat(whichPlayer,key,"1")
        else
            call DzAPI_Map_Ladder_SetStat(whichPlayer,key,"0")
        endif
    endfunction
    function DzAPI_Map_Ladder_SubmitTitle takes player whichPlayer, string value returns nothing
        call DzAPI_Map_Ladder_SetStat(whichPlayer,value,"1")
    endfunction
    function DzAPI_Map_Ladder_SubmitPlayerRank takes player whichPlayer, integer value returns nothing
        call DzAPI_Map_Ladder_SetPlayerStat(whichPlayer,"RankIndex",I2S(value))
    endfunction
    function DzAPI_Map_Ladder_SubmitPlayerExtraExp takes player whichPlayer, integer value returns nothing
        call DzAPI_Map_Ladder_SetStat(whichPlayer,"ExtraExp",I2S(value))
    endfunction
    function DzAPI_Map_PlayedGames takes player whichPlayer returns integer
        return RequestExtraIntegerData(45, whichPlayer, null, null, false, 0, 0, 0)
    endfunction
    function DzAPI_Map_CommentCount takes player whichPlayer returns integer
        return RequestExtraIntegerData(46, whichPlayer, null, null, false, 0, 0, 0)
    endfunction
    function DzAPI_Map_FriendCount takes player whichPlayer returns integer
        return RequestExtraIntegerData(47, whichPlayer, null, null, false, 0, 0, 0)
    endfunction
    function DzAPI_Map_IsConnoisseur takes player whichPlayer returns boolean
        return RequestExtraBooleanData(48, whichPlayer, null, null, false, 0, 0, 0)
    endfunction
    function DzAPI_Map_IsAuthor takes player whichPlayer returns boolean
        return RequestExtraBooleanData(50, whichPlayer, null, null, false, 0, 0, 0)
    endfunction
    function DzAPI_Map_CommentTotalCount takes nothing returns integer
        return RequestExtraIntegerData(51, null, null, null, false, 0, 0, 0)
    endfunction
    function DzAPI_Map_Statistics takes player whichPlayer, string eventKey, string eventType, integer value returns nothing
        call RequestExtraBooleanData(34, whichPlayer, eventKey, eventType, false, value, 0, 0)
    endfunction
    function DzAPI_Map_Returns takes player whichPlayer, integer label returns boolean
        return RequestExtraBooleanData(53, whichPlayer, null, null, false, label, 0, 0)
    endfunction
    function DzAPI_Map_ContinuousCount takes player whichPlayer, integer id returns integer
        return RequestExtraIntegerData(54, whichPlayer, null, null, false, id, 0, 0)
    endfunction
    // IsPlayer,                      //是否为玩家
    function DzAPI_Map_IsPlayer takes player whichPlayer returns boolean
        return RequestExtraBooleanData(55, whichPlayer, null, null, false, 0, 0, 0)
    endfunction
    // MapsTotalPlayed,               //所有地图的总游戏时长
    function DzAPI_Map_MapsTotalPlayed takes player whichPlayer returns integer
        return RequestExtraIntegerData(56, whichPlayer, null, null, false, 0, 0, 0)
    endfunction
    // MapsLevel,                    //指定地图的地图等级
    function DzAPI_Map_MapsLevel takes player whichPlayer, integer mapId returns integer
        return RequestExtraIntegerData(57, whichPlayer, null, null, false, mapId, 0, 0)
    endfunction
    // MapsConsumeGold,              //所有地图的金币消耗
    function DzAPI_Map_MapsConsumeGold takes player whichPlayer, integer mapId returns integer
        return RequestExtraIntegerData(58, whichPlayer, null, null, false, mapId, 0, 0)
    endfunction
    // MapsConsumeLumber,            //所有地图的木材消耗
    function DzAPI_Map_MapsConsumeLumber takes player whichPlayer, integer mapId returns integer
        return RequestExtraIntegerData(59, whichPlayer, null, null, false, mapId, 0, 0)
    endfunction
    // MapsConsumeLv1,               //消费 1-199
    function DzAPI_Map_MapsConsumeLv1 takes player whichPlayer, integer mapId returns boolean
        return RequestExtraBooleanData(60, whichPlayer, null, null, false, mapId, 0, 0)
    endfunction
    // MapsConsumeLv2,               //消费 200-499
    function DzAPI_Map_MapsConsumeLv2 takes player whichPlayer, integer mapId returns boolean
        return RequestExtraBooleanData(61, whichPlayer, null, null, false, mapId, 0, 0)
    endfunction
    // MapsConsumeLv3,               //消费 500~999
    function DzAPI_Map_MapsConsumeLv3 takes player whichPlayer, integer mapId returns boolean
        return RequestExtraBooleanData(62, whichPlayer, null, null, false, mapId, 0, 0)
    endfunction
    // MapsConsumeLv4,               //消费 1000+
    function DzAPI_Map_MapsConsumeLv4 takes player whichPlayer, integer mapId returns boolean
        return RequestExtraBooleanData(63, whichPlayer, null, null, false, mapId, 0, 0)
    endfunction
    // IsPlayerUsingSkin,            //检查是否装备着皮肤（skinType：头像=1、边框=2、称号=3、底纹=4）
    function DzAPI_Map_IsPlayerUsingSkin takes player whichPlayer, integer skinType, integer id returns boolean
        return RequestExtraBooleanData(64,whichPlayer, null, null, false, skinType, id, 0)
    endfunction
    //获取论坛数据（0=累计获得赞数，1=精华帖数量，2=发表回复次数，3=收到的欢乐数，4=是否发过贴子，5=是否版主，6=主题数量）
    function DzAPI_Map_GetForumData takes player whichPlayer, integer whichData returns integer
        return RequestExtraIntegerData(65, whichPlayer, null, null, false, whichData, 0, 0)
    endfunction
    // PlayerFlags,                   //玩家标记 label（1=曾经是平台回流用户，2=当前是平台回流用户，4=曾经是地图回流用户，8=当前是地图回流用户，16=地图是否被玩家收藏）
    function DzAPI_Map_PlayerFlags takes player whichPlayer, integer label returns boolean
        return RequestExtraBooleanData(53, whichPlayer, null, null, false, label, 0, 0)
    endfunction
    // GetLotteryUsedCount, // 获取宝箱抽取次数
    function DzAPI_Map_GetLotteryUsedCountEx takes player whichPlayer,integer index returns integer
        return RequestExtraIntegerData(68, whichPlayer, null, null, false, index, 0, 0)
    endfunction
    function DzAPI_Map_GetLotteryUsedCount takes player whichPlayer returns integer
        return DzAPI_Map_GetLotteryUsedCountEx(whichPlayer,0)+DzAPI_Map_GetLotteryUsedCountEx(whichPlayer,1)+DzAPI_Map_GetLotteryUsedCountEx(whichPlayer,2)
    endfunction
    function DzAPI_Map_OpenMall takes player whichPlayer,string whichkey returns boolean
        return RequestExtraBooleanData(66, whichPlayer, whichkey, null, false, 0, 0, 0)
    endfunction
    function DzAPI_Map_GameResult_CommitData takes player whichPlayer, string key, string value returns nothing
        call RequestExtraIntegerData(69, whichPlayer, key, value, false, 0, 0, 0)
    endfunction
    //游戏结算
    function DzAPI_Map_GameResult_CommitTitle takes player whichPlayer, string value returns nothing
        call DzAPI_Map_GameResult_CommitData(whichPlayer,value,"1")
        set whichPlayer=null
        set value=null
    endfunction
    function DzAPI_Map_GameResult_CommitPlayerRank takes player whichPlayer, integer value returns nothing
        call DzAPI_Map_GameResult_CommitData(whichPlayer,"RankIndex",I2S(value))
        set whichPlayer=null
        set value=0
    endfunction
    function DzAPI_Map_GameResult_CommitGameMode takes string value returns nothing
        call DzAPI_Map_GameResult_CommitData(GetLocalPlayer(),"InnerGameMode",value)
        set value=null
    endfunction
    function DzAPI_Map_GameResult_CommitGameResult takes player whichPlayer, integer value returns nothing
        call DzAPI_Map_GameResult_CommitData(whichPlayer,"GameResult",I2S(value))
        set whichPlayer=null
    endfunction
    function DzAPI_Map_GameResult_CommitGameResultNoEnd takes player whichPlayer, integer value returns nothing
        call DzAPI_Map_GameResult_CommitData(whichPlayer,"GameResultNoEnd",I2S(value))
        set whichPlayer=null
    endfunction
    // GetSinceLastPlayedSeconds, // 获取距最后一次游戏的秒数
    function DzAPI_Map_GetSinceLastPlayedSeconds takes player whichPlayer returns integer
        return RequestExtraIntegerData(70, whichPlayer, null, null, false, 0, 0, 0)
    endfunction
    // QuickBuy, //游戏内快速购买
    function DzAPI_Map_QuickBuy takes player whichPlayer, string key, integer count, integer seconds returns boolean
        return RequestExtraBooleanData(72, whichPlayer, key, null, false, count, seconds, 0)
    endfunction
    // CancelQuickBuy, //取消快速购买
    function DzAPI_Map_CancelQuickBuy takes player whichPlayer returns boolean
        return RequestExtraBooleanData(73, whichPlayer, null, null, false, 0, 0, 0)
    endfunction
    //判断是加载成功某个玩家的道具
    function DzAPI_Map_PlayerLoadedItems takes player whichPlayer returns boolean
        return RequestExtraBooleanData(77, whichPlayer, null, null, false, 0, 0, 0)
    endfunction
    function DzAPI_Map_CustomRankCount takes integer id returns integer
        return RequestExtraIntegerData(78, null, null, null, false, id, 0, 0)
    endfunction
    // CustomRankPlayerName            // 获取排行榜上指定排名的用户名称
    function DzAPI_Map_CustomRankPlayerName takes integer id, integer ranking returns string
        return RequestExtraStringData(79, null, null, null, false, id, ranking, 0)
    endfunction
    // CustomRankPlayerValue           // 获取排行榜上指定排名的值
    function DzAPI_Map_CustomRankValue takes integer id, integer ranking returns integer
        return RequestExtraIntegerData(80, null, null, null, false, id, ranking, 0)
    endfunction
    //获取玩家在KK平台的完整昵称（基础昵称#编号）
    function DzAPI_Map_GetPlayerUserName takes player whichPlayer returns string 
        return RequestExtraStringData(81, whichPlayer, null, null, false, 0, 0, 0)
    endfunction
    // GetServerValueLimitLeft,   // 获取服务器存档限制余额
    function KKApiGetServerValueLimitLeft takes player whichPlayer, string key returns integer
        return RequestExtraIntegerData(82, whichPlayer, key, null, false, 0, 0, 0)
    endfunction
    // RequestBackendLogic,       //请求后端逻辑生成 
    function KKApiRequestBackendLogic takes player whichPlayer, string key, string groupkey returns boolean
        return RequestExtraBooleanData(83, whichPlayer, key, groupkey, false, 0, 0, 0)
    endfunction
    // CheckBackendLogicExists,   // 获取后端逻辑生成结果 是否存在
    function KKApiCheckBackendLogicExists takes player whichPlayer, string key returns boolean
        return RequestExtraBooleanData(84, whichPlayer, key, null, false, 0, 0, 0)
    endfunction
    // GetBackendLogicIntResult,  // 获取后端逻辑生成结果 整型
    function KKApiGetBackendLogicIntResult takes player whichPlayer, string key returns integer
        return RequestExtraIntegerData(85, whichPlayer, key, null, false, 0, 0, 0)
    endfunction
    // GetBackendLogicStrResult,  // 获取后端逻辑生成结果 字符串
    function KKApiGetBackendLogicStrResult takes player whichPlayer, string key returns string
        return RequestExtraStringData(86, whichPlayer, key, null, false, 0, 0, 0)
    endfunction
    // GetBackendLogicUpdateTime, // 获取后端逻辑生成时间
    function KKApiGetBackendLogicUpdateTime takes player whichPlayer, string key returns integer
        return RequestExtraIntegerData(87, whichPlayer, key, null, false, 0, 0, 0)
    endfunction
    // GetBackendLogicGroup,      // 获取后端逻辑生成组
    function KKApiGetBackendLogicGroup takes player whichPlayer, string key returns string
        return RequestExtraStringData(88, whichPlayer, key, null, false, 0, 0, 0)
    endfunction
    // RemoveBackendLogicResult,  // 删除后端逻辑生成结果
    function KKApiRemoveBackendLogicResult takes player whichPlayer, string key returns boolean
        return RequestExtraBooleanData(89, whichPlayer, key, null, false, 0, 0, 0)
    endfunction
    // 获取随机存档剩余次数
    function KKApiRandomSaveGameCount takes player whichPlayer, string groupkey returns integer
        return RequestExtraIntegerData(101, whichPlayer, groupkey, null, false, 0, 0, 0)
    endfunction
    function KKApiTriggerRegisterBackendLogicUpdata takes trigger trig returns nothing
        call DzTriggerRegisterSyncData(trig, "DZBLU", true)
    endfunction
    function KKApiTriggerRegisterBackendLogicDelete takes trigger trig returns nothing
        call DzTriggerRegisterSyncData(trig, "DZBLD", true)
    endfunction
    function KKApiGetSyncBackendLogic takes nothing returns string
        return DzGetTriggerSyncData()
    endfunction
    function KKApiIsGameMode takes nothing returns boolean
        return RequestExtraBooleanData(90, null, null, null, false, 0, 0, 0)
    endfunction
    function KKApiInitializeGameKey takes player whichPlayer,integer setIndex, string k,string data returns boolean
        return RequestExtraBooleanData(91, whichPlayer, "[{\"name\":\""+data+"\",\"key\":\""+k+"\"}]", null, false, setIndex, 0, 0)
    endfunction
    function KKApiPlayerGUID takes player whichPlayer returns string
        return RequestExtraStringData(93, whichPlayer, null, null, false, 0, 0, 0)
    endfunction
    function KKApiIsTaskInProgress takes player whichPlayer,integer setIndex,integer taskstat returns boolean
        return RequestExtraIntegerData(94, whichPlayer, null, null, false, setIndex, 0, 0)==taskstat
    endfunction
    function KKApiQueryTaskCurrentProgress takes player whichPlayer, integer setIndex returns integer
        return RequestExtraIntegerData(95, whichPlayer, null, null, false, setIndex, 0, 0)
    endfunction
    function KKApiQueryTaskTotalProgress takes player whichPlayer, integer setIndex returns integer
        return RequestExtraIntegerData(96, whichPlayer, null, null, false, setIndex, 0, 0)
    endfunction
    // IsAchievementCompleted,  // 获取玩家成就是否完成
    function KKApiIsAchievementCompleted takes player whichPlayer, string id returns boolean
        return RequestExtraBooleanData(98, whichPlayer, id, null, false, 0, 0, 0)
    endfunction
    // AchievementPoints,  // 获取玩家地图成就点数
    function KKApiAchievementPoints takes player whichPlayer returns integer
        return RequestExtraIntegerData(99, whichPlayer, null, null, false, 0, 0, 0)
    endfunction
    
    // 判断游戏时长是否满足条件 minHours: 最小小时数，maxHours: 最大小时数，0表示不限制
    function KKApiPlayedTime takes player whichPlayer, integer minHours, integer maxHours returns boolean
        return RequestExtraBooleanData(100, whichPlayer, null, null, false, minHours, maxHours, 0)
    endfunction
    // BeginBatchSaveArchive,  // 开始批量保存存档
    function KKApiBeginBatchSaveArchive takes player whichPlayer returns boolean
        return RequestExtraBooleanData(102, whichPlayer, null, null, false, 0, 0, 0)
    endfunction
    
    // AddBatchSaveArchive,    // 添加批量保存存档条目
    function KKApiAddBatchSaveArchive takes player whichPlayer, string key, string value, boolean caseInsensitive returns boolean
        return RequestExtraBooleanData(103, whichPlayer, key, value, caseInsensitive, 0, 0, 0)
    endfunction
    
    // EndBatchSaveArchive,    // 结束批量保存存档
    function KKApiEndBatchSaveArchive takes player whichPlayer, boolean abandon returns boolean
        return RequestExtraBooleanData(104, whichPlayer, null, null, abandon, 0, 0, 0)
    endfunction
    //天梯投降
    function KKApiTriggerRegisterLadderSurrender takes trigger trig returns nothing
        call DzTriggerRegisterSyncData(trig, "DZSR", true)
    endfunction
    function KKApiGetLadderSurrenderTeamId takes nothing returns integer
        return S2I(DzGetTriggerSyncData())
    endfunction
    // GetGuildLevel,          // 获取公会等级
    function KKApiGetGuildLevel takes player whichPlayer returns integer
        return RequestExtraIntegerData(106, whichPlayer, null, null, false, 0, 0, 0)
    endfunction
    //宠物探险次数
    function KKApiMapExplorationNum takes player whichPlayer returns integer
        return RequestExtraIntegerData(107, whichPlayer, null, null, false, 0, 0, 0)
    endfunction
    //宠物探险时间
    function KKApiMapExplorationTime takes player whichPlayer returns integer
        return RequestExtraIntegerData(108, whichPlayer, null, null, false, 0, 0, 0)
    endfunction
    
    //测试大厅预约人数
    function KKApiMapOrderNum takes nothing returns integer
        return RequestExtraIntegerData(109, null, null, null, false, 0, 0, 0)
    endfunction
    // 发送云脚本数据
    function KKApiMlScriptEvent takes player whichPlayer, string eventName, string payload returns boolean
        return RequestExtraBooleanData(110, whichPlayer, eventName, payload, false, 0, 0, 0)
    endfunction
    // 获取商城道具最后变动的数量（新增/删除）
    function KKApiGetMallItemUpdateCount takes player whichPlayer, string key returns integer
        return RequestExtraIntegerData(110, whichPlayer, key, null, false, 0, 0, 0)
    endfunction
endlibrary
//! zinc
/*
几何工具
todo:直接用宏定义修改试试
*/
library Geometry {
    // 4个坐标的距离
    public function GetDistance (real x1,real y1,real x2,real y2) -> real {
        real dx = x2 - x1 , dy = y2 - y1;
        return SquareRoot(dx*dx+dy*dy);
    }
    // 6个坐标的距离
    public function GetDistanceZ (real x1,real y1,real z1,real x2,real y2,real z2) -> real {
        real dx = x2 - x1 , dy = y2 - y1, dz = z2 - z1;
        return SquareRoot(dx*dx+dy*dy+dz*dz);
    }
    // 4个坐标的角度,前面是人的位置，后面是点的位置
    public function GetFacing (real x1,real y1,real x2,real y2) -> real {
        return Atan2BJ(y2-y1,x2-x1);
    }
}
//! endzinc
library YDWEUnitHasItemOfTypeBJNull
function YDWEUnitHasItemOfTypeBJNull takes unit whichUnit, integer itemId returns boolean
    local integer index = 0
	if itemId != 0 then
		loop
			if GetItemTypeId(UnitItemInSlot(whichUnit, index)) == itemId then
				return true
			endif
			set index = index + 1
			exitwhen index >= bj_MAX_INVENTORY
		endloop
	endif
    return false
endfunction
endlibrary
//! zinc
/*
原生Lua引擎非内置
*/
// https://create.reckfeng.com/kkapidoc/#/menu_kkapi_japi kkapi的japi文档
library YDLua {
    // main 函数就初始化的
    public function initializeLua () -> integer {
        Cheat("exec-lua:plugin_main");
        return 0;
    }
    function onInit () {
        //在游戏开始0.0秒后再调用
        trigger tr = CreateTrigger();
        TriggerRegisterTimerEventSingle(tr,0.0);
        TriggerAddCondition(tr,Condition(function (){
            BJDebugMsg("调用了YDLua引擎");
            DestroyTrigger(GetTriggeringTrigger());
        }));
        tr = null;
    }
}
//! endzinc
library_once YDWEBase initializer InitializeYD
//===========================================================================
//HashTable
//===========================================================================
globals
//ȫ�ֹ�ϣ�� 
	hashtable YDHT = null
endglobals
//===========================================================================
//Return bug
//===========================================================================
function YDWEH2I takes handle h returns integer
    return GetHandleId(h)
endfunction
//����
function YDWEFlushAllData takes nothing returns nothing
    call FlushParentHashtable(YDHT)
endfunction
function YDWEFlushMissionByInteger takes integer i returns nothing
    call FlushChildHashtable(YDHT,i)
endfunction
function YDWEFlushMissionByString takes string s returns nothing
    call FlushChildHashtable(YDHT,StringHash(s))
endfunction
function YDWEFlushStoredIntegerByInteger takes integer i,integer j returns nothing
    call RemoveSavedInteger(YDHT,i,j)
endfunction
function YDWEFlushStoredIntegerByString takes string s1,string s2 returns nothing
    call RemoveSavedInteger(YDHT,StringHash(s1),StringHash(s2))
endfunction
function YDWEHaveSavedIntegerByInteger takes integer i,integer j returns boolean
    return HaveSavedInteger(YDHT,i,j)
endfunction
function YDWEHaveSavedIntegerByString takes string s1,string s2 returns boolean
    return HaveSavedInteger(YDHT,StringHash(s1),StringHash(s2))
endfunction
//store and get integer
function YDWESaveIntegerByInteger takes integer pTable,integer pKey,integer i returns nothing
    call SaveInteger(YDHT,pTable,pKey,i)
endfunction
function YDWESaveIntegerByString takes string pTable,string pKey,integer i returns nothing
    call SaveInteger(YDHT,StringHash(pTable),StringHash(pKey),i)
endfunction
function YDWEGetIntegerByInteger takes integer pTable,integer pKey returns integer
    return LoadInteger(YDHT,pTable,pKey)
endfunction
function YDWEGetIntegerByString takes string pTable,string pKey returns integer
    return LoadInteger(YDHT,StringHash(pTable),StringHash(pKey))
endfunction
//store and get real
function YDWESaveRealByInteger takes integer pTable,integer pKey,real r returns nothing
    call SaveReal(YDHT,pTable,pKey,r)
endfunction
function YDWESaveRealByString takes string pTable,string pKey,real r returns nothing
    call SaveReal(YDHT,StringHash(pTable),StringHash(pKey),r)
endfunction
function YDWEGetRealByInteger takes integer pTable,integer pKey returns real
    return LoadReal(YDHT,pTable,pKey)
endfunction
function YDWEGetRealByString takes string pTable,string pKey returns real
    return LoadReal(YDHT,StringHash(pTable),StringHash(pKey))
endfunction
//store and get string
function YDWESaveStringByInteger takes integer pTable,integer pKey,string s returns nothing
    call SaveStr(YDHT,pTable,pKey,s)
endfunction
function YDWESaveStringByString takes string pTable,string pKey,string s returns nothing
    call SaveStr(YDHT,StringHash(pTable),StringHash(pKey),s)
endfunction
function YDWEGetStringByInteger takes integer pTable,integer pKey returns string
    return LoadStr(YDHT,pTable,pKey)
endfunction
function YDWEGetStringByString takes string pTable,string pKey returns string
    return LoadStr(YDHT,StringHash(pTable),StringHash(pKey))
endfunction
//store and get boolean
function YDWESaveBooleanByInteger takes integer pTable,integer pKey,boolean b returns nothing
    call SaveBoolean(YDHT,pTable,pKey,b)
endfunction
function YDWESaveBooleanByString takes string pTable,string pKey,boolean b returns nothing
    call SaveBoolean(YDHT,StringHash(pTable),StringHash(pKey),b)
endfunction
function YDWEGetBooleanByInteger takes integer pTable,integer pKey returns boolean
    return LoadBoolean(YDHT,pTable,pKey)
endfunction
function YDWEGetBooleanByString takes string pTable,string pKey returns boolean
    return LoadBoolean(YDHT,StringHash(pTable),StringHash(pKey))
endfunction
//Covert Unit
function YDWESaveUnitByInteger takes integer pTable,integer pKey,unit u returns nothing
    call SaveUnitHandle(YDHT,pTable,pKey,u)
endfunction
function YDWESaveUnitByString takes string pTable,string pKey,unit u returns nothing
    call SaveUnitHandle(YDHT,StringHash(pTable),StringHash(pKey),u)
endfunction
function YDWEGetUnitByInteger takes integer pTable,integer pKey returns unit
    return LoadUnitHandle(YDHT,pTable,pKey)
endfunction
function YDWEGetUnitByString takes string pTable,string pKey returns unit
    return LoadUnitHandle(YDHT,StringHash(pTable),StringHash(pKey))
endfunction
//Covert UnitID
function YDWESaveUnitIDByInteger takes integer pTable,integer pKey,integer uid returns nothing
    call SaveInteger(YDHT,pTable,pKey,uid)
endfunction
function YDWESaveUnitIDByString takes string pTable,string pKey,integer uid returns nothing
    call SaveInteger(YDHT,StringHash(pTable),StringHash(pKey),uid)
endfunction
function YDWEGetUnitIDByInteger takes integer pTable,integer pKey returns integer
    return LoadInteger(YDHT,pTable,pKey)
endfunction
function YDWEGetUnitIDByString takes string pTable,string pKey returns integer
    return LoadInteger(YDHT,StringHash(pTable),StringHash(pKey))
endfunction
//Covert AbilityID
function YDWESaveAbilityIDByInteger takes integer pTable,integer pKey,integer abid returns nothing
    call SaveInteger(YDHT,pTable,pKey,abid)
endfunction
function YDWESaveAbilityIDByString takes string pTable,string pKey,integer abid returns nothing
    call SaveInteger(YDHT,StringHash(pTable),StringHash(pKey),abid)
endfunction
function YDWEGetAbilityIDByInteger takes integer pTable,integer pKey returns integer
    return LoadInteger(YDHT,pTable,pKey)
endfunction
function YDWEGetAbilityIDByString takes string pTable,string pKey returns integer
    return LoadInteger(YDHT,StringHash(pTable),StringHash(pKey))
endfunction
//Covert Player
function YDWESavePlayerByInteger takes integer pTable,integer pKey,player p returns nothing
    call SavePlayerHandle(YDHT,pTable,pKey,p)
endfunction
function YDWESavePlayerByString takes string pTable,string pKey,player p returns nothing
    call SavePlayerHandle(YDHT,StringHash(pTable),StringHash(pKey),p)
endfunction
function YDWEGetPlayerByInteger takes integer pTable,integer pKey returns player
    return LoadPlayerHandle(YDHT,pTable,pKey)
endfunction
function YDWEGetPlayerByString takes string pTable,string pKey returns player
    return LoadPlayerHandle(YDHT,StringHash(pTable),StringHash(pKey))
endfunction
//Covert Item
function YDWESaveItemByInteger takes integer pTable,integer pKey,item it returns nothing
    call SaveItemHandle(YDHT,pTable,pKey,it)
endfunction
function YDWESaveItemByString takes string pTable,string pKey,item it returns nothing
    call SaveItemHandle(YDHT,StringHash(pTable),StringHash(pKey),it)
endfunction
function YDWEGetItemByInteger takes integer pTable,integer pKey returns item
    return LoadItemHandle(YDHT,pTable,pKey)
endfunction
function YDWEGetItemByString takes string pTable,string pKey returns item
    return LoadItemHandle(YDHT,StringHash(pTable),StringHash(pKey))
endfunction
//Covert ItemID
function YDWESaveItemIDByInteger takes integer pTable,integer pKey,integer itid returns nothing
    call SaveInteger(YDHT,pTable,pKey,itid)
endfunction
function YDWESaveItemIDByString takes string pTable,string pKey,integer itid returns nothing
    call SaveInteger(YDHT,StringHash(pTable),StringHash(pKey),itid)
endfunction
function YDWEGetItemIDByInteger takes integer pTable,integer pKey returns integer
    return LoadInteger(YDHT,pTable,pKey)
endfunction
function YDWEGetItemIDByString takes string pTable,string pKey returns integer
    return LoadInteger(YDHT,StringHash(pTable),StringHash(pKey))
endfunction
//Covert Timer
function YDWESaveTimerByInteger takes integer pTable,integer pKey,timer t returns nothing
    call SaveTimerHandle(YDHT,pTable,pKey,t)
endfunction
function YDWESaveTimerByString takes string pTable,string pKey,timer t returns nothing
    call SaveTimerHandle(YDHT,StringHash(pTable),StringHash(pKey),t)
endfunction
function YDWEGetTimerByInteger takes integer pTable,integer pKey returns timer
    return LoadTimerHandle(YDHT,pTable,pKey)
endfunction
function YDWEGetTimerByString takes string pTable,string pKey returns timer
    return LoadTimerHandle(YDHT,StringHash(pTable),StringHash(pKey))
endfunction
//Covert Trigger
function YDWESaveTriggerByInteger takes integer pTable,integer pKey,trigger trg returns nothing
    call SaveTriggerHandle(YDHT,pTable,pKey,trg)
endfunction
function YDWESaveTriggerByString takes string pTable,string pKey,trigger trg returns nothing
    call SaveTriggerHandle(YDHT,StringHash(pTable),StringHash(pKey),trg)
endfunction
function YDWEGetTriggerByInteger takes integer pTable,integer pKey returns trigger
    return LoadTriggerHandle(YDHT,pTable,pKey)
endfunction
function YDWEGetTriggerByString takes string pTable,string pKey returns trigger
    return LoadTriggerHandle(YDHT,StringHash(pTable),StringHash(pKey))
endfunction
//Covert Location
function YDWESaveLocationByInteger takes integer pTable,integer pKey,location pt returns nothing
    call SaveLocationHandle(YDHT,pTable,pKey,pt)
endfunction
function YDWESaveLocationByString takes string pTable,string pKey,location pt returns nothing
    call SaveLocationHandle(YDHT,StringHash(pTable),StringHash(pKey),pt)
endfunction
function YDWEGetLocationByInteger takes integer pTable,integer pKey returns location
    return LoadLocationHandle(YDHT,pTable,pKey)
endfunction
function YDWEGetLocationByString takes string pTable,string pKey returns location
    return LoadLocationHandle(YDHT,StringHash(pTable),StringHash(pKey))
endfunction
//Covert Group
function YDWESaveGroupByInteger takes integer pTable,integer pKey,group g returns nothing
    call SaveGroupHandle(YDHT,pTable,pKey,g)
endfunction
function YDWESaveGroupByString takes string pTable,string pKey,group g returns nothing
    call SaveGroupHandle(YDHT,StringHash(pTable),StringHash(pKey),g)
endfunction
function YDWEGetGroupByInteger takes integer pTable,integer pKey returns group
    return LoadGroupHandle(YDHT,pTable,pKey)
endfunction
function YDWEGetGroupByString takes string pTable,string pKey returns group
    return LoadGroupHandle(YDHT,StringHash(pTable),StringHash(pKey))
endfunction
//Covert Multiboard
function YDWESaveMultiboardByInteger takes integer pTable,integer pKey,multiboard m returns nothing
    call SaveMultiboardHandle(YDHT,pTable,pKey,m)
endfunction
function YDWESaveMultiboardByString takes string pTable,string pKey,multiboard m returns nothing
    call SaveMultiboardHandle(YDHT,StringHash(pTable),StringHash(pKey),m)
endfunction
function YDWEGetMultiboardByInteger takes integer pTable,integer pKey returns multiboard
    return LoadMultiboardHandle(YDHT,pTable,pKey)
endfunction
function YDWEGetMultiboardByString takes string pTable,string pKey returns multiboard
    return LoadMultiboardHandle(YDHT,StringHash(pTable),StringHash(pKey))
endfunction
//Covert MultiboardItem
function YDWESaveMultiboardItemByInteger takes integer pTable,integer pKey,multiboarditem mt returns nothing
    call SaveMultiboardItemHandle(YDHT,pTable,pKey,mt)
endfunction
function YDWESaveMultiboardItemByString takes string pTable,string pKey,multiboarditem mt returns nothing
    call SaveMultiboardItemHandle(YDHT,StringHash(pTable),StringHash(pKey),mt)
endfunction
function YDWEGetMultiboardItemByInteger takes integer pTable,integer pKey returns multiboarditem
    return LoadMultiboardItemHandle(YDHT,pTable,pKey)
endfunction
function YDWEGetMultiboardItemByString takes string pTable,string pKey returns multiboarditem
    return LoadMultiboardItemHandle(YDHT,StringHash(pTable),StringHash(pKey))
endfunction
//Covert TextTag
function YDWESaveTextTagByInteger takes integer pTable,integer pKey,texttag tt returns nothing
    call SaveTextTagHandle(YDHT,pTable,pKey,tt)
endfunction
function YDWESaveTextTagByString takes string pTable,string pKey,texttag tt returns nothing
    call SaveTextTagHandle(YDHT,StringHash(pTable),StringHash(pKey),tt)
endfunction
function YDWEGetTextTagByInteger takes integer pTable,integer pKey returns texttag
    return LoadTextTagHandle(YDHT,pTable,pKey)
endfunction
function YDWEGetTextTagByString takes string pTable,string pKey returns texttag
    return LoadTextTagHandle(YDHT,StringHash(pTable),StringHash(pKey))
endfunction
//Covert Lightning
function YDWESaveLightningByInteger takes integer pTable,integer pKey,lightning ln returns nothing
    call SaveLightningHandle(YDHT,pTable,pKey,ln)
endfunction
function YDWESaveLightningByString takes string pTable,string pKey,lightning ln returns nothing
    call SaveLightningHandle(YDHT,StringHash(pTable),StringHash(pKey),ln)
endfunction
function YDWEGetLightningByInteger takes integer pTable,integer pKey returns lightning
    return LoadLightningHandle(YDHT,pTable,pKey)
endfunction
function YDWEGetLightningByString takes string pTable,string pKey returns lightning
    return LoadLightningHandle(YDHT,StringHash(pTable),StringHash(pKey))
endfunction
//Covert Region
function YDWESaveRegionByInteger takes integer pTable,integer pKey,region rn returns nothing
    call SaveRegionHandle(YDHT,pTable,pKey,rn)
endfunction
function YDWESaveRegionByString takes string pTable,string pKey,region rt returns nothing
    call SaveRegionHandle(YDHT,StringHash(pTable),StringHash(pKey),rt)
endfunction
function YDWEGetRegionByInteger takes integer pTable,integer pKey returns region
    return LoadRegionHandle(YDHT,pTable,pKey)
endfunction
function YDWEGetRegionByString takes string pTable,string pKey returns region
    return LoadRegionHandle(YDHT,StringHash(pTable),StringHash(pKey))
endfunction
//Covert Rect
function YDWESaveRectByInteger takes integer pTable,integer pKey,rect rn returns nothing
    call SaveRectHandle(YDHT,pTable,pKey,rn)
endfunction
function YDWESaveRectByString takes string pTable,string pKey,rect rt returns nothing
    call SaveRectHandle(YDHT,StringHash(pTable),StringHash(pKey),rt)
endfunction
function YDWEGetRectByInteger takes integer pTable,integer pKey returns rect
    return LoadRectHandle(YDHT,pTable,pKey)
endfunction
function YDWEGetRectByString takes string pTable,string pKey returns rect
    return LoadRectHandle(YDHT,StringHash(pTable),StringHash(pKey))
endfunction
//Covert Leaderboard
function YDWESaveLeaderboardByInteger takes integer pTable,integer pKey,leaderboard lb returns nothing
    call SaveLeaderboardHandle(YDHT,pTable,pKey,lb)
endfunction
function YDWESaveLeaderboardByString takes string pTable,string pKey,leaderboard lb returns nothing
    call SaveLeaderboardHandle(YDHT,StringHash(pTable),StringHash(pKey),lb)
endfunction
function YDWEGetLeaderboardByInteger takes integer pTable,integer pKey returns leaderboard
    return LoadLeaderboardHandle(YDHT,pTable,pKey)
endfunction
function YDWEGetLeaderboardByString takes string pTable,string pKey returns leaderboard
    return LoadLeaderboardHandle(YDHT,StringHash(pTable),StringHash(pKey))
endfunction
//Covert Effect
function YDWESaveEffectByInteger takes integer pTable,integer pKey,effect e returns nothing
    call SaveEffectHandle(YDHT,pTable,pKey,e)
endfunction
function YDWESaveEffectByString takes string pTable,string pKey,effect e returns nothing
    call SaveEffectHandle(YDHT,StringHash(pTable),StringHash(pKey),e)
endfunction
function YDWEGetEffectByInteger takes integer pTable,integer pKey returns effect
    return LoadEffectHandle(YDHT,pTable,pKey)
endfunction
function YDWEGetEffectByString takes string pTable,string pKey returns effect
    return LoadEffectHandle(YDHT,StringHash(pTable),StringHash(pKey))
endfunction
//Covert Destructable
function YDWESaveDestructableByInteger takes integer pTable,integer pKey,destructable da returns nothing
    call SaveDestructableHandle(YDHT,pTable,pKey,da)
endfunction
function YDWESaveDestructableByString takes string pTable,string pKey,destructable da returns nothing
    call SaveDestructableHandle(YDHT,StringHash(pTable),StringHash(pKey),da)
endfunction
function YDWEGetDestructableByInteger takes integer pTable,integer pKey returns destructable
    return LoadDestructableHandle(YDHT,pTable,pKey)
endfunction
function YDWEGetDestructableByString takes string pTable,string pKey returns destructable
    return LoadDestructableHandle(YDHT,StringHash(pTable),StringHash(pKey))
endfunction
//Covert triggercondition
function YDWESaveTriggerConditionByInteger takes integer pTable,integer pKey,triggercondition tc returns nothing
    call SaveTriggerConditionHandle(YDHT,pTable,pKey,tc)
endfunction
function YDWESaveTriggerConditionByString takes string pTable,string pKey,triggercondition tc returns nothing
    call SaveTriggerConditionHandle(YDHT,StringHash(pTable),StringHash(pKey),tc)
endfunction
function YDWEGetTriggerConditionByInteger takes integer pTable,integer pKey returns triggercondition
    return LoadTriggerConditionHandle(YDHT,pTable,pKey)
endfunction
function YDWEGetTriggerConditionByString takes string pTable,string pKey returns triggercondition
    return LoadTriggerConditionHandle(YDHT,StringHash(pTable),StringHash(pKey))
endfunction
//Covert triggeraction
function YDWESaveTriggerActionByInteger takes integer pTable,integer pKey,triggeraction ta returns nothing
    call SaveTriggerActionHandle(YDHT,pTable,pKey,ta)
endfunction
function YDWESaveTriggerActionByString takes string pTable,string pKey,triggeraction ta returns nothing
    call SaveTriggerActionHandle(YDHT,StringHash(pTable),StringHash(pKey),ta)
endfunction
function YDWEGetTriggerActionByInteger takes integer pTable,integer pKey returns triggeraction
    return LoadTriggerActionHandle(YDHT,pTable,pKey)
endfunction
function YDWEGetTriggerActionByString takes string pTable,string pKey returns triggeraction
    return LoadTriggerActionHandle(YDHT,StringHash(pTable),StringHash(pKey))
endfunction
//Covert event
function YDWESaveTriggerEventByInteger takes integer pTable,integer pKey,event et returns nothing
    call SaveTriggerEventHandle(YDHT,pTable,pKey,et)
endfunction
function YDWESaveTriggerEventByString takes string pTable,string pKey,event et returns nothing
    call SaveTriggerEventHandle(YDHT,StringHash(pTable),StringHash(pKey),et)
endfunction
function YDWEGetTriggerEventByInteger takes integer pTable,integer pKey returns event
    return LoadTriggerEventHandle(YDHT,pTable,pKey)
endfunction
function YDWEGetTriggerEventByString takes string pTable,string pKey returns event
    return LoadTriggerEventHandle(YDHT,StringHash(pTable),StringHash(pKey))
endfunction
//Covert force
function YDWESaveForceByInteger takes integer pTable,integer pKey,force fc returns nothing
    call SaveForceHandle(YDHT,pTable,pKey,fc)
endfunction
function YDWESaveForceByString takes string pTable,string pKey,force fc returns nothing
    call SaveForceHandle(YDHT,StringHash(pTable),StringHash(pKey),fc)
endfunction
function YDWEGetForceByInteger takes integer pTable,integer pKey returns force
    return LoadForceHandle(YDHT,pTable,pKey)
endfunction
function YDWEGetForceByString takes string pTable,string pKey returns force
    return LoadForceHandle(YDHT,StringHash(pTable),StringHash(pKey))
endfunction
//Covert boolexpr
function YDWESaveBoolexprByInteger takes integer pTable,integer pKey,boolexpr be returns nothing
    call SaveBooleanExprHandle(YDHT,pTable,pKey,be)
endfunction
function YDWESaveBoolexprByString takes string pTable,string pKey,boolexpr be returns nothing
    call SaveBooleanExprHandle(YDHT,StringHash(pTable),StringHash(pKey),be)
endfunction
function YDWEGetBoolexprByInteger takes integer pTable,integer pKey returns boolexpr
    return LoadBooleanExprHandle(YDHT,pTable,pKey)
endfunction
function YDWEGetBoolexprByString takes string pTable,string pKey returns boolexpr
    return LoadBooleanExprHandle(YDHT,StringHash(pTable),StringHash(pKey))
endfunction
//Covert sound
function YDWESaveSoundByInteger takes integer pTable,integer pKey,sound sd returns nothing
    call SaveSoundHandle(YDHT,pTable,pKey,sd)
endfunction
function YDWESaveSoundByString takes string pTable,string pKey,sound sd returns nothing
    call SaveSoundHandle(YDHT,StringHash(pTable),StringHash(pKey),sd)
endfunction
function YDWEGetSoundByInteger takes integer pTable,integer pKey returns sound
    return LoadSoundHandle(YDHT,pTable,pKey)
endfunction
function YDWEGetSoundByString takes string pTable,string pKey returns sound
    return LoadSoundHandle(YDHT,StringHash(pTable),StringHash(pKey))
endfunction
//Covert timerdialog
function YDWESaveTimerDialogByInteger takes integer pTable,integer pKey,timerdialog td returns nothing
    call SaveTimerDialogHandle(YDHT,pTable,pKey,td)
endfunction
function YDWESaveTimerDialogByString takes string pTable,string pKey,timerdialog td returns nothing
    call SaveTimerDialogHandle(YDHT,StringHash(pTable),StringHash(pKey),td)
endfunction
function YDWEGetTimerDialogByInteger takes integer pTable,integer pKey returns timerdialog
    return LoadTimerDialogHandle(YDHT,pTable,pKey)
endfunction
function YDWEGetTimerDialogByString takes string pTable,string pKey returns timerdialog
    return LoadTimerDialogHandle(YDHT,StringHash(pTable),StringHash(pKey))
endfunction
//Covert trackable
function YDWESaveTrackableByInteger takes integer pTable,integer pKey,trackable ta returns nothing
    call SaveTrackableHandle(YDHT,pTable,pKey,ta)
endfunction
function YDWESaveTrackableByString takes string pTable,string pKey,trackable ta returns nothing
    call SaveTrackableHandle(YDHT,StringHash(pTable),StringHash(pKey),ta)
endfunction
function YDWEGetTrackableByInteger takes integer pTable,integer pKey returns trackable
    return LoadTrackableHandle(YDHT,pTable,pKey)
endfunction
function YDWEGetTrackableByString takes string pTable,string pKey returns trackable
    return LoadTrackableHandle(YDHT,StringHash(pTable),StringHash(pKey))
endfunction
//Covert dialog
function YDWESaveDialogByInteger takes integer pTable,integer pKey,dialog d returns nothing
    call SaveDialogHandle(YDHT,pTable,pKey,d)
endfunction
function YDWESaveDialogByString takes string pTable,string pKey,dialog d returns nothing
    call SaveDialogHandle(YDHT,StringHash(pTable),StringHash(pKey),d)
endfunction
function YDWEGetDialogByInteger takes integer pTable,integer pKey returns dialog
    return LoadDialogHandle(YDHT,pTable,pKey)
endfunction
function YDWEGetDialogByString takes string pTable,string pKey returns dialog
    return LoadDialogHandle(YDHT,StringHash(pTable),StringHash(pKey))
endfunction
//Covert button
function YDWESaveButtonByInteger takes integer pTable,integer pKey,button bt returns nothing
    call SaveButtonHandle(YDHT,pTable,pKey,bt)
endfunction
function YDWESaveButtonByString takes string pTable,string pKey,button bt returns nothing
    call SaveButtonHandle(YDHT,StringHash(pTable),StringHash(pKey),bt)
endfunction
function YDWEGetButtonByInteger takes integer pTable,integer pKey returns button
    return LoadButtonHandle(YDHT,pTable,pKey)
endfunction
function YDWEGetButtonByString takes string pTable,string pKey returns button
    return LoadButtonHandle(YDHT,StringHash(pTable),StringHash(pKey))
endfunction
//Covert quest
function YDWESaveQuestByInteger takes integer pTable,integer pKey,quest qt returns nothing
    call SaveQuestHandle(YDHT,pTable,pKey,qt)
endfunction
function YDWESaveQuestByString takes string pTable,string pKey,quest qt returns nothing
    call SaveQuestHandle(YDHT,StringHash(pTable),StringHash(pKey),qt)
endfunction
function YDWEGetQuestByInteger takes integer pTable,integer pKey returns quest
    return LoadQuestHandle(YDHT,pTable,pKey)
endfunction
function YDWEGetQuestByString takes string pTable,string pKey returns quest
    return LoadQuestHandle(YDHT,StringHash(pTable),StringHash(pKey))
endfunction
//Covert questitem
function YDWESaveQuestItemByInteger takes integer pTable,integer pKey,questitem qi returns nothing
    call SaveQuestItemHandle(YDHT,pTable,pKey,qi)
endfunction
function YDWESaveQuestItemByString takes string pTable,string pKey,questitem qi returns nothing
    call SaveQuestItemHandle(YDHT,StringHash(pTable),StringHash(pKey),qi)
endfunction
function YDWEGetQuestItemByInteger takes integer pTable,integer pKey returns questitem
    return LoadQuestItemHandle(YDHT,pTable,pKey)
endfunction
function YDWEGetQuestItemByString takes string pTable,string pKey returns questitem
    return LoadQuestItemHandle(YDHT,StringHash(pTable),StringHash(pKey))
endfunction
function YDWES2I takes string s returns integer
    return StringHash(s)
endfunction
function YDWESaveAbilityHandleBJ takes integer AbilityID, integer key, integer missionKey, hashtable table returns nothing
    call SaveInteger(table,missionKey,key,AbilityID)
endfunction
function YDWESaveAbilityHandle takes hashtable table, integer parentKey, integer childKey, integer AbilityID returns nothing
    call SaveInteger(table,parentKey,childKey,AbilityID)
endfunction
function YDWELoadAbilityHandleBJ takes integer key, integer missionKey, hashtable table returns integer
    return LoadInteger(table,missionKey,key)
endfunction
function YDWELoadAbilityHandle takes hashtable table, integer parentKey, integer childKey returns integer
    return LoadInteger(table,parentKey,childKey)
endfunction
globals
	string bj_AllString=".................................!.#$%&'()*+,-./0123456789:;<=>.@ABCDEFGHIJKLMNOPQRSTUVWXYZ[.]^_`abcdefghijklmnopqrstuvwxyz{|}~................................................................................................................................"
//全局系统变量
    unit bj_lastAbilityCastingUnit=null
    unit bj_lastAbilityTargetUnit=null
    unit bj_lastPoolAbstractedUnit=null
    unitpool bj_lastCreatedUnitPool=null
    item bj_lastPoolAbstractedItem=null
    itempool bj_lastCreatedItemPool=null
    attacktype bj_lastSetAttackType = ATTACK_TYPE_NORMAL
    damagetype bj_lastSetDamageType = DAMAGE_TYPE_NORMAL
    weapontype bj_lastSetWeaponType = WEAPON_TYPE_WHOKNOWS
    real yd_MapMaxX = 0
    real yd_MapMinX = 0
    real yd_MapMaxY = 0
    real yd_MapMinY = 0
    private string array yd_PlayerColor
endglobals
//===========================================================================
//返回参数
//===========================================================================
//地图边界判断
function YDWECoordinateX takes real x returns real
    return RMinBJ(RMaxBJ(x, yd_MapMinX), yd_MapMaxX)
endfunction
function YDWECoordinateY takes real y returns real
    return RMinBJ(RMaxBJ(y, yd_MapMinY), yd_MapMaxY)
endfunction
//两个单位之间的距离
function YDWEDistanceBetweenUnits takes unit a,unit b returns real
    return SquareRoot((GetUnitX(a)-GetUnitX(b))*(GetUnitX(a)-GetUnitX(b))+(GetUnitY(a)-GetUnitY(b))*(GetUnitY(a)-GetUnitY(b)))
endfunction
//两个单位之间的角度
function YDWEAngleBetweenUnits takes unit fromUnit, unit toUnit returns real
    return bj_RADTODEG * Atan2(GetUnitY(toUnit) - GetUnitY(fromUnit), GetUnitX(toUnit) - GetUnitX(fromUnit))
endfunction
//生成区域
function YDWEGetRect takes real x,real y,real width, real height returns rect
    return Rect( x - width*0.5, y - height*0.5, x + width*0.5, y + height*0.5 )
endfunction
//===========================================================================
//设置单位可以飞行
//===========================================================================
function YDWEFlyEnable takes unit u returns nothing
    call UnitAddAbility(u,'Amrf')
    call UnitRemoveAbility(u,'Amrf')
endfunction
//===========================================================================
//字符窜与ID转换
//===========================================================================
function YDWEId2S takes integer value returns string
    local string charMap=bj_AllString
    local string result = ""
    local integer remainingValue = value
    local integer charValue
    local integer byteno
    set byteno = 0
    loop
        set charValue = ModuloInteger(remainingValue, 256)
        set remainingValue = remainingValue / 256
        set result = SubString(charMap, charValue, charValue + 1) + result
        set byteno = byteno + 1
        exitwhen byteno == 4
    endloop
    return result
endfunction
function YDWES2Id takes string targetstr returns integer
    local string originstr=bj_AllString
    local integer strlength=StringLength(targetstr)
    local integer a=0 //分部当前数字
local integer b=0 //当前处理字
local integer numx=1 //位权
local integer result=0
    loop
    exitwhen b>strlength-1
        set numx=R2I(Pow(256,strlength-1-b))
        set a=1
        loop
            exitwhen a>255
            if SubString(targetstr,b,b+1)==SubString(originstr,a,a+1) then
                set result=result+a*numx
                set a=256
            endif
            set a=a+1
        endloop
        set b=b+1
    endloop
    return result
endfunction
function YDWES2UnitId takes string targetstr returns integer
    return YDWES2Id(targetstr)
endfunction
function YDWES2ItemId takes string targetstr returns integer
    return YDWES2Id(targetstr)
endfunction
function GetLastAbilityCastingUnit takes nothing returns unit
    return bj_lastAbilityCastingUnit
endfunction
function GetLastAbilityTargetUnit takes nothing returns unit
    return bj_lastAbilityTargetUnit
endfunction
function YDWESetMapLimitCoordinate takes real MinX,real MaxX,real MinY,real MaxY returns nothing
    set yd_MapMaxX=MaxX
    set yd_MapMinX=MinX
    set yd_MapMaxY=MaxY
    set yd_MapMinY=MinY
endfunction
//===========================================================================
//===========================================================================
//地图初始化
//===========================================================================
//YDWE特殊技能结束事件
globals
    private trigger array AbilityCastingOverEventQueue
    private integer array AbilityCastingOverEventType
    private integer AbilityCastingOverEventNumber = 0
endglobals
function YDWESyStemAbilityCastingOverTriggerAction takes unit u_hero, integer index returns nothing
	local integer i = 0
    loop
        exitwhen i >= AbilityCastingOverEventNumber
        if AbilityCastingOverEventType[i] == index then
            set bj_lastAbilityCastingUnit = u_hero
			if AbilityCastingOverEventQueue[i] != null and TriggerEvaluate(AbilityCastingOverEventQueue[i]) and IsTriggerEnabled(AbilityCastingOverEventQueue[i]) then
				call TriggerExecute(AbilityCastingOverEventQueue[i])
			endif
		endif
        set i = i + 1
    endloop
endfunction
//===========================================================================
//YDWE技能捕捉事件
//===========================================================================
function YDWESyStemAbilityCastingOverRegistTrigger takes trigger trg,integer index returns nothing
	set AbilityCastingOverEventQueue[AbilityCastingOverEventNumber] = trg
	set AbilityCastingOverEventType[AbilityCastingOverEventNumber] = index
	set AbilityCastingOverEventNumber = AbilityCastingOverEventNumber + 1
endfunction
//===========================================================================
//系统函数完善
//===========================================================================
function YDWECreateUnitPool takes nothing returns nothing
    set bj_lastCreatedUnitPool=CreateUnitPool()
endfunction
function YDWEPlaceRandomUnit takes unitpool up,player p,real x,real y,real face returns nothing //unitpool,player,real,real,real
set bj_lastPoolAbstractedUnit=PlaceRandomUnit(up,p,x,y,face)
endfunction
function YDWEGetLastUnitPool takes nothing returns unitpool
    return bj_lastCreatedUnitPool
endfunction
function YDWEGetLastPoolAbstractedUnit takes nothing returns unit
    return bj_lastPoolAbstractedUnit
endfunction
function YDWECreateItemPool takes nothing returns nothing
    set bj_lastCreatedItemPool=CreateItemPool()
endfunction
function YDWEPlaceRandomItem takes itempool ip,real x,real y returns nothing //unitpool,player,real,real,real
set bj_lastPoolAbstractedItem=PlaceRandomItem(ip,x,y)
endfunction
function YDWEGetLastItemPool takes nothing returns itempool
    return bj_lastCreatedItemPool
endfunction
function YDWEGetLastPoolAbstractedItem takes nothing returns item
    return bj_lastPoolAbstractedItem
endfunction
function YDWESetAttackDamageWeaponType takes attacktype at,damagetype dt,weapontype wt returns nothing
    set bj_lastSetAttackType=at
    set bj_lastSetDamageType=dt
    set bj_lastSetWeaponType=wt
endfunction
//unitpool bj_lastCreatedPool=null
//unit bj_lastPoolAbstractedUnit=null
function YDWEGetPlayerColorString takes player p, string s returns string
    return yd_PlayerColor[GetHandleId(GetPlayerColor(p))] + s + "|r"
endfunction
//===========================================================================
//===========================================================================
//系统函数补充
//===========================================================================
//===========================================================================
function YDWEGetUnitItemSoftId takes unit u_hero,item it returns integer
    local integer i = 0
    loop
         exitwhen i > 5
         if UnitItemInSlot(u_hero, i) == it then
            return i + 1
         endif
         set i = i + 1
    endloop
    return 0
endfunction
//===========================================================================
//===========================================================================
//地图初始化
//===========================================================================
//===========================================================================
//显示版本
function YDWEVersion_Display takes nothing returns boolean
    call DisplayTimedTextToPlayer(GetTriggerPlayer(), 0, 0, 30,"|cFF1E90FF当前编辑器版本为： |r|cFF00FF00YDWE ")
    return false
endfunction
function YDWEVersion_Init takes nothing returns nothing
    local trigger t = CreateTrigger()
    local integer i = 0
    loop
        exitwhen i == 12
        call TriggerRegisterPlayerChatEvent(t, Player(i), "YDWE Version", true)
        set i = i + 1
    endloop
    call TriggerAddCondition(t, Condition(function YDWEVersion_Display))
    set t = null
endfunction
function InitializeYD takes nothing returns nothing
     set YDHT=InitHashtable()
	//=================设置变量=====================
	set yd_MapMinX = GetCameraBoundMinX() - GetCameraMargin(CAMERA_MARGIN_LEFT)
	set yd_MapMinY = GetCameraBoundMinY() - GetCameraMargin(CAMERA_MARGIN_BOTTOM)
	set yd_MapMaxX = GetCameraBoundMaxX() + GetCameraMargin(CAMERA_MARGIN_RIGHT)
	set yd_MapMaxY = GetCameraBoundMaxY() + GetCameraMargin(CAMERA_MARGIN_TOP)
    set yd_PlayerColor [0] = "|cFFFF0303"
    set yd_PlayerColor [1] = "|cFF0042FF"
    set yd_PlayerColor [2] = "|cFF1CE6B9"
    set yd_PlayerColor [3] = "|cFF540081"
    set yd_PlayerColor [4] = "|cFFFFFC01"
    set yd_PlayerColor [5] = "|cFFFE8A0E"
    set yd_PlayerColor [6] = "|cFF20C000"
    set yd_PlayerColor [7] = "|cFFE55BB0"
    set yd_PlayerColor [8] = "|cFF959697"
    set yd_PlayerColor [9] = "|cFF7EBFF1"
    set yd_PlayerColor[10] = "|cFF106246"
    set yd_PlayerColor[11] = "|cFF4E2A04"
    set yd_PlayerColor[12] = "|cFF282828"
    set yd_PlayerColor[13] = "|cFF282828"
    set yd_PlayerColor[14] = "|cFF282828"
    set yd_PlayerColor[15] = "|cFF282828"
    //=================显示版本=====================
    call YDWEVersion_Init()
endfunction
endlibrary
//===========================================================================
//系统-TimerSystem
//===========================================================================
library YDWETimerSystem initializer Init requires YDTriggerSaveLoadSystem
globals
	private integer CurrentTime
	private integer CurrentIndex
    private integer TaskListHead
    private integer TaskListIdleHead
    private integer TaskListIdleMax
    private integer array TaskListIdle
    private integer array TaskListNext
    private integer array TaskListTime
    private trigger array TaskListProc //函数组
private trigger fnRemoveUnit //移除单位函数
private trigger fnDestroyTimer //摧毁计时器
private trigger fnRemoveItem //移除物品
private trigger fnDestroyEffect //删除特效
private trigger fnDestroyLightning //删除删掉特效
private trigger fnRunTrigger //运行触发器
private timer Timer //最小时间计时器  系统计时器  用于一些需要精确计时的功能
private integer TimerHandle
	private integer TimerSystem_RunIndex = 0
endglobals
private function NewTaskIndex takes nothing returns integer
	local integer h = TaskListIdleHead
	if TaskListIdleHead < 0 then
		if TaskListIdleMax >= 8000 then
			debug call BJDebugMsg("中心计时器任务队列溢出！")
			return 8100
		else
			set TaskListIdleMax = TaskListIdleMax + 1
			return TaskListIdleMax
		endif
	endif
	set TaskListIdleHead = TaskListIdle[h]
	return h
endfunction
private function DeleteTaskIndex takes integer index returns nothing
	set TaskListIdle[index] = TaskListIdleHead
	set TaskListIdleHead = index
endfunction
//该函数序列处理
private function NewTask takes real time, trigger proc returns integer
	local integer index = NewTaskIndex()
	local integer h = TaskListHead
	local integer t = R2I(100.*time) + CurrentTime
	local integer p
	set TaskListProc[index] = proc
	set TaskListTime[index] = t
	loop
		set p = TaskListNext[h]
		if p < 0 or TaskListTime[p] >= t then
		//	call BJDebugMsg("NewTask:"+I2S(index))
			set TaskListNext[h] = index
			set TaskListNext[index] = p
			return index
		endif
		set h = p
	endloop
	return index
endfunction
function YDWETimerSystemNewTask takes real time, trigger proc returns integer
	return NewTask(time, proc)
endfunction
function YDWETimerSystemGetCurrentTask takes nothing returns integer
	return CurrentIndex
endfunction
//删除单位
private function RemoveUnit_CallBack takes nothing returns nothing
    call RemoveUnit(YDHashGet(YDHASH_HANDLE, unit, TimerHandle, CurrentIndex))
    call YDHashClear(YDHASH_HANDLE, unit, TimerHandle, CurrentIndex)
endfunction
function YDWETimerRemoveUnit takes real time, unit u returns nothing
    call YDHashSet(YDHASH_HANDLE, unit, TimerHandle, NewTask(time, fnRemoveUnit), u)
endfunction
//摧毁计时器
private function DestroyTimer_CallBack takes nothing returns nothing
    call DestroyTimer(YDHashGet(YDHASH_HANDLE, timer, TimerHandle, CurrentIndex))
    call YDHashClear(YDHASH_HANDLE, timer, TimerHandle, CurrentIndex)
endfunction
function YDWETimerDestroyTimer takes real time, timer t returns nothing
    call YDHashSet(YDHASH_HANDLE, timer, TimerHandle, NewTask(time, fnDestroyTimer), t)
endfunction
//删除物品
private function RemoveItem_CallBack takes nothing returns nothing
    call RemoveItem(YDHashGet(YDHASH_HANDLE, item, TimerHandle, CurrentIndex))
    call YDHashClear(YDHASH_HANDLE, item, TimerHandle, CurrentIndex)
endfunction
function YDWETimerRemoveItem takes real time, item it returns nothing
    call YDHashSet(YDHASH_HANDLE, item, TimerHandle, NewTask(time, fnRemoveItem), it)
endfunction
//删除特效
private function DestroyEffect_CallBack takes nothing returns nothing
    call DestroyEffect(YDHashGet(YDHASH_HANDLE, effect, TimerHandle, CurrentIndex))
    call YDHashClear(YDHASH_HANDLE, effect, TimerHandle, CurrentIndex)
endfunction
function YDWETimerDestroyEffect takes real time, effect e returns nothing
    call YDHashSet(YDHASH_HANDLE, effect, TimerHandle, NewTask(time, fnDestroyEffect), e)
endfunction
//删除闪电特效
private function DestroyLightning_CallBack takes nothing returns nothing
    call DestroyLightning(YDHashGet(YDHASH_HANDLE, lightning, TimerHandle, CurrentIndex))
    call YDHashClear(YDHASH_HANDLE, lightning, TimerHandle, CurrentIndex)
endfunction
function YDWETimerDestroyLightning takes real time, lightning lt returns nothing
	local integer i = NewTask(time, fnDestroyLightning)
    call YDHashSet(YDHASH_HANDLE, lightning, TimerHandle, i, lt)
endfunction
//运行触发器
private function RunTrigger_CallBack takes nothing returns nothing
    call TriggerExecute(YDHashGet(YDHASH_HANDLE, trigger, TimerHandle, CurrentIndex))
    call YDHashClear(YDHASH_HANDLE, trigger, TimerHandle, CurrentIndex)
endfunction
function YDWETimerRunTrigger takes real time, trigger trg returns nothing
    call YDHashSet(YDHASH_HANDLE, trigger, TimerHandle, NewTask(time, fnRunTrigger), trg)
endfunction
//删除漂浮文字
function YDWETimerDestroyTextTag takes real time, texttag tt returns nothing
    local integer N=0
    local integer i=0
    if time <= 0 then
        set time = 0.01
    endif
    call SetTextTagPermanent(tt,false)
    call SetTextTagLifespan(tt,time)
    call SetTextTagFadepoint(tt,time)
endfunction
//中心计时器主函数
private function Main takes nothing returns nothing
	local integer h = TaskListHead
	local integer p
	loop
		set CurrentIndex = TaskListNext[h]
		exitwhen CurrentIndex < 0 or CurrentTime < TaskListTime[CurrentIndex]
		//call BJDebugMsg("Task:"+I2S(CurrentIndex))
		call TriggerEvaluate(TaskListProc[CurrentIndex])
		call DeleteTaskIndex(CurrentIndex)
		set TaskListNext[h] = TaskListNext[CurrentIndex]
	endloop
	set CurrentTime = CurrentTime + 1
endfunction
//初始化函数
private function Init takes nothing returns nothing
    set Timer = CreateTimer()
	set TimerHandle	= YDHashAny2I(timer, Timer)
	set CurrentTime = 0
	set TaskListHead = 0
	set TaskListNext[0] = -1
	set TaskListIdleHead = 1
	set TaskListIdleMax = 1
	set TaskListIdle[1] = -1
	set fnRemoveUnit = CreateTrigger()
	set fnDestroyTimer = CreateTrigger()
	set fnRemoveItem = CreateTrigger()
	set fnDestroyEffect = CreateTrigger()
	set fnDestroyLightning = CreateTrigger()
	set fnRunTrigger = CreateTrigger()
	call TriggerAddCondition(fnRemoveUnit, Condition(function RemoveUnit_CallBack))
	call TriggerAddCondition(fnDestroyTimer, Condition(function DestroyTimer_CallBack))
	call TriggerAddCondition(fnRemoveItem, Condition(function RemoveItem_CallBack))
	call TriggerAddCondition(fnDestroyEffect, Condition(function DestroyEffect_CallBack))
	call TriggerAddCondition(fnDestroyLightning, Condition(function DestroyLightning_CallBack))
	call TriggerAddCondition(fnRunTrigger, Condition(function RunTrigger_CallBack))
    call TimerStart(Timer, 0.01, true, function Main)
endfunction
//循环类仍用独立计时器
function YDWETimerSystemGetRunIndex takes nothing returns integer
    return TimerSystem_RunIndex
endfunction
private function RunPeriodicTriggerFunction takes nothing returns nothing
    local integer tid = YDHashAny2I(timer, GetExpiredTimer())
    local trigger trg = YDHashGet(YDHASH_HANDLE, trigger, tid, $D0001)
	call YDHashSetByString(YDHASH_HANDLE, integer, I2S(YDHashAny2I(trigger, trg)), "RunIndex", YDHashGet(YDHASH_HANDLE, integer, tid, $D0002))
    if TriggerEvaluate(trg) then
        call TriggerExecute(trg)
    endif
    set trg = null
endfunction
private function RunPeriodicTriggerFunctionByTimes takes nothing returns nothing
    local integer tid = YDHashAny2I(timer, GetExpiredTimer())
    local trigger trg = YDHashGet(YDHASH_HANDLE, trigger, tid, $D0001)
    local integer times = YDHashGet(YDHASH_HANDLE, integer, tid, $D0003)
	call YDHashSetByString(YDHASH_HANDLE, integer, I2S(YDHashAny2I(trigger, trg)), "RunIndex", YDHashGet(YDHASH_HANDLE, integer, tid, $D0002))
    if TriggerEvaluate(trg) then
        call TriggerExecute(trg)
    endif
    set times = times - 1
    if times > 0 then
		call YDHashSet(YDHASH_HANDLE, integer, tid, $D0003, times)
      else
        call DestroyTimer(GetExpiredTimer())
        call YDHashClearTable(YDHASH_HANDLE, tid)
    endif
    set trg = null
endfunction
function YDWETimerRunPeriodicTrigger takes real timeout, trigger trg, boolean b, integer times, integer data returns nothing
    local timer t
    local integer tid
    local integer index = 0
    if timeout < 0 then
        return
      else
        set t = CreateTimer()
		set tid = YDHashAny2I(timer, t)
    endif
    set TimerSystem_RunIndex = TimerSystem_RunIndex + 1
	call YDHashSet(YDHASH_HANDLE, trigger, tid, $D0001, trg)
	call YDHashSet(YDHASH_HANDLE, integer, tid, $D0002, TimerSystem_RunIndex)
	set index = YDHashGet(YDHASH_HANDLE, integer, YDHashAny2I(trigger, trg), 'YDTS'+data)
    set index = index + 1
	call YDHashSet(YDHASH_HANDLE, integer, YDHashAny2I(trigger, trg), 'YDTS'+data, index)
	call YDHashSet(YDHASH_HANDLE, timer, YDHashAny2I(trigger, trg), ('YDTS'+data)*index, t)
    if b == false then
		call YDHashSet(YDHASH_HANDLE, integer, tid, $D0003, times)
        call TimerStart(t, timeout, true, function RunPeriodicTriggerFunctionByTimes)
      else
        call TimerStart(t, timeout, true, function RunPeriodicTriggerFunction)
    endif
    set t = null
endfunction
function YDWETimerRunPeriodicTriggerOver takes trigger trg, integer data returns nothing
	local integer trgid = YDHashAny2I(trigger, trg)
    local integer index = YDHashGet(YDHASH_HANDLE, integer, trgid, 'YDTS'+data)
    local timer t
    loop
        exitwhen index <= 0
        set t = YDHashGet(YDHASH_HANDLE, timer, trgid, ('YDTS'+data)*index)
        call DestroyTimer(t)
        call YDHashClearTable(YDHASH_HANDLE, YDHashAny2I(timer, t))
		call YDHashClear(YDHASH_HANDLE, timer, trgid, ('YDTS'+data)*index)
        set index = index - 1
    endloop
    call YDHashClear(YDHASH_HANDLE, integer, trgid, 'YDTS'+data)
    set t = null
endfunction
endlibrary
library YDWEGetUnitsOfPlayerMatchingNull
globals
    group yd_NullTempGroup
endglobals
function YDWEGetUnitsOfPlayerMatchingNull takes player whichPlayer, boolexpr filter returns group
    local group g = CreateGroup()
    call GroupEnumUnitsOfPlayer(g, whichPlayer, filter)
    call DestroyBoolExpr(filter)
    set yd_NullTempGroup = g
    set g = null
    return yd_NullTempGroup
endfunction
endlibrary
library YDWETriggerRegisterLeaveRectSimpleNull
globals
    region yd_NullTempRegion
endglobals
function YDWETriggerRegisterLeaveRectSimpleNull takes trigger trig, rect r returns event
    local region rectRegion = CreateRegion()
    call RegionAddRect(rectRegion, r)
    set yd_NullTempRegion = rectRegion
    set rectRegion = null
    return TriggerRegisterLeaveRegion(trig, yd_NullTempRegion, null)
endfunction
endlibrary
/*

japi引用的常量库 由于wave宏定义 只对以下的代码有效

请将常量库里所有内容复制到  自定义脚本代码区
*/
//魔兽版本 用GetGameVersion 来获取当前版本 来对比以下具体版本做出相应操作
//-----------模拟聊天------------------
//---------技能数据类型---------------
//冷却时间
//目标允许
//施放时间
//持续时间
//持续时间
//魔法消耗
//施放间隔
//影响区域
//施法距离
//数据A
//数据B
//数据C
//数据D
//数据E
//数据F
//数据G
//数据H
//数据I
//单位类型
//热键
//关闭热键
//学习热键
//名字
//图标
//目标效果
//施法者效果
//目标点效果
//区域效果
//投射物
//特殊效果
//闪电效果
//buff提示
//buff提示
//学习提示
//提示
//关闭提示
//学习提示
//提示
//关闭提示
//----------物品数据类型----------------------
//物品图标
//物品提示
//物品扩展提示
//物品名字
//物品说明
//------------单位数据类型--------------
//攻击1 伤害骰子数量
//攻击1 伤害骰子面数
//攻击1 基础伤害
//攻击1 升级奖励
//攻击1 最小伤害
//攻击1 最大伤害
//攻击1 全伤害范围
//装甲
// attack 1 attribute adds
//攻击1 伤害衰减参数
//攻击1 武器声音
//攻击1 攻击类型
//攻击1 最大目标数
//攻击1 攻击间隔
//攻击1 攻击延迟/summary>
//攻击1 弹射弧度
//攻击1 攻击范围缓冲
//攻击1 目标允许
//攻击1 溅出区域
//攻击1 溅出半径
//攻击1 武器类型
// attack 2 attributes (sorted in a sequencial order based on memory address)
//攻击2 伤害骰子数量
//攻击2 伤害骰子面数
//攻击2 基础伤害
//攻击2 升级奖励
//攻击2 伤害衰减参数
//攻击2 武器声音
//攻击2 攻击类型
//攻击2 最大目标数
//攻击2 攻击间隔
//攻击2 攻击延迟
//攻击2 攻击范围
//攻击2 攻击缓冲
//攻击2 最小伤害
//攻击2 最大伤害
//攻击2 弹射弧度
//攻击2 目标允许类型
//攻击2 溅出区域
//攻击2 溅出半径
//攻击2 武器类型
//装甲类型
//! zinc
/*
伤害工具
*/
library DamageUtils requires UnitFilter,GroupUtils {
    //旧名替换:DamageSingle
    //单体伤害:物理
    public function ApplyPhysicalDamage (unit u,unit target,real dmg,boolean bj) {
        static if (LIBRARY_Damage) {dmgF.isBJ = bj;}
        UnitDamageTarget( u, target, dmg, false, false, ATTACK_TYPE_HERO, DAMAGE_TYPE_NORMAL, WEAPON_TYPE_WHOKNOWS );
    }
    //单体伤害:真实
    public function ApplyPureDamage (unit u,unit target,real dmg,boolean bj) {
        static if (LIBRARY_Damage) {dmgF.isBJ = bj;}
        UnitDamageTarget( u, target, dmg, false, false, ATTACK_TYPE_CHAOS, DAMAGE_TYPE_SLOW_POISON, WEAPON_TYPE_WHOKNOWS );
    }
    //模拟普攻(最后一个参数代表额外的终伤,0)
    public function SimulateBasicAttack (unit u,unit target,real fd) {
        UnitDamageTarget( u, target, GetUnitState(u,ConvertUnitState(0x12))*(1.0+fd), true, false, ATTACK_TYPE_HERO, DAMAGE_TYPE_NORMAL, WEAPON_TYPE_WHOKNOWS );
    }
    //伤害参数结构体
    private struct DmgP {
        unit source; //伤害来源
string eft; //特效
real damage; //伤害值
boolean isBj; //是否暴击

        method destroy() {
            this.source = null;
            this.eft = null;
        }
    }
    //伤害参数栈
    public struct DmgS [] {
        private static DmgP stack[100];
        private static integer top = -1;
        public static method push(DmgP params) {
            thistype.top += 1;
            thistype.stack[thistype.top] = params;
        }
        public static method pop() -> DmgP {
            DmgP params = thistype.stack[thistype.top];
            thistype.stack[thistype.top] = 0;
            thistype.top -= 1;
            return params;
        }
        public static method getTop() -> integer {
            return thistype.top;
        }
        public static method current() -> DmgP {
            return thistype.stack[thistype.top];
        }
    }
    //范围普通伤害
    public function DamageArea (unit u,real x,real y,real radius,real damage,boolean bj,string efx) {
        group g = CreateGroup();
        DmgP params = DmgP.create();
        params.source = u;
        params.eft = efx;
        params.damage = damage;
        params.isBj = bj;
        DmgS.push(params);
        GroupEnumUnitsInRangeEx(g, x, y, radius, Filter(function () -> boolean {
            DmgP current = DmgS.current();
            if (IsEnemy(GetOwningPlayer(current.source),GetFilterUnit())) {
                ApplyPhysicalDamage(current.source,GetFilterUnit(),current.damage,current.isBj);
                if (current.eft != null) {
                    DestroyEffect(AddSpecialEffect(current.eft, GetUnitX(GetFilterUnit()),GetUnitY(GetFilterUnit())));
                }
                return true;
            }
            return false;
        }));
        params = DmgS.pop();
        params.destroy();
        DestroyGroup(g);
        g = null;
    }
    //范围真实伤害
    public function DamageAreaPure (unit u,real x,real y,real radius,real damage,boolean bj,string efx) {
        group g = CreateGroup();
        DmgP params = DmgP.create();
        params.source = u;
        params.eft = efx;
        params.damage = damage;
        params.isBj = bj;
        DmgS.push(params);
        GroupEnumUnitsInRangeEx(g, x, y, radius, Filter(function () -> boolean {
            DmgP current = DmgS.current();
            if (IsEnemy(GetOwningPlayer(current.source),GetFilterUnit())) {
                ApplyPureDamage(current.source,GetFilterUnit(),current.damage,current.isBj);
                if (current.eft != null) {
                    DestroyEffect(AddSpecialEffect(current.eft, GetUnitX(GetFilterUnit()),GetUnitY(GetFilterUnit())));
                }
                return true;
            }
            return false;
        }));
        params = DmgS.pop();
        params.destroy();
        DestroyGroup(g);
        g = null;
    }
}
//! endzinc
//===========================================================================  
//万能环绕模板 
//===========================================================================
library YDWEAroundSystem requires YDWEBase
//library TP1 requires YDWEBase
    globals
        private constant timer AROUND_TIM = CreateTimer()
        private constant real AROUND_INTER = 0.01
    endglobals
    private struct Data
        static thistype array Structs
        static integer Total = 0
        unit caster = null
        unit obj = null 
        real dur = 0.
        real inter = 0.
        real each = 0. 
        real rate = 0.
        real dis = 0.
        real rise = 0. 
        real angle = 0.
        real radius = 0.
        real height = 0
    endstruct
    private function spin takes nothing returns nothing
        local Data d = 0
        local real x = 0.
        local real y = 0.
        local integer inst = 0
        
        loop
            exitwhen (inst == Data.Total)
            set d = Data.Structs[inst]
            if ( d.dur > 0 ) and (GetUnitState(d.caster, UNIT_STATE_LIFE)>0) and (GetUnitState(d.obj, UNIT_STATE_LIFE)>0) then
                set d.each = d.each + AROUND_INTER
                if ( d.each >= d.inter ) then
                    set d.angle = d.angle + d.rate
                    set d.radius = d.radius + d.dis
                    set d.height = d.height + d.rise
                    set x = GetUnitX(d.caster) + d.radius*Cos(d.angle)
                    set y = GetUnitY(d.caster) + d.radius*Sin(d.angle)
                    set x = YDWECoordinateX(x)
                    set y = YDWECoordinateY(y)
                    call SetUnitX(d.obj, x)
                    call SetUnitY(d.obj, y)
                    call SetUnitFlyHeight(d.obj, d.height, 0.)
                    set d.each = 0.
                endif
                set d.dur = d.dur - AROUND_INTER
            else 
                set bj_lastAbilityTargetUnit=d.caster
                call YDWESyStemAbilityCastingOverTriggerAction(d.obj,10) 
                set d.caster = null
                set d.obj = null
                call d.destroy()
                set Data.Total = Data.Total - 1
                set Data.Structs[inst] = Data.Structs[Data.Total]
                set inst = inst - 1
            endif
            set inst = inst + 1
        endloop
        if ( Data.Total == 0 ) then
            call PauseTimer(AROUND_TIM)
        endif
    endfunction
    function YDWEAroundSystem takes unit satellite, unit star, real angleRate, real displacement, real riseRate,real timeout, real interval returns nothing
        local Data d = Data.create()
        local real x1 = GetUnitX(star)
        local real y1 = GetUnitY(star)
        local real x2 = GetUnitX(satellite)
        local real y2 = GetUnitY(satellite)
        set d.caster = star
        set d.obj = satellite
        set d.dur = timeout
        set d.inter = interval
        set d.rate = angleRate*(3.14159/180.)
        set d.dis = displacement
        set d.rise = riseRate
        set d.angle = Atan2(y2-y1,x2-x1)
        set d.radius = SquareRoot((x2-x1)*(x2-x1)+(y2-y1)*(y2-y1))
        set d.height = GetUnitFlyHeight(d.obj) 
        set Data.Structs[Data.Total] = integer(d)
        set Data.Total = Data.Total + 1 
        if ( Data.Total - 1 == 0 ) then
            call TimerStart(AROUND_TIM, AROUND_INTER, true, function spin)
        endif
    endfunction
    
endlibrary 
//! zinc
/*
转换工具
*/
library ConversionUtils {
    //补充函数
    public function B2S(boolean b) -> string {
        if (b) {return "true";}
        else {return "false";}
    }
    //三目运算符
    public function S3 (boolean b,string s1,string s2) -> string {
        if (b) {return s1;}
        else {return s2;}
    }
    //三目运算符
    public function I3 (boolean b,integer i1,integer i2) -> integer {
        if (b) {return i1;}
        else {return i2;}
    }
    //三目运算符
    public function R3 (boolean b,real r1,real r2) -> real {
        if (b) {return r1;}
        else {return r2;}
    }
    // 将数字转换为魔兽的四字符ID,使用256进制但限制36个数一进位
    // pos为输入数字,每36个数字进一位,每位用0-9和a-z表示(共36个字符)
    // 示例:0->'0000', 35->'000z', 36->'0010'(进位), 37->'0011'
    public function GetIDSymbol ( integer pos ) -> integer {
        integer bit = pos/36;
        pos = ModuloInteger(pos,36);
        if (pos < 10) {return pos + bit * 256;}
        else {return '000a' - '0000' + pos - 10 + bit * 256;}
    }
    // 将魔兽的四字符ID转换回对应数字
    // s为输入的四字符ID,将其还原为原始数字
    // 示例:'0000'->0, '000z'->35, '0010'->36, '0011'->37
    public function GetSymbolID ( integer s ) -> integer {
        integer i1 = s/256;
        integer i2 = ModuloInteger(s,256);
        if (i2 < 10) {return i1 * 36 + i2;}
        else {return i2 - '000a' + '0000' + 10 + i1 * 36;}
    }
}
//! endzinc
//! zinc
/*
字符串工具
*/
library StringUtils {
    string temp;
    //重复某一个字符串N次,并可以按照指定间隔添加空格和换行
    //参数 s: 要重复的字符串
    //参数 times: 重复的次数
    //参数 gap1: 每隔多少个字符串添加一个空格,如gap1=3则每3个字符串后加空格
    //参数 gap2: 每隔多少个字符串添加一个换行,如gap2=5则每5个字符串后换行
    //返回: 处理后的完整字符串
    //示例: RepeatString("A",6,2,3) 会返回 "AA AA A\nA"
    public function RepeatString (string s,integer times,integer gap1,integer gap2) -> string {
        integer i;
        temp = "";
        for (1 <= i <= times) {
            temp += s;
            if (ModuloInteger(i,gap1) == 0) temp += " ";
            if (ModuloInteger(i,gap2) == 0) temp += "\n";
        }
        return temp;
    }
    //判断一个字符串是否有东西
    public function IsNotEmpty (string s) -> boolean {return (s != null && s != "");}
    // 数字转字符串,首位自动填充0
    // 不支持负数
    // 比如12,3   -> 012
    public function I2SM ( integer num,integer bit ) -> string {
        integer i , count;
        string s;
        if (num < 0) {return I2S(num);}
        s = I2S(num);
        count = bit - StringLength(s);
        for (1 <= i <= count) {s = "0" + s;}
        return s;
    }
    //赞助系统：循环Hash
    public function GetCycleHash ( string s,integer times ) -> integer {
        string result = s;
        integer i;
        for (1 <= i <= times) {
            result = I2S(StringHash(result));
        }
        return S2I(result);
    }
    //拼接式存放数据的API
    //自动将整数补至10位长度的字符串(会自动取绝对值)
    public function IMendS ( integer num,integer bit ) -> string {
        integer abs = IAbsBJ(num);
        string result = I2S(abs);
        integer i , length = StringLength(result);
        for (1 <= i <= bit - length) {result = "0" + result;}
        return result;
    }
}
//! endzinc
library YDWEGetForceOfPlayerNull
globals
    force yd_NullTempForce
endglobals
function YDWEGetForceOfPlayerNull takes player whichPlayer returns force
    local force f = CreateForce()
    call ForceAddPlayer(f, whichPlayer)
    set yd_NullTempForce = f
    set f = null
    return yd_NullTempForce
endfunction
endlibrary
library_once YDWETimerPattern initializer Init requires YDWEBase
//***************************************************
//*  - Matrix ģ庯
//*--------------------
//* ߣWarft_TigerCN  ŻFetrix_sai
//***************************************************
    private keyword Thread
    globals
        private boolexpr Bexpr = null
        private rect Area = null
        private Thread tmp_data
        private location yd_loc = Location(0.0, 0.0)
    endglobals
    private struct YDVector3
        real x
        real y
        real z
    endstruct
    function interface AfterCollied takes Thread t,real nx,real ny returns nothing
    //-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=
    //                                       Timer Pattern Union                                              //
    //-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=
    private function SingleMagic takes unit sour, unit targ, real x, real y, real h, integer uid, integer aid, integer lv, integer order returns nothing
        local unit dummy = CreateUnit(GetOwningPlayer(sour), uid, x, y, GetUnitFacing(sour))
        call UnitApplyTimedLife(dummy, 'BHwe', 1.0)
        call UnitAddAbility(dummy, aid)
        call SetUnitAbilityLevel(dummy, aid, lv)
        call SetUnitFlyHeight(dummy, h, 0.0)
        call IssueTargetOrderById(dummy, order, targ)
        //debug call BJDebugMsg("Target order")
        set dummy = null
    endfunction
    private function GetUnitZ takes unit u returns real
        call MoveLocation(yd_loc, GetUnitX(u), GetUnitY(u))
        return GetUnitFlyHeight(u) + GetLocationZ(yd_loc)
    endfunction
    //-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=
    //                                            Filter Funcs                                                //
    //-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=
    private function EnemyFilter takes unit u, unit caster returns boolean
        return IsUnitType(u, UNIT_TYPE_MAGIC_IMMUNE) == false and IsUnitType(u, UNIT_TYPE_RESISTANT) == false /*
        */and IsUnitType(u, UNIT_TYPE_SLEEPING) == false and GetUnitState(u, UNIT_STATE_LIFE) > 0.405 /*
        */and IsUnitType(u, UNIT_TYPE_STRUCTURE) == false and IsUnitIllusion(u) == false /*
        */and IsUnitHidden(u) == false and IsUnitEnemy(u, GetOwningPlayer(caster)) /*
        */and IsUnitVisible(u, GetOwningPlayer(caster))
    endfunction
    private function TreeFilter takes nothing returns boolean
        local integer id = GetDestructableTypeId(GetFilterDestructable())
        return id == 'LTlt' or id == 'ATtr' or id == 'BTtw' or id == 'KTtw' /*
          */or id == 'YTft' or id == 'JTct' or id == 'YTst' or id == 'YTct' /*
          */or id == 'YTwt' or id == 'JTtw' or id == 'DTsh' or id == 'FTtw' /*
          */or id == 'CTtr' or id == 'ITtw' or id == 'NTtw' or id == 'OTtw' /*
          */or id == 'ZTtw' or id == 'WTst' or id == 'GTsh' or id == 'VTlt' /*
          */or id == 'WTtw' or id == 'ATtc' or id == 'BTtc' or id == 'CTtc' /*
          */or id == 'ITtc' or id == 'NTtc' or id == 'ZTtc'
    endfunction
    private function DamageFilter takes nothing returns boolean
        local unit u = GetFilterUnit()
        local Thread d = tmp_data
        //call BJDebugMsg("outer:"+I2S(CountUnitsInGroup(d.g)))
        if not(IsUnitInGroup(u, d.g)) and d.switch != 0 and EnemyFilter(u, d.caster) then
            call GroupAddUnit(d.g, u)
            call BJDebugMsg(I2S(YDWEH2I(u)))
            call UnitDamageTarget(d.caster, u, d.amount, true, true, bj_lastSetAttackType, bj_lastSetDamageType, bj_lastSetWeaponType)
            //call DestroyEffect(AddSpecialEffectTarget(d.dsfx, u, d.part))
            call DestroyEffect( AddSpecialEffect(d.dsfx, GetUnitX(u), GetUnitY(u)) )
           // call BJDebugMsg(":" + d.dsfx)
            if d.skills > '0000' and d.skills != null and d.order > 0 and d.order != null then
                call SingleMagic(d.caster, u, d.pos.x, d.pos.y, GetUnitFlyHeight(d.obj), d.unitid, d.skills, d.level, d.order)
            endif
            if not(d.recycle) then
                //debug call BJDebugMsg("|cff00ff00[YDWE] Timer Pattern : |r A one-time.")
                set d.switch = 0
            endif
            set d.target = u
            set u = null
            return true
        endif
        set u = null
        return false
    endfunction
    private function TreeKill takes nothing returns nothing
        local destructable d = GetEnumDestructable()
        if GetWidgetLife(d) > 0.405 then
            call KillDestructable(d)
        endif
        set d = null
    endfunction
    //-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=
    //                                         Major Structure Code                                           //
    //-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=
    private struct Thread
        YDVector3 des //destination
YDVector3 pos //position
YDVector3 vel //velocity
unit caster
        unit source
        unit target
        unit obj
        real ac
        real bc
        real dist
        real step
        real amount
        real radius
        integer switch
        integer follow
        integer unitid
        integer skills
        integer order
        integer level
        string dsfx
        string gsfx
        string wsfx
        string part
        boolean recycle
        boolean killdest
        boolean volume
        group g
        timer t
        AfterCollied afc
        static method operator [] takes handle h returns thistype
            return YDWEGetIntegerByString("YDWETimerPattern.", I2S(YDWEH2I(h)))
        endmethod
        static method operator []= takes handle h, thistype value returns nothing
            call YDWESaveIntegerByString("YDWETimerPattern.", I2S(YDWEH2I(h)), value)
        endmethod
        static method flush takes handle h returns nothing
            call YDWEFlushStoredIntegerByString("YDWETimerPattern.", I2S(YDWEH2I(h)))
        endmethod
        method operator x= takes real value returns nothing
            set .pos.x = value
            call SetUnitX(.obj, value)
        endmethod
        method operator y= takes real value returns nothing
            set .pos.y = value
            call SetUnitY(.obj, value)
        endmethod
        method operator z= takes real value returns nothing
            set .pos.z = value
            call MoveLocation(yd_loc, .pos.x, .pos.y)
            call SetUnitFlyHeight(.obj, value - GetLocationZ(yd_loc), 0)
        endmethod
        method onDestroy takes nothing returns nothing
            //debug call BJDebugMsg("|cff00ff00[YDWE] Timer Pattern : |r Knockback stopped!")
            call Thread.flush(.obj)
            call Thread.flush(.t)
            call GroupClear(.g)
            call DestroyGroup(.g)
            call PauseTimer(.t)
            call DestroyTimer(.t)
            call .des.destroy()
            call .pos.destroy()
            call .vel.destroy()
            set .caster = null
            set .target = null
            set .obj = null
            set .g = null
            set .t = null
            set .amount = 0
            set .skills = 0
            set .order = 0
            set .afc = 0
            set .dsfx = ""
            set .gsfx = ""
            set .wsfx = ""
            set .part = ""
        endmethod
    endstruct
    private struct Parabola extends Thread
        static method move takes nothing returns nothing
            local thistype this = Thread[GetExpiredTimer()]
            //local real vx = .des.x - .pos.x
            //local real vy = .des.y - .pos.y
            //local real vz = .des.z - .pos.z
            //if vx * vx + vy * vy + vz * vz > 900.0 then
                set .x = GetUnitX(.obj) + .vel.x //.pos.x + .vel.x
set .y = GetUnitY(.obj) + .vel.y //.pos.y + .vel.y
set .z = GetUnitZ(.obj) + .ac * .step * 2 + .ac * .dist + .bc //.pos.z + .ac * .step * 2 + .ac * .dist + .bc
set .step = .step + .dist
                //debug call BJDebugMsg("|cff00ff00[YDWE] Timer Pattern : |r high = ." + R2S(GetLocationZ(yd_loc)))
                if YDWECoordinateX(.pos.x) != .pos.x or YDWECoordinateY(.pos.y) != .pos.y or .pos.z <= GetLocationZ(yd_loc) then
                    set .switch = 0
                endif
                if .amount > 0.0 then
                    //call this.damage(.caster, .pos.x + .vel.x, .pos.y + .vel.y, GetUnitZ(.obj), false, false)
                    set tmp_data = integer(this)
                    call GroupEnumUnitsInRange(.g, .pos.x + .vel.x, .pos.y + .vel.y, 120.0, function DamageFilter)
                    //debug call BJDebugMsg("|cff00ff00[YDWE] Timer Pattern : |r Area damage.")
                endif
            //else
                //set .switch = 0
            //endif
            if .switch == 0 then
                call SetUnitFlyHeight(.obj, GetUnitDefaultFlyHeight(.obj), 200.0)
                call SetUnitTimeScale(.obj, 1)
                //YDWETriggerEvent
                call YDWESyStemAbilityCastingOverTriggerAction(.obj, 7)
                call this.destroy()
            endif
        endmethod
        static method create takes unit source, unit object, real angle, real distance, real time, real interval, real high, real damage, string attach, string deff returns thistype
            local thistype this = thistype.allocate()
            local real vx = 0.0
            local real vy = 0.0
            local real vz = 0.0
            set .des = YDVector3.create()
            set .pos = YDVector3.create()
            set .vel = YDVector3.create()
            set .pos.x = GetUnitX(object)
            set .pos.y = GetUnitY(object)
            set .pos.z = GetUnitZ(object)
            set .des.x = .pos.x + distance * Cos(angle)
            set .des.y = .pos.y + distance * Sin(angle)
            call MoveLocation(yd_loc, .des.x, .des.y)
            set .des.z = GetLocationZ(yd_loc)
            if .pos.z > .des.z then
                set high = high + .pos.z
            else
                set high = high + .des.z
            endif
            set .ac = (2 * (.pos.z + .des.z) - 4 * high) / (distance * distance)
            set .bc = (.des.z - .pos.z - .ac * distance * distance) / distance
            set .dist = distance * interval / time
            set .ac = .ac * .dist
            set .bc = .bc * .dist
            set .vel.x = .dist * Cos(angle)
            set .vel.y = .dist * Sin(angle)
            set .step = 0.0
            set .caster = source
            set .obj = object
            set .amount = damage
            set .dsfx = deff
            set .part = attach
            set .switch = 1
            set .recycle = true
            set .t = CreateTimer()
            set .g = CreateGroup()
            call UnitAddAbility(.obj, 'Amrf')
            call UnitRemoveAbility(.obj, 'Amrf')
            call TimerStart(.t, interval, true, function thistype.move)
            call GroupAddUnit(.g, object)
            set Thread[object] = integer(this)
            set Thread[.t] = integer(this)
            return this
        endmethod
    endstruct
    // uniform speed
    private struct Linear extends Thread
        static method move takes nothing returns nothing
            local thistype this = Thread[GetExpiredTimer()]
            if .step > .dist then
                set .x = GetUnitX(.obj) + .vel.x //.pos.x + .vel.x
set .y = GetUnitY(.obj) + .vel.y //.pos.y + .vel.y
//set .pos.z = GetUnitZ(.obj)
set .step = .step - .dist
                //call this.damage(.caster, .pos.x, .pos.y, .pos.z, true, true)
                set tmp_data = integer(this)
                call GroupEnumUnitsInRange(.g, .pos.x + .vel.x, .pos.y + .vel.y, 120.0, function DamageFilter)
                if YDWECoordinateX(.pos.x) != .pos.x or YDWECoordinateY(.pos.y) != .pos.y then
                    set .switch = 0
                endif
            else
                set .switch = 0
            endif
            if .switch == 0 then
                // YDWETriggerEvent
                if .target != null then
                    //debug call BJDebugMsg("|cff00ff00[YDWE] Timer Pattern : |r  |cffff0000" + GetUnitName(.target) + "|r was hit!!!")
                    //call YDWESaveUnitByString(I2S(YDWEH2I(.caster)), "MoonPriestessArrow", .target)
                    set bj_lastAbilityTargetUnit = .target
                    call YDWESyStemAbilityCastingOverTriggerAction(.caster, 8)
                else
                    call YDWESyStemAbilityCastingOverTriggerAction(.caster, 9)
                endif
                //call KillUnit(.obj)
                call RemoveUnit(.obj)
                call this.destroy()
            endif
        endmethod
        static method create takes unit source, unit object, real angle, real distance, real time, real interval, integer uid, integer aid, integer lv, integer orderid, string attach, string sfx returns thistype
            local thistype this = thistype.allocate()
            set .des = YDVector3.create()
            set .pos = YDVector3.create()
            set .vel = YDVector3.create()
            set .step = distance
            set .dist = distance * interval / time
            set .vel.x = .dist * Cos(angle)
            set .vel.y = .dist * Sin(angle)
            set .pos.x = GetUnitX(object)
            set .pos.y = GetUnitY(object)
            set .caster = source
            set .obj = object
            set .unitid = uid
            set .skills = aid
            set .level = lv
            set .order = orderid
            set .part = attach
            set .gsfx = sfx
            set .switch = 1
            set .recycle = false
            set .t = CreateTimer()
            set .g = CreateGroup()
            call TimerStart(.t, interval, true, function thistype.move)
            set Thread[.t] = integer(this)
            return this
        endmethod
    endstruct
    // Uniform deceleration
    private struct Deceleration extends Thread
        static method move takes nothing returns nothing
            local thistype this = Thread[GetExpiredTimer()]
            local real xp = GetUnitX(.obj) + .dist * .vel.x
            local real yp = GetUnitY(.obj) + .dist * .vel.y
            local group ge = CreateGroup()
            if .volume == false then
                //debug call BJDebugMsg("|cff00ff00[YDWE] Timer Pattern : |rPathable without terrain.")
                if IsTerrainPathable(xp, yp, PATHING_TYPE_WALKABILITY) then
                    if (.afc != 0) then
                        call afc.execute(this,xp,yp)
                    else
                        set .switch = 0
                    endif
                else
                    set .x = xp
                    set .y = yp
                endif
            else
                set .x = xp
                set .y = yp
            endif
            if .follow == 0 then
                if GetUnitFlyHeight(.obj) < 5. then
                        call DestroyEffect(AddSpecialEffect(.gsfx, .pos.x, .pos.y))
                endif
            endif
            set .follow = .follow + 1
            if .follow == 2 then
                set .follow = 0
            endif
            if .killdest then
                call MoveRectTo(Area, .pos.x, .pos.y)
                call EnumDestructablesInRect(Area, Bexpr, function TreeKill)
            endif
            if .amount > 0.0 then
                //call this.damage(.caster, .pos.x, .pos.y, 0.0, false, .recycle)
                set tmp_data = integer(this)
                call GroupEnumUnitsInRange(ge, .pos.x, .pos.y, .radius, function DamageFilter)
            endif
            set .step = .step - 1.
            if .step <= 0.0 or YDWECoordinateX(.pos.x) != .pos.x or YDWECoordinateY(.pos.y) != .pos.y then
                set .switch = 0
            endif
            call DestroyGroup(ge)
            set ge = null
            if not (IsUnitAliveBJ(.obj)) then
                set .switch = 0
            endif
            if .switch == 0 then
                call SetUnitFlyHeight(.obj, GetUnitDefaultFlyHeight(.obj), 200.0)
                call SetUnitTimeScale(.obj, 1)
                // YDWETriggerEvent
                call YDWESyStemAbilityCastingOverTriggerAction(.obj, 6)
                call this.destroy()
            endif
        endmethod
        static method create takes unit source, unit object, real angle, real distance, real time, real interval, real damage,real radius, boolean killtrees, boolean cycle, boolean path, string part, string geff, string weff,AfterCollied f returns thistype
            local thistype this = thistype.allocate() //thistype(Thread[object])
local real vx = 0.0
            local real vy = 0.0
            local real l = 0.0
            set .des = YDVector3.create()
            set .pos = YDVector3.create()
            set .vel = YDVector3.create()
            set .vel.x = Cos(angle)
            set .vel.y = Sin(angle)
            set .dist = distance * interval / time
            //stepĳ˶
            set .step = time / interval
            set .pos.x = GetUnitX(object)
            set .pos.y = GetUnitY(object)
            set .caster = source
            set .obj = object
            set .radius = radius
            set .amount = damage
            set .killdest = killtrees
            set .recycle = cycle
            set .volume = path
            set .gsfx = geff
            set .dsfx = weff
            set .switch = 1
            set .follow = 0
            set .afc = f
            set .g = CreateGroup()
            set .t = CreateTimer()
            call TimerStart(.t, interval, true, function thistype.move)
            set Thread[.t] = integer(this)
            return this
        endmethod
    endstruct
    // Jump Attack PUI
    function YDWETimerPatternJumpAttack takes unit u, real face, real dis, real lasttime, real timeout, real high, real damage, string part, string dsfx returns nothing
        if u == null then
            //debug call BJDebugMsg("|cff00ff00[YDWE] Timer Pattern : |r No object!")
            return
        endif
        call Parabola.create(u, u, Deg2Rad(face), RMaxBJ(dis, 0), RMaxBJ(lasttime, 0), RMaxBJ(timeout, 0), high, damage, part, dsfx)
    endfunction
    // Moon Priestess Arrow PUI
    function YDWETimerPatternMoonPriestessArrow takes unit u, real face, real dis, real lasttime, real timeout, integer lv, integer aid, integer uid, string order, string part, string dsfx returns nothing
        local unit sour = null
        if u == null then
            //debug call BJDebugMsg("|cff00ff00[YDWE] Timer Pattern : |r No object!")
            return
        endif
        set sour = YDWEGetUnitByString(I2S(YDWEH2I(u)), "MoonPriestessArrow")
        if sour == null then
            set sour = u
        endif
        call Linear.create(sour, u, Deg2Rad(face), RMaxBJ(dis, 0), RMaxBJ(lasttime, 0), RMaxBJ(timeout, 0), uid, aid, IMaxBJ(lv, 1), OrderId(order), part, dsfx)
        //call YDWEFlushMissionByString(I2S(YDWEH2I(u)))
        set sour = null
    endfunction
    // Rush Slide PUI
    function YDWETimerPatternRushSlide takes unit u, real face, real dis, real lasttime, real timeout, real damage, real radius, boolean killtrees, boolean cycle, boolean path, string part, string gsfx, string wsfx returns nothing
        if u == null then
            //debug call BJDebugMsg("|cff00ff00[YDWE] Timer Pattern : |r No object!")
            return
        endif
        call Deceleration.create(u, u, Deg2Rad(face), RMaxBJ(dis, 0), RMaxBJ(lasttime, 0), RMaxBJ(timeout, 0), damage, RMaxBJ(radius,0), killtrees, cycle, path, part, gsfx, wsfx ,0)
    endfunction
    private function Rebound takes Thread t,real nx,real ny returns nothing
        
        if not (IsTerrainPathable(nx, t.pos.y, PATHING_TYPE_WALKABILITY)) then
            set t.vel.y = -1 * t.vel.y
        elseif not (IsTerrainPathable(t.pos.x, ny, PATHING_TYPE_WALKABILITY)) then
            set t.vel.x = -1 * t.vel.x
        else
            set t.vel.y = -1 * t.vel.y
            set t.vel.x = -1 * t.vel.x
        endif
        call GroupClear(t.g)
        call SetUnitFacing(t.obj,Atan2BJ(t.vel.y,t.vel.x))
    endfunction
    /*
        lasttimeʱ,timeoutˢʱ,cycleײ,pathӵ,һfײʱõĺӿ,ñѵFALSE,һװʱЧ
    */
    function DIYRushSlide takes unit u, real face, real dis, real lasttime, real timeout, real damage, real radius, boolean killtrees, boolean cycle, boolean path, string part, string gsfx, string wsfx returns nothing
         local AfterCollied rebound = AfterCollied.Rebound
         call Deceleration.create(u, u, Deg2Rad(face), RMaxBJ(dis, 0), RMaxBJ(lasttime, 0), RMaxBJ(timeout, 0), damage, RMaxBJ(radius,0), killtrees, cycle, path, part, gsfx, wsfx,Rebound)
    endfunction
    private function Init takes nothing returns nothing
        set Area = Rect(-120.0, -120.0, 120.0, 120.0)
        set Bexpr = Filter(function TreeFilter)
    endfunction
endlibrary
library YDWEGetUnitsOfPlayerAndTypeIdNull
globals
endglobals
function YDWEGetUnitsOfPlayerAndTypeIdNull takes player whichPlayer, integer unitid returns group
    local group g = CreateGroup()
    set bj_groupEnumTypeId = unitid
    call GroupEnumUnitsOfPlayer(g, whichPlayer, filterGetUnitsOfPlayerAndTypeId)
    set yd_NullTempGroup = g
    set g = null
    return yd_NullTempGroup
endfunction
endlibrary
//===========================================================================
//佣兵系统 
//===========================================================================
library YDWESetGuard requires YDWEBase
private function IsUnitIdle takes unit u returns boolean
    return OrderId2String(GetUnitCurrentOrder(u)) == null
endfunction
function YDWERemoveGuard takes unit pet returns nothing
    local integer tm = YDWEGetIntegerByString( I2S(YDWEH2I(pet)), "Timer")
    call YDWEFlushMissionByString(I2S(YDWEH2I(pet)))
    call YDWEFlushMissionByString(I2S(tm))
    call DestroyTimer(YDWEGetTimerByString(I2S(YDWEH2I(pet)), "Timer"))
endfunction
function SetGuardTimer takes nothing returns nothing
  local timer tm = GetExpiredTimer()
  local unit pet = (YDWEGetUnitByString( I2S(YDWEH2I(tm)), "Pet"))
  local unit captain = (YDWEGetUnitByString( I2S(YDWEH2I(tm)), "Captain"))
  local real x = GetUnitX(captain) - GetUnitX(pet)
  local real y = GetUnitY(captain) - GetUnitY(pet)
  local real d = x*x + y*y
  local real v
  local real a
  local effect e=null
  local real life = YDWEGetRealByString( I2S(YDWEH2I(tm)), "Life")
  local integer p = YDWEGetIntegerByString(I2S(YDWEH2I(tm)), "Percent")
  set v = YDWEGetRealByString(I2S(YDWEH2I(tm)), "GuardRanger") 
  if GetUnitState(pet, UNIT_STATE_LIFE)>0 and GetUnitState(captain, UNIT_STATE_LIFE)> 0 then 
      if d<v*v then
         if IsUnitIdle(pet) and GetRandomInt(0,100)<p then
           set x = GetUnitX(captain)
           set y = GetUnitY(captain)
           set d = GetRandomReal(0,v)
           set a = GetRandomReal(0,360)
           call IssuePointOrder(pet, "patrol", x+d*CosBJ(a), y+d*SinBJ(a))
         endif
      else
        set v = YDWEGetRealByString( I2S(YDWEH2I(tm)), "ReturnRanger")
        if d<v*v then
          if IsUnitIdle(pet) then
            call IssuePointOrder(pet, "patrol", GetUnitX(captain), GetUnitY(captain))
          endif
        else
          set v = YDWEGetRealByString(I2S(YDWEH2I(tm)), "OutRanger")
            if d!=0 and d>v*v then
              call SetUnitPosition(pet,GetUnitX(captain),GetUnitY(captain))
              set e =AddSpecialEffectTarget("Abilities\\Spells\\Human\\MassTeleport\\MassTeleportTarget.mdl" ,captain,"chest")
              call DestroyEffect(e)
            else
              call IssuePointOrder(pet, "move", GetUnitX(captain), GetUnitY(captain))
            endif
          endif
       endif
     else
       call IssuePointOrder(pet, "attack", GetUnitX(captain), GetUnitY(captain))
       call YDWERemoveGuard(pet) 
  endif
  set tm = null
  set pet = null
  set captain = null
  set e=null
endfunction
function YDWESetGuard takes unit pet, unit captain, real timeout, real guardRanger, real returnRanger, real outRanger,integer percent returns nothing
    local timer tm = CreateTimer() 
    call YDWESaveTimerByString(I2S(YDWEH2I(pet)), "Timer", tm)
    call YDWESaveUnitByString(I2S(YDWEH2I(tm)), "pet", pet)
    call YDWESaveUnitByString(I2S(YDWEH2I(tm)), "Captain", captain)
    call YDWESaveIntegerByString(I2S(YDWEH2I(tm)), "Percent", percent) 
    call YDWESaveRealByString(I2S(YDWEH2I(tm)), "GuardRanger", guardRanger) 
    call YDWESaveRealByString(I2S(YDWEH2I(tm)), "ReturnRanger", returnRanger) 
    call YDWESaveRealByString(I2S(YDWEH2I(tm)), "OutRanger", outRanger)
    call TimerStart(tm, timeout, true, function SetGuardTimer)
    set tm = null
endfunction
endlibrary 
library YDWEGetItemOfTypeFromUnitBJNull
globals
    item yd_NullTempItem
endglobals
function YDWEGetItemOfTypeFromUnitBJNull takes unit whichUnit, integer itemId returns item
    local integer index = 0
    loop
        set yd_NullTempItem = UnitItemInSlot(whichUnit, index)
        if GetItemTypeId(yd_NullTempItem) == itemId then
            return yd_NullTempItem
        endif
        set index = index + 1
        exitwhen index >= bj_MAX_INVENTORY
    endloop
    return null
endfunction
endlibrary
/*
声音的初始化
及一些常用的声音API
*/
//! zinc
library Music {
	public struct music []{
		private sound snd;
		//只给某个玩家播放
		method playFor (player p) {
			if (GetLocalPlayer() == p) {
				StartSound(snd);
			}
		}
		//播放音效
		method play () {
			StartSound(snd);
		}
		static method onInit () {
			sound snd = null;
			//# check: music[1001]
			//# dependency:sound/sound/btn_down_01.wav
			snd = CreateSound("sound\\btn_down_01.wav", false, false, false, 10, 10, "");
			SetSoundDuration(snd, 131);
			SetSoundChannel(snd, 0);
			SetSoundVolume(snd, 127);
			SetSoundPitch(snd, 1.0);
			thistype[1001].snd = snd;
			//# endcheck
			//# check: music[1002]
			//# dependency:sound/sound/btn_over_01.wav
			snd = CreateSound("sound\\btn_over_01.wav", false, false, false, 10, 10, "");
			SetSoundDuration(snd, 56);
			SetSoundChannel(snd, 0);
			SetSoundVolume(snd, 127);
			SetSoundPitch(snd, 1.0);
			thistype[1002].snd = snd;
			//# endcheck
			//# check: music[1003]
			//# dependency:sound/sound/btn_over_02.wav
			snd = CreateSound("sound\\btn_over_02.wav", false, false, false, 10, 10, "");
			SetSoundDuration(snd, 60);
			SetSoundChannel(snd, 0);
			SetSoundVolume(snd, 127);
			SetSoundPitch(snd, 1.0);
			thistype[1003].snd = snd;
			//# endcheck
			//# check: music[1004]
			//# dependency:sound/sound/btn_up_01.wav
			snd = CreateSound("sound\\btn_up_01.wav", false, false, false, 10, 10, "");
			SetSoundDuration(snd, 54);
			SetSoundChannel(snd, 0);
			SetSoundVolume(snd, 127);
			SetSoundPitch(snd, 1.0);
			thistype[1004].snd = snd;
			//# endcheck
			//# check: music[7]
			snd = CreateSound("Sound\\Interface\\Warning\\Human\\KnightNoGold1.wav", false, false, false, 10, 10, "DefaultEAXON");
			SetSoundDuration(snd, 1486);
			thistype[7].snd = snd;
			//# endcheck
			//# check: music[8]
			snd = CreateSound("Sound\\Interface\\Error.wav", false, false, false, 10, 10, "DefaultEAXON");
			SetSoundDuration(snd, 614);
			thistype[8].snd = snd;
			//# endcheck
			//# check: music[9]
			snd = CreateSound("Abilities\\Spells\\Items\\ResourceItems\\ReceiveGold.wav", false, false, false, 10, 10, "SpellsEAX");
			SetSoundDuration(snd, 589);
			thistype[9].snd = snd;
			//# endcheck
			//# check: music[10]
			snd = CreateSound("Abilities\\Spells\\Items\\AIam\\Tomes.wav", false, false, false, 10, 10, "SpellsEAX");
			SetSoundDuration(snd, 1770);
			thistype[10].snd = snd;
			//# endcheck
			//# check: music[11]
			snd = CreateSound("Sound\\Interface\\ItemReceived.wav", false, false, false, 10, 10, "");
			SetSoundDuration(snd, 1483);
			thistype[11].snd = snd;
			//# endcheck
			//# check: music[12]
			snd = CreateSound("Sound\\Interface\\MouseClick1.wav", false, false, false, 10, 10, "");
			SetSoundDuration(snd, 239);
			thistype[12].snd = snd;
			//# endcheck
			//# check: music[13]
			snd = CreateSound("Sound\\Interface\\SecretFound.wav", false, false, false, 10, 10, "");
			SetSoundDuration(snd, 2525);
			thistype[13].snd = snd;
			//# endcheck
			snd = null;
		}
	}
}
//! endzinc
//! zinc
/*
单位组有关
伤害有关
// u = FirstOfGroup(g);  //少用这个,单位删了后直接是0了
用GroupPickRandomUnit(g);好一些
*/
library GroupUtils requires UnitFilter {
    group tempG = null;
    unit tempU = null;
    //库补充,防内存泄漏
    public function GroupEnumUnitsInRangeEx (group whichGroup,real x,real y,real radius,boolexpr filter) {
        GroupEnumUnitsInRange(whichGroup, x, y, radius, filter);
        DestroyBoolExpr(filter);
    }
    //库补充,防内存泄漏
    public function GroupEnumUnitsInRectEx (group whichGroup,rect r,boolexpr filter) {
        GroupEnumUnitsInRect(whichGroup, r, filter);
        DestroyBoolExpr(filter);
    }
    //获取单位组:[敌方]
    public function GetEnemyGroup (unit u,real x,real y,real radius) -> group {
        tempG = CreateGroup();
        tempU = u;
        GroupEnumUnitsInRangeEx(tempG, x, y, radius, Filter(function () -> boolean {
            if (IsEnemy(GetOwningPlayer(tempU),GetFilterUnit())) {
                return true;
            }
            return false;
        }));
        tempU = null;
        return tempG;
    }
    //获取圆形随机单位
    public function GetRandomEnemy (unit u,real x,real y,real radius) -> unit {
        return GroupPickRandomUnit(GetEnemyGroup(u,x,y,radius));
    }
}
//! endzinc
//! zinc
/*
单位有关
*/
library UnitFilter {
    //判断是否是敌方(不带无敌)
    public function IsEnemy (player p,unit u) -> boolean {
        return GetUnitState(u, UNIT_STATE_LIFE) > .405 && !(IsUnitType(u, UNIT_TYPE_STRUCTURE)) && !(IsUnitHidden(u)) && IsUnitEnemy(u, p) && GetUnitAbilityLevel(u,'Avul') == 0;
    }
    //旧名：IsEnemy2
    //判断是否是敌方(能匹配到无敌单位)
    public function IsEnemyIncludeInvul (player p,unit u) -> boolean {
        return GetUnitState(u, UNIT_STATE_LIFE) > .405 && !(IsUnitType(u, UNIT_TYPE_STRUCTURE)) && !(IsUnitHidden(u)) && IsUnitEnemy(u, p);
    }
    //判断是否是友方
    public function IsAlly (player p,unit u) -> boolean {
        return GetUnitState(u, UNIT_STATE_LIFE) > .405 && !(IsUnitType(u, UNIT_TYPE_STRUCTURE)) && !(IsUnitHidden(u)) && IsUnitAlly(u, p);
    }
}
//! endzinc
library YDWEGetUnitsOfTypeIdAllNull
globals
endglobals
function YDWEGetUnitsOfTypeIdAllNull takes integer unitid returns group
    local group result = CreateGroup()
    local group g = CreateGroup()
    local integer index
    set index = 0
    loop
        set bj_groupEnumTypeId = unitid
        call GroupClear(g)
        call GroupEnumUnitsOfPlayer(g, Player(index), filterGetUnitsOfTypeIdAll)
        call GroupAddGroup(g, result)
        set index = index + 1
        exitwhen index == bj_MAX_PLAYER_SLOTS
    endloop
    call DestroyGroup(g)
    set g = null
    set yd_NullTempGroup = result
    set result = null
    return yd_NullTempGroup
endfunction
endlibrary
library YDWEGetUnitsInRectMatchingNull
globals
endglobals
function YDWEGetUnitsInRectMatchingNull takes rect r, boolexpr filter returns group
    local group g = CreateGroup()
    call GroupEnumUnitsInRect(g, r, filter)
    call DestroyBoolExpr(filter)
    set yd_NullTempGroup = g
    set g = null
    return yd_NullTempGroup
endfunction
endlibrary
library YDWEPolledWaitNull
function YDWEPolledWaitNull takes real duration returns nothing
    local timer t
    local real timeRemaining
    if (duration > 0) then
        set t = CreateTimer()
        call TimerStart(t, duration, false, null)
        loop
            set timeRemaining = TimerGetRemaining(t)
            exitwhen timeRemaining <= 0
            // If we have a bit of time left, skip past 10% of the remaining
            // duration instead of checking every interval, to minimize the
            // polling on long waits.
            if (timeRemaining > bj_POLLED_WAIT_SKIP_THRESHOLD) then
                call TriggerSleepAction(0.1 * timeRemaining)
            else
                call TriggerSleepAction(bj_POLLED_WAIT_INTERVAL)
            endif
        endloop
        call DestroyTimer(t)
    endif
    set t = null
endfunction
endlibrary
library YDWETriggerRegisterEnterRectSimpleNull
globals
endglobals
function YDWETriggerRegisterEnterRectSimpleNull takes trigger trig, rect r returns event
    local region rectRegion = CreateRegion()
    call RegionAddRect(rectRegion, r)
    set yd_NullTempRegion = rectRegion
    set rectRegion = null
    return TriggerRegisterEnterRegion(trig, yd_NullTempRegion, null)
endfunction
endlibrary
//! zinc
//==================================
// 日志打印系统
// version: 1.0
// author: 系统自动生成
// date: 2024/3/21
//
// 功能：提供五个日志级别输出
// - TRACE(灰)：追踪调试用
// - DEBUG(绿)：调试信息用
// - INFO(白)：普通信息用
// - WARN(黄)：警告信息用
// - ERROR(红)：错误信息用
//
// 示例：
// call Info("普通信息")
// call Error(Player(0), "玩家1的错误")
//==================================
library Logger requires YDLua {
    public integer logger_level = 0;
    public string logger_msg = null;
    public player logger_p = null;
    public trigger logger_tr = null;
    // 追踪级别日志(灰色),用于程序执行追踪
    public function Trace(string msg) {
        logger_msg = msg;
        logger_level = 0;
        logger_p = GetLocalPlayer();
		TriggerEvaluate(logger_tr);
    }
    // 调试级别日志(绿色),用于输出变量值等调试信息
    public function Debug(string msg) {
        logger_msg = msg;
        logger_level = 1;
        logger_p = GetLocalPlayer();
		TriggerEvaluate(logger_tr);
    }
    // 信息级别日志(白色),用于输出普通提示信息
    public function Info(string msg) {
        logger_msg = msg;
        logger_level = 2;
        logger_p = GetLocalPlayer();
		TriggerEvaluate(logger_tr);
    }
    // 警告级别日志(黄色),用于输出警告信息
    public function Warn(string msg) {
        logger_msg = msg;
        logger_level = 3;
        logger_p = GetLocalPlayer();
		TriggerEvaluate(logger_tr);
    }
    // 错误级别日志(红色),用于输出错误信息
    public function Error(string msg) {
        logger_msg = msg;
        logger_level = 4;
        logger_p = GetLocalPlayer();
		TriggerEvaluate(logger_tr);
    }
    // 向指定玩家输出追踪日志(灰色)
    public function TraceToPlayer(player p, string msg) {
        logger_msg = msg;
        logger_level = 0;
        logger_p = p;
		TriggerEvaluate(logger_tr);
    }
    // 向指定玩家输出调试日志(绿色)
    public function DebugToPlayer(player p, string msg) {
        logger_msg = msg;
        logger_level = 1;
        logger_p = p;
		TriggerEvaluate(logger_tr);
    }
    // 向指定玩家输出信息日志(白色)
    public function InfoToPlayer(player p, string msg) {
        logger_msg = msg;
        logger_level = 2;
        logger_p = p;
		TriggerEvaluate(logger_tr);
    }
    // 向指定玩家输出警告日志(黄色)
    public function WarnToPlayer(player p, string msg) {
        logger_msg = msg;
        logger_level = 3;
        logger_p = p;
		TriggerEvaluate(logger_tr);
    }
    // 向指定玩家输出错误日志(红色)
    public function ErrorToPlayer(player p, string msg) {
        logger_msg = msg;
        logger_level = 4;
        logger_p = p;
		TriggerEvaluate(logger_tr);
    }
    function onInit() {
        Cheat("exec-lua:depends.debug.logger"); //日志打印系统初始化
}
}
//! endzinc
//===========================================================================
//===========================================================================
//自定义事件
//===========================================================================
//===========================================================================
library YDWETriggerEvent
globals
    trigger yd_DamageEventTrigger = null
    private constant integer DAMAGE_EVENT_SWAP_TIMEOUT = 20 // 每隔这个时间(秒), yd_DamageEventTrigger 会被移入销毁队列
private constant boolean DAMAGE_EVENT_SWAP_ENABLE = true // 若为 false 则不启用销毁机制
private trigger yd_DamageEventTriggerToDestory = null
    private trigger array DamageEventQueue
    private integer DamageEventNumber = 0
    item bj_lastMovedItemInItemSlot = null
    private trigger MoveItemEventTrigger = null
    private trigger array MoveItemEventQueue
    private integer MoveItemEventNumber = 0
endglobals
//===========================================================================
//任意单位伤害事件
//===========================================================================
function YDWEAnyUnitDamagedTriggerAction takes nothing returns nothing
    local integer i = 0
    loop
        exitwhen i >= DamageEventNumber
        if DamageEventQueue[i] != null and IsTriggerEnabled(DamageEventQueue[i]) and TriggerEvaluate(DamageEventQueue[i]) then
            call TriggerExecute(DamageEventQueue[i])
        endif
        set i = i + 1
    endloop
endfunction
function YDWEAnyUnitDamagedFilter takes nothing returns boolean
    if GetUnitAbilityLevel(GetFilterUnit(), 'Aloc') <= 0 then
        call TriggerRegisterUnitEvent(yd_DamageEventTrigger, GetFilterUnit(), EVENT_UNIT_DAMAGED)
    endif
    return false
endfunction
function YDWEAnyUnitDamagedEnumUnit takes nothing returns nothing
    local group g = CreateGroup()
    local integer i = 0
    loop
        call GroupEnumUnitsOfPlayer(g, Player(i), Condition(function YDWEAnyUnitDamagedFilter))
        set i = i + 1
        exitwhen i >= bj_MAX_PLAYER_SLOTS
    endloop
    call DestroyGroup(g)
    set g = null
endfunction
function YDWEAnyUnitDamagedRegistTriggerUnitEnter takes nothing returns nothing
    local trigger t = CreateTrigger()
    local region r = CreateRegion()
    local rect world = GetWorldBounds()
    call RegionAddRect(r, world)
    call TriggerRegisterEnterRegion(t, r, Condition(function YDWEAnyUnitDamagedFilter))
    call RemoveRect(world)
    set t = null
    set r = null
    set world = null
endfunction
// 将 yd_DamageEventTrigger 移入销毁队列, 从而排泄触发器事件
function YDWESyStemAnyUnitDamagedSwap takes nothing returns nothing
    local boolean isEnabled = IsTriggerEnabled(yd_DamageEventTrigger)
    call DisableTrigger(yd_DamageEventTrigger)
    if yd_DamageEventTriggerToDestory != null then
        call DestroyTrigger(yd_DamageEventTriggerToDestory)
    endif
    set yd_DamageEventTriggerToDestory = yd_DamageEventTrigger
    set yd_DamageEventTrigger = CreateTrigger()
    if not isEnabled then
        call DisableTrigger(yd_DamageEventTrigger)
    endif
    call TriggerAddAction(yd_DamageEventTrigger, function YDWEAnyUnitDamagedTriggerAction)
    call YDWEAnyUnitDamagedEnumUnit()
endfunction
function YDWESyStemAnyUnitDamagedRegistTrigger takes trigger trg returns nothing
    if trg == null then
        return
    endif
    if DamageEventNumber == 0 then
        set yd_DamageEventTrigger = CreateTrigger()
        call TriggerAddAction(yd_DamageEventTrigger, function YDWEAnyUnitDamagedTriggerAction)
        call YDWEAnyUnitDamagedEnumUnit()
        call YDWEAnyUnitDamagedRegistTriggerUnitEnter()
        if DAMAGE_EVENT_SWAP_ENABLE then
            // 每隔 DAMAGE_EVENT_SWAP_TIMEOUT 秒, 将正在使用的 yd_DamageEventTrigger 移入销毁队列
            call TimerStart(CreateTimer(), DAMAGE_EVENT_SWAP_TIMEOUT, true, function YDWESyStemAnyUnitDamagedSwap)
        endif
    endif
    set DamageEventQueue[DamageEventNumber] = trg
    set DamageEventNumber = DamageEventNumber + 1
endfunction
//===========================================================================
//移动物品事件
//===========================================================================
function YDWESyStemItemUnmovableTriggerAction takes nothing returns nothing
    local integer i = 0
    if GetIssuedOrderId() >= 852002 and GetIssuedOrderId() <= 852007 then
		set bj_lastMovedItemInItemSlot = GetOrderTargetItem()
    	loop
        	exitwhen i >= MoveItemEventNumber
        	if MoveItemEventQueue[i] != null and IsTriggerEnabled(MoveItemEventQueue[i]) and TriggerEvaluate(MoveItemEventQueue[i]) then
        	    call TriggerExecute(MoveItemEventQueue[i])
        	endif
        	set i = i + 1
    	endloop
	endif
endfunction
function YDWESyStemItemUnmovableRegistTrigger takes trigger trg returns nothing
    if trg == null then
        return
    endif
    if MoveItemEventNumber == 0 then
        set MoveItemEventTrigger = CreateTrigger()
        call TriggerAddAction(MoveItemEventTrigger, function YDWESyStemItemUnmovableTriggerAction)
        call TriggerRegisterAnyUnitEventBJ(MoveItemEventTrigger, EVENT_PLAYER_UNIT_ISSUED_TARGET_ORDER)
    endif
    set MoveItemEventQueue[MoveItemEventNumber] = trg
    set MoveItemEventNumber = MoveItemEventNumber + 1
endfunction
function GetLastMovedItemInItemSlot takes nothing returns item
    return bj_lastMovedItemInItemSlot
endfunction
endlibrary
//===========================================================================
//
// - |cff00ff00单元测试地图|r -
//
//   Warcraft III map script
//   Generated by the Warcraft III World Editor
//   Date: Sun Nov 27 05:00:30 2022
//   Map Author: Crainax
//
//===========================================================================
//***************************************************************************
//*
//*  Global Variables
//*
//***************************************************************************
library YDTriggerSaveLoadSystem initializer Init
//#  define YDTRIGGER_handle(SG)                          YDTRIGGER_HT##SG##(HashtableHandle)
globals
        hashtable YDHT
    hashtable YDLOC
endglobals
    private function Init takes nothing returns nothing
            set YDHT = InitHashtable()
        set YDLOC = InitHashtable()
    endfunction
endlibrary
globals
    // Generated
    rect gg_rct_Wave1 = null
    rect gg_rct_Wave2 = null
    rect gg_rct_Wave3 = null
    rect gg_rct_Wave4 = null
    rect gg_rct_Base = null
    rect gg_rct_BaseBack = null
    rect gg_rct_Home1 = null
    rect gg_rct_Home2 = null
    rect gg_rct_Home3 = null
    rect gg_rct_Home4 = null
    rect gg_rct_Fuben1 = null
    rect gg_rct_Fuben2 = null
    rect gg_rct_Fuben3 = null
    rect gg_rct_Fuben4 = null
    rect gg_rct_Fuben5 = null
    rect gg_rct_Fuben6 = null
    rect gg_rct_Fuben7 = null
    rect gg_rct_Fuben8 = null
    trigger gg_trg_______u = null
    unit gg_unit_hcas_0011 = null
endglobals
function InitGlobals takes nothing returns nothing
endfunction
//***************************************************************************
//*
//*  Unit Creation
//*
//***************************************************************************
//===========================================================================
function CreateBuildingsForPlayer8 takes nothing returns nothing
    local player p = Player(8)
    local unit u
    local integer unitID
    local trigger t
    local real life
    set gg_unit_hcas_0011 = CreateUnit( p, 'hcas', -64.0, -1984.0, 270.000 )
endfunction
//===========================================================================
function CreatePlayerBuildings takes nothing returns nothing
    call CreateBuildingsForPlayer8( )
endfunction
//===========================================================================
function CreatePlayerUnits takes nothing returns nothing
endfunction
//===========================================================================
function CreateAllUnits takes nothing returns nothing
    call CreatePlayerBuildings( )
    call CreatePlayerUnits( )
endfunction
//***************************************************************************
//*
//*  Regions
//*
//***************************************************************************
function CreateRegions takes nothing returns nothing
    local weathereffect we
    set gg_rct_Wave1 = Rect( -5088.0, 3168.0, -4448.0, 3968.0 )
    set gg_rct_Wave2 = Rect( -1568.0, 3360.0, -928.0, 4160.0 )
    set gg_rct_Wave3 = Rect( 1312.0, 3584.0, 1952.0, 4384.0 )
    set gg_rct_Wave4 = Rect( 4320.0, 3232.0, 4960.0, 4032.0 )
    set gg_rct_Base = Rect( -320.0, -2304.0, 192.0, -1664.0 )
    set gg_rct_BaseBack = Rect( -320.0, -3328.0, 160.0, -2848.0 )
    set gg_rct_Home1 = Rect( -10496.0, 1440.0, -8128.0, 3776.0 )
    set gg_rct_Home2 = Rect( 7712.0, 1568.0, 10080.0, 3904.0 )
    set gg_rct_Home3 = Rect( -10464.0, -3680.0, -8096.0, -1344.0 )
    set gg_rct_Home4 = Rect( 7712.0, -3552.0, 10080.0, -1216.0 )
    set gg_rct_Fuben1 = Rect( -11872.0, 7968.0, -8224.0, 11584.0 )
    set gg_rct_Fuben2 = Rect( -5472.0, 8000.0, -1824.0, 11616.0 )
    set gg_rct_Fuben3 = Rect( 1184.0, 8000.0, 4832.0, 11616.0 )
    set gg_rct_Fuben4 = Rect( 7712.0, 7968.0, 11360.0, 11584.0 )
    set gg_rct_Fuben5 = Rect( -11872.0, -11328.0, -8224.0, -7712.0 )
    set gg_rct_Fuben6 = Rect( -5472.0, -11328.0, -1824.0, -7712.0 )
    set gg_rct_Fuben7 = Rect( 1184.0, -11328.0, 4832.0, -7712.0 )
    set gg_rct_Fuben8 = Rect( 7712.0, -11328.0, 11360.0, -7712.0 )
endfunction
//***************************************************************************
//*
//*  Custom Script Code
//*
//***************************************************************************
//TESH.scrollpos=0
//TESH.alwaysfold=0
// 当前构建版本
// 当前的平台分包
    // 正式版
    // lua_print: 正式版本
// 结构体共用方法定义
//共享打印方法
// UI组件内部共享方法及成员
// UI组件依赖库
// UI组件创建时共享调用
// UI组件销毁时共享调用
// 原生UI的大小
// #define StructMode // todo:结构体数量查看模式:用条件编译直接全部搞定
//函数入口
// 用原始地图测试
// 用空地图测试
///#include  "edit/Test.j"
/*
    语法基础
*/
library_once JBase
endlibrary
/*
    常量
*/
library_once Constant initializer InitConstant requires JBase
	globals
		string diffculty = ""
		string SgameMode = ""
		/*
		    英雄数量
		*/
		constant integer HERO_COUNT = 20
		/*
		    活动开关
		*/
		constant boolean Huodong = false
		/*
		    成就页数
		*/
		constant integer PAGE_ACHIEVE = 11
		constant integer PAGE_HERO_CHALLANGER = 3
		/*
		    实际人数(从一开始的)
		*/
		integer renshu = 0
		/*
		    游戏模式
		*/
		integer mode = 0
		constant integer COUNT_WANJIE = 6
		private integer WPointer = 1
		//星胧的标志位
		boolean BSpinXinglong = false
	endglobals
//---------------------------------------------------------------------------------------------------
	/*
	    获取当前版本
	*/
	constant function GetVersion takes nothing returns string
		return "3.421B"
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    获取是否是11
	*/
	constant function Get11 takes nothing returns boolean
		return false
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    判断游戏模式是否为经典
	*/
	function IsClassic takes nothing returns boolean
		return mode == 1
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    判断游戏模式是否为加速
	*/
	function IsHighSpeed takes nothing returns boolean
		return mode == 2
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    整数经典或加速
	*/
	function CModeH takes integer i1,integer i2 returns integer
		if (IsClassic()) then
			return i1
		else
			return i2
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    实数经典或加速
	*/
	function RCModeH takes real r1,real r2 returns real
		if (IsClassic()) then
			return r1
		else
			return r2
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    判断是否是皮肤
	*/
	function IsUnitIsSpin takes unit u returns boolean
		return GetUnitTypeId(u) == 'E00F' or GetUnitTypeId(u) == 'E00E' or GetUnitTypeId(u) == 'U001' or GetUnitTypeId(u) == 'H01V' or GetUnitTypeId(u) == 'H01W' or GetUnitTypeId(u) == 'E00G' or GetUnitTypeId(u) == 'O002' or GetUnitTypeId(u) == 'H01X' or GetUnitTypeId(u) == 'U002' or GetUnitTypeId(u) == 'O004' or GetUnitTypeId(u) == 'N01W' or GetUnitTypeId(u) == 'H026' or GetUnitTypeId(u) == 'H02C' or GetUnitTypeId(u) == 'N023' or GetUnitTypeId(u) == 'U003' or GetUnitTypeId(u) == 'H02E' or GetUnitTypeId(u) == 'E00H' or GetUnitTypeId(u) == 'H02L' or GetUnitTypeId(u) == 'H02O'
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    获取英雄索引号
	*/
	function GetHeroIndex takes integer heroType returns integer
		if (heroType == 'Ocbh' or heroType == 'O002') then
			return 1
		elseif (heroType == 'Eevi' or heroType == 'E00F') then
			return 2
		elseif (heroType == 'Hvwd' or heroType == 'H01X') then
			return 3
		elseif (heroType == 'Uktl' or heroType == 'U002') then
			return 4
		elseif (heroType == 'Nbbc' or heroType == 'N01W') then
			return 5
		elseif (heroType == 'E00D' or heroType == 'E00E') then
			return 6
		elseif (heroType == 'Usyl' or heroType == 'U001') then
			return 7
		elseif (heroType == 'Hjai' or heroType == 'H01V') then
			return 8
		elseif (heroType == 'Harf' or heroType == 'H01W') then
			return 9
		elseif (heroType == 'E00C' or heroType == 'E00H') then
			return 10
		elseif (heroType == 'Etyr' or heroType == 'E00G') then
			return 11
		elseif (heroType == 'Othr' or heroType == 'O004') then
			return 12
		elseif (heroType == 'Udea' or heroType == 'U003') then
			return 13
		elseif (heroType == 'Hkal') then
			return 14
		elseif (heroType == 'Hant' or heroType == 'H026') then
			return 15
		elseif (heroType == 'Nsjs' or heroType == 'N023') then
			return 16
		elseif (heroType == 'Hhkl' or heroType == 'H02C') then
			return 17
		elseif (heroType == 'Hapm' or heroType == 'H01I' or heroType == 'H02L' or heroType == 'H02O') then
			return 18
		elseif (heroType == 'H01Y') then
			return 19
		elseif (heroType == 'H027' or heroType == 'H02E') then
			return 20
		endif
		return 0
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    获取英雄名，由索引
	*/
	function GetIndexHeroName takes integer i returns string
			local string result = ""
			if (i == 1) then
				set result = "凯撒"
			elseif (i == 2) then
				set result = "湮灭"
			elseif (i == 3) then
				set result = "莫琪"
			elseif (i == 4) then
				set result = "玄雪"
			elseif (i == 5) then
				set result = "霸绝"
			elseif (i == 6) then
				set result = "瑟雨"
			elseif (i == 7) then
				set result = "晓月"
			elseif (i == 8) then
				set result = "凌雪"
			elseif (i == 9) then
				set result = "辰寂"
			elseif (i == 10) then
				set result = "寒殇"
			elseif (i == 11) then
				set result = "泰雅"
			elseif (i == 12) then
				set result = "摄焱"
			elseif (i == 13) then
				set result = "黑阎"
			elseif (i == 14) then
				set result = "梦霁"
			elseif (i == 15) then
				set result = "幻逸"
			elseif (i == 16) then
				set result = "苍凌"
			elseif (i == 17) then
				set result = "司宸"
			elseif (i == 18) then
				set result = "星胧"
			elseif (i == 19) then
				set result = "霄霆"
			elseif (i == 20) then
				set result = "离魑"
			endif
			return result
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    英雄天赋
	*/
	function GetHeroTianFu takes unit u returns integer
		local integer id = GetHeroIndex(GetUnitTypeId(u))
		if (id == 1) then
			return 'AOre'
		elseif (id == 2) then
			return 'A072'
		elseif (id == 3) then
			return 'A04G'
		elseif (id == 4) then
			return 'A042'
		elseif (id == 5) then
			return 'Absk'
		elseif (id == 6) then
			return 'A0IL'
		elseif (id == 7) then
			return 'ACfs'
		elseif (id == 8) then
			return 'A0FV'
		elseif (id == 9) then
			return 'A0F2'
		elseif (id == 10) then
			return 'A0II'
		elseif (id == 11) then
			return 'ACbc'
		elseif (id == 12) then
			return 'A0E7'
		elseif (id == 13) then
			return 'A0A3'
		elseif (id == 14) then
			return 'A0GX'
		elseif (id == 15) then
			return 'AHHD'
		elseif (id == 16) then
			return 'A0HH'
		elseif (id == 17) then
			return 'A0IP'
		elseif (id == 18) then
			return I3(BSpinXinglong,'A0NG','AEme')
		elseif (id == 19) then
			return 'A0LJ'
		elseif (id == 20) then
			return 'A0MH'
		endif
		return 0
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    英雄难度
	*/
	function GetHeroDifficulty takes unit u returns string
		local integer id = GetHeroIndex(GetUnitTypeId(u))
		if (id == 1) then
			return "|cffffff00操作难度：★☆☆☆☆|r"
		elseif (id == 2) then
			return "|cffff8000操作难度：★★★☆☆|r"
		elseif (id == 3) then
			return "|cffffff00操作难度：★☆☆☆☆|r"
		elseif (id == 4) then
			return "|cffff8000操作难度：★★★☆☆|r"
		elseif (id == 5) then
			return "|cffff4000操作难度：★★★★☆|r"
		elseif (id == 6) then
			return "|cffffc000操作难度：★★☆☆☆|r"
		elseif (id == 7) then
			return "|cffffff00操作难度：★☆☆☆☆|r"
		elseif (id == 8) then
			return "|cffffff00操作难度：★☆☆☆☆|r"
		elseif (id == 9) then
			return "|cffff4000操作难度：★★★★☆|r"
		elseif (id == 10) then
			return "|cffff4000操作难度：★★★★☆|r"
		elseif (id == 11) then
			return "|cffff8000操作难度：★★★☆☆|r"
		elseif (id == 12) then
			return "|cffff4000操作难度：★★★★☆|r"
		elseif (id == 13) then
			return "|cffffc000操作难度：★★☆☆☆|r"
		elseif (id == 13) then
			return "|cffffc000操作难度：★★☆☆☆|r"
		elseif (id == 14) then
			return "|cffffff00操作难度：★☆☆☆☆|r"
		elseif (id == 15) then
			return "|cffff0000操作难度：★★★★★(极度不推荐新手使用)|r"
		elseif (id == 16) then
			return "|cffffc000操作难度：★★☆☆☆|r"
		elseif (id == 17) then
			return "|cffffc000操作难度：★★☆☆☆|r"
		elseif (id == 18) then
			return "|cffff4000操作难度：★★★★☆|r"
		elseif (id == 19) then
			return "|cffff0000操作难度：★★★★★(极度不推荐新手使用)|r"
		elseif (id == 20) then
			return "|cffffff00操作难度：★☆☆☆☆|r"
		endif
		return ""
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    获取英雄彩名
	*/
	function GetIndexHeroColorName takes integer i returns string
		local string result = ""
		if (i == 1) then
			set result = "|cffff0000凯撒|r"
		elseif (i == 2) then
			set result = "|cFFFFCC66湮灭|r"
		elseif (i == 3) then
			set result = "|cFF999900莫琪|r"
		elseif (i == 4) then
			set result = "|cFF33FF33玄雪|r"
		elseif (i == 5) then
			set result = "|cFFCCFF66霸绝|r"
		elseif (i == 6) then
			set result = "|cFFCCFF33瑟雨|r"
		elseif (i == 7) then
			set result = "|cffff00ff晓月|r"
		elseif (i == 8) then
			set result = "|cFFFF3399凌雪|r"
		elseif (i == 9) then
			set result = "|cFFCCFF00辰寂|r"
		elseif (i == 10) then
			set result = "|cFF33FF33寒殇|r"
		elseif (i == 11) then
			set result = "|cFFFF3399泰雅|r"
		elseif (i == 12) then
			set result = "|cff00ccff摄焱|r"
		elseif (i == 13) then
			set result = "|cffff6800黑阎|r"
		elseif (i == 14) then
			set result = "|cffff99cc梦霁|r"
		elseif (i == 15) then
			set result = "|cff00ccff幻逸|r"
		elseif (i == 16) then
			set result = "|cff80ff80苍凌|r"
		elseif (i == 17) then
			set result = "|cff993366司宸|r"
		elseif (i == 18) then
			set result = "|cff99cc00星胧|r"
		elseif (i == 19) then
			set result = "|cff00ff00霄霆|r"
		elseif (i == 20) then
			set result = "|cff3366ff离魑|r"
		endif
		return result
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    反转的物品
	*/
	function GetFanzhuanItemType takes unit u returns integer
		local integer id = GetHeroIndex(GetUnitTypeId(u))
		if (id == 1) then
			return 'I046'
		elseif (id == 2) then
			return 'I07U'
		elseif (id == 3) then
			return 'I032'
		endif
		return 0
	endfunction
//---------------------------------------------------------------------------------------------------
    /*
        获取彩名依赖
    */
	function GetRandomColor takes nothing returns string
		local integer random = GetRandomInt(1,8)
		if (random == 1) then
			return "|cff0000ff"
		elseif (random == 2) then
			return "|cffcc99ff"
		elseif (random == 3) then
			return "|cff99cc00"
		elseif (random == 4) then
			return "|cffff0000"
		elseif (random == 5) then
			return "|cffff6600"
		elseif (random == 6) then
			return "|cffff00ff"
		elseif (random == 7) then
			return "|cff808000"
		else
			return "|cffffff00"
		endif
	endfunction
    /*
        获取彩名
    */
    function GetColorString takes string s returns string
		local integer length = StringLength(s)
		local string result = ""
		local integer i =1
		if (length == 0) then
			return ""
		endif
		loop
			exitwhen i > length
			set result = result + GetRandomColor() + SubStringBJ(s,i,i+2)
			set i = i + 3
		endloop
        return result + "|r"
    endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    条件：彩名成就索引条件
	*/
	function IsAchieveColor takes integer achieveID returns boolean
		return achieveID == 325 or achieveID == 24 or achieveID == 28 or achieveID == 29 or achieveID == 220 or achieveID == 226 or achieveID == 230 or achieveID == 35 or achieveID == 310 or achieveID == 314 or achieveID == 318 or achieveID == 326 or achieveID == 320 or achieveID == 321 or achieveID == 322 or achieveID == 323 or achieveID == 324 or achieveID == 327 or achieveID == 331 or achieveID == 42 or achieveID == 44 or achieveID == 45 or achieveID == 46 or achieveID == 47 or achieveID == 48 or achieveID == 49 or achieveID == 410 or achieveID == 411 or achieveID == 412 or achieveID == 413 or achieveID == 414 or achieveID == 415 or achieveID == 416 or achieveID == 417 or achieveID == 418 or achieveID == 420 or achieveID == 421 or achieveID == 422
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    白名显示条件
	*/
	function IsAchieveWhite takes integer achieveID returns boolean
		return achieveID == 12 or achieveID == 216
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    条件：能量之光特效索引条件
	*/
	function IsAchieveLight takes integer achieveID returns boolean
		return IsAchieveColor(achieveID) or achieveID == 18 or achieveID == 210 or achieveID == 222
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    获取成就名
	*/
	function GetAchievementName takes integer achieveID returns string
		if (achieveID == 325) then
			return GetColorString("【万劫录】")
		elseif (achieveID == 18) then
			return "|cffff00ff【轮回舰】"
		elseif (achieveID == 17) then
			return "|cffff0000【末日车】"
		elseif (achieveID == 16) then
			return "|cffff6600【地狱使】"
		elseif (achieveID == 15) then
			return "|cffffff00【灭炼狱】"
		elseif (achieveID == 14) then
			return "|cff3366ff【定战争】"
		elseif (achieveID == 13) then
			return "|cff99cc00【和谐世】"
		elseif (achieveID == 12) then
			return "【太平源】"
		elseif (achieveID == 11) then
			return "|cff999999【天国音】"
		elseif (achieveID == 21) then
			return "|cff99cc00【定心魔】"
		elseif (achieveID == 22) then
			return "|cffffff00【斩心魔】"
		elseif (achieveID == 23) then
			return "|cffff0000【净心魔】"
		elseif (achieveID == 24) then
			return GetColorString("【创心魔】")
		elseif (achieveID == 25) then
			return "|cff99cc00【复世财】"
		elseif (achieveID == 26) then
			return "|cffffff00【盛世财】"
		elseif (achieveID == 27) then
			return "|cffff0000【灭世财】"
		elseif (achieveID == 28) then
			return GetColorString("【造世财】")
		elseif (achieveID == 29) then
			return GetColorString("【单轮回】")
		elseif (achieveID == 210) then
			return "|cffff00ff【单末日】"
		elseif (achieveID == 211) then
			return "|cffff0000【单地狱】"
		elseif (achieveID == 212) then
			return "|cffff6600【单炼狱】"
		elseif (achieveID == 213) then
			return "|cffffff00【单战争】"
		elseif (achieveID == 214) then
			return "|cff3366ff【单和谐】"
		elseif (achieveID == 215) then
			return "|cff99cc00【单太平】"
		elseif (achieveID == 216) then
			return "【单天国】"
		elseif (achieveID == 217) then
			return "|cff99cc00【知天地】"
		elseif (achieveID == 218) then
			return "|cffffff00【探乾坤】"
		elseif (achieveID == 219) then
			return "|cffff0000【五界主】"
		elseif (achieveID == 220) then
			return GetColorString("【六界王】")
		elseif (achieveID == 221) then
			return "|cff99cc00【千钧劫】"
		elseif (achieveID == 222) then
			return "|cffff00ff【末世劫】"
		elseif (achieveID == 223) then
			return "|cff99cc00【风驰者】"
		elseif (achieveID == 224) then
			return "|cffffff00【电掣侠】"
		elseif (achieveID == 225) then
			return "|cffff0000【无影客】"
		elseif (achieveID == 226) then
			return GetColorString("【逆苍天】")
		elseif (achieveID == 227) then
			return "|cff99cc00【逐天魔】"
		elseif (achieveID == 228) then
			return "|cffffff00【驱天魔】"
		elseif (achieveID == 229) then
			return "|cffff0000【伏天魔】"
		elseif (achieveID == 230) then
			return GetColorString("【赦天魔】")
		elseif (achieveID == 231) then
			return ("|cffff0000【无心冢】")
		elseif (achieveID == 32) then
			return "|cff99cc00【触天式】"
		elseif (achieveID == 33) then
			return "|cffffff00【伐天式】"
		elseif (achieveID == 34) then
			return "|cffff0000【噬天式】"
		elseif (achieveID == 35) then
			return GetColorString("【诛天式】")
		elseif (achieveID == 36) then
			return "|cff99cc00【缘灭罐】"
		elseif (achieveID == 37) then
			return "|cffffff00【彼岸花】"
		elseif (achieveID == 38) then
			return "|cffff0000【仙瀑光】"
		elseif (achieveID == 39) then
			return "|cffff0000【烛龙谱】"
		elseif (achieveID == 310) then
			return GetColorString("【零失误】")
		elseif (achieveID == 311) then
			return "|cff99cc00【破虚者】"
		elseif (achieveID == 312) then
			return "|cffffff00【裂虚者】"
		elseif (achieveID == 313) then
			return "|cffff0000【断虚者】"
		elseif (achieveID == 314) then
			return GetColorString("【弑虚帝】")
		elseif (achieveID == 315) then
			return "|cff99cc00【定无双】"
		elseif (achieveID == 316) then
			return "|cffffff00【战无双】"
		elseif (achieveID == 317) then
			return "|cffff0000【凛无双】"
		elseif (achieveID == 318) then
			return GetColorString("【魄无双】")
		elseif (achieveID == 326) then
			return GetColorString("【封神门】")
		elseif (achieveID == 320) then
			return GetColorString("【圣洁玉】")
		elseif (achieveID == 321) then
			return GetColorString("【孤心戒】")
		elseif (achieveID == 322) then
			return GetColorString("【御天启】")
		elseif (achieveID == 323) then
			return GetColorString("【九轮圣】")
		elseif (achieveID == 324) then
			return GetColorString("【帝曜芒】")
		elseif (achieveID == 327) then
			return GetColorString("【浩劫赋】")
		elseif (achieveID == 328) then
			return "|cff99cc00【凶兽使】"
		elseif (achieveID == 329) then
			return "|cffffff00【千里眼】"
		elseif (achieveID == 330) then
			return "|cffff0000【执江山】"
		elseif (achieveID == 331) then
			return GetColorString("【啻主宰】")
		elseif (achieveID == 42) then
			return GetColorString("【傲临天魇】")
		elseif (achieveID == 43) then
			return "|cffffff00【迷踪步】"
		elseif (achieveID == 44) then
			return GetColorString("【影无缈】")
		elseif (achieveID == 45) then
			return GetColorString("【破枷皇】")
		elseif (achieveID == 46) then
			return GetColorString("【真言殿】")
		elseif (achieveID == 47) then
			return GetColorString("【不败神话】")
		elseif (achieveID == 48) then
			return GetColorString("【无上六界王】")
		elseif (achieveID == 49) then
			return GetColorString("【荒神炼】")
		elseif (achieveID == 410) then
			return GetColorString("【驻永恒】")
		elseif (achieveID == 411) then
			return GetColorString("【创世篇】")
		elseif (achieveID == 412) then
			return GetColorString("【若凰生】")
		elseif (achieveID == 413) then
			return GetColorString("【淼无极】")
		elseif (achieveID == 414) then
			return GetColorString("【金瓯体】")
		elseif (achieveID == 415) then
			return GetColorString("【控神识】")
		elseif (achieveID == 416) then
			return GetColorString("【契歃约】")
		elseif (achieveID == 417) then
			return GetColorString("【宵无霁】")
		elseif (achieveID == 418) then
			return GetColorString("【「白夜」奉天】")
		elseif (achieveID == 420) then
			return GetColorString("【「黑日」释帝】")
		elseif (achieveID == 421) then
			return GetColorString("【皆之初】")
		elseif (achieveID == 422) then
			return GetColorString("【前之痕】")
		elseif (achieveID == 423) then
			return GetColorString("【者之尘】")
		//完了再加到Achievement.j上的全成就.
		endif
		return ""
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    获取大厅成就名
	*/
	function GetAchievementWhiteName takes integer achieveID returns string
		if (achieveID == 325) then
			return "万劫录"
		elseif (achieveID == 18) then
			return "轮回舰"
		elseif (achieveID == 17) then
			return "末日车"
		elseif (achieveID == 16) then
			return "地狱使"
		elseif (achieveID == 15) then
			return "灭炼狱"
		elseif (achieveID == 14) then
			return "定战争"
		elseif (achieveID == 13) then
			return "和谐世"
		elseif (achieveID == 12) then
			return "太平源"
		elseif (achieveID == 11) then
			return "天国音"
		elseif (achieveID == 21) then
			return "定心魔"
		elseif (achieveID == 22) then
			return "斩心魔"
		elseif (achieveID == 23) then
			return "净心魔"
		elseif (achieveID == 24) then
			return "创心魔"
		elseif (achieveID == 25) then
			return "复世财"
		elseif (achieveID == 26) then
			return "盛世财"
		elseif (achieveID == 27) then
			return "灭世财"
		elseif (achieveID == 28) then
			return "造世财"
		elseif (achieveID == 29) then
			return "单轮回"
		elseif (achieveID == 210) then
			return "单末日"
		elseif (achieveID == 211) then
			return "单地狱"
		elseif (achieveID == 212) then
			return "单炼狱"
		elseif (achieveID == 213) then
			return "单战争"
		elseif (achieveID == 214) then
			return "单和谐"
		elseif (achieveID == 215) then
			return "单太平"
		elseif (achieveID == 216) then
			return "单天国"
		elseif (achieveID == 217) then
			return "知天地"
		elseif (achieveID == 218) then
			return "探乾坤"
		elseif (achieveID == 219) then
			return "五界主"
		elseif (achieveID == 220) then
			return "六界王"
		elseif (achieveID == 221) then
			return "千钧劫"
		elseif (achieveID == 222) then
			return "末世劫"
		elseif (achieveID == 223) then
			return "风驰者"
		elseif (achieveID == 224) then
			return "电掣侠"
		elseif (achieveID == 225) then
			return "无影客"
		elseif (achieveID == 226) then
			return "逆苍天"
		elseif (achieveID == 227) then
			return "逐天魔"
		elseif (achieveID == 228) then
			return "驱天魔"
		elseif (achieveID == 229) then
			return "伏天魔"
		elseif (achieveID == 230) then
			return "赦天魔"
		elseif (achieveID == 231) then
			return "无心冢"
		elseif (achieveID == 32) then
			return "触天式"
		elseif (achieveID == 33) then
			return "伐天式"
		elseif (achieveID == 34) then
			return "噬天式"
		elseif (achieveID == 35) then
			return "诛天式"
		elseif (achieveID == 36) then
			return "缘灭罐"
		elseif (achieveID == 37) then
			return "彼岸花"
		elseif (achieveID == 38) then
			return "仙瀑光"
		elseif (achieveID == 39) then
			return "烛龙谱"
		elseif (achieveID == 310) then
			return "零失误"
		elseif (achieveID == 311) then
			return "破虚者"
		elseif (achieveID == 312) then
			return "断虚者"
		elseif (achieveID == 313) then
			return "裂虚者"
		elseif (achieveID == 314) then
			return "弑虚帝"
		elseif (achieveID == 315) then
			return "定无双"
		elseif (achieveID == 316) then
			return "战无双"
		elseif (achieveID == 317) then
			return "凛无双"
		elseif (achieveID == 318) then
			return "魄无双"
		elseif (achieveID == 326) then
			return "封神门"
		elseif (achieveID == 320) then
			return "圣洁玉"
		elseif (achieveID == 321) then
			return "孤心戒"
		elseif (achieveID == 322) then
			return "御天启"
		elseif (achieveID == 323) then
			return "九轮圣"
		elseif (achieveID == 324) then
			return "帝曜芒"
		elseif (achieveID == 327) then
			return "浩劫赋"
		elseif (achieveID == 328) then
			return "凶兽使"
		elseif (achieveID == 329) then
			return "千里眼"
		elseif (achieveID == 330) then
			return "执江山"
		elseif (achieveID == 331) then
			return "啻主宰"
		elseif (achieveID == 42) then
			return "傲临天魇"
		elseif (achieveID == 43) then
			return "迷踪步"
		elseif (achieveID == 44) then
			return "影无缈"
		elseif (achieveID == 45) then
			return "破枷皇"
		elseif (achieveID == 46) then
			return "真言殿"
		elseif (achieveID == 47) then
			return "不败神话"
		elseif (achieveID == 48) then
			return "无上六界王"
		elseif (achieveID == 49) then
			return "荒神炼"
		elseif (achieveID == 410) then
			return "驻永恒"
		elseif (achieveID == 411) then
			return "创世篇"
		elseif (achieveID == 412) then
			return "若凰生"
		elseif (achieveID == 413) then
			return "淼无极"
		elseif (achieveID == 414) then
			return "金瓯体"
		elseif (achieveID == 415) then
			return "控神识"
		elseif (achieveID == 416) then
			return "契歃约"
		elseif (achieveID == 417) then
			return "宵无霁"
		elseif (achieveID == 418) then
			return "「白夜」奉天"
		elseif (achieveID == 420) then
			return "「黑日」释帝"
		elseif (achieveID == 421) then
			return "皆之初"
		elseif (achieveID == 422) then
			return "前之痕"
		elseif (achieveID == 423) then
			return "者之尘"
		endif
		return ""
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    获取成就名条件
	*/
	function GetAchievementCondition takes integer achieveID returns string
		if (achieveID == 325) then
			return "通关|cff008000\"万劫\"难度|r后可以自动获得该成就.
			|cffffff00该成就会显示在官方对战平台游戏大厅内哦,也会显示在你的名字前面!
			|r|cff3366ff使用该成就进行游戏英雄会有能量之光的特效哦!
			|r|cff99ccff若你通关了该难度可以加轮回之狱主群申请上|r|cff99cc00封帝万劫录|r|cff99ccff哦!|r"
		elseif (achieveID == 18) then
			return "通关|cffff00ff\"轮回\"难度|r后可以自动获得该成就.
			|cffffff00该成就会显示在官方对战平台游戏大厅内哦,也会显示在你的名字前面!
			|r|cff3366ff使用该成就进行游戏英雄会有能量之光的特效哦!|r"
		elseif (achieveID == 17) then
			return "通关|cffff0000\"末日\"难度|r后可以自动获得该成就.
			|cffffff00该成就会显示在官方对战平台游戏大厅内哦,也会显示在你的名字前面!|r"
		elseif (achieveID == 16) then
			return "通关|cffff6600\"地狱\"难度|r后可以自动获得该成就.
			|cffffff00该成就会显示在官方对战平台游戏大厅内哦,也会显示在你的名字前面!|r"
		elseif (achieveID == 15) then
			return "通关|cffffff00\"炼狱\"难度|r后可以自动获得该成就.
			|cffffff00该成就会显示在官方对战平台游戏大厅内哦,也会显示在你的名字前面!|r"
		elseif (achieveID == 14) then
			return "通关|cff3366ff\"战争\"难度|r后可以自动获得该成就.
			|cffffff00该成就会显示在官方对战平台游戏大厅内哦,也会显示在你的名字前面!|r"
		elseif (achieveID == 13) then
			return "通关|cff99cc00\"和谐\"难度|r后可以自动获得该成就.
			|cffffff00该成就会显示在官方对战平台游戏大厅内哦,也会显示在你的名字前面!|r"
		elseif (achieveID == 12) then
			return "通关\"太平\"难度后可以自动获得该成就.
			|cffffff00该成就会显示在官方对战平台游戏大厅内哦,也会显示在你的名字前面!|r"
		elseif (achieveID == 11) then
			return "通关|cff999999\"天国\"难度|r后可以自动获得该成就.
			|cffffff00该成就会显示在官方对战平台游戏大厅内哦,也会显示在你的名字前面!|r"
		elseif (achieveID == 21) then
			return "完成20次转生即可自动获得该成就.
			|cffffff00该成就会显示在官方对战平台游戏大厅内哦,也会显示在你的名字前面!|r"
		elseif (achieveID == 22) then
			return "完成50次转生即可自动获得该成就.
			|cffffff00该成就会显示在官方对战平台游戏大厅内哦,也会显示在你的名字前面!|r"
		elseif (achieveID == 23) then
			return "完成100次转生即可自动获得该成就.
			|cffffff00该成就会显示在官方对战平台游戏大厅内哦,也会显示在你的名字前面!|r"
		elseif (achieveID == 24) then
			return "完成150次转生即可自动获得该成就.
			|r|cff3366ff使用该成就进行游戏英雄会有能量之光的特效哦!
			|cffffff00该成就会显示在官方对战平台游戏大厅内哦,也会显示在你的名字前面!|r"
		elseif (achieveID == 25) then
			return "木材大于20000即可自动获得该成就.
			|cffffff00该成就会显示在官方对战平台游戏大厅内哦,也会显示在你的名字前面!|r"
		elseif (achieveID == 26) then
			return "木材大于50000即可自动获得该成就.
			|cffffff00该成就会显示在官方对战平台游戏大厅内哦,也会显示在你的名字前面!|r"
		elseif (achieveID == 27) then
			return "木材大于100000即可自动获得该成就.
			|cffffff00该成就会显示在官方对战平台游戏大厅内哦,也会显示在你的名字前面!|r"
		elseif (achieveID == 28) then
			return "木材大于200000即可自动获得该成就.
			|r|cff3366ff使用该成就进行游戏英雄会有能量之光的特效哦!
			|cffffff00该成就会显示在官方对战平台游戏大厅内哦,也会显示在你的名字前面!|r"
		elseif (achieveID == 29) then
			return "单通|cffff00ff\"轮回\"难度|r即可自动获得该成就.
			|r|cff3366ff使用该成就进行游戏英雄会有能量之光的特效哦!
			|cffffff00该成就会显示在官方对战平台游戏大厅内哦,也会显示在你的名字前面!|r"
		elseif (achieveID == 210) then
			return "单通|cffff0000\"末日\"难度|r即可自动获得该成就.
			|r|cff3366ff使用该成就进行游戏英雄会有能量之光的特效哦!
			|cffffff00该成就会显示在官方对战平台游戏大厅内哦,也会显示在你的名字前面!|r"
		elseif (achieveID == 211) then
			return "单通|cffff6600\"地狱\"难度|r后可以自动获得该成就.
			|cffffff00该成就会显示在官方对战平台游戏大厅内哦,也会显示在你的名字前面!|r"
		elseif (achieveID == 212) then
			return "单通|cffffff00\"炼狱\"难度|r后可以自动获得该成就.
			|cffffff00该成就会显示在官方对战平台游戏大厅内哦,也会显示在你的名字前面!|r"
		elseif (achieveID == 213) then
			return "单通|cff3366ff\"战争\"难度|r后可以自动获得该成就.
			|cffffff00该成就会显示在官方对战平台游戏大厅内哦,也会显示在你的名字前面!|r"
		elseif (achieveID == 214) then
			return "单通|cff99cc00\"和谐\"难度|r后可以自动获得该成就.
			|cffffff00该成就会显示在官方对战平台游戏大厅内哦,也会显示在你的名字前面!|r"
		elseif (achieveID == 215) then
			return "单通\"太平\"难度后可以自动获得该成就.
			|cffffff00该成就会显示在官方对战平台游戏大厅内哦,也会显示在你的名字前面!|r"
		elseif (achieveID == 216) then
			return "单通|cff999999\"天国\"难度|r后可以自动获得该成就.
			|cffffff00该成就会显示在官方对战平台游戏大厅内哦,也会显示在你的名字前面!|r"
		elseif (achieveID == 217) then
			return "使用至少12个英雄，每个进行至少1场游戏.
			|cffffff00该成就会显示在官方对战平台游戏大厅内哦,也会显示在你的名字前面!|r"
		elseif (achieveID == 218) then
			return "使用至少12个英雄，每个进行至少5场游戏.
			|cffffff00该成就会显示在官方对战平台游戏大厅内哦,也会显示在你的名字前面!|r"
		elseif (achieveID == 219) then
			return "使用至少12个英雄，每个进行至少10场游戏.
			|cffffff00该成就会显示在官方对战平台游戏大厅内哦,也会显示在你的名字前面!|r"
		elseif (achieveID == 220) then
			return "使用至少12个英雄，每个进行至少30场游戏.
			|r|cff3366ff使用该成就进行游戏英雄会有能量之光的特效哦!
			|cffffff00该成就会显示在官方对战平台游戏大厅内哦,也会显示在你的名字前面!|r"
		elseif (achieveID == 221) then
			return "在基地剩余0次防护罩时通关游戏.
			|cffffff00该成就会显示在官方对战平台游戏大厅内哦,也会显示在你的名字前面!|r"
		elseif (achieveID == 222) then
			return "在基地剩余0次防护罩,且生命低于25%时通关游戏.
			|r|cff3366ff使用该成就进行游戏英雄会有能量之光的特效哦!
			|cffffff00该成就会显示在官方对战平台游戏大厅内哦,也会显示在你的名字前面!|r"
		elseif (achieveID == 223) then
			return "在经典模式中135分钟内击败冥刹.
			|cffffff00该成就会显示在官方对战平台游戏大厅内哦,也会显示在你的名字前面!|r"
		elseif (achieveID == 224) then
			return "在经典模式中120分钟内击败冥刹.
			|cffffff00该成就会显示在官方对战平台游戏大厅内哦,也会显示在你的名字前面!|r"
		elseif (achieveID == 225) then
			return "在经典模式中90分钟内击败冥刹.
			|cffffff00该成就会显示在官方对战平台游戏大厅内哦,也会显示在你的名字前面!|r"
		elseif (achieveID == 226) then
			return "在经典模式中60分钟内击败冥刹.
			|r|cff3366ff使用该成就进行游戏英雄会有能量之光的特效哦!
			|cffffff00该成就会显示在官方对战平台游戏大厅内哦,也会显示在你的名字前面!|r"
		elseif (achieveID == 227) then
			return "在单场游戏中杀敌数达到1.5万。
			|cffffff00该成就会显示在官方对战平台游戏大厅内哦,也会显示在你的名字前面!|r"
		elseif (achieveID == 228) then
			return "在单场游戏中杀敌数达到4万。
			|cffffff00该成就会显示在官方对战平台游戏大厅内哦,也会显示在你的名字前面!|r"
		elseif (achieveID == 229) then
			return "在单场游戏中杀敌数达到8万。
			|cffffff00该成就会显示在官方对战平台游戏大厅内哦,也会显示在你的名字前面!|r"
		elseif (achieveID == 230) then
			return "在单场游戏中杀敌数达到15万。
			|r|cff3366ff使用该成就进行游戏英雄会有能量之光的特效哦!
			|cffffff00该成就会显示在官方对战平台游戏大厅内哦,也会显示在你的名字前面!|r"
		elseif (achieveID == 231) then
			return "单局游戏死亡次数达到100次。（凯撒触发天赋技能也算死亡）
			|cffffff00该成就会显示在官方对战平台游戏大厅内哦,也会显示在你的名字前面!|r"
		elseif (achieveID == 32) then
			return "在单场游戏中造成的总伤害达500亿。
			|cffffff00该成就会显示在官方对战平台游戏大厅内哦,也会显示在你的名字前面!|r"
		elseif (achieveID == 33) then
			return "在单场游戏中造成的总伤害达4000亿。
			|cffffff00该成就会显示在官方对战平台游戏大厅内哦,也会显示在你的名字前面!|r"
		elseif (achieveID == 34) then
			return "在单场游戏中造成的总伤害达30000亿。
			|cffffff00该成就会显示在官方对战平台游戏大厅内哦,也会显示在你的名字前面!|r"
		elseif (achieveID == 35) then
			return "在单场游戏中造成的总伤害达600000亿。
			|r|cff3366ff使用该成就进行游戏英雄会有能量之光的特效哦!
			|cffffff00该成就会显示在官方对战平台游戏大厅内哦,也会显示在你的名字前面!|r"
		elseif (achieveID == 36) then
			return "通过秘境挑战13层。
			|cffffff00该成就会显示在官方对战平台游戏大厅内哦,也会显示在你的名字前面!|r"
		elseif (achieveID == 37) then
			return "通过秘境挑战15层。
			|cffffff00该成就会显示在官方对战平台游戏大厅内哦,也会显示在你的名字前面!|r"
		elseif (achieveID == 38) then
			return "通过秘境挑战17层。
			|cffffff00该成就会显示在官方对战平台游戏大厅内哦,也会显示在你的名字前面!|r"
		elseif (achieveID == 39) then
			return "通过秘境挑战20层。
			|cffffff00该成就会显示在官方对战平台游戏大厅内哦,也会显示在你的名字前面!|r"
		elseif (achieveID == 310) then
			return "击败冥刹时所有玩家均0死亡。（凯撒触发天赋技能也算死亡）
			|r|cff3366ff使用该成就进行游戏英雄会有能量之光的特效哦!
			|cffffff00该成就会显示在官方对战平台游戏大厅内哦,也会显示在你的名字前面!|r"
		elseif (achieveID == 311) then
			return "击败任意难度巨能融合石6次。
			|cffffff00该成就会显示在官方对战平台游戏大厅内哦,也会显示在你的名字前面!|r"
		elseif (achieveID == 312) then
			return "击败任意难度巨能融合石20次。
			|cffffff00该成就会显示在官方对战平台游戏大厅内哦,也会显示在你的名字前面!|r"
		elseif (achieveID == 313) then
			return "击败轮回难度巨能融合石12次。
			|cffffff00该成就会显示在官方对战平台游戏大厅内哦,也会显示在你的名字前面!|r"
		elseif (achieveID == 314) then
			return "击败轮回难度巨能融合石40次。
			|r|cff3366ff使用该成就进行游戏英雄会有能量之光的特效哦!
			|cffffff00该成就会显示在官方对战平台游戏大厅内哦,也会显示在你的名字前面!|r"
		elseif (achieveID == 315) then
			return "总属性之和达到300 W.（成就获取在1分钟内，请耐心等待）
			|cffffff00该成就会显示在官方对战平台游戏大厅内哦,也会显示在你的名字前面!|r"
		elseif (achieveID == 316) then
			return "总属性之和达到800 W.（成就获取在1分钟内，请耐心等待）
			|cffffff00该成就会显示在官方对战平台游戏大厅内哦,也会显示在你的名字前面!|r"
		elseif (achieveID == 317) then
			return "总属性之和达到2000 W.（成就获取在1分钟内，请耐心等待）
			|cffffff00该成就会显示在官方对战平台游戏大厅内哦,也会显示在你的名字前面!|r"
		elseif (achieveID == 318) then
			return "总属性之和达到5000 W.（成就获取在1分钟内，请耐心等待）
			|r|cff3366ff使用该成就进行游戏英雄会有能量之光的特效哦!
			|cffffff00该成就会显示在官方对战平台游戏大厅内哦,也会显示在你的名字前面!|r"
		elseif (achieveID == 326) then
			return "在8分钟内将复活点处的门毁坏。
			|r|cff3366ff使用该成就进行游戏英雄会有能量之光的特效哦!
			|cffffff00该成就会显示在官方对战平台游戏大厅内哦,也会显示在你的名字前面!|r"
		elseif (achieveID == 320) then
			return "到通关为止基地未受到任何伤害。
			|r|cff3366ff使用该成就进行游戏英雄会有能量之光的特效哦!
			|cffffff00该成就会显示在官方对战平台游戏大厅内哦,也会显示在你的名字前面!|r"
		elseif (achieveID == 321) then
			return "鬼MAX戒指或者超鬼戒指吸收灵魂层数达到120.
			|r|cff3366ff使用该成就进行游戏英雄会有能量之光的特效哦!
			|cffffff00该成就会显示在官方对战平台游戏大厅内哦,也会显示在你的名字前面!|r"
		elseif (achieveID == 322) then
			return "使用至少12个英雄击败擂台十英雄-辕煞.
			|r|cff3366ff使用该成就进行游戏英雄会有能量之光的特效哦!
			|cffffff00该成就会显示在官方对战平台游戏大厅内哦,也会显示在你的名字前面!|r"
		elseif (achieveID == 323) then
			return "自己与所有队友从头到尾不打任何宝石,不打任何秘境,不打任何擂台,不合成任何翅膀通关游戏.
			|r|cff3366ff使用该成就进行游戏英雄会有能量之光的特效哦!
			|cffffff00该成就会显示在官方对战平台游戏大厅内哦,也会显示在你的名字前面!|r"
		elseif (achieveID == 324) then
			return "与低于(或等于)5级的玩家进行游戏通关满100人.
			|r|cff3366ff使用该成就进行游戏英雄会有能量之光的特效哦!
			|cffffff00该成就会显示在官方对战平台游戏大厅内哦,也会显示在你的名字前面!|r"
		elseif (achieveID == 327) then
			return "自己与所有队友不学2级技能，10级技能，20级技能，40级技能，100级技能通关游戏。
			|r|cff3366ff使用该成就进行游戏英雄会有能量之光的特效哦!
			|cffffff00该成就会显示在官方对战平台游戏大厅内哦,也会显示在你的名字前面!|r"
		elseif (achieveID == 328) then
			return "使用中型捕兽网（50 W上限）成功捕捉大于或等于50级的怪物。
			|cffffff00该成就会显示在官方对战平台游戏大厅内哦,也会显示在你的名字前面!|r"
		elseif (achieveID == 329) then
			return "使用中型捕兽网（50 W上限）成功捕捉大于或等于70级的怪物。
			|cffffff00该成就会显示在官方对战平台游戏大厅内哦,也会显示在你的名字前面!|r"
		elseif (achieveID == 330) then
			return "使用中型捕兽网（50 W上限）成功捕捉大于或等于100级的怪物。
			|cffffff00该成就会显示在官方对战平台游戏大厅内哦,也会显示在你的名字前面!|r"
		elseif (achieveID == 331) then
			return "使用中型捕兽网（50 W上限）成功捕捉大于或等于150级的怪物。
			|r|cff3366ff使用该成就进行游戏英雄会有能量之光的特效哦!
			|cffffff00该成就会显示在官方对战平台游戏大厅内哦,也会显示在你的名字前面!|r"
		elseif (achieveID == 43) then
			return "在迷你挑战1-骷髅海中里面的时间成功超过35秒.
			|cffffff00该成就会显示在官方对战平台游戏大厅内哦,也会显示在你的名字前面!|r"
		elseif (achieveID == 44) then
			return "在迷你挑战1-骷髅海中里面的时间成功超过80秒.
			|r|cff3366ff使用该成就进行游戏英雄会有能量之光的特效哦!
			|cffffff00该成就会显示在官方对战平台游戏大厅内哦,也会显示在你的名字前面!|r"
		elseif (achieveID == 45) then
			return "4人及以上游戏时,在击败人王傀儡与妖王傀儡时从未触发过BOSS生命联结技能.
			|r|cff3366ff使用该成就进行游戏英雄会有能量之光的特效哦!
			|cffffff00该成就会显示在官方对战平台游戏大厅内哦,也会显示在你的名字前面!|r"
		elseif (achieveID == 46) then
			return "单次技能伤害达到300亿.
			|r|cff3366ff使用该成就进行游戏英雄会有能量之光的特效哦!
			|cffffff00该成就会显示在官方对战平台游戏大厅内哦,也会显示在你的名字前面!|r"
		elseif (achieveID == 49) then
			return "从头到尾全地图同时存在的进攻怪从未超过20个.
			|r|cff3366ff使用该成就进行游戏英雄会有能量之光的特效哦!
			|cffffff00该成就会显示在官方对战平台游戏大厅内哦,也会显示在你的名字前面!|r"
		elseif (achieveID == 410) then
			return "完成任意难度的挑战模式中的\"驻永恒挑战\"
			|r|cff3366ff使用该成就进行游戏英雄会有能量之光的特效哦!
			|cffffff00该成就会显示在官方对战平台游戏大厅内哦,也会显示在你的名字前面!|r"
		elseif (achieveID == 411) then
			return "完成任意难度的挑战模式中的\"创世篇挑战\"
			|r|cff3366ff使用该成就进行游戏英雄会有能量之光的特效哦!
			|cffffff00该成就会显示在官方对战平台游戏大厅内哦,也会显示在你的名字前面!|r"
		elseif (achieveID == 412) then
			return "输入-hs1进行生命检测，此时你的英雄生命达到1%以下却未死。
			(检测时英雄不能带有瘟疫或者中毒的BUFF)
			|r|cff3366ff使用该成就进行游戏英雄会有能量之光的特效哦!
			|cffffff00该成就会显示在官方对战平台游戏大厅内哦,也会显示在你的名字前面!|r"
		elseif (achieveID == 413) then
			return "输入-hs2进行生命检测，使用非霸绝英雄进行游戏，生命值达到5亿或以上。
			|r|cff3366ff使用该成就进行游戏英雄会有能量之光的特效哦!
			|cffffff00该成就会显示在官方对战平台游戏大厅内哦,也会显示在你的名字前面!|r"
		elseif (achieveID == 414) then
			return "输入-hs3进行防御检测，防御达到100 W或以上。
			（注意检测结果将不包含于装备中的防御定值光环与装备中的短暂BUFF效果）
			|r|cff3366ff使用该成就进行游戏英雄会有能量之光的特效哦!
			|cffffff00该成就会显示在官方对战平台游戏大厅内哦,也会显示在你的名字前面!|r"
		elseif (achieveID == 415) then
			return "在一局游戏中成功答对30次仙帝傀儡——樱乐的问题.
			|r|cff3366ff使用该成就进行游戏英雄会有能量之光的特效哦!
			|cffffff00该成就会显示在官方对战平台游戏大厅内哦,也会显示在你的名字前面!|r"
		elseif (achieveID == 416) then
			return "在一局游戏中所有队友从未说过一句话通关游戏.
			|r|cff3366ff使用该成就进行游戏英雄会有能量之光的特效哦!
			|cffffff00该成就会显示在官方对战平台游戏大厅内哦,也会显示在你的名字前面!|r"
		elseif (achieveID == 417) then
			return "成功击杀秘境BOSS(21-25层)——夜袭使者。
			|r|cff3366ff使用该成就进行游戏英雄会有能量之光的特效哦!
			|cffffff00该成就会显示在官方对战平台游戏大厅内哦,也会显示在你的名字前面!|r"
		elseif (achieveID == 421) then
			return "使用\"皆\"字传承施放伤害时对超过120个单位同时造成伤害.(英雄需要在三级野区以左的地区施放.)
			|r|cff3366ff使用该成就进行游戏英雄会有能量之光的特效哦!
			|cffffff00该成就会显示在官方对战平台游戏大厅内哦,也会显示在你的名字前面!|r"
		elseif (achieveID == 422) then
			return "使用\"前\"字传承,利用前字幻影超过击杀6700个来进攻基地的怪物.
			|r|cff3366ff使用该成就进行游戏英雄会有能量之光的特效哦!
			|cffffff00该成就会显示在官方对战平台游戏大厅内哦,也会显示在你的名字前面!|r"
		elseif (achieveID == 423) then
			return "使用\"者\"字传承,在一次性时间(5秒,不能拥有霄霆加的光环)内累计死亡18次.
			|r|cff3366ff使用该成就进行游戏英雄会有能量之光的特效哦!
			|cffffff00该成就会显示在官方对战平台游戏大厅内哦,也会显示在你的名字前面!|r"
		endif
		return ""
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    获取页数与索引对应的成就序号
	*/
	function GetAchievementIndex takes integer page,integer index returns integer
		if (page == 1) then
			return I3(index == 9,325,page * 10 + index)
		elseif (page == 2) then
			return (page * 10 + index)
		elseif (page == 3) then
			return I3(index < 8,217 - index,29)
		elseif (page == 4) then
			return index + 216
		elseif (page == 5) then
			return I3(index < 8,index + 224,310)
		elseif (page == 6) then
			return index + 31
		elseif (page == 7) then
			return index + 310
		elseif (page == 8) then
			return I3(index == 7,327,I3(index == 1,326,index + 318))
		elseif (page == 9) then
			return I3(index <= 4 ,index + 327,index + 38)
		elseif (page == 10) then
			return I3(index == 1 ,49,index + 408)
		elseif (page == 11) then
			return index + 420
		endif
		return 0
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    英雄挑战的名字
	*/
	function GetHeroChallenageName takes integer i,integer page returns string
		if (page == 1) then
			if (i == 2) then
				return "瑟雨：|cffff66cc赤血白燕|r"
			elseif (i == 3) then
				return "晓月：|cff99ccff月轮绯狱|r"
			elseif (i == 4) then
				return "湮灭：|cFFFF0000殛霆无迹|r"
			elseif (i == 5) then
				return "玄雪：|cFF33FF33末日权杖|r"
			elseif (i == 6) then
				return "泰雅：|cFFCCFF66三弦星谧|r"
			elseif (i == 7) then
				return "辰寂：|cFFFF3333霜夜之哀|r"
			elseif (i == 8) then
				return "寒殇：|cFF3333FF獠牙之匕|r"
			elseif (i == 9) then
				return "凌雪：|cFF339933沐雪无瑕|r"
			elseif (i == 10) then
				return "辰寂：|cFFFF3333双流贯恒|r"
			endif
		elseif (page == 2) then
			if (i == 1) then
				return "莫琪：|cFFFF00CC星界麒麟|r"
			elseif (i == 2) then
				return "凯撒：|cFF6699FF熔日煌世|r"
			elseif (i == 3) then
				return "玄雪：|cFFFF0000凝冰红灯|r"
			elseif (i == 4) then
				return "摄焱：|cffff0000凰迹天知|r"
			elseif (i == 5) then
				return "霸绝：|cFF6699FF封霜玄锋|r"
			elseif (i == 6) then
				return "幻逸：|cffff6800天罚四界|r"
			elseif (i == 7) then
				return "司宸：|cff33cccc白莲圣日·黑羽魔月|r"
			elseif (i == 8) then
				return "苍凌：|cff993366翎翼浮灵|r"
			elseif (i == 9) then
				return "黑阎：|cff0000ff七阴之恸|r"
			elseif (i == 10) then
				return "离魑：|cffff6800谜幻逸空|r"
			endif
		elseif (page == 3) then
			if (i == 1) then
				return "寒殇：|cFF3333FF耀金独心|r"
			elseif (i == 2) then
				return "星胧：|cffff00ff绯想龙域|r"
			elseif (i == 3) then
				return "梦霁：|cffff00ff独步帝弓|r"
			endif
		endif
		return ""
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    超级成就的名字
	*/
	function GetSuperChallenageName takes integer i returns string
		if (i == 1) then
			return "全成就达成"
		elseif (i == 2) then
			return "通关|cff993366天魇|r"
		elseif (i == 3) then
			return "连续登录20天"
		elseif (i == 4) then
			return "所有英雄99次使用"
		elseif (i == 5) then
			return "狂欢模式中单通万劫"
		elseif (i == 6) then
			return "狂欢模式中多通天魇"
		endif
		return ""
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    英雄挑战的条件
	*/
	function GetHeroChallenageContent takes integer i,integer page returns string
		if (page == 1) then
			if (i == 2) then
				return "使用瑟雨在1秒内将能量从0%直接增加至105%(或以上).
				完成该项挑战后你将获得瑟雨的皮肤\"|cffff66cc赤血白燕|r\"(拥有少量的属性加成)!"
			elseif (i == 3) then
				return "使用晓月在一局游戏内成功在黯黑杀阵内成功复活满150人.
				完成该项挑战后你将获得晓月的皮肤\"|cff99ccff月轮绯狱|r\"(拥有少量的属性加成)!"
			elseif (i == 4) then
				return "使用湮灭在一局游戏内成功完成125次转生.
				完成该项挑战后你将获得湮灭的皮肤\"|cFFFF0000殛霆无迹|r\"(拥有少量的属性加成)!"
			elseif (i == 5) then
				return "使用玄雪在一局游戏内成功单通战争难度(或以上).
				完成该项挑战后你将获得玄雪的模型法杖\"|cFF33FF33末日权杖|r\"(拥有少量的属性加成)!"
			elseif (i == 6) then
				return "使用泰雅在一局游戏中成功使用月神之箭技能触发\"秒\"效果杀死至少2500个单位.
				完成该项挑战后你将获得泰雅的皮肤\"|cFFCCFF66三弦星谧|r\"(拥有少量的属性加成)!"
			elseif (i == 7) then
				return "使用辰寂在一局游戏中成功使用满7次90剑灵技能-引渡.
				完成该项挑战后你将获得辰寂的模型特效\"|cFFFF3333霜夜之哀|r\"(拥有少量的属性加成)!"
			elseif (i == 8) then
				return "使用寒殇在一局游戏内成功使用无穷吞噬技能获得超过500万的总和属性.
				完成该项挑战后你将获得寒殇的模型武器\"|cFF3333FF獠牙之匕|r\"(拥有少量的属性加成)!"
			elseif (i == 9) then
				return "在每天的连续签到中达到14天。
				完成该项挑战后你将获得凌雪的皮肤\"|cFF339933沐雪无瑕|r\"(拥有少量的属性加成)!"
			elseif (i == 10) then
				return "输入-chenji可以进行检测，若此时英雄的生命低于1%，则完成该挑战。
				完成该项挑战后你将获得辰寂的皮肤\"|cFFFF3333双流贯恒|r\"(拥有少量的属性加成)!"
			endif
		elseif (page == 2) then
			if (i == 1) then
				return "使用莫琪在使用|cffffcc00裁决|r技能时的施法角度在89.9-90.1度之内.
						(换句话说即为完全垂直向上射)
				完成该项挑战后你将获得莫琪的皮肤\"|cFFFF00CC星界麒麟|r\"(拥有少量的属性加成)!"
			elseif (i == 2) then
				return "使用凯撒在一局游戏中只靠|cffff6800忠诚之躯|r技能杀死攻击基地的敌人2500个.
				完成该项挑战后你将获得凯撒的皮肤\"|cFF6699FF熔日煌世|r\"(拥有少量的属性加成)!"
			elseif (i == 3) then
				return "使用玄雪在一局游戏内成功侵入134种不同的生物.(注意,如果你需要进行该挑战,请在第一波前输入-xx以开启该英雄挑战)
				完成该项挑战后你将获得玄雪的皮肤\"|cFFFF0000凝冰红灯|r\"(拥有少量的属性加成)!"
			elseif (i == 4) then
				return "使用摄焱在一局游戏中杀敌数满125000.
				完成该项挑战后你将获得摄焱的皮肤\"|cffff0000凰迹天知|r\"(拥有少量的属性加成)!"
			elseif (i == 5) then
				return "使用霸绝在使用|cFFFF0099剑法IV式 - 永恒|r技能结束后的落点距离英雄在施放该技能的位置有8000码远.(注意,如果你需要进行该挑战,请在第一波前输入-bj以开启该英雄挑战,注意要使用主英雄施放,其他分身施放无效)
				完成该项挑战后你将获得霸绝的皮肤\"|cFF6699FF封霜玄锋|r\"(拥有少量的属性加成)!"
			elseif (i == 6) then
				return "
				使用幻逸输入-hy后进入挑战:将会随机出现一个技能名字,切换到对应名字的技能即可,然后继续随机出现下一个技能名字,30秒内成功切换25次即为挑战成功.
				完成该项挑战后你将获得幻逸的皮肤\"|cffff6800天罚四界|r\"(拥有少量的属性加成)!"
			elseif (i == 7) then
				return "
				使用司宸属性总和达到3500 W.
				完成该项挑战后你将获得司宸的皮肤\"|cff33cccc白莲圣日·黑羽魔月|r\"(拥有少量的属性加成)!"
			elseif (i == 8) then
				return "
				使用苍凌在一局游戏中不灭真炎时间叠加到750秒.
				完成该项挑战后你将获得苍凌的皮肤\"|cff993366翎翼浮灵|r\"(拥有少量的属性加成)!"
			elseif (i == 9) then
				return "
				使用黑阎在一局使用泣罗刹祭品替死达到300次,且自身不能死亡一次.
				完成该项挑战后你将获得黑阎的皮肤\"|cff0000ff七阴之恸|r\"(拥有少量的属性加成)!"
			elseif (i == 10) then
				return "
				使用离魑在一局触发影爆次数达到100次.
				完成该项挑战后你将获得离魑的皮肤\"|cffff6800谜幻逸空|r\"(拥有少量的属性加成)!"
			endif
		elseif (page == 3) then
			if (i == 1) then
				return "
				使用寒殇在一局游戏中总共获得(捡起)过520种不同的物品(包括升级装备的书本).(需要输入-lj来开启该挑战)
				完成该项挑战后你将获得寒殇的皮肤\"|cFF3333FF耀金独心|r\"(拥有少量的属性加成)!"
			elseif (i == 2) then
				return "
				使用星胧在一局游戏中总共升级累计30000次.
				完成该项挑战后你将获得星胧的皮肤\"|cffff00ff绯想龙域|r\"(拥有少量的属性加成)!"
			endif
		endif
		return ""
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    英雄挑战的条件
	*/
	function GetSuperChallenageContent takes integer i returns string
		if (i == 1) then
			return "解锁截止上个版本以来的所有成就.(输入-cj可以查看所有成就情况)
			完成该项挑战后你将可以使用-qm指令自定义你的成就名!"
		elseif (i == 2) then
			return "通关隐藏难度|cff993366天魇|r(通关|cff008000万劫|r难度解锁)
			完成该项挑战后你的名字将在以后始终置顶于|cff008000\"封帝万劫录\"|r中!
			并获得四字成就名"+GetAchievementName(42)+"。"
		elseif (i == 3) then
			return "在嘉年华活动版本中连续签到达20天.
			完成该项挑战后可以在每次开局选英雄后接受来自六界的欢迎。
			并获得四字成就名"+GetAchievementName(47)+"。"
		elseif (i == 4) then
			return "全英雄99次达成!
			完成该项挑战后每局游戏中在基地出现罩子时有着不一样的文字提醒哦!
			并获得五字成就名"+GetAchievementName(48)+"。"
		elseif (i == 5) then
			return "在狂欢模式中单人通关万劫难度.
			获得成就名"+GetAchievementName(418)+"。
			如果你同时完成了"+GetAchievementName(420)+",那么你将可以在许愿时获得额外的奖励.
			"
		elseif (i == 6) then
			return "在狂欢模式中多人通关天魇难度.
			获得成就名"+GetAchievementName(420)+"。
			如果你同时完成了"+GetAchievementName(418)+",那么你将可以在许愿时获得额外的奖励.
			"
		endif
		return ""
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    万劫录
	*/
	function GetWanjieluName takes nothing returns string
		set WPointer = WPointer - 1
		if (WPointer <= 0) then
			set WPointer = COUNT_WANJIE
		endif
		if (WPointer == 1) then
			return "话唠。"
		elseif (WPointer == 2) then
			return "与你童在"
		elseif (WPointer == 3) then
			return "丶念少。"
		elseif (WPointer == 4) then
			return "祭轮回丶"
		elseif (WPointer == 5) then
			return "嚣张城"
		elseif (WPointer == 6) then
			return "神天羽"
		endif
		return ""
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    初始化
	*/
	private function InitConstant takes nothing returns nothing
		local integer i = 1
		loop
			exitwhen i > 6
			if ((GetPlayerSlotState(ConvertedPlayer(i)) == PLAYER_SLOT_STATE_PLAYING) and (GetPlayerController(ConvertedPlayer(i)) == MAP_CONTROL_USER)) then
				set renshu = renshu + 1
			endif
			set i = i +1
		endloop
	endfunction
endlibrary
library_once PIVInterface
	globals
		boolean array sPIV
	endglobals
//---------------------------------------------------------------------------------------------------
	/*
	    是否是VIP
	*/
	function IsPIV takes player p returns boolean
		return sPIV[GetConvertedPlayerId(p)]
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    判断是否有VIP
	*/
	function hasPIV takes nothing returns boolean
		local integer i = 1
		loop
			exitwhen i > 6
			if (IsPIV(ConvertedPlayer(i))) then
				return true
			endif
			set i = i +1
		endloop
		return false
	endfunction
endlibrary
library_once LHBase initializer InitLHBase requires Constant,JBase,PIVInterface//,Test
    globals
        unit learnSkillHero = null
        /*
            仓库
        */
        unit array UDepot
        string array playerName
        /*
            魔兽显示
        */
        boolean array BMoshou
        /*
            万劫封帝录
        */
        unit Uwanjie = null
        hashtable itemTable = InitHashtable()
        hashtable LHTable = InitHashtable()
        hashtable spellTable = InitHashtable()
        /*
            全局变量 英雄
        */
        unit kaisa = null
        unit yanmie = null
        unit moqi = null
        unit lingxue = null
        unit bajue = null
        unit seyu = null
        unit xiaoyue = null
        unit xuanxue = null
        unit chenji = null
        unit hanshang = null
        unit taiya = null
        unit sheyan = null
        unit Heiyan = null
        unit cangling = null
        unit mengji = null
        unit Huanyi = null
        unit sichen = null
        unit xinglong = null
        unit xiaoting = null
        unit lichi = null
        /*
            觉醒
        */
        boolean array BJuexing1
        boolean array BJuexing2
        boolean array BJuexing3
        //是否变色
        timer array TBianse
        //是否正在禁用天赋
        boolean BTianfu = false
        boolean array BYeguaiFirst
        //是否显示伤害
        boolean array BHideDamage
        //是否可以跳关
        //boolean BSkipKuilei = false
        //英雄死了
        boolean array BHeroDeath
        //轮流玩家指针
        integer INextPlayerID = 0
        //京剧
        boolean JJ1 = false
        boolean JJ2 = false
        boolean JJ3 = false
        boolean JJ4 = false
        item array IBibo
        //仓库改称号
        boolean array BBoxName
        boolean BBuqian1 = false
        boolean BBuqian2 = false
        boolean BBuqian3 = false
        //英雄是否3秒复活
        boolean array B3SecondRevive
    endglobals
//---------------------------------------------------------------------------------------------------
    /*
        判断是否是力量英雄
    */
    function IsStrHero takes unit u returns boolean
        return u == kaisa or u == chenji or u ==bajue or u == Heiyan or u == xinglong
    endfunction
//---------------------------------------------------------------------------------------------------
    /*
        判断是否是敏捷英雄
    */
    function IsAgiHero takes unit u returns boolean
        return u == taiya or u == xiaoyue or u == mengji or u == moqi or u == hanshang or u == cangling or u == seyu or u == yanmie or u == sichen or u == xiaoting
    endfunction
//---------------------------------------------------------------------------------------------------
    /*
        判断是否是智力英雄
    */
    function IsIntHero takes unit u returns boolean
        return u == lingxue or u == xuanxue or u == sheyan or u == Huanyi or u == lichi
    endfunction
//---------------------------------------------------------------------------------------------------
    /*
        判断是否是魔界英雄
    */
    function IsMo takes unit u returns boolean
        return u == lichi
    endfunction
//---------------------------------------------------------------------------------------------------
    /*
        仙器使用技能进行禁止丢弃判断
    */
    function IsXianSpell takes integer spell returns boolean
        return (spell == 'Acht') or (spell =='A03A') or (spell =='A0BM') /*
            */or (spell =='A07Z') or (spell =='A07T') or (spell =='A05Z')/*
            */or (spell =='ACro') or (spell =='Acht') or (spell =='A07X') or (spell =='A05Y')/*
            */or (spell =='AChv') or (spell =='A07V') or (spell =='Awrg') or (spell =='A05X')/*
            */or (spell =='A07C') or (spell =='A07D') or (spell =='Awrh') or (spell =='A075')/*
            */or (spell =='A06W') or (spell =='A06Y') or (spell =='A06Q') or (spell =='A07R')/*
            */or (spell =='ACcl') or (spell =='AOhw') or (spell =='AIin') or (spell =='AIil')/*
            */or (spell =='A07S') or (spell =='AChx')
    endfunction
//---------------------------------------------------------------------------------------------------
    /*
        元素之灵过滤器
    */
    function IsYuansu takes unit u returns boolean
        return GetUnitTypeId(u) == 'nlv3' or GetUnitTypeId(u) == 'hwat' or GetUnitTypeId(u) == 'nbal' or GetUnitTypeId(u) == 'nvde' or GetUnitTypeId(u) == 'ehpr' or GetUnitTypeId(u) == 'nsll' or GetUnitTypeId(u) == 'nadr' or GetUnitTypeId(u) == 'nitp' or GetUnitTypeId(u) == 'nsgg' or GetUnitTypeId(u) == 'nehy' or GetUnitTypeId(u) == 'nbzd'
    endfunction
//---------------------------------------------------------------------------------------------------
    /*
        禁止复制的装备
    */
    function IsCanCopy takes item i returns boolean
        return ((GetItemTypeId(i) != 'mgtk') and (GetItemTypeId(i) != 'k3m1') and (GetItemTypeId(i) != 'pomn') and (GetItemTypeId(i) != 'wild') and (GetItemTypeId(i) != 'hlst') and (GetItemTypeId(i) != 'totw') and (GetItemTypeId(i) != 'sror') and (GetItemTypeId(i) != 'fgrg') and (GetItemTypeId(i) != 'wshs') and (GetItemTypeId(i) != 'IXU1') and (GetItemTypeId(i) != 'I049') and (GetItemTypeId(i) != 'I04A') and (GetItemTypeId(i) != 'I000') and (GetItemTypeId(i) != 'I001') and (GetItemTypeId(i) != 'I002') and (GetItemTypeId(i) != 'I01D') and (GetItemTypeId(i) != 'I02W') and (GetItemTypeId(i) != 'sres') and (GetItemTypeId(i) != 'I06A') and (GetItemTypeId(i) != 'I06B') and (GetItemTypeId(i) != 'I06C') and (GetItemTypeId(i) != 'I06J') and (GetItemTypeId(i) != 'I062') and (GetItemTypeId(i) != 'ICS1') and (GetItemTypeId(i) != 'I04W') and (GetItemTypeId(i) != 'I04Y') and (GetItemTypeId(i) != 'I05T') and (GetItemTypeId(i) != 'I05W') and (GetItemTypeId(i) != 'I05V') and (GetItemTypeId(i) != 'ICY1') and (GetItemTypeId(i) != 'I05X') and (GetItemTypeId(i) != 'IB0A') and (GetItemTypeId(i) != 'I04X') and (GetItemTypeId(i) != 'ICX1') and (GetItemTypeId(i) != 'I05Y') and (GetItemTypeId(i) != 'I05Z') and (GetItemTypeId(i) != 'I060') and (GetItemTypeId(i) != 'I06N') and (GetItemTypeId(i) != 'I07D') and (GetItemTypeId(i) != 'I07T') and (GetItemTypeId(i) != 'I07E') and (GetItemTypeId(i) != 'I07F') and (GetItemTypeId(i) != 'I07G') and (GetItemTypeId(i) != 'I07H') and (GetItemTypeId(i) != 'I07I') and (GetItemTypeId(i) != 'I07J') and (GetItemTypeId(i) != 'I07K') and (GetItemTypeId(i) != 'I07O') and (GetItemTypeId(i) != 'I07N') and (GetItemTypeId(i) != 'I07P') and (GetItemTypeId(i) != 'I07Q') and (GetItemTypeId(i) != 'I07M') and (GetItemTypeId(i) != 'I07L') and (GetItemTypeId(i) != 'I05U') and (GetItemTypeId(i) != 'I07R') and (GetItemTypeId(i) != 'I02U') and (GetItemTypeId(i) != 'I02V') and (GetItemTypeId(i) != 'I02X') and (GetItemTypeId(i) != 'I031'))
    endfunction
//---------------------------------------------------------------------------------------------------
    /*
        判断是否是1-9宝石或者3种组合石
    */
    function IsDiamond takes item i returns boolean
        return GetItemTypeId(i) == 'I02N' or GetItemTypeId(i) == 'I04S' or GetItemTypeId(i) == 'azhr' or GetItemTypeId(i) == 'gmfr' or GetItemTypeId(i) == 'jpnt' or GetItemTypeId(i) == 'glsk' or GetItemTypeId(i) == 'kygh' or GetItemTypeId(i) == 'sehr' or GetItemTypeId(i) == 'bzbf' or GetItemTypeId(i) == 'phlt' or GetItemTypeId(i) == 'dkfw' or GetItemTypeId(i) == 'thle'
    endfunction
//---------------------------------------------------------------------------------------------------
    /*
        20个全体的单位
    */
    function Is20Unit takes unit u returns boolean
        return (((GetUnitTypeId(u) == 'nanw') or (GetUnitTypeId(u) == 'nbld') or (GetUnitTypeId(u) == 'nbdo') or (GetUnitTypeId(u) == 'ncnk') or (GetUnitTypeId(u) == 'nenc') or (GetUnitTypeId(u) == 'ngnw')))
    endfunction
//---------------------------------------------------------------------------------------------------
    /*
        10个全体的单位
    */
    function Is10Unit takes unit u returns boolean
        return (((GetUnitTypeId(u) == 'nano') or (GetUnitTypeId(u) == 'nenf') or (GetUnitTypeId(u) == 'nbda') or (GetUnitTypeId(u) == 'ncim') or (GetUnitTypeId(u) == 'ngns') or (GetUnitTypeId(u) == 'nhfp')))
    endfunction
//---------------------------------------------------------------------------------------------------
    /*
        获取某个单位应该对应的杀敌数
    */
    function GetKillCount takes unit u returns integer
        if (Is10Unit(u)) then
            return 10 * CModeH(1,2)
        elseif (Is20Unit(u)) then
            return 20 * CModeH(1,2)
        else
            return 1 * CModeH(1,2)
        endif
    endfunction
//---------------------------------------------------------------------------------------------------
    /*
        判断一个单位是否无敌
    */
    function IsWudi takes unit u returns boolean
        return GetUnitAbilityLevel(u,'Avul') > 0
    endfunction
//---------------------------------------------------------------------------------------------------
    /*
        戒指1-9过滤器
    */
    function GetBasicRing takes unit u returns item
        if (YDWEUnitHasItemOfTypeBJNull(u,'rat9'))then
            return YDWEGetItemOfTypeFromUnitBJNull(u, 'rat9')
        elseif (YDWEUnitHasItemOfTypeBJNull(u,'rlif'))then
            return YDWEGetItemOfTypeFromUnitBJNull(u, 'rlif')
        elseif (YDWEUnitHasItemOfTypeBJNull(u,'lgdh'))then
            return YDWEGetItemOfTypeFromUnitBJNull(u, 'lgdh')
        elseif (YDWEUnitHasItemOfTypeBJNull(u,'clfm'))then
            return YDWEGetItemOfTypeFromUnitBJNull(u, 'clfm')
        elseif (YDWEUnitHasItemOfTypeBJNull(u,'bgst'))then
            return YDWEGetItemOfTypeFromUnitBJNull(u, 'bgst')
        elseif (YDWEUnitHasItemOfTypeBJNull(u,'belv'))then
            return YDWEGetItemOfTypeFromUnitBJNull(u, 'belv')
        elseif (YDWEUnitHasItemOfTypeBJNull(u,'hcun'))then
            return YDWEGetItemOfTypeFromUnitBJNull(u, 'hcun')
        elseif (YDWEUnitHasItemOfTypeBJNull(u,'rag1'))then
            return YDWEGetItemOfTypeFromUnitBJNull(u, 'rag1')
        elseif (YDWEUnitHasItemOfTypeBJNull(u,'penr'))then
            return YDWEGetItemOfTypeFromUnitBJNull(u, 'penr')
        endif
        return null
    endfunction
//---------------------------------------------------------------------------------------------------
    /*
        戒指max和超鬼过滤器
    */
    function GetMaxRing takes unit u returns item
        if (YDWEUnitHasItemOfTypeBJNull(u,'brac')) then
            return YDWEGetItemOfTypeFromUnitBJNull(u, 'brac')
        elseif (YDWEUnitHasItemOfTypeBJNull(u,'lhst'))then
            return YDWEGetItemOfTypeFromUnitBJNull(u, 'lhst')
        elseif (YDWEUnitHasItemOfTypeBJNull(u,'I05W'))then
            return YDWEGetItemOfTypeFromUnitBJNull(u, 'I05W')
        elseif (YDWEUnitHasItemOfTypeBJNull(u,'I05V'))then
            return YDWEGetItemOfTypeFromUnitBJNull(u, 'I05V')
        elseif (YDWEUnitHasItemOfTypeBJNull(u,'I07M'))then
            return YDWEGetItemOfTypeFromUnitBJNull(u, 'I07M')
        elseif (YDWEUnitHasItemOfTypeBJNull(u,'I07L'))then
            return YDWEGetItemOfTypeFromUnitBJNull(u, 'I07L')
        endif
        return null
    endfunction
//---------------------------------------------------------------------------------------------------
    /*
        判断是否是鬼戒指Max或者超鬼
    */
    function IsMaxRing takes item i returns boolean
        return GetItemTypeId(i) == 'brac' or GetItemTypeId(i) == 'lhst' or GetItemTypeId(i) == 'I05W' or GetItemTypeId(i) == 'I05V' or GetItemTypeId(i) == 'I07M' or GetItemTypeId(i) == 'I07L'
    endfunction
//---------------------------------------------------------------------------------------------------
    /*
        戒指过滤器
    */
    function GetRing takes unit u returns item
        if (YDWEUnitHasItemOfTypeBJNull(u,'rat9')) then
            return YDWEGetItemOfTypeFromUnitBJNull(u, 'rat9')
        elseif (YDWEUnitHasItemOfTypeBJNull(u,'rlif')) then
            return YDWEGetItemOfTypeFromUnitBJNull(u, 'rlif')
        elseif (YDWEUnitHasItemOfTypeBJNull(u,'lgdh')) then
            return YDWEGetItemOfTypeFromUnitBJNull(u, 'lgdh')
        elseif (YDWEUnitHasItemOfTypeBJNull(u,'clfm')) then
            return YDWEGetItemOfTypeFromUnitBJNull(u, 'clfm')
        elseif (YDWEUnitHasItemOfTypeBJNull(u,'bgst')) then
            return YDWEGetItemOfTypeFromUnitBJNull(u, 'bgst')
        elseif (YDWEUnitHasItemOfTypeBJNull(u,'belv')) then
            return YDWEGetItemOfTypeFromUnitBJNull(u, 'belv')
        elseif (YDWEUnitHasItemOfTypeBJNull(u,'hcun')) then
            return YDWEGetItemOfTypeFromUnitBJNull(u, 'hcun')
        elseif (YDWEUnitHasItemOfTypeBJNull(u,'rag1')) then
            return YDWEGetItemOfTypeFromUnitBJNull(u, 'rag1')
        elseif (YDWEUnitHasItemOfTypeBJNull(u,'penr')) then
            return YDWEGetItemOfTypeFromUnitBJNull(u, 'penr')
        elseif (YDWEUnitHasItemOfTypeBJNull(u,'brac')) then
            return YDWEGetItemOfTypeFromUnitBJNull(u, 'brac')
        elseif (YDWEUnitHasItemOfTypeBJNull(u,'lhst')) then
            return YDWEGetItemOfTypeFromUnitBJNull(u, 'lhst')
        elseif (YDWEUnitHasItemOfTypeBJNull(u,'I05W')) then
            return YDWEGetItemOfTypeFromUnitBJNull(u, 'I05W')
        elseif (YDWEUnitHasItemOfTypeBJNull(u,'I05V')) then
            return YDWEGetItemOfTypeFromUnitBJNull(u, 'I05V')
        elseif (YDWEUnitHasItemOfTypeBJNull(u,'I07M')) then
            return YDWEGetItemOfTypeFromUnitBJNull(u, 'I07M')
        elseif (YDWEUnitHasItemOfTypeBJNull(u,'I07L')) then
            return YDWEGetItemOfTypeFromUnitBJNull(u, 'I07L')
        endif
        return null
    endfunction
//---------------------------------------------------------------------------------------------------
    /*
        获取英雄身上的是什么灯
    */
    function GetDeng takes unit u returns integer
        if (YDWEUnitHasItemOfTypeBJNull(u,'ILI1')) then
            return 1
        elseif (YDWEUnitHasItemOfTypeBJNull(u,'ILI2')) then
            return 2
        elseif (YDWEUnitHasItemOfTypeBJNull(u,'ILI3')) then
            return 3
        elseif (YDWEUnitHasItemOfTypeBJNull(u,'ILI4')) then
            return 4
        elseif (YDWEUnitHasItemOfTypeBJNull(u,'ILI5')) then
            return 5
        elseif (YDWEUnitHasItemOfTypeBJNull(u,'ILI6')) then
            return 6
        elseif (YDWEUnitHasItemOfTypeBJNull(u,'ILI7')) then
            return 7
        elseif (YDWEUnitHasItemOfTypeBJNull(u,'ILI8')) then
            return 8
        elseif (YDWEUnitHasItemOfTypeBJNull(u,'ILI9')) then
            return 9
        elseif (YDWEUnitHasItemOfTypeBJNull(u,'ILIA')) then
            return 10
        elseif (YDWEUnitHasItemOfTypeBJNull(u,'ILIB')) then
            return 11
        elseif (YDWEUnitHasItemOfTypeBJNull(u,'ILIC')) then
            return 12
        elseif (YDWEUnitHasItemOfTypeBJNull(u,'ILID')) then
            return 13
        elseif (YDWEUnitHasItemOfTypeBJNull(u,'ILIE')) then
            return 14
        elseif (YDWEUnitHasItemOfTypeBJNull(u,'ILIF')) then
            return 15
        elseif (YDWEUnitHasItemOfTypeBJNull(u,'ILIG')) then
            return 16
        elseif (YDWEUnitHasItemOfTypeBJNull(u,'ILIH')) then
            return 17
        elseif (YDWEUnitHasItemOfTypeBJNull(u,'ILII')) then
            return 18
        elseif (YDWEUnitHasItemOfTypeBJNull(u,'ILIJ')) then
            return 19
        elseif (YDWEUnitHasItemOfTypeBJNull(u,'ILIK')) then
            return 20
        elseif (YDWEUnitHasItemOfTypeBJNull(u,'I07D')) then
            return 21
        endif
        return 0
    endfunction
//---------------------------------------------------------------------------------------------------
    /*
        判断是否是战魂与死亡勋章
    */
    //判断超
    function IsZhanfaChao takes item i returns boolean
        local integer id = GetItemTypeId(i)
        return id == 'rst1' or id == 'I05U' or id == 'ICX1'
    endfunction
    function IsZhan0 takes item i returns boolean
        local integer id = GetItemTypeId(i)
        return IsZhanfaChao(i) or id == 'rde2' or id == 'vamp' or id == 'skul' or id == 'tsct' or id == 'tcas' or id == 'plcl' or id == 'tgrh' or id == 'I01E'
    endfunction
    function IsFa0 takes item i returns boolean
        local integer id = GetItemTypeId(i)
        return IsZhanfaChao(i) or id == 'rnec' or id == 'shas' or id == 'spro' or id == 'phea' or id == 'rin1' or id == 'ward' or id == 'rde1'
    endfunction
    function IsZhanfa3 takes item i returns boolean
        local integer id = GetItemTypeId(i)
        return IsZhanfaChao(i) or id == 'spro' or id == 'tcas' or id == 'shas' or id == 'plcl' or id == 'rnec' or id == 'tgrh' or id == 'phea' or id == 'tsct'
    endfunction
    function IsZhanfahun takes item i returns boolean
        local integer id = GetItemTypeId(i)
        return IsFa0(i) or IsZhan0(i)
    endfunction
//---------------------------------------------------------------------------------------------------
    /*
        获取英雄身上的夜之哀伤
    */
    function GetYeai takes nothing returns item
        if (YDWEUnitHasItemOfTypeBJNull(chenji,'stel')) then
            return YDWEGetItemOfTypeFromUnitBJNull(chenji, 'stel')
        elseif (YDWEUnitHasItemOfTypeBJNull(chenji,'I04M')) then
            return YDWEGetItemOfTypeFromUnitBJNull(chenji, 'I04M')
        endif
        return null
    endfunction
//---------------------------------------------------------------------------------------------------
    /*
        敏感物品
    */
    function IsMinganItem takes item i returns boolean
        return i == GetYeai() or GetItemTypeId(i) == 'I079'
    endfunction
//---------------------------------------------------------------------------------------------------
    /*
        判断是否是灯
    */
    function IsDeng takes item i returns boolean
        local integer t = GetItemTypeId(i)
        return ( t == 'ILI1') or ( t == 'ILI2') or ( t == 'ILI3') or ( t == 'ILI4') or ( t == 'ILI5') or ( t == 'ILI6') or ( t == 'ILI7') or ( t == 'ILI8') or ( t == 'ILI9') or ( t == 'ILIA') or ( t == 'ILIB') or ( t == 'ILIC') or ( t == 'ILID') or ( t == 'ILIE') or ( t == 'ILIF') or ( t == 'ILIG') or ( t == 'ILIH') or ( t == 'ILII') or ( t == 'ILIJ') or ( t == 'ILIK') or ( t == 'I07D')
    endfunction
//---------------------------------------------------------------------------------------------------
    /*
        敌人过滤器,判断玩家的,包含魔免
    */
    function IsEnemyMP takes unit u, player p returns boolean
        return IsUnitType(u, UNIT_TYPE_SLEEPING) == false and GetUnitState(u, UNIT_STATE_LIFE) > 0.405 /*
        */and IsUnitType(u, UNIT_TYPE_STRUCTURE) == false and IsUnitAliveBJ(u) == true /*
        */and IsUnitHidden(u) == false and IsUnitEnemy(u, p) /*
        */and IsUnitVisible(u, p) and GetUnitAbilityLevel(u,'Avul') < 1 /*
        */and GetUnitPointValue(u) != 123 and GetUnitPointValue(u) != 0
    endfunction
//---------------------------------------------------------------------------------------------------
    /*
        敌人过滤器，包含魔免单位
    */
    function IsEnemyM takes unit u, unit caster returns boolean
        return IsEnemyMP(u,GetOwningPlayer(caster))
    endfunction
//---------------------------------------------------------------------------------------------------
    /*
        雇佣兵过滤器
    */
    function IsSolider takes unit u returns boolean
        return (GetUnitTypeId(u) == 'uG01') or (GetUnitTypeId(u) == 'uG02') or (GetUnitTypeId(u) == 'uG03') or (GetUnitTypeId(u) == 'uG04') or (GetUnitTypeId(u) == 'uG05') or (GetUnitTypeId(u) == 'uG06')
    endfunction
//---------------------------------------------------------------------------------------------------
    /*
        敌人过滤器1,只能造成伤害的
    */
   function IsEnemyP takes unit u, player p returns boolean
        return IsUnitType(u, UNIT_TYPE_MAGIC_IMMUNE) == false and IsEnemyMP(u,p) and IsUnitType(u, UNIT_TYPE_RESISTANT) == false
    endfunction
//---------------------------------------------------------------------------------------------------
    /*
        敌人过滤器2,只要是敌人都算
    */
   function IsEnemy2 takes unit u, unit caster returns boolean
        return GetUnitState(u, UNIT_STATE_LIFE) > 0.405 and IsUnitAliveBJ(u) == true /*
        */and IsUnitEnemy(u, GetOwningPlayer(caster)) and GetUnitPointValue(u) != 123 /*
        */and GetUnitPointValue(u) != 0
    endfunction
//---------------------------------------------------------------------------------------------------
    /*
        干掉一个区域的所有单位
    */
    function KillAreaPlayerEnemy takes unit attacker,real x,real y,real radius,player p returns nothing
        local group l_group = CreateGroup()
        local unit l_unit
        call GroupEnumUnitsInRange(l_group, x, y, radius, null)
        loop
            set l_unit = FirstOfGroup(l_group)
            exitwhen l_unit == null
            call GroupRemoveUnit(l_group, l_unit)
            if (IsEnemyMP(l_unit,p)) then
                call UnitDamageTarget( attacker, l_unit, GetUnitState(l_unit,UNIT_STATE_MAX_LIFE)*2, false, true, ATTACK_TYPE_CHAOS, DAMAGE_TYPE_SLOW_POISON, WEAPON_TYPE_WHOKNOWS )
            endif
        endloop
        call DestroyGroup(l_group)
        set l_group = null
        set l_unit =null
    endfunction
//---------------------------------------------------------------------------------------------------
    /*
        忠诚单位过滤器
    */
    function IsLoyalUnit takes unit u returns boolean
        return ((GetUnitTypeId(u) == 'owyv') or (GetUnitTypeId(u) == 'nzom') or (GetUnitTypeId(u) == 'nsog') or (GetUnitTypeId(u) == 'nsoc') or (GetUnitTypeId(u) == 'ninc') or (GetUnitTypeId(u) == 'ninm') or (GetUnitTypeId(u) == 'nsrn') or (GetUnitTypeId(u) == 'nsrh') or (GetUnitTypeId(u) == 'nmit'))
    endfunction
//---------------------------------------------------------------------------------------------------
    /*
        与敌人过滤器2一致，但匹配的是玩家
    */
   function IsEnemy3 takes unit u, player p returns boolean
        return GetUnitState(u, UNIT_STATE_LIFE) > 0.405 and IsUnitAliveBJ(u) == true /*
        */and IsUnitEnemy(u, p) and GetUnitPointValue(u) != 123 /*
        */and GetUnitPointValue(u) != 0
    endfunction
//---------------------------------------------------------------------------------------------------
    /*
        删除单位组里面的所有单位并清空自定义数据
    */
    function DeleteGroup takes group g returns nothing
        local unit l_unit
        loop
            set l_unit = FirstOfGroup(g)
            exitwhen l_unit == null
            call GroupRemoveUnit(g, l_unit)
            call FlushChildHashtable(YDHT,GetHandleId(l_unit))
            call RemoveUnit( l_unit )
        endloop
        set l_unit = null
    endfunction
//---------------------------------------------------------------------------------------------------
    /*
        移动回基地
    */
    function HG takes unit u returns nothing
        call SetUnitPositionLoc(u,udg_Point_Fuhuo)
    endfunction
//---------------------------------------------------------------------------------------------------
    /*
        全部胜利
    */
    function ShengliAll takes nothing returns nothing
        call CustomVictoryBJ( GetEnumPlayer(), true, true )
    endfunction
//---------------------------------------------------------------------------------------------------
    /*
        4个坐标的角度,前面是人的位置，后面是点的位置
    */
    function GetFacingBetweenXY takes real x1,real y1,real x2,real y2 returns real
        return Atan2BJ(y2-y1,x2-x1)
    endfunction
//---------------------------------------------------------------------------------------------------
    /*
        4个坐标的距离
    */
    function GetUnitDistance takes unit u1,unit u2 returns real
        return GetDistance(GetUnitX(u1),GetUnitY(u1),GetUnitX(u2),GetUnitY(u2))
    endfunction
//---------------------------------------------------------------------------------------------------
    /*
        判断背刺,u1是判断的单位,u2是背后的单位
    */
    function IsUnitInUnitBack takes unit u1,unit u2,real angle returns boolean
        return CosBJ(GetUnitFacing(u1) - YDWEAngleBetweenUnits(u2, u1)) >= CosBJ(angle)
    endfunction
//---------------------------------------------------------------------------------------------------
    /*
        创建漂浮文字，漂浮然后消失
    */
    function CreateTextTagA takes string name,unit u,real red,real green,real blue,real time,real size returns nothing
        local texttag t = CreateTextTagUnitBJ( name, u, 0, size, red, green, blue, 0 )
        call SetTextTagVelocityBJ( t, 64, 90.00 )
        if time <= 0 then
            set time = 0.01
        endif
        call SetTextTagPermanent(t,false)
        call SetTextTagLifespan(t,time)
        call SetTextTagFadepoint(t,time)
    endfunction
    /*
        创建技能的漂浮文字，漂浮然后消失
    */
    function CreateSpellTextTag takes string name,unit u,real red,real green,real blue,real time returns nothing
        call CreateTextTagA(name,u,red,green,blue,time,16)
    endfunction
    /*
            召唤马甲然后施放技能
    */
    function SimulateSpell takes unit caster,unit target,integer spellId,integer spellLevel,real lifeTime ,string orderId,boolean isPoint,boolean isImmediate,boolean isTarget returns nothing
        local unit u = CreateUnit(GetOwningPlayer(caster),'h000',GetUnitX(target),GetUnitY(target),0)
        call UnitApplyTimedLifeBJ( 5.00, 'BHwe',u )
        call UnitAddAbilityBJ( spellId,u )
        call SetUnitAbilityLevel(u,spellId,spellLevel)
        if (isPoint) then
            call IssuePointOrder(u,orderId,GetUnitX(target),GetUnitY(target))
        elseif (isImmediate) then
            call IssueImmediateOrder( u, orderId )
        elseif (isTarget) then
            call IssueTargetOrder( u, orderId, target )
        endif
        set u = null
    endfunction
    /*
        技能4的马甲，点目标，限定使用
    */
    function SimulateSpell4 takes unit caster,real x,real y,integer spellId,integer spellLevel,real lifeTime,string orderId returns nothing
        local unit u = CreateUnit(GetOwningPlayer(caster),'h01B',x,y,0)
        call UnitApplyTimedLifeBJ( 5.00, 'BHwe',u )
        call UnitAddAbilityBJ( spellId,u )
        call SetUnitAbilityLevel(u,spellId,spellLevel)
        call IssuePointOrder(u,orderId,x,y)
        set u = null
    endfunction
    /*
        创建马甲作为特效(有无时间参数)
    */
    function CreateUnitEffectSpecifyTime takes player whichPlayer,integer unitType,real x,real y,real facing,real time returns nothing
        call UnitApplyTimedLifeBJ( time, 'BHwe',CreateUnit(whichPlayer,unitType,x,y,facing))
    endfunction
    function CreateUnitEffect takes player whichPlayer,integer unitType,real x,real y,real facing returns nothing
        call CreateUnitEffectSpecifyTime(whichPlayer,unitType,x,y,facing,5)
    endfunction
//---------------------------------------------------------------------------------------------------
    /*
        伤害一个区域，非转生单位无效
    */
    function DamageAreaMirror takes unit attacker,real x,real y,real radius,real damage returns nothing
        local group l_group = CreateGroup()
        local unit l_unit
        call GroupEnumUnitsInRange(l_group, x, y, radius, null)
        loop
            set l_unit = FirstOfGroup(l_group)
            exitwhen l_unit == null
            call GroupRemoveUnit(l_group, l_unit)
            if (IsEnemy(l_unit,attacker) and (udg_U_Zhuansheng_Dantiao[2] != l_unit or udg_U_Zhuansheng_Dantiao[1] == attacker) ) then
                call UnitDamageTarget( attacker, l_unit, damage, false, true, ATTACK_TYPE_MAGIC, DAMAGE_TYPE_MAGIC, WEAPON_TYPE_WHOKNOWS )
            endif
        endloop
        call DestroyGroup(l_group)
        set l_group = null
        set l_unit =null
    endfunction
//---------------------------------------------------------------------------------------------------
    /*
        伤害一个区域，附带特效(Mirror)
    */
    function DamageAreaEffMirror takes unit attacker,real x,real y,real radius,real damage,string eff returns nothing
        local group l_group = CreateGroup()
        local unit l_unit
        call GroupEnumUnitsInRange(l_group, x, y, radius, null)
        loop
            set l_unit = FirstOfGroup(l_group)
            exitwhen l_unit == null
            call GroupRemoveUnit(l_group, l_unit)
            if (IsEnemy(l_unit,attacker) and (udg_U_Zhuansheng_Dantiao[2] != l_unit or udg_U_Zhuansheng_Dantiao[1] == attacker)) then
                call UnitDamageTarget( attacker, l_unit, damage, false, true, ATTACK_TYPE_MAGIC, DAMAGE_TYPE_MAGIC, WEAPON_TYPE_WHOKNOWS )
                call DestroyEffect(AddSpecialEffect(eff, GetUnitX(l_unit), GetUnitY(l_unit) ))
            endif
        endloop
        call DestroyGroup(l_group)
        set l_group = null
        set l_unit =null
    endfunction
//---------------------------------------------------------------------------------------------------
    /*
        伤害一个区域，附带特效
    */
    function DamageAreaEff takes unit attacker,real x,real y,real radius,real damage,string eff returns nothing
        local group l_group = CreateGroup()
        local unit l_unit
        call GroupEnumUnitsInRange(l_group, x, y, radius, null)
        loop
            set l_unit = FirstOfGroup(l_group)
            exitwhen l_unit == null
            call GroupRemoveUnit(l_group, l_unit)
            if (IsEnemy(l_unit,attacker)) then
                call UnitDamageTarget( attacker, l_unit, damage, false, true, ATTACK_TYPE_MAGIC, DAMAGE_TYPE_MAGIC, WEAPON_TYPE_WHOKNOWS )
                call DestroyEffect(AddSpecialEffect(eff, GetUnitX(l_unit), GetUnitY(l_unit) ))
            endif
        endloop
        call DestroyGroup(l_group)
        set l_group = null
        set l_unit =null
    endfunction
//---------------------------------------------------------------------------------------------------
    /*
        添加3W
    */
    function AddHero3W takes unit u, integer value returns nothing
        local unit hero = udg_H[GetConvertedPlayerId(GetOwningPlayer(u))]
        if (hero == chenji) then
            call SetHeroStr(hero,GetHeroStr(hero,true) + value * 3 ,true)
        else
            call SetHeroInt(hero,GetHeroInt(hero,true) + value ,true)
            call SetHeroAgi(hero,GetHeroAgi(hero,true) + value ,true)
            call SetHeroStr(hero,GetHeroStr(hero,true) + value ,true)
        endif
        set hero = null
    endfunction
//---------------------------------------------------------------------------------------------------
    /*
        溢出属性的处理
    */
    function GetLimit takes integer i returns integer
        if (i < 0 or i > 2100000000) then
            return 2100000000
        else
            return i
        endif
    endfunction
//---------------------------------------------------------------------------------------------------
    /*
        弹对话框
    */
    function ShowGameHint takes player p,string content returns nothing
        local dialog d = DialogCreate()
        local string s = "
            " + content
        call DialogSetMessage( d, s )
        call DialogAddButton( d, "我知道了|cffff6800(Esc)|r",512)
        call DialogDisplay( p, d, true )
        set d = null
    endfunction
//---------------------------------------------------------------------------------------------------
    /*
        输出选英雄皮肤的提示
    */
    function ChooseSpinHero takes player p,unit u returns nothing
        call ShowGameHint(p,"
        这是英雄"+GetUnitName(u)+"的皮肤。"+S3(DEBUG_MODE,"
        双击中间的旗子查看挑战内容,
        完成对应挑战即可永久解锁该皮肤。","
        使用魔兽争霸官方对战平台(dz .163.com)进行游戏
        完成挑战即可获取该皮肤。"))
    endfunction
//---------------------------------------------------------------------------------------------------
    /*
        弹对话框(全体玩家)
    */
    function ShowGameHintAll takes string content returns nothing
        local integer i = 1
        local dialog d = DialogCreate()
        local string s = "
            " + content
        call DialogSetMessage( d, s )
        call DialogAddButton( d, "我知道了|cffff6800(Esc)|r",512)
        loop
            exitwhen i > 6
            call DialogDisplay( ConvertedPlayer(i), d, true )
            set i = i +1
        endloop
        set d = null
    endfunction
//---------------------------------------------------------------------------------------------------
    /*
        玩家轮流转
    */
    function GetNextPlayerID takes nothing returns integer
        local integer i = 1
        loop
            exitwhen i > 6
            set INextPlayerID = I3(INextPlayerID >= 6, 1, INextPlayerID + 1)
            if ((GetPlayerSlotState(ConvertedPlayer(INextPlayerID)) == PLAYER_SLOT_STATE_PLAYING) and (GetPlayerController(ConvertedPlayer(INextPlayerID)) == MAP_CONTROL_USER) and udg_H[INextPlayerID] != null) then
                exitwhen true
            endif
            set i = i +1
        endloop
        return INextPlayerID
    endfunction
//---------------------------------------------------------------------------------------------------
    /*
        购买者的判断，防止是假分身
    */
    function BuyerFilter takes unit buyer returns boolean
        return (GetUnitTypeId(buyer) != 'N018') and (GetUnitTypeId(buyer) != 'N01X') and (GetUnitTypeId(buyer) != 'N01Y')
    endfunction
//---------------------------------------------------------------------------------------------------
    /*
        判断是否有琉璃璞玉
    */
    function HasLiuli takes unit u returns boolean
        return (GetItemTypeId(YDWEGetItemOfTypeFromUnitBJNull(u, 'IXU1')) == 'IXU1')
    endfunction
//---------------------------------------------------------------------------------------------------
    /*
        回血,小数表示
    */
    function RecoverUnitHP takes unit u,real volume returns nothing
        call SetUnitLifeBJ(u,GetUnitState(u,UNIT_STATE_LIFE)+GetUnitState(u,UNIT_STATE_MAX_LIFE)*volume)
    endfunction
//---------------------------------------------------------------------------------------------------
    /*
        回魔,量表示
    */
    function RecoverUnitMP takes unit u,real volume returns nothing
        call SetUnitManaBJ(u,GetUnitState(u,UNIT_STATE_MANA)+volume)
    endfunction
//---------------------------------------------------------------------------------------------------
    /*
        自杀
    */
    function KillSelf takes unit u returns nothing
        call UnitDamageTarget( u, u, GetUnitState(u,UNIT_STATE_MAX_LIFE)*2, false, true, ATTACK_TYPE_CHAOS, DAMAGE_TYPE_POISON, WEAPON_TYPE_WHOKNOWS )
    endfunction
//---------------------------------------------------------------------------------------------------
    /*
        给英雄加技能,如果是星胧则加永久性
    */
    function UnitAddAbilityP takes unit u,integer i returns nothing
            call UnitAddAbility(u,i)
            if (u == xinglong) then
                call UnitMakeAbilityPermanent(u,true,i)
            endif
    endfunction
//---------------------------------------------------------------------------------------------------
    /*
        单位是否有空物品栏
    */
    function IsUnitHasSlot takes unit u returns boolean
        local integer i = 1
        loop
            exitwhen i > 6
            if ( UnitItemInSlotBJ(u,i) == null) then
                return true
            endif
            set i = i +1
        endloop
        return false
    endfunction
//---------------------------------------------------------------------------------------------------
    /*
        判断坐标是否在区域内
    */
    function IsInRect takes real x, real y,rect reg returns boolean
        return (GetRectMaxX(reg) >= x and GetRectMinX(reg) <= x and GetRectMaxY(reg) >= y and GetRectMinY(reg) <= y )
    endfunction
//---------------------------------------------------------------------------------------------------
    /*
        判断是否在闪烁禁区内
    */
    function IsInForbitRegion takes real x,real y,unit u returns boolean
        return (IsInRect(x,y,gg_rct_______a3) and (not(RectContainsUnit(gg_rct_______a3, u)))) or (IsInRect(x,y,gg_rct_Arena_forbit) and (not(RectContainsUnit(gg_rct_Arena_forbit, u))))
    endfunction
//---------------------------------------------------------------------------------------------------
    /*
        获取第一个玩家
    */
    function GetFirstPlayer takes nothing returns player
        local integer i = 1
        loop
            exitwhen i > 6
            if ((GetPlayerSlotState(ConvertedPlayer(i)) == PLAYER_SLOT_STATE_PLAYING) and (GetPlayerController(ConvertedPlayer(i)) == MAP_CONTROL_USER)) then
                return ConvertedPlayer(i)
            endif
            set i = i +1
        endloop
        return ConvertedPlayer(1)
    endfunction
//---------------------------------------------------------------------------------------------------
    /*
        基地爆炸
    */
    function Jidibaozha takes string s returns nothing
        local integer i = 1
        loop
            exitwhen i > 6
            call CustomDefeatBJ( ConvertedPlayer(i), s )
            set i = i +1
        endloop
    endfunction
//---------------------------------------------------------------------------------------------------
    /*
        开始定时刷万劫录
    */
    private function StartWanjieTimer takes nothing returns nothing
        local timer t = GetExpiredTimer()
        local integer id = GetHandleId(t)
        local integer value = LoadInteger(LHTable,id,1)
        local texttag tt = null
        local location point = null
        if (value <= 200) then
            call SaveInteger(LHTable,GetHandleId(t),1,value + 1)
            set point = Location(GetUnitX(Uwanjie) - 100, GetUnitY(Uwanjie) )
            set tt = CreateTextTagLocBJ( "|cffFFD700【万劫录】"+GetWanjieluName(), point, 50.00, 12, 100, 100, 100, 0 )
            call SetTextTagVelocityBJ( tt, 64, 90.00 )
            call SetTextTagPermanent(tt,false)
            call SetTextTagLifespan(tt,5)
            call SetTextTagFadepoint(tt,5)
            call RemoveLocation(point)
            set point = null
            set tt = null
        else
            call PauseTimer(t)
            call FlushChildHashtable(LHTable,id)
            call DestroyTimer(t)
        endif
        set t = null
    endfunction
//---------------------------------------------------------------------------------------------------
    private function InitLHBase takes nothing returns nothing
        local timer t = CreateTimer()
        local integer i = 1
        loop
            exitwhen i > 6
            if ((GetPlayerSlotState(ConvertedPlayer(i)) == PLAYER_SLOT_STATE_PLAYING) and (GetPlayerController(ConvertedPlayer(i)) == MAP_CONTROL_USER)) then
                set BMoshou[i] = false
            endif
            set i = i +1
        endloop
        /*
            仓库初始化
        */
        set UDepot[1] = CreateUnit(Player(0), 'nmgv', 10175.0, - 691.0, 270.000)
        set UDepot[2] = CreateUnit(Player(1), 'nmgv', 10307.0, - 691.0, 270.000)
        set UDepot[3] = CreateUnit(Player(2), 'nmgv', 10431.0, - 691.0, 270.000)
        set UDepot[4] = CreateUnit(Player(3), 'nmgv', 10175.0, - 60.6, 270.000)
        set UDepot[5] = CreateUnit(Player(4), 'nmgv', 10307.0, - 60.6, 270.000)
        set UDepot[6] = CreateUnit(Player(5), 'nmgv', 10431.0, - 60.6, 270.000)
        set Uwanjie = CreateUnit(Player(PLAYER_NEUTRAL_PASSIVE), 'n01F', - 14394.0, - 15446.0, 270.000)
        call SaveInteger(LHTable,GetHandleId(t),1,0)
        call TimerStart(t,2,true,function StartWanjieTimer)
        set t = null
    endfunction
endlibrary
/*
    网易平台的功能初始化
    debug模式是网易模式
*/
///#include  "edit/Huodong.j"
library_once ChallangerDZ requires LHBase
	globals
		constant integer COUNT_CHALLANGER = 7
		string array easyCString
		string array middleCString
		string array hardCString
		//挑战难度
		integer CDiff = 0
		//挑战类型
    	integer CType = 0
		//判断是否读取成功
		boolean array Bdudang
		string array Greward2
	endglobals
//---------------------------------------------------------------------------------------------------
	/*
	    获取仓库
	*/
	function GetAndSaveCangku takes player p,integer i returns nothing
		local integer index = GetConvertedPlayerId(p)
		local string temp = null
		//if (GetBit(Greward[index],i) < 1 and i < 9) then
		//	set Greward[index] = Greward[index] + R2I(Pow(10,i-1))
		//	call DisplayTextToPlayer(p, 0., 0., "//|cff3366ff【消息】恭喜你成功新的仓库模型！|r")
		//	call DisplayTextToPlayer(p, 0., 0., "//|cff3366ff【消息】恭喜你成功新的仓库模型！|r")
		//	call DisplayTextToPlayer(p, 0., 0., "//|cff3366ff【消息】恭喜你成功新的仓库模型！|r")
		//	call DzAPI_Map_StoreInteger( p,  "Greward", Greward[index] )
		//endif
		if (StringLength(Greward2[index]) < 62) then
			set Greward2[index] = "00000000000000000000000000000000000000000000000000000000000000"
		endif
		if (S2I(SubStringBJ(Greward2[index],i,i)) != 1) then
			set temp = Greward2[index]
			set Greward2[index] = SubStringBJ(temp,1,i - 1)
			set Greward2[index] = Greward2[index] + "1"
			set Greward2[index] = Greward2[index] + SubStringBJ(temp,i+1,StringLength(temp))
			set temp = null
			call DisplayTextToPlayer(p, 0., 0., "|cff3366ff【消息】恭喜你成功新的仓库模型！|r")
			call DisplayTextToPlayer(p, 0., 0., "|cff3366ff【消息】恭喜你成功新的仓库模型！|r")
			call DisplayTextToPlayer(p, 0., 0., "|cff3366ff【消息】恭喜你成功新的仓库模型！|r")
			debug call DzAPI_Map_StoreString( p, "Greward2", Greward2[index] )
		endif
	endfunction
	function IsHasCangku takes player p,integer i returns boolean
		return S2I(SubStringBJ(Greward2[GetConvertedPlayerId(p)],i,i)) == 1
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    获取仓库
	*/
	function Huoqucangku takes player p,string chat returns nothing
		local integer i = 1
		local integer result = 0
		loop
			exitwhen i > 10
			if (chat == I2S(GetCycleHash(playerName[GetConvertedPlayerId(p)]+"ck"+I2S(i),1))) then
				call GetAndSaveCangku(p,i)
				exitwhen true
			endif
			set i = i +1
		endloop
		set BBuqian2 = false
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    对应难度的对应数字
	*/
	private function C3 takes integer i1,integer i2,integer i3 returns integer
		if (CDiff == 1) then
			return i1
		elseif (CDiff == 2) then
			return i2
		elseif (CDiff == 3) then
			return i3
		else
			return 0
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    判断是否是力量透支挑战
	*/
	function CT1 takes nothing returns boolean
		return CType == 1
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    判断是否是纯装备挑战
	*/
	function CT2 takes nothing returns boolean
		return CType == 2
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    判断是否是tz1挑战
	*/
	function CT3 takes nothing returns boolean
		return CType == 3
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    判断是否是tz2挑战
	*/
	function CT4 takes nothing returns boolean
		return CType == 4
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    判断是否是镜像英雄挑战
	*/
	function CT5 takes nothing returns boolean
		return CType == 5
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    判断是否是随机英雄挑战
	*/
	function CT6 takes nothing returns boolean
		return CType == 6
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    判断是否是随机英雄挑战
	*/
	function CT7 takes nothing returns boolean
		return CType == 7
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    判断是否是随机英雄挑战
	*/
	function IsKuanghuan takes nothing returns boolean
		return CType == -1
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    获取某个玩家的完成挑战(某个难度)
	*/
	function GetEasyComplete takes player p returns integer
		local integer index = GetConvertedPlayerId(p)
		local integer i = 1
		local integer result = 0
		if (StringLength(easyCString[index]) < 62) then
			set easyCString[index] = "00000000000000000000000000000000000000000000000000000000000000"
		endif
		loop
			exitwhen i > COUNT_CHALLANGER
			if (S2I(SubStringBJ(easyCString[index],i,i)) > 0) then
				set result = result + 1
			endif
			set i = i +1
		endloop
		return result
	endfunction
	function GetMiddleComplete takes player p returns integer
		local integer index = GetConvertedPlayerId(p)
		local integer i = 1
		local integer result = 0
		if (StringLength(middleCString[index]) < 62) then
			set middleCString[index] = "00000000000000000000000000000000000000000000000000000000000000"
		endif
		loop
			exitwhen i > COUNT_CHALLANGER
			if (S2I(SubStringBJ(middleCString[index],i,i)) > 0) then
				set result = result + 1
			endif
			set i = i +1
		endloop
		return result
	endfunction
	function GetHardComplete takes player p returns integer
		local integer index = GetConvertedPlayerId(p)
		local integer i = 1
		local integer result = 0
		if (StringLength(hardCString[index]) < 62) then
			set hardCString[index] = "00000000000000000000000000000000000000000000000000000000000000"
		endif
		loop
			exitwhen i > COUNT_CHALLANGER
			if (S2I(SubStringBJ(hardCString[index],i,i)) > 0) then
				set result = result + 1
			endif
			set i = i +1
		endloop
		return result
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    获取一个玩家的总完成数
	*/
	function GetAllComplete takes player p returns integer
		return GetHardComplete(p) + GetEasyComplete(p) + GetMiddleComplete(p)
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
		获取一个玩家的完成率
	*/
	function GetCompleteRate takes player p returns real
		return I2R(GetAllComplete(p)) / (3.0*I2R(COUNT_CHALLANGER))
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    初始化数据与存档
	*/
	function InitChallangerData takes player p returns nothing
		if (Bdudang[GetConvertedPlayerId(p)]) then
	    	debug call DzAPI_Map_Stat_SetStat( p, "chal", I2S(GetAllComplete(p))+"/"+I2S(3*COUNT_CHALLANGER) )
			debug call DzAPI_Map_StoreString( p, "easyCString", easyCString[GetConvertedPlayerId(p)] )
			debug call DzAPI_Map_StoreString( p, "middleCString", middleCString[GetConvertedPlayerId(p)] )
			debug call DzAPI_Map_StoreString( p, "hardCString", hardCString[GetConvertedPlayerId(p)] )
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    某一个挑战完成后
	*/
	function ChallangerSuccess takes player p returns nothing
		local string temp = ""
		local integer index = GetConvertedPlayerId(p)
		if (CType == -1) then
			set temp = null
			return
		endif
		if (CDiff == 1) then
			set temp = easyCString[index]
			set easyCString[index] = SubStringBJ(temp,1,CType - 1)
			set easyCString[index] = easyCString[index] + "1"
			set easyCString[index] = easyCString[index] + SubStringBJ(temp,CType+1,StringLength(temp))
		elseif (CDiff == 2) then
			set temp = middleCString[index]
			set middleCString[index] = SubStringBJ(temp,1,CType - 1)
			set middleCString[index] = middleCString[index] + "1"
			set middleCString[index] = middleCString[index] + SubStringBJ(temp,CType+1,StringLength(temp))
		elseif (CDiff == 3) then
			set temp = hardCString[index]
			set hardCString[index] = SubStringBJ(temp,1,CType - 1)
			set hardCString[index] = hardCString[index] + "1"
			set hardCString[index] = hardCString[index] + SubStringBJ(temp,CType+1,StringLength(temp))
		endif
		call InitChallangerData(p)
		call DisplayTextToPlayer(p, 0., 0., "|cFFFF66CC【消息】|r你成功的完成了"+SgameMode+".")
		set temp = null
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    判断是否解锁
	*/
	function IsChallangerComplete takes player p, integer bit returns boolean
		local integer index = GetConvertedPlayerId(p)
		local string s = ""
		if (CDiff == 1) then
			return S2I(SubStringBJ(easyCString[index] ,bit,bit)) > 0
		elseif (CDiff == 2) then
			return S2I(SubStringBJ(middleCString[index] ,bit,bit)) > 0
		elseif (CDiff == 3) then
			return S2I(SubStringBJ(hardCString[index] ,bit,bit)) > 0
		endif
		return false
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    获取挑战的名字
	*/
	function GetChallangerTitle takes integer i returns string
		if (i == 1) then
			return "力量透支挑战"
		elseif (i == 2) then
			return "纯装备挑战"
		elseif (i == 3) then
			return "驻永恒挑战"
		elseif (i == 4) then
			return "创世篇挑战"
		elseif (i == 5) then
			return "镜像挑战"
		elseif (i == 6) then
			return "随机英雄挑战"
		elseif (i == 7) then
			return "金钟罩挑战"
		endif
		return ""
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    获取挑战的介绍
	*/
	function GetChallangerContent takes integer i returns string
		if (i == 1) then
			return "
			力量透支挑战内容如下:
			英雄初始等级为450级.
			但是英雄初始属性为负95%.
			该模式下禁止捕捉超过20级的宠物.
			简单最低通关要求:(天国)
			中等最低通关要求:(炼狱)
			困难最低通关要求:(轮回)
			|cff00ccff在该模式下不能获得成就及皮肤.|r
			"
		elseif (i == 2) then
			return "
			纯装备挑战如下:
			所有玩家英雄只有1个装备栏.
			英雄获取任何装备时,
			都增加该装备的6倍属性.
			简单最低通关要求:(天国)
			中等最低通关要求:(炼狱)
			困难最低通关要求:(轮回)
			|cff00ccff在该模式下不能获得成就及皮肤.|r
			"
		elseif (i == 3) then
			return "
			驻永恒挑战如下:
			该挑战下英雄攻击速度极慢,
			移动速度-10000000%.
			简单最低通关要求:(天国)
			中等最低通关要求:(炼狱)
			困难最低通关要求:(轮回)
			|cff00ccff在该模式下不能获得成就及皮肤.|r
			"
		elseif (i == 4) then
			return "
			创世篇挑战如下:
			该挑战下英雄获得金钱为1%,
			英雄每秒减少10%的生命.
			(13波开始每秒减少30%的生命)
			简单最低通关要求:(天国)
			中等最低通关要求:(炼狱)
			困难最低通关要求:(轮回)
			|cff00ccff在该模式下不能获得成就及皮肤.|r
			"
		elseif (i == 5) then
			return "
			镜像挑战如下:
			该挑战下进攻怪为英雄的转生镜像,
			与转生类似的属性,不拥有转生技能,
			拥有与英雄一样的物品,
			波数对应为转数,怪物数量会少3倍.
			(进攻怪的经验固定在100/个)
			简单最低通关要求:(天国)
			中等最低通关要求:(炼狱)
			困难最低通关要求:(轮回)
			难度越大每波怪对应的转数越大。
			|cff00ccff在该模式下不能获得成就及皮肤.|r
			"
		elseif (i == 6) then
			return "
			随机英雄挑战如下:
			只能选取随机英雄.
			但是可以额外获得5000金币.
			简单最低通关要求:(天国)
			中等最低通关要求:(炼狱)
			困难最低通关要求:(轮回)
			|cff00ccff在该模式下不能获得成就及皮肤.|r
			"
		elseif (i == 7) then
			return "
			金钟罩挑战如下:
			所有进攻怪与BOSS只会攻击基地,
			包括部分副本BOSS.
			但是你兑换防护罩时额外获得2个.
			简单最低通关要求:(天国)
			中等最低通关要求:(炼狱)
			困难最低通关要求:(轮回)
			|cff00ccff在该模式下不能获得成就及皮肤.|r
			"
		endif
		return ""
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    对应的难度返回
	*/
	function GetChallangerDifficulty takes nothing returns integer
		if (CType == 1) then
			return C3(1,5,8)
		elseif (CType == 2) then
			return C3(1,5,8)
		elseif (CType == 3) then
			return C3(1,5,8)
		elseif (CType == 4) then
			return C3(1,5,8)
		elseif (CType == 5) then
			return C3(1,5,8)
		elseif (CType == 6) then
			return C3(1,5,8)
		elseif (CType == 7) then
			return C3(1,5,8)
		endif
		return 0
	endfunction
endlibrary
library_once Attr initializer InitAttr requires LHBase
	globals
		integer array IStr
		integer array IAgi
		integer array IInt
	endglobals
//---------------------------------------------------------------------------------------------------
	/*
	    获取敏捷增益
	*/
	function GetAgiPercent takes integer playerID returns real
		return udg_I_Xianglian[( playerID + 6 )]
	endfunction
	/*
	    获取力量增益
	*/
	function GetStrPercent takes integer playerID returns real
		return udg_I_Xianglian[( playerID)]
	endfunction
	/*
	    获取智力增益
	*/
	function GetIntPercent takes integer playerID returns real
		return udg_I_Xianglian[( playerID + 12 )]
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    刷新英雄的力量值
	*/
	function FlashHeroStr takes player p returns nothing
		local integer index = GetConvertedPlayerId(p)
		local integer temp = 0
		if ((GetPlayerSlotState(p) == PLAYER_SLOT_STATE_PLAYING) and (GetPlayerController(p) == MAP_CONTROL_USER) and (GetStrPercent(index) != 0 or IStr[index] != 0)) then
			set temp = R2I(I2R(GetHeroStr(udg_H[index],true) - IStr[index]) * GetStrPercent(index))
			if (temp != IStr[index]) then
				call SetHeroStr(udg_H[index],GetHeroStr(udg_H[index],true)-IStr[index]+temp,true)
				set IStr[index] = temp
			endif
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    全刷力量
	*/
	function FlashAllHeroStr takes nothing returns nothing
		local integer i = 1
		loop
			exitwhen i > 6
			call FlashHeroStr(ConvertedPlayer(i))
			set i = i +1
		endloop
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    刷新英雄的敏捷值
	*/
	function FlashHeroAgi takes player p returns nothing
		local integer index = GetConvertedPlayerId(p)
		local integer temp = 0
		if ((GetPlayerSlotState(p) == PLAYER_SLOT_STATE_PLAYING) and (GetPlayerController(p) == MAP_CONTROL_USER) and (GetAgiPercent(index) != 0 or IAgi[index] != 0)) then
			set temp = R2I(I2R(GetHeroAgi(udg_H[index],true) - IAgi[index]) * GetAgiPercent(index))
			if (temp != IAgi[index]) then
				call SetHeroAgi(udg_H[index],GetHeroAgi(udg_H[index],true)-IAgi[index]+temp,true)
				set IAgi[index] = temp
			endif
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    全刷敏捷
	*/
	function FlashAllHeroAgi takes nothing returns nothing
		local integer i = 1
		loop
			exitwhen i > 6
			call FlashHeroAgi(ConvertedPlayer(i))
			set i = i +1
		endloop
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    刷新英雄的智力值
	*/
	function FlashHeroInt takes player p returns nothing
		local integer index = GetConvertedPlayerId(p)
		local integer temp = 0
		if ((GetPlayerSlotState(p) == PLAYER_SLOT_STATE_PLAYING) and (GetPlayerController(p) == MAP_CONTROL_USER) and (GetIntPercent(index) != 0 or IInt[index] != 0)) then
			set temp = R2I(I2R(GetHeroInt(udg_H[index],true) - IInt[index]) * GetIntPercent(index))
			if (temp != IInt[index]) then
				call SetHeroInt(udg_H[index],GetHeroInt(udg_H[index],true)-IInt[index]+temp,true)
				set IInt[index] = temp
			endif
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    全刷智力
	*/
	function FlashAllHeroInt takes nothing returns nothing
		local integer i = 1
		loop
			exitwhen i > 6
			call FlashHeroInt(ConvertedPlayer(i))
			set i = i +1
		endloop
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    对于扣除3W的话,如果负数容易出现问题,则用这种方法
	*/
	function ReduceHeroStrF takes unit hero,integer i returns nothing
		local integer delta
		local integer index
		if (GetHeroStr(hero,true) - i >= 0) then
			call SetHeroStr(hero,GetHeroStr(hero,true)-i,true)
			call FlashHeroStr(GetOwningPlayer(hero))
		else
			set index = GetConvertedPlayerId(GetOwningPlayer(hero))
			set delta = R2I(I2R(i) * GetStrPercent(index))
			set IStr[index] = IStr[index] - delta
			call SetHeroStr(hero,GetHeroStr(hero,true)-i-delta,true)
			call FlashHeroStr(GetOwningPlayer(hero))
		endif
	endfunction
	function ReduceHeroAgiF takes unit hero,integer i returns nothing
		local integer delta
		local integer index
		if (GetHeroAgi(hero,true) - i >= 0) then
			call SetHeroAgi(hero,GetHeroAgi(hero,true)-i,true)
			call FlashHeroAgi(GetOwningPlayer(hero))
		else
			set index = GetConvertedPlayerId(GetOwningPlayer(hero))
			set delta = R2I(I2R(i) * GetAgiPercent(index))
			set IAgi[index] = IAgi[index] - delta
			call SetHeroAgi(hero,GetHeroAgi(hero,true)-i-delta,true)
			call FlashHeroAgi(GetOwningPlayer(hero))
		endif
	endfunction
	function ReduceHeroIntF takes unit hero,integer i returns nothing
		local integer delta
		local integer index
		if (GetHeroInt(hero,true) - i >= 0) then
			call SetHeroInt(hero,GetHeroInt(hero,true)-i,true)
			call FlashHeroInt(GetOwningPlayer(hero))
		else
			set index = GetConvertedPlayerId(GetOwningPlayer(hero))
			set delta = R2I(I2R(i) * GetIntPercent(index))
			set IInt[index] = IInt[index] - delta
			call SetHeroInt(hero,GetHeroInt(hero,true)-i-delta,true)
			call FlashHeroInt(GetOwningPlayer(hero))
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    增加生命上限增益
	*/
	function AddHPPercent takes integer playerID , real value returns nothing
		set udg_I_Xianglian[( playerID + 18 )] = udg_I_Xianglian[( playerID + 18 )] + value
		call TriggerExecute( gg_trg_D7 )
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    敏捷增益
	*/
	function AddAgiPercent takes integer playerID , real value returns nothing
		set udg_I_Xianglian[( playerID + 6 )] = udg_I_Xianglian[( playerID + 6 )] + value
		call TriggerExecute( gg_trg_D7 )
	endfunction
	/*
	    增加敏捷增益，并立即刷新
	*/
	function AddAgiPercentImme takes integer playerID , real value returns nothing
		call AddAgiPercent(playerID,value)
    	call FlashHeroAgi(ConvertedPlayer(playerID))
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    力量增益
	*/
	function AddStrPercent takes integer playerID , real value returns nothing
		set udg_I_Xianglian[( playerID)] = udg_I_Xianglian[( playerID)] + value
		call TriggerExecute( gg_trg_D7 )
	endfunction
	/*
	    增加力量增益，并立即刷新
	*/
	function AddStrPercentImme takes integer playerID , real value returns nothing
		call AddStrPercent(playerID,value)
    	call FlashHeroStr(ConvertedPlayer(playerID))
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    智力增益
	*/
	function AddIntPercent takes integer playerID , real value returns nothing
		set udg_I_Xianglian[( playerID + 12 )] = udg_I_Xianglian[( playerID + 12 )] + value
		call TriggerExecute( gg_trg_D7 )
	endfunction
	/*
	    增加智力增益，并立即刷新
	*/
	function AddIntPercentImme takes integer playerID , real value returns nothing
		call AddIntPercent(playerID,value)
    	call FlashHeroInt(ConvertedPlayer(playerID))
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    金钱增益
	*/
	function AddMoneyPercent takes integer playerID , real value returns nothing
		set udg_I_Jinqianhuodelv[playerID] = udg_I_Jinqianhuodelv[playerID] + value
		call TriggerExecute( gg_trg_D7 )
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    攻击增益
	*/
	function AddAttackPercent takes integer playerID , real value returns nothing
		set udg_I_Xianglian[playerID + 24] = udg_I_Xianglian[playerID + 24] + value
		call TriggerExecute( gg_trg_D7 )
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    防御增益
	*/
	function AddDefensePercent takes integer playerID , real value returns nothing
		set udg_I_Xianglian[playerID + 30] = udg_I_Xianglian[playerID + 30] + value
		call TriggerExecute( gg_trg_D7 )
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    技能伤害增益
	*/
	function AddSpellPercent takes integer playerID , real value returns nothing
		set udg_I_Jinengjiacheng[playerID] = udg_I_Jinengjiacheng[playerID] + value
		call TriggerExecute( gg_trg_D7 )
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    造成伤害增益
	*/
	function AddDamagePercent takes integer playerID, real value returns nothing
		set udg_I_Shanghai[playerID] = udg_I_Shanghai[playerID] + value
		call TriggerExecute( gg_trg_D7 )
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    设置攻击
	*/
	function SetAttack takes unit u,integer attack returns nothing
	    set udg_Unit = u
	    call SaveInteger(YDHT,GetHandleId(u),0x5039AFFB,attack)
	    call TriggerExecute( gg_trg_____________800W )
	endfunction
	function GetAttack takes unit u returns integer
		return LoadInteger(YDHT,GetHandleId(u),0x5039AFFB)
	endfunction
	function AddAttack takes unit u,integer attack returns nothing
		call SetAttack(u,GetAttack(u) + attack)
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    设置防御
	*/
	function SetDefense takes unit u,integer defense returns nothing
	    set udg_Unit = u
	    call SaveInteger(YDHT,GetHandleId(u),0x81FD3994,defense)
	    call TriggerExecute( gg_trg___________________4000______u )
	endfunction
	function GetDefense takes unit u returns integer
		return LoadInteger(YDHT,GetHandleId(u),0x81FD3994)
	endfunction
	function AddDefense takes unit u,integer defense returns nothing
		call SetDefense(u,GetDefense(u) + defense)
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    设置生命上限
	*/
	function SetHP takes unit u,integer hp returns nothing
	    set udg_Unit = u
	    call SaveInteger(YDHT,GetHandleId(u),0xFCD961C9,hp)
    	call TriggerExecute( gg_trg_HP_____________________u )
	endfunction
	function GetHP takes unit u returns integer
		return LoadInteger(YDHT,GetHandleId(u),0xFCD961C9)
	endfunction
	function AddHP takes unit u,integer hp returns nothing
		call SetHP(u,GetHP(u) + hp)
	endfunction
//---------------------------------------------------------------------------------------------------
	private function InitAttr takes nothing returns nothing
	endfunction
endlibrary
/*
    转生
*/
library_once Mirror requires LHBase ,Attr
    globals
        timer TiMirror
        timerdialog TiDiaMirror
    endglobals
//---------------------------------------------------------------------------------------------------
    /*
        设置某个单位和另一个单位一样,镜像
    */
    function SetUnitMirror takes unit mirror,unit u1,integer times returns nothing
        local integer i = 1
        loop
            exitwhen i > 6
            call UnitAddItemByIdSwapped(GetItemTypeId(UnitItemInSlotBJ(u1,i)), mirror)
            set i = i +1
        endloop
        call SetHeroInt(mirror,GetLimit( GetHeroInt( u1, true) * times ),true)
        call SetHeroAgi(mirror,GetLimit( GetHeroAgi( u1, true) * times ),true)
        call SetHeroStr(mirror,GetLimit( GetHeroStr( u1, true) * times ),true)
        call SetAttack(mirror,GetAttack(u1)*times)
        call SetDefense(mirror,GetDefense(u1)*times)
        call SetHP(mirror,GetHP(u1)*times)
        if (u1 == kaisa) then
            call UnitRemoveAbility(mirror,'AOre')
        elseif (u1 == taiya) then
            call SetUnitAcquireRange( mirror, 600.00 )
        endif
    endfunction
//---------------------------------------------------------------------------------------------------
    /*
        显示进度
    */
    function ShowLiuliProcess takes nothing returns nothing
        if (udg_Z[GetConvertedPlayerId(GetOwningPlayer(udg_U_Zhuansheng_Dantiao[1]))] < 42) then
            call DisplayTextToPlayer(GetOwningPlayer(udg_U_Zhuansheng_Dantiao[1]), 0., 0., "|cffff00ff【虚】琉璃璞玉|r"+I2S(udg_Z[GetConvertedPlayerId(GetOwningPlayer(udg_U_Zhuansheng_Dantiao[1]))])+"/42.")
        endif
    endfunction
//---------------------------------------------------------------------------------------------------
    /*
        转生限制1分钟
    */
    private function MirrorTimeOut takes nothing returns nothing
        //移动单位回基地
        call DisplayTextToPlayer(GetOwningPlayer(udg_U_Zhuansheng_Dantiao[1]), 0., 0., "|cFFFF66CC【消息】|r你未能在限定时间内通过转生！")
        call SetUnitPositionLoc(udg_U_Zhuansheng_Dantiao[1],udg_Point_Fuhuo)
    endfunction
    function DestroyMirrorTimer takes nothing returns nothing
        call TimerDialogDisplay(TiDiaMirror,false)
        call DestroyTimerDialog(TiDiaMirror)
        call PauseTimer(TiMirror)
        call DestroyTimer(TiMirror)
        set TiMirror = null
        set TiDiaMirror = null
    endfunction
    function CreateMirrorTimer takes nothing returns nothing
        set TiMirror = CreateTimer()
        set TiDiaMirror = CreateTimerDialogBJ(TiMirror,"转生时间")
        call TimerStart(TiMirror,60,false,function MirrorTimeOut)
        call TimerDialogDisplay(TiDiaMirror,true)
    endfunction
//---------------------------------------------------------------------------------------------------
    /*
        根据难度给转生加上技能与提示
    */
    function AddMirrorSpell takes nothing returns nothing
        local unit mirror = udg_U_Zhuansheng_Dantiao[2]
        local unit defier = udg_U_Zhuansheng_Dantiao[1]
        local integer count = udg_Z[GetConvertedPlayerId(GetOwningPlayer(defier))]
        if (count == 20) then
            call DisplayTextToPlayer(GetOwningPlayer(defier), 0., 0., "|cFFFF66CC【消息】|r从"+I2S(count)+"转开始镜像将获得33%30倍攻击与破隐技能。")
        elseif (count == 40) then
            call DisplayTextToPlayer(GetOwningPlayer(defier), 0., 0., "|cFFFF66CC【消息】|r从"+I2S(count)+"转开始镜像将获得神圣护甲技能。")
        elseif (count == 60) then
            call DisplayTextToPlayer(GetOwningPlayer(defier), 0., 0., "|cFFFF66CC【消息】|r从"+I2S(count)+"转开始镜像将获得10%回血技能。")
        elseif (count == 80) then
            call DisplayTextToPlayer(GetOwningPlayer(defier), 0., 0., "|cFFFF66CC【消息】|r从"+I2S(count)+"转开始镜像将获得15秒重生技能。")
        elseif (count == 100) then
            call DisplayTextToPlayer(GetOwningPlayer(defier), 0., 0., "|cFFFF66CC【消息】|r从"+I2S(count)+"转开始镜像将获得秒杀献祭技能。")
        elseif (count == 120) then
            call DisplayTextToPlayer(GetOwningPlayer(defier), 0., 0., "|cFFFF66CC【消息】|r从"+I2S(count)+"转开始镜像将获得破防10万技能。")
        elseif (count == 150) then
            call DisplayTextToPlayer(GetOwningPlayer(defier), 0., 0., "|cFFFF66CC【消息】|r从"+I2S(count)+"转开始镜像将获得急速破魔技能。")
        elseif (count == 160) then
            call DisplayTextToPlayer(GetOwningPlayer(defier), 0., 0., "|cFFFF66CC【消息】|r从"+I2S(count)+"转开始镜像将获得减少50%魔法伤害技能。")
        elseif (count == 170) then
            call DisplayTextToPlayer(GetOwningPlayer(defier), 0., 0., "|cFFFF66CC【消息】|r从"+I2S(count)+"转开始镜像将出生于英雄周围。")
        elseif (count == 180) then
            call DisplayTextToPlayer(GetOwningPlayer(defier), 0., 0., "|cFFFF66CC【消息】|r从"+I2S(count)+"转开始镜像将更加厉害的破魔。")
        endif
        if (count >= 20) then
            call UnitAddAbility(mirror,'A0GL')
            call UnitAddAbility(mirror,'Adtg')
        endif
        if (count >= 40) then
            call UnitAddAbility(mirror,'A0F1')
        endif
        if (count >= 60) then
            call UnitAddAbility(mirror,'A0GM')
        endif
        if (count >= 80) then
            call UnitAddAbility(mirror,'A0GN')
        endif
        if (count >= 100) then
            call UnitAddAbility(mirror,'A0GO')
        endif
        if (count >= 120) then
            call UnitAddAbility(mirror,'A0GP')
        endif
        if (count >= 150) then
            call UnitAddAbility(mirror,'A0GQ')
        endif
        if (count >= 160) then
            call UnitAddAbility(mirror,'A052')
        endif
        if (count >= 170) then
            call SetUnitX(mirror,GetUnitX(defier))
            call SetUnitY(mirror,GetUnitY(defier))
        endif
        if (count >= 180) then
            call SetUnitAbilityLevel(mirror,'A0GQ',2)
        endif
    endfunction
endlibrary
library_once ChallangerMode requires LHBase,ChallangerDZ,Huodong,Mirror
	globals
		integer EquipLoopingTime = 1
		group GJingxiang = null
	endglobals
//---------------------------------------------------------------------------------------------------
    /*
        输出选英雄皮肤的提示
    */
    function ShowChallangerDialog takes player p returns nothing
    	if (CType != 0) then
        	call ShowGameHint(p,GetChallangerContent(CType))
    	endif
    endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    开始挑战3
	*/
	function StartTiaozhan1 takes nothing returns nothing
		local integer i = 1
    	local unit u = CreateUnit(Player(10),'h025',0,0,0)
		loop
			exitwhen i > 6
			if (udg_H[i] != null) then
				call UnitRemoveAbility(udg_H[i],'A0B9')
			endif
			set i = i +1
		endloop
    	call ShowUnitHide(u)
		call BJDebugMsg("|cFFFF66CC【消息】|r你们开启了成就挑战1,所有英雄失去攻击速度与100000%的移动速度.")
		set u = null
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    初始化乱斗
	*/
	function InitKuanghuan takes nothing returns nothing
		set CType = -1
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    开始挑战4
	*/
	private function Tiaozhan2Timer takes nothing returns nothing
		local integer i = 1
		if (udg_Bo >= 13) then
			loop
				exitwhen i > 6
				if (udg_H[i] != null) then
    				call RecoverUnitHP(udg_H[i],-0.3)
				endif
				set i = i +1
			endloop
		else
			loop
				exitwhen i > 6
				if (udg_H[i] != null) then
    				call RecoverUnitHP(udg_H[i],-0.1)
				endif
				set i = i +1
			endloop
		endif
	endfunction
	function StartTiaozhan2 takes nothing returns nothing
		call TimerStart(CreateTimer(),1,true,function Tiaozhan2Timer)
		call BJDebugMsg("|cFFFF66CC【消息】|r你们开启了成就挑战2,所有英雄获得金钱为1%,英雄每秒减少10%的生命.(13波开始每秒减少30%的生命)")
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    挑战初始化
	*/
	function InitChallanger takes nothing returns nothing
		if (CT2()) then
			set EquipLoopingTime = 6
		elseif (CT3()) then
			call StartTiaozhan1()
		elseif (CT4()) then
			call StartTiaozhan2()
		elseif (CT5()) then
			set GJingxiang = CreateGroup()
		elseif (CT7()) then
	    	call SetPlayerTechResearchedSwap( 'R01L', 1 , Player(10))
	    	call SetPlayerTechResearchedSwap( 'R01L', 1 , Player(11))
			set udg_I_Er_diansi[1] = udg_I_Er_diansi[1] + 5
		endif
		if (CType != 0) then
			set SgameMode = S3(CDiff == 1,"简单",S3(CDiff == 2,"中等","困难")) + GetChallangerTitle(CType)
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    第二个挑战英雄初始化
	*/
	function InitChallanger2Hero takes unit u returns nothing
		local integer i = 2
		local item it = null
		if not(CT2()) then
			return
		endif
		loop
			exitwhen i > 6
			if (UnitItemInSlotBJ(u,i) != null) then
    			call UnitRemoveItemSwapped( UnitItemInSlotBJ(u,i), u )
			endif
			call UnitAddItemByIdSwapped('I079', u)
			set i = i +1
		endloop
		if (u == cangling) then
			set i = 8
			loop
				exitwhen i > 12
				set IBibo[i] = CreateItem('I079',0,0)
				call SetItemVisible(IBibo[i],false)
				set i = i +1
			endloop
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    第一个挑战英雄初始化
	*/
	function InitChallanger1Hero takes unit u returns nothing
		local integer int = 0
		local integer agi = 0
		local integer str = 0
		if not(CT1()) then
			return
		endif
		set int = GetHeroInt(u,true)
		set agi = GetHeroAgi(u,true)
		set str = GetHeroStr(u,true)
	    call SetHeroLevelBJ( u, 450, false )
	    call SetHeroInt(u,int,true)
	    call SetHeroAgi(u,agi,true)
	    call SetHeroStr(u,str,true)
	    call AddAgiPercentImme(GetConvertedPlayerId(GetOwningPlayer(u)),-0.95)
	    call AddStrPercentImme(GetConvertedPlayerId(GetOwningPlayer(u)),-0.95)
	    call AddIntPercentImme(GetConvertedPlayerId(GetOwningPlayer(u)),-0.95)
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    游戏难度的选取
	*/
	function ChooseDifficulty takes integer i returns nothing
		call DialogSetMessage( udg_X_Nandu, "选择难度" )
	    if (i < 2) then
		    call DialogAddButtonBJ( udg_X_Nandu, "天国（24波）")
		    set udg_X_Nandu_Chuangkou[1] = GetLastCreatedButtonBJ()
	    endif
	    if (i < 3) then
		    call DialogAddButtonBJ( udg_X_Nandu, "太平（24波）")
		    set udg_X_Nandu_Chuangkou[2] = GetLastCreatedButtonBJ()
	    endif
	    if (i < 4) then
		    call DialogAddButtonBJ( udg_X_Nandu, "和谐（24+5波）")
		    set udg_X_Nandu_Chuangkou[3] = GetLastCreatedButtonBJ()
	    endif
	    if (i < 5) then
		    call DialogAddButtonBJ( udg_X_Nandu, "战争（24+5波）" )
		    set udg_X_Nandu_Chuangkou[4] = GetLastCreatedButtonBJ()
		endif
	    if (i < 6) then
		    call DialogAddButtonBJ( udg_X_Nandu, "炼狱（24+5+2波）" )
		    set udg_X_Nandu_Chuangkou[5] = GetLastCreatedButtonBJ()
		endif
	    if (i < 7) then
		    call DialogAddButtonBJ( udg_X_Nandu, "地狱（24+5+2波）" )
		    set udg_X_Nandu_Chuangkou[6] = GetLastCreatedButtonBJ()
		endif
	    if (i < 8) then
		    call DialogAddButtonBJ( udg_X_Nandu, "|cFFFF0000末日|r（24+5+2波）" )
		    set udg_X_Nandu_Chuangkou[7] = GetLastCreatedButtonBJ()
		endif
	    if (i < 9) then
		    call DialogAddButtonBJ( udg_X_Nandu, "|cffff00ff轮回|r（24+5+2波）" )
		    set udg_X_Nandu_Chuangkou[8] = GetLastCreatedButtonBJ()
		endif
	    if (i < 10) then
		    call DialogAddButtonBJ( udg_X_Nandu, "|cff008000万劫|r（24+5+2波）" )
		    set udg_X_Nandu_Chuangkou[9] = GetLastCreatedButtonBJ()
		endif
	    if (IsTianyanOK()) then
		    call DialogAddButtonBJ( udg_X_Nandu, "|cff993366天魇|r（24+5+2波）" )
		    set udg_X_Nandu_Chuangkou[10] = GetLastCreatedButtonBJ()
	    endif
	    call DialogDisplay( GetFirstPlayer(), udg_X_Nandu, true )
	    if (CType != 0 and CType != -1) then
	    	call InitChallanger()
	    endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    选择速度后
	*/
	private function ChooseSpeedClick takes nothing returns nothing
	    local dialog d = GetClickedDialogBJ()
        if (GetClickedButtonBJ() == LoadButtonHandle(LHTable,GetHandleId(d),1)) then
        	call BJDebugMsg("|cFFFF66CC【消息】|r当前游戏速度为经典(常速).")
			set mode = 1
			set SgameMode = SgameMode + "C"
    	endif
        if (GetClickedButtonBJ() == LoadButtonHandle(LHTable,GetHandleId(d),2)) then
        	call BJDebugMsg("|cFFFF66CC【消息】|r当前游戏速度为加速(进阶).")
			set mode = 2
			set SgameMode = SgameMode + "S"
    	endif
    	call ChooseDifficulty(GetChallangerDifficulty())
        call FlushChildHashtable(LHTable,GetHandleId(d))
    	call DialogDisplay( Player(0), d, false )
        call DialogClear(d)
        call DialogDestroy(d)
        set d = null
        call DestroyTrigger(GetTriggeringTrigger())
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    选择加速与否
	*/
	private function CreateCDialog4 takes nothing returns nothing
	    local trigger t = CreateTrigger()
	    local dialog d = DialogCreate()
    	call DialogSetMessage( d, "经典(常速)还是加速?" )
	    call SaveButtonHandle(LHTable,GetHandleId(d),1,DialogAddButtonBJ( d, "经典(推荐)"))
    	call SaveButtonHandle(LHTable,GetHandleId(d),2,DialogAddButton( d, "加速(进阶)",512))
	    call DialogDisplay( GetFirstPlayer(), d, true )
	    call TriggerRegisterDialogEvent( t, d )
	    call TriggerAddAction(t, function ChooseSpeedClick)
	    set d = null
	    set t = null
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    确认之后
	*/
	private function ChooseComfirmClick takes nothing returns nothing
	    local dialog d = GetClickedDialogBJ()
        if (GetClickedButtonBJ() == LoadButtonHandle(LHTable,GetHandleId(d),1)) then
        	call CreateCDialog4()
        	call BJDebugMsg("|cFFFF66CC【消息】|r已确认挑战内容,正在选择加速与难度.")
    	endif
        if (GetClickedButtonBJ() == LoadButtonHandle(LHTable,GetHandleId(d),2)) then
    		call CreateCDialog2.execute()
        	call BJDebugMsg("|cFFFF66CC【消息】|r正在切换挑战类型.")
    	endif
        call FlushChildHashtable(LHTable,GetHandleId(d))
    	call DialogDisplay( Player(0), d, false )
        call DialogClear(d)
        call DialogDestroy(d)
        set d = null
        call DestroyTrigger(GetTriggeringTrigger())
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    创建挑战标题对话框
	*/
	private function CreateCDialog3 takes integer i returns nothing
	    local trigger t = CreateTrigger()
	    local dialog d = DialogCreate()
    	call DialogSetMessage( d, GetChallangerContent(i) )
    	//设置类型
    	set CType = i
	    call SaveButtonHandle(LHTable,GetHandleId(d),1,DialogAddButtonBJ( d, "确认选择"))
    	call SaveButtonHandle(LHTable,GetHandleId(d),2,DialogAddButton( d, "返回|cffff6800(Esc)|r",512))
	    call DialogDisplay( GetFirstPlayer(), d, true )
	    call TriggerRegisterDialogEvent( t, d )
	    call TriggerAddAction(t, function ChooseComfirmClick)
	    set d = null
	    set t = null
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    选择内容之后
	*/
	private function ChooseChallangerClick takes nothing returns nothing
	    local dialog d = GetClickedDialogBJ()
	    local integer i = 1
	    loop
	    	exitwhen i > 9
	        if (GetClickedButtonBJ() == LoadButtonHandle(LHTable,GetHandleId(d),i)) then
        		call CreateCDialog3(i)
        		call BJDebugMsg("|cFFFF66CC【消息】|r当前挑战为"+GetChallangerTitle(i)+".")
	    	endif
	    	set i = i +1
	    endloop
        if (GetClickedButtonBJ() == LoadButtonHandle(LHTable,GetHandleId(d),10)) then
    		call CreateCDialog1.execute()
    		call BJDebugMsg("|cFFFF66CC【消息】|r正在切换挑战难度.")
    	endif
        call FlushChildHashtable(LHTable,GetHandleId(d))
    	call DialogDisplay( Player(0), d, false )
        call DialogClear(d)
        call DialogDestroy(d)
        set d = null
        call DestroyTrigger(GetTriggeringTrigger())
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    创建挑战标题对话框
	*/
	function CreateCDialog2 takes nothing returns nothing
	    local trigger t = CreateTrigger()
	    local dialog d = DialogCreate()
	    local integer i = 1
	    if (CDiff == 1) then
	    	call DialogSetMessage( d, "选择挑战类别(简单)" )
	    elseif (CDiff == 2) then
	    	call DialogSetMessage( d, "选择挑战类别(中等)" )
	    elseif (CDiff == 3) then
	    	call DialogSetMessage( d, "选择挑战类别(困难)" )
	    endif
	    call SaveButtonHandle(LHTable,GetHandleId(d),7,DialogAddButtonBJ( d, GetChallangerTitle(7) + S3(IsChallangerComplete(GetFirstPlayer(),7),"|cffff9900(已完成)|r","|cff33cccc(未完成)|r")))
	    loop
	    	exitwhen i > 6
		    call SaveButtonHandle(LHTable,GetHandleId(d),i,DialogAddButtonBJ( d, GetChallangerTitle(i) + S3(IsChallangerComplete(GetFirstPlayer(),i),"|cffff9900(已完成)|r","|cff33cccc(未完成)|r")))
	    	set i = i +1
	    endloop
    	call SaveButtonHandle(LHTable,GetHandleId(d),10,DialogAddButton( d, "返回|cffff6800(Esc)|r",512))
	    call DialogDisplay( GetFirstPlayer(), d, true )
	    call TriggerRegisterDialogEvent( t, d )
	    call TriggerAddAction(t,function ChooseChallangerClick)
	    set d = null
	    set t = null
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    选择难度之后
	*/
	private function ChooseDifficultyClick takes nothing returns nothing
	    local dialog d = GetClickedDialogBJ()
        if (GetClickedButtonBJ() == LoadButtonHandle(LHTable,GetHandleId(d),1)) then
        	set CDiff = 1
        	call CreateCDialog2()
        	call BJDebugMsg("|cFFFF66CC【消息】|r当前的挑战模式难度为简单.")
		elseif (GetClickedButtonBJ() == LoadButtonHandle(LHTable,GetHandleId(d),2)) then
        	set CDiff = 2
        	call CreateCDialog2()
        	call BJDebugMsg("|cFFFF66CC【消息】|r当前的挑战模式难度为中等.")
		elseif (GetClickedButtonBJ() == LoadButtonHandle(LHTable,GetHandleId(d),3)) then
        	set CDiff = 3
        	call CreateCDialog2()
        	call BJDebugMsg("|cFFFF66CC【消息】|r当前的挑战模式难度为困难.")
		endif
        call FlushChildHashtable(LHTable,GetHandleId(d))
    	call DialogDisplay( Player(0), d, false )
        call DialogClear(d)
        call DialogDestroy(d)
        set d = null
        call DestroyTrigger(GetTriggeringTrigger())
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    创建难度对话框
	*/
	function CreateCDialog1 takes nothing returns nothing
	    local trigger t = CreateTrigger()
	    local dialog d = DialogCreate()
	    call DialogSetMessage( d, "选择挑战难度" )
	    if (DEBUG_MODE) then
		    call SaveButtonHandle(LHTable,GetHandleId(d),1,DialogAddButtonBJ( d, "简单(" + I2S(GetEasyComplete(GetFirstPlayer())) +"/"+I2S(COUNT_CHALLANGER)+")"))
		    call SaveButtonHandle(LHTable,GetHandleId(d),2,DialogAddButtonBJ( d, "中等(" + I2S(GetMiddleComplete(GetFirstPlayer())) +"/"+I2S(COUNT_CHALLANGER)+")"))
		    call SaveButtonHandle(LHTable,GetHandleId(d),3,DialogAddButtonBJ( d, "困难(" + I2S(GetHardComplete(GetFirstPlayer())) +"/"+I2S(COUNT_CHALLANGER)+")"))
		else
			call SaveButtonHandle(LHTable,GetHandleId(d),1,DialogAddButtonBJ( d, "简单"))
		    call SaveButtonHandle(LHTable,GetHandleId(d),2,DialogAddButtonBJ( d, "中等"))
		    call SaveButtonHandle(LHTable,GetHandleId(d),3,DialogAddButtonBJ( d, "困难"))
	    endif
	    call DialogDisplay( GetFirstPlayer(), d, true )
	    call TriggerRegisterDialogEvent( t, d )
	    call TriggerAddAction(t, function ChooseDifficultyClick)
	    set d = null
	    set t = null
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    显示挑战对话框
	*/
	function ShowTiaozhanDialog takes nothing returns nothing
		call CreateCDialog1()
	endfunction
endlibrary
library_once SpellBase requires LHBase
	globals
		key kUImmuteDamage
	endglobals
//---------------------------------------------------------------------------------------------------
	/*
	    使单位免疫某次伤害。
	*/
	private function ImmuteDamageTimer takes nothing returns nothing
		local timer t = GetExpiredTimer()
		local integer id = GetHandleId(t)
		local unit u = LoadUnitHandle(spellTable,id,kUImmuteDamage)
		call PauseTimer(t)
		call DestroyTimer(t)
		call FlushChildHashtable(spellTable,id)
		call UnitRemoveAbility(u,'Avul')
		set u = null
		set t = null
	endfunction
	function ImmuteDamageInterval takes unit u,real time returns nothing
		local timer t = CreateTimer()
		call UnitAddAbility(u,'Avul')
		call SaveUnitHandle(spellTable,GetHandleId(t),kUImmuteDamage,u)
		call TimerStart(t,time,false,function ImmuteDamageTimer)
		set t = null
	endfunction
	function ImmuteDamage takes unit u returns nothing
		call ImmuteDamageInterval(u,0)
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    只打基地
	*/
	struct OnlyAttackBase
		private unit u
		private timer t
		static method flashAttack takes nothing returns nothing
			local thistype this = thistype[GetExpiredTimer()]
			if (IsUnitAliveBJ(.u) or GetUnitAbilityLevel(.u,'A0KH') > 0) then
				call IssueTargetOrder(.u,"attack",gg_unit_haro_0030)
			else
				call .destroy()
			endif
		endmethod
        static method operator [] takes handle h returns thistype
            return YDWEGetIntegerByString("SpellBase", I2S(YDWEH2I(h)))
        endmethod
        static method operator []= takes handle h, thistype value returns nothing
            call YDWESaveIntegerByString("SpellBase", I2S(YDWEH2I(h)), value)
        endmethod
        static method flush takes handle h returns nothing
            call YDWEFlushStoredIntegerByString("SpellBase", I2S(YDWEH2I(h)))
        endmethod
		static method create takes unit u returns thistype
		   	local thistype this = thistype.allocate()
		   	set .u = u
			set .t = CreateTimer()
			set thistype[.t] = integer(this)
			call TimerStart(.t,3,true,function thistype.flashAttack)
			call IssueTargetOrder(u,"attack",gg_unit_haro_0030)
			return this
		endmethod
		method onDestroy takes nothing returns nothing
			call thistype.flush(.t)
			set .u = null
			call PauseTimer(.t)
			call DestroyTimer(.t)
			set .t = null
		endmethod
	endstruct
//---------------------------------------------------------------------------------------------------
	/*
	    然后这是连结2个人
	*/
	struct Connect
		private boolean BDie
		private unit unit1
		private unit unit2
		private lightning l
		private timer t
		static method connect takes nothing returns nothing
			local thistype this = thistype[GetExpiredTimer()]
			if (.BDie) then
				if (not(IsUnitAliveBJ(unit1)) or not(IsUnitAliveBJ(unit2)) ) then
					call DestroyLightningBJ(.l)
					set .l = null
				else
					if (l != null) then
						call MoveLightning( .l ,true, GetUnitX(.unit1),GetUnitY(.unit1),GetUnitX(.unit2),GetUnitY(.unit2) )
					endif
				endif
			else
				call MoveLightning( .l ,true, GetUnitX(.unit1),GetUnitY(.unit1),GetUnitX(.unit2),GetUnitY(.unit2) )
			endif
		endmethod
        static method operator [] takes handle h returns thistype
            return YDWEGetIntegerByString("SpellBase", I2S(YDWEH2I(h)))
        endmethod
        static method operator []= takes handle h, thistype value returns nothing
            call YDWESaveIntegerByString("SpellBase", I2S(YDWEH2I(h)), value)
        endmethod
        static method flush takes handle h returns nothing
            call YDWEFlushStoredIntegerByString("SpellBase", I2S(YDWEH2I(h)))
        endmethod
		static method create takes unit unit1,unit unit2,string lightningType returns thistype
		   	local thistype this = thistype.allocate()
		   	set .unit1 = unit1
		   	set .unit2 = unit2
		   	set .BDie = false
			set .l = AddLightning( lightningType, true , GetUnitX(unit1),GetUnitY(unit1),GetUnitX(unit2),GetUnitY(unit2))
			set .t = CreateTimer()
			set thistype[.t] = integer(this)
			call TimerStart(.t,0.05,true,function thistype.connect)
			return this
		endmethod
		method setDieVanish takes nothing returns nothing
			set .BDie = true
		endmethod
		method onDestroy takes nothing returns nothing
			call thistype.flush(.t)
			set .unit1 = null
			set .unit2 = null
			call DestroyLightningBJ(.l)
			set .l = null
			call PauseTimer(.t)
			call DestroyTimer(.t)
			set .t = null
		endmethod
	endstruct
//---------------------------------------------------------------------------------------------------
	struct Attract
		private unit caster
		private real radius
		private real interval
		private real speed
		private timer t
		private boolean forbitHero
		private boolean deathContinue
		static method attract takes nothing returns nothing
			local real x1
			local real y1
			local real x2
			local real y2
			local real facing
			local real distance
			local thistype this = thistype[GetExpiredTimer()]
			local group l_group = CreateGroup()
			local unit l_unit
			if(IsUnitAliveBJ(.caster))then
				call GroupEnumUnitsInRange(l_group, GetUnitX(.caster), GetUnitY(.caster), .radius, null)
				loop
				    set l_unit = FirstOfGroup(l_group)
				    exitwhen l_unit == null
				    call GroupRemoveUnit(l_group, l_unit)
				    if(IsEnemyM(l_unit,.caster) and (GetUnitMoveSpeed(l_unit) > 0) and (not(.forbitHero and IsUnitType(l_unit,UNIT_TYPE_HERO))) and GetUnitAbilityLevel(l_unit,'A0IH') < 1)then
				    	set x2 = GetUnitX(l_unit)
				    	set y2 = GetUnitY(l_unit)
				    	set x1 = GetUnitX(.caster)
				    	set y1 = GetUnitY(.caster)
				    	set distance = SquareRoot((x1-x2)*(x1-x2)+(y1-y2)*(y1-y2))
				    	if( distance > 80)then
				    	set facing = Atan2BJ(y1-y2,x1-x2)
				    	call SetUnitX(l_unit,YDWECoordinateX(x2+CosBJ(facing)*.speed))
				    	call SetUnitY(l_unit,YDWECoordinateY(y2+SinBJ(facing)*.speed))
				    	endif
				    endif
				endloop
				call DestroyGroup(l_group)
			else
				if not(.deathContinue) then
					call .destroy()
				endif
			endif
			set l_group = null
			set l_unit =null
		endmethod
        static method operator [] takes handle h returns thistype
            return YDWEGetIntegerByString("SPellBase", I2S(YDWEH2I(h)))
        endmethod
        static method operator []= takes handle h, thistype value returns nothing
            call YDWESaveIntegerByString("SPellBase", I2S(YDWEH2I(h)), value)
        endmethod
        static method flush takes handle h returns nothing
            call YDWEFlushStoredIntegerByString("SPellBase", I2S(YDWEH2I(h)))
        endmethod
		static method create takes unit caster,real radius,real interval,real speed returns thistype
		   	local thistype this = thistype.allocate()
		   	local timer t
			set .caster = caster
			set .radius = radius
			set .interval = interval
			set .speed = speed
			set .forbitHero = false
			set .deathContinue = false
			return this
		endmethod
		method SetForbitHero takes nothing returns nothing
			set .forbitHero = true
		endmethod
		method SetDeathContinue takes nothing returns nothing
			set .deathContinue = true
		endmethod
		method setSpeed takes real speed returns nothing
			set .speed = speed
		endmethod
		method start takes nothing returns nothing
			set .t = CreateTimer()
			set thistype[.t] = integer(this)
			call TimerStart(.t,.interval,true,function thistype.attract)
		endmethod
		method onDestroy takes nothing returns nothing
			call thistype.flush(.t)
			set .caster = null
			call PauseTimer(.t)
			call DestroyTimer(.t)
			set .t = null
		endmethod
	endstruct
//---------------------------------------------------------------------------------------------------
	struct Missile
		private unit caster
		private string effx
		private real radius
		private real interval1
		private real interval2
		private real damage
		private real x
		private real y
		private timer t
		static method explode takes nothing returns nothing
			local thistype this = thistype[GetExpiredTimer()]
			local group l_group = CreateGroup()
			local unit l_unit
			call GroupEnumUnitsInRange(l_group, .x, .y, .radius, null)
			loop
			    set l_unit = FirstOfGroup(l_group)
			    exitwhen l_unit == null
			    call GroupRemoveUnit(l_group, l_unit)
			    if(IsEnemyM(l_unit,.caster) == true) then
			    	call UnitDamageTarget( .caster, l_unit, .damage, false, true, ATTACK_TYPE_CHAOS, DAMAGE_TYPE_SLOW_POISON, WEAPON_TYPE_WHOKNOWS )
			    endif
			endloop
			call DestroyGroup(l_group)
			set l_group = null
			set l_unit =null
			call .destroy()
		endmethod
		static method launch takes nothing returns nothing
			local thistype this = thistype[GetExpiredTimer()]
			call DestroyEffect(AddSpecialEffect(.effx, .x, .y ))
			call PauseTimer(.t)
			call TimerStart(.t,.interval2,false,function thistype.explode)
		endmethod
        static method operator [] takes handle h returns thistype
            return YDWEGetIntegerByString("SPellBase", I2S(YDWEH2I(h)))
        endmethod
        static method operator []= takes handle h, thistype value returns nothing
            call YDWESaveIntegerByString("SPellBase", I2S(YDWEH2I(h)), value)
        endmethod
        static method flush takes handle h returns nothing
            call YDWEFlushStoredIntegerByString("SPellBase", I2S(YDWEH2I(h)))
        endmethod
		static method createXY takes unit caster,integer preview,string effx,real radius,real x,real y,real interval1,real interval2,real damage returns thistype
		   	local thistype this = thistype.allocate()
		   	set .x = x
		   	set .y = y
			set .caster = caster
			set .effx = effx
			set .radius = radius
			set .interval1 = interval1
			set .interval2 = interval2
			set .damage = damage
			set .t = CreateTimer()
			set thistype[.t] = integer(this)
			call UnitApplyTimedLifeBJ( interval1+interval2, 'BHwe',CreateUnit(GetOwningPlayer(.caster),preview,.x,.y,0) )
			call TimerStart(.t,.interval1,false,function thistype.launch)
			return this
		endmethod
		static method create takes unit caster,integer preview,string effx,real radius,real range,real interval1,real interval2,real damage returns thistype
		   	local real Rangel = GetRandomReal(-180,180)
		   	local real Rradius= GetRandomReal(0,range)
			return createXY(caster,preview,effx,radius,GetUnitX(caster) + Rradius * CosBJ(Rangel),GetUnitY(caster) + Rradius * SinBJ(Rangel),interval1,interval2,damage)
		endmethod
		method onDestroy takes nothing returns nothing
			call thistype.flush(.t)
			set .caster = null
			call PauseTimer(.t)
			call DestroyTimer(.t)
			set .t = null
		endmethod
	endstruct
//---------------------------------------------------------------------------------------------------
	/*
	    回答问题
	*/
    function interface AfterSucceed takes nothing returns nothing
	struct Questions
		private player p
		private integer time
		private trigger click
		private dialog d
		private timer t
		private integer rightPos
		private string question
		private AfterSucceed as
		//失败
		method fail takes nothing returns nothing
	    	call PlaySoundBJ( gg_snd_kill_boss )
			set udg_I_Er_diansi[1] = IMaxBJ(0,udg_I_Er_diansi[1] - (IMaxBJ(1,R2I(0.2 * udg_I_Er_diansi[1]))))
        	call BJDebugMsg("|cFFFF66CC【消息】|r问题回答错误,你们失去了五分之一的防护罩,还剩"+I2S(udg_I_Er_diansi[1])+"个...")
			call .destroy()
		endmethod
		//成功
		method succeed takes nothing returns nothing
        	call PlaySoundBJ(gg_snd_GoodJob)
        	call BJDebugMsg("|cFFFF66CC【消息】|r问题回答正确,BOSS失去10%的生命.")
        	if (.as != 0) then
                call .as.execute()
        	endif
			call .destroy()
		endmethod
		static method flashTimeout takes nothing returns nothing
			local thistype this = LoadInteger(LHTable,GetHandleId(GetExpiredTimer()),1)
			set .time = .time - 1
			if (.time <= 0) then
				call .fail()
			else
				call DialogSetMessage( .d, .question+"(剩余时间:"+I2S(.time)+"s)" )
			endif
		endmethod
		static method chooseAnswer takes nothing returns nothing
			local thistype this = LoadInteger(LHTable,GetHandleId(LoadTimerHandle(LHTable,GetHandleId(GetTriggeringTrigger()),1)),1)
			local integer i = 1
			loop
				exitwhen i > 10
		        if (GetClickedButtonBJ() == LoadButtonHandle(LHTable,GetHandleId(.d),i)) then
		        	if (i == .rightPos) then
		        		call .succeed()
		        		return
		        	else
		        		call .fail()
		        		return
		        	endif
		        endif
				set i = i +1
			endloop
		endmethod
        static method GetRightAnswer takes integer shu1,integer shu2,boolean jia returns integer
        	if (jia) then
        		return shu1+shu2
        	else
        		return shu1*shu2
        	endif
        endmethod
        static method GetWrongAnswer takes integer shu,integer diff returns integer
        	local integer result = 0
        	local integer result2 = 0
        	if (GetRandomInt(1,2) == 1) then
        		set result = shu + GetRandomInt(1,R2I(Pow(2,diff)))
        		if (diff >= 10) then
        			set result2 = S2I(SubStringBJ(I2S(result),1,StringLength(I2S(result))-2) + SubStringBJ(I2S(shu),StringLength(I2S(shu))-1,StringLength(I2S(shu))))
        			if (result2 != shu) then
        				return result2
        			endif
        		endif
        		return result
        	else
        		set result = shu - GetRandomInt(1,R2I(Pow(2,diff)))
        		if (diff >= 10) then
        			set result2 = S2I(SubStringBJ(I2S(result),1,StringLength(I2S(result))-2) + SubStringBJ(I2S(shu),StringLength(I2S(shu))-1,StringLength(I2S(shu))))
        			if (result2 != shu) then
        				return result2
        			endif
        		endif
        		return result
        	endif
        endmethod
        static method create takes player p,integer diff,integer count,AfterSucceed as returns thistype
		   	local thistype this = thistype.allocate()
		   	local string s = ""
		   	local boolean jia = (GetRandomInt(1,2) == 1)
		   	local integer shu1 = GetRandomInt(R2I(Pow(2,diff-1)),R2I(Pow(2,diff)))
		   	local integer shu2 = GetRandomInt(R2I(Pow(2,diff-1)),R2I(Pow(2,diff)))
		   	local integer right = GetRightAnswer(shu1,shu2,jia)
		   	local integer i = 1
		   	if (as != 0) then
		   		set .as = as
		   	endif
		   	set .rightPos = GetRandomInt(1,count)
		   	set .time = 5
		   	set .click = CreateTrigger()
			set .p = p
			set .t = CreateTimer()
			set .d = DialogCreate()
			set .question = I2S(shu1)+S3(jia,"+","x")+I2S(shu2)+"=?"
			call DialogSetMessage( .d, .question+"(剩余时间:5s)" )
			loop
				exitwhen i > count
				if (i == .rightPos) then
					call SaveButtonHandle(LHTable,GetHandleId(.d),i,DialogAddButtonBJ( .d, I2S(right)))
				else
					call SaveButtonHandle(LHTable,GetHandleId(.d),i,DialogAddButtonBJ( .d, I2S(GetWrongAnswer(right,diff))))
				endif
				set i = i +1
			endloop
			call SaveTimerHandle(LHTable,GetHandleId(.click),1,.t)
			call SaveInteger(LHTable,GetHandleId(.t),1,this)
			call DialogDisplay( .p, .d, true )
			call TriggerRegisterDialogEvent( .click, .d )
			call TriggerAddAction(.click, function thistype.chooseAnswer)
			call TimerStart(.t,1,true,function thistype.flashTimeout)
			return this
		endmethod
		method onDestroy takes nothing returns nothing
			call PauseTimer(.t)
			call DestroyTimer(.t)
			call FlushChildHashtable(LHTable,GetHandleId(.t))
			set .t = null
			set .time = 0
			set .rightPos = 0
			call FlushChildHashtable(LHTable,GetHandleId(.click))
			call FlushChildHashtable(LHTable,GetHandleId(.d))
			call DestroyTrigger(.click)
	    	call DialogDisplay( .p, .d, false )
	        call DialogClear(.d)
	        call DialogDestroy(.d)
			set .click = null
			set .p = null
			set .question = null
			set .d = null
		endmethod
	endstruct
//---------------------------------------------------------------------------------------------------
	/*
	    大肉棒
	*/
	struct Roubang
		private unit array URou [20]
		private real aSpeed
		private real cAngle
		private real radius
		private timer t
		private integer number
		private unit caster
		static method roubangrotate takes nothing returns nothing
			local thistype this = thistype[GetExpiredTimer()]
			local integer i = 1
			if (not(IsUnitAliveBJ(.caster)) and GetUnitAbilityLevel(.caster,'A0KH') < 1) then
				call .destroy()
			endif
			set .cAngle = ModuloReal(.cAngle + .aSpeed,360.)
			loop
				exitwhen i > .number
				if (.URou[i] != null) then
					call SetUnitX(.URou[i],YDWECoordinateX(GetUnitX(.caster) + .radius * (2 * i - 1 ) * CosBJ(.cAngle)))
					call SetUnitY(.URou[i],YDWECoordinateY(GetUnitY(.caster) + .radius * (2 * i - 1 ) * SinBJ(.cAngle)))
					call SetUnitFacing(.URou[i],.cAngle + 90)
				endif
				set i = i +1
			endloop
		endmethod
        static method operator [] takes handle h returns thistype
            return YDWEGetIntegerByString("SPellBase", I2S(YDWEH2I(h)))
        endmethod
        static method operator []= takes handle h, thistype value returns nothing
            call YDWESaveIntegerByString("SPellBase", I2S(YDWEH2I(h)), value)
        endmethod
        static method flush takes handle h returns nothing
            call YDWEFlushStoredIntegerByString("SPellBase", I2S(YDWEH2I(h)))
        endmethod
		static method create takes unit caster,integer number,real radius,real aSpeed,real angle,integer utype returns thistype
			local integer i = 2
		   	local thistype this = thistype.allocate()
			set .caster = caster
			set .number = IMinBJ(29,number)
			set .radius = radius
			set .aSpeed = aSpeed
			set .cAngle = angle
			set .t = CreateTimer()
			set thistype[.t] = integer(this)
			set URou[1] = null
		   	loop
		   		exitwhen i > IMinBJ(29,number)
	   			set URou[i] = CreateUnit(GetOwningPlayer(caster), utype , YDWECoordinateX(GetUnitX(caster) + radius * (2 * i - 1 ) * CosBJ(angle)) , YDWECoordinateY(GetUnitY(caster) + radius * (2 * i - 1 ) * SinBJ(angle)) , angle + 90)
		   		set i = i +1
		   	endloop
			call TimerStart(.t,0.05,true,function thistype.roubangrotate)
			return this
		endmethod
		method onDestroy takes nothing returns nothing
			local integer i = 1
			call thistype.flush(.t)
			set .caster = null
			loop
				exitwhen i > .number
				if (.URou[i] != null) then
					call RemoveUnit(.URou[i])
					set .URou[i] = null
				endif
				set i = i +1
			endloop
			call PauseTimer(.t)
			call DestroyTimer(.t)
			set .aSpeed = 0.
			set .cAngle = 0.
			set .radius = 0.
			set .number = 0
			set .t = null
		endmethod
	endstruct
//---------------------------------------------------------------------------------------------------
	/*
	    多条命
	*/
    function interface AfterLessLife takes unit u returns nothing
	struct MultiLife
		private unit caster
		private integer times
		private integer current
		private timer t
		private texttag ttHint
		private AfterLessLife al
		static method flashLoc takes nothing returns nothing
			local thistype this = thistype[GetExpiredTimer()]
			if (times < 2) then
				call UnitRemoveAbility(.caster,'A0KH')
			endif
			if (.current >= .times) then
				return
			endif
			call SetTextTagPosUnitBJ(.ttHint,.caster,20)
			if not (IsUnitAliveBJ(.caster)) then
				set .current = .current + 1
				call SetUnitLifePercentBJ(.caster,100)
				call SetTextTagTextBJ(.ttHint,I2S(.current) + "/" + I2S(.times) +"次生命",20)
				if (.current >= .times) then
					call UnitRemoveAbility(.caster,'A0KH')
				endif
				if (.al != 0) then
					call .al.execute(.caster)
				endif
			endif
		endmethod
		method getTimes takes nothing returns integer
			return .current
		endmethod
		method setAL takes AfterLessLife al returns nothing
			set .al = al
		endmethod
		static method operator [] takes handle h returns thistype
            return YDWEGetIntegerByString("SPellBase", I2S(YDWEH2I(h)))
        endmethod
        static method operator []= takes handle h, thistype value returns nothing
            call YDWESaveIntegerByString("SPellBase", I2S(YDWEH2I(h)), value)
        endmethod
        static method flush takes handle h returns nothing
            call YDWEFlushStoredIntegerByString("SPellBase", I2S(YDWEH2I(h)))
        endmethod
        static method create takes unit caster,integer times returns thistype
		   	local thistype this
		   	set this = thistype.allocate()
			set .caster = caster
			set .times = times
			set .al = 0
			set .ttHint = CreateTextTagUnitBJ( "1/" + I2S(times) +"次生命", caster, 0, 20, 0, 100, 100, 0 )
			set .current = 1
			//加上复活技能
			call UnitAddAbility(caster,'A0KH')
			set .t = CreateTimer()
			set thistype[.t] = integer(this)
			call TimerStart(.t,0.05,true,function thistype.flashLoc)
			return this
		endmethod
		method onDestroy takes nothing returns nothing
			call thistype.flush(.t)
			call UnitRemoveAbility(.caster,'A0KH')
			call DestroyTextTag(.ttHint)
			set .ttHint = null
			set .caster = null
			call PauseTimer(.t)
			call DestroyTimer(.t)
			set .t = null
		endmethod
	endstruct
//---------------------------------------------------------------------------------------------------
	/*
	    几段无敌
	*/
	struct SuperShield
		private unit caster
		private integer times
		private integer current
		private timer t
		private boolean deathContinue
		static method flashLife takes nothing returns nothing
			local thistype this = thistype[GetExpiredTimer()]
			if (IsUnitAliveBJ(.caster)) then
				if (.current <= .times and GetUnitState(.caster,UNIT_STATE_LIFE) < (GetUnitState(.caster,UNIT_STATE_MAX_LIFE) * (1.0-((I2R(.current))/(I2R(.times + 1)))))) then
					call ImmuteDamageInterval(.caster,5)
					call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Human\\Resurrect\\ResurrectCaster.mdl", GetUnitX(.caster), GetUnitY(.caster) ))
		    		call CreateSpellTextTag(I2S(.current)+"/"+I2S(times)+"段无敌",.caster,100,0,0,4)
		    		call SetUnitLifePercentBJ(.caster,100.0*(1.0-((I2R(.current))/(I2R(.times + 1)))))
					call UnitRemoveBuffsBJ( bj_REMOVEBUFFS_ALL, .caster )
					set .current = .current + 1
				endif
			else
				if not(.deathContinue) then
					call .destroy()
				endif
			endif
		endmethod
        static method operator [] takes handle h returns thistype
            return YDWEGetIntegerByString("SPellBase", I2S(YDWEH2I(h)))
        endmethod
        static method operator []= takes handle h, thistype value returns nothing
            call YDWESaveIntegerByString("SPellBase", I2S(YDWEH2I(h)), value)
        endmethod
        static method flush takes handle h returns nothing
            call YDWEFlushStoredIntegerByString("SPellBase", I2S(YDWEH2I(h)))
        endmethod
		static method create takes unit caster,integer times returns thistype
		   	local thistype this = thistype.allocate()
			set .caster = caster
			set .times = times
			set .current = 1
			set .deathContinue = false
			set .t = CreateTimer()
			set thistype[.t] = integer(this)
			call TimerStart(.t,0.5,true,function thistype.flashLife)
			return this
		endmethod
		method SetDeathContinue takes nothing returns nothing
			set .deathContinue = true
		endmethod
		method onDestroy takes nothing returns nothing
			call thistype.flush(.t)
			set .caster = null
			call PauseTimer(.t)
			call DestroyTimer(.t)
			set .t = null
		endmethod
	endstruct
//---------------------------------------------------------------------------------------------------
	/*
	    判断是否是一段觉醒,前面是觉醒能力值
	*/
	function IJ1 takes unit u,integer i1,integer i2 returns integer
		if (BJuexing1[GetConvertedPlayerId(GetOwningPlayer(u))]) then
			return i1
		else
			return i2
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    判断是否是一段觉醒,前面是觉醒能力值
	*/
	function RJ1 takes unit u,real r1,real r2 returns real
		if (BJuexing1[GetConvertedPlayerId(GetOwningPlayer(u))]) then
			return r1
		else
			return r2
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    判断是否是二段觉醒,前面是觉醒能力值
	*/
	function IJ2 takes unit u,integer i1,integer i2 returns integer
		if (BJuexing2[GetConvertedPlayerId(GetOwningPlayer(u))]) then
			return i1
		else
			return i2
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    判断是否是二段觉醒,前面是觉醒能力值
	*/
	function RJ2 takes unit u,real r1,real r2 returns real
		if (BJuexing2[GetConvertedPlayerId(GetOwningPlayer(u))]) then
			return r1
		else
			return r2
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    判断是否是三段觉醒,前面是觉醒能力值
	*/
	function IJ3 takes unit u,integer i1,integer i2 returns integer
		if (BJuexing3[GetConvertedPlayerId(GetOwningPlayer(u))]) then
			return i1
		else
			return i2
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    判断是否是三段觉醒,前面是觉醒能力值
	*/
	function RJ3 takes unit u,real r1,real r2 returns real
		if (BJuexing3[GetConvertedPlayerId(GetOwningPlayer(u))]) then
			return r1
		else
			return r2
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    获取基础力量英雄技能伤害
	*/
	function GetDamageStr takes unit u returns real
		local unit uH = udg_H[GetConvertedPlayerId(GetOwningPlayer(u))]
		local real damage = (( GetHeroStr(uH, true) * 1.80 ) + ( GetHeroAgi(uH, true) ) + ( GetHeroInt(uH, true) * 1.20 )) * SquareRoot(GetHeroLevel(uH)) * udg_I_Jinengjiacheng[GetConvertedPlayerId(GetOwningPlayer(uH))]
		set uH = null
		return damage
	endfunction
	/*
	    获取辰寂技能伤害
	*/
	function GetDamageChenji takes unit u returns real
		local unit uH = udg_H[GetConvertedPlayerId(GetOwningPlayer(u))]
		local real damage = (GetHeroStr(uH, true)) * 2 * SquareRoot(GetHeroLevel(uH)) * udg_I_Jinengjiacheng[GetConvertedPlayerId(GetOwningPlayer(uH))]
		set uH = null
		return damage
	endfunction
	/*
	    获取基础敏捷英雄技能伤害
	*/
	function GetDamageAgi takes unit u returns real
		local unit uH = udg_H[GetConvertedPlayerId(GetOwningPlayer(u))]
		local real damage = (( GetHeroStr(uH, true) ) + ( GetHeroAgi(uH, true) *1.80 ) + ( GetHeroInt(uH, true) * 1.20 )) * SquareRoot(GetHeroLevel(uH)) * udg_I_Jinengjiacheng[GetConvertedPlayerId(GetOwningPlayer(uH))]
		set uH = null
		return damage
	endfunction
	/*
	    获取基础智力英雄技能伤害
	*/
	function GetDamageInt takes unit u returns real
		local unit uH = udg_H[GetConvertedPlayerId(GetOwningPlayer(u))]
		local real damage = (( GetHeroStr(uH, true) ) + ( GetHeroAgi(uH, true) ) + ( GetHeroInt(uH, true) * 2.0 )) * SquareRoot(GetHeroLevel(uH)) * udg_I_Jinengjiacheng[GetConvertedPlayerId(GetOwningPlayer(uH))]
		set uH = null
		return damage
	endfunction
	/*
	    获取基础英雄技能伤害
	*/
	function GetDamageBase takes unit u returns real
		local unit uH = udg_H[GetConvertedPlayerId(GetOwningPlayer(u))]
		local real damage = (( GetHeroStr(uH, true) *1.30) + ( GetHeroAgi(uH, true) * 1.30) + ( GetHeroInt(uH, true) * 1.3 )) * SquareRoot(GetHeroLevel(uH)) * udg_I_Jinengjiacheng[GetConvertedPlayerId(GetOwningPlayer(uH))]
		set uH = null
		return damage
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    判断是否可以使用第2个技能了
	*/
	function IsSecondSpellOK takes unit hero returns boolean
		return GetPlayerTechCountSimple('R006',GetOwningPlayer(hero)) == 1
	endfunction
	/*
	    判断是否可以使用第3个技能了
	*/
	function IsThirdSpellOK takes unit hero returns boolean
		return GetPlayerTechCountSimple('R007',GetOwningPlayer(hero)) == 1
	endfunction
	/*
	    判断是否可以使用第4个技能了
	*/
	function IsFourthSpellOK takes unit hero returns boolean
		return GetPlayerTechCountSimple('R008',GetOwningPlayer(hero)) == 1
	endfunction
	/*
	    判断是否可以使用第5个技能了
	*/
	function IsFifthSpellOK takes unit hero returns boolean
		return (GetPlayerTechCountSimple('R009',GetOwningPlayer(hero)) == 1) and (GetPlayerTechCountSimple('R00A',GetOwningPlayer(hero)) == 1) and (GetPlayerTechCountSimple('R00B',GetOwningPlayer(hero)) == 1)
	endfunction
//---------------------------------------------------------------------------------------------------
endlibrary
library_once Structs requires LHBase
//---------------------------------------------------------------------------------------------------
	/*
	    文字绑定
	*/
	struct TextTagBind
		private unit caster
		private texttag tt
		private real xOff
		private real yOff
		private real size
		private string content
		private timer t
		static method flash takes nothing returns nothing
			local thistype this = thistype[GetExpiredTimer()]
			call SetTextTagPos(.tt,YDWECoordinateX( GetUnitX(.caster) - .xOff) , YDWECoordinateY( GetUnitY(.caster) - .yOff ),20)
		endmethod
        static method operator [] takes handle h returns thistype
            return YDWEGetIntegerByString("TextTagBind", I2S(YDWEH2I(h)))
        endmethod
        static method operator []= takes handle h, thistype value returns nothing
            call YDWESaveIntegerByString("TextTagBind", I2S(YDWEH2I(h)), value)
        endmethod
        static method flush takes handle h returns nothing
            call YDWEFlushStoredIntegerByString("TextTagBind", I2S(YDWEH2I(h)))
        endmethod
		static method create takes unit caster,real xOff,real yOff returns thistype
		   	local thistype this = thistype.allocate()
		   	local location point = Location( YDWECoordinateX( GetUnitX(caster) - xOff) , YDWECoordinateY( GetUnitY(caster) - yOff ))
			set .xOff = xOff
			set .yOff = yOff
			set .caster = caster
			set .size = 20.
			set .tt = CreateTextTagLocBJ( "", point , 0, 20.00, 0, 100, 100, 0 )
			set .t = CreateTimer()
			set thistype[.t] = integer(this)
			call TimerStart(.t,0.05,true,function thistype.flash)
			call RemoveLocation(point)
			set point = null
			return this
		endmethod
		method setSize takes real size returns nothing
			set .size = size
			call SetTextTagTextBJ(.tt,.content,size)
		endmethod
		method setContent takes string s returns nothing
			set .content = s
			call SetTextTagTextBJ(.tt,s,.size)
		endmethod
		method onDestroy takes nothing returns nothing
			call thistype.flush(.t)
			set .caster = null
			call DestroyTextTag(.tt)
			set .tt = null
			set .xOff = 0.
			set .yOff = 0.
			call PauseTimer(.t)
			call DestroyTimer(.t)
			set .t = null
		endmethod
	endstruct
//---------------------------------------------------------------------------------------------------
	/*
	    时限BUFF(玩家)加接口
	*/
    function interface AfterBuffTime takes player p returns nothing
	struct Buff
		private player p
		private AfterBuffTime ab
		private timer t
		static method timeout takes nothing returns nothing
			local thistype this = thistype[GetExpiredTimer()]
            call .ab.execute(.p)
            call .destroy()
		endmethod
        static method operator [] takes handle h returns thistype
            return YDWEGetIntegerByString("TextTagBind", I2S(YDWEH2I(h)))
        endmethod
        static method operator []= takes handle h, thistype value returns nothing
            call YDWESaveIntegerByString("TextTagBind", I2S(YDWEH2I(h)), value)
        endmethod
        static method flush takes handle h returns nothing
            call YDWEFlushStoredIntegerByString("TextTagBind", I2S(YDWEH2I(h)))
        endmethod
		static method create takes player p,real time,AfterBuffTime ab returns thistype
		   	local thistype this = thistype.allocate()
			set .p = p
			set .ab = ab
			set .t = CreateTimer()
			set thistype[.t] = integer(this)
			call TimerStart(.t,time,false,function thistype.timeout)
			return this
		endmethod
		method onDestroy takes nothing returns nothing
			call thistype.flush(.t)
			set .p = null
			set .ab = 0
			call PauseTimer(.t)
			call DestroyTimer(.t)
			set .t = null
		endmethod
	endstruct
//---------------------------------------------------------------------------------------------------
	/*
	    检测有人与否进入无敌
	*/
	struct JudgeInvu
		private unit u
		private timer t
		static method timeout takes nothing returns nothing
			local thistype this = LoadInteger(LHTable,GetHandleId(GetExpiredTimer()),1)
			local group g = null
			if (IsUnitAliveBJ(.u)) then
				set g = GetEnemyGroup(Player(10),GetUnitX(.u),GetUnitY(.u),900)
				if (GetUnitAbilityLevel(.u,'Avul') < 1 and CountUnitsInGroup(g) == 0) then
					call UnitAddAbility(.u,'Avul')
					call PauseUnit(.u,true)
					call SetUnitLifePercentBJ(.u,100)
				elseif (GetUnitAbilityLevel(.u,'Avul') >= 1 and CountUnitsInGroup(g) != 0) then
					call UnitRemoveAbility(.u,'Avul')
					call PauseUnit(.u,false)
				endif
				call DestroyGroup(g)
				set g = null
			else
            	call .destroy()
			endif
		endmethod
		static method create takes unit u,real time returns thistype
		   	local thistype this = thistype.allocate()
			set .u = u
			set .t = CreateTimer()
			call SaveInteger(LHTable,GetHandleId(.t),1,this)
			call TimerStart(.t,time,true,function thistype.timeout)
			return this
		endmethod
		method onDestroy takes nothing returns nothing
			call FlushChildHashtable(LHTable,GetHandleId(.t))
			set .u = null
			call PauseTimer(.t)
			call DestroyTimer(.t)
			set .t = null
		endmethod
	endstruct
//---------------------------------------------------------------------------------------------------
	/*
	    扔炸弹
	*/
	struct Boom
		private unit caster
		private timer t
		private real x
		private real y
		private real facing
		private real damage
		private real speed
		private real radius
		private string effx
		static method move takes nothing returns nothing
			local thistype this = LoadInteger(LHTable,GetHandleId(GetExpiredTimer()),1)
			if (GetDistance(GetUnitX(.caster),GetUnitY(.caster),.x,.y) > .speed) then
				call SetUnitX(.caster,GetUnitX(.caster)+ CosBJ(.facing) * .speed)
				call SetUnitY(.caster,GetUnitY(.caster)+ SinBJ(.facing) * .speed)
			else
				call DamageAreaMirror(udg_H[GetConvertedPlayerId(GetOwningPlayer(.caster))],.x,.y,.radius,.damage)
				call DestroyEffect(AddSpecialEffect(.effx, .x, .y ))
				call .destroy()
			endif
		endmethod
		static method create takes unit u,real x,real y,real facing,real damage,real speed,real radius,real inteval, string effx returns thistype
		   	local thistype this = thistype.allocate()
			set .caster = u
			set .x = x
			set .y = y
			set .facing = facing
			set .damage = damage
			set .speed = speed
			set .radius = radius
			set .effx = effx
			call SetUnitFacing(u,facing)
			set .t = CreateTimer()
			call SaveInteger(LHTable,GetHandleId(.t),1,this)
			call TimerStart(.t,inteval,true,function thistype.move)
			return this
		endmethod
		method onDestroy takes nothing returns nothing
			call FlushChildHashtable(LHTable,GetHandleId(.t))
			call RemoveUnit(.caster)
			set .caster = null
			set .x = 0.0
			set .y = 0.0
			set .facing = 0.0
			set .damage = 0.0
			set .speed = 0.0
			set .radius = 0.0
			set .effx = null
			call PauseTimer(.t)
			call DestroyTimer(.t)
			set .t = null
		endmethod
	endstruct
endlibrary
///#include  "edit/NetVersion.j"
library_once Multiboard initializer InitMultiboard requires LHBase,Version
	globals
		integer array centerCredit
		/*
		    统计的伤害
		*/
		integer array Mdamage1
		integer array Mdamage2
	endglobals
//---------------------------------------------------------------------------------------------------
	/*
	    统计总伤害值
	*/
	private function TAddAllDamageCon takes nothing returns boolean
		return GetEventDamage() > 100000 and GetPlayerSlotState(GetOwningPlayer( GetEventDamageSource())) == PLAYER_SLOT_STATE_PLAYING and GetPlayerController(GetOwningPlayer( GetEventDamageSource())) == MAP_CONTROL_USER
	endfunction
	private function TAddAllDamageAct takes nothing returns nothing
		local integer index = GetConvertedPlayerId(GetOwningPlayer(GetEventDamageSource()))
		local integer divede1e = 0
		if (GetEventDamage() > 100000000) then
			set divede1e =R2I(GetEventDamage() / 100000000)
			set Mdamage2[index] = Mdamage2[index] + divede1e
			if (divede1e > 300) then
				debug call GetAchievementAndSave(ConvertedPlayer(index),46)
			endif
		endif
		set Mdamage1[index] = Mdamage1[index] + R2I(ModuloReal(GetEventDamage(),100000000))
		if (Mdamage1[index] > 100000000) then
			set Mdamage2[index] = Mdamage2[index] + 1
			set Mdamage1[index] = Mdamage1[index] - 100000000
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    增加守家积分
	*/
	function AddCenterCredit takes unit u returns nothing
		local integer index
		if (udg_RENSHU > 1) then
			set index = GetConvertedPlayerId(GetOwningPlayer(u))
			set centerCredit[index] = centerCredit[index] + (udg_Bo) * CModeH(1,2)
			call YDWEMultiboardSetItemValueBJNull( udg_D, 9, index + 1 , I2S(centerCredit[index]) )
		else
			set index = GetConvertedPlayerId(GetOwningPlayer(u))
			set centerCredit[index] = centerCredit[index] + (udg_Bo / 2) * CModeH(1,2)
			call YDWEMultiboardSetItemValueBJNull( udg_D, 9, index + 1 , I2S(centerCredit[index]) )
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    每10秒刷新一次伤害总值
	*/
	private function FlashDamage takes nothing returns nothing
		local integer i = 1
		loop
			exitwhen i > 6
			if ((GetPlayerSlotState(ConvertedPlayer(i)) == PLAYER_SLOT_STATE_PLAYING) and (GetPlayerController(ConvertedPlayer(i)) == MAP_CONTROL_USER)) then
				//刷新多面板
			 	call LeaderboardSetPlayerItemValueBJ( Player(11), udg_Paihang[i], Mdamage1[i] )
    			call LeaderboardSetPlayerItemLabelBJ( Player(11), udg_Paihang[i], "总伤害("+I2S(Mdamage2[i])+"亿)" )
				debug call SaveAchievement6(ConvertedPlayer(i),Mdamage2[i])
			endif
			set i = i +1
		endloop
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    初始化刷新计时器
	*/
	private function InitMultiboard takes nothing returns nothing
		local trigger t = CreateTrigger()
		call TimerStart(CreateTimer(),20,true,function FlashDamage)
    	call YDWESyStemAnyUnitDamagedRegistTrigger( t )
	    call TriggerAddCondition(t, Condition(function TAddAllDamageCon))
	    call TriggerAddAction(t, function TAddAllDamageAct)
    	set t = null
	endfunction
endlibrary
library_once GoldSystem initializer InitGoldSystem requires LHBase,Version
	globals
		boolean array BGoldGongxiang
	endglobals
//---------------------------------------------------------------------------------------------------
	/*
	    怪物死亡事件
	*/
	function TGoldDeathCon takes nothing returns boolean
	    return (((HaveSavedInteger(YDHT, GetUnitTypeId(GetDyingUnit()), 0x9DA51395) == true) or IsUnitInGroup(GetDyingUnit(),GJingxiang)) and (IsUnitIllusionBJ(GetDyingUnit()) != true) and (GetPlayerController(GetOwningPlayer(GetKillingUnitBJ())) == MAP_CONTROL_USER) and (GetPlayerSlotState(GetOwningPlayer(GetKillingUnitBJ())) == PLAYER_SLOT_STATE_PLAYING))
	endfunction
	function TGoldDeathAct takes nothing returns nothing
		local integer index = GetConvertedPlayerId(GetOwningPlayer(GetKillingUnitBJ()))
		local integer rate = 1
		local integer i = 1
		if (IsHighSpeed()) then
			if not (IsUnitType(GetDyingUnit(),UNIT_TYPE_HERO)) then
				set rate = 2
			endif
		endif
		loop
			exitwhen i > 6
			if (i == index or BGoldGongxiang[i]) then
	    		set udg_gold[i] = (R2I(I2R(I3(IsUnitInGroup(GetDyingUnit(),GJingxiang),udg_Bo * 75 + 225,LoadInteger(YDHT, GetUnitTypeId(GetDyingUnit()), 0x9DA51395))) * udg_I_Jinqianhuodelv[i])) * rate + udg_gold[i] + udg_gold[i + 6]
			endif
			set i = i +1
		endloop
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    每秒加黄金
	*/
	function AddGoldForPlayerTimer takes nothing returns nothing
		local integer i = 1
		loop
			exitwhen i > 6
			if ((udg_gold[i] != 0)) then
				if (CT4()) then
		        	call AdjustPlayerStateBJ( R2I(I2R(udg_gold[i])*0.01), ConvertedPlayer(i), PLAYER_STATE_RESOURCE_GOLD )
	    			call CreateSpellTextTag("黄金+"+ I2S(R2I(I2R(udg_gold[i])*0.01)),udg_H[i],255,255,0,2)
				else
		        	call AdjustPlayerStateBJ( udg_gold[i], ConvertedPlayer(i), PLAYER_STATE_RESOURCE_GOLD )
	    			call CreateSpellTextTag("黄金+"+ I2S(udg_gold[i]),udg_H[i],255,255,0,2)
				endif
		        set udg_gold[i] = 0
		    endif
			set i = i +1
		endloop
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    金币初始化
	*/
	private function InitAllMonsterGoldSystem takes nothing returns nothing
		call SaveInteger(YDHT , 'nitr' , 0x9DA51395, 100)
	    call SaveInteger(YDHT , 'nitw' , 0x9DA51395, 100)
	    call SaveInteger(YDHT , 'nith' , 0x9DA51395, 125)
	    call SaveInteger(YDHT , 'nits' , 0x9DA51395, 125)
	    call SaveInteger(YDHT , 'nmrl' , 0x9DA51395, 150)
	    call SaveInteger(YDHT , 'nmrm' , 0x9DA51395, 150)
	    call SaveInteger(YDHT , 'hfoo' , 0x9DA51395, 175)
	    call SaveInteger(YDHT , 'hmpr' , 0x9DA51395, 175)
	    call SaveInteger(YDHT , 'hsor' , 0x9DA51395, 200)
	    call SaveInteger(YDHT , 'hspt' , 0x9DA51395, 200)
	    call SaveInteger(YDHT , 'uban' , 0x9DA51395, 225)
	    call SaveInteger(YDHT , 'unec' , 0x9DA51395, 225)
	    call SaveInteger(YDHT , 'ugho' , 0x9DA51395, 250)
	    call SaveInteger(YDHT , 'ucry' , 0x9DA51395, 250)
	    call SaveInteger(YDHT , 'earc' , 0x9DA51395, 275)
	    call SaveInteger(YDHT , 'esen' , 0x9DA51395, 275)
	    call SaveInteger(YDHT , 'ogru' , 0x9DA51395, 300)
	    call SaveInteger(YDHT , 'orai' , 0x9DA51395, 300)
	    call SaveInteger(YDHT , 'hkni' , 0x9DA51395, 325)
	    call SaveInteger(YDHT , 'hrif' , 0x9DA51395, 325)
	    call SaveInteger(YDHT , 'ohun' , 0x9DA51395, 350)
	    call SaveInteger(YDHT , 'odoc' , 0x9DA51395, 350)
	    call SaveInteger(YDHT , 'njks' , 0x9DA51395, 375)
	    call SaveInteger(YDHT , 'hhes' , 0x9DA51395, 375)
	    call SaveInteger(YDHT , 'nchr' , 0x9DA51395, 400)
	    call SaveInteger(YDHT , 'nchw' , 0x9DA51395, 400)
	    call SaveInteger(YDHT , 'okod' , 0x9DA51395, 425)
	    call SaveInteger(YDHT , 'oshm' , 0x9DA51395, 425)
	    call SaveInteger(YDHT , 'nzom' , 0x9DA51395, 450)
	    call SaveInteger(YDHT , 'uswb' , 0x9DA51395, 450)
	    call SaveInteger(YDHT , 'hgry' , 0x9DA51395, 475)
	    call SaveInteger(YDHT , 'hdhw' , 0x9DA51395, 475)
	    call SaveInteger(YDHT , 'otau' , 0x9DA51395, 500)
	    call SaveInteger(YDHT , 'ospw' , 0x9DA51395, 500)
	    call SaveInteger(YDHT , 'edry' , 0x9DA51395, 525)
	    call SaveInteger(YDHT , 'edot' , 0x9DA51395, 525)
	    call SaveInteger(YDHT , 'hgyr' , 0x9DA51395, 550)
	    call SaveInteger(YDHT , 'hmtm' , 0x9DA51395, 550)
	    call SaveInteger(YDHT , 'efdr' , 0x9DA51395, 575)
	    call SaveInteger(YDHT , 'edoc' , 0x9DA51395, 575)
	    call SaveInteger(YDHT , 'uobs' , 0x9DA51395, 600)
	    call SaveInteger(YDHT , 'umtw' , 0x9DA51395, 600)
	    call SaveInteger(YDHT , 'otbr' , 0x9DA51395, 625)
	    call SaveInteger(YDHT , 'owyv' , 0x9DA51395, 625)
	    call SaveInteger(YDHT , 'owar' , 0x9DA51395, 650)
	    call SaveInteger(YDHT , 'oswy' , 0x9DA51395, 650)
	    call SaveInteger(YDHT , 'emtg' , 0x9DA51395, 700)
	    call SaveInteger(YDHT , 'ebal' , 0x9DA51395, 700)
	    call SaveInteger(YDHT , 'nfgb' , 0x9DA51395, 5000)
	    call SaveInteger(YDHT , 'nsgb' , 0x9DA51395, 5000)
	    call SaveInteger(YDHT , 'nwrg' , 0x9DA51395, 6000)
	    call SaveInteger(YDHT , 'nlkl' , 0x9DA51395, 6000)
	    call SaveInteger(YDHT , 'nltc' , 0x9DA51395, 7000)
	    call SaveInteger(YDHT , 'nltc' , 0x9DA51395, 7000)
	    call SaveInteger(YDHT , 'nmsc' , 0x9DA51395, 8000)
	    call SaveInteger(YDHT , 'nplg' , 0x9DA51395, 8000)
	    call SaveInteger(YDHT , 'nlrv' , 0x9DA51395, 9000)
	    call SaveInteger(YDHT , 'nvdg' , 0x9DA51395, 9000)
	    call SaveInteger(YDHT , 'nano' , 0x9DA51395, 200)
	    call SaveInteger(YDHT , 'nanw' , 0x9DA51395, 400)
	    call SaveInteger(YDHT , 'nenf' , 0x9DA51395, 500)
	    call SaveInteger(YDHT , 'nbld' , 0x9DA51395, 1000)
	    call SaveInteger(YDHT , 'nbda' , 0x9DA51395, 1000)
	    call SaveInteger(YDHT , 'nbdo' , 0x9DA51395, 2000)
	    call SaveInteger(YDHT , 'ncim' , 0x9DA51395, 2500)
	    call SaveInteger(YDHT , 'ncnk' , 0x9DA51395, 5000)
	    call SaveInteger(YDHT , 'ngnw' , 0x9DA51395, 10000)
	    call SaveInteger(YDHT , 'ngns' , 0x9DA51395, 5000)
	    call SaveInteger(YDHT , 'ngna' , 0x9DA51395, 500)
	    call SaveInteger(YDHT , 'nhhr' , 0x9DA51395, 1000)
	    call SaveInteger(YDHT , 'nhfp' , 0x9DA51395, 10000)
	    call SaveInteger(YDHT , 'nenc' , 0x9DA51395, 20000)
	    call SaveInteger(YDHT , 'Nbst' , 0x9DA51395, 20000)
	    call SaveInteger(YDHT , 'Hblm' , 0x9DA51395, 50000)
	    call SaveInteger(YDHT , 'Obla' , 0x9DA51395, 150000)
	    call SaveInteger(YDHT , 'Npbm' , 0x9DA51395, 250000)
	    call SaveInteger(YDHT , 'Hamg' , 0x9DA51395, 400000)
	    call SaveInteger(YDHT , 'nltl' , 0x9DA51395, 100)
	    call SaveInteger(YDHT , 'nthl' , 0x9DA51395, 500)
	    call SaveInteger(YDHT , 'nstw' , 0x9DA51395, 1500)
	    call SaveInteger(YDHT , 'nslm' , 0x9DA51395, 100)
	    call SaveInteger(YDHT , 'nslf' , 0x9DA51395, 500)
	    call SaveInteger(YDHT , 'nsln' , 0x9DA51395, 1500)
	    call SaveInteger(YDHT , 'nspd' , 0x9DA51395, 100)
	    call SaveInteger(YDHT , 'nnwa' , 0x9DA51395, 500)
	    call SaveInteger(YDHT , 'nnwl' , 0x9DA51395, 1500)
	    call SaveInteger(YDHT , 'nubk' , 0x9DA51395, 100)
	    call SaveInteger(YDHT , 'nubr' , 0x9DA51395, 500)
	    call SaveInteger(YDHT , 'nubw' , 0x9DA51395, 1500)
	endfunction
//---------------------------------------------------------------------------------------------------
	private function InitGoldSystem takes nothing returns nothing
		//怪物死亡事件
	    local trigger t = CreateTrigger()
	    local timer ti = CreateTimer()
	    call TriggerRegisterAnyUnitEventBJ( t, EVENT_PLAYER_UNIT_DEATH )
	    call TriggerAddCondition(t, Condition(function TGoldDeathCon))
	    call TriggerAddAction(t, function TGoldDeathAct)
	    call InitAllMonsterGoldSystem()
	    //每秒增加黄金
	    call TimerStart(ti,1,true,function AddGoldForPlayerTimer)
	    set t = null
	    set ti = null
	endfunction
endlibrary
///#include  "edit/NetVersion.j"
/*
    传承试练
*/
library_once Shilian initializer InitShilian requires LHBase,SpellBase,Structs,Attr,Diffculty,Multiboard,GoldSystem,Version
	globals
		unit UShilian = null
		//时间
		private integer array IShilianTime
		//连结效果
		private Connect array CShilian
		//类型
		integer array IShilianType
		//是否正在放
		private boolean array BShilianing
		//计时器
		private timer array TShilian
		//那个漂浮文字
		private TextTagBind array TTBShilian
		//次数
		private integer array IShilianTimes
		//试练提示对话框:第一次购买
		private boolean array BFirstShilian1
		//试练提示对话框:第一次使用,提示关闭
		private boolean array BFirstShilian2
		boolean array BEscOnce
		boolean array BEscTwice
		//单位组，传承试练
		private group GShilian = null
		//试练玩家
		private player PShilian = null
		//正在挑战的试练
		private integer IContinousShilian = 0
		//正在进行传承的计时器
		private timer TChuanchengRest =null
		private timerdialog TDChuanchengRest =null
		private timer TChuanchengJudge = null
		//字的触发
		private trigger TZhe = null
		private trigger TXing = null
		//吸怪的临
		private Attract array ALin
		//皆的数值中途值
		private integer array IJie1
		private integer array IJie2
		//前的分身
		private unit array UQian
		private boolean array BQian
		integer array IKuanghuanType
		integer array IQianAchievement
		integer array IZheCountOnce
	endglobals
//---------------------------------------------------------------------------------------------------
	/*
	    者的防御效果
	*/
	private function TZheCon takes nothing returns boolean
		return (GetEventDamage() > GetUnitState(GetTriggerUnit(),UNIT_STATE_LIFE)) and BShilianing[GetConvertedPlayerId(GetOwningPlayer(GetTriggerUnit()))]
	endfunction
	private function TZheAct takes nothing returns nothing
		if (GetUnitAbilityLevel(gg_unit_n01S_0258,'A0M5') == 0) then
			set IZheCountOnce[GetConvertedPlayerId(GetOwningPlayer(GetTriggerUnit()))] = IZheCountOnce[GetConvertedPlayerId(GetOwningPlayer(GetTriggerUnit()))] + 1
		endif
		call ImmuteDamageInterval(GetTriggerUnit(),0.1)
		call SetUnitLifePercentBJ(GetTriggerUnit(),100)
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    行的移动 效果
	*/
	private function TXingCon takes nothing returns boolean
		return (GetIssuedOrderIdBJ() == String2OrderIdBJ("smart")) and (BShilianing[GetConvertedPlayerId(GetOwningPlayer(GetTriggerUnit()))] or IKuanghuanType[GetConvertedPlayerId(GetOwningPlayer(GetTriggerUnit()))] == 2)
	endfunction
	private function TXingAct takes nothing returns nothing
		if (IsInForbitRegion(GetOrderPointX(),GetOrderPointY(),GetTriggerUnit())) then
			call IssueImmediateOrder( GetTriggerUnit(), "stop" )
	        call DisplayTextToPlayer( GetOwningPlayer(GetTriggerUnit()), 0, 0, "|cFFFF66CC【消息】|r此处禁止瞬移到达." )
	        return
		endif
	    if (IsTerrainPathable(GetOrderPointX(), GetOrderPointY(), PATHING_TYPE_WALKABILITY)) then
	    	call DisplayTextToPlayer(GetOwningPlayer(GetTriggerUnit()), 0., 0., "|cFFFF66CC【消息】|r目标地点不能通行,瞬移失败！")
	    	return
	    endif
		call SetUnitX(GetTriggerUnit(),GetOrderPointX())
		call SetUnitY(GetTriggerUnit(),GetOrderPointY())
		call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Orc\\MirrorImage\\MirrorImageCaster.mdl", GetOrderPointX(), GetOrderPointY() ))
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    获取类型
	*/
	//临
	function SLSpellLin takes unit u returns nothing
	endfunction
	//兵
	function SLSpellBing takes unit u returns nothing
		local group l_group = null
		local unit l_unit = null
		local unit temp = null
		if (ModuloInteger(IShilianTime[GetConvertedPlayerId(GetOwningPlayer(u))],10) != 0) then
			return
		endif
		set l_group = CreateGroup()
		call GroupEnumUnitsInRange(l_group, GetUnitX(u),GetUnitY(u), 600, null)
		loop
		    set l_unit = FirstOfGroup(l_group)
		    exitwhen l_unit == null
		    call GroupRemoveUnit(l_group, l_unit)
		    if (IsEnemy(l_unit,u)) then
			    if (GetUnitState(l_unit,UNIT_STATE_LIFE) > GetUnitState(temp,UNIT_STATE_LIFE)) then
			    	set temp = l_unit
			    endif
		    endif
		endloop
		call DestroyGroup(l_group)
		set l_group = null
		set l_unit =null
		if (temp != null) then
			call UnitDamageTarget( u, temp, GetDamageBase(u)*0.6 , false, true, ATTACK_TYPE_MAGIC, DAMAGE_TYPE_MAGIC, WEAPON_TYPE_WHOKNOWS )
			call DestroyEffect(AddSpecialEffect("war3mapImported\\ImpaleMissTarget_Portrait.mdl", GetUnitX(temp),GetUnitY(temp) ))
		endif
		set temp = null
	endfunction
	//阵
	function SLSpellZhen takes unit u returns nothing
		if (ModuloInteger(IShilianTime[GetConvertedPlayerId(GetOwningPlayer(u))],10) != 0) then
			return
		endif
		call DamageAreaEff(u,GetUnitX(u),GetUnitY(u),600,GetDamageBase(u)*0.2,"war3mapImported\\Artillery.mdl")
	endfunction
	//总索引
	function ShilianTimerContent takes player p returns nothing
		local integer id = GetConvertedPlayerId(p)
		if (IShilianType[id] == 2) then
			call SLSpellBing(udg_H[id])
		elseif (IShilianType[id] == 6) then
			call SLSpellZhen(udg_H[id])
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    皆
	*/
	private function InitJieDamage takes player p returns nothing
		local integer index = GetConvertedPlayerId(p)
		set IJie1[index] = Mdamage1[index]
		set IJie2[index] = Mdamage2[index]
	endfunction
	private function JieDamageExpose takes player p returns nothing
		local integer index = GetConvertedPlayerId(p)
		local real damage1 = I2R(Mdamage1[index] - IJie1[index])*0.3
		local real damage2 = I2R(Mdamage2[index] - IJie2[index])*0.3
		local real damage = 0.
		local group l_group = CreateGroup()
		local unit l_unit = null
		local integer count = 0
		call GroupEnumUnitsInRange(l_group, GetUnitX(udg_H[GetConvertedPlayerId(p)]),GetUnitY(udg_H[GetConvertedPlayerId(p)]), 900, null)
		loop
		    set l_unit = FirstOfGroup(l_group)
		    exitwhen l_unit == null
		    call GroupRemoveUnit(l_group, l_unit)
		    if (IsEnemy(l_unit,udg_H[GetConvertedPlayerId(p)])) then
		    	set count = count + 1
		    endif
		endloop
		if (count >= 120 and not(IsInRect(GetUnitX(udg_H[GetConvertedPlayerId(p)]),GetUnitY(udg_H[GetConvertedPlayerId(p)]),gg_rct__________u))) then
			debug call GetAchievementAndSave(p,421)
		elseif (count >= 20) then
			call DisplayTextToPlayer(p, 0., 0., "|cFFFF66CC【消息】|r数量:"+I2S(count))
		endif
		call DestroyGroup(l_group)
		set damage = RMinBJ(300000000.*100,damage2 * 100000000 + damage1)/IMaxBJ(1,count)
		call CreateTextTagA( I2S(R2I(damage/10000)) + "万伤害!",udg_H[GetConvertedPlayerId(p)],100,0,0,3,30)
		set l_group = CreateGroup()
		call GroupEnumUnitsInRange(l_group, GetUnitX(udg_H[GetConvertedPlayerId(p)]),GetUnitY(udg_H[GetConvertedPlayerId(p)]), 900, null)
		loop
		    set l_unit = FirstOfGroup(l_group)
		    exitwhen l_unit == null
		    call GroupRemoveUnit(l_group, l_unit)
		    if (IsEnemy(l_unit,udg_H[GetConvertedPlayerId(p)])) then
		    	if (IsUnitType(l_unit,UNIT_TYPE_HERO)) then
		    		call UnitDamageTarget( udg_H[GetConvertedPlayerId(p)], l_unit, RMinBJ(damage,GetUnitState(l_unit,UNIT_STATE_MAX_LIFE)*0.2), false, true, ATTACK_TYPE_MAGIC, DAMAGE_TYPE_MAGIC, WEAPON_TYPE_WHOKNOWS )
		    	else
		    		call UnitDamageTarget( udg_H[GetConvertedPlayerId(p)], l_unit, damage, false, true, ATTACK_TYPE_MAGIC, DAMAGE_TYPE_MAGIC, WEAPON_TYPE_WHOKNOWS )
		    	endif
				call DestroyEffect(AddSpecialEffect("Objects\\Spawnmodels\\Orc\\Orcblood\\BattrollBlood.mdl", GetUnitX(l_unit), GetUnitY(l_unit) ))
		    endif
		endloop
		call DestroyGroup(l_group)
		set l_group = null
		set l_unit =null
		set IJie1[index] = 0
		set IJie2[index] = 0
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    设置对应的属性
	*/
	private function SyncQian takes player p returns nothing
		local integer id = GetConvertedPlayerId(p)
		local unit u = udg_H[GetConvertedPlayerId(p)]
		local integer i = 1
		if (IsUnitAliveBJ(UQian[id])) then
			call SetUnitUserData(UQian[id],0)
			loop
				exitwhen i > 6
				if (GetItemTypeId(UnitItemInSlotBJ(u,i)) != GetItemTypeId(UnitItemInSlotBJ(UQian[id],i))) then
					call RemoveItem(UnitItemInSlotBJ(UQian[id],i))
					call UnitAddItemToSlotById(UQian[id],GetItemTypeId(UnitItemInSlotBJ(u,i)),i-1)
				    call SetItemDroppable( UnitItemInSlotBJ(UQian[id],i), false )
				    call SetItemPawnable( UnitItemInSlotBJ(UQian[id],i), false )
				endif
				set i = i +1
			endloop
			call SetUnitUserData(UQian[id],1)
			if not(BQian[id]) then
				call SetAttack(UQian[id],R2I(GetAttack(u)*0.1))
				call SetDefense(UQian[id],R2I(GetDefense(u)*0.1))
				call SetHP(UQian[id],R2I(GetHP(u)*0.1))
				call SetHeroInt(UQian[id],R2I(GetHeroInt(u,false)*0.1),false)
				call SetHeroStr(UQian[id],R2I(GetHeroStr(u,false)*0.1),false)
				call SetHeroAgi(UQian[id],R2I(GetHeroAgi(u,false)*0.1),false)
			else
				call SetAttack(UQian[id],GetAttack(u))
				call SetDefense(UQian[id],GetDefense(u))
				call SetHP(UQian[id],GetHP(u))
				call SetHeroStr(UQian[id],GetHeroStr(u,false),false)
				call SetHeroAgi(UQian[id],GetHeroAgi(u,false),false)
				call SetHeroInt(UQian[id],GetHeroInt(u,false),false)
			endif
		endif
		set u = null
	endfunction
	private function QianTimer takes nothing returns nothing
		local timer t = GetExpiredTimer()
		local integer id = GetHandleId(t)
		local player p = LoadPlayerHandle(LHTable,id,1)
		call SyncQian(p)
		set p = null
		set t = null
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    同步前幻象
	*/
	function InitSyncQianAttr takes player p returns nothing
		local timer t = CreateTimer()
		call SyncQian(p)
		call SavePlayerHandle(LHTable,GetHandleId(t),1,p)
		call TimerStart(t,10,true,function QianTimer)
		set t = null
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    对每个字的主动进行初始化
	*/
	function InitShilianSpell takes player p returns nothing
		local integer id = GetConvertedPlayerId(p)
		if (IShilianType[id] == 1) then
			set ALin[id] = Attract.create(udg_H[id],900,0.05,50)
			call ALin[id].SetForbitHero()
			call ALin[id].SetDeathContinue()
		    call ALin[id].start()
		elseif (IShilianType[id] == 2) then
		elseif (IShilianType[id] == 3) then
			call UnitAddAbilityP(udg_H[id],'A0LC')
		elseif (IShilianType[id] == 4) then
			set IZheCountOnce[id] = 0
		elseif (IShilianType[id] == 5) then
			call InitJieDamage(p)
		elseif (IShilianType[id] == 6) then
		elseif (IShilianType[id] == 7) then
			call UnitAddAbilityP(udg_H[id],'A0MA')
			set BGoldGongxiang[id] = true
		elseif (IShilianType[id] == 8) then
			set BQian[id] = true
			call SyncQian(p)
		elseif (IShilianType[id] == 9) then
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    对每个字的主动关闭
	*/
	function CloseShilianSpell takes player p returns nothing
		local integer id = GetConvertedPlayerId(p)
		if (IShilianType[id] == 1) then
		    call ALin[id].destroy()
			set ALin[id] = 0
		elseif (IShilianType[id] == 3) then
			call UnitRemoveAbility(udg_H[id],'A0LC')
		elseif (IShilianType[id] == 4) then
			if (IZheCountOnce[id] > 0) then
				if (IZheCountOnce[id] >= 18) then
					debug call GetAchievementAndSave(p,423)
				else
					call DisplayTextToPlayer(p, 0., 0., "|cFFFF66CC【者之尘】|r"+I2S(IZheCountOnce[id]))
				endif
			endif
		elseif (IShilianType[id] == 5) then
			call JieDamageExpose(p)
		elseif (IShilianType[id] == 6) then
		elseif (IShilianType[id] == 7) then
			call UnitRemoveAbility(udg_H[id],'A0MA')
			set BGoldGongxiang[id] = false
		elseif (IShilianType[id] == 8) then
			set BQian[id] = false
			call SyncQian(p)
		elseif (IShilianType[id] == 9) then
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    关闭
	*/
	function DestroyShilianSpell takes player p returns nothing
		local integer id = GetConvertedPlayerId(p)
		set BShilianing[id] = false
		call CShilian[id].destroy()
		set CShilian[id] = 0
		call FlushChildHashtable(LHTable,GetHandleId(TShilian[id]))
		call PauseTimer(TShilian[id])
		call DestroyTimer(TShilian[id])
		set TShilian[id] = null
		call TTBShilian[id].destroy()
		call CloseShilianSpell(p)
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    开启时期的计时器
	*/
	function FlashShilianTimer takes nothing returns nothing
		local player p = LoadPlayerHandle(LHTable,GetHandleId(GetExpiredTimer()),1)
		local integer id = GetConvertedPlayerId(p)
        set IShilianTime[id] = IShilianTime[id] - 1
        if (IShilianTime[id] <= 0) then
        	call DestroyShilianSpell(p)
        	set p = null
        	return
        endif
		call TTBShilian[id].setContent(I2S(IShilianTime[id]/10) + "." + I2S(ModuloInteger(IShilianTime[id],10)) +"s")
    	call ShilianTimerContent(p)
        set p = null
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    开启
	*/
	function StartShilianSpell takes player p returns nothing
		local integer id = GetConvertedPlayerId(p)
		set BShilianing[id] = true
		set CShilian[id] = Connect.create(UShilian,udg_H[id],"HWPB")
		set TShilian[id] = CreateTimer()
		call SavePlayerHandle(LHTable,GetHandleId(TShilian[id]),1,p)
		call TimerStart(TShilian[id],0.1,true,function FlashShilianTimer)
		set TTBShilian[id] = TextTagBind.create(udg_H[id],70,70)
		call InitShilianSpell(p)
		if not(BFirstShilian2[id]) then
			set BFirstShilian2[id] = true
			call ShowGameHint(p,"
			|cff00ccff每次完成挑战你将得到
			"+I2S(IShilianTime[id]/10)+"s的主动技能持续时间.|r
			|cffffff00在开启该技能时该持续时间会不断消耗.|r
			|cffff6800你可以再次通过双击(点击2次)Esc键
			来关闭主动技能,停止时间消耗.|r
")
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    开启/关闭技能
	*/
	function SpellShilian takes player p returns nothing
		local integer id = GetConvertedPlayerId(p)
		if not(BShilianing[id]) then
			// 开始施放技能
			if (IShilianTime[id] > 0) then
				call StartShilianSpell(p)
			else
				call DisplayTextToPlayer(p, 0., 0., "|cFFFF66CC【消息】|r你的试练充能时间已经用光了,请重新试练吧!")
			endif
		else
			//已经开始施放了,则关闭
			call DestroyShilianSpell(p)
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    双击Esc事件
	*/
	private function TDoubleEscAct takes nothing returns nothing
		local integer id = GetConvertedPlayerId(GetTriggerPlayer())
		if (BEscOnce[id]) then
			set BEscOnce[id] = false
			if not(BEscTwice[id]) then
				call SpellShilian(GetTriggerPlayer())
				set BEscTwice[id]= true
				call YDWEPolledWaitNull(0.3)
				set BEscTwice[id]= false
				set BEscOnce[id]= false
			endif
		else
			set BEscOnce[id]= true
			call YDWEPolledWaitNull(0.3)
			set BEscOnce[id]= false
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    为一个单位添加行字效果
	*/
	function AddXingUnit takes unit u returns nothing
    	if (TXing == null) then
			set TXing = CreateTrigger()
			call TriggerAddCondition(TXing, Condition(function TXingCon))
			call TriggerAddAction(TXing, function TXingAct)
		endif
    	call TriggerRegisterUnitEvent( TXing, u , EVENT_UNIT_ISSUED_POINT_ORDER )
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    刚刚定下你的真言的时候
	*/
	function ChooseShilian takes player p,integer index returns nothing
		local integer id = GetConvertedPlayerId(p)
		set IShilianType[id] = index
		if (index == 1) then
			//临
			call DisplayTextToPlayer(p, 0., 0., "|cFFFF66CC【消息】|r你成功的将|cff00ccff九字真言 - 临|r定为你的试练内容.")
			call UnitAddAbilityP(udg_H[id],'A0L7')
			call AddAgiPercentImme(id,0.05)
			call AddStrPercentImme(id,0.05)
			call AddIntPercentImme(id,0.05)
		elseif (index == 2) then
			//兵
			call DisplayTextToPlayer(p, 0., 0., "|cFFFF66CC【消息】|r你成功的将|cff00ccff九字真言 - 兵|r定为你的试练内容.")
			call UnitAddAbilityP(udg_H[id],'A0KX')
		elseif (index == 3) then
			//斗
			call UnitAddAbilityP(udg_H[id],'A0L4')
			call UnitAddAbilityP(udg_H[id],'A0LE')
			call DisplayTextToPlayer(p, 0., 0., "|cFFFF66CC【消息】|r你成功的将|cff00ccff九字真言 - 斗|r定为你的试练内容.")
			call SetPlayerAbilityAvailable(p,'A0LE',false)
			call SetPlayerAbilityAvailable(p,'A0LC',false)
		elseif (index == 4) then
			//者
			call UnitAddAbilityP(udg_H[id],'A0LF')
			call SetPlayerAbilityAvailable(p,'A0LF',false)
			call DisplayTextToPlayer(p, 0., 0., "|cFFFF66CC【消息】|r你成功的将|cff00ccff九字真言 - 者|r定为你的试练内容.")
			call UnitAddAbilityP(udg_H[id],'A0LA')
			if (TZhe == null) then
				set TZhe = CreateTrigger()
				call TriggerAddCondition(TZhe, Condition(function TZheCon))
				call TriggerAddAction(TZhe, function TZheAct)
			endif
	   		call TriggerRegisterUnitEvent(TZhe,udg_H[GetConvertedPlayerId(p)],EVENT_UNIT_DAMAGED)
		elseif (index == 5) then
			//皆
			call DisplayTextToPlayer(p, 0., 0., "|cFFFF66CC【消息】|r你成功的将|cff00ccff九字真言 - 皆|r定为你的试练内容.")
			call UnitAddAbilityP(udg_H[id],'A0L6')
			call AddHPPercent(id,0.1)
		elseif (index == 6) then
			//阵
			call DisplayTextToPlayer(p, 0., 0., "|cFFFF66CC【消息】|r你成功的将|cff00ccff九字真言 - 阵|r定为你的试练内容.")
			call AddDamagePercent(GetConvertedPlayerId(p),0.08)
			call UnitAddAbilityP(udg_H[id],'A0LB')
		elseif (index == 7) then
			//列
			call DisplayTextToPlayer(p, 0., 0., "|cFFFF66CC【消息】|r你成功的将|cff00ccff九字真言 - 列|r定为你的试练内容.")
			call UnitAddAbilityP(udg_H[id],'A0L5')
			call AddDefensePercent(id,0.1)
			call SetPlayerAbilityAvailable(p,'A0MA',false)
		elseif (index == 8) then
			//前
			call DisplayTextToPlayer(p, 0., 0., "|cFFFF66CC【消息】|r你成功的将|cff00ccff九字真言 - 前|r定为你的试练内容.")
			call UnitAddAbilityP(udg_H[id],'A0L8')
			set UQian[id] = CreateUnit(p,'N01Y',GetUnitX(udg_H[id]),GetUnitY(udg_H[id]),0)
			call InitSyncQianAttr(p)
		elseif (index == 9) then
			//行
			call UnitAddAbilityP(udg_H[id],'A0L9')
			call UnitAddAbilityP(udg_H[id],'A0LG')
			call DisplayTextToPlayer(p, 0., 0., "|cFFFF66CC【消息】|r你成功的将|cff00ccff九字真言 - 行|r定为你的试练内容.")
			call SetPlayerAbilityAvailable(p,'A0LG',false)
			call AddXingUnit(udg_H[GetConvertedPlayerId(p)])
		endif
		call ShowGameHint(p,"
			恭喜你完成了传承试练!
			|cff00ccff你获得了对应该传承的
			主动技能与被动技能.|r
			|cffffff00被动技能将会一直存在.|r
			|cffff6800你可以通过双击(点击2次)Esc键
			来开启主动技能.|r
")
    	call SetPlayerTechResearchedSwap( 'R01K', 1 , p)
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    给怪物加上随机的技能
	*/
	private function AddMonsterRandomAbility takes unit u returns nothing
		local integer i = GetRandomInt(1,24)
		if (i == 1) then
			call UnitAddAbility(u,'A044')
			call SetUnitAbilityLevel(u,'A044',udg_Nandu_JJJ)
		elseif (i == 2) then
			call UnitAddAbility(u,'A0AN')
		elseif (i == 3) then
			call UnitAddAbility(u,'A00A')
		elseif (i == 4) then
			call UnitAddAbility(u,'ACat')
			call SetUnitAbilityLevel(u,'ACat',udg_Nandu_JJJ)
		elseif (i == 5) then
			call UnitAddAbility(u,'A03T')
			call SetUnitAbilityLevel(u,'A03T',udg_Nandu_JJJ)
			call UnitAddAbility(u,'A06K')
			call SetUnitAbilityLevel(u,'A06K',udg_Nandu_JJJ)
		elseif (i == 6) then
			call UnitAddAbility(u,'A05N')
			call SetUnitAbilityLevel(u,'A05N',udg_Nandu_JJJ)
		elseif (i == 7) then
			call UnitAddAbility(u,'A08H')
			call SetUnitAbilityLevel(u,'A08H',udg_Nandu_JJJ)
			call UnitAddAbility(u,'A05O')
			call SetUnitAbilityLevel(u,'A05O',udg_Nandu_JJJ)
		elseif (i == 8) then
			call UnitAddAbility(u,'uban')
			call SetUnitAbilityLevel(u,'uban',udg_Nandu_JJJ)
		elseif (i == 9) then
			call UnitAddAbility(u,'A05V')
			call SetUnitAbilityLevel(u,'A05V',udg_Nandu_JJJ)
		elseif (i == 10) then
			call UnitAddAbility(u,'A05I')
			call SetUnitAbilityLevel(u,'A05I',udg_Nandu_JJJ)
		elseif (i == 11) then
			call UnitAddAbility(u,'Ablo')
			call SetUnitAbilityLevel(u,'Ablo',udg_Nandu_JJJ)
		elseif (i == 12) then
			call UnitAddAbility(u,'A09G')
			call SetUnitAbilityLevel(u,'A09G',udg_Nandu_JJJ)
		elseif (i == 13) then
			call UnitAddAbility(u,'A09N')
			call SetUnitAbilityLevel(u,'A09N',udg_Nandu_JJJ)
		elseif (i == 14) then
			//归一
			//call UnitAddAbility(u,'A095')
		elseif (i == 15) then
			call UnitAddAbility(u,'Aams')
			call SetUnitAbilityLevel(u,'Aams',udg_Nandu_JJJ)
		elseif (i == 16) then
			call UnitAddAbility(u,'A08A')
			call SetUnitAbilityLevel(u,'A08A',udg_Nandu_JJJ)
		elseif (i == 17) then
			call UnitAddAbility(u,'A0A1')
			call SetUnitAbilityLevel(u,'A0A1',udg_Nandu_JJJ)
		elseif (i == 18) then
			call UnitAddAbility(u,'A09C')
			call SetUnitAbilityLevel(u,'A09C',udg_Nandu_JJJ)
		elseif (i == 19) then
			call UnitAddAbility(u,'A0LH')
		elseif (i == 20) then
			call UnitAddAbility(u,'ANr2')
			call SetUnitAbilityLevel(u,'ANr2',udg_Nandu_JJJ)
		elseif (i == 21) then
			call UnitAddAbility(u,'A0LI')
		elseif (i == 22) then
			call UnitAddAbility(u,'A08F')
			call SetUnitAbilityLevel(u,'A08F',udg_Nandu_JJJ)
		elseif (i == 23) then
			call UnitAddAbility(u,'A0B8')
		elseif (i == 24) then
			call UnitAddAbility(u,'A0BD')
			call SetUnitAbilityLevel(u,'A0BD',udg_Nandu_JJJ)
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    给怪物设置相应的生命与生命,还有防御
	*/
	private function MonsterSetPower takes unit u,player p returns nothing
		local integer id = GetConvertedPlayerId(p)
		if (udg_Zhandouli[id] < 500) then
			call SetHeroInt(u,20,true)
			call SetHeroAgi(u,5000,true)
			call SetHeroStr(u,1000,true)
		elseif (udg_Zhandouli[id] < 2500) then
			call SetHeroInt(u,80,true)
			call SetHeroAgi(u,15000,true)
			call SetHeroStr(u,30000,true)
		elseif (udg_Zhandouli[id] < 8500) then
			call SetHeroInt(u,500,true)
			call SetHeroAgi(u,30000,true)
			call SetHeroStr(u,150000,true)
		elseif (udg_Zhandouli[id] < 15000) then
			call SetHeroInt(u,5000,true)
			call SetHeroAgi(u,50000,true)
			call SetHeroStr(u,500000,true)
		elseif (udg_Zhandouli[id] < 30000) then
			call SetHeroInt(u,30000,true)
			call SetHeroAgi(u,80000,true)
			call SetHeroStr(u,1300000,true)
		elseif (udg_Zhandouli[id] < 60000) then
			call SetHeroInt(u,60000,true)
			call SetHeroAgi(u,120000,true)
			call SetHeroStr(u,3000000,true)
		elseif (udg_Zhandouli[id] < 120000) then
			call SetHeroInt(u,150000,true)
			call SetHeroAgi(u,120000,true)
			call SetHeroStr(u,10000000,true)
		elseif (udg_Zhandouli[id] < 250000) then
			call SetHeroInt(u,800000,true)
			call SetHeroAgi(u,200000,true)
			call SetHeroStr(u,30000000,true)
		elseif (udg_Zhandouli[id] < 500000) then
			call SetHeroInt(u,3000000,true)
			call SetHeroAgi(u,400000,true)
			call SetHeroStr(u,100000000,true)
		elseif (udg_Zhandouli[id] < 700000) then
			call SetHeroInt(u,5000000,true)
			call SetHeroAgi(u,500000,true)
			call SetHeroStr(u,200000000,true)
		elseif (udg_Zhandouli[id] < 800000) then
			call SetHeroInt(u,6000000,true)
			call SetHeroAgi(u,600000,true)
			call SetHeroStr(u,300000000,true)
		elseif (udg_Zhandouli[id] < 900000) then
			call SetHeroInt(u,8000000,true)
			call SetHeroAgi(u,700000,true)
			call SetHeroStr(u,500000000,true)
		elseif (udg_Zhandouli[id] < 1000000) then
			call SetHeroInt(u,10000000,true)
			call SetHeroAgi(u,1000000,true)
			call SetHeroStr(u,800000000,true)
		elseif (udg_Zhandouli[id] < 1200000) then
			call SetHeroInt(u,18000000,true)
			call SetHeroAgi(u,1300000,true)
			call SetHeroStr(u,1000000000,true)
		elseif (udg_Zhandouli[id] < 1500000) then
			call SetHeroInt(u,24000000,true)
			call SetHeroAgi(u,1500000,true)
			call SetHeroStr(u,1400000000,true)
		elseif (udg_Zhandouli[id] < 1800000) then
			call SetHeroInt(u,29000000,true)
			call SetHeroAgi(u,1800000,true)
			call SetHeroStr(u,1600000000,true)
		else
			call SetHeroInt(u,34000000,true)
			call SetHeroAgi(u,2200000,true)
			call SetHeroStr(u,2000000000,true)
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    创建怪物
	*/
	private function CreateShilianMonster takes player p returns nothing
		local integer i = 1
		local unit u = null
		call DisplayTextToPlayer(p, 0., 0., "|cFFFF66CC【消息】|r你的战斗力为"+I2S(udg_Zhandouli[GetConvertedPlayerId(p)])+".")
		loop
			exitwhen i > 20
            set u = CreateUnit(Player(11),'N01U',GetRandomReal(GetRectMinX(gg_rct_Chuancheng),GetRectMaxX(gg_rct_Chuancheng)),GetRandomReal(GetRectMinY(gg_rct_Chuancheng),GetRectMaxY(gg_rct_Chuancheng)),GetRandomReal(0,360))
        	call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\NightElf\\Blink\\BlinkTarget.mdl", GetUnitX(u),GetUnitY(u) ))
        	call AddMonsterRandomAbility(u)
    		call TriggerExecute( gg_trg_zhandouli2 )
        	call MonsterSetPower(u,p)
            call EnhanceDiffAttack(u)
			call GroupAddUnit(GShilian,u)
			set i = i +1
		endloop
		set u = null
	endfunction
//---------------------------------------------------------------------------------------------------
    /*
        判断怪物的数量
    */
    private function GetShilianMonsterCount takes nothing returns integer
        local group l_group = CreateGroup()
        local unit l_unit
        local integer count = 0
        call GroupAddGroup(GShilian,l_group)
        loop
            set l_unit = FirstOfGroup(l_group)
            exitwhen l_unit == null
            call GroupRemoveUnit(l_group, l_unit)
            if (IsUnitAliveBJ(l_unit) and GetOwningPlayer(l_unit) == Player(11)) then
                set count = count + 1
                call UnitRemoveBuffsBJ( bj_REMOVEBUFFS_ALL, l_unit )
            endif
        endloop
        call DestroyGroup(l_group)
        set l_group = null
        set l_unit =null
        return count
    endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    清除试练时的所有东西
	*/
	private function RemoveChuanchengUnit takes nothing returns nothing
        if (IsUnitAliveBJ(GetEnumUnit()) and GetOwningPlayer(GetEnumUnit()) == Player(11)) then
            call FlushChildHashtable(YDHT,GetHandleId(GetEnumUnit()))
            call RemoveUnit(GetEnumUnit())
        endif
	endfunction
	private function ClearChuancheng takes nothing returns nothing
		call ForGroup(GShilian,function RemoveChuanchengUnit)
		call DestroyGroup(GShilian)
		set GShilian = null
		set IContinousShilian = 0
		set PShilian = null
		call PauseTimer(TChuanchengRest)
		call DestroyTimer(TChuanchengRest)
		call DestroyTimerDialog(TDChuanchengRest)
		set TChuanchengRest = null
		set TDChuanchengRest = null
		call PauseTimer(TChuanchengJudge)
		call DestroyTimer(TChuanchengJudge)
		set TChuanchengJudge = null
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    每秒都判断一次是否胜利
	*/
	private function ChuanchengJudge takes nothing returns nothing
        if (GetShilianMonsterCount() == 0) then
        	if (IShilianType[GetConvertedPlayerId(PShilian)] == 0) then
        		call ChooseShilian(PShilian,IContinousShilian)
        	endif
			set IShilianTimes[GetConvertedPlayerId(PShilian)] = IShilianTimes[GetConvertedPlayerId(PShilian)] + 1
        	if (IShilianType[GetConvertedPlayerId(PShilian)] == 1) then
        		set IShilianTime[GetConvertedPlayerId(PShilian)] = 250 * I3(GetUnitAbilityLevel(gg_unit_n01S_0258,'A0M5') == 1,2,1)
        	elseif (IShilianType[GetConvertedPlayerId(PShilian)] == 2) then
        		set IShilianTime[GetConvertedPlayerId(PShilian)] = 600 * I3(GetUnitAbilityLevel(gg_unit_n01S_0258,'A0M5') == 1,2,1)
        	elseif (IShilianType[GetConvertedPlayerId(PShilian)] == 3) then
        		set IShilianTime[GetConvertedPlayerId(PShilian)] = 900 * I3(GetUnitAbilityLevel(gg_unit_n01S_0258,'A0M5') == 1,2,1)
        	elseif (IShilianType[GetConvertedPlayerId(PShilian)] == 4) then
        		set IShilianTime[GetConvertedPlayerId(PShilian)] = 50 * I3(GetUnitAbilityLevel(gg_unit_n01S_0258,'A0M5') == 1,2,1)
        	elseif (IShilianType[GetConvertedPlayerId(PShilian)] == 5) then
        		set IShilianTime[GetConvertedPlayerId(PShilian)] = 250 * I3(GetUnitAbilityLevel(gg_unit_n01S_0258,'A0M5') == 1,2,1)
        	elseif (IShilianType[GetConvertedPlayerId(PShilian)] == 6) then
        		set IShilianTime[GetConvertedPlayerId(PShilian)] = 600 * I3(GetUnitAbilityLevel(gg_unit_n01S_0258,'A0M5') == 1,2,1)
        	elseif (IShilianType[GetConvertedPlayerId(PShilian)] == 7) then
        		set IShilianTime[GetConvertedPlayerId(PShilian)] = 900 * I3(GetUnitAbilityLevel(gg_unit_n01S_0258,'A0M5') == 1,2,1)
        	elseif (IShilianType[GetConvertedPlayerId(PShilian)] == 8) then
        		set IShilianTime[GetConvertedPlayerId(PShilian)] = 900 * I3(GetUnitAbilityLevel(gg_unit_n01S_0258,'A0M5') == 1,2,1)
        	elseif (IShilianType[GetConvertedPlayerId(PShilian)] == 9) then
        		set IShilianTime[GetConvertedPlayerId(PShilian)] = 450 * I3(GetUnitAbilityLevel(gg_unit_n01S_0258,'A0M5') == 1,2,1)
        	endif
        	call DisplayTextToPlayer(PShilian, 0., 0., "|cFFFF66CC【消息】|r你的主动技能时间充能至"+I2S(IShilianTime[GetConvertedPlayerId(PShilian)]/10)+"s.")
			call ClearChuancheng()
        endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    时间到了，失败哦
	*/
	private function ChuanchengTimeOut takes nothing returns nothing
		//清除传承有关的东西
		call DisplayTextToPlayer(PShilian, 0., 0., "|cFFFF66CC【消息】|r你的传承试练失败了！")
		call ClearChuancheng()
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    开始试练
	*/
	function StartShilian takes player p,integer i returns nothing
		local integer id = GetConvertedPlayerId(p)
		if (i != IShilianType[id] and IShilianType[id] != 0) then
			call DisplayTextToPlayer(p, 0., 0., "|cFFFF66CC【消息】|r每一局游戏只能选择一种试练并不能更改.")
			return
		endif
		if not(udg_H[id] == GetBuyingUnit() and RectContainsUnit(gg_rct_Chuancheng,GetBuyingUnit())) then
            call DisplayTextToPlayer( p, 0, 0, "|cFFFF66CC【消息】|r请用英雄来试练。" )
            return
		endif
		if (PShilian != null) then
            call DisplayTextToPlayer( p, 0, 0, "|cFFFF66CC【消息】|r有人正在试练!" )
            return
		endif
		if (IShilianTime[GetConvertedPlayerId(p)] > 0) then
			call DisplayTextToPlayer(p, 0., 0., "|cFFFF66CC【消息】|r你的时间未用完，请把所有时间用完再来试练！")
            return
		endif
        if (GetPlayerState(p, PLAYER_STATE_RESOURCE_LUMBER) < (R2I(Pow(2,IShilianTimes[GetConvertedPlayerId(p)])) * 10)) then
            call DisplayTextToPlayer(p , 0., 0., "|cFFFF66CC【消息】|r你的木头不足" + I2S((R2I(Pow(2,IShilianTimes[GetConvertedPlayerId(p)])) * 10)) + ".")
            return
        endif
        call AdjustPlayerStateBJ( -1*(R2I(Pow(2,IShilianTimes[GetConvertedPlayerId(p)])) * 10), p , PLAYER_STATE_RESOURCE_LUMBER )
		set IContinousShilian = i
		set GShilian = CreateGroup()
		set PShilian = p
		if not(BFirstShilian1[id]) then
			set BFirstShilian1[id] = true
			call ShowGameHint(p,"传承试练介绍
				|cff00ccff在1分钟内清除与自身战斗力有关的20只怪物,
				每只怪物有24波进攻怪的随机技能,
				便可以获得对应主动技能与被动技能!|r
				|cffffff00主动技能在挑战结束后会充能一定的时间,
				使用主动技能会消耗该充能时间,
				再次双击Esc能随时关闭该主动技能,
				在把时间用光后请继续来挑战获取时间.|r
				|cffff6800注意:每次挑战都要花费一定的木头,
				第1次为10,第2次为20,第3次为40,
				……第5次为160,第6次为320……
				以此类推,每次都会在原基础*2。|r
				挑战将在5秒后开始。
")
			call YDWEPolledWaitNull(5)
		endif
		call CreateShilianMonster(p)
        set TChuanchengRest = CreateTimer()
        set TDChuanchengRest = CreateTimerDialogBJ(TChuanchengRest,"传承试练")
        call TimerStart(TChuanchengRest,60,false,function ChuanchengTimeOut)
        call TimerDialogDisplay(TDChuanchengRest,true)
        set TChuanchengJudge = CreateTimer()
        call TimerStart(TChuanchengJudge,1,true,function ChuanchengJudge)
        set p = null
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    离开后就失败了
	*/
	private function TLeaveShilianCon takes nothing returns boolean
		return GetLeavingUnit() == udg_H[GetConvertedPlayerId(PShilian)]
	endfunction
	private function TLeaveShilianAct takes nothing returns nothing
		call DisplayTextToPlayer(PShilian, 0., 0., "|cFFFF66CC【消息】|r你的传承试练失败了！")
		call ClearChuancheng()
	endfunction
//---------------------------------------------------------------------------------------------------
    /*
        进入试练，开启
    */
    function EnterShilian takes nothing returns nothing
        local real x
        local real y
        if ((GetItemTypeId(GetSoldItem()) == 'I06P')) then
            set x = GetRectCenterX(gg_rct_Chuancheng)
            set y = GetRectCenterY(gg_rct_Chuancheng)
            call SetUnitX(GetBuyingUnit(),x)
            call SetUnitY(GetBuyingUnit(),y)
            call PanCameraToTimedForPlayer(GetOwningPlayer(GetBuyingUnit()),x,y,0.2)
            call DestroyEffect( AddSpecialEffect("Abilities\\Spells\\Human\\MassTeleport\\MassTeleportCaster.mdl", x, y))
            call DisplayTextToPlayer( GetOwningPlayer(GetBuyingUnit()), 0, 0, "|cFFFF66CC【消息】|r回去输入“HG”。" )
        endif
        //试练
        if ((GetItemTypeId(GetSoldItem()) == 'I06Q')) then
        	call StartShilian(GetOwningPlayer(GetBuyingUnit()),1)
        elseif ((GetItemTypeId(GetSoldItem()) == 'I06R')) then
        	call StartShilian(GetOwningPlayer(GetBuyingUnit()),2)
        elseif ((GetItemTypeId(GetSoldItem()) == 'I06S')) then
        	call StartShilian(GetOwningPlayer(GetBuyingUnit()),3)
        elseif ((GetItemTypeId(GetSoldItem()) == 'I06T')) then
        	call StartShilian(GetOwningPlayer(GetBuyingUnit()),4)
        elseif ((GetItemTypeId(GetSoldItem()) == 'I06U')) then
        	call StartShilian(GetOwningPlayer(GetBuyingUnit()),5)
        elseif ((GetItemTypeId(GetSoldItem()) == 'I06V')) then
        	call StartShilian(GetOwningPlayer(GetBuyingUnit()),6)
        elseif ((GetItemTypeId(GetSoldItem()) == 'I06W')) then
        	call StartShilian(GetOwningPlayer(GetBuyingUnit()),7)
        elseif ((GetItemTypeId(GetSoldItem()) == 'I06X')) then
        	call StartShilian(GetOwningPlayer(GetBuyingUnit()),8)
        elseif ((GetItemTypeId(GetSoldItem()) == 'I077')) then
        	call StartShilian(GetOwningPlayer(GetBuyingUnit()),9)
        endif
    endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    那个死亡后的者被动
	*/
	function ZheBeidong takes unit u returns nothing
		if (IShilianType[GetConvertedPlayerId(GetOwningPlayer(u))] == 2) then
			set IShilianTime[GetConvertedPlayerId(GetOwningPlayer(u))] = IShilianTime[GetConvertedPlayerId(GetOwningPlayer(u))] + 50
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    前字的成就
	*/
	function QianAchievement takes player p returns nothing
		if (GetUnitTypeId(GetKillingUnitBJ()) == 'N01Y' or (GetUnitTypeId(GetKillingUnitBJ()) == 'h02T' and GetUnitUserData(GetKillingUnitBJ()) == 1)) then
			set IQianAchievement[GetConvertedPlayerId(p)] = IQianAchievement[GetConvertedPlayerId(p)] + CModeH(1,2)
			if (IQianAchievement[GetConvertedPlayerId(p)] >= 6700) then
				debug call GetAchievementAndSave(p,422)
			elseif (ModuloInteger(IQianAchievement[GetConvertedPlayerId(p)],100) == 0) then
				call DisplayTextToPlayer(p, 0., 0., "|cFFFF66CC【前之痕】|r:"+I2S(IQianAchievement[GetConvertedPlayerId(p)]))
			endif
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    初始化
	*/
	private function InitShilian takes nothing returns nothing
		local trigger t = CreateTrigger()
		set UShilian = CreateUnit( Player(PLAYER_NEUTRAL_PASSIVE), 'n01T', -14272.0, -5440.0, 270.000 )
    	call TriggerRegisterPlayerEventEndCinematic( t, Player(0) )
    	call TriggerRegisterPlayerEventEndCinematic( t, Player(1) )
    	call TriggerRegisterPlayerEventEndCinematic( t, Player(2) )
    	call TriggerRegisterPlayerEventEndCinematic( t, Player(3) )
    	call TriggerRegisterPlayerEventEndCinematic( t, Player(4) )
    	call TriggerRegisterPlayerEventEndCinematic( t, Player(5) )
		call TriggerAddAction(t, function TDoubleEscAct)
        set t = CreateTrigger()
        call YDWETriggerRegisterLeaveRectSimpleNull( t, gg_rct_Chuancheng )
        call TriggerAddCondition(t, Condition(function TLeaveShilianCon))
        call TriggerAddAction(t, function TLeaveShilianAct)
		set t = null
	endfunction
endlibrary
///#include  "edit/NetVersion.j"
library_once Kuanghuan initializer InitKuanghuan requires LHBase,SpellBase,Shilian,Version
	globals
		private trigger TRedAttack = null
		private boolean array BKuanghuanRed
	endglobals
//---------------------------------------------------------------------------------------------------
	/*
	    红BUFF
	*/
	private function TRedAttackCon takes nothing returns boolean
		return (IKuanghuanType[GetConvertedPlayerId(GetOwningPlayer(GetAttackedUnitBJ()))] == 1 and GetAttackedUnitBJ() == udg_H[GetConvertedPlayerId(GetOwningPlayer(GetAttackedUnitBJ()))]) or (IKuanghuanType[GetConvertedPlayerId(GetOwningPlayer(GetAttacker()))] == 1 and GetAttacker() == udg_H[GetConvertedPlayerId(GetOwningPlayer(GetAttacker()))])
	endfunction
	private function TRedAttackAct takes nothing returns nothing
		local unit u = null
		if (IKuanghuanType[GetConvertedPlayerId(GetOwningPlayer(GetAttacker()))] == 1) then
			if not(BKuanghuanRed[GetConvertedPlayerId(GetOwningPlayer(GetAttacker()))]) then
				set u = GetAttacker()
				call DestroyEffect(AddSpecialEffect("war3mapImported\\FireNova2.mdl", GetUnitX(GetAttackedUnitBJ()),GetUnitY(GetAttackedUnitBJ()) ))
				call DamageArea(u,GetUnitX(GetAttackedUnitBJ()), GetUnitY(GetAttackedUnitBJ()),600,GetDamageBase(u) * 2	)
	    		call CreateSpellTextTag("红色泪殇——炎",u,100,0,0,4)
				set BKuanghuanRed[GetConvertedPlayerId(GetOwningPlayer(u))] = true
				call YDWEPolledWaitNull(3.0)
				set BKuanghuanRed[GetConvertedPlayerId(GetOwningPlayer(u))] = false
				set u = null
			endif
		else
			if not(BKuanghuanRed[GetConvertedPlayerId(GetOwningPlayer(GetAttackedUnitBJ()))]) then
				set u = GetAttackedUnitBJ()
				call RecoverUnitHP(u,0.6)
		    	call RecoverUnitMP(u,200)
 				call SimulateSpell(u,u,'A0NE',1,6,"stomp",false,true,false)
				call DestroyEffect(AddSpecialEffect("war3mapImported\\FrostNova2.mdl", GetUnitX(u),GetUnitY(u) ))
	    		call CreateSpellTextTag("红色泪殇——霜",u,0,0,80,4)
				set BKuanghuanRed[GetConvertedPlayerId(GetOwningPlayer(u))] = true
				call YDWEPolledWaitNull(3.0)
				set BKuanghuanRed[GetConvertedPlayerId(GetOwningPlayer(u))] = false
				set u = null
			endif
		endif
	endfunction
	private function InitRedColor takes player p returns nothing
		set IKuanghuanType[GetConvertedPlayerId(p)] = 1
		call CinematicFadeBJ( bj_CINEFADETYPE_FADEOUTIN, 3.00, "ReplaceableTextures\\CameraMasks\\White_mask.blp", 100.00, 0, 0, 0 )
		call PlaySoundBJ( gg_snd_fanzhuan )
		call BJDebugMsg("|cFFFF66CC【消息】|r"+GetPlayerName(p)+"获得了狂欢模式的|cffff0000【狂欢BUFF】红色泪殇|r.")
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    蓝色BUFF
	*/
	private function InitBlueColor takes player p returns nothing
		set IKuanghuanType[GetConvertedPlayerId(p)] = 2
		call UnitAddAbilityP(udg_H[GetConvertedPlayerId(p)],'A0NF')
		call SetPlayerAbilityAvailable(p,'A0NF',false)
		call CinematicFadeBJ( bj_CINEFADETYPE_FADEOUTIN, 3.00, "ReplaceableTextures\\CameraMasks\\White_mask.blp", 0, 0, 100.0, 0 )
		call PlaySoundBJ( gg_snd_fanzhuan )
		call BJDebugMsg("|cFFFF66CC【消息】|r"+GetPlayerName(p)+"获得了狂欢模式的|cff00ccff【狂欢BUFF】蓝焰轰影|r.")
		call AddXingUnit(udg_H[GetConvertedPlayerId(p)])
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    绿色
	*/
	function GiveGreenEggs takes nothing returns nothing
		local integer i = 1
		loop
			exitwhen i > 6
			if (IKuanghuanType[i] == 3) then
				call DisplayTextToPlayer(ConvertedPlayer(i), 0., 0., "|cFFFF66CC【消息】你获得了来自狂欢模式中每一波赠送的绿踪彩蛋.|r")
				call DisplayTextToPlayer(ConvertedPlayer(i), 0., 0., "|cFFFF66CC【消息】你获得了来自狂欢模式中每一波赠送的绿踪彩蛋.|r")
				call DisplayTextToPlayer(ConvertedPlayer(i), 0., 0., "|cFFFF66CC【消息】你获得了来自狂欢模式中每一波赠送的绿踪彩蛋.|r")
				call UnitAddItemByIdSwapped('I02U', udg_H[i])
		        call SaveInteger(YDHT,GetHandleId(GetLastCreatedItem()),0xA75AD423,i)
		        call PingMinimapForForce( YDWEGetForceOfPlayerNull(ConvertedPlayer(i)), GetUnitX(udg_H[i]),GetUnitY(udg_H[i]), 5.00 )
			endif
			set i = i +1
		endloop
	endfunction
	private function InitGreenColor takes player p returns nothing
		set IKuanghuanType[GetConvertedPlayerId(p)] = 3
		//call UnitAddItemByIdSwapped('I02U', udg_H[GetConvertedPlayerId(p)])
        //call SaveInteger(YDHT,GetHandleId(GetLastCreatedItem()),0xA75AD423,GetConvertedPlayerId(p))
		call CinematicFadeBJ( bj_CINEFADETYPE_FADEOUTIN, 3.00, "ReplaceableTextures\\CameraMasks\\White_mask.blp", 0, 100.0, 0, 0 )
		call PlaySoundBJ( gg_snd_fanzhuan )
		call BJDebugMsg("|cFFFF66CC【消息】|r"+GetPlayerName(p)+"获得了狂欢模式的|cff99cc00【狂欢BUFF】绿踪彩蛋|r.")
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    开局随机赠送并计时
	*/
	function GiveRandomEggs takes unit u returns nothing
		local integer pos = 0
		local integer i = 1
		loop
			exitwhen i > ModuloInteger(DzAPI_Map_GetGameStartTime(),23) + GetConvertedPlayerId(GetOwningPlayer(u)) + udg_Second[1] + udg_Nandu_JJJ
			set pos = GetRandomInt(1,3)
			set i = i +1
		endloop
		if (pos == 1) then
			call UnitAddItemByIdSwapped('I031', udg_H[GetConvertedPlayerId(GetOwningPlayer(u))])
			call ShowGameHint(GetOwningPlayer(u),"
			该模式是狂欢活动模式:
			你获得了随机的|cffff0000【狂欢BUFF】红色泪殇|r,
			注意查看你的背包,
			使用后将让你获得很强大的能力哦,
			快去试试吧!")
		elseif (pos == 2) then
			call UnitAddItemByIdSwapped('I02X', udg_H[GetConvertedPlayerId(GetOwningPlayer(u))])
			call ShowGameHint(GetOwningPlayer(u),"
			该模式是狂欢活动模式:
			你获得了随机的|cff00ccff【狂欢BUFF】蓝焰轰影|r,
			注意查看你的背包,
			使用后将让你获得很强大的能力哦,
			快去试试吧!")
		elseif (pos == 3) then
			call UnitAddItemByIdSwapped('I02V', udg_H[GetConvertedPlayerId(GetOwningPlayer(u))])
			call ShowGameHint(GetOwningPlayer(u),"
			该模式是狂欢活动模式:
			你获得了随机的|cff99cc00【狂欢BUFF】绿踪彩蛋|r,
			注意查看你的背包,
			使用后将让你获得很强大的能力哦,
			快去试试吧!")
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    决定你命运的颜色
	*/
	function ChooseBuffColor takes player p,integer t returns boolean
		if (t == 'I031') then
			call InitRedColor(p)
			return true
		elseif (t == 'I02X') then
			call InitBlueColor(p)
			return true
		elseif (t == 'I02V') then
			call InitGreenColor(p)
			return true
		endif
		return false
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    红BUFF
	*/
	private function InitKuanghuan takes nothing returns nothing
		set TRedAttack = CreateTrigger()
		call TriggerRegisterAnyUnitEventBJ(TRedAttack,EVENT_PLAYER_UNIT_ATTACKED)
		call TriggerAddCondition(TRedAttack, Condition(function TRedAttackCon))
		call TriggerAddAction(TRedAttack, function TRedAttackAct)
	endfunction
endlibrary
/*
    debug模式是网易模式
*/
library_once Achievement requires LHBase,ChallangerDZ
	globals
		integer array achiPage
		integer array achieve
		integer array achieve2
		integer array achieve3
		integer array achieve4
		effect array achiEff
		/*
		    是否有彩色皮肤
		*/
		integer array spin
		integer array spin2
		integer array spin3
		string array heroCountString
		//倾雪寒晶
		integer array Greward
	endglobals
//---------------------------------------------------------------------------------------------------
	/*
	    十转2
	*/
	function Int2Bin takes integer num returns string
		local string result = ""
		local integer mod = 0
		local integer number = num
		local integer i = 1
		loop
			exitwhen i > 31
			if (number == 0) then
				set result = "0" + result
			else
				set mod = ModuloInteger(number,2)
				set result = I2S(mod) + result
				set number = number / 2
			endif
			set i = i + 1
		endloop
		if (num < 0) then
			set result = "1" + result
		else
			set result = "0" + result
		endif
		return result
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    2转十
	*/
	function Bin2Int takes string bin returns integer
		local integer i = StringLength(bin)
		local integer result = 0
		local integer mi = 0
		if (i < 1) then
			return 0
		endif
		loop
			exitwhen i == 1
			set result = result + R2I(Pow(2,mi)) * S2I(SubStringBJ(bin,i,i))
			set mi = mi + 1
			set i = i - 1
		endloop
		if (S2I(SubStringBJ(bin,1,1)) == 1) then
			set result = result * -1
		endif
		return result
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    给二进制的某位设置为1
	*/
	function SetBinBit takes string bin,integer bit,boolean isOne returns string
		local string result
		local integer length = StringLength(bin)
		if (length < bit or bit <= 0) then
			return bin
		endif
		set result = SubStringBJ(bin,1,bit-1)
		if (isOne) then
			set result = result + "1"
		else
			set result = result + "0"
		endif
		return result + SubStringBJ(bin,bit+1,length)
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    给整数的某位直接设置成1
	*/
	function SetIntegerBit takes integer int,integer bit,boolean isOne returns integer
		return Bin2Int(SetBinBit(Int2Bin(int),bit,isOne))
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    获取整数的某位
	*/
	function GetIntegerBit takes integer int,integer bit returns integer
		return S2I(SubStringBJ(Int2Bin(int),bit,bit))
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    获取整数一共有几个1
	*/
	function GetIntegerHasOne takes integer num returns integer
		local integer result = 0
		local integer number = num
		local integer i = 1
		loop
			exitwhen i > 31
			set result = ModuloInteger(number,2) + result
			set number = number / 2
			set i = i + 1
		endloop
		if (num < 0) then
			set result = 1 + result
		endif
		return result
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    获取某个英雄使用次数
	*/
	function GetSpecifyHeroTimes takes player p,integer heroIndex returns integer
		if (heroIndex>0) then
			return S2I(SubStringBJ(heroCountString[GetConvertedPlayerId(p)],2*heroIndex -1,2*heroIndex))
		else
			return 0
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    获取最低使用次数英雄的次数的英雄（能使用的所有英雄）
	*/
	function GetLowerHeroCount takes player p,integer limit,integer number returns boolean
		local integer count = 0
		local integer i = 1
		loop
			exitwhen i > HERO_COUNT
			if (GetSpecifyHeroTimes(p,i) >= limit) then
				set count = count + 1
			endif
			set i = i +1
		endloop
		return count >= number
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    获取当前成就的类项
	*/
	private function GetAchievePage takes integer i returns integer
		return S2I(SubStringBJ(I2S(i),1,1))
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    获取当前成就的位数
	*/
	private function GetAchieveTarget takes integer i returns integer
		return S2I(SubStringBJ(I2S(i),2,StringLength(I2S(i))))
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    存档皮肤数据
	*/
	private function SaveSpinData takes player p returns nothing
		if (Bdudang[GetConvertedPlayerId(p)]) then
			call DzAPI_Map_StoreInteger( p, "spin", spin[GetConvertedPlayerId(p)] )
			call DzAPI_Map_StoreInteger( p, "spin2", spin2[GetConvertedPlayerId(p)] )
			call DzAPI_Map_StoreInteger( p, "spin3", spin3[GetConvertedPlayerId(p)] )
		else
			call DisplayTextToPlayer(p, 0., 0., "|cFFFF66CC【消息】|r本局游戏皮肤数据读取失败,请重新开始游戏.")
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    获取皮肤名字
	*/
	function GetSpecifySpin takes player p, integer page,integer index returns nothing
		local integer judge = 0
		if (page == 1) then
			set judge = spin[GetConvertedPlayerId(p)]
		elseif (page == 2) then
			set judge = spin2[GetConvertedPlayerId(p)]
		elseif (page == 3) then
			set judge = spin3[GetConvertedPlayerId(p)]
		endif
		if (CType != 0) then
			return
		endif
		if (GetBit(judge,index) < 1) then
			if (page == 1) then
				set spin[GetConvertedPlayerId(p)] = spin[GetConvertedPlayerId(p)] + R2I(Pow(10,index-1))
			elseif (page == 2) then
				set spin2[GetConvertedPlayerId(p)] = spin2[GetConvertedPlayerId(p)] + R2I(Pow(10,index-1))
			elseif (page == 3) then
				set spin3[GetConvertedPlayerId(p)] = spin3[GetConvertedPlayerId(p)] + R2I(Pow(10,index-1))
			endif
			call DisplayTextToPlayer(p, 0., 0., "|cFFFF66CC【消息】|r恭喜你成功获取皮肤\""+GetHeroChallenageName(index,page)+"\"！")
			call SaveSpinData(p)
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    指令获取皮肤
	*/
	function Huoquspin takes player p ,string chat returns nothing
		local integer i = 1
		local integer j = 1
		local integer result = 0
		loop
			exitwhen j > 3
			set i = 1
			loop
				exitwhen i > 10
				if (chat == I2S(GetCycleHash(playerName[GetConvertedPlayerId(p)]+"sp"+I2S(j)+I2S(i),1))) then
					call GetSpecifySpin(p,j,i)
					exitwhen true
				endif
				set i = i +1
			endloop
			set j = j +1
		endloop
		set BBuqian2 = false
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    瑟雨皮肤条件
	*/
	function GetSeyu1Spin takes player p returns boolean
		return GetBit(spin[GetConvertedPlayerId(p)],2)>0
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    瑟雨皮肤OK了
	*/
	function SetSeyuSpinOK takes player p returns nothing
		call GetSpecifySpin(p,1,2)
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    晓月皮肤条件
	*/
	function GetXiaoyue1Spin takes player p returns boolean
		return GetBit(spin[GetConvertedPlayerId(p)],3) > 0
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    晓月皮肤OK了
	*/
	function SetXiaoyueSpinOK takes player p returns nothing
		call GetSpecifySpin(p,1,3)
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    湮灭皮肤条件
	*/
	function GetYanmie1Spin takes player p returns boolean
		return GetBit(spin[GetConvertedPlayerId(p)],4) > 0
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    湮灭皮肤OK了
	*/
	function SetYanmieSpinOK takes player p returns nothing
		call GetSpecifySpin(p,1,4)
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    巫妖皮肤条件
	*/
	function GetXuanxue1Spin takes player p returns boolean
		return GetBit(spin[GetConvertedPlayerId(p)],5) > 0
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    巫妖皮肤OK了
	*/
	function SetXuanxue1SpinOK takes player p returns nothing
		call GetSpecifySpin(p,1,5)
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    白虎皮肤条件
	*/
	function GetTaiya1Spin takes player p returns boolean
		return GetBit(spin[GetConvertedPlayerId(p)],6) > 0
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    白虎皮肤OK了
	*/
	function SetTaiyaSpinOK takes player p returns nothing
		call GetSpecifySpin(p,1,6)
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    辰寂皮肤条件
	*/
	function GetChenji1Spin takes player p returns boolean
		return GetBit(spin[GetConvertedPlayerId(p)],7) > 0
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    辰寂皮肤OK了
	*/
	function SetChenji1SpinOK takes player p returns nothing
		call GetSpecifySpin(p,1,7)
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    寒殇皮肤条件
	*/
	function GetHanshang1Spin takes player p returns boolean
		return GetBit(spin[GetConvertedPlayerId(p)],8) > 0
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    寒殇皮肤OK了
	*/
	function SetHanshang1SpinOK takes player p returns nothing
		call GetSpecifySpin(p,1,8)
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    凌雪皮肤条件
	*/
	function GetLingxue1Spin takes player p returns boolean
		return GetBit(spin[GetConvertedPlayerId(p)],9) > 0
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    凌雪皮肤OK了
	*/
	function SetLingxueSpinOK takes player p returns nothing
		call GetSpecifySpin(p,1,9)
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    辰寂皮肤条件
	*/
	function GetChenji2Spin takes player p returns boolean
		return GetBit(spin[GetConvertedPlayerId(p)],10) > 0
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    辰寂皮肤OK了
	*/
	function SetChenji2SpinOK takes player p returns nothing
		call GetSpecifySpin(p,1,10)
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    莫琪皮肤条件
	*/
	function GetMoqiSpin takes player p returns boolean
		return GetBit(spin2[GetConvertedPlayerId(p)],1) > 0
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    莫琪皮肤OK了
	*/
	function SetMoqiSpinOK takes player p returns nothing
		call GetSpecifySpin(p,2,1)
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    凯撒皮肤条件
	*/
	function GetKaisaSpin takes player p returns boolean
		return GetBit(spin2[GetConvertedPlayerId(p)],2) > 0
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    凯撒皮肤OK了
	*/
	function SetKaisaSpinOK takes player p returns nothing
		call GetSpecifySpin(p,2,2)
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    玄雪皮肤条件
	*/
	function GetXuanxue2Spin takes player p returns boolean
		return GetBit(spin2[GetConvertedPlayerId(p)],3) > 0
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    玄雪皮肤OK了
	*/
	function SetXuanxue2SpinOK takes player p returns nothing
		call GetSpecifySpin(p,2,3)
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    摄焱皮肤条件
	*/
	function GetSheyan1Spin takes player p returns boolean
		return GetBit(spin2[GetConvertedPlayerId(p)],4) > 0
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    摄焱皮肤OK了
	*/
	function SetSheyanSpinOK takes player p returns nothing
		call GetSpecifySpin(p,2,4)
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    霸绝皮肤条件
	*/
	function GetBajue1Spin takes player p returns boolean
		return GetBit(spin2[GetConvertedPlayerId(p)],5) > 0
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    霸绝皮肤OK了
	*/
	function SetBajueSpinOK takes player p returns nothing
		call GetSpecifySpin(p,2,5)
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    幻逸皮肤条件
	*/
	function GetHuanyi1Spin takes player p returns boolean
		return GetBit(spin2[GetConvertedPlayerId(p)],6) > 0
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    幻逸皮肤OK了
	*/
	function SetHuanyiSpinOK takes player p returns nothing
		call GetSpecifySpin(p,2,6)
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    司宸皮肤条件
	*/
	function GetSichen1Spin takes player p returns boolean
		return GetBit(spin2[GetConvertedPlayerId(p)],7) > 0
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    司宸皮肤OK了
	*/
	function SetSichenSpinOK takes player p returns nothing
		call GetSpecifySpin(p,2,7)
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    苍凌皮肤条件
	*/
	function GetCangling1Spin takes player p returns boolean
		return GetBit(spin2[GetConvertedPlayerId(p)],8) > 0
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    苍凌皮肤OK了
	*/
	function SetCanglingSpinOK takes player p returns nothing
		call GetSpecifySpin(p,2,8)
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    黑阎皮肤条件
	*/
	function GetHeiyan1Spin takes player p returns boolean
		return GetBit(spin2[GetConvertedPlayerId(p)],9) > 0
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    黑阎皮肤OK了
	*/
	function SetHeiyanSpinOK takes player p returns nothing
		call GetSpecifySpin(p,2,9)
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    离魑皮肤条件
	*/
	function GetLichi1Spin takes player p returns boolean
		return GetBit(spin2[GetConvertedPlayerId(p)],10) > 0
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    离魑皮肤OK了
	*/
	function SetLichiSpinOK takes player p returns nothing
		call GetSpecifySpin(p,2,10)
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    寒殇皮肤条件
	*/
	function GetHanshang2Spin takes player p returns boolean
		return GetBit(spin3[GetConvertedPlayerId(p)],1) > 0
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    寒殇皮肤OK了
	*/
	function SetHanshang2SpinOK takes player p returns nothing
		call GetSpecifySpin(p,3,1)
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    星胧皮肤条件
	*/
	function GetXinglong1Spin takes player p returns boolean
		return GetBit(spin3[GetConvertedPlayerId(p)],2) > 0
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    星胧皮肤OK了
	*/
	function SetXinglong1SpinOK takes player p returns nothing
		call GetSpecifySpin(p,3,2)
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    获取成就索引条件是否满足了
	*/
	function IsAchieveOK takes player p,integer achieveID returns boolean
		local integer id = GetConvertedPlayerId(p)
		local integer page = GetAchievePage(achieveID)
		local integer target = GetAchieveTarget(achieveID)
		if (achieveID == 48) then
			return GetLowerHeroCount(p,99,HERO_COUNT)
		endif
		if (page == 1) then
			return (GetBit(achieve[id],target) > 0)
		elseif (page == 2) then
			return (GetIntegerBit(achieve2[id],target) >0)
		elseif (page == 3) then
			return (GetIntegerBit(achieve3[id],target) >0)
		elseif (page == 4) then
			return (GetIntegerBit(achieve4[id],target) >0)
		endif
		return false
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    是否全成就
	*/
	function IsQuanchengjiu takes player p returns boolean
		local boolean result = true
		local integer i = 11
		loop
			exitwhen i > 18
			set result = result and IsAchieveOK(p,i)
			set i = i +1
		endloop
		set i = 21
		loop
			exitwhen i > 29
			set result = result and IsAchieveOK(p,i)
			set i = i +1
		endloop
		set i = 210
		loop
			exitwhen i > 231
			set result = result and IsAchieveOK(p,i)
			set i = i +1
		endloop
		set i = 32
		loop
			exitwhen i > 39
			set result = result and IsAchieveOK(p,i)
			set i = i +1
		endloop
		set i = 310
		loop
			exitwhen i > 318
			set result = result and IsAchieveOK(p,i)
			set i = i +1
		endloop
		set i = 320
		loop
			exitwhen i > 331
			set result = result and IsAchieveOK(p,i)
			set i = i +1
		endloop
		set i = 43
		loop
			exitwhen i > 46
			set result = result and IsAchieveOK(p,i)
			set i = i +1
		endloop
		set result = result and IsAchieveOK(p,49)
		set i = 410
		loop
			exitwhen i > 417
			set result = result and IsAchieveOK(p,i)
			set i = i +1
		endloop
		set i = 421
		loop
			exitwhen i > 423
			set result = result and IsAchieveOK(p,i)
			set i = i +1
		endloop
		return result
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    初始成就名
	*/
	function SetAchievement takes player p,integer achieveID returns nothing
		local integer id = GetConvertedPlayerId(p)
		if (udg_H[id] == null) then
			return
		endif
		if (IsAchieveOK(p,achieveID)) then
			set achiPage[id] = achieveID
			//彩名
			if (IsAchieveColor(achieveID)) then
				call SetPlayerName(p, GetAchievementName(achieveID) + GetRandomColor() + playerName[id] + "|r")
			elseif (IsAchieveWhite(achieveID)) then
				call SetPlayerName(p, GetAchievementName(achieveID) + playerName[id])
			else
				call SetPlayerName(p, GetAchievementName(achieveID) + playerName[id] + "|r")
			endif
			//特效
			if (IsAchieveLight(achieveID)) then
				if (achiEff[id] != null) then
					call DestroyEffect(achiEff[id])
				endif
				set achiEff[id] = AddSpecialEffectTargetUnitBJ("origin",udg_H[id],"war3mapImported\\lunhuitexiao.mdl")
			endif
			call DzAPI_Map_Stat_SetStat( p, "achi", GetAchievementWhiteName(achieveID) )
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    存储成就指针
	*/
	function SaveAchievePointer takes player p returns nothing
		call DzAPI_Map_StoreInteger( p, "page", achiPage[GetConvertedPlayerId(p)] )
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    存储成就数据1
	*/
	function SaveAchieveData1 takes player p returns nothing
		call DzAPI_Map_StoreString( p, "achieve", I2S(achieve[GetConvertedPlayerId(p)]) )
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    存储成就数据2
	*/
	function SaveAchieveData2 takes player p returns nothing
		call DzAPI_Map_StoreInteger( p, "achieve2", achieve2[GetConvertedPlayerId(p)] )
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    存储成就数据3
	*/
	function SaveAchieveData3 takes player p returns nothing
		call DzAPI_Map_StoreInteger( p, "achieve3", achieve3[GetConvertedPlayerId(p)] )
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    存储成就数据3
	*/
	function SaveAchieveData4 takes player p returns nothing
		call DzAPI_Map_StoreInteger( p, "achieve4", achieve4[GetConvertedPlayerId(p)] )
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    提示获取数据成功并保存数据
	*/
	function GetAchievementAndSave takes player p , integer achieveID returns nothing
		local integer id = GetConvertedPlayerId(p)
		if (udg_H[id] == null) then
			return
		endif
		//两个仅有的挑战成就
		if ((achieveID == 410 or achieveID == 411 /*or achieveID == 418 or achieveID == 420*/) and CType == 0) then
			return
		endif
		if (achieveID != 410 and achieveID != 411 and CType > 0) then
			return
		endif
		if (achieveID != 418 and achieveID != 420 and CType == -1) then
			return
		endif
		//两个超级成就
		if not(IsAchieveOK(p,achieveID)) then
			if (GetAchievePage(achieveID) == 1) then
				set achieve[id] = achieve[id] + R2I(Pow(10,I2R(achieveID-11)))
			elseif (GetAchievePage(achieveID) == 2) then
				set achieve2[id] = SetIntegerBit(achieve2[id],GetAchieveTarget(achieveID),true)
			elseif (GetAchievePage(achieveID) == 3) then
				set achieve3[id] = SetIntegerBit(achieve3[id],GetAchieveTarget(achieveID),true)
			elseif (GetAchievePage(achieveID) == 4) then
				set achieve4[id] = SetIntegerBit(achieve4[id],GetAchieveTarget(achieveID),true)
			endif
			call DisplayTextToPlayer(p, 0., 0., "|cFFFF66CC【消息】|r恭喜你获得成就\""+GetAchievementName(achieveID)+"|r\",该成就会显示在游戏大厅内及你的名字前面.")
		    call SetAchievement(p,achieveID)
			call SaveAchieveData1(p)
			call SaveAchieveData2(p)
			call SaveAchieveData3(p)
			call SaveAchieveData4(p)
		    call SaveAchievePointer(p)
			call DisplayTextToPlayer(p, 0., 0., "|cFFFF66CC【消息】|r如果你想使用其他的成就，请输入\"-cj\"来切换你的现有成就。")
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    创建成就对话框
	*/
	function NextPageAchievement takes player p, dialog d , integer page returns nothing
	    local integer i = 1
		if (page == 1) then
		    loop
		    	exitwhen i > 8
		    	call SaveButtonHandle(LHTable,GetHandleId(d),i,DialogAddButtonBJ( d, GetAchievementName(i + 10) + S3(IsAchieveOK(p,i + 10),"|cffff9900(已解锁)|r","|cff33cccc(未解锁)|r")))
		    	set i = i + 1
		    endloop
	    	call SaveButtonHandle(LHTable,GetHandleId(d),9,DialogAddButtonBJ( d, GetAchievementName(325) + S3(IsAchieveOK(p,325),"|cffff9900(已解锁)|r","|cff33cccc(未解锁)|r")))
		elseif (page == 2) then
		    loop
		    	exitwhen i > 8
		    	call SaveButtonHandle(LHTable,GetHandleId(d),i,DialogAddButtonBJ( d, GetAchievementName(i + 20) + S3(IsAchieveOK(p,i + 20),"|cffff9900(已解锁)|r","|cff33cccc(未解锁)|r")))
		    	set i = i + 1
		    endloop
		elseif (page == 3) then
		    loop
		    	exitwhen i > 7
		    	call SaveButtonHandle(LHTable,GetHandleId(d),i,DialogAddButtonBJ( d, GetAchievementName(217 - i) + S3(IsAchieveOK(p,217 - i),"|cffff9900(已解锁)|r","|cff33cccc(未解锁)|r")))
		    	set i = i + 1
		    endloop
	    	call SaveButtonHandle(LHTable,GetHandleId(d),8,DialogAddButtonBJ( d, GetAchievementName(29) + S3(IsAchieveOK(p,29),"|cffff9900(已解锁)|r","|cff33cccc(未解锁)|r")))
		elseif (page == 4) then
		    loop
		    	exitwhen i > 8
		    	call SaveButtonHandle(LHTable,GetHandleId(d),i,DialogAddButtonBJ( d, GetAchievementName(i + 216) + S3(IsAchieveOK(p,i + 216),"|cffff9900(已解锁)|r","|cff33cccc(未解锁)|r")))
		    	set i = i + 1
		    endloop
		elseif (page == 5) then
		    loop
		    	exitwhen i > 7
		    	call SaveButtonHandle(LHTable,GetHandleId(d),i,DialogAddButtonBJ( d, GetAchievementName(i + 224) + S3(IsAchieveOK(p,i + 224),"|cffff9900(已解锁)|r","|cff33cccc(未解锁)|r")))
		    	set i = i + 1
		    endloop
	    	call SaveButtonHandle(LHTable,GetHandleId(d),8,DialogAddButtonBJ( d, GetAchievementName(310) + S3(IsAchieveOK(p,310),"|cffff9900(已解锁)|r","|cff33cccc(未解锁)|r")))
		elseif (page == 6) then
		    loop
		    	exitwhen i > 8
		    	call SaveButtonHandle(LHTable,GetHandleId(d),i,DialogAddButtonBJ( d, GetAchievementName(i + 31) + S3(IsAchieveOK(p,i + 31),"|cffff9900(已解锁)|r","|cff33cccc(未解锁)|r")))
		    	set i = i + 1
		    endloop
		elseif (page == 7) then
		    loop
		    	exitwhen i > 8
		    	call SaveButtonHandle(LHTable,GetHandleId(d),i,DialogAddButtonBJ( d, GetAchievementName(i + 310) + S3(IsAchieveOK(p,i + 310),"|cffff9900(已解锁)|r","|cff33cccc(未解锁)|r")))
		    	set i = i + 1
		    endloop
		elseif (page == 8) then
	    	call SaveButtonHandle(LHTable,GetHandleId(d),1,DialogAddButtonBJ( d, GetAchievementName(326) + S3(IsAchieveOK(p,326),"|cffff9900(已解锁)|r","|cff33cccc(未解锁)|r")))
			set i = 2
		    loop
		    	exitwhen i > 6
		    	call SaveButtonHandle(LHTable,GetHandleId(d),i,DialogAddButtonBJ( d, GetAchievementName(i + 318) + S3(IsAchieveOK(p,i + 318),"|cffff9900(已解锁)|r","|cff33cccc(未解锁)|r")))
		    	set i = i + 1
		    endloop
    	    	call SaveButtonHandle(LHTable,GetHandleId(d),7,DialogAddButtonBJ( d, GetAchievementName(327) + S3(IsAchieveOK(p,327),"|cffff9900(已解锁)|r","|cff33cccc(未解锁)|r")))
		elseif (page == 9) then
			set i = 1
		    loop
		    	exitwhen i > 4
		    	call SaveButtonHandle(LHTable,GetHandleId(d),i,DialogAddButtonBJ( d, GetAchievementName(i + 327) + S3(IsAchieveOK(p,i + 327),"|cffff9900(已解锁)|r","|cff33cccc(未解锁)|r")))
		    	set i = i + 1
		    endloop
			set i = 5
		    loop
		    	exitwhen i > 8
		    	call SaveButtonHandle(LHTable,GetHandleId(d),i,DialogAddButtonBJ( d, GetAchievementName(i + 38) + S3(IsAchieveOK(p,i + 38),"|cffff9900(已解锁)|r","|cff33cccc(未解锁)|r")))
		    	set i = i + 1
		    endloop
		elseif (page == 10) then
	    	call SaveButtonHandle(LHTable,GetHandleId(d),1,DialogAddButtonBJ( d, GetAchievementName(49) + S3(IsAchieveOK(p,49),"|cffff9900(已解锁)|r","|cff33cccc(未解锁)|r")))
			set i = 2
		    loop
		    	exitwhen i > 9
		    	call SaveButtonHandle(LHTable,GetHandleId(d),i,DialogAddButtonBJ( d, GetAchievementName(i + 408) + S3(IsAchieveOK(p,i + 408),"|cffff9900(已解锁)|r","|cff33cccc(未解锁)|r")))
		    	set i = i + 1
		    endloop
		elseif (page == 11) then
			set i = 1
		    loop
		    	exitwhen i > 3
		    	call SaveButtonHandle(LHTable,GetHandleId(d),i,DialogAddButtonBJ( d, GetAchievementName(i + 420) + S3(IsAchieveOK(p,i + 420),"|cffff9900(已解锁)|r","|cff33cccc(未解锁)|r")))
		    	set i = i + 1
		    endloop
		endif
    	call SaveButtonHandle(LHTable,GetHandleId(d),17,DialogAddButtonBJ( d, "上一页"))
    	call SaveButtonHandle(LHTable,GetHandleId(d),10,DialogAddButtonBJ( d, "下一页"))
    	call SaveButtonHandle(LHTable,GetHandleId(d),11,DialogAddButton( d, "关闭|cffff6800(Esc)|r",512))
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    创建英雄挑战对话框
	*/
	function CreateHeroDialogContent takes player p, dialog d,integer page returns nothing
		local integer i = 1
		if (page == 1) then
			set i = 2
			loop
				exitwhen i > 10
				call SaveButtonHandle(LHTable,GetHandleId(d),i,DialogAddButtonBJ( d, GetHeroChallenageName(i,1) + S3(GetBit(spin[GetConvertedPlayerId(p)],i)>0,"|cffff9900(已完成)|r","|cff33cccc(未完成)|r")))
				set i = i +1
			endloop
		elseif (page == 2) then
			set i = 1
			loop
				exitwhen i > 10
				call SaveButtonHandle(LHTable,GetHandleId(d),i,DialogAddButtonBJ( d, GetHeroChallenageName(i,2) + S3(GetBit(spin2[GetConvertedPlayerId(p)],i)>0,"|cffff9900(已完成)|r","|cff33cccc(未完成)|r")))
				set i = i +1
			endloop
		elseif (page == 3) then
			set i = 1
			loop
				exitwhen i > 2
				call SaveButtonHandle(LHTable,GetHandleId(d),i,DialogAddButtonBJ( d, GetHeroChallenageName(i,3) + S3(GetBit(spin3[GetConvertedPlayerId(p)],i)>0,"|cffff9900(已完成)|r","|cff33cccc(未完成)|r")))
				set i = i +1
			endloop
		endif
    	call SaveButtonHandle(LHTable,GetHandleId(d),14,DialogAddButtonBJ( d, "下一页"))
    	call SaveButtonHandle(LHTable,GetHandleId(d),11,DialogAddButton( d, "关闭|cffff6800(Esc)|r",512))
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    创建超级成就对话框
	*/
	function CreateSuperDialogContent takes player p,dialog d returns nothing
		call SaveButtonHandle(LHTable,GetHandleId(d),1,DialogAddButtonBJ( d, GetSuperChallenageName(1) + S3(IsQuanchengjiu(p),"|cffff9900(已完成)|r","|cff33cccc(未完成)|r")))
		call SaveButtonHandle(LHTable,GetHandleId(d),2,DialogAddButtonBJ( d, GetSuperChallenageName(2) + S3(IsAchieveOK(p,42),"|cffff9900(已完成)|r","|cff33cccc(未完成)|r")))
		call SaveButtonHandle(LHTable,GetHandleId(d),3,DialogAddButtonBJ( d, GetSuperChallenageName(3) + S3(IsAchieveOK(p,47),"|cffff9900(已完成)|r","|cff33cccc(未完成)|r")))
		call SaveButtonHandle(LHTable,GetHandleId(d),4,DialogAddButtonBJ( d, GetSuperChallenageName(4) + S3(GetLowerHeroCount(p,99,HERO_COUNT),"|cffff9900(已完成)|r","|cff33cccc(未完成)|r")))
		call SaveButtonHandle(LHTable,GetHandleId(d),5,DialogAddButtonBJ( d, GetSuperChallenageName(5) + S3(IsAchieveOK(p,418),"|cffff9900(已完成)|r","|cff33cccc(未完成)|r")))
		call SaveButtonHandle(LHTable,GetHandleId(d),6,DialogAddButtonBJ( d, GetSuperChallenageName(6) + S3(IsAchieveOK(p,420),"|cffff9900(已完成)|r","|cff33cccc(未完成)|r")))
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    成就对话框点击事件
	*/
	function AchievementDialogClick takes nothing returns nothing
		local dialog d = GetClickedDialogBJ()
	    local integer i = 1
	    local integer page = LoadInteger(LHTable,GetHandleId(d),12)
	    local player p = LoadPlayerHandle(LHTable,GetHandleId(d),13)
	    local integer achieveID = LoadInteger(LHTable,GetHandleId(d),14)
        //查看条件与设置
	    if (GetClickedButtonBJ() == LoadButtonHandle(LHTable,GetHandleId(d),15)) then
	    	call DisplayTextToPlayer(p, 0., 0., "|cFFFF66CC【消息】|r" + GetAchievementName(achieveID) + "|r成就的获取条件如下所示:")
	    	call DisplayTextToPlayer(p, 0., 0., GetAchievementCondition(achieveID))
	    elseif (GetClickedButtonBJ() == LoadButtonHandle(LHTable,GetHandleId(d),16)) then
	    	call SetAchievement(p,achieveID)
	    	call DisplayTextToPlayer(p, 0., 0., "|cFFFF66CC【消息】|r你成功地将成就设置成了"+GetAchievementName(achieveID)+".")
	    	//保存到服务器
	    	call SaveAchievePointer(p)
	    endif
	    //退出
	    if ((GetClickedButtonBJ() == LoadButtonHandle(LHTable,GetHandleId(d),11)) or (GetClickedButtonBJ() == LoadButtonHandle(LHTable,GetHandleId(d),15)) or (GetClickedButtonBJ() == LoadButtonHandle(LHTable,GetHandleId(d),16))) then
            call DialogClear(d)
	        call FlushChildHashtable(LHTable,GetHandleId(d))
        	call DialogDisplay( p, d, false )
	        call DialogDestroy(d)
	        set d = null
	        set p = null
	        call DestroyTrigger(GetTriggeringTrigger())
	        return
	    endif
	    //下一页
	    if (GetClickedButtonBJ() == LoadButtonHandle(LHTable,GetHandleId(d),10)) then
            call DialogClear(d)
	    	set page = I3(page < PAGE_ACHIEVE,page + 1,1)
    		call SaveInteger(LHTable,GetHandleId(d),12,page)
	    	call DialogSetMessage( d, "我的成就|cffff6800(第"+I2S(page)+"/"+I2S(PAGE_ACHIEVE)+"页)|r
	    		收集全部成就可以自定义成就名" )
	    	call NextPageAchievement(p,d,page)
        	call DialogDisplay( p, d, true )
		    set d = null
		    set p = null
	    	return
	    endif
	    //上一页
	    if (GetClickedButtonBJ() == LoadButtonHandle(LHTable,GetHandleId(d),17)) then
            call DialogClear(d)
	    	set page = I3(page <= 1,PAGE_ACHIEVE,page - 1)
    		call SaveInteger(LHTable,GetHandleId(d),12,page)
	    	call DialogSetMessage( d, "我的成就|cffff6800(第"+I2S(page)+"/"+I2S(PAGE_ACHIEVE)+"页)|r
	    		收集全部成就可以自定义成就名" )
	    	call NextPageAchievement(p,d,page)
        	call DialogDisplay( p, d, true )
		    set d = null
		    set p = null
	    	return
	    endif
	    //点击指定的成就
	    loop
	        exitwhen i > 9
	        if (GetClickedButtonBJ() == LoadButtonHandle(LHTable,GetHandleId(d),i)) then
                call DialogClear(d)
	        	set achieveID = GetAchievementIndex(page,i)
	    		call SaveInteger(LHTable,GetHandleId(d),14,achieveID)
	    		call DialogSetMessage( d, GetAchievementName(achieveID) + S3(IsAchieveOK(p,achieveID),"|cffff9900(已解锁)|r","|cff33cccc(未解锁)|r") )
		    	call SaveButtonHandle(LHTable,GetHandleId(d),15,DialogAddButtonBJ( d, "查看获取条件"))
		    	if (IsAchieveOK(p,achieveID)) then
		    		call SaveButtonHandle(LHTable,GetHandleId(d),16,DialogAddButtonBJ( d, "使用该成就"))
		    	endif
		    	call SaveButtonHandle(LHTable,GetHandleId(d),11,DialogAddButton( d, "关闭|cffff6800(Esc)|r",512))
	            exitwhen true
	        endif
	        set i = i +1
	    endloop
        call DialogDisplay( p, d, true )
	    set d = null
	    set p = null
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    英雄挑战对话框
	*/
	function HeroDialogClick takes nothing returns nothing
		local dialog d = GetClickedDialogBJ()
	    local player p = LoadPlayerHandle(LHTable,GetHandleId(d),13)
	    local integer page = LoadInteger(LHTable,GetHandleId(d),12)
		local integer i = 1
	    //退出
	    if (GetClickedButtonBJ() == LoadButtonHandle(LHTable,GetHandleId(d),11)) then
            call DialogClear(d)
	        call FlushChildHashtable(LHTable,GetHandleId(d))
        	call DialogDisplay( p, d, false )
	        call DialogDestroy(d)
	        set d = null
	        set p = null
	        call DestroyTrigger(GetTriggeringTrigger())
	        return
	    endif
	    //下一页
	    if (GetClickedButtonBJ() == LoadButtonHandle(LHTable,GetHandleId(d),14)) then
            call DialogClear(d)
	    	set page = I3(page < PAGE_HERO_CHALLANGER,page + 1,1)
	    	call DialogSetMessage( d, "英雄挑战|cffff6800(第"+I2S(page)+"/"+I2S(PAGE_HERO_CHALLANGER)+"页)|r" )
    		call SaveInteger(LHTable,GetHandleId(d),12,page)
	    	call CreateHeroDialogContent(p,d,page)
        	call DialogDisplay( p, d, true )
		    set d = null
		    set p = null
	    	return
	    endif
	    //点击
	    loop
	        exitwhen i > 10
	        if (GetClickedButtonBJ() == LoadButtonHandle(LHTable,GetHandleId(d),i)) then
                call DialogClear(d)
		    	call DisplayTextToPlayer(p, 0., 0., "|cFFFF66CC【消息】|r" + GetHeroChallenageName(i,page) + "|r英雄挑战的条件如下所示:")
		    	call DisplayTextToPlayer(p, 0., 0., GetHeroChallenageContent(i,page))
	            exitwhen true
	        endif
	        set i = i +1
	    endloop
        call DialogClear(d)
        call FlushChildHashtable(LHTable,GetHandleId(d))
    	call DialogDisplay( p, d, false )
        call DialogDestroy(d)
        set d = null
        set p = null
        call DestroyTrigger(GetTriggeringTrigger())
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    超级成就对话框
	*/
	function SuperAchievementClick takes nothing returns nothing
		local dialog d = GetClickedDialogBJ()
	    local player p = LoadPlayerHandle(LHTable,GetHandleId(d),13)
		local integer i = 1
	    loop
	        exitwhen i > 9
	        if (GetClickedButtonBJ() == LoadButtonHandle(LHTable,GetHandleId(d),i)) then
                call DialogClear(d)
		    	call DisplayTextToPlayer(p, 0., 0., "|cFFFF66CC【消息】|r" + GetSuperChallenageName(i) + "|r超级成就的完成条件如下所示:")
		    	call DisplayTextToPlayer(p, 0., 0., GetSuperChallenageContent(i))
		    	if (i == 2) then
	    			call SetAchievement(p,42)
	    			call SaveAchievePointer(p)
		    	elseif (i == 3) then
	    			call SetAchievement(p,47)
	    			call SaveAchievePointer(p)
		    	elseif (i == 4) then
	    			call SetAchievement(p,48)
	    			call SaveAchievePointer(p)
		    	elseif (i == 5) then
	    			call SetAchievement(p,418)
	    			call SaveAchievePointer(p)
		    	elseif (i == 6) then
	    			call SetAchievement(p,420)
	    			call SaveAchievePointer(p)
		    	endif
	            exitwhen true
	        endif
	        set i = i +1
	    endloop
        call DialogClear(d)
        call FlushChildHashtable(LHTable,GetHandleId(d))
    	call DialogDisplay( p, d, false )
        call DialogDestroy(d)
        set d = null
        set p = null
        call DestroyTrigger(GetTriggeringTrigger())
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    创建一个成就对话框给玩家
	*/
	function CreateAchievementDialog takes player p returns nothing
	    local trigger t = CreateTrigger()
	    local dialog d = DialogCreate()
	    call DialogSetMessage( d, "我的成就|cffff6800(第1/"+I2S(PAGE_ACHIEVE)+"页)|r
	    	收集全部成就可以自定义成就名" )
	    call NextPageAchievement(p,d,1)
    	call SaveButtonHandle(LHTable,GetHandleId(d),15,null)
    	call SaveButtonHandle(LHTable,GetHandleId(d),16,null)
    	call SaveInteger(LHTable,GetHandleId(d),12,1)
	    call SavePlayerHandle(LHTable,GetHandleId(d),13,p)
	    call SaveInteger(LHTable,GetHandleId(d),14,10)
	    call DialogDisplay( p, d, true )
	    call TriggerRegisterDialogEvent( t, d )
	    call TriggerAddAction(t, function AchievementDialogClick)
	    set d = null
	    set t = null
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    创建一个英雄挑战对话框给玩家
	*/
	function CreateHeroChallenagerDialog takes player p returns nothing
		local trigger t = CreateTrigger()
	    local dialog d = DialogCreate()
	    call DialogSetMessage( d, "英雄挑战|cffff6800(第1/"+I2S(PAGE_HERO_CHALLANGER)+"页)|r" )
	    call CreateHeroDialogContent(p,d,1)
	    call SavePlayerHandle(LHTable,GetHandleId(d),13,p)
	    call SaveInteger(LHTable,GetHandleId(d),12,1)
	    call DialogDisplay( p, d, true )
	    call TriggerRegisterDialogEvent( t, d )
	    call TriggerAddAction(t, function HeroDialogClick)
	    set d = null
	    set t = null
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    创建一个超级成就对话框给玩家
	*/
	function CreateSuperAchievementDialog takes player p returns nothing
		local trigger t = CreateTrigger()
	    local dialog d = DialogCreate()
	    call DialogSetMessage( d, "超级成就" )
	    call CreateSuperDialogContent(p,d)
	    call SavePlayerHandle(LHTable,GetHandleId(d),13,p)
	    call DialogDisplay( p, d, true )
	    call TriggerRegisterDialogEvent( t, d )
	    call TriggerAddAction(t, function SuperAchievementClick)
	    set d = null
	    set t = null
	endfunction
endlibrary
library_once Huodong requires LHBase,Achievement
	globals
		integer IKuanghuan = 0
	endglobals
//---------------------------------------------------------------------------------------------------
	/*
	    限时活动6:12-23
	*/
	function IsHuodong7 takes nothing returns boolean
		//return true
		return ((DzAPI_Map_GetGameStartTime()/10) > 149978880) and ((DzAPI_Map_GetGameStartTime()/10) < 150315840)
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    嘉年华活动:
	*/
	function IsJianianhua takes nothing returns boolean
		return true
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    狂欢模式活动:
	*/
	function IsKuanghuanTime takes nothing returns boolean
		return IKuanghuan == 1
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    天魇难度的开启条件
	*/
	function IsTianyanOK takes nothing returns boolean
		return IsAchieveOK(Player(0),325)
	endfunction
endlibrary
library_once Diffculty requires LHBase,Huodong,ChallangerMode//,Kuanghuan
	globals
		/*
		    地狱1,末日2,轮回万劫3
		*/
		integer NanDiff = 0
		unit UWanjieGuanghuan = null
		boolean IsTianyan = false
	endglobals
//---------------------------------------------------------------------------------------------------
	/*
	    获取当前难度序号
	*/
	function GetDiffculty takes nothing returns integer
		if (udg_Nandu_JJJ > 7) then
			return 9
		elseif (udg_Nandu > 20) then
			return 8
		elseif (udg_Nandu > 10) then
			return 7
		elseif (udg_Nandu > 8) then
			return 6
		elseif (udg_Nandu > 6) then
			return 5
		elseif (udg_Nandu > 4) then
			return 4
		elseif (udg_Nandu > 2) then
			return 3
		elseif (udg_Nandu > 1) then
			return 2
		else
			return 1
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    创建镜像单位
	*/
	function CreateJingongguai takes integer unitType,real facing returns nothing
		local integer id
		if (CT5()) then
			set id = GetNextPlayerID()
	    	call CreateNUnitsAtLoc( 1, GetUnitTypeId(udg_H[id]), Player(11), udg_Point, facing )
	    	call SetUnitMirror(GetLastCreatedUnit(),udg_H[id],I3(udg_Bo == 1 ,1,udg_Bo*GetDiffculty()))
	    	call GroupAddUnit(GJingxiang,GetLastCreatedUnit())
		else
	    	call CreateNUnitsAtLoc( 1, unitType, Player(11), udg_Point, facing )
		endif
	endfunction
	/*
	    判断当前难度是否是万劫
	*/
	function IsWanjie takes nothing returns boolean
		return GetDiffculty() == 9
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    加强攻击力
	*/
	function EnhanceDiffAttack takes unit u returns nothing
		if (NanDiff <= 0) then
			return
		endif
		if (IsTianyan) then
			call UnitAddAbility(u,'A0G5')
		endif
		//100倍攻击加强
		if (GetUnitAbilityLevel(u,'A09V') >= 1) then
			call SetUnitAbilityLevel(u,'A09V',NanDiff + 1)
			return
		endif
		call UnitAddAbility(u,'A0EY')
		call SetUnitAbilityLevel(u,'A0EY',NanDiff)
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    天魇难度加强魔抗
	*/
	function AddTianyanmokang takes unit u returns nothing
		if (IsTianyan) then
			 call UnitAddAbility(u,'A09G')
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    移除技能
	*/
	function RemoveDiffAttack takes unit u returns nothing
		if (GetUnitAbilityLevel(u,'A09V') >= 1) then
			call SetUnitAbilityLevel(u,'A09V',1)
		endif
		call UnitRemoveAbility(u,'A0EY')
		call UnitRemoveAbility(u,'A05O')
		call UnitRemoveAbility(u,'A0G5')
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    万劫的加强攻击力
	*/
	function EnhanceWanjieAttack takes unit u returns nothing
		if(IsWanjie()) then
			call EnhanceDiffAttack(u)
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    直接A基地
	*/
	function AttackBase takes unit u returns nothing
		if (IsTianyan and GetUnitTypeId(u) == 'hrif') then
			call IssueTargetOrder(u,"attack",gg_unit_haro_0030)
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    获取巨能对应等级的科技
	*/
	function GetJunengTech takes nothing returns integer
		if (NanDiff == 1) then
			return 'R00T'
		elseif (NanDiff == 2) then
			return 'R00U'
		elseif (NanDiff == 3) then
			return 'R00V'
		else
			return 'R00R'
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    获取混沌对应等级的科技
	*/
	function GetHundunTech takes nothing returns integer
		if (NanDiff == 1) then
			return 'R01H'
		elseif (NanDiff == 2) then
			return 'R01I'
		elseif (NanDiff == 3) then
			return 'R01J'
		else
			return 'R01G'
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    获取混沌2对应等级的科技
	*/
	function GetHundun2Tech takes nothing returns integer
		if (NanDiff == 1) then
			return 'R01M'
		elseif (NanDiff == 2) then
			return 'R01N'
		elseif (NanDiff == 3) then
			return 'R01O'
		else
			return 'R01P'
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    获取禁用技能的时间
	*/
	function GetForbidTianfuTime takes nothing returns real
		if (GetDiffculty() >= 9) then
			return 9.5
		elseif (GetDiffculty() >= 8) then
			return 7.5
		else
			return 5.
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    获取擂台升级的速度
	*/
	function GetArenaUpdateSpeed takes nothing returns real
		if (NanDiff == 1) then
			return 4.
		elseif (NanDiff == 2) then
			return 3.
		elseif (NanDiff == 3) then
			return 2.
		else
			return 5.
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    万劫数据才value*rate
	*/
	function GetWanjieInt takes integer value,real rate returns integer
		if(IsWanjie()) then
			return IMinBJ(2100000000,R2I(I2R(value) * rate))
		endif
		return value
	endfunction
	/*
	    万劫数据才value*rate，实数版
	*/
	function GetWanjieReal takes real value ,real rate returns real
		if (IsWanjie()) then
			return value * rate
		endif
		return value
	endfunction
	/*
	    万劫数据才value + add
	*/
	function GetWanjieAddInt takes integer value,integer add returns integer
		if (IsWanjie()) then
			return value + add
		endif
		return value
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    万劫给怪物加闪烁技能，波数11波后60倍攻击
	*/
	function AddWanjieSpell takes unit u returns nothing
		if (IsWanjie()) then
			if (udg_Bo > 10) then
				//60倍技能
				call UnitAddAbility(u,'A0GL')
			endif
			//闪烁技能
			call UnitAddAbility(u,'ANbl')
			call UnitAddAbility(u,'A0HE')
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    地狱难度的数据提示
	*/
	function PrintDifficulty takes nothing returns nothing
		local integer d = GetDiffculty()
		if (d == 6) then
			call BJDebugMsg("|cFFFF66CC【消息】|r地狱难度下，会额外提高以下怪物的难度：")
			call BJDebugMsg("|cFFFF66CC【消息】|r炼狱30+层、宝石区怪物和翅膀区伤害提高100%,生命提高66%.")
		elseif (d == 7) then
			call BJDebugMsg("|cFFFF66CC【消息】|r|cffff0000末日|r难度下，会额外提高以下怪物的难度：")
			call BJDebugMsg("|cFFFF66CC【消息】|r炼狱30+层、宝石区怪物和翅膀区伤害提高200%,生命提高133%.")
		elseif (d == 8) then
			call BJDebugMsg("|cFFFF66CC【消息】|r|cffff00ff轮回|r难度下，会额外提高以下怪物的难度：")
			call BJDebugMsg("|cFFFF66CC【消息】|r炼狱30+层、宝石区怪物和翅膀区伤害提高300%,有几率无视闪避,生命提高200%.")
		elseif (d == 9) then
			call BJDebugMsg("|cFFFF66CC【消息】|r|cff008000万劫|r难度下，会额外提高以下怪物的难度：")
			call BJDebugMsg("|cFFFF66CC【消息】|r炼狱30+层、宝石区怪物和翅膀区伤害提高300%,有几率无视闪避,生命提高200%.")
			call BJDebugMsg("|cFFFF66CC【消息】|r炼狱前30层与天庭均会增强同上属性.")
			call BJDebugMsg("|cFFFF66CC【消息】|r所有单位增加50%基础防御,所有非英雄单位增加2%生命回复速度.")
			call BJDebugMsg("|cFFFF66CC【消息】|r野怪每次升级会升3级.")
			call BJDebugMsg("|cFFFF66CC【消息】|r进攻怪获得技能\"闪烁\",10波以后怪物提高20倍生命与20倍攻击.")
			call BJDebugMsg("|cFFFF66CC【消息】|r熊猫与大法BOSS提高50倍生命与20倍生命.")
			call BJDebugMsg("|cFFFF66CC【消息】|r英雄获得经验减少25%.")
			call BJDebugMsg("|cFFFF66CC【消息】|r通关该难度可以加轮回之狱主群把你名字永久保存在|cff99cc00封帝万劫录|r中哦!")
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    初始化万劫难度
	*/
	function InitWanjie takes nothing returns nothing
		//光环（加防和回血）
    	set UWanjieGuanghuan = CreateUnit(Player(10),'h00U',0,0,0)
    	if (IsTianyan) then
    		call SetUnitAbilityLevel(UWanjieGuanghuan,'A0HD',2)
    		call UnitAddAbility(UWanjieGuanghuan,'A0JJ')
    	endif
    	call ShowUnitHide(UWanjieGuanghuan)
		//前三野与前30层科技 3倍生命
    	call SetPlayerTechResearchedSwap( 'R00X', 1 , Player(10))
    	call SetPlayerTechResearchedSwap( 'R00X', 1 , Player(11))
    	//11-24波怪物，10倍生命
    	call SetPlayerTechResearchedSwap( 'R00Y', 1 , Player(10))
    	call SetPlayerTechResearchedSwap( 'R00Y', 1 , Player(11))
    	//加宝石射程
    	call SetPlayerTechResearchedSwap( 'R010', 1 , Player(10))
    	call SetPlayerTechResearchedSwap( 'R010', 1 , Player(11))
    	call SetPlayerTechResearchedSwap( 'R011', 1 , Player(10))
    	call SetPlayerTechResearchedSwap( 'R011', 1 , Player(11))
    	//冥刹30000E
    	call SetPlayerTechResearchedSwap( 'R013', 1 , Player(10))
    	call SetPlayerTechResearchedSwap( 'R013', 1 , Player(11))
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    无限沉默
	*/
	private function UnlimitSlienceTianyanTimer takes nothing returns nothing
		local timer t = GetExpiredTimer()
		local integer id = GetHandleId(t)
		local unit u = LoadUnitHandle(spellTable,id,1)
		if (IsUnitAliveBJ(u)) then
 			call SimulateSpell(u,u,'A0JK',1,5,"silence",true,false,false)
		else
			call PauseTimer(t)
			call FlushChildHashtable(spellTable,id)
			call DestroyTimer(t)
		endif
		set u = null
		set t = null
	endfunction
	function UnlimitSlienceTianyan takes unit u returns nothing
		local timer t = CreateTimer()
		call SaveUnitHandle(spellTable,GetHandleId(t),1,u)
		call TimerStart(t,3,true,function UnlimitSlienceTianyanTimer)
		set t = null
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    天魇
	*/
	function InitTianyan takes nothing returns nothing
		local unit l_unit = null
		local group g = YDWEGetUnitsOfTypeIdAllNull('uzg2')
		loop
		    set l_unit = FirstOfGroup(g)
		    exitwhen l_unit == null
		    call GroupRemoveUnit(g, l_unit)
		    call AddTianyanmokang(l_unit)
		endloop
    	call SetPlayerTechResearchedSwap( 'R00Z', 1 , Player(10))
    	call SetPlayerTechResearchedSwap( 'R00Z', 1 , Player(11))
    	call SetPlayerTechResearchedSwap( 'R01F', 1 , Player(10))
    	call SetPlayerTechResearchedSwap( 'R01F', 1 , Player(11))
    	call DestroyGroup(g)
    	set g = null
    	set l_unit = null
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    显示对话框提示选更高难度
	*/
	function Show245Dialog takes nothing returns nothing
		call ShowGameHintAll("
		感谢对本地图的支持！
    	你选择的难度在这波就结束了.
    	后续的关卡请选择\"和谐\"难度(难度3)或以上进行体验
    	(前5个难度其实提升不大)")
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    显示对话框提示选更高难度
	*/
	function Show2451Dialog takes nothing returns nothing
		call ShowGameHintAll("
			感谢对本地图的支持！
	    	你选择的难度在这波就结束了.
	    	后续的关卡请选择\"炼狱\"难度(难度35)或以上进行体验
	    	(前5个难度其实提升不大)")
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    显示对话框提示冥界进攻
	*/
	function ShowMingjieDialog takes nothing returns nothing
		call ShowGameHintAll("
			|cffff6800新任务:|r
			击败来自冥界的5波攻击并击败|cffff0000冥刹|r.")
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    显示对话框提示选更高难度
	*/
	function ShowKuileiDialog takes nothing returns nothing
		call ShowGameHintAll("
			|cffff6800新任务:|r
			击败六界傀儡|cffffff00穆晴|r与白浅.")
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    游戏模式选中
	*/
	private function GameModeClick takes nothing returns nothing
	    local dialog d = GetClickedDialogBJ()
        if (GetClickedButtonBJ() == LoadButtonHandle(LHTable,GetHandleId(d),1)) then
			//经典模式
			set mode = 1
			call BJDebugMsg("|cFFFF66CC【消息】|r当前的游戏模式为\"经典模式\".")
			set SgameMode = "经典"
			call ChooseDifficulty(1)
		elseif (GetClickedButtonBJ() == LoadButtonHandle(LHTable,GetHandleId(d),3)) then
			//加速模式
			call BJDebugMsg("|cFFFF66CC【消息】|r当前的游戏模式为\"挑战模式\".")
			set SgameMode = "挑战"
			set mode = 1
			call ShowTiaozhanDialog()
		elseif (GetClickedButtonBJ() == LoadButtonHandle(LHTable,GetHandleId(d),2)) then
			//挑战模式
			set mode = 2
			call BJDebugMsg("|cFFFF66CC【消息】|r当前的游戏模式为\"加速模式\".")
			set SgameMode = "加速"
			call ChooseDifficulty(1)
		elseif (GetClickedButtonBJ() == LoadButtonHandle(LHTable,GetHandleId(d),5)) then
			//挑战模式
			set mode = 2
			call BJDebugMsg("|cFFFF66CC【消息】|r当前的游戏模式为\"狂欢模式\".")
			set SgameMode = "狂欢"
			call InitKuanghuan()
			call ChooseDifficulty(4)
		endif
        call FlushChildHashtable(LHTable,GetHandleId(d))
    	call DialogDisplay( Player(0), d, false )
        call DialogClear(d)
        call DialogDestroy(d)
        set d = null
        call DestroyTrigger(GetTriggeringTrigger())
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    选择游戏模式
	*/
	function ChooseGameMode takes nothing returns nothing
	    local trigger t = CreateTrigger()
	    local dialog d = DialogCreate()
	    call DialogSetMessage( d, "请选择游戏模式" )
	    if (IsKuanghuanTime()) then
	    	call SaveButtonHandle(LHTable,GetHandleId(d),5,DialogAddButtonBJ( d, "狂欢模式(活动)"))
	    endif
	    call SaveButtonHandle(LHTable,GetHandleId(d),1,DialogAddButtonBJ( d, "经典模式"))
	    call SaveButtonHandle(LHTable,GetHandleId(d),3,DialogAddButtonBJ( d, "挑战模式"))
	    call SaveButtonHandle(LHTable,GetHandleId(d),2,DialogAddButtonBJ( d, "加速模式(速通)"))
	    call DialogDisplay( GetFirstPlayer(), d, true )
	    call TriggerRegisterDialogEvent( t, d )
	    call TriggerAddAction(t, function GameModeClick)
	    set d = null
	    set t = null
	endfunction
endlibrary
library_once ItemBase initializer InitItemBase requires LHBase,Diffculty
	globals
		timerdialog TiDiaNecklace
		unit UCrainax
		boolean array BRing
	endglobals
//---------------------------------------------------------------------------------------------------
	/*
	    判断是否是超神器
	*/
	function IsChaoshen takes item i returns boolean
		local integer id = GetItemTypeId(i)
		return id == 'I07F' or id == 'I07E' or id == 'ICS1' or id == 'I04W' or id == 'tlum'
	endfunction
	//判断是否大于3级的神器
	function IsShen3 takes item i returns boolean
		local integer id = GetItemTypeId(i)
		return IsChaoshen(i) or id == 'sksh' or id == 'oslo' or id == 'grsl' or id == 'flag' or id == 'ocor' or id == 'blba' or id == 'cosl' or id == 'shhn' or id == 'rat3' or id == 'pams' or id == 'jdrn' or id == 'shcw' or id == 'stre' or id == 'shrs' or id == 'kgal' or id == 'shtm' or id == 'lure' or id == 'thdm' or id == 'arsh' or id == 'srtl' or id == 'rots' or id == 'tmmt' or id == 'brag' or id == 'olig' or id == 'tbar' or id == 'ccmd' or id == 'iwbr'
	endfunction
	/*
	    判断是否是神器(全部)
	*/
	function IsShenAll takes item i returns boolean
		local integer id = GetItemTypeId(i)
		return IsShen3(i) or id == 'I04Z' or id == 'I056' or id == 'I057' or id == 'I050' or id == 'I055' or id == 'I03Y' or id == 'nflg' or id == 'spre' or id == 'fwss' or id == 'uflg' or id == 'tgxp' or id == 'dust' or id == 'esaz' or id == 'asbl' or id == 'ram4' or id == 'ram3' or id == 'ram2' or id == 'ram1'
	endfunction
	//判断身上神器的数量
	function Shen3Count takes unit u returns integer
		local integer i = 1
		local integer count = 0
		loop
			exitwhen i > 6
			if (IsShen3(UnitItemInSlotBJ(u,i))) then
				set count = count + 1
			endif
			set i = i +1
		endloop
		return count
	endfunction
	//神器破防技能
	function GetShenPofangSpell takes unit u returns integer
		if (YDWEUnitHasItemOfTypeBJNull(u,'I07F')) then
			return 'A0DA'
		elseif (YDWEUnitHasItemOfTypeBJNull(u,'I07E')) then
			return 'A0CI'
		elseif (YDWEUnitHasItemOfTypeBJNull(u,'ICS1')) then
			return 'A0CH'
		elseif (YDWEUnitHasItemOfTypeBJNull(u,'I04W')) then
			return 'A0K5'
		elseif (YDWEUnitHasItemOfTypeBJNull(u,'tlum')) then
			return 'A0D9'
		elseif (YDWEUnitHasItemOfTypeBJNull(u,'tbar') or YDWEUnitHasItemOfTypeBJNull(u,'ccmd')) then
			return 'A0CQ'
		elseif (YDWEUnitHasItemOfTypeBJNull(u,'shtm') or YDWEUnitHasItemOfTypeBJNull(u,'srtl') or YDWEUnitHasItemOfTypeBJNull(u,'olig')) then
			return 'A0BK'
		elseif (YDWEUnitHasItemOfTypeBJNull(u,'kgal') or YDWEUnitHasItemOfTypeBJNull(u,'arsh') or YDWEUnitHasItemOfTypeBJNull(u,'brag')) then
			return 'A0BC'
		elseif (YDWEUnitHasItemOfTypeBJNull(u,'shrs') or YDWEUnitHasItemOfTypeBJNull(u,'thdm') or YDWEUnitHasItemOfTypeBJNull(u,'tmmt')) then
			return 'A0AX'
		elseif (YDWEUnitHasItemOfTypeBJNull(u,'stre') or YDWEUnitHasItemOfTypeBJNull(u,'lure') or YDWEUnitHasItemOfTypeBJNull(u,'rots')) then
			return 'A0A9'
		elseif (YDWEUnitHasItemOfTypeBJNull(u,'ram3') or YDWEUnitHasItemOfTypeBJNull(u,'ram2') or YDWEUnitHasItemOfTypeBJNull(u,'ram1')) then
			return 'A088'
		elseif (YDWEUnitHasItemOfTypeBJNull(u,'uflg') or YDWEUnitHasItemOfTypeBJNull(u,'tgxp') or YDWEUnitHasItemOfTypeBJNull(u,'dust')) then
			return 'A087'
		elseif (YDWEUnitHasItemOfTypeBJNull(u,'I050') or YDWEUnitHasItemOfTypeBJNull(u,'I055') or YDWEUnitHasItemOfTypeBJNull(u,'I03Y')) then
			return 'A041'
		endif
		return 0
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    魔
	*/
	function IsChaomo takes item i returns boolean
		local integer id = GetItemTypeId(i)
		return id == 'IB09' or id == 'IB0A' or id == 'I04X' or id == 'I07O' or id == 'I07N'
	endfunction
	function IsMo3 takes item i returns boolean
		local integer id = GetItemTypeId(i)
		return IsChaomo(i) or id == 'IB04' or id == 'IB05' or id == 'IB06' or id == 'IB07' or id == 'IB08'
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    戒指
	*/
	function IsGui3 takes item i returns boolean
		local integer id = GetItemTypeId(i)
		return IsMaxRing(i) or id == 'lgdh' or id == 'clfm' or id == 'bgst' or id == 'belv' or id == 'hcun' or id == 'rag1' or id == 'penr' or id == 'brac'
	endfunction
	function IsGui takes item i returns boolean
		local integer id = GetItemTypeId(i)
		return IsGui3(i) or id == 'rat9' or id == 'rlif'
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    翅膀
	*/
	function IsChaoyao takes item i returns boolean
		local integer id = GetItemTypeId(i)
		return id == 'ICY1' or id == 'I05X' or id == 'I05F' or id == 'I07P' or id == 'I07Q'
	endfunction
	function IsYao3 takes item i returns boolean
		local integer id = GetItemTypeId(i)
		return IsChaoyao(i) or id == 'I041' or id == 'I04R' or id == 'I05C' or id == 'I05B'
	endfunction
	function Yao3Count takes unit u returns integer
		local integer i = 1
		local integer count = 0
		loop
			exitwhen i > 6
			if (IsYao3(UnitItemInSlotBJ(u,i))) then
				set count = count + 1
			endif
			set i = i +1
		endloop
		return count
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    项链
	*/
	function IsXianglian takes item i returns boolean
		local integer id = GetItemTypeId(i)
		return id == 'rde3' or id == 'ssil' or id == 'I04Y' or id == 'I05T' or id == 'I07H' or id == 'I07G'
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    衣服
	*/
	function IsChaoren takes item i returns boolean
		local integer id = GetItemTypeId(i)
		return id == 'tbsm' or id == 'tfar' or id == 'tbak' or id == 'I05Y' or id == 'I05Z' or id == 'I060' or id == 'I07K' or id == 'I07J' or id == 'I07I'
	endfunction
	function IsRen3 takes item i returns boolean
		local integer id = GetItemTypeId(i)
		return IsChaoren(i) or id == 'frhg' or id == 'mlst' or id == 'nspi' or id == 'oli2' or id == 'rump' or id == 'shen' or id == 'stpg' or id == 'ofir' or id == 'soul' or id == 'sbok' or id == 'arsc' or id == 'rde0' or id == 'oflg' or id == 'frgd' or id == 'gldo' or id == 'gsou' or id == 'envl' or id == 'rugt' or id == 'shdt' or id == 'crdt' or id == 'pspd'
	endfunction
	function IsRen takes item i returns boolean
		local integer id = GetItemTypeId(i)
		return IsRen3(i) or id == 'rugt' or id == 'drph' or id == 'oven' or id == 'rej4' or id == 'dtsb' or id == 'gobm' or id == 'gvsm' or id == 'pgin' or id == 'rej6' or id == 'tels'
	endfunction
	function GetRenTime takes unit u returns real
		if (YDWEUnitHasItemOfTypeBJNull(u,'tbak') or YDWEUnitHasItemOfTypeBJNull(u,'I060') or YDWEUnitHasItemOfTypeBJNull(u,'I07I')) then
			return 9.0
		elseif (YDWEUnitHasItemOfTypeBJNull(u,'pspd')) then
			return 8.5
		elseif (YDWEUnitHasItemOfTypeBJNull(u,'crdt') or YDWEUnitHasItemOfTypeBJNull(u,'tfar') or YDWEUnitHasItemOfTypeBJNull(u,'tbsm') or YDWEUnitHasItemOfTypeBJNull(u,'I05Y') or YDWEUnitHasItemOfTypeBJNull(u,'I05Z') or YDWEUnitHasItemOfTypeBJNull(u,'I07K') or YDWEUnitHasItemOfTypeBJNull(u,'I07J')) then
			return 8.0
		elseif (YDWEUnitHasItemOfTypeBJNull(u,'shdt') or YDWEUnitHasItemOfTypeBJNull(u,'frgd') or YDWEUnitHasItemOfTypeBJNull(u,'stpg')) then
			return 7.5
		elseif (YDWEUnitHasItemOfTypeBJNull(u,'rugt') or YDWEUnitHasItemOfTypeBJNull(u,'oflg') or YDWEUnitHasItemOfTypeBJNull(u,'shen')) then
			return 7.0
		elseif (YDWEUnitHasItemOfTypeBJNull(u,'envl') or YDWEUnitHasItemOfTypeBJNull(u,'rde0') or YDWEUnitHasItemOfTypeBJNull(u,'rump')) then
			return 6.5
		elseif (YDWEUnitHasItemOfTypeBJNull(u,'gsou') or YDWEUnitHasItemOfTypeBJNull(u,'arsc') or YDWEUnitHasItemOfTypeBJNull(u,'oli2')) then
			return 6.0
		elseif (YDWEUnitHasItemOfTypeBJNull(u,'gldo') or YDWEUnitHasItemOfTypeBJNull(u,'sbok') or YDWEUnitHasItemOfTypeBJNull(u,'nspi')) then
			return 5.5
		elseif (YDWEUnitHasItemOfTypeBJNull(u,'gvsm') or YDWEUnitHasItemOfTypeBJNull(u,'soul') or YDWEUnitHasItemOfTypeBJNull(u,'mlst')) then
			return 5.0
		elseif (YDWEUnitHasItemOfTypeBJNull(u,'gobm') or YDWEUnitHasItemOfTypeBJNull(u,'ofir') or YDWEUnitHasItemOfTypeBJNull(u,'frhg')) then
			return 4.5
		elseif (YDWEUnitHasItemOfTypeBJNull(u,'pgin') or YDWEUnitHasItemOfTypeBJNull(u,'tels') or YDWEUnitHasItemOfTypeBJNull(u,'oven')) then
			return 4.0
		elseif (YDWEUnitHasItemOfTypeBJNull(u,'dtsb') or YDWEUnitHasItemOfTypeBJNull(u,'drph')) then
			return 3.5
		elseif (YDWEUnitHasItemOfTypeBJNull(u,'rej4') or YDWEUnitHasItemOfTypeBJNull(u,'rej6')) then
			return 3.0
		endif
		return 0.
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    箱子
	*/
	function IsBox takes item i returns boolean
		local integer id = GetItemTypeId(i)
		return id == 'wild' or id == 'hlst' or id == 'totw' or id == 'sror' or id == 'fgrg' or id == 'wshs' or id == 'I06N' or id == 'I07T' or id == 'I02U'
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    双魂
	*/
	//判断身上双魂的数量
	function Xian3Count takes unit u returns integer
		local integer i = 1
		local integer count = 0
		loop
			exitwhen i > 6
			if (IsZhanfa3(UnitItemInSlotBJ(u,i))) then
				set count = count + 1
			endif
			set i = i +1
		endloop
		return count
	endfunction
	function Zhan0Count takes unit u returns integer
		local integer i = 1
		local integer count = 0
		loop
			exitwhen i > 6
			if (IsZhan0(UnitItemInSlotBJ(u,i))) then
				set count = count + 1
			endif
			set i = i +1
		endloop
		return count
	endfunction
	function ChaoxianCount takes unit u returns integer
		local integer i = 1
		local integer count = 0
		loop
			exitwhen i > 6
			if (IsZhanfaChao(UnitItemInSlotBJ(u,i))) then
				set count = count + 1
			endif
			set i = i +1
		endloop
		return count
	endfunction
	//复活时长
	function GetZhanfaReviveTime takes unit u returns real
		local real time = 0
		if (ChaoxianCount(u) >= 1 or playerName[GetConvertedPlayerId(GetOwningPlayer(u))] == "信哲大人" or B3SecondRevive[GetConvertedPlayerId(GetOwningPlayer(u))]) then
			set time = 3.0 / CModeH(1,2)
		elseif (YDWEUnitHasItemOfTypeBJNull(u,'tgrh')) then
			set time = 4.0 / CModeH(1,2)
		elseif (YDWEUnitHasItemOfTypeBJNull(u,'I078') or YDWEUnitHasItemOfTypeBJNull(u,'plcl')) then
			set time = 8.0 / CModeH(1,2)
		elseif (YDWEUnitHasItemOfTypeBJNull(u,'tcas')) then
			set time = 10.0 / CModeH(1,2)
		elseif (YDWEUnitHasItemOfTypeBJNull(u,'tsct')) then
			set time = 12.0 / CModeH(1,2)
		elseif (YDWEUnitHasItemOfTypeBJNull(u,'skul')) then
			set time = 14.0 / CModeH(1,2)
		elseif (YDWEUnitHasItemOfTypeBJNull(u,'vamp')) then
			set time = 16.0 / CModeH(1,2)
		elseif (YDWEUnitHasItemOfTypeBJNull(u,'I01U') or YDWEUnitHasItemOfTypeBJNull(u,'rde2')) then
			set time = 18.0 / CModeH(1,2)
		else
			set time = 20.0 / CModeH(1,2)
		endif
		if (GetUnitTypeId(UDepot[GetConvertedPlayerId(GetOwningPlayer(u))]) == 'n02D') then
			set time = RMaxBJ(1.5,time - 1.0)
		endif
		return time
	endfunction
	//复活回复魔法
	function GetZhanfaReviveMana takes unit u returns real
		if (ChaoxianCount(u) >= 1) then
			return 1000.
		elseif (YDWEUnitHasItemOfTypeBJNull(u,'shas')) then
			return 600.
		elseif (YDWEUnitHasItemOfTypeBJNull(u,'spro')) then
			return 500.
		elseif (YDWEUnitHasItemOfTypeBJNull(u,'phea')) then
			return 400.
		elseif (YDWEUnitHasItemOfTypeBJNull(u,'rin1')) then
			return 300.
		elseif (YDWEUnitHasItemOfTypeBJNull(u,'ward')) then
			return 200.
		elseif (YDWEUnitHasItemOfTypeBJNull(u,'rde1') or YDWEUnitHasItemOfTypeBJNull(u,'I027')) then
			return 100.
		else
			return 0.
		endif
	endfunction
	//战魂加的属性
	function GetZhanhunShuxing takes unit u returns integer
		if (YDWEUnitHasItemOfTypeBJNull(u,'I05U')) then
			return 10
		elseif (YDWEUnitHasItemOfTypeBJNull(u,'ICX1')) then
			return 9
		elseif (YDWEUnitHasItemOfTypeBJNull(u,'rst1')) then
			return 8
		elseif (YDWEUnitHasItemOfTypeBJNull(u,'tgrh')) then
			return 7
		elseif (YDWEUnitHasItemOfTypeBJNull(u,'plcl')) then
			return 6
		elseif (YDWEUnitHasItemOfTypeBJNull(u,'tcas')) then
			return 5
		elseif (YDWEUnitHasItemOfTypeBJNull(u,'tsct')) then
			return 4
		elseif (YDWEUnitHasItemOfTypeBJNull(u,'skul')) then
			return 3
		elseif (YDWEUnitHasItemOfTypeBJNull(u,'vamp')) then
			return 2
		elseif (YDWEUnitHasItemOfTypeBJNull(u,'I01E') or YDWEUnitHasItemOfTypeBJNull(u,'rde2')) then
			return 1
		else
			return 0
		endif
	endfunction
	//减少的伤害
	function GetZhanhunJianshang takes item i returns integer
		local integer id = GetItemTypeId(i)
		if (IsZhanfaChao(i)) then
			return 50000
		elseif (id == 'tgrh') then
			return 25000
		elseif (id == 'plcl') then
			return 10000
		elseif (id == 'tcas') then
			return 6000
		elseif (id == 'tsct') then
			return 3000
		elseif (id == 'skul') then
			return 1000
		elseif (id == 'I02A' or id == 'rde2') then
			return 75
		else
			return 0
		endif
	endfunction
	//复活时长
	function GetZhanfaReviveCool takes unit u returns real
		if (ChaoxianCount(u) >= 1) then
			return 29.
		elseif (YDWEUnitHasItemOfTypeBJNull(u,'tgrh')) then
			return 59.
		elseif (YDWEUnitHasItemOfTypeBJNull(u,'I078') or YDWEUnitHasItemOfTypeBJNull(u,'plcl')) then
			return 99.
		elseif (YDWEUnitHasItemOfTypeBJNull(u,'tcas')) then
			return 149.
		elseif (YDWEUnitHasItemOfTypeBJNull(u,'tsct')) then
			return 174.
		elseif (YDWEUnitHasItemOfTypeBJNull(u,'skul')) then
			return 199.
		elseif (YDWEUnitHasItemOfTypeBJNull(u,'vamp')) then
			return 219.
		elseif (YDWEUnitHasItemOfTypeBJNull(u,'I01U') or YDWEUnitHasItemOfTypeBJNull(u,'rde2')) then
			return 249.
		else
			return -1.
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    获取随机一种药水
	*/
	function GetRandomPotion takes nothing returns integer
		local integer i = GetRandomInt(1,6)
		if (i == 1) then
			return 'sres'
		elseif (i == 2) then
			return 'I06A'
		elseif (i == 3) then
			return 'I06B'
		elseif (i == 4) then
			return 'I06C'
		elseif (i == 5) then
			return 'I06J'
		elseif (i == 6) then
			return 'I06O'
		endif
		return 0
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    英雄或者镜像获得翅膀才有火焰技能
	*/
	private function TGetWingSpellCon takes nothing returns boolean
		return (GetManipulatingUnit() == udg_H[GetConvertedPlayerId(GetOwningPlayer(GetManipulatingUnit()))] or GetManipulatingUnit() == udg_U_Zhuansheng_Dantiao[2])
	endfunction
	private function TGetWingSpellPickAct takes nothing returns nothing
		if (GetItemTypeId(GetManipulatedItem()) == 'I043') then
			call UnitAddAbility(GetManipulatingUnit(),'Apxf')
		elseif (GetItemTypeId(GetManipulatedItem()) == 'I045') then
			call UnitAddAbility(GetManipulatingUnit(),'A06O')
		elseif (GetItemTypeId(GetManipulatedItem()) == 'I041') then
			call UnitAddAbility(GetManipulatingUnit(),'A09J')
		elseif (GetItemTypeId(GetManipulatedItem()) == 'I04R') then
			call UnitAddAbility(GetManipulatingUnit(),'A0AO')
		elseif (GetItemTypeId(GetManipulatedItem()) == 'I05B') then
			call UnitAddAbility(GetManipulatingUnit(),'A0CL')
		elseif (GetItemTypeId(GetManipulatedItem()) == 'I05C') then
			call UnitAddAbility(GetManipulatingUnit(),'A0CU')
		elseif (GetItemTypeId(GetManipulatedItem()) == 'I05F') then
			call UnitAddAbility(GetManipulatingUnit(),'A0D0')
		elseif (GetItemTypeId(GetManipulatedItem()) == 'I05X') then
			call UnitAddAbility(GetManipulatingUnit(),'A0KE')
		elseif (GetItemTypeId(GetManipulatedItem()) == 'ICY1') then
			call UnitAddAbility(GetManipulatingUnit(),'A0KF')
		elseif (GetItemTypeId(GetManipulatedItem()) == 'I07P') then
			call UnitAddAbility(GetManipulatingUnit(),'A0KE')
			call SetUnitAbilityLevel(GetManipulatingUnit(),'A0KE',2)
		elseif (GetItemTypeId(GetManipulatedItem()) == 'I07Q') then
			call UnitAddAbility(GetManipulatingUnit(),'A0KF')
			call SetUnitAbilityLevel(GetManipulatingUnit(),'A0KF',2)
		endif
	endfunction
	private function TGetWingSpellDropAct takes nothing returns nothing
		if (GetItemTypeId(GetManipulatedItem()) == 'I043') then
			call UnitRemoveAbility(GetManipulatingUnit(),'Apxf')
		elseif (GetItemTypeId(GetManipulatedItem()) == 'I045') then
			call UnitRemoveAbility(GetManipulatingUnit(),'A06O')
		elseif (GetItemTypeId(GetManipulatedItem()) == 'I041') then
			call UnitRemoveAbility(GetManipulatingUnit(),'A09J')
		elseif (GetItemTypeId(GetManipulatedItem()) == 'I04R') then
			call UnitRemoveAbility(GetManipulatingUnit(),'A0AO')
		elseif (GetItemTypeId(GetManipulatedItem()) == 'I05B') then
			call UnitRemoveAbility(GetManipulatingUnit(),'A0CL')
		elseif (GetItemTypeId(GetManipulatedItem()) == 'I05C') then
			call UnitRemoveAbility(GetManipulatingUnit(),'A0CU')
		elseif (GetItemTypeId(GetManipulatedItem()) == 'I05F') then
			call UnitRemoveAbility(GetManipulatingUnit(),'A0D0')
		elseif (GetItemTypeId(GetManipulatedItem()) == 'I05X') then
			call UnitRemoveAbility(GetManipulatingUnit(),'A0KE')
		elseif (GetItemTypeId(GetManipulatedItem()) == 'ICY1') then
			call UnitRemoveAbility(GetManipulatingUnit(),'A0KF')
		elseif (GetItemTypeId(GetManipulatedItem()) == 'I07P') then
			call UnitRemoveAbility(GetManipulatingUnit(),'A0KE')
		elseif (GetItemTypeId(GetManipulatedItem()) == 'I07Q') then
			call UnitRemoveAbility(GetManipulatingUnit(),'A0KF')
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    删除书本小点BUG
	*/
	private function TBookBUGCon takes nothing returns boolean
		return GetItemType(GetManipulatedItem()) == ITEM_TYPE_POWERUP
	endfunction
	private function TBookBUGAct takes nothing returns nothing
		call YDWEPolledWaitNull(1.0)
		call RemoveItem(GetManipulatedItem())
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    Crainax属性与技能的设定
	*/
	function ReflashCrainaxAttr takes nothing returns nothing
		call ModifyHeroStat( bj_HEROSTAT_STR, UCrainax, bj_MODIFYMETHOD_SET, IMinBJ(2100000000,R2I(( I2R(udg_Laser[udg_Bo]) * ( 1.00 + ( 0.30 * I2R(udg_Nandu_JJJ) ) ) ))))
	    call ModifyHeroStat( bj_HEROSTAT_AGI, UCrainax, bj_MODIFYMETHOD_SET, IMinBJ(2100000000,R2I(( I2R(udg_Laser[( udg_Bo + 29 )]) * ( 1.00 + ( 0.30 * I2R(udg_Nandu_JJJ) ) ) )) ))
	    call ModifyHeroStat( bj_HEROSTAT_INT, UCrainax, bj_MODIFYMETHOD_SET, IMinBJ(2100000000,R2I(( I2R(udg_Laser[( udg_Bo + 58 )]) * ( 1.00 + ( 0.30 * I2R(udg_Nandu_JJJ) ) ) )) ))
	    call SetUnitAbilityLevelSwapped( 'A0EM', UCrainax, udg_Bo )
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    项链的重生
	*/
	private function ReviveNecklace takes nothing returns nothing
	        call PingMinimap( -1658.00, -14973.00, 2.00 )
	        call RemoveUnit(UCrainax)
	        set UCrainax = CreateUnit(Player(10),'Ekgg',-1658.00, -14973.00 , 180)
	        call AddTianyanmokang(UCrainax)
	        call ReflashCrainaxAttr()
	        call DisplayTextToForce( GetPlayersAll(), "|cFFFF66CC【消息】|r|cffff9900圣主Crainax的分身|r复活." )
	        call TimerDialogDisplay(TiDiaNecklace,false)
	        call DestroyTimerDialog(TiDiaNecklace)
	        call PauseTimer(GetExpiredTimer())
	        call DestroyTimer(GetExpiredTimer())
	        set TiDiaNecklace = null
	endfunction
	private function ReviveRing takes nothing returns nothing
			local unit u = null
	        call PingMinimap( -10630.00, -8642.00, 2.00 )
	        set u = CreateUnit(Player(10),'Naka',-10425.00, -10429.00 , 180)
	        call SetHeroLevel( u, ( GetHeroLevel(u) + 1 ), true )
	        call DisplayTextToForce( GetPlayersAll(), ( "|cFFFF66CC【消息】|r" + "|cFFFF6699千年孤魂|r|cffffcc00弑魂|r复活了。" ) )
	        set u = null
	        call PauseTimer(GetExpiredTimer())
	        call DestroyTimer(GetExpiredTimer())
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    死亡掉落
	*/
	function BossDeathDropItem takes nothing returns nothing
		local timer t
	    if ((GetUnitTypeId(GetDyingUnit()) == 'Naka')) then
	        call CreateItem( 'rat9', GetUnitX(GetTriggerUnit()),GetUnitY(GetTriggerUnit()) )
	        call DestroyEffect( AddSpecialEffect("Abilities\\Spells\\Demon\\DarkPortal\\DarkPortalTarget.mdl", GetUnitX(GetTriggerUnit()),GetUnitY(GetTriggerUnit())) )
	        call TimerStart(CreateTimer(),30,false,function ReviveRing)
	        call YDWEPolledWaitNull(0.5)
	        call RemoveUnit(GetDyingUnit())
	    endif
	    if (GetDyingUnit() == UCrainax) then
	        call CreateItem( 'rde3', GetUnitX(UCrainax),GetUnitY(UCrainax) )
	        call DestroyEffect( AddSpecialEffect("Abilities\\Spells\\Demon\\DarkPortal\\DarkPortalTarget.mdl", GetUnitX(UCrainax),GetUnitY(UCrainax)) )
	        set t = CreateTimer()
	        set TiDiaNecklace = CreateTimerDialogBJ(t,"圣主分身复活")
	        call TimerStart(t,900,false,function ReviveNecklace)
	        call TimerDialogDisplay(TiDiaNecklace,true)
	        set t = null
	    endif
	endfunction
//---------------------------------------------------------------------------------------------------
	private function InitItemBase takes nothing returns nothing
		//删除书本的小点BUG
		local trigger t = CreateTrigger()
		call TriggerRegisterAnyUnitEventBJ(t,EVENT_PLAYER_UNIT_PICKUP_ITEM)
		call TriggerAddCondition(t,Condition(function TBookBUGCon))
		call TriggerAddAction(t,function TBookBUGAct)
		//获得翅膀的技能
		set t = CreateTrigger()
		call TriggerRegisterAnyUnitEventBJ(t,EVENT_PLAYER_UNIT_PICKUP_ITEM)
		call TriggerAddCondition(t, Condition(function TGetWingSpellCon))
		call TriggerAddAction(t, function TGetWingSpellPickAct)
		//删掉翅膀的技能
		set t = CreateTrigger()
		call TriggerRegisterAnyUnitEventBJ(t,EVENT_PLAYER_UNIT_DROP_ITEM)
		call TriggerAddCondition(t, Condition(function TGetWingSpellCon))
		call TriggerAddAction(t, function TGetWingSpellDropAct)
		//死亡掉落戒指和项链
	    set t = CreateTrigger()
	    call TriggerRegisterAnyUnitEventBJ( t, EVENT_PLAYER_UNIT_DEATH )
	    call TriggerAddAction(t, function BossDeathDropItem)
		set UCrainax=CreateUnit(Player(10), 'Ekgg', - 1661.7, - 14985.1, 180.000)
		set t = null
	endfunction
endlibrary
///#include  "edit/Jizi.j"
library_once Continous initializer InitContinous requires LHBase,ItemBase,Achievement,Huodong//,Jizi
	globals
		integer array IConDays
		integer array ILastTime
		constant integer TIMESTAMP_START = 1500998400
		boolean array BWuxing
		//integer DzAPI_Map_GetGameStartTime() = 0
	endglobals
//---------------------------------------------------------------------------------------------------
	/*
	    获取签到的金币奖励
	*/
	private function GetGoldReward takes integer day returns integer
		return I3(day == 1, 500 ,R2I((SquareRoot(day) + 2.) * 300.))
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    给奖励
	*/
	function GiveJianianhuaGift takes player p returns nothing
		local integer i = IConDays[GetConvertedPlayerId(p)]
		local unit u = udg_H[GetConvertedPlayerId(p)]
		call AdjustPlayerStateBJ( GetGoldReward(i), GetOwningPlayer(u) , PLAYER_STATE_RESOURCE_GOLD )
		if (i >= 2) then
			call UnitAddItemByIdSwapped('ankh', u)
		endif
		if (i >= 4) then
			call UnitAddItemByIdSwapped('k3m1', u)
		endif
		if (i >= 7) then
			call UnitAddItemByIdSwapped('I07A', u)
			set BWuxing[GetConvertedPlayerId(p)] = true
		endif
		if (i >= 12) then
			call UnitAddItemByIdSwapped('I05O', u)
			call SetItemPawnable(GetLastCreatedItem(),false)
		endif
		if (i >= 14) then
			call SetLingxueSpinOK(p)
		endif
		if (i >= 20) then
			call UnitAddItemByIdSwapped('hlst', u)
		endif
		if (i >= 40) then
			call GetAchievementAndSave(p,47)
		endif
		set u = null
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    奖励物品
	*/
	function GetDailyReward takes integer days returns string
		if (days == 2) then
			return "天地庇佑 * 2"
		elseif (days == 4) then
			return "血精石 * 1"
		elseif (days == 7) then
			return "|cffffff00【妖】五行之杖|r * 1"
		elseif (days == 12) then
			return "聚宝·Lv0 * 1"
		elseif (days == 14) then
			return "|cFF339933沐雪无瑕|r皮肤"
		elseif (days == 20) then
			return "|cff808080【E】幸运宝箱|r"
		elseif (days == 40) then
			return GetAchievementName(47)+"成就"
		endif
		return null
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    获取从保存的第一天开始的时间
	*/
	function GetContinousDay takes player p returns integer
		if (DzAPI_Map_GetGameStartTime() < TIMESTAMP_START) then
			return 0
		endif
		return (DzAPI_Map_GetGameStartTime() - ILastTime[GetConvertedPlayerId(p)])/86400
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    创建一个对话框
	*/
	function CreateLoginDialog takes player p returns nothing
        local dialog d = DialogCreate()
        local string s = "
        	连续登录奖励
        	你获得了第"+I2S(IConDays[GetConvertedPlayerId(p)])+"天对应的"+I2S(GetGoldReward(IConDays[GetConvertedPlayerId(p)]))+"金币!
        	明天继续签到可以获得"+I2S(GetGoldReward(IConDays[GetConvertedPlayerId(p)] + 1))+"的金币!
        	"
        local integer i = 1
        loop
        	exitwhen i > 41
        	if (GetDailyReward(i) != null) then
        		set s = s + "第" + I2S(i) + "天:" + GetDailyReward(i) +S3(IConDays[GetConvertedPlayerId(p)] >= i,"|cffff9900(已完成)|r","|cff33cccc(未完成)|r") + "
        		"
        	endif
        	set i = i +1
        endloop
                		set s = s + "
        你已经连续签到了" + I2S(IConDays[GetConvertedPlayerId(p)]) + "天,注意断签了会重新计算哦."
        call DialogSetMessage( d, s )
        call DialogAddButton( d, "10分钟之后当天才签到成功|cffff6800(Esc)|r",512)
        call DialogDisplay( p, d, true )
        //call DialogDestroy(d)
        set d = null
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    获取当前时间的0点
	*/
	private function GetCurrentStartTime takes nothing returns integer
		return TIMESTAMP_START + ((DzAPI_Map_GetGameStartTime() - TIMESTAMP_START)/86400)*86400
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    获取前n天的0点
	*/
	private function GetOldStartTime takes integer day returns integer
		return GetCurrentStartTime() - ((day - 1) * 86400)
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	     初始化你的登录时间
	*/
	function InitContinousData takes player p returns nothing
		set IConDays[GetConvertedPlayerId(p)] = DzAPI_Map_GetStoredInteger(p, "IConDays")
		set ILastTime[GetConvertedPlayerId(p)] = DzAPI_Map_GetStoredInteger(p, "ILastTime")
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    显示签到指数
	*/
	/*function ShowQiandao takes player p returns nothing
		call DisplayTextToPlayer(p, 0., 0., "|cFFFF66CC【消息】|r你的签到指数为"+I2S(IQiandao2[GetConvertedPlayerId(p)])+".")
	endfunction*/
//---------------------------------------------------------------------------------------------------
	/*
	    保存登录状态
	*/
	function SaveLoginState takes player p returns nothing
		if (Bdudang[GetConvertedPlayerId(p)]) then
			call DzAPI_Map_StoreInteger( p, "IConDays", IConDays[GetConvertedPlayerId(p)] )
			call DzAPI_Map_StoreInteger( p, "ILastTime", ILastTime[GetConvertedPlayerId(p)] )
			//call DzAPI_Map_StoreInteger( p,  "IQiandao2", IQiandao2[GetConvertedPlayerId(p)] )
			call DisplayTextToPlayer(p, 0., 0., "|cffff0000【消息】连续登录数据保存成功!|r")
			call DisplayTextToPlayer(p, 0., 0., "|cffff0000【消息】连续登录数据保存成功!|r")
			call DisplayTextToPlayer(p, 0., 0., "|cffff0000【消息】连续登录数据保存成功!|r")
			call DisplayTextToPlayer(p, 0., 0., "|cffff0000【消息】连续登录数据保存成功!|r")
			call DisplayTextToPlayer(p, 0., 0., "|cffff0000【消息】连续登录数据保存成功!|r")
			//call CreateYuebingPlayer(GetUnitX(udg_H[GetConvertedPlayerId(p)]),GetUnitY(udg_H[GetConvertedPlayerId(p)]),p)
		else
			call DisplayTextToPlayer(p, 0., 0., "|cffff0000【消息】连续登录数据保存失败,请重启游戏!|r")
			call DisplayTextToPlayer(p, 0., 0., "|cffff0000【消息】连续登录数据保存失败,请重启游戏!|r")
			call DisplayTextToPlayer(p, 0., 0., "|cffff0000【消息】连续登录数据保存失败,请重启游戏!|r")
			call DisplayTextToPlayer(p, 0., 0., "|cffff0000【消息】连续登录数据保存失败,请重启游戏!|r")
			call DisplayTextToPlayer(p, 0., 0., "|cffff0000【消息】连续登录数据保存失败,请重启游戏!|r")
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
		等10分钟后上传到网易
	*/
	private function UploadToNetEaseTimer takes nothing returns nothing
		local timer t = GetExpiredTimer()
		local integer id = GetHandleId(t)
		local player p = LoadPlayerHandle(LHTable,id,1)
		call SaveLoginState(p)
		call PauseTimer(t)
		call FlushChildHashtable(LHTable,id)
		call DestroyTimer(t)
		set p = null
		set t = null
	endfunction
	function UploadToNetEase takes player p returns nothing
		local timer t = CreateTimer()
		call SavePlayerHandle(LHTable,GetHandleId(t),1,p)
		call TimerStart(t,600,false,function UploadToNetEaseTimer)
		set t = null
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    设置连续时间
	*/
	function SetDenglu takes player p returns nothing
		//活动还没开始，或者说是首次
		if (DzAPI_Map_GetGameStartTime() < TIMESTAMP_START) then
			call BJDebugMsg("|cFFFF66CC【消息】|r ")
			call DisplayTextToPlayer(Player(0), 0., 0., "|cFFFF66CC【消息】|r嘉年华时间未开始.")
			return
		endif
		if (ILastTime[GetConvertedPlayerId(p)] < TIMESTAMP_START) then
			set ILastTime[GetConvertedPlayerId(p)] = TIMESTAMP_START
			set IConDays[GetConvertedPlayerId(p)] = 0
		endif
		//断签啦重新存储
		if (GetContinousDay(p) == IConDays[GetConvertedPlayerId(p)])	then
			//首次连续登录的提示与奖励
			set IConDays[GetConvertedPlayerId(p)] = GetContinousDay(p) + 1
			//set IQiandao2[GetConvertedPlayerId(p)] = IQiandao2[GetConvertedPlayerId(p)] + DzAPI_Map_GetGameStartTime() - GetCurrentStartTime(p)
			call DisplayTextToPlayer(p, 0., 0., "|cFFFF66CC【消息】|r你已经成功连续登录"+I2S(IConDays[GetConvertedPlayerId(p)])+"天(注意今天的签到需要等10分钟才能保存).")
		elseif (GetContinousDay(p) == IConDays[GetConvertedPlayerId(p)] - 1)then
			//保持当天的奖励
			call DisplayTextToPlayer(p, 0., 0., "|cFFFF66CC【消息】|r你已经成功连续登录"+I2S(IConDays[GetConvertedPlayerId(p)])+"天(今天的签到数据已经在前面游戏中保存了哦).")
		else
			set ILastTime[GetConvertedPlayerId(p)] = GetCurrentStartTime()
			set IConDays[GetConvertedPlayerId(p)] = 1
			//set IQiandao2[GetConvertedPlayerId(p)] = IQiandao2[GetConvertedPlayerId(p)] + DzAPI_Map_GetGameStartTime() - GetCurrentStartTime(p)
			call DisplayTextToPlayer(p, 0., 0., "|cFFFF66CC【消息】|r你已经成功连续登录"+I2S(IConDays[GetConvertedPlayerId(p)])+"天(注意今天的签到需要等10分钟才能保存).")
		endif
		call UploadToNetEase(p)
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    补签
	*/
	function Buqian1 takes player p returns nothing
		if not(BBuqian1) then
			set BBuqian1 = true
			call DisplayTextToPlayer(p, 0., 0., "|cFFFF66CC【消息】|r补签1阶段.")
		endif
	endfunction
	function Buqian2 takes player p,string s returns nothing
		if (s == I2S(GetCycleHash(playerName[GetConvertedPlayerId(p)],25))) then
			set BBuqian2 = true
			call DisplayTextToPlayer(p, 0., 0., "|cFFFF66CC【消息】|r补签2阶段.")
		endif
		set BBuqian1 = false
	endfunction
	function Buqian3 takes player p,string s returns nothing
		local integer i = 1
		local integer result = 0
		loop
			exitwhen i > 100
			if (s == I2S(GetCycleHash(I2S(i),1))) then
				set IConDays[GetConvertedPlayerId(p)] = i
				set ILastTime[GetConvertedPlayerId(p)] = GetOldStartTime(i)
				call DisplayTextToPlayer(p, 0., 0., "|cFFFF66CC【消息】|r补签为"+I2S(i)+"天.")
				call SaveLoginState(p)
				exitwhen true
			endif
			set i = i +1
		endloop
		set BBuqian2 = false
	endfunction
//---------------------------------------------------------------------------------------------------
	private function InitContinous takes nothing returns nothing
	endfunction
endlibrary
library_once Jizi requires LHBase,Achievement,ChallangerDZ,Attr,Structs
	globals
	endglobals
//---------------------------------------------------------------------------------------------------
	/*
	    集字
	*/
	private function GetZhongqiuWord takes integer i returns string
		if (i == 1) then
			return "平"
		elseif (i == 2) then
			return "分"
		elseif (i == 3) then
			return "秋"
		elseif (i == 4) then
			return "色"
		elseif (i == 5) then
			return "一"
		elseif (i == 6) then
			return "轮"
		elseif (i == 7) then
			return "满"
		elseif (i == 8) then
			return "长"
		elseif (i == 9) then
			return "伴"
		elseif (i == 10) then
			return "云"
		elseif (i == 11) then
			return "衢"
		elseif (i == 12) then
			return "千"
		elseif (i == 13) then
			return "里"
		elseif (i == 14) then
			return "明"
		endif
		return ""
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    奖励物品
	*/
	private function GetRewardName takes integer days returns string
		if (days == 14) then
			return "全皮肤体验权[活动期间]
+绝版中秋英雄死亡声效.[永久]"
		elseif (days == 10) then
			return "湮灭皮肤[永久]"
		elseif (days == 12) then
			return "司宸皮肤与仓库瞬息万年[永久]"
		elseif (days == 8) then
			return "解锁星胧[活动期间]"
		endif
		return null
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    状态
	*/
	private function GetStateName takes integer i returns string
		if (i == 1) then
			return "|cff99cc00金钱获取率+100%持续3分钟。|r"
		elseif (i == 2) then
			return "|cff99cc00技能伤害+50%持续4分钟。|r"
		elseif (i == 3) then
			return "|cffff66003秒复活持续5分钟。|r"
		endif
		return ""
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    获取某个字
	*/
	private function GetNewWord takes player p,integer i returns boolean
		local integer index = GetConvertedPlayerId(p)
		local string temp = null
		if (StringLength(SJizi[index]) < 62) then
			set SJizi[index] = "00000000000000000000000000000000000000000000000000000000000000"
		endif
		if (S2I(SubStringBJ(SJizi[index],i,i)) != 1) then
			set temp = SJizi[index]
			set SJizi[index] = SubStringBJ(temp,1,i - 1)
			set SJizi[index] = SJizi[index] + "1"
			set SJizi[index] = SJizi[index] + SubStringBJ(temp,i+1,StringLength(temp))
			set temp = null
			if (i != 15) then
				call DisplayTextToPlayer(p, 0., 0., "|cff3366ff【消息】恭喜你收集到从未获得的|r"+GetZhongqiuWord(i)+"字.")
				call DisplayTextToPlayer(p, 0., 0., "|cff3366ff【消息】恭喜你收集到从未获得的|r"+GetZhongqiuWord(i)+"字.")
				call DisplayTextToPlayer(p, 0., 0., "|cff3366ff【消息】恭喜你收集到从未获得的|r"+GetZhongqiuWord(i)+"字.")
			endif
			call DzAPI_Map_StoreString( p, "SJizi", SJizi[index] )
			return true
		endif
		return false
	endfunction
	private function IsHasWord takes player p,integer i returns boolean
		return S2I(SubStringBJ(SJizi[GetConvertedPlayerId(p)],i,i)) == 1
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    获取一个玩家总共集齐了几个字
	*/
	function GetPlayerWordCount takes player p returns integer
		local integer i = 1
		local integer count = 0
		loop
			exitwhen i > 14
			if (IsHasWord(p,i)) then
				set count = count + 1
			endif
			set i = i +1
		endloop
		return count
	endfunction
	function HasAll14Word takes player p returns boolean
		return IsHasWord(p,15)
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    14个字
	*/
	function Get14Word takes player p returns string
		local string s = ""
		local integer i = 1
		loop
			exitwhen i > 14
			set s = s + S3(IsHasWord(p,i),"|cffff00ff","|cffffffff") + GetZhongqiuWord(i) + "|r"
			if (i == 7) then
				set s = s + "|cffff00ff，|r"
			elseif(i == 14) then
				set s = s + "|cffff00ff。|r"
			endif
			set i = i +1
		endloop
		return s
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    字数的奖励
	*/
	private function GetWordCountReward takes player p returns nothing
		if (GetPlayerWordCount(p) >= 10) then
			call SetYanmieSpinOK(p)
		endif
		if (GetPlayerWordCount(p) >= 12) then
			call SetSichenSpinOK(p)
			call GetAndSaveCangku(p,5)
		endif
		if (GetPlayerWordCount(p) >= 14) then
			call GetNewWord(p,15)
		endif
	endfunction
	private function AfterMoneyBuffTime takes player p returns nothing
		call AddMoneyPercent(GetConvertedPlayerId(p),-1.0)
		call DisplayTextToPlayer(p, 0., 0., "|cFFFF66CC【消息】|r月饼给你提供的金钱时间到了.")
	endfunction
	private function AfterSpellBuffTime takes player p returns nothing
		call AddSpellPercent(GetConvertedPlayerId(p),-0.5)
		call DisplayTextToPlayer(p, 0., 0., "|cFFFF66CC【消息】|r月饼给你提供的技能伤害时间到了.")
	endfunction
	private function AfterReviveBuffTime takes player p returns nothing
		set B3SecondRevive[GetConvertedPlayerId(p)] = false
		call DisplayTextToPlayer(p, 0., 0., "|cFFFF66CC【消息】|r月饼给你提供的3秒复活时间到了.")
	endfunction
	private function GetStateReward takes player p,integer state returns nothing
		if (state == 1) then
			call AddMoneyPercent(GetConvertedPlayerId(p),1.0)
			call Buff.create(p,180,AfterBuffTime.AfterMoneyBuffTime)
		elseif (state == 2) then
			call AddSpellPercent(GetConvertedPlayerId(p),0.5)
			call Buff.create(p,240,AfterBuffTime.AfterSpellBuffTime)
		elseif (state == 3) then
			set B3SecondRevive[GetConvertedPlayerId(p)] = true
			call Buff.create(p,300,AfterBuffTime.AfterReviveBuffTime)
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    获得某个字
	*/
	function OpenTheYuebing takes player p returns nothing
		local integer iWord = GetRandomInt(1,14)
		local integer iState = GetRandomInt(1,3)
		local integer i = 1
		local string s = null
		call GetNewWord(p,iWord)
		set s = "
			你开启该月饼获得了:
			" + GetStateName(iState) +"
			活动字\"|cffff00ff" + GetZhongqiuWord(iWord) +"|r\"
			你目前收集到的总字数为:
			" + Get14Word(p) +"
			("+I2S(GetPlayerWordCount(p))+"个字)
			"
		loop
			exitwhen i > 14
        	if (GetRewardName(i) != null) then
        		set s = s + I2S(i) + "字:" + GetRewardName(i) + S3(GetPlayerWordCount(p) >= i,"|cffff9900(已获得)|r","|cff33cccc(未获得)|r") + "
"
        	endif
			set i = i +1
		endloop
		call GetWordCountReward(p)
		call GetStateReward(p,iState)
		call ShowGameHint(p,s)
		set s = null
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    创建一个月饼
	*/
	function CreateYuebingPlayer takes real x,real y,player p returns nothing
		local item it = null
		call BJDebugMsg("|cFFFF66CC【消息】|r地图出现了一个月饼!")
		call PingMinimapForForce( GetPlayersAll(), x, y, 5.00 )
		call PlaySoundBJ(gg_snd_MapPing)
		set it = CreateItem('I07T',x,y)
		if (p != null) then
	        call SaveInteger(YDHT,GetHandleId(it),0xA75AD423,GetConvertedPlayerId(p))
		endif
		set it = null
	endfunction
	function CreateYuebing takes real x,real y returns nothing
		call CreateYuebingPlayer(x,y,null)
	endfunction
	/*
	    每人一个月饼
	*/
	function CreateAllYuebing takes nothing returns nothing
		local integer i = 1
		loop
			exitwhen i > 6
			if ((GetPlayerSlotState(ConvertedPlayer(i)) == PLAYER_SLOT_STATE_PLAYING) and (GetPlayerController(ConvertedPlayer(i)) == MAP_CONTROL_USER) and udg_H[i] != null) then
				call CreateYuebingPlayer(GetUnitX(udg_H[i]),GetUnitY(udg_H[i]),ConvertedPlayer(i))
			endif
			set i = i +1
		endloop
	endfunction
endlibrary
/*
    七夕
*/
library_once Qixi requires LHBase,Achievement
//---------------------------------------------------------------------------------------------------
	/*
	    补偿
	*/
	function Buchang takes player p returns nothing
		// local integer i = GetConvertedPlayerId(p)
		// if (playerName[i] == "Cyandrizzle") then
		// 	call GetAchievementAndSave(p,325)
		// 	call GetAchievementAndSave(p,35)
		// 	call GetAchievementAndSave(p,321)
		// 	call GetAchievementAndSave(p,412)
		// 	call GetAchievementAndSave(p,413)
		// 	call GetAchievementAndSave(p,414)
		// endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    瞬息万年
	*/
	/*private function Fafang1 takes player p returns nothing
		if (GetPlayerName(p) == "你挺得劲" or GetPlayerName(p) == "ㅈ轩轩" or GetPlayerName(p) == "利绝天" or GetPlayerName(p) == "米老鼠的米") then
			call GetAndSaveCangku(p,3)
		endif
		endfunction*/
//---------------------------------------------------------------------------------------------------
	/*
	    紫雷之极
	*/
	/*private function Fafang2 takes player p returns nothing
		if (GetPlayerName(p) == "天子脚下一堆坑" or GetPlayerName(p) == "肆虐De疼痛" or GetPlayerName(p) == "叹之奈何也" or GetPlayerName(p) == "文能题笔安天下" ) then
			call GetAndSaveCangku(p,4)
		endif
	endfunction*/
//---------------------------------------------------------------------------------------------------
	/*
	   皮肤
	*/
	/*private function Fafang3 takes player p returns nothing
		if (GetPlayerName(p) == "玉之魂") then
			call SetHuanyiSpinOK(p)
		elseif (GetPlayerName(p) == "泛舟") then
			call SetLichiSpinOK(p)
			call SetSichenSpinOK(p)
		elseif (GetPlayerName(p) == "英子丶丿") then
			call GetAndSaveCangku(p,4)
			call GetAndSaveCangku(p,7)
			call SetHeiyanSpinOK(p)
		elseif (GetPlayerName(p) == "冷灬无情") then
			call SetMoqiSpinOK(p)
			call SetChenji2SpinOK(p)
		elseif (GetPlayerName(p) == "因我而空虚") then
			call SetXuanxue2SpinOK(p)
			call GetAndSaveCangku(p,6)
			call SetCanglingSpinOK(p)
		elseif (GetPlayerName(p) == "Buckethead") then
			call SetMoqiSpinOK(p)
			call SetCanglingSpinOK(p)
		elseif (GetPlayerName(p) == "小米酥丶") then
			call SetLichiSpinOK(p)
			call GetAndSaveCangku(p,5)
		elseif (GetPlayerName(p) == "FuYou丶") then
			call GetAndSaveCangku(p,5)
			call GetAndSaveCangku(p,6)
			call GetAndSaveCangku(p,7)
		elseif (GetPlayerName(p) == "邪魔ご逆神") then
			call SetHeiyanSpinOK(p)
		elseif (GetPlayerName(p) == "嚣张城") then
			call SetSichenSpinOK(p)
		elseif (GetPlayerName(p) == "wc不在线") then
			call GetAndSaveCangku(p,3)
		elseif (GetPlayerName(p) == "星际诺娃") then
			call GetAndSaveCangku(p,3)
		elseif (GetPlayerName(p) == "午夜魅") then
			call SetXuanxue2SpinOK(p)
		elseif (GetPlayerName(p) == "Cyandrizzle") then
			call SetXuanxue2SpinOK(p)
			call SetKaisaSpinOK(p)
		endif
	endfunction*/
//---------------------------------------------------------------------------------------------------
	/*
	   司宸
	*/
	/*private function Fafang4 takes player p returns nothing
		if (GetPlayerName(p) ==  "FuYou丶" or GetPlayerName(p) ==  "因我而空虚" or GetPlayerName(p) ==  "Buckethead" or GetPlayerName(p) ==  "英子丶丿" or GetPlayerName(p) ==  "小米酥丶" or GetPlayerName(p) ==  "嚣张城" or GetPlayerName(p) ==  "利绝天" or GetPlayerName(p) ==  "１１" or GetPlayerName(p) ==  "与你童在") then
			call SetSichenSpinOK(p)
		endif
	endfunction*/
//---------------------------------------------------------------------------------------------------
	/*
	    发放
	*/
	private function QixiHuodongFafang takes player p returns nothing
		//倾雪
		//call Fafang1(p)
		//救死
		//call Fafang2(p)
		//皮肤
		//call Fafang3(p)
		//幻逸
		//call Fafang4(p)
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    七夕活动
	*/
	private function QixiHuodongJudgeTimer takes nothing returns nothing
		local timer t = GetExpiredTimer()
		local integer id = GetHandleId(t)
		local player p = LoadPlayerHandle(LHTable,id,1)
		call QixiHuodongFafang(p)
		call PauseTimer(t)
		call FlushChildHashtable(LHTable,id)
		call DestroyTimer(t)
		set p = null
		set t = null
	endfunction
	function QixiHuodong takes player p returns nothing
		local timer t = CreateTimer()
		call SavePlayerHandle(LHTable,GetHandleId(t),1,p)
		call TimerStart(t,1,false,function QixiHuodongJudgeTimer)
		set t = null
	endfunction
endlibrary
library_once Fanzhuan requires LHBase,Achievement
	globals
		integer array diyu
		string array SFanzhaun
	endglobals
//---------------------------------------------------------------------------------------------------
	/*
	    反转条件
	*/
	function FanzhuanCondition takes player p,integer i returns boolean
		if not(DEBUG_MODE) then
			return IsPIV(p)
		else
			return S2I(SubStringBJ(SFanzhaun[GetConvertedPlayerId(p)],i,i)) == 1 or GetSpecifyHeroTimes(p,i) >= 25 or IsPIV(p)
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    反转失败提示语
	*/
	function GetFanzhuanFailString takes player p,integer i returns string
		if not(DEBUG_MODE) then
			return "
			在该版本中获取赞助后永久解锁使用.(请看复活点介绍)
			或者在官方平台使用该英雄25次后解锁.
			"
		endif
		return "
		该英雄使用次数达到25次.
		进度:"+I2S(GetSpecifyHeroTimes(p,i))+"/25"
		return ""
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    设置可以选
	*/
	function SetFanzhuanOK takes player p,integer i returns nothing
		local integer index = GetConvertedPlayerId(p)
		local string temp = null
		if (StringLength(SFanzhaun[index]) < 62) then
			set SFanzhaun[index] = "00000000000000000000000000000000000000000000000000000000000000"
		endif
		if (S2I(SubStringBJ(SFanzhaun[index],i,i)) != 1) then
			set temp = SFanzhaun[index]
			set SFanzhaun[index] = SubStringBJ(temp,1,i - 1)
			set SFanzhaun[index] = SFanzhaun[index] + "1"
			set SFanzhaun[index] = SFanzhaun[index] + SubStringBJ(temp,i+1,StringLength(temp))
			set temp = null
			call DisplayTextToPlayer(p, 0., 0., "|cff3366ff【消息】恭喜你成功解锁英雄"+GetIndexHeroColorName(i)+"|cff3366ff新的技能形态!|r")
			debug call DzAPI_Map_StoreString( p, "SFanzhaun", SFanzhaun[index] )
		endif
	endfunction
endlibrary
library_once Version initializer InitVersion requires LHBase,Diffculty,Achievement,Continous,Qixi,Fanzhuan//,Jizi
	globals
		//集字
		string array SJizi
		unit UChengjiu = null
		integer array vipCode
		/*
		    击败冥刹多少次
		*/
		integer array mingcha
		/*
		    玩家通关次数
		*/
		integer array passTimes
		/*
		    抓宠物次数
		*/
		integer array petTimes
		/*
		    计时存档次数
		*/
		key kSaveHeroTimes
		/*
		    通关次数
		*/
		/*integer array pass1
		integer array pass2
		integer array pass3
		integer array pass4
		integer array pass5
		integer array pass6
		integer array pass7
		integer array pass8
		integer array pass9*/
		/*
		    死亡次数
		*/
		integer array deathCount
		/*
		    杀敌数
		*/
		integer array killCount
		/*
		    基地是否没受伤过
		*/
		boolean BBaseDamage = false
		/*
		    巨能统计
		*/
		integer JunengCount = 0
		/*
		    带新统计
		*/
		integer array Idaixin
		boolean BJiulun = false
		boolean BHaojie = false
		//杀擂台十的英雄统计
		integer array Ileishi
		//DIY名字
		string array SDIY
		//没被碰到
		boolean BShengming = false
		//签到指数
		//integer array IQiandao2
		//总数不存在20个
		boolean BZongshu = false
		//箱子
		string array SBoxWord
		//不说话的成就
		boolean BSlince = false
	endglobals
//---------------------------------------------------------------------------------------------------
	/*
	    给所有玩家一个成就
	*/
	function SaveAllPlayerAchievement takes integer id returns nothing
		local integer i = 1
		loop
			exitwhen i > 6
			if ((GetPlayerSlotState(ConvertedPlayer(i)) == PLAYER_SLOT_STATE_PLAYING) and (GetPlayerController(ConvertedPlayer(i)) == MAP_CONTROL_USER)) then
				call GetAchievementAndSave(ConvertedPlayer(i),id)
			endif
			set i = i +1
		endloop
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    获取平台的金币
	*/
	function GetPlatformLevelGold takes player p returns nothing
		if (DzAPI_Map_GetMapLevel(p) >= 20) then
			call AdjustPlayerStateBJ( 8000, p , PLAYER_STATE_RESOURCE_GOLD )
		elseif (DzAPI_Map_GetMapLevel(p) >= 15) then
			call AdjustPlayerStateBJ( 6000, p , PLAYER_STATE_RESOURCE_GOLD )
		elseif (DzAPI_Map_GetMapLevel(p) >= 10 or true) then
			call AdjustPlayerStateBJ( 4000, p , PLAYER_STATE_RESOURCE_GOLD )
		elseif (DzAPI_Map_GetMapLevel(p) >= 5) then
			call AdjustPlayerStateBJ( 2000, p , PLAYER_STATE_RESOURCE_GOLD )
		endif
	endfunction
//-----------------------------------------------------------------1---------------------------------
	/*
	    判断一个玩家是否通关了某一个难度或者以上
	*/
	private function IsPass takes player p,integer nan returns boolean
		local integer i = 9
		loop
			exitwhen i < nan
			if (GetBit(achieve[GetConvertedPlayerId(p)],i) > 0) then
				return true
			endif
			set i = i - 1
		endloop
		return false
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    激活所有皮肤(空)
	*/
	function ActivateAllSpin takes player p returns nothing
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    幻逸的提示文本
	*/
	function GetHuanyiHint takes nothing returns string
		return "|cff99ccff需要地图等级达到2级才能选取该英雄|r"
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    梦霁的提示文本
	*/
	function GetMengjiHint takes nothing returns string
		return "|cff99ccff需要地图等级达到6级才能选取该英雄|r"
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    苍凌的提示文本
	*/
	function GetCanglingHint takes nothing returns string
		return "|cff99ccff需要地图等级达到8级才能选取该英雄|r"
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    星胧的提示文本
	*/
	function GetXinglongHint takes nothing returns string
		return "|cff99ccff需要地图等级达到11级才能选取该英雄|r"
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    霄霆的提示文本
	*/
	function GetXiaotingHint takes nothing returns string
		return "|cff99ccff考虑到操作对新手可能不友好,通关炼狱难度后证明自己的实力即可选取|r"
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    提示当前平台等级
	*/
	function PrintCurrentPlatformLevel takes player p returns nothing
		call DisplayTextToPlayer(p, 0., 0., "|cFFFF66CC【消息】|r当前你的平台地图等级为：" + I2S(DzAPI_Map_GetMapLevel(p)) + "！")
		// call QixiHuodong(p)
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    彩名皮肤
	*/
	function IsColorSpin takes player p returns boolean
		return (GetBit(spin[GetConvertedPlayerId(p)],1) > 0)
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    幻逸选取条件
	*/
	function GetHuanyiSelectedCon takes player p returns boolean
		return (DzAPI_Map_GetMapLevel(p) >= 2)
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    梦霁选取条件
	*/
	function GetMengjiSelectedCon takes player p returns boolean
		return (DzAPI_Map_GetMapLevel(p) >= 6)
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    苍凌选取条件
	*/
	function GetCanglingSelectedCon takes player p returns boolean
		return (DzAPI_Map_GetMapLevel(p) >= 8)
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    星胧选取条件
	*/
	function GetXinglongSelectedCon takes player p returns boolean
		return (DzAPI_Map_GetMapLevel(p) >= 11)// or GetPlayerWordCount(p) >= 8
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    霄霆选取条件
	*/
	function GetXiaotingSelectedCon takes player p returns boolean
		return IsPass(p,5)
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    输出密码
	*/
	function PrintMengjiPassword takes nothing returns nothing
	endfunction
	function PrintCanglingPassword takes nothing returns nothing
	endfunction
	function PrintXinglongPassword takes nothing returns nothing
	endfunction
	function PrintXiaotingPassword takes nothing returns nothing
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    初始化每位玩家的成就
	*/
	function InitAllAchievement takes nothing returns nothing
		local integer i = 1
		loop
			exitwhen i > 6
			if ((GetPlayerSlotState(ConvertedPlayer(i)) == PLAYER_SLOT_STATE_PLAYING) and (GetPlayerController(ConvertedPlayer(i)) == MAP_CONTROL_USER)) then
    			set achieve[i] = S2I(DzAPI_Map_GetStoredString(ConvertedPlayer(i), "achieve"))
    			set achieve2[i] = DzAPI_Map_GetStoredInteger(ConvertedPlayer(i), "achieve2")
    			set achieve3[i] = DzAPI_Map_GetStoredInteger(ConvertedPlayer(i), "achieve3")
    			set achieve4[i] = DzAPI_Map_GetStoredInteger(ConvertedPlayer(i), "achieve4")
    			set vipCode[i] = DzAPI_Map_GetStoredInteger(ConvertedPlayer(i), "vip")
    			set achiPage[i] = DzAPI_Map_GetStoredInteger(ConvertedPlayer(i), "page")
    			set heroCountString[i] = DzAPI_Map_GetStoredString(ConvertedPlayer(i), "hero")
    			set spin[i] = DzAPI_Map_GetStoredInteger(ConvertedPlayer(i), "spin")
    			set diyu[i] = DzAPI_Map_GetStoredInteger(ConvertedPlayer(i), "defense")
    			set mingcha[i] = DzAPI_Map_GetStoredInteger(ConvertedPlayer(i), "mingcha")
    			/*set passTimes[i] = DzAPI_Map_GetStoredInteger(ConvertedPlayer(i), "pass")
    			set petTimes[i] = DzAPI_Map_GetStoredInteger(ConvertedPlayer(i), "pet")
    			set pass1[i] = DzAPI_Map_GetStoredInteger(ConvertedPlayer(i), "pass1")
    			set pass2[i] = DzAPI_Map_GetStoredInteger(ConvertedPlayer(i), "pass2")
    			set pass3[i] = DzAPI_Map_GetStoredInteger(ConvertedPlayer(i), "pass3")
    			set pass4[i] = DzAPI_Map_GetStoredInteger(ConvertedPlayer(i), "pass4")
    			set pass5[i] = DzAPI_Map_GetStoredInteger(ConvertedPlayer(i), "pass5")
    			set pass6[i] = DzAPI_Map_GetStoredInteger(ConvertedPlayer(i), "pass6")
    			set pass7[i] = DzAPI_Map_GetStoredInteger(ConvertedPlayer(i), "pass7")
    			set pass8[i] = DzAPI_Map_GetStoredInteger(ConvertedPlayer(i), "pass8")
    			set pass9[i] = DzAPI_Map_GetStoredInteger(ConvertedPlayer(i), "pass9")*/
    			set Idaixin[i] = DzAPI_Map_GetStoredInteger(ConvertedPlayer(i), "daixin")
    			set Ileishi[i] = DzAPI_Map_GetStoredInteger(ConvertedPlayer(i), "leishi")
    			set SDIY[i] = DzAPI_Map_GetStoredString(ConvertedPlayer(i), "diy")
    			set Greward[i] = DzAPI_Map_GetStoredInteger(ConvertedPlayer(i), "Greward")
    			set Greward2[i] = DzAPI_Map_GetStoredString(ConvertedPlayer(i), "Greward2")
    			set SJizi[i] = DzAPI_Map_GetStoredString(ConvertedPlayer(i), "SJizi")
    			set IConDays[i] = DzAPI_Map_GetStoredInteger(ConvertedPlayer(i), "IConDays")
    			set ILastTime[i] = DzAPI_Map_GetStoredInteger(ConvertedPlayer(i), "ILastTime")
    			//签到指数
    			//set IQiandao2[i] = DzAPI_Map_GetStoredInteger(ConvertedPlayer(i), "IQiandao2")
    			set spin2[i] = DzAPI_Map_GetStoredInteger(ConvertedPlayer(i), "spin2")
    			set spin3[i] = DzAPI_Map_GetStoredInteger(ConvertedPlayer(i), "spin3")
    			set easyCString[i] = DzAPI_Map_GetStoredString(ConvertedPlayer(i), "easyCString")
    			set middleCString[i] = DzAPI_Map_GetStoredString(ConvertedPlayer(i), "middleCString")
    			set hardCString[i] = DzAPI_Map_GetStoredString(ConvertedPlayer(i), "hardCString")
    			set SBoxWord[i] = DzAPI_Map_GetStoredString(ConvertedPlayer(i), "SBoxWord")
    			set SFanzhaun[i] = DzAPI_Map_GetStoredString(ConvertedPlayer(i), "SFanzhaun")
    			//全局变量
    			set IKuanghuan = S2I(DzAPI_Map_GetMapConfig("kh"))
    			call DisplayTextToPlayer(ConvertedPlayer(i), 0., 0., "|cFFFF66CC【消息】|r读取数据中.....")
			endif
			set i = i +1
		endloop
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    判断是否读档成功
	*/
	function JudgeCundang takes nothing returns nothing
		local integer i = 1
		loop
			exitwhen i > 6
			if (GetPlayerServerValueSuccess(ConvertedPlayer(i))) then
				set Bdudang[i] = true
			else
				set Bdudang[i] = false
			endif
			set i = i +1
		endloop
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    隐藏密码的判定
	*/
	function TSpeakPassword takes nothing returns nothing
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    初始旧版本的成就
	*/
	function InitOldAchievement takes integer id returns nothing
		if (GetBit(achieve[id],9) > 0) then
			set achiPage[id] = 19
		elseif (GetBit(achieve[id],8) > 0) then
			set achiPage[id] = 18
		elseif (GetBit(achieve[id],7) > 0) then
			set achiPage[id] = 17
		elseif (GetBit(achieve[id],6) > 0) then
			set achiPage[id] = 16
		elseif (GetBit(achieve[id],5) > 0) then
			set achiPage[id] = 15
		elseif (GetBit(achieve[id],4) > 0) then
			set achiPage[id] = 14
		elseif (GetBit(achieve[id],3) > 0) then
			set achiPage[id] = 13
		elseif (GetBit(achieve[id],2) > 0) then
			set achiPage[id] = 12
		elseif (GetBit(achieve[id],1) > 0) then
			set achiPage[id] = 11
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    统计总死亡次数
	*/
	private function GetTotalDeathCount takes nothing returns integer
		local integer i = 1
		local integer result = 0
		loop
			exitwhen i > 6
			set result = result + deathCount[i]
			set i = i +1
		endloop
		return result
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    统计带新人数并保存
	*/
	function SaveDaixin takes integer index returns nothing
		local integer i = 1
		loop
			exitwhen i > 6
			if ((GetPlayerSlotState(ConvertedPlayer(i)) == PLAYER_SLOT_STATE_PLAYING) and (GetPlayerController(ConvertedPlayer(i)) == MAP_CONTROL_USER) and (index != i) and (DzAPI_Map_GetMapLevel(ConvertedPlayer(i))<= 5)) then
				set Idaixin[index] = Idaixin[index] + 1
			endif
			set i = i +1
		endloop
		if (Idaixin[index] >= 100) then
			call GetAchievementAndSave(ConvertedPlayer(index),324)
		else
			call DisplayTextToPlayer(ConvertedPlayer(index), 0., 0., GetAchievementName(324)+"|r"+I2S(Idaixin[index])+"/100.")
	    	call DzAPI_Map_StoreInteger( ConvertedPlayer(index), "daixin", Idaixin[index] )
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    递增通关次数/恶魔反转
	*/
	function IncreaseYanmieFanzhuan takes player p returns nothing
		local integer i = GetConvertedPlayerId(p)
		if (diyu[i]/100000 < 5) then
			set diyu[i] = diyu[i] + 100000
			call DzAPI_Map_StoreInteger( ConvertedPlayer(i), "defense", diyu[i] )
			call DisplayTextToPlayer(p, 0., 0., "|cFFFF66CC【消息】|r湮灭技能第二形态进度:"+I2S(diyu[i]/100000)+"/5")
		endif
		if (diyu[i]/100000 >= 5) then
			call SetFanzhuanOK(p,2)
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    存储到服务器,通关
	*/
	function SaveAchievement takes nothing returns nothing
		local integer i = 1
		local integer level = GetDiffculty()
		call BJDebugMsg("|cFFFF66CC【消息】|r正在保存游戏数据中....请不要马上退出游戏,以免保存失败...")
		loop
			exitwhen i > 6
			if ((GetPlayerSlotState(ConvertedPlayer(i)) == PLAYER_SLOT_STATE_PLAYING) and (GetPlayerController(ConvertedPlayer(i)) == MAP_CONTROL_USER)) then
				//通关称号
				call GetAchievementAndSave(ConvertedPlayer(i),I3(level == 9,325,10 + level))
				//单通称号
				if (renshu == 1 and level != 9) then
					call GetAchievementAndSave(ConvertedPlayer(i),I3(level < 8,217 - level,29))
				endif
				//玄雪末日权杖
				if (renshu == 1 and udg_H[i] == xuanxue and level >= 4) then
					call SetXuanxue1SpinOK(ConvertedPlayer(i))
				endif
				if (level >= 4) then
					call IncreaseYanmieFanzhuan(ConvertedPlayer(i))
				endif
				//基地的血
				if (udg_I_Er_diansi[1] == 0) then
					call GetAchievementAndSave(ConvertedPlayer(i),221)
					if (GetUnitState(gg_unit_haro_0030,UNIT_STATE_LIFE) <= (0.25 * GetUnitState(gg_unit_haro_0030,UNIT_STATE_MAX_LIFE))) then
						call GetAchievementAndSave(ConvertedPlayer(i),222)
					endif
				endif
				if not(BBaseDamage) then
					call GetAchievementAndSave(ConvertedPlayer(i),320)
				endif
				if (GetTotalDeathCount() < 1) then
					call GetAchievementAndSave(ConvertedPlayer(i),310)
				endif
				call SaveDaixin(i)
				if not(BJiulun) then
					call GetAchievementAndSave(ConvertedPlayer(i),323)
				endif
				if not(BHaojie) then
					call GetAchievementAndSave(ConvertedPlayer(i),327)
				endif
				if not (BSlince) then
					call GetAchievementAndSave(ConvertedPlayer(i),416)
				endif
				if not(BZongshu)then
					call GetAchievementAndSave(ConvertedPlayer(i),49)
				endif
				if (CT3())then
					call GetAchievementAndSave(ConvertedPlayer(i),410)
				endif
				if (CT4())then
					call GetAchievementAndSave(ConvertedPlayer(i),411)
				endif
				if (CType != 0 and CType != -1) then
					call ChallangerSuccess(ConvertedPlayer(i))
				endif
				if (CType == -1 and level == 9 and renshu == 1) then
					call GetAchievementAndSave(ConvertedPlayer(i),418)
				endif
				if (CType == -1 and IsTianyan) then
					call GetAchievementAndSave(ConvertedPlayer(i),420)
				endif
			endif
			set i = i +1
		endloop
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    击败傀儡1
	*/
	function SaveAchievementKuilei1 takes nothing returns nothing
		local integer i = 1
		local integer level = GetDiffculty()
		call BJDebugMsg("|cFFFF66CC【消息】|r正在保存游戏数据中....请不要马上退出游戏,以免保存失败...")
		loop
			exitwhen i > 6
			if ((GetPlayerSlotState(ConvertedPlayer(i)) == PLAYER_SLOT_STATE_PLAYING) and (GetPlayerController(ConvertedPlayer(i)) == MAP_CONTROL_USER)) then
				if (not(BShengming) and udg_RENSHU >= 4) then
					call GetAchievementAndSave(ConvertedPlayer(i),45)
				endif
			endif
			set i = i +1
		endloop
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    击败傀儡2
	*/
	function SaveAchievementKuilei2 takes nothing returns nothing
		local integer i = 1
		local integer level = GetDiffculty()
		call BJDebugMsg("|cFFFF66CC【消息】|r正在保存游戏数据中....请不要马上退出游戏,以免保存失败...")
		loop
			exitwhen i > 6
			if ((GetPlayerSlotState(ConvertedPlayer(i)) == PLAYER_SLOT_STATE_PLAYING) and (GetPlayerController(ConvertedPlayer(i)) == MAP_CONTROL_USER)) then
				call GetAndSaveCangku(ConvertedPlayer(i),9)
			endif
			set i = i +1
		endloop
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	     击败冥刹后的成就
	*/
	function SaveAchievement2 takes nothing returns nothing
		local integer i = 1
		loop
			exitwhen i > 6
			if ((GetPlayerSlotState(ConvertedPlayer(i)) == PLAYER_SLOT_STATE_PLAYING) and (GetPlayerController(ConvertedPlayer(i)) == MAP_CONTROL_USER)) then
				//通关称号,时间
				if (IsClassic()) then
					if (udg_Second[2] < 135) then
						call GetAchievementAndSave(ConvertedPlayer(i),223)
					endif
					if (udg_Second[2] < 120) then
						call GetAchievementAndSave(ConvertedPlayer(i),224)
					endif
					if (udg_Second[2] < 90) then
						call GetAchievementAndSave(ConvertedPlayer(i),225)
					endif
					if (udg_Second[2] < 60) then
						call GetAchievementAndSave(ConvertedPlayer(i),226)
					endif
				endif
			endif
			set i = i +1
		endloop
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    转生的成就
	*/
	function SaveAchievement3 takes player p,integer zhuan returns nothing
		if (zhuan >= 20) then
			call GetAchievementAndSave(p,21)
		endif
		if (zhuan >= 50) then
			call GetAchievementAndSave(p,22)
		endif
		if (zhuan >= 100) then
			call GetAchievementAndSave(p,23)
		endif
		if (zhuan == 125 and udg_H[GetConvertedPlayerId(p)] == yanmie) then
			call SetYanmieSpinOK(p)
		endif
		if (zhuan >= 150) then
			call GetAchievementAndSave(p,24)
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    木材的成就
	*/
	function TGetAchievementLumber takes nothing returns nothing
		call GetAchievementAndSave(GetTriggerPlayer(),25)
		if (GetPlayerState(GetTriggerPlayer(), PLAYER_STATE_RESOURCE_LUMBER) > 50000) then
			call GetAchievementAndSave(GetTriggerPlayer(),26)
		endif
		if (GetPlayerState(GetTriggerPlayer(), PLAYER_STATE_RESOURCE_LUMBER) > 100000) then
			call GetAchievementAndSave(GetTriggerPlayer(),27)
		endif
		if (GetPlayerState(GetTriggerPlayer(), PLAYER_STATE_RESOURCE_LUMBER) > 200000) then
			call GetAchievementAndSave(GetTriggerPlayer(),28)
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
		PIV
	*/
	function SavePIV takes player p,integer i returns nothing
    	call DzAPI_Map_StoreInteger( p, "vip", i )
	endfunction
	function IsSavePIV takes player p,integer i returns boolean
		return vipCode[GetConvertedPlayerId(p)] == i
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    自增
	*/
	function IncreaseHeroCount takes player p, integer i returns nothing
		local integer index = GetConvertedPlayerId(p)
		local integer length
		local integer times
		local string temp
		if (i<1 or i>31) then
			return
		endif
		if not(Bdudang[index]) then
			call DisplayTextToPlayer(p, 0., 0., "|cFFFF66CC【消息】|r本局游戏英雄次数数据读取失败,请重新开始游戏.")
			return
		endif
		if (StringLength(heroCountString[index]) < 62) then
			set heroCountString[index] = "00000000000000000000000000000000000000000000000000000000000000"
		endif
		set length = StringLength(heroCountString[index])
		set times = S2I(SubStringBJ(heroCountString[index],2*i -1,2*i))
		set temp = heroCountString[index]
		set times = IMinBJ(99,times+1)
		set heroCountString[index] = SubStringBJ(temp,1,2*i - 2)
		if (times < 10) then
			set heroCountString[index] = heroCountString[index] + "0" +I2S(times)
		else
			set heroCountString[index] = heroCountString[index] + I2S(times)
		endif
		set heroCountString[index] = heroCountString[index] + SubStringBJ(temp,2*i+1,length)
		set temp = null
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    获取当前英雄使用次数
	*/
	function GetHeroTimes takes player p returns integer
		local unit u = udg_H[GetConvertedPlayerId(p)]
		local integer i = GetHeroIndex(GetUnitTypeId(u))
		set u = null
		return GetSpecifyHeroTimes(p,i)
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    获取最高使用的英雄
	*/
	function GetBestHero takes player p returns integer
		local integer max = 0
		local integer maxIndex = 0
		local integer i = HERO_COUNT
		loop
			exitwhen i < 1
			if ((GetSpecifyHeroTimes(p,i) > max) or (GetSpecifyHeroTimes(p,i) == max and GetHeroIndex(GetUnitTypeId(udg_H[GetConvertedPlayerId(p)])) == i)) then
				set max = GetSpecifyHeroTimes(p,i)
				set maxIndex = i
			endif
			set i = i - 1
		endloop
		return maxIndex
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    打印所有英雄
	*/
	function PrintAllHeroTimes takes player p returns nothing
		local string result = ""
		local integer i = 1
		if not(Bdudang[GetConvertedPlayerId(p)]) then
			call DisplayTextToPlayer(p, 0., 0., "|cFFFF66CC【消息】|r本局游戏英雄次数数据读取失败,请重新开始游戏.")
			return
		endif
		call DisplayTextToPlayer(p, 0., 0., "|cFFFF66CC【消息】|r你的所有英雄使用次数如下所示：")
		loop
			exitwhen i > HERO_COUNT
			set result = result + GetIndexHeroColorName(i) + "的使用次数:" + I2S(GetSpecifyHeroTimes(p,i)) + ","
			if (ModuloInteger(i,3) == 0) then
				call DisplayTextToPlayer(p, 0., 0., result)
				set result = ""
			endif
			set i = i +1
		endloop
		if (result != "") then
			call DisplayTextToPlayer(p, 0., 0., result)
		endif
		set result = null
		call DisplayTextToPlayer(p, 0., 0., "|cFFFF66CC【消息】|r如果你想调节视角高度,请输入-+")
		call DisplayTextToPlayer(p, 0., 0., "|cFFFF66CC【消息】|r如果你想隐藏技能伤害,请输入-sh(不推荐新手输入)")
		//call DisplayTextToPlayer(p, 0., 0., "|cFFFF66CC【消息】|r如果你想取消彩色皮肤,请输入-qc")
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    死亡次数的成就：无心冢
	*/
	function SaveDeathAchievement takes player p returns nothing
		set deathCount[GetConvertedPlayerId(p)] = deathCount[GetConvertedPlayerId(p)] + 1
		if (deathCount[GetConvertedPlayerId(p)] >= 100) then
			call GetAchievementAndSave(p,231)
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    戒指的成就:孤心戒
	*/
	function SaveRingAchievement takes player p,integer count returns nothing
		if (count == 120) then
			call GetAchievementAndSave(p,321)
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    秘境的成就
	*/
	function SaveMijingAchievement takes integer count returns nothing
		local integer i = 1
		if (count <13) then
			return
		endif
		loop
			exitwhen i > 6
			if ((GetPlayerSlotState(ConvertedPlayer(i)) == PLAYER_SLOT_STATE_PLAYING) and (GetPlayerController(ConvertedPlayer(i)) == MAP_CONTROL_USER)) then
				if (count >= 13) then
					call GetAchievementAndSave(ConvertedPlayer(i),36)
				endif
				if (count >= 15) then
					call GetAchievementAndSave(ConvertedPlayer(i),37)
				endif
				if (count >= 17) then
					call GetAchievementAndSave(ConvertedPlayer(i),38)
				endif
				if (count >= 20) then
					call GetAchievementAndSave(ConvertedPlayer(i),39)
				endif
			endif
			set i = i +1
		endloop
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    巨能成就
	*/
	function SaveJunengAchievement takes nothing returns nothing
		set JunengCount = JunengCount + 1
		if (JunengCount >= 6) then
			call SaveAllPlayerAchievement(311)
		endif
		if (JunengCount >= 20) then
			call SaveAllPlayerAchievement(312)
		endif
		if (JunengCount >= 12 and GetDiffculty() >= 8) then
			call SaveAllPlayerAchievement(313)
		endif
		if (JunengCount >= 40 and GetDiffculty() >= 8) then
			call SaveAllPlayerAchievement(314)
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    A门的成就：封神门
	*/
	function SaveDoorAchievement takes nothing returns nothing
		local integer i = 1
		if (udg_Second[2] >= 8) then
			return
		endif
		loop
			exitwhen i > 6
			if ((GetPlayerSlotState(ConvertedPlayer(i)) == PLAYER_SLOT_STATE_PLAYING) and (GetPlayerController(ConvertedPlayer(i)) == MAP_CONTROL_USER)) then
				call GetAchievementAndSave(ConvertedPlayer(i),326)
			endif
			set i = i +1
		endloop
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    属性的成就,及月饼
	*/
	private function SaveAttrAchievement takes nothing returns nothing
		local integer i = 1
		local integer attr = 0
		loop
			exitwhen i > 6
			if ((GetPlayerSlotState(ConvertedPlayer(i)) == PLAYER_SLOT_STATE_PLAYING) and (GetPlayerController(ConvertedPlayer(i)) == MAP_CONTROL_USER)) then
				if (udg_H[i] != null) then
					set attr = GetHeroStr(udg_H[i],true) + GetHeroInt(udg_H[i],true) + GetHeroAgi(udg_H[i],true)
					if ( attr > 3000000) then
						call GetAchievementAndSave(ConvertedPlayer(i),315)
					endif
					if ( attr > 8000000) then
						call GetAchievementAndSave(ConvertedPlayer(i),316)
					endif
					if ( attr > 20000000) then
						call GetAchievementAndSave(ConvertedPlayer(i),317)
					endif
					if ( attr > 35000000 and udg_H[i] == sichen) then
						call SetSichenSpinOK(ConvertedPlayer(i))
					endif
					if ( attr > 50000000) then
						call GetAchievementAndSave(ConvertedPlayer(i),318)
					endif
				endif
			endif
			set i = i +1
		endloop
		// if (udg_RENSHU > 0) then
		// 	if (ModuloInteger(udg_Second[2],60/udg_RENSHU) == 0 and (udg_Second[2] != 0 or udg_RENSHU > 1)) then
		// 		call CreateYuebing(GetRectRandomX(GetPlayableMapRect()),GetRectRandomY(GetPlayableMapRect()))
		// 	endif
		// endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    杀擂台十的成就
	*/
	function SaveKillLeishi takes player p returns nothing
		set Ileishi[GetConvertedPlayerId(p)] = SetIntegerBit(Ileishi[GetConvertedPlayerId(p)],GetHeroIndex(GetUnitTypeId(udg_H[GetConvertedPlayerId(p)]))+1,true)
		if (GetIntegerHasOne(Ileishi[GetConvertedPlayerId(p)])>=12) then
			call GetAchievementAndSave(p,322)
		else
			call DisplayTextToPlayer(p, 0., 0., GetAchievementName(322)+"|r"+I2S(GetIntegerHasOne(Ileishi[GetConvertedPlayerId(p)]))+"/12.")
		endif
    	call DzAPI_Map_StoreInteger( p, "leishi", Ileishi[GetConvertedPlayerId(p)] )
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    杀怪成就
	*/
	function SaveAchievement5 takes player p, integer count returns nothing
		set killCount[GetConvertedPlayerId(p)] = killCount[GetConvertedPlayerId(p)] + count
		if (killCount[GetConvertedPlayerId(p)] >= 15000) then
			call GetAchievementAndSave(p,227)
		endif
		if (killCount[GetConvertedPlayerId(p)] >= 40000) then
			call GetAchievementAndSave(p,228)
		endif
		if (killCount[GetConvertedPlayerId(p)] >= 80000) then
			call GetAchievementAndSave(p,229)
		endif
		if (killCount[GetConvertedPlayerId(p)] >= 150000) then
			call GetAchievementAndSave(p,230)
		endif
		if (killCount[GetConvertedPlayerId(p)] >= 125000 and udg_H[GetConvertedPlayerId(p)] == sheyan ) then
			call SetSheyanSpinOK(p)
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
		检测1:到达1%以下
	*/
	function Jiance1 takes unit u returns nothing
        local real percentThousand = (GetUnitState(u,UNIT_STATE_LIFE) * 1000.)/GetUnitState(u,UNIT_STATE_MAX_LIFE)
        if (UnitHasBuffBJ(u,'Bapl') or UnitHasBuffBJ(u,'Bpoi') or UnitHasBuffBJ(u,'Bpsd')) then
        	call DisplayTextToPlayer(GetOwningPlayer(u), 0., 0., "|cFFFF66CC【消息】|r你拥有中毒BUFF.")
        	return
        endif
        if (percentThousand < 10 and IsUnitAliveBJ(u) and not(BHeroDeath[GetConvertedPlayerId(GetOwningPlayer(u))])) then
			call GetAchievementAndSave(GetOwningPlayer(u),412)
        endif
        call DisplayTextToPlayer(GetOwningPlayer(u), 0., 0., "|cFFFF66CC【消息】|r你当前的生命为千分之"+R2S(percentThousand)+".")
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
		检测2:到达5E
	*/
	function Jiance2 takes unit u returns nothing
        local real life = GetUnitState(u,UNIT_STATE_MAX_LIFE)
        if (life > 500000000) then
			call GetAchievementAndSave(GetOwningPlayer(u),413)
        endif
        call DisplayTextToPlayer(GetOwningPlayer(u), 0., 0., "|cFFFF66CC【消息】|r你当前的生命为"+R2S(life)+".")
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
		检测3:防御检测
	*/
	function Jiance3 takes unit u returns nothing
        local integer defense = GetHeroAgi(u,true)/100 + GetDefense(u)
        if (defense > 1000000) then
			call GetAchievementAndSave(GetOwningPlayer(u),414)
        endif
        call DisplayTextToPlayer(GetOwningPlayer(u), 0., 0., "|cFFFF66CC【消息】|r你判定的防御为"+R2S(defense)+".")
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    总伤害成就
	*/
	function SaveAchievement6 takes player p, integer damage2 returns nothing
		if (damage2 >= 500) then
			call GetAchievementAndSave(p,32)
		endif
		if (damage2 >= 4000) then
			call GetAchievementAndSave(p,33)
		endif
		if (damage2 >= 30000) then
			call GetAchievementAndSave(p,34)
		endif
		if (damage2 >= 600000) then
			call GetAchievementAndSave(p,35)
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
		抓宠物的成就
	*/
	function SavePetAchievement takes player p,integer level returns nothing
		if (level >= 50) then
			call GetAchievementAndSave(p,328)
		endif
		if (level >= 70) then
			call GetAchievementAndSave(p,329)
		endif
		if (level >= 100) then
			call GetAchievementAndSave(p,330)
		endif
		if (level >= 150) then
			call GetAchievementAndSave(p,331)
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    英雄次数的成就
	*/
	function SaveAchievement4 takes player p returns nothing
		if (GetLowerHeroCount(p,1,12)) then
			call GetAchievementAndSave(p,217)
		endif
		if (GetLowerHeroCount(p,5,12)) then
			call GetAchievementAndSave(p,218)
		endif
		if (GetLowerHeroCount(p,10,12)) then
			call GetAchievementAndSave(p,219)
		endif
		if (GetLowerHeroCount(p,30,12)) then
			call GetAchievementAndSave(p,220)
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    存储所有英雄的使用次数
	*/
	private function SaveAllHeroTimes takes nothing returns nothing
		local timer t = GetExpiredTimer()
		local integer id = GetHandleId(t)
		local player p = ConvertedPlayer(LoadInteger(LHTable,id,kSaveHeroTimes))
		local integer i = GetHeroIndex(GetUnitTypeId(udg_H[GetConvertedPlayerId(p)]))
		call IncreaseHeroCount(p,i)
		if (Bdudang[GetConvertedPlayerId(p)]) then
			call DzAPI_Map_StoreString( p, "hero", heroCountString[GetConvertedPlayerId(p)] )
	    	call DzAPI_Map_Stat_SetStat( p, "hero", GetIndexHeroName(GetBestHero(p)) )
	    else
	    	call ShowGameHint(p,"
	    		本局游戏数据读取失败,建议重新开始游戏.
	    		(还是能正常游戏,但是不能获得成就与皮肤)")
		endif
		call PrintAllHeroTimes(p)
		call SaveAchievement4(p)
		call PauseTimer(t)
		call FlushChildHashtable(LHTable,id)
		call DestroyTimer(t)
		set t = null
		set p = null
	endfunction
	/*
	    开启定时器，然后自增
	*/
	function CreateAllHeroTimesTimer takes player p returns nothing
		local timer t = CreateTimer()
		call SaveInteger(LHTable,GetHandleId(t),kSaveHeroTimes,GetConvertedPlayerId(p))
		call TimerStart(t,10,false,function SaveAllHeroTimes)
		set t = null
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    判断是否有人超级六界王
	*/
	function GetSuperLiujiewang takes nothing returns player
		local integer i = 1
		loop
			exitwhen i > 6
			if (IsAchieveOK(ConvertedPlayer(i),48)) then
				return ConvertedPlayer(i)
			endif
			set i = i +1
		endloop
		return null
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    自定义成就名的使用
	*/
	function SetAndSaveDIYName takes player p returns nothing
		local integer id = GetConvertedPlayerId(p)
		set achiPage[id] = -1
		call SaveAchievePointer(p)
		call SetPlayerName(p, GetRandomColor() +"【" + GetRandomColor() + SDIY[id] + GetRandomColor() + "】" + GetRandomColor() + playerName[id] + "|r")
		call DzAPI_Map_Stat_SetStat( p, "achi", SDIY[id] )
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    初始化游戏名
	*/
	function InitAchievementName takes unit u returns nothing
		local integer id = GetConvertedPlayerId(GetOwningPlayer(u))
		//计时英雄数
		call CreateAllHeroTimesTimer(GetOwningPlayer(u))
		if (achiPage[id] == -1 and (IsQuanchengjiu(GetOwningPlayer(u)) or playerName[id] == "信哲大人")) then
			call SetAndSaveDIYName(GetOwningPlayer(u))
		else
			if (StringLength(I2S(achiPage[id])) < 2 or achiPage[id] < 0) then
				set achiPage[id] = 10
				call InitOldAchievement(id)
				call SaveAchievePointer(GetOwningPlayer(u))
			endif
			call SetAchievement(GetOwningPlayer(u),achiPage[id])
		endif
		if (IsAchieveOK(GetOwningPlayer(u),47)) then
			call BJDebugMsg(GetPlayerName(GetOwningPlayer(u))+"|cff00ff00受到了来自圣界的欢迎!!!|r")
			call BJDebugMsg(GetPlayerName(GetOwningPlayer(u))+"|cff00ff00受到了来自圣界的欢迎!!!|r")
			call BJDebugMsg(GetPlayerName(GetOwningPlayer(u))+"|cff00ff00受到了来自圣界的欢迎!!!|r")
			call BJDebugMsg(GetPlayerName(GetOwningPlayer(u))+"|cff00ff00受到了来自圣界的欢迎!!!|r")
			call BJDebugMsg(GetPlayerName(GetOwningPlayer(u))+"|cff00ff00受到了来自圣界的欢迎!!!|r")
			call BJDebugMsg(GetPlayerName(GetOwningPlayer(u))+"|cff00ff00受到了来自圣界的欢迎!!!|r")
			call BJDebugMsg(GetPlayerName(GetOwningPlayer(u))+"|cff00ff00受到了来自圣界的欢迎!!!|r")
			call BJDebugMsg(GetPlayerName(GetOwningPlayer(u))+"|cff00ff00受到了来自圣界的欢迎!!!|r")
			call BJDebugMsg(GetPlayerName(GetOwningPlayer(u))+"|cff00ff00受到了来自圣界的欢迎!!!|r")
			call BJDebugMsg(GetPlayerName(GetOwningPlayer(u))+"|cff00ff00受到了来自圣界的欢迎!!!|r")
		endif
		call InitChallangerData(GetOwningPlayer(u))
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    自定义成就名
	*/
	function SetDIYName takes player p,string s returns nothing
		local integer i = GetConvertedPlayerId(p)
		call DisplayTextToPlayer(p, 0., 0., "|cFFFF66CC【消息】|r你已经成就将成就自定义成:"+s+".")
		set SDIY[i] = s
		call DzAPI_Map_StoreString( p, "diy", SDIY[i] )
		call SetAndSaveDIYName(p)
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    指令获取成就
	*/
	function Huoquachi takes player p ,string chat,integer page returns nothing
		local integer i = 1
		local integer result = 0
		loop
			exitwhen i > 40
			if (chat == I2S(GetCycleHash(playerName[GetConvertedPlayerId(p)]+"ac"+I2S(page)+I2S(i),1))) then
				call GetAchievementAndSave(p,S2I(I2S(page)+I2S(i)))
				exitwhen true
			endif
			set i = i +1
		endloop
		set BBuqian2 = false
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    初始化
	*/
	function InitVersion takes nothing returns nothing
		local trigger t = CreateTrigger()
		local integer i = 1
    	call CreateUnit(Player(PLAYER_NEUTRAL_PASSIVE), 'n01L', - 9816.0, - 5968.0, 270.000)
    	set UChengjiu = CreateUnit(Player(6), 'n01K', -14504.0, -14040.0, 270.000)
		loop
			exitwhen i > 6
			if ((GetPlayerSlotState(ConvertedPlayer(i)) == PLAYER_SLOT_STATE_PLAYING) and (GetPlayerController(ConvertedPlayer(i)) == MAP_CONTROL_USER)) then
			    call TriggerRegisterPlayerStateEvent( t, ConvertedPlayer(i), PLAYER_STATE_RESOURCE_LUMBER, GREATER_THAN_OR_EQUAL, 20000.00 )
			    set deathCount[i] = 0
			    set killCount[i] = 0
			endif
			set i = i +1
		endloop
		call TriggerAddAction(t, function TGetAchievementLumber)
		call TimerStart(CreateTimer(),60,true,function SaveAttrAchievement)
		set t = null
	endfunction
endlibrary
///#include  "edit/Box.j"
library_once BaseVersion initializer InitBaseVersion requires LHBase,Box,Version
	globals
		boolean array BDIYName
		//获取仓库与皮肤
		boolean BCangkuhuoqu = false
		boolean BSpinhuoqu = false
		integer ISpinachi = 0
	endglobals
	private function TSpeakPasswordBase takes nothing returns nothing
		local string chat = GetEventPlayerChatString()
		debug if (BDIYName[GetConvertedPlayerId(GetTriggerPlayer())]) then
			debug call SetDIYName(GetTriggerPlayer(),chat)
			debug set BDIYName[GetConvertedPlayerId(GetTriggerPlayer())] = false
		debug elseif (BBuqian1) then
		debug call Buqian2(GetTriggerPlayer(),GetEventPlayerChatString())
		debug elseif (BBuqian2) then
		debug call Buqian3(GetTriggerPlayer(),GetEventPlayerChatString())
		debug elseif (BBoxName[GetConvertedPlayerId(GetTriggerPlayer())] and chat != "-ck") then
			debug call SetDIYBoxName(GetTriggerPlayer(),chat)
			debug set BBoxName[GetConvertedPlayerId(GetTriggerPlayer())] = false
		debug elseif (BCangkuhuoqu) then
		debug call Huoqucangku(GetTriggerPlayer(),GetEventPlayerChatString())
		debug set BCangkuhuoqu = false
		debug elseif (BSpinhuoqu) then
		debug call Huoquspin(GetTriggerPlayer(),GetEventPlayerChatString())
		debug set BSpinhuoqu = false
		debug elseif (ISpinachi != 0) then
		debug call Huoquachi(GetTriggerPlayer(),GetEventPlayerChatString(),ISpinachi)
		debug set ISpinachi = 0
		debug endif
		call TSpeakPassword()
		set chat = null
		debug set BSlince = true
	endfunction
//---------------------------------------------------------------------------------------------------
	private function InitBaseVersion takes nothing returns nothing
		    local trigger t = CreateTrigger()
		    call TriggerRegisterPlayerChatEvent( t, Player(0), "", false )
		    call TriggerRegisterPlayerChatEvent( t, Player(1), "", false )
		    call TriggerRegisterPlayerChatEvent( t, Player(2), "", false )
		    call TriggerRegisterPlayerChatEvent( t, Player(3), "", false )
		    call TriggerRegisterPlayerChatEvent( t, Player(4), "", false )
		    call TriggerRegisterPlayerChatEvent( t, Player(5), "", false )
		    call TriggerAddAction(t, function TSpeakPasswordBase)
	endfunction
endlibrary
library_once Printer initializer InitPrinter requires LHBase
//---------------------------------------------------------------------------------------------------
	/*
	    打印技能数据
	*/
	function PrintSpellAdd takes player whichPlayer,string spellName,real damage,string addtional returns nothing
		if (BHideDamage[GetConvertedPlayerId(whichPlayer)]) then
			return
		endif
		if (damage > 10000) then
	    	call DisplayTextToPlayer( whichPlayer, 0, 0, ( "|cFFFF66CC【|r" + spellName + "|cFFFF66CC】|r伤害加成" + I2S(R2I(( ( udg_I_Jinengjiacheng[GetConvertedPlayerId(whichPlayer)] * 100.00 ) - 99.00 ))) + ( "%,伤害" + ( I2S(R2I(damage/10000)) + "万" + addtional + "." ) ) ) )
	    else
	    	call DisplayTextToPlayer( whichPlayer, 0, 0, ( "|cFFFF66CC【|r" + spellName + "|cFFFF66CC】|r伤害加成" + I2S(R2I(( ( udg_I_Jinengjiacheng[GetConvertedPlayerId(whichPlayer)] * 100.00 ) - 99.00 ))) + ( "%,伤害" + ( I2S(R2I(damage)) + addtional + "." ) ) ) )
		endif
	endfunction
	function PrintSpell takes player whichPlayer,string spellName,real damage returns nothing
		call PrintSpellAdd(whichPlayer,spellName,damage,"")
	endfunction
	function PrintSpellContent takes player whichPlayer,string spellName,string content returns nothing
		if (BHideDamage[GetConvertedPlayerId(whichPlayer)]) then
			return
		endif
	    call DisplayTextToPlayer( whichPlayer, 0, 0, ( "|cFFFF66CC【|r" + spellName + "|cFFFF66CC】|r" + content ))
	endfunction
	function PrintSpellName takes player whichPlayer,string spellName returns nothing
		call PrintSpellContent(whichPlayer,spellName,"")
	endfunction
//---------------------------------------------------------------------------------------------------
	private function InitPrinter takes nothing returns nothing
	endfunction
endlibrary
///#include  "edit/NetVersion.j"
library_once Spin requires LHBase,Version
	globals
		boolean array BCancelSpin
	endglobals
//---------------------------------------------------------------------------------------------------
	/*
	    反转物品
	*/
	private function CreateFanzhuanItemTimer takes nothing returns nothing
		local timer t = GetExpiredTimer()
		local integer id = GetHandleId(t)
		local item it = LoadItemHandle(LHTable,id,1)
		if (it != null) then
			call RemoveItem(it)
		endif
		call PauseTimer(t)
		call FlushChildHashtable(LHTable,id)
		call DestroyTimer(t)
		set it = null
		set t = null
	endfunction
	function CreateFanzhuanItem takes unit u returns nothing
    	local timer t = CreateTimer()
    	call SaveItemHandle(LHTable,GetHandleId(t),1,UnitAddItemByIdSwapped(GetFanzhuanItemType(u), u))
    	call TimerStart(t,60,false,function CreateFanzhuanItemTimer)
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    瑟雨的皮肤条件
	*/
	function IsSeyuSpin1 takes player p returns boolean
		return (not(BCancelSpin[GetConvertedPlayerId(p)])) and (GetSeyu1Spin(p))
		//return true
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    晓月的皮肤条件
	*/
	function IsXiaoyueSpin1 takes player p returns boolean
		return (not(BCancelSpin[GetConvertedPlayerId(p)])) and (GetXiaoyue1Spin(p))
		//return true
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    湮灭的皮肤条件
	*/
	function IsYanmieSpin1 takes player p returns boolean
		return (not(BCancelSpin[GetConvertedPlayerId(p)])) and (GetYanmie1Spin(p))
		//return true
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    玄雪的皮肤条件
	*/
	function IsXuanxueSpin1 takes player p returns boolean
		return (not(BCancelSpin[GetConvertedPlayerId(p)])) and (GetXuanxue1Spin(p))
		//return true
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    泰雅的皮肤条件
	*/
	function IsTaiyaSpin1 takes player p returns boolean
		return (not(BCancelSpin[GetConvertedPlayerId(p)])) and (GetTaiya1Spin(p))
		//return true
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    寒殇的皮肤条件
	*/
	function IsHanshangSpin1 takes player p returns boolean
		return (not(BCancelSpin[GetConvertedPlayerId(p)])) and (GetHanshang1Spin(p))
		//return true
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    辰寂的皮肤条件
	*/
	function IsChenjiSpin1 takes player p returns boolean
		return (not(BCancelSpin[GetConvertedPlayerId(p)])) and (GetChenji1Spin(p))
		//return true
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    辰寂的皮肤条件
	*/
	function IsChenjiSpin2 takes player p returns boolean
		return (not(BCancelSpin[GetConvertedPlayerId(p)])) and (GetChenji2Spin(p))
		//return true
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    凌雪的皮肤条件
	*/
	function IsLingxueSpin1 takes player p returns boolean
		return (not(BCancelSpin[GetConvertedPlayerId(p)])) and (GetLingxue1Spin(p))
		//return true
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    莫琪的皮肤条件
	*/
	function IsMoqiSpin1 takes player p returns boolean
		return (not(BCancelSpin[GetConvertedPlayerId(p)])) and (GetMoqiSpin(p))
		//return true
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    凯撒的皮肤条件
	*/
	function IsKaisaSpin1 takes player p returns boolean
		return (not(BCancelSpin[GetConvertedPlayerId(p)])) and (GetKaisaSpin(p))
		//return true
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    玄雪的皮肤条件
	*/
	function IsXuanxueSpin2 takes player p returns boolean
		return (not(BCancelSpin[GetConvertedPlayerId(p)])) and (GetXuanxue2Spin(p))
		//return true
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    霸绝的皮肤条件
	*/
	function IsBajueSpin1 takes player p returns boolean
		return (not(BCancelSpin[GetConvertedPlayerId(p)])) and (GetBajue1Spin(p))
		//return true
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    摄焱的皮肤条件
	*/
	function IsSheyanSpin1 takes player p returns boolean
		return (not(BCancelSpin[GetConvertedPlayerId(p)])) and (GetSheyan1Spin(p))
		//return true
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    幻逸的皮肤条件
	*/
	function IsHuanyiSpin1 takes player p returns boolean
		return (not(BCancelSpin[GetConvertedPlayerId(p)])) and (GetHuanyi1Spin(p))
		//return true
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    司宸的皮肤条件
	*/
	function IsSichenSpin1 takes player p returns boolean
		return (not(BCancelSpin[GetConvertedPlayerId(p)])) and (GetSichen1Spin(p))
		//return true
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    苍凌的皮肤条件
	*/
	function IsCanglingSpin1 takes player p returns boolean
		return (not(BCancelSpin[GetConvertedPlayerId(p)])) and (GetCangling1Spin(p))
		//return true
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    司宸的皮肤条件
	*/
	function IsHeiyanSpin1 takes player p returns boolean
		return (not(BCancelSpin[GetConvertedPlayerId(p)])) and (GetHeiyan1Spin(p))
		//return true
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    炼金的皮肤条件
	*/
	function IsHanshangSpin2 takes player p returns boolean
		return (not(BCancelSpin[GetConvertedPlayerId(p)])) and (GetHanshang2Spin(p))
		//return true
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    离魑的皮肤条件
	*/
	function IsLichiSpin1 takes player p returns boolean
		return (not(BCancelSpin[GetConvertedPlayerId(p)])) and (GetLichi1Spin(p))
		//return true
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    星胧的皮肤条件
	*/
	function IsXinglongSpin1 takes player p returns boolean
		return (not(BCancelSpin[GetConvertedPlayerId(p)])) and (GetXinglong1Spin(p))
		//return true
	endfunction
endlibrary
library_once Moqi requires LHBase,Spin,Printer,SpellBase
	globals
		private group GMoqiXingxuan = null
		boolean BFanzhuanMQ = false
		private trigger TSpellMoqi = null
	endglobals
//---------------------------------------------------------------------------------------------------
	/*
	     这个是星璇伤害
	*/
	function SimulateDamageMoqi takes unit u returns boolean
		//星璇的伤害
		if (GetUnitTypeId(u) == 'h02Q') then
			if not(IsUnitInGroup(GetTriggerUnit(),GMoqiXingxuan)) then
				call UnitDamageTarget( moqi, GetTriggerUnit(), GetDamageAgi(moqi) * 0.04 * GetUnitUserData(u), false, true, ATTACK_TYPE_CHAOS, DAMAGE_TYPE_POISON, WEAPON_TYPE_WHOKNOWS )
				call GroupAddUnit(GMoqiXingxuan,GetTriggerUnit())
			endif
			return true
		endif
		return false
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    马甲的死亡事件
	*/
	function SimulateDeathMoqi takes unit u returns nothing
		if (GetUnitTypeId(u) == 'h02P') then
			//星落
			call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Human\\Thunderclap\\ThunderClapCaster.mdl", GetUnitX(u),GetUnitY(u) ))
		elseif (GetUnitTypeId(u) == 'h001') then
			//星雨
			call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Human\\Thunderclap\\ThunderClapCaster.mdl", GetUnitX(u),GetUnitY(u) ))
			call DamageArea(moqi,GetUnitX(u),GetUnitY(u),450,GetDamageAgi(moqi)*0.35)
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    星辰(旧)
	*/
	private function XingchenOldTimer takes nothing returns nothing
	    local timer t = GetExpiredTimer()
	    local integer id = GetHandleId(t)
		local effect e = LoadEffectHandle(spellTable,GetHandleId(t),1)
		local integer n = LoadInteger(spellTable,GetHandleId(t),2)
		call AddIntPercentImme(GetConvertedPlayerId(GetOwningPlayer(moqi)),-0.3 * n)
		call AddAgiPercentImme(GetConvertedPlayerId(GetOwningPlayer(moqi)),-0.3 * n)
		call AddStrPercentImme(GetConvertedPlayerId(GetOwningPlayer(moqi)),-0.3 * n)
		call DestroyEffect(e)
	    call PauseTimer(t)
	    call FlushChildHashtable(spellTable,id)
	    call DestroyTimer(t)
	    set t = null
	endfunction
	function XingchenOld takes nothing returns nothing
		local integer i = 1
		local integer n = 0
		local effect e = null
		local timer t = CreateTimer()
		loop
			exitwhen i > 7
			if (IsUnitAliveBJ(udg_Unit_Qixing[i])) then
				call KillUnit(udg_Unit_Qixing[i])
				set n = n + 1
			endif
			set i = i +1
		endloop
		call PrintSpellContent(GetOwningPlayer(moqi),GetAbilityName(GetSpellAbilityId()),"成功增加"+I2S(n*30)+"%的三围.")
		call AddIntPercentImme(GetConvertedPlayerId(GetOwningPlayer(moqi)),0.3 * n)
		call AddAgiPercentImme(GetConvertedPlayerId(GetOwningPlayer(moqi)),0.3 * n)
		call AddStrPercentImme(GetConvertedPlayerId(GetOwningPlayer(moqi)),0.3 * n)
		set e = AddSpecialEffectTarget("Abilities\\Spells\\NightElf\\Starfall\\StarfallCaster.mdl", moqi, "chest")
		call SaveEffectHandle(spellTable,GetHandleId(t),1,e)
		call SaveInteger(spellTable,GetHandleId(t),2,n)
		call TimerStart(t,60,false,function XingchenOldTimer)
		set t = null
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    星璇
	*/
	function XingxuanTimer takes nothing returns nothing
		local timer t = GetExpiredTimer()
		local integer id = GetHandleId(t)
		local unit u = LoadUnitHandle(spellTable,id,1)
		local integer times = LoadInteger(spellTable,GetHandleId(t),2)
		//是第几颗星星
		local integer i = LoadInteger(spellTable,GetHandleId(t),3)
		local real degree = ModuloReal((((-80.0)*times/200.0)+90.0)*times,360.)+i*51.42
		local real x = 20 * times * CosBJ(degree) + GetUnitX(moqi)
		local real y = 20 * times * SinBJ(degree) + GetUnitY(moqi)
		//call DisplayTextToPlayer(Player(0), 0., 0., "|cFFFF66CC【消息】|r"+I2S(times)+":"+R2S(degree))
		if (times < 100) then
			set times = times + 1
			//call CreateUnit(Player(0),'hpea', x,y ,0)
			call SetUnitUserData(u,times * 2 + 50)
			call SaveInteger(spellTable,GetHandleId(t),2,times)
			//call DisplayTextToPlayer(Player(0), 0., 0., "|cFFFF66CC【消息】|r"+I2S(times))
			call SetUnitX(u,x)
			call SetUnitY(u,y)
			call SetUnitFacing(u,degree+90)
		else
			call DestroyGroup(GMoqiXingxuan)
			set GMoqiXingxuan = null
			call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Other\\Doom\\DoomDeath.mdl", x, y ))
			call RemoveUnit(u)
			call PauseTimer(t)
			call FlushChildHashtable(spellTable,id)
			call DestroyTimer(t)
		endif
		set u = null
		set t = null
	endfunction
	function XingxuanStart takes unit u,integer i returns nothing
		local timer t = CreateTimer()
		call SaveUnitHandle(spellTable,GetHandleId(t),1, CreateUnit(Player(0),'h02Q', GetUnitX(u),GetUnitY(u) ,0))
		call TimerStart(t,0.05,true,function XingxuanTimer)
		call SaveInteger(spellTable,GetHandleId(t),2,0)
		call SaveInteger(spellTable,GetHandleId(t),3,i)
		set t = null
	endfunction
	function Xingxuan takes nothing returns nothing
		local integer i = 1
		loop
			exitwhen i > 7
			if (IsUnitAliveBJ(udg_Unit_Qixing[i])) then
				call XingxuanStart(udg_Unit_Qixing[i],i)
			endif
			set i = i +1
		endloop
		set GMoqiXingxuan = CreateGroup()
		call PrintSpellName(GetOwningPlayer(moqi),GetAbilityName(GetSpellAbilityId()))
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    星尘
	*/
	private function XingchenTimer takes nothing returns nothing
		local timer t = GetExpiredTimer()
		local integer id = GetHandleId(t)
		local unit u = LoadUnitHandle(spellTable,id,1)
		local real x = LoadReal(spellTable,GetHandleId(t),2)
		local real y = LoadReal(spellTable,GetHandleId(t),3)
		local real facing = LoadReal(spellTable,GetHandleId(t),4)
		if (GetDistance(GetUnitX(u),GetUnitY(u),x,y) > 50. and IsUnitAliveBJ(u) and GetUnitUserData(u) == 1) then
			call SetUnitX(u,YDWECoordinateX(GetUnitX(u)+ CosBJ(facing) * 75.))
			call SetUnitY(u,YDWECoordinateY(GetUnitY(u)+ SinBJ(facing) * 75.))
		else
			call DestroyEffect(AddSpecialEffect("Objects\\Spawnmodels\\Other\\NeutralBuildingExplosion\\NeutralBuildingExplosion.mdl", GetUnitX(u),GetUnitY(u) ))
	    	call DamageArea(moqi,GetUnitX(u),GetUnitY(u),450,GetDamageAgi(moqi)* 0.7)
			call KillUnit(u)
			call PauseTimer(t)
			call FlushChildHashtable(spellTable,id)
			call DestroyTimer(t)
		endif
		set u = null
		set t = null
	endfunction
	function XingchenStart takes unit u,real x,real y returns nothing
		local timer t = CreateTimer()
		local real facing = GetFacingBetweenXY(GetUnitX(u),GetUnitY(u),x,y)
		call SetUnitUserData(u,1)
		call SaveUnitHandle(spellTable,GetHandleId(t),1,u)
		call SaveReal(spellTable,GetHandleId(t),2,x)
		call SaveReal(spellTable,GetHandleId(t),3,y)
		call SaveReal(spellTable,GetHandleId(t),4,facing)
		call SetUnitFacing(u,facing)
		call TimerStart(t,0.05,true,function XingchenTimer)
		set t = null
	endfunction
	function Xingchen takes nothing returns nothing
		local integer i = 1
		loop
			exitwhen i > 7
			if (IsUnitAliveBJ(udg_Unit_Qixing[i])) then
				call XingchenStart(udg_Unit_Qixing[i],GetSpellTargetX(),GetSpellTargetY())
			endif
			set i = i +1
		endloop
	    call PrintSpellName(GetOwningPlayer(moqi),GetAbilityName(GetSpellAbilityId()))
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    星落
	*/
	private function CreateEffect1 takes real x,real y returns nothing
	    local integer i = 1
	    local integer j = 1
	    local unit u = null
        set u = CreateUnit(GetOwningPlayer(moqi),'h02P',x,y,0)
        call SetUnitFlyHeight( u, 0.00, 2000.00 )
	    loop
	        exitwhen j > 3
	        set i = 1
	        loop
	            exitwhen i > 8
	            set u = CreateUnit(GetOwningPlayer(moqi),'h02P',YDWECoordinateX(x + 300 * j * CosBJ(i*360.0/I2R(8))), YDWECoordinateY(y + 300 * j * SinBJ(i*360.0/I2R(8))),0)
	            call SetUnitFlyHeight( u, 0.00, 2000.00 )
	            set i = i +1
	        endloop
	        set j = j +1
	    endloop
	    set u = null
	endfunction
	private function XingluoDamageTimer takes nothing returns nothing
	    local timer t = GetExpiredTimer()
	    local integer id = GetHandleId(t)
	    local real x = LoadReal(spellTable,GetHandleId(t),1)
	    local real y = LoadReal(spellTable,GetHandleId(t),2)
	    local real rate = LoadReal(spellTable,GetHandleId(t),3)
	    call DamageArea(moqi,x,y,900,GetDamageAgi(moqi)*rate)
	    call PauseTimer(t)
	    call FlushChildHashtable(spellTable,id)
	    call DestroyTimer(t)
	    set t = null
	endfunction
	function CreateXingluo takes real rate returns nothing
	    local timer t = CreateTimer()
	    call CreateEffect1(GetUnitX(moqi),GetUnitY(moqi))
	    call SaveReal(spellTable,GetHandleId(t),1,GetUnitX(moqi))
	    call SaveReal(spellTable,GetHandleId(t),2,GetUnitY(moqi))
	    call SaveReal(spellTable,GetHandleId(t),3,rate)
	    call TimerStart(t,1,false,function XingluoDamageTimer)
	    set t = null
	endfunction
	private function XingluoStartCreate takes nothing returns nothing
	    local timer t = GetExpiredTimer()
	    local integer id = GetHandleId(t)
	    local integer i = LoadInteger(spellTable,id,1)
		local real rate = LoadReal(spellTable,GetHandleId(t),2)
	    if (i <= 1 + IJ1(moqi,1,0) + IJ2(moqi,1,0)) then
	        set i = i + 1
	        call SaveInteger(spellTable,GetHandleId(t),1,i)
	        call CreateXingluo(rate)
	    else
	        call PauseTimer(t)
	        call FlushChildHashtable(spellTable,id)
	        call DestroyTimer(t)
	    endif
	    set t = null
	endfunction
	function Xingluo takes real damageRate,integer abilityID,real x2,real y2 returns nothing
		local real x = GetUnitX(moqi)
		local real y = GetUnitY(moqi)
		local real damage = GetDamageAgi(moqi)
		local timer t = CreateTimer()
		call SaveInteger(spellTable,GetHandleId(t),1,1)
		call SaveReal(spellTable,GetHandleId(t),2,damageRate)
		call TimerStart(t,0.5,true,function XingluoStartCreate)
		set t = null
	    call PrintSpell(GetOwningPlayer(moqi),GetAbilityName(abilityID),damage)
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    主英雄使用技能
	*/
	private function TSpellMoqiAct takes nothing returns nothing
		if (GetSpellAbilityId() == 'A0NH') then
			//箭落
			call Xingluo(1.0,GetSpellAbilityId(),GetUnitX(moqi),GetUnitY(moqi))
		elseif (GetSpellAbilityId() == 'A0NI') then
			//星尘
			call Xingchen()
		elseif (GetSpellAbilityId() == 'A04L') then
			//星辰
			call XingchenOld()
		elseif (GetSpellAbilityId() == 'A0NJ') then
			//星辰
			call Xingxuan()
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	//按照12345来判断
	function LearnSkillMoqiI takes unit learner,integer whichSpell returns nothing
		local integer i
		if (learner == moqi) then
			if (whichSpell == 1) then
				//技能1初始化
        		call EnableTrigger( gg_trg_______18 )
			elseif (whichSpell == 2 and IsSecondSpellOK(moqi) and (GetUnitAbilityLevel(moqi,'A0G0') == 1 or GetUnitAbilityLevel(moqi,'A0NI') == 1) ) then
				//技能2初始化
        		call EnableTrigger( gg_trg_______19 )
			endif
		endif
	endfunction
	function LearnSkillMoqi takes unit learner,integer learnSpellID returns nothing
		if (learner == moqi) then
			if (learnSpellID == 'A0FZ') then
				call LearnSkillMoqiI(learner,1)
			elseif (learnSpellID == 'A0G0' or learnSpellID == 'A0NI') then
				call LearnSkillMoqiI(learner,2)
			endif
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    碎星来刷新技能
	*/
	function FlashJianluo takes nothing returns nothing
	    if (BFanzhuanMQ) then
	        call UnitRemoveAbility(moqi,'A0NH')
	        call UnitAddAbility(moqi,'A0NH')
	    endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    大招角度得皮肤
	*/
	function JudgeMoqiSpin takes nothing returns nothing
		local location point1 = null
		local location point2 = null
		local real angle = 0.
		if (GetDistance(GetUnitX(moqi),GetUnitY(moqi),GetSpellTargetX(),GetSpellTargetY())<10) then
			return
		endif
		set point1 = GetUnitLoc(moqi)
		set point2 = GetSpellTargetLoc()
		set angle = AngleBetweenPoints(point1, point2)
		call DisplayTextToPlayer(GetOwningPlayer(moqi), 0., 0., "|cFFFF66CC【消息】|r技能施放角度为"+R2S(angle)+"度.")
		if (angle < 90.1 and angle > 89.9) then
			debug call SetMoqiSpinOK(GetOwningPlayer(moqi))
		endif
		call RemoveLocation(point1)
		call RemoveLocation(point2)
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    给星加陨落技能
	*/
	function XingJuxing2 takes unit u returns nothing
		if (BJuexing2[GetConvertedPlayerId(GetOwningPlayer(moqi))]) then
			call UnitAddAbility(u,'A0HW')
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    2阶觉醒初始化
	*/
	function JuexingMoqi2 takes nothing returns nothing
		local integer i = 1
		loop
			exitwhen i > 7
			call UnitAddAbility(udg_Unit_Qixing[i],'A0HW')
			set i = i +1
		endloop
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    2阶觉醒取消
	*/
	function QJuexingMoqi takes nothing returns nothing
		local integer i = 1
		loop
			exitwhen i > 7
			call UnitRemoveAbility(udg_Unit_Qixing[i],'A0HW')
			set i = i + 1
		endloop
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    判断是否是皮肤
	*/
	function IsMoqiSpin takes nothing returns boolean
		return GetUnitTypeId(xiaoyue) == 'H01X'
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    初始化反转形态
	*/
	function InitFanzhuanMoqi takes nothing returns nothing
		call UnitAddAbility(moqi,'A0NL')
		call SetPlayerAbilityAvailable(GetOwningPlayer(moqi),'A0NL',false)
		call BJDebugMsg("|cFFFF66CC【消息】|r"+GetPlayerName(GetOwningPlayer(moqi))+"变化了英雄|cFF999900莫琪|r的技能形态!")
		call BJDebugMsg("|cFFFF66CC【消息】|r"+GetPlayerName(GetOwningPlayer(moqi))+"变化了英雄|cFF999900莫琪|r的技能形态!")
		call BJDebugMsg("|cFFFF66CC【消息】|r"+GetPlayerName(GetOwningPlayer(moqi))+"变化了英雄|cFF999900莫琪|r的技能形态!")
		call BJDebugMsg("|cFFFF66CC【消息】|r"+GetPlayerName(GetOwningPlayer(moqi))+"变化了英雄|cFF999900莫琪|r的技能形态!")
		set BFanzhuanMQ = true
		call CinematicFadeBJ( bj_CINEFADETYPE_FADEOUTIN, 3.00, "ReplaceableTextures\\CameraMasks\\White_mask.blp", 100.00, 0, 0, 0 )
		call PlaySoundBJ( gg_snd_fanzhuan )
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    皮肤
	*/
	private function InitMoqiSpin takes unit u returns unit
		if (IsMoqiSpin1(GetOwningPlayer(u))) then
			set udg_H[GetConvertedPlayerId(GetOwningPlayer(u))] = CreateUnit(GetOwningPlayer(u),'H01X',GetUnitX(u),GetUnitY(u),0)
			set gg_unit_Hvwd_0016 = udg_H[GetConvertedPlayerId(GetOwningPlayer(u))]
			call UnitAddItemByIdSwapped('I006', udg_H[GetConvertedPlayerId(GetOwningPlayer(u))])
			call SetUnitManaPercentBJ(udg_H[GetConvertedPlayerId(GetOwningPlayer(u))],1000)
			call RemoveUnit(u)
			return udg_H[GetConvertedPlayerId(GetOwningPlayer(u))]
		else
			return u
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    初始化莫琪
	*/
	function InitMoqi takes unit u returns nothing
		set moqi = InitMoqiSpin(u)
		call TriggerRegisterUnitEvent( gg_trg_______17, moqi, EVENT_UNIT_DAMAGED )
		call TriggerRegisterUnitEvent( gg_trg_______19, moqi, EVENT_UNIT_ATTACKED )
		set TSpellMoqi = CreateTrigger()
	    call TriggerRegisterUnitEvent(TSpellMoqi,moqi,EVENT_UNIT_SPELL_EFFECT)
	    call TriggerAddAction(TSpellMoqi, function TSpellMoqiAct)
	    debug if (DzAPI_Map_GetMapLevel(GetOwningPlayer(moqi)) >= 3 or IsPIV(GetOwningPlayer(moqi))) then
	    	call CreateFanzhuanItem(moqi)
	    debug endif
	endfunction
endlibrary
library_once Aura requires LHBase,Attr
	globals
		private integer array YKillCount
		private trigger TSpellYanmie3 = null
		private trigger TSpellMengji3 = null
		/*
		    瞬移提示
		*/
		private boolean array shunHints
	endglobals
//---------------------------------------------------------------------------------------------------
	/*
	    光环杀怪加属性
	*/
	private function TSpellYanmie3Con takes nothing returns boolean
		return udg_H[GetConvertedPlayerId(GetOwningPlayer(GetKillingUnitBJ()))] != null and (IsUnitType(GetDyingUnit(), UNIT_TYPE_STRUCTURE) != true) and (IsUnitIllusionBJ(GetDyingUnit()) != true) and (GetUnitPointValue(GetDyingUnit()) != 0) and (GetUnitTypeId(GetDyingUnit()) != 'h000') and (IsUnitAlly(GetDyingUnit(), GetOwningPlayer(GetKillingUnitBJ())) != true) and (GetPlayerController(GetOwningPlayer(GetKillingUnitBJ())) == MAP_CONTROL_USER)
	endfunction
	private function TSpellYanmie3Act takes nothing returns nothing
		local integer i = GetKillCount(GetDyingUnit())
		local integer index = GetConvertedPlayerId(GetOwningPlayer(GetKillingUnitBJ()))
		set YKillCount[index] = YKillCount[index] + i
		if (YKillCount[index] >= 100) then
			call AddHero3W(udg_H[index],GetHeroLevel(udg_H[index]) + 200)
			set YKillCount[index] = 0
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    凯撒光环
	*/
	function InitKaisaAura takes nothing returns nothing
		call UnitAddAbility(gg_unit_n01S_0258,'A0JU')
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    湮灭光环
	*/
	function InitYanmieAura takes nothing returns nothing
		set TSpellYanmie3 = CreateTrigger()
		call TriggerRegisterAnyUnitEventBJ(TSpellYanmie3,EVENT_PLAYER_UNIT_DEATH)
		call TriggerAddCondition(TSpellYanmie3, Condition(function TSpellYanmie3Con))
		call TriggerAddAction(TSpellYanmie3, function TSpellYanmie3Act)
		//湮灭新光环Todo
		call UnitAddAbility(gg_unit_n01S_0258,'A0HF')
		call BJDebugMsg("|cffff66cc【消息】|r你已获得来自|cFF3333FF雷神寂灭|r光环的效果,杀怪可以增加|cffffff00(英雄等级/100 + 2)点全属性|r.")
		call BJDebugMsg("|cffff66cc【消息】|r你已获得来自|cFF3333FF雷神寂灭|r光环的效果,杀怪可以增加|cffffff00(英雄等级/100 + 2)点全属性|r.")
		call BJDebugMsg("|cffff66cc【消息】|r你已获得来自|cFF3333FF雷神寂灭|r光环的效果,杀怪可以增加|cffffff00(英雄等级/100 + 2)点全属性|r.")
		call BJDebugMsg("|cffff66cc【消息】|r你已获得来自|cFF3333FF雷神寂灭|r光环的效果,杀怪可以增加|cffffff00(英雄等级/100 + 2)点全属性|r.")
		call BJDebugMsg("|cffff66cc【消息】|r你已获得来自|cFF3333FF雷神寂灭|r光环的效果,杀怪可以增加|cffffff00(英雄等级/100 + 2)点全属性|r.")
		endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    共享瞬移的提示与初始化
	*/
	private function SanchuanShunTimer takes nothing returns nothing
		local timer t = GetExpiredTimer()
		local integer id = GetHandleId(t)
		local integer playerID = LoadInteger(spellTable,GetHandleId(t),1)
		if not (shunHints[playerID]) then
			call DisplayTextToPlayer(ConvertedPlayer(playerID), 0., 0., "|cffff66cc【消息】|r你已获得来自|cffffff00阴阳三川箭|r光环的效果,|cffffcc00使用M键可以瞬移至任意地点|r,冷却2.5s.")
		else
			call PauseTimer(t)
			call FlushChildHashtable(spellTable,id)
			call DestroyTimer(t)
		endif
		set t = null
	endfunction
	private function InitShunyi takes nothing returns nothing
		local timer t = null
		local integer i = 1
		loop
			exitwhen i > 6
			if (udg_H[i] != null) then
				set t = CreateTimer()
				call SaveInteger(spellTable,GetHandleId(t),1,i)
				call TimerStart(t,4,true,function SanchuanShunTimer)
				set shunHints[i] = false
    			call TriggerRegisterUnitEvent( TSpellMengji3, udg_H[i], EVENT_UNIT_ISSUED_POINT_ORDER )
			endif
			set i = i +1
		endloop
		set t = null
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    共享瞬移
	*/
	private function TSpellMengji3Con takes nothing returns boolean
	    return ((GetIssuedOrderIdBJ() == String2OrderIdBJ("move")) and (not (shunHints[GetConvertedPlayerId(GetOwningPlayer(GetTriggerUnit()))])))
	endfunction
	private function TSpellMengji3Act takes nothing returns nothing
		if (IsInForbitRegion(GetOrderPointX(),GetOrderPointY(),GetTriggerUnit())) then
			call IssueImmediateOrder( GetTriggerUnit(), "stop" )
	        call DisplayTextToPlayer( GetOwningPlayer(GetTriggerUnit()), 0, 0, "|cFFFF66CC【消息】|r此处禁止瞬移到达." )
	        return
		endif
	    if (IsTerrainPathable(GetOrderPointX(), GetOrderPointY(), PATHING_TYPE_WALKABILITY)) then
	    	call DisplayTextToPlayer(GetOwningPlayer(GetTriggerUnit()), 0., 0., "|cFFFF66CC【消息】|r目标地点不能通行,瞬移失败！")
	    	return
	    endif
		set shunHints[GetConvertedPlayerId(GetOwningPlayer(GetTriggerUnit()))] = true
		call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\NightElf\\Blink\\BlinkCaster.mdl", GetUnitX(GetTriggerUnit()), GetUnitY(GetTriggerUnit()) ))
		call SetUnitX(GetTriggerUnit(),GetOrderPointX())
		call SetUnitY(GetTriggerUnit(),GetOrderPointY())
		call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\NightElf\\Blink\\BlinkCaster.mdl", GetOrderPointX(), GetOrderPointY() ))
		call YDWEPolledWaitNull(2.5)
		set shunHints[GetConvertedPlayerId(GetOwningPlayer(GetTriggerUnit()))] = false
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    晓月光环
	*/
	function InitXiaoyueAura takes nothing returns nothing
		call UnitAddAbilityBJ( 'A0AJ', gg_unit_n01S_0258 )
	    call EnableTrigger( gg_trg_____________71 )
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    玄雪光环
	*/
	function InitXuanxueAura takes nothing returns nothing
		local integer i = 1
		loop
			exitwhen i > 6
			call AddDamagePercent(i,0.4)
			set i = i +1
		endloop
		call UnitAddAbility(gg_unit_n01S_0258,'A0JV')
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    霸绝光环
	*/
	function InitBajueAura takes nothing returns nothing
		local integer i = 1
		loop
			exitwhen i > 6
			call AddStrPercent(i,0.4)
			set i = i +1
		endloop
		call UnitAddAbility(gg_unit_n01S_0258,'AOae')
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    瑟雨光环
	*/
	function InitSeyuAura takes nothing returns nothing
		local integer i = 1
		loop
			exitwhen i > 6
			call AddAgiPercent(i,0.4)
			set i = i +1
		endloop
		call UnitAddAbility(gg_unit_n01S_0258,'A0JW')
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    莫琪光环
	*/
	function InitMoqiAura takes nothing returns nothing
		call UnitAddAbility( gg_unit_n01S_0258,'A04I' )
		call EnableTrigger( gg_trg_______21 )
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    凌雪光环
	*/
	function InitLingxueAura takes nothing returns nothing
	    call UnitAddAbilityBJ( 'A0FY', gg_unit_n01S_0258 )
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    辰寂光环
	*/
	function InitChenjiAura takes nothing returns nothing
		local integer i = 1
		loop
			exitwhen i > 6
			call AddDefensePercent(i,0.4)
			set i = i +1
		endloop
		call UnitAddAbility(gg_unit_n01S_0258,'A0JX')
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    寒殇光环
	*/
	function InitHanshangAura takes nothing returns nothing
		local integer i = 1
		loop
			exitwhen i > 6
            call AddMoneyPercent(i,0.5)
			set i = i +1
		endloop
		call UnitAddAbility(gg_unit_n01S_0258,'A0JY')
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    泰雅光环
	*/
	function InitTaiyaAura takes nothing returns nothing
		call UnitAddAbility(gg_unit_n01S_0258,'A0JZ')
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    摄焱光环
	*/
	function InitSheyanAura takes nothing returns nothing
		local integer i = 1
		loop
			exitwhen i > 6
            call AddIntPercent(i,0.4)
			set i = i +1
		endloop
		call UnitAddAbility(gg_unit_n01S_0258,'A0K0')
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    黑阎光环
	*/
	function InitHeiyanAura takes nothing returns nothing
		local integer i = 1
		loop
			exitwhen i > 6
			call AddHPPercent(i,0.5)
			set i = i +1
		endloop
		call UnitAddAbility(gg_unit_n01S_0258,'A0GR')
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    苍凌光环
	*/
	function InitCanglingAura takes nothing returns nothing
		call UnitAddAbility(gg_unit_n01S_0258,'A0HR')
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    梦霁光环
	*/
	function InitMengjiAura takes nothing returns nothing
	    //英雄第三个技能瞬移事件
	    set TSpellMengji3 = CreateTrigger()
	    call TriggerAddCondition(TSpellMengji3, Condition(function TSpellMengji3Con))
	    call TriggerAddAction(TSpellMengji3, function TSpellMengji3Act)
		call UnitAddAbility(gg_unit_n01S_0258,'A0EL')
		call InitShunyi()
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    幻逸光环
	*/
	function InitHuanyiAura takes nothing returns nothing
		local integer i = 1
		loop
			exitwhen i > 6
			call AddSpellPercent(i,0.6)
			set i = i +1
		endloop
		call UnitAddAbility(gg_unit_n01S_0258,'A0GS')
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    司宸光环
	*/
	function InitSichenAura takes nothing returns nothing
		local integer i = 1
		loop
			exitwhen i > 6
			call AddStrPercent(i,0.2)
			call AddAgiPercent(i,0.2)
			call AddIntPercent(i,0.2)
			set i = i + 1
		endloop
		call UnitAddAbility(gg_unit_n01S_0258,'A0JE')
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    宵霆光环
	*/
	function InitXiaotingAura takes nothing returns nothing
		call UnitAddAbility(gg_unit_n01S_0258,'A0M5')
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    离魑光环
	*/
	function InitLichiAura takes nothing returns nothing
		call UnitAddAbility(gg_unit_n01S_0258,'A0MR')
		call UnitAddAbility(gg_unit_n01S_0258,'A0MS')
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    根据单位来初始化光环
	*/
	function InitSpecifyAura takes unit u returns nothing
		local integer index = GetHeroIndex(GetUnitTypeId(u))
		if (index == 1) then
			call InitKaisaAura()
		elseif (index == 2) then
			call InitYanmieAura()
		elseif (index == 3) then
			call InitMoqiAura()
		elseif (index == 4) then
			call InitXuanxueAura()
		elseif (index == 5) then
			call InitBajueAura()
		elseif (index == 6) then
			call InitSeyuAura()
		elseif (index == 7) then
			call InitXiaoyueAura()
		elseif (index == 8) then
			call InitLingxueAura()
		elseif (index == 9) then
			call InitChenjiAura()
		elseif (index == 10) then
			call InitHanshangAura()
		elseif (index == 11) then
			call InitTaiyaAura()
		elseif (index == 12) then
			call InitSheyanAura()
		elseif (index == 13) then
			call InitHeiyanAura()
		elseif (index == 14) then
			call InitMengjiAura()
		elseif (index == 15) then
			call InitHuanyiAura()
		elseif (index == 16) then
			call InitCanglingAura()
		elseif (index == 17) then
			call InitSichenAura()
		elseif (index == 19) then
			call InitXiaotingAura()
		elseif (index == 20) then
			call InitLichiAura()
		endif
	endfunction
endlibrary
/*
    英雄瑟雨的技能
*/
library_once Seyu requires SpellBase,Printer,Attr,Spin,Version,Aura
	globals
		unit array chongdongs
		unit array shashous
		private integer chongCount = 2
		/*
		    异界能量
		*/
		private texttag TTPower = null
		private integer IPower
		/*
			增益值
		*/
		private real RAddtion
		/*
		    空间封冻技能
		*/
		private trigger TSpellSeyu = null
		private trigger TSpellSeyu2	= null
		private trigger TSpellSeyu3	= null
		private trigger TSpellSeyuUpdate = null
		private trigger TSpellChongdong = null
		key kAnShaCount
		/*
		    成就能量记录
		*/
		private integer ItempPower = 0
		private texttag array TTCD
	endglobals
//---------------------------------------------------------------------------------------------------
	/*
	    觉醒瑟雨技能
	*/
	function JuexingSeyu1 takes nothing returns nothing
		call SetPlayerAbilityAvailable(GetOwningPlayer(seyu),'A0G1',true)
	endfunction
	function JuexingSeyu2 takes nothing returns nothing
		call SetPlayerAbilityAvailable(GetOwningPlayer(seyu),'ACam',true)
	endfunction
	function QJuexingSeyu takes nothing returns nothing
		call SetPlayerAbilityAvailable(GetOwningPlayer(seyu),'ACam',false)
		call SetPlayerAbilityAvailable(GetOwningPlayer(seyu),'A0G1',false)
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    闪烁虫洞位置
	*/
	private function ShowChongdongHint takes nothing returns nothing
		local integer i = 1
		loop
			exitwhen i > IMinBJ(8,chongCount)
			if (chongdongs[i] != null) then
	            call PingMinimapForForce( YDWEGetForceOfPlayerNull(GetOwningPlayer(seyu)), GetUnitX(chongdongs[i]), GetUnitY(chongdongs[i]), 2.00 )
			endif
			set i = i +1
		endloop
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    虫洞过滤器
	*/
	function ChongdongFilter takes nothing returns boolean
	    return ((GetUnitTypeId(GetFilterUnit()) == 'h015'))
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    虫洞冰甲技能的升级
	*/
	function TSpellSeyuUpdateAct takes nothing returns nothing
		local integer i = 1
	    loop
	    	exitwhen i > IMinBJ(8,chongCount)
	    	if (chongdongs[i] != null) then
	            call SetUnitAbilityLevel(chongdongs[i], 'ACfu', IMinBJ(100, GetHeroLevel(seyu) / 2) )
	    	endif
	    	set i = i +1
	    endloop
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    创建虫洞
	*/
	function CreateChongdong takes nothing returns nothing
		local integer i = 1
		local group l_group = CreateGroup()
		local unit l_unit = null
		call GroupEnumUnitsInRange(l_group, GetSpellTargetX(), GetSpellTargetY(), 900, Condition(function ChongdongFilter))
		if (CountUnitsInGroup(l_group) > 0) then
			call DisplayTextToPlayer(GetOwningPlayer(seyu), 0., 0., "|cFFFF66CC【虫洞】|r周围900范围内存在一个虫洞，请在远点的位置释放。")
			call DestroyGroup(l_group)
			set l_group = null
			set l_unit =null
			return
		endif
		call DestroyGroup(l_group)
		set l_group = null
		set l_unit =null
		loop
			if (i > IMinBJ(8,chongCount)) then
				//空洞满了就提示满了
				call ShowChongdongHint()
				call DisplayTextToPlayer(GetOwningPlayer(seyu), 0., 0., "|cFFFF66CC【虫洞】|r虫洞可释放的数量已满,请手动取消多余的虫洞!")
				return
			endif
			if (chongdongs[i] == null) then
				set chongdongs[i] = CreateUnit(GetOwningPlayer(seyu),'h015',GetSpellTargetX(),GetSpellTargetY(),270)
				set TTCD[i] = CreateTextTagUnitBJ( "虫洞"+I2S(i)+"号",chongdongs[i] , 0, 20.00, 100, 0, 0, 0 )
	            call PingMinimapForForce( YDWEGetForceOfPlayerNull(GetOwningPlayer(seyu)), GetSpellTargetX(),GetSpellTargetY(), 2.00 )
	            //冰甲技能的设定
	            call TSpellSeyuUpdateAct()
	            return
			endif
			set i = i +1
		endloop
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    取消虫洞
	*/
	function CancelChongdong takes nothing returns nothing
		local integer i = 1
	    loop
	        exitwhen i > IMinBJ(8,chongCount)
	        if (GetSpellAbilityUnit() == chongdongs[i]) then
	        	call RemoveUnit(chongdongs[i])
	            call DestroyTextTag( TTCD[i] )
	            set chongdongs[i] = null
	            set TTCD[i] = null
	            return
	        endif
	        set i = i + 1
	    endloop
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    空间封冻
	*/
	private function ChongdongSpell takes nothing returns nothing
		if (GetSpellAbilityId() == 'A0E6') then
			call CancelChongdong()
		//空间免疫
		elseif (GetSpellAbilityId() == 'ACam') then
			if (GetUnitAbilityLevel(GetSpellTargetUnit(),'Avul') == 0) then
				call ImmuteDamageInterval(GetSpellTargetUnit(),3)
				call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Human\\Resurrect\\ResurrectCaster.mdl", GetUnitX(GetSpellTargetUnit()), GetUnitY(GetSpellTargetUnit()) ))
			endif
		//空间囚笼
		elseif (GetSpellAbilityId() == 'A0G1') then
 			call SimulateSpell(GetSpellAbilityUnit(),GetSpellAbilityUnit(),'A0G2',1,6,"stomp",false,true,false)
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    敌方单位
	*/
	private function EnemyFilterSeyu takes nothing returns boolean
		return IsEnemy(GetFilterUnit(),seyu) == true
	endfunction
    /*
        获取一个单位周围的随机一个敌方非魔免单位
    */
    function GetRandomUnitAround takes unit u,real radius returns unit
		local group l_group = CreateGroup()
	    local unit result = null
	    call GroupEnumUnitsInRange(l_group, GetUnitX(u), GetUnitY(u), radius, Condition(function EnemyFilterSeyu))
	    set result = FirstOfGroup(l_group)
	    call DestroyGroup(l_group)
	    set l_group = null
	    return result
    endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    曼陀罗之刺
	*/
	function Mantuoluo takes real damageRate,integer abilityID returns nothing
		local real damage = GetDamageAgi(seyu) * damageRate * 0.8
	    local integer i = 1
	    loop
	    	exitwhen i > IMinBJ(8,chongCount)
	    	if (chongdongs[i] != null) then
	    		call DamageAreaEffMirror(seyu,GetUnitX(chongdongs[i]),GetUnitY(chongdongs[i]),600,damage,"Abilities\\Spells\\Other\\Stampede\\StampedeMissileDeath.mdl" )
	    	endif
	    	set i = i +1
	    endloop
		call DamageAreaEffMirror(seyu,GetUnitX(seyu),GetUnitY(seyu),600,damage,"Abilities\\Spells\\Other\\Stampede\\StampedeMissileDeath.mdl" )
		call CreateUnitEffect(GetOwningPlayer(seyu),'h00E',GetUnitX(seyu),GetUnitY(seyu),0)
	    //输出伤害
	    call PrintSpell(GetOwningPlayer(seyu),GetAbilityName(abilityID),damage)
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    异界能量
	*/
	function TSpellSeyu2Con takes nothing returns boolean
	    return (((GetAttacker() == seyu) or (GetUnitTypeId(GetAttacker()) == 'n01I')) and ( IsSecondSpellOK(seyu) == true) and (GetRandomInt(1, 20) == 1) and (GetUnitStateSwap(UNIT_STATE_MANA, seyu) > 200.00) and (GetUnitAbilityLevel(seyu,'A0C2') > 0))
	endfunction
	function TSpellSeyu2Act takes nothing returns nothing
		call DisableTrigger(GetTriggeringTrigger())
		call Mantuoluo(1,'A0C2')
		call YDWEPolledWaitNull(5)
		call EnableTrigger(GetTriggeringTrigger())
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    异界能量1:文字位置
	*/
	//位置刷新，0.05s
	private function FlashPowerLocation takes nothing returns nothing
		call SetTextTagPosUnitBJ(TTPower,seyu,25)
	endfunction
	//数值刷新,1秒1次
	private function FlashPowerData takes nothing returns nothing
		local integer index = GetConvertedPlayerId(GetOwningPlayer(seyu))
		local real delta
		//限制能量在0-105之间
		set IPower = IMinBJ(IMaxBJ(IPower - IJ3(seyu,GetRandomInt(1,2),1),0),IJ3(seyu,255,105))
		debug if (ItempPower == 0 and IPower >= 105) then
			debug call SetSeyuSpinOK(GetOwningPlayer(seyu))
		debug endif
		debug set ItempPower = IPower
		call SetTextTagTextBJ(TTPower,I2S(IPower) + "%能量",20)
		set delta = I2R((IPower/10)*10)/100
		if (RAddtion != delta) then
			call AddStrPercent(index, delta - RAddtion )
			call AddIntPercent(index, delta - RAddtion )
			call AddAgiPercent(index, delta - RAddtion )
			set RAddtion = delta
			call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Demon\\DarkPortal\\DarkPortalTarget.mdl", GetUnitX(seyu), GetUnitY(seyu) ))
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
    	异界能量的获取
	*/
	private function TDeathAddPowerCon takes nothing returns boolean
		return (udg_H[GetConvertedPlayerId(GetOwningPlayer(GetKillingUnitBJ()))] == seyu)
	endfunction
	private function TDeathAddPowerAct takes nothing returns nothing
		set IPower = IPower + 1
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    初始化异界能量
	*/
	private function InitPower takes nothing returns nothing
		local timer ti = CreateTimer()
		local trigger t = CreateTrigger()
		//异界能量触发
		call TriggerRegisterAnyUnitEventBJ(t,EVENT_PLAYER_UNIT_DEATH)
		call TriggerAddCondition(t, Condition(function TDeathAddPowerCon))
		call TriggerAddAction(t, function TDeathAddPowerAct)
		set IPower = 0
		set RAddtion = 0
		set TTPower = CreateTextTagUnitBJ( I2S(IPower) + "%能量", seyu, 0, 20, 100, 0, 100, 0 )
		call TimerStart(ti,0.05,true,function FlashPowerLocation)
		set ti = CreateTimer()
		call TimerStart(ti,1,true,function FlashPowerData)
		set ti = null
		set t = null
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    空间封冻
	*/
	private function TSpellSeyu3Con takes nothing returns boolean
    	return GetAttackedUnitBJ() == seyu and GetRandomInt(1,20) == 1 and GetUnitState(seyu,UNIT_STATE_MANA) >= 400 and IsThirdSpellOK(seyu) == true and GetUnitAbilityLevel(seyu,'AEar') == 1
	endfunction
	private function TSpellSeyu3Act takes nothing returns nothing
		local real damage = GetDamageAgi(seyu) * 2
		local integer i = 1
		local unit u = null
		call DisableTrigger(GetTriggeringTrigger())
		loop
			exitwhen i > IMinBJ(8,chongCount)
			if (chongdongs[i] != null) then
				set u = GetRandomUnitAround(chongdongs[i],600)
	        	call CreateUnitEffect(GetOwningPlayer(u),'hh00',GetUnitX(u),GetUnitY(u),0)
	    		call CreateSpellTextTag("冻",u,0,100,0,4)
				call UnitDamageTarget( seyu, u, damage, false, true, ATTACK_TYPE_MAGIC, DAMAGE_TYPE_MAGIC, WEAPON_TYPE_WHOKNOWS )
			endif
			set i = i +1
		endloop
		set u = GetRandomUnitAround(seyu,600)
    	call CreateUnitEffect(GetOwningPlayer(u),'hh00',GetUnitX(u),GetUnitY(u),0)
		call CreateSpellTextTag("冻",u,0,100,0,4)
		call UnitDamageTarget( seyu, u, damage, false, true, ATTACK_TYPE_MAGIC, DAMAGE_TYPE_MAGIC, WEAPON_TYPE_WHOKNOWS )
	    call PrintSpell(GetOwningPlayer(seyu),GetAbilityName('AEar'),damage)
		set u = null
		call YDWEPolledWaitNull(8)
		call EnableTrigger(GetTriggeringTrigger())
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    空间杀手
	*/
	function Kongjianshashou takes nothing returns nothing
		local integer i = 1
		local integer ii = 1
		local integer attack = R2I(I2R(GetHeroAgi(seyu,true))*SquareRoot(GetHeroLevel(seyu)))
		call PrintSpellContent(GetOwningPlayer(seyu),GetAbilityName(GetSpellAbilityId()),"攻击力"+I2S(attack)+".")
        call PlaySoundBJ(gg_snd_seyu_4)
		loop
			exitwhen i > IMinBJ(8,chongCount)
			if (shashous[i] != null) then
	        	call FlushChildHashtable(YDHT,GetHandleId(shashous[i]))
				call RemoveUnit(shashous[i])
			endif
			set i = i +1
		endloop
		loop
			exitwhen ii > IMinBJ(8,chongCount)
			if (chongdongs[ii] != null) then
				set shashous[ii] = CreateUnit(GetOwningPlayer(seyu),'n01I',GetUnitX(chongdongs[ii]),GetUnitY(chongdongs[ii]),270)
				call UnitApplyTimedLifeBJ( 120, 'BHwe',shashous[ii] )
				call SetAttack(shashous[ii],attack)
			endif
			set ii = ii +1
		endloop
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    刷新杀手位置
	*/
	function FlashShashouLocation takes nothing returns nothing
		local integer i = 1
		loop
			exitwhen i > IMinBJ(8,chongCount)
			if (IsUnitAliveBJ(shashous[i]) and shashous[i] != null) then
				if not(IsUnitInRange(shashous[i], chongdongs[i], 1800.00)) then
					call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Human\\MassTeleport\\MassTeleportCaster.mdl", GetUnitX(shashous[i]), GetUnitY(shashous[i]) ))
					call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Human\\MassTeleport\\MassTeleportCaster.mdl", GetUnitX(chongdongs[i]), GetUnitY(chongdongs[i]) ))
					call SetUnitPosition(shashous[i],GetUnitX(chongdongs[i]),GetUnitY(chongdongs[i]))
				endif
			else
				set shashous[i] = null
			endif
			set i = i +1
		endloop
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    暗杀之舞
	*/
	private function AnShaZhiWuTimer takes nothing returns nothing
		local timer t = GetExpiredTimer()
		local integer id = GetHandleId(t)
		local real damage = GetDamageAgi(seyu) * 0.5
		local integer value = LoadInteger(spellTable,id,kAnShaCount)
		local integer i = 1
		if (value < 30) then
			//++1
			call SaveInteger(spellTable,id,kAnShaCount,value + 1)
			//特效
	        call CreateUnitEffect(GetOwningPlayer(seyu),'h00E',GetUnitX(seyu),GetUnitY(seyu),0)
    		call DamageArea(seyu,GetUnitX(seyu),GetUnitY(seyu),600,damage)
			loop
				exitwhen i > 8
				if (chongdongs[i] != null) then
	       			call CreateUnitEffect(GetOwningPlayer(seyu),'h00E',GetUnitX(chongdongs[i]),GetUnitY(chongdongs[i]),0)
	    			call DamageArea(seyu,GetUnitX(chongdongs[i]),GetUnitY(chongdongs[i]),600,damage)
				endif
				set i = i +1
			endloop
		else
			call PauseTimer(t)
			call DestroyTimer(t)
			call FlushChildHashtable(spellTable,id)
		endif
		set t = null
	endfunction
	private function AnShaZhiWu takes nothing returns nothing
		local timer t = CreateTimer()
	    call PrintSpell(GetOwningPlayer(seyu),GetAbilityName(GetSpellAbilityId()),GetDamageAgi(seyu))
		call SaveInteger(spellTable,GetHandleId(t),kAnShaCount,0)
        call PlaySoundBJ(gg_snd_seyu_5)
		call TimerStart(t,0.5,true,function AnShaZhiWuTimer)
		set t = null
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    英雄使用技能
	*/
	private function TSpellSeyuCon takes nothing returns boolean
	    return (GetSpellAbilityUnit() == seyu)
	endfunction
	private function TSpellSeyuAct takes nothing returns nothing
		if ((GetSpellAbilityId() == 'A0IM')) then
			call Mantuoluo(1,GetSpellAbilityId())
		//放虫洞
		elseif (GetSpellAbilityId() == 'A0IL') then
			call CreateChongdong()
		//空间杀手
		elseif (GetSpellAbilityId() == 'AEsv') then
			call Kongjianshashou()
		elseif ((GetSpellAbilityId() == 'AEst')) then
			call AnShaZhiWu()
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    英雄学习技能
	*/
	//按照12345来判断
	function LearnSkillSeyuI takes unit learner,integer whichSpell returns nothing
		local integer i
		if (learner == seyu) then
			if(whichSpell == 1) then
				set chongCount = chongCount + 1
			elseif (whichSpell == 2 and IsSecondSpellOK(seyu) == true and GetUnitAbilityLevel(seyu,'A0C2') == 1) then
				//技能2初始化
				call InitPower()
				set chongCount = chongCount + 1
			elseif (whichSpell == 3 and IsThirdSpellOK(seyu) == true and GetUnitAbilityLevel(seyu,'AEar') == 1) then
				//技能3初始化
				call SetPlayerTechResearchedSwap( 'R00D', 1, GetOwningPlayer(seyu) )
				set chongCount = chongCount + 1
				call InitSeyuAura()
			elseif (whichSpell == 4 and IsFourthSpellOK(seyu) == true and GetUnitAbilityLevel(seyu,'AEsv') == 1) then
				//技能4初始化
				set chongCount = chongCount + 1
			elseif (whichSpell == 5 and IsFifthSpellOK(seyu) == true and GetUnitAbilityLevel(seyu,'AEst') == 1) then
				//技能5初始化
				set chongCount = chongCount + 2
			endif
		endif
	endfunction
	function LearnSkillSeyu takes unit learner,integer learnSpellID returns nothing
		if (learner == seyu) then
			if (learnSpellID == 'A0IM') then
				call LearnSkillSeyuI(learner,1)
			elseif (learnSpellID == 'A0C2') then
				call LearnSkillSeyuI(learner,2)
			elseif (learnSpellID == 'AEar') then
				call LearnSkillSeyuI(learner,3)
			elseif (learnSpellID == 'AEsv') then
				call LearnSkillSeyuI(learner,4)
			elseif (learnSpellID == 'AEst') then
				call LearnSkillSeyuI(learner,5)
			endif
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    瑟雨皮肤
	*/
	private function InitSeyuSpin takes unit u returns unit
		if (IsSeyuSpin1(GetOwningPlayer(u))) then
			set udg_H[GetConvertedPlayerId(GetOwningPlayer(u))] = CreateUnit(GetOwningPlayer(u),'E00E',GetUnitX(u),GetUnitY(u),0)
			call UnitAddItemByIdSwapped('I006', udg_H[GetConvertedPlayerId(GetOwningPlayer(u))])
			call AddSpellPercent(GetConvertedPlayerId(GetOwningPlayer(u)),0.1)
			call SetUnitManaPercentBJ(udg_H[GetConvertedPlayerId(GetOwningPlayer(u))],100)
			call RemoveUnit(u)
			return udg_H[GetConvertedPlayerId(GetOwningPlayer(u))]
		else
			return u
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    初始化瑟雨
	*/
	function InitSeyu takes unit u returns nothing
		local integer i = 1
 		//皮肤
		set seyu = InitSeyuSpin(u)
		set chongCount = 2
		//1
	    set TSpellSeyu = CreateTrigger()
	    call TriggerRegisterAnyUnitEventBJ( TSpellSeyu, EVENT_PLAYER_UNIT_SPELL_EFFECT )
	    call TriggerAddCondition(TSpellSeyu, Condition(function TSpellSeyuCon))
	    call TriggerAddAction(TSpellSeyu, function TSpellSeyuAct)
		//1
	    set TSpellChongdong = CreateTrigger()
	    call TriggerRegisterAnyUnitEventBJ( TSpellChongdong, EVENT_PLAYER_UNIT_SPELL_EFFECT )
	    call TriggerAddAction(TSpellChongdong, function ChongdongSpell)
	    //2
	    set TSpellSeyu2 = CreateTrigger()
	    call TriggerRegisterAnyUnitEventBJ( TSpellSeyu2, EVENT_PLAYER_UNIT_ATTACKED )
	    call TriggerAddCondition(TSpellSeyu2, Condition(function TSpellSeyu2Con))
	    call TriggerAddAction(TSpellSeyu2, function TSpellSeyu2Act)
	    //注册空间封冻技能
	    set TSpellSeyu3 = CreateTrigger()
	    call TriggerRegisterAnyUnitEventBJ(TSpellSeyu3,EVENT_PLAYER_UNIT_ATTACKED)
	    call TriggerAddCondition(TSpellSeyu3, Condition(function TSpellSeyu3Con))
	    call TriggerAddAction(TSpellSeyu3, function TSpellSeyu3Act)
		//杀手位置刷新
		call TimerStart(CreateTimer(),5,true,function FlashShashouLocation)
	    //升级顺便提高虫洞技能等级
	    set TSpellSeyuUpdate = CreateTrigger()
	    call TriggerRegisterUnitEvent( TSpellSeyuUpdate, seyu, EVENT_UNIT_HERO_LEVEL )
	    call TriggerAddAction(TSpellSeyuUpdate, function TSpellSeyuUpdateAct)
	    call QJuexingSeyu()
	endfunction
endlibrary
/*
    英雄梦霁的技能
*/
library_once Mengji requires SpellBase,Printer,Attr,Aura,ChallangerDZ
	globals
		private integer ITianhong = 0
		private real HuanmengX = 0.
		private real HuanmengY = 0.
		/*
		    技能触发
		*/
		private trigger TSpellMengji = null
		private trigger TSpellMengji01 = null
		private trigger TSpellMengji02 = null
		private trigger TSpellMengji03 = null
		private trigger TSpellMengji2 = null
		private trigger TSpellMengji41 = null
		private trigger TSpellMengji42 = null
		/*
		    六涛天虹
		*/
		private item Liutao = null
		private item Nihe = null
		/*
		    玲珑舞两个单位及闪电特效
		*/
		private unit ULinglong1 = null
		private unit ULinglong2 = null
		private lightning array LLinglong
	endglobals
//---------------------------------------------------------------------------------------------------
	/*
	    马甲的攻击伤害
	*/
	function SimulateDamageMengji takes unit u returns boolean
		if (GetUnitTypeId(u) == 'hhm1') then
			call UnitDamageTarget( mengji, GetTriggerUnit(), GetDamageAgi(mengji) * 0.2, false, true, ATTACK_TYPE_MAGIC, DAMAGE_TYPE_MAGIC, WEAPON_TYPE_WHOKNOWS )
			return true
		endif
		if (GetUnitTypeId(u) == 'hhm2') then
			call UnitDamageTarget( mengji, GetTriggerUnit(), GetUnitState(GetTriggerUnit(),UNIT_STATE_MAX_LIFE) * 0.02, false, true, ATTACK_TYPE_CHAOS, DAMAGE_TYPE_SLOW_POISON, WEAPON_TYPE_WHOKNOWS )
			return true
		endif
		if (GetUnitTypeId(u) == 'hhm3') then
			call RecoverUnitHP(GetTriggerUnit(),0.1)
			return true
		endif
		//瞬伐心
		if (GetUnitTypeId(u) == 'h01B' and udg_H[GetConvertedPlayerId(GetOwningPlayer(u))] == mengji) then
			call UnitDamageTarget( mengji, GetTriggerUnit(), GetDamageAgi(mengji) * 0.35, false, true, ATTACK_TYPE_MAGIC, DAMAGE_TYPE_MAGIC, WEAPON_TYPE_WHOKNOWS )
			return true
		endif
		if (GetUnitTypeId(u) == 'hhm4') then
			call UnitDamageTarget( mengji, GetTriggerUnit(), GetDamageAgi(mengji) * 0.4, false, true, ATTACK_TYPE_MAGIC, DAMAGE_TYPE_MAGIC, WEAPON_TYPE_WHOKNOWS )
			return true
		endif
		return false
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    别人拿圣弓不能加属性
	*/
	function GetOtherLiutao takes unit u ,item it returns boolean
		if (GetItemTypeId(it) == 'I049' or GetItemTypeId(it) == 'I04A' or it == Nihe) then
			return (u == mengji)
		else
			return true
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    判断英雄是否拿着圣弓
	*/
	private function HasShenggong takes nothing returns boolean
		return UnitHasItem(mengji, Liutao)
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    圣弓与超圣弓的转换
	*/
	private function ExchangeChao takes boolean higher returns nothing
		local integer charges = GetItemCharges(Liutao)
		if (GetItemTypeId(Liutao) == I3(higher or BJuexing3[GetConvertedPlayerId(GetOwningPlayer(mengji))],'I04A','I049')) then
			return
		endif
		call FlushChildHashtable(YDHT,GetHandleId(Liutao))
		call RemoveItem(Liutao)
		set Liutao = CreateItem(I3(higher or BJuexing3[GetConvertedPlayerId(GetOwningPlayer(mengji))],'I04A','I049'),GetUnitX(mengji),GetUnitY(mengji))
	    call SaveInteger(YDHT,GetHandleId(Liutao),0xA75AD423,GetConvertedPlayerId(GetOwningPlayer(mengji)))
		call SetItemCharges(Liutao,charges)
		if (Nihe != null) then
			call SetItemVisible(Liutao,false)
		else
			if (IsUnitHasSlot(mengji)) then
				//有空位则给英雄
				call UnitAddItem( mengji,Liutao)
			endif
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    六涛天虹-拟态
	*/
	private function NitaiTimer takes nothing returns nothing
		local timer t = GetExpiredTimer()
		local integer id = GetHandleId(t)
		if (Nihe != null) then
			call RemoveItem(Nihe)
		endif
		set Nihe = null
		call SetItemVisible(Liutao,true)
		if (IsUnitHasSlot(mengji) and IsUnitAliveBJ(mengji)) then
			//有空位则给英雄
			call UnitAddItem( mengji,Liutao)
	    	call PrintSpellContent(GetOwningPlayer(mengji),GetAbilityName('A0GX'),"，拟态结束，圣弓回归至英雄身上.")
		else
			//没有位置则移到英雄脚下
			call SetItemPosition(Liutao,GetUnitX(mengji),GetUnitY(mengji))
			call PingMinimapForForce(YDWEGetForceOfPlayerNull(GetOwningPlayer(mengji)), GetUnitX(mengji),GetUnitY(mengji), 2.00)
	    	call PrintSpellContent(GetOwningPlayer(mengji),GetAbilityName('A0GX'),"，拟态结束，由于背包已满，圣弓回归至英雄脚下.")
		endif
		call PauseTimer(t)
		call FlushChildHashtable(spellTable,id)
		call DestroyTimer(t)
		set t = null
	endfunction
	private function Nitai takes nothing returns nothing
		local timer t = CreateTimer()
		local item temp = GetSpellTargetItem()
		local integer spellID = GetSpellAbilityId()
		//call SetItemPosition(Liutao,0,0)
		call UnitRemoveItemSwapped(Liutao,mengji)
		call SetItemVisible(Liutao,false)
		call UnitAddItemByIdSwapped(GetItemTypeId(temp), mengji)
		set Nihe = GetLastCreatedItem()
		call SetItemPawnable(Nihe,false)
		call TimerStart(t,30,false,function NitaiTimer)
	    call PrintSpellContent(GetOwningPlayer(mengji),GetAbilityName(spellID),"拟合出"+GetItemName(temp))
		set t = null
		set temp = null
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    若幻梦的装备回归
	*/
	function RuohuanmengChatBack1 takes nothing returns nothing
		if (Nihe != null) then
			call RemoveItem(Nihe)
			set Nihe = null
		endif
		if (IsUnitHasSlot(mengji) and IsUnitAliveBJ(mengji)) then
			//有空位则给英雄
			call UnitAddItem( mengji,Liutao)
	    	call PrintSpellContent(GetOwningPlayer(mengji),GetAbilityName('A0GX'),"，圣弓回归至英雄身上.")
		else
			//没有位置则移到英雄脚下
			call SetItemPosition(Liutao,GetUnitX(mengji),GetUnitY(mengji))
			call PingMinimapForForce(YDWEGetForceOfPlayerNull(GetOwningPlayer(mengji)), GetUnitX(mengji),GetUnitY(mengji), 2.00)
	    	call PrintSpellContent(GetOwningPlayer(mengji),GetAbilityName('A0GX'),"由于背包已满，圣弓回归至英雄脚下.")
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    若幻梦的装备回归
	*/
	function RuohuanmengChatBack takes nothing returns nothing
		if (ULinglong1 == null) then
			call ExchangeChao(false)
		endif
		if (IsUnitInRange(mengji,ULinglong1,900)) then
			call ExchangeChao(true)
		else
			call ExchangeChao(false)
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    若幻梦的攻击充能
	*/
	private function RuohuanmengAttackCon takes nothing returns boolean
		return GetAttacker() == mengji and HasShenggong()
	endfunction
	private function RuohuanmengAttack takes nothing returns nothing
		local integer times = GetItemCharges(Liutao)
		if (GetItemTypeId(Liutao) == 'I049') then
			if (times < IJ2(mengji,200,100)) then
				call SetItemCharges(Liutao,times + 1)
			endif
		else
			call SetItemCharges(Liutao,IMinBJ(1000,times + 1))
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    若幻梦的死亡复活触发
	*/
	function RuohuanmengDeathCon takes nothing returns boolean
	    return ((GetEventDamage() >= GetUnitStateSwap(UNIT_STATE_LIFE, GetTriggerUnit())) and GetItemCharges(Liutao) >= 100 and IsUnitAliveBJ(mengji))
	endfunction
	function RuohuanmengDeathAct takes nothing returns nothing
		call SetItemCharges(Liutao,IMaxBJ(0,GetItemCharges(Liutao) - 100))
	    call UnitAddAbilityBJ( 'A0GV', GetTriggerUnit() )
	    call YDWEPolledWaitNull(0.01)
	    call UnitRemoveAbilityBJ( 'A0GV', GetTriggerUnit() )
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    若幻梦的静止移动
	*/
    private function RuohuanmengTimer takes nothing returns nothing
    	if (HuanmengX != GetUnitX(mengji) or HuanmengY != GetUnitY(mengji)) then
    		set HuanmengX = GetUnitX(mengji)
    		set HuanmengY = GetUnitY(mengji)
    		//移动
    		if (GetUnitAbilityLevel(mengji,'A0GX') >= 1) then
    			call UnitRemoveAbility(mengji,'A0GX')
    			call UnitAddAbility(mengji,'A0GY')
    			call SetUnitAbilityLevel(mengji,'A0GY',1+IJ1(mengji,1,0)+IJ2(mengji,1,0)+IJ3(mengji,1,0))
    		endif
    	else
    		//静止
    		if (GetUnitAbilityLevel(mengji,'A0GY') >= 1) then
    			call UnitRemoveAbility(mengji,'A0GY')
    			call UnitAddAbility(mengji,'A0GX')
    			call SetUnitAbilityLevel(mengji,'A0GX',1+IJ1(mengji,1,0)+IJ2(mengji,1,0)+IJ3(mengji,1,0))
    		endif
    	endif
    endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    苍龙探幽箭
	*/
	private function Tanyoujian takes real damageRate,integer abilityID,real x2,real y2,integer count returns nothing
		local real damage = GetDamageAgi(mengji) * damageRate
	    local real x1 = GetUnitX(mengji)
	    local real y1 = GetUnitY(mengji)
	    local real facing = Atan2BJ(y2-y1,x2-x1)
		local unit u = null
		local boolean next = true
		local integer i = -1 * count / 2
		loop
			exitwhen i > count / 2
			set u = CreateUnit(GetOwningPlayer(mengji),'hhm5',x1,y1,facing + i * 20)
	    	call UnitApplyTimedLifeBJ( 2, 'BHwe', u)
		    call YDWETimerPatternRushSlide( u, facing + i * 20 , 2000, 2, 0.05, damage, 300., false, true, true, "origin", "Abilities\\Spells\\Undead\\DeathCoil\\DeathCoilSpecialArt.mdl", "Abilities\\Spells\\Other\\Stampede\\StampedeMissileDeath.mdl" )
			set i = i + 1
		endloop
	    call PrintSpell(GetOwningPlayer(mengji),GetAbilityName(abilityID),damage)
	    set u = null
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    玄音镇魂锁
	*/
	private function Zhenhunsuo takes nothing returns nothing
 		local unit u = CreateUnit(GetOwningPlayer(mengji),'h000',GetUnitX(mengji),GetUnitY(mengji),0)
	    call UnitApplyTimedLifeBJ( 12.00, 'BHwe',u )
        call UnitAddAbilityBJ( 'A0H0',u )
    	call IssueTargetOrder( u, "magicleash", GetSpellTargetUnit() )
 		set u = CreateUnit(GetOwningPlayer(mengji),'h000',GetUnitX(mengji),GetUnitY(mengji),0)
	    call UnitApplyTimedLifeBJ( 12.00, 'BHwe',u )
        call UnitAddAbilityBJ( 'A0H0',u )
    	call IssueTargetOrder( u, "magicleash", GetSpellTargetUnit() )
	    set u = null
	    call PrintSpellName(GetOwningPlayer(mengji),GetAbilityName(GetSpellAbilityId()))
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    镇魂锁被动
	*/
    private function TSpellMengji2Con takes nothing returns boolean
    	return GetAttacker() == mengji and IsSecondSpellOK(mengji) == true and GetUnitState(mengji,UNIT_STATE_MANA) >= 250 and HasShenggong() and GetUnitAbilityLevel(mengji,'AHM2') == 1
    endfunction
    private function TSpellMengji2Act takes nothing returns nothing
    	call DisableTrigger(GetTriggeringTrigger())
		call Tanyoujian(0.4,'AHM2',GetUnitX(GetAttackedUnitBJ()),GetUnitY(GetAttackedUnitBJ()),1)
		call YDWEPolledWaitNull(5)
    	call EnableTrigger(GetTriggeringTrigger())
    endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    阴阳三川箭
	*/
	private function Sanchuanjian takes nothing returns nothing
		local real damage = GetDamageAgi(mengji) * 0.2
		local real x = YDWECoordinateX(GetSpellTargetX() + GetRandomInt(-100,100))
		local real y = YDWECoordinateY(GetSpellTargetY() + GetRandomInt(-100,100))
        local unit u = CreateUnit(GetOwningPlayer(mengji),'hhm1',x,y,0)
        call UnitApplyTimedLifeBJ( 22.00, 'BHwe',u )
        call IssuePointOrder(u,"stampede",GetSpellTargetX(),GetSpellTargetY())
		set x = YDWECoordinateX(GetSpellTargetX() + GetRandomInt(-100,100))
		set y = YDWECoordinateY(GetSpellTargetY() + GetRandomInt(-100,100))
 		set u = CreateUnit(GetOwningPlayer(mengji),'hhm2',x,y,0)
        call UnitApplyTimedLifeBJ( 22.00, 'BHwe',u )
        call IssuePointOrder(u,"stampede",GetSpellTargetX(),GetSpellTargetY())
		set x = YDWECoordinateX(GetSpellTargetX() + GetRandomInt(-100,100))
		set y = YDWECoordinateY(GetSpellTargetY() + GetRandomInt(-100,100))
 		set u = CreateUnit(Player(10),'hhm3',x,y,0)
        call UnitApplyTimedLifeBJ( 22.00, 'BHwe',u )
        call IssuePointOrder(u,"stampede",GetSpellTargetX(),GetSpellTargetY())
	    call PrintSpell(GetOwningPlayer(mengji),GetAbilityName(GetSpellAbilityId()),damage)
        set u = null
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    万界瞬伐心
	*/
	private function Shunfaxin takes nothing returns nothing
		local real damage = GetDamageAgi(mengji) * 0.1
	    call EnableTrigger(TSpellMengji41)
	    call EnableTrigger(TSpellMengji42)
        call PlaySoundBJ(gg_snd_mengji_4)
	    call PrintSpell(GetOwningPlayer(mengji),GetAbilityName('AHM4'),damage)
	    call YDWEPolledWaitNull(30)
	    call DisableTrigger(TSpellMengji41)
	    call DisableTrigger(TSpellMengji42)
	    call PrintSpellContent(GetOwningPlayer(mengji),GetAbilityName('AHM4'),",施法结束.")
	endfunction
	/*
	    射箭
	*/
	private function ShunfaxinArrow takes real x2,real y2 returns nothing
		local real x1 = GetUnitX(mengji)
	    local real y1 = GetUnitY(mengji)
	    local real facing = Atan2BJ(y2-y1,x2-x1)
	    local real x = x2 - CosBJ(facing) * 100
	    local real y = y2 - SinBJ(facing) * 100
 		local unit u = CreateUnit(GetOwningPlayer(mengji),'h01B',x,y,0)
        call UnitApplyTimedLifeBJ( 5.00, 'BHwe',u )
        call UnitAddAbility(u,'A0H4')
        call IssuePointOrder(u,"carrionswarm",x2,y2)
        set u = null
        //call PolledWait(0.01)
        call IssuePointOrder(mengji,"move",GetUnitX(mengji),GetUnitY(mengji))
        // if (RAbsBJ(GetUnitX(mengji)-x1) < 600) then
	    //     call SetUnitX(mengji,x1)
	    //     call SetUnitY(mengji,y1)
        // 	endif
        // call IssueImmediateOrder(mengji,"stop")
	endfunction
	private function TSpellMengji4Con takes nothing returns boolean
	    return ((GetIssuedOrderIdBJ() == String2OrderIdBJ("smart")))
	endfunction
	private function TSpellMengji41Act takes nothing returns nothing
	    call ShunfaxinArrow(GetUnitX(GetOrderTargetUnit()),GetUnitY(GetOrderTargetUnit()))
	endfunction
	private function TSpellMengji42Act takes nothing returns nothing
	    call ShunfaxinArrow(GetOrderPointX(),GetOrderPointY())
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    浣海玲珑舞
	*/
	private function LinglongwuTimer takes nothing returns nothing
		local timer t = GetExpiredTimer()
		local unit u = null
		local integer id = GetHandleId(t)
		local integer count = LoadInteger(spellTable,id,1)
		local real angel = GetRandomReal(0,360)
		if (IsUnitInRange(mengji,ULinglong1,900)) then
			if (IsUnitAliveBJ(mengji)) then
				set u = CreateUnit(GetOwningPlayer(mengji),'hhm4',GetUnitX(mengji),GetUnitY(mengji),angel)
	       		call UnitApplyTimedLifeBJ( 5.00, 'BHwe',u )
	        	call IssuePointOrder(u,"carrionswarm",YDWECoordinateX(GetUnitX(mengji)+100*CosBJ(angel)),YDWECoordinateY(GetUnitY(mengji)+100*SinBJ(angel)))
			endif
	        call MoveLightningEx(LLinglong[1],true,YDWECoordinateX(GetUnitX(ULinglong1)+900*CosBJ(count)),YDWECoordinateY(GetUnitY(ULinglong1)+900*SinBJ(count)),0,YDWECoordinateX(GetUnitX(ULinglong1)+900*CosBJ(count)),YDWECoordinateY(GetUnitY(ULinglong1)+900*SinBJ(count)),750)
	        call MoveLightningEx(LLinglong[2],true,YDWECoordinateX(GetUnitX(ULinglong1)+900*CosBJ(count + 120)),YDWECoordinateY(GetUnitY(ULinglong1)+900*SinBJ(count + 120)),0,YDWECoordinateX(GetUnitX(ULinglong1)+900*CosBJ(count + 120)),YDWECoordinateY(GetUnitY(ULinglong1)+900*SinBJ(count + 120)),750)
	        call MoveLightningEx(LLinglong[3],true,YDWECoordinateX(GetUnitX(ULinglong1)+900*CosBJ(count+240)),YDWECoordinateY(GetUnitY(ULinglong1)+900*SinBJ(count+240)),0,YDWECoordinateX(GetUnitX(ULinglong1)+900*CosBJ(count+240)),YDWECoordinateY(GetUnitY(ULinglong1)+900*SinBJ(count+240)),750)
			call SaveInteger(spellTable,GetHandleId(t),1,ModuloInteger(count+6,360))
			set u = null
		else
			call RemoveUnit(ULinglong1)
			call RemoveUnit(ULinglong2)
			call DestroyLightningBJ(LLinglong[1])
			call DestroyLightningBJ(LLinglong[2])
			call DestroyLightningBJ(LLinglong[3])
			set ULinglong1 = null
			set ULinglong2 = null
			set LLinglong[1] = null
			set LLinglong[2] = null
			set LLinglong[3] = null
			call ExchangeChao(false)
			call PauseTimer(t)
			call FlushChildHashtable(spellTable,id)
			call DestroyTimer(t)
		endif
		set t = null
	endfunction
	private function Linglongwu takes nothing returns nothing
		local timer t = null
		if (ULinglong1 != null) then
			return
		endif
		set t = CreateTimer()
        call PlaySoundBJ(gg_snd_mengji_5)
		set ULinglong1 = CreateUnit(GetOwningPlayer(mengji),'h00S',GetUnitX(mengji),GetUnitY(mengji),0)
		set ULinglong2 = CreateUnit(GetOwningPlayer(mengji),'h00T',GetUnitX(mengji),GetUnitY(mengji),0)
		set LLinglong[1] = AddLightningEx("DRAM",true,YDWECoordinateX(GetUnitX(ULinglong1)+900),YDWECoordinateY(GetUnitY(ULinglong1)),0,YDWECoordinateX(GetUnitX(ULinglong1)+900),YDWECoordinateY(GetUnitY(ULinglong1)),750)
		set LLinglong[2] = AddLightningEx("DRAM",true,YDWECoordinateX(GetUnitX(ULinglong1)-450),YDWECoordinateY(GetUnitY(ULinglong1)),0,YDWECoordinateX(GetUnitX(ULinglong1)+779),YDWECoordinateY(GetUnitY(ULinglong1)),750)
		set LLinglong[3] = AddLightningEx("DRAM",true,YDWECoordinateX(GetUnitX(ULinglong1)-450),YDWECoordinateY(GetUnitY(ULinglong1)),0,YDWECoordinateX(GetUnitX(ULinglong1)-779),YDWECoordinateY(GetUnitY(ULinglong1)),750)
		call ExchangeChao(true)
		call SaveInteger(spellTable,GetHandleId(t),1,0)
		call TimerStart(t,0.1,true,function LinglongwuTimer)
	    call PrintSpell(GetOwningPlayer(mengji),GetAbilityName('AHM5'),GetDamageAgi(mengji)*0.2)
		set t = null
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    主英雄技能判断
	*/
	private function TSpellMengjiAct takes nothing returns nothing
		if (GetSpellAbilityId() == 'AHM1') then
			call Tanyoujian(0.75,GetSpellAbilityId(),GetSpellTargetX(),GetSpellTargetY(),5)
		elseif (GetSpellAbilityId() == 'AHM2') then
			call Zhenhunsuo()
		elseif (GetSpellAbilityId() == 'A0GW') then
			call Sanchuanjian()
		elseif (GetSpellAbilityId() == 'AHM4') then
			call Shunfaxin()
		elseif (GetSpellAbilityId() == 'AHM5') then
			call Linglongwu()
		//拟态
		elseif (GetSpellAbilityId() == 'A0JG' and IsCanCopy(GetSpellTargetItem())) then
			if (IsInRect(GetUnitX(mengji),GetUnitY(mengji),gg_rct_______a3) and IsInRect(GetUnitX(mengji),GetUnitY(mengji),gg_rct_______a3)) then
				call DisplayTextToPlayer(GetOwningPlayer(mengji), 0., 0., "|cFFFF66CC【消息】|r此处禁止拟态.")
			else
				call Nitai()
			endif
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    英雄学习技能
	*/
	//按照12345来判断
	function LearnSkillMengjiI takes unit learner,integer whichSpell returns nothing
		local integer i
		if (learner == mengji) then
			if(whichSpell == 1) then
			elseif (whichSpell == 2 and IsSecondSpellOK(mengji) == true and GetUnitAbilityLevel(mengji,'AHM2') == 1) then
				//技能2初始化
			elseif (whichSpell == 3 and IsThirdSpellOK(mengji) == true and GetUnitAbilityLevel(mengji,'A0GW') == 1) then
				//技能3初始化
				call AddSpecialEffectTargetUnitBJ("origin",mengji,"war3mapImported\\BlightwalkerAura.mdx")
				call InitMengjiAura()
			elseif (whichSpell == 4 and IsFourthSpellOK(mengji) == true and GetUnitAbilityLevel(mengji,'AHM4') == 1) then
				//技能4初始化
			elseif (whichSpell == 5 and IsFifthSpellOK(mengji) == true and GetUnitAbilityLevel(mengji,'AHM5') == 1) then
				//技能5初始化
			endif
		endif
	endfunction
	function LearnSkillMengji takes unit learner,integer learnSpellID returns nothing
		if (learner == mengji) then
			if (learnSpellID == 'AHM1') then
				call LearnSkillMengjiI(learner,1)
			elseif (learnSpellID == 'AHM2') then
				call LearnSkillMengjiI(learner,2)
			elseif (learnSpellID == 'A0GW') then
				call LearnSkillMengjiI(learner,3)
			elseif (learnSpellID == 'AHM4') then
				call LearnSkillMengjiI(learner,4)
			elseif (learnSpellID == 'AHM5') then
				call LearnSkillMengjiI(learner,5)
			endif
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	function InitMengji takes unit u returns nothing
	    local timer t = CreateTimer()
		set mengji = u
		set Liutao = YDWEGetItemOfTypeFromUnitBJNull(mengji, 'I049')
	    call SaveInteger(YDHT,GetHandleId(Liutao),0xA75AD423,GetConvertedPlayerId(GetOwningPlayer(mengji)))
	    /*
	        六涛的属性值
	    */
	    call AddStrPercent(GetConvertedPlayerId(GetOwningPlayer(mengji)),0.2 * I3(CT2(),6,1))
	    call AddAgiPercent(GetConvertedPlayerId(GetOwningPlayer(mengji)),0.2 * I3(CT2(),6,1))
	    call AddIntPercent(GetConvertedPlayerId(GetOwningPlayer(mengji)),0.2 * I3(CT2(),6,1))
	    call AddAttackPercent(GetConvertedPlayerId(GetOwningPlayer(mengji)),0.5 * I3(CT2(),6,1))
	    call AddSpellPercent(GetConvertedPlayerId(GetOwningPlayer(mengji)),0.4 * I3(CT2(),6,1))
	    call AddDamagePercent(GetConvertedPlayerId(GetOwningPlayer(mengji)),0.2 * I3(CT2(),6,1))
		call SetPlayerAbilityAvailable(GetOwningPlayer(mengji),'A0GV',false)
		//若幻梦
	    set TSpellMengji01 = CreateTrigger()
	    call TriggerRegisterPlayerChatEvent( TSpellMengji01, GetOwningPlayer(mengji), "-th", true )
	    call TriggerAddAction(TSpellMengji01, function RuohuanmengChatBack1)
	    set TSpellMengji02 = CreateTrigger()
	    call TriggerRegisterAnyUnitEventBJ( TSpellMengji02, EVENT_PLAYER_UNIT_ATTACKED )
	    call TriggerAddCondition(TSpellMengji02, Condition(function RuohuanmengAttackCon))
	    call TriggerAddAction(TSpellMengji02, function RuohuanmengAttack)
	    set TSpellMengji03 = CreateTrigger()
	    call TriggerRegisterUnitEvent( TSpellMengji03, mengji, EVENT_UNIT_DAMAGED )
	    call TriggerAddCondition(TSpellMengji03, Condition(function RuohuanmengDeathCon))
	    call TriggerAddAction(TSpellMengji03, function RuohuanmengDeathAct)
		//主英雄技能
		set TSpellMengji = CreateTrigger()
	    call TriggerRegisterUnitEvent(TSpellMengji,u,EVENT_UNIT_SPELL_EFFECT)
	    call TriggerAddAction(TSpellMengji, function TSpellMengjiAct)
	    //若幻梦静止与动
	    call TimerStart(t,0.5,true,function RuohuanmengTimer)
	    //英雄第二个技能攻击事件
	    set TSpellMengji2 = CreateTrigger()
	    call TriggerRegisterAnyUnitEventBJ(TSpellMengji2,EVENT_PLAYER_UNIT_ATTACKED)
	    call TriggerAddCondition(TSpellMengji2, Condition(function TSpellMengji2Con))
	    call TriggerAddAction(TSpellMengji2, function TSpellMengji2Act)
	    //瞬伐心
	    set TSpellMengji41 = CreateTrigger()
	    call TriggerRegisterUnitEvent( TSpellMengji41, mengji, EVENT_UNIT_ISSUED_TARGET_ORDER )
	    call TriggerAddCondition(TSpellMengji41, Condition(function TSpellMengji4Con))
	    call TriggerAddAction(TSpellMengji41, function TSpellMengji41Act)
	    call DisableTrigger(TSpellMengji41)
	    set TSpellMengji42 = CreateTrigger()
	    call TriggerRegisterUnitEvent( TSpellMengji42, mengji, EVENT_UNIT_ISSUED_POINT_ORDER )
	    call TriggerAddCondition(TSpellMengji42, Condition(function TSpellMengji4Con))
	    call TriggerAddAction(TSpellMengji42, function TSpellMengji42Act)
	    call DisableTrigger(TSpellMengji42)
	    set t = null
	endfunction
endlibrary
///#include  "edit/Diamond.j"
/*
    英雄幻逸的技能
*/
library_once Huanyi requires SpellBase,Printer,Attr,Diffculty,Aura,Diamond,Spin
	globals
		/*
		    技能触发
		*/
		private trigger TSpellHuanyi = null
		/*
		    伤害
		*/
		private real RDamageHuanyi = 0.
		/*
		    元素状态
		*/
		private boolean IsFire = false
		private boolean IsWater = false
		private boolean IsLumber = false
		private boolean IsWind = false
		integer ICurrentSpell = 0
		/*
		    魔能数
		*/
		private integer IMoneng = 0
		/*
		    提升智力倍数
		*/
		key kNoneIntTimes
		/*
		    泉水
		*/
		key kUHuanyiQuan
		/*
		    古参
		*/
		key kIGuCan
		timer TGuCan = null
		/*
		    寰宇
		*/
		key kHuanyuTimes
		/*
		    魔能
		*/
		private texttag TTMoneng
		private effect ELowMoneng = null
		private unit UGucan = null
		//开始挑战的计时器
        timer TiHuanyiTiaozhan = null
        timerdialog TiDiaHuanyiTiaozhan = null
        integer HuanyiTiaozhanCount = 0
        integer HuanyiTiaozhanCurrent = 0
        integer HuanyiWrongTimes = 0
	endglobals
//---------------------------------------------------------------------------------------------------
	/*
	    开始挑战
	*/
	private function RandomSetHuanyiTiaozhan takes nothing returns nothing
		local integer i = GetRandomInt(1,16)
		if ( i == 1 ) then
			set HuanyiTiaozhanCurrent = 'AHH5'
		elseif ( i == 2 ) then
			set HuanyiTiaozhanCurrent = 'AHH6'
		elseif ( i == 3 ) then
			set HuanyiTiaozhanCurrent = 'AHH7'
		elseif ( i == 4 ) then
			set HuanyiTiaozhanCurrent = 'AHH8'
		elseif ( i == 5 ) then
			set HuanyiTiaozhanCurrent = 'AHH9'
		elseif ( i == 6 ) then
			set HuanyiTiaozhanCurrent = 'AHHA'
		elseif ( i == 7 ) then
			set HuanyiTiaozhanCurrent = 'AHHB'
		elseif ( i == 8 ) then
			set HuanyiTiaozhanCurrent = 'AHHC'
		elseif ( i == 9 ) then
			set HuanyiTiaozhanCurrent = 'AHHD'
		elseif ( i == 10 ) then
			set HuanyiTiaozhanCurrent = 'AHHE'
		elseif ( i == 11 ) then
			set HuanyiTiaozhanCurrent = 'AHHF'
		elseif ( i == 12 ) then
			set HuanyiTiaozhanCurrent = 'AHHG'
		elseif ( i == 13 ) then
			set HuanyiTiaozhanCurrent = 'AHHH'
		elseif ( i == 14 ) then
			set HuanyiTiaozhanCurrent = 'AHHI'
		elseif ( i == 15 ) then
			set HuanyiTiaozhanCurrent = 'AHHJ'
		else
			set HuanyiTiaozhanCurrent = 'AHHK'
		endif
		call DisplayTextToPlayer(GetOwningPlayer(Huanyi), 0., 0., "|cFFFF66CC【消息】|r你的"+I2S(HuanyiTiaozhanCount)+"次技能挑战为"+GetAbilityName(HuanyiTiaozhanCurrent)+".")
	endfunction
    private function HuanyiTiaozhanTimeout takes nothing returns nothing
    	call DisplayTextToPlayer(GetOwningPlayer(Huanyi), 0., 0., "|cFFFF66CC【消息】|r你成功在30秒内完成了"+I2S(HuanyiTiaozhanCount)+"个技能.")
    	if (HuanyiTiaozhanCount >= 25) then
    		debug call SetHuanyiSpinOK(GetOwningPlayer(Huanyi))
    	endif
        call TimerDialogDisplay(TiDiaHuanyiTiaozhan,false)
        call DestroyTimerDialog(TiDiaHuanyiTiaozhan)
        call PauseTimer(TiHuanyiTiaozhan)
        call DestroyTimer(TiHuanyiTiaozhan)
        set TiHuanyiTiaozhan = null
        set TiDiaHuanyiTiaozhan = null
		set HuanyiWrongTimes = 0
        set HuanyiTiaozhanCount = 0
    endfunction
	private function HuanyiTiaozhanPanding takes nothing returns nothing
		if (ICurrentSpell == HuanyiTiaozhanCurrent) then
			set HuanyiTiaozhanCount = HuanyiTiaozhanCount +1
			call RandomSetHuanyiTiaozhan()
			set HuanyiWrongTimes = 0
		else
			set HuanyiWrongTimes = HuanyiWrongTimes + 1
			if (HuanyiWrongTimes >= 7) then
				set HuanyiTiaozhanCount = 0
				set HuanyiWrongTimes = 0
				call DisplayTextToPlayer(GetOwningPlayer(Huanyi), 0., 0., "|cFFFF66CC【消息】|r7次按键不能正确切换,清空挑战值.")
			endif
		endif
	endfunction
	function InitHuanyiTiaozhan takes nothing returns nothing
		if (TiHuanyiTiaozhan != null) then
			call DisplayTextToPlayer(GetOwningPlayer(Huanyi), 0., 0., "|cFFFF66CC【消息】|r请完成目前挑战再重新输入!")
			return
		endif
        set TiHuanyiTiaozhan = CreateTimer()
        set TiDiaHuanyiTiaozhan = CreateTimerDialogBJ(TiHuanyiTiaozhan,"幻逸挑战")
        call TimerStart(TiHuanyiTiaozhan,30,false,function HuanyiTiaozhanTimeout)
        call TimerDialogDisplay(TiDiaHuanyiTiaozhan,true)
        set HuanyiTiaozhanCount = 1
        call RandomSetHuanyiTiaozhan()
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    马甲的攻击伤害
	*/
	function SimulateDamageHuanyi takes unit u returns boolean
		//风
		if (GetUnitTypeId(u) == 'hhh3') then
			call UnitDamageTarget( Huanyi, GetTriggerUnit(), RDamageHuanyi * 0.3, false, true, ATTACK_TYPE_MAGIC, DAMAGE_TYPE_MAGIC, WEAPON_TYPE_WHOKNOWS )
			return true
		endif
		//冰火
		if (GetUnitTypeId(u) == 'h01B' and udg_H[GetConvertedPlayerId(GetOwningPlayer(u))] == Huanyi) then
			call UnitDamageTarget( Huanyi, GetTriggerUnit(), RDamageHuanyi * 0.4, false, true, ATTACK_TYPE_MAGIC, DAMAGE_TYPE_MAGIC, WEAPON_TYPE_WHOKNOWS )
			return true
		endif
		return false
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
		马甲的死亡触发效果
	*/
	function SimulateDeathHuanyi takes unit u returns nothing
		if (GetUnitTypeId(u) == 'hhh7') then
			call DamageArea(Huanyi,GetUnitX(u),GetUnitY(u),300,RDamageHuanyi*1.5)
	    	call DestroyEffect(AddSpecialEffect("Objects\\Spawnmodels\\Other\\NeutralBuildingExplosion\\NeutralBuildingExplosion.mdl", GetUnitX(u), GetUnitY(u) ))
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    获取多重施法的重数:1-5
	*/
	private function GetMultiSpell takes nothing returns integer
		if (BJuexing3[GetConvertedPlayerId(GetOwningPlayer(Huanyi))]) then
			return I3(IsWanjie(),6,5)
		endif
		if not(IsThirdSpellOK(Huanyi) == true and GetUnitAbilityLevel(Huanyi,'AHH2') == 1) then
			return 1 + IJ2(Huanyi,1,0)
		endif
		return IMaxBJ(IMinBJ(IMoneng/2,I3(IsWanjie(),4,5)),1) + IJ2(Huanyi,1,0)
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    幻元伏心，加20%的智力。
	*/
	private function NoneTimer takes nothing returns nothing
		local timer t = GetExpiredTimer()
		local real intTimes = LoadReal(spellTable,GetHandleId(t),kNoneIntTimes)
		call AddIntPercentImme(GetConvertedPlayerId(GetOwningPlayer(Huanyi)),-1 * intTimes)
		call FlushChildHashtable(spellTable,GetHandleId(t))
		call PauseTimer(t)
		call DestroyTimer(t)
		set t = null
	endfunction
	private function None takes nothing returns nothing
		local integer times = GetMultiSpell()
		local real intTimes = times * 0.2
		local real time = times * 10
		local timer t = CreateTimer()
		call SaveReal(spellTable,GetHandleId(t),kNoneIntTimes,intTimes)
		call TimerStart(t,time,false,function NoneTimer)
		call AddIntPercentImme(GetConvertedPlayerId(GetOwningPlayer(Huanyi)),intTimes)
		call YDWETimerDestroyEffect(time,AddSpecialEffectTargetUnitBJ("overhead",Huanyi,"war3mapImported\\music.mdx"))
		if (times > 1) then
	    	call CreateSpellTextTag(I2S(times)+"重施法",Huanyi,0,100,0,4)
		endif
	    call PrintSpellContent(GetOwningPlayer(Huanyi),GetAbilityName('AHH5'),"成功增加"+I2S(times*20)+"%的智力，持续"+I2S(times * 10)+"秒。")
	    set t = null
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
		七炎焚狱
	*/
	private function Fire takes real x,real y returns nothing
		local integer times = GetMultiSpell()
		local real damage = RDamageHuanyi
		local integer i = 1
		if (times > 1) then
	    	call CreateSpellTextTag(I2S(times)+"重施法",Huanyi,0,100,0,4)
		endif
	    call PrintSpell(GetOwningPlayer(Huanyi),GetAbilityName('AHH6'),damage)
		loop
			set times = times - 1
	        call CreateUnitEffect(GetOwningPlayer(Huanyi),'hhh1',x,y,0)
	        set i = 1
			loop
				exitwhen i > 6
	        	call CreateUnitEffect(GetOwningPlayer(Huanyi),'hhh1',x + 400 * CosBJ(i*60),y+ 400 * SinBJ(i*60),0)
				set i = i +1
			endloop
			call DamageArea(Huanyi,x,y,600,damage)
			exitwhen times <= 0
			call YDWEPolledWaitNull(0.5)
		endloop
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    天古木精
	*/
	private function Lumber takes nothing returns nothing
		local integer times = GetMultiSpell()
		local integer attack = GetHeroInt(Huanyi,true) + GetAttack(Huanyi)
		local integer defense = GetHeroAgi(Huanyi,true)/100 + GetDefense(Huanyi)
		local integer hp = GetHeroStr(Huanyi,true) * 10 + GetHP(Huanyi)
		local unit u
		local integer i = 1
		loop
			exitwhen i > times
			set u = CreateUnit(GetOwningPlayer(Huanyi),'hhh2',GetUnitX(Huanyi),GetUnitY(Huanyi),0)
			call SetUnitAnimation( u, "birth" )
			call UnitApplyTimedLifeBJ( 180.00, 'BHwe',u )
			call SetAttack(u,attack)
			call SetDefense(u,defense)
			call SetHP(u,hp)
			set i = i +1
		endloop
		if (times > 1) then
	    	call CreateSpellTextTag(I2S(times)+"重施法",Huanyi,0,100,0,4)
		endif
	    call PrintSpellName(GetOwningPlayer(Huanyi),GetAbilityName('AHH8'))
	    set u = null
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    幻化残卷
	*/
	private function Wind takes nothing returns nothing
		local integer times = GetMultiSpell()
		local unit u
		local integer i = 1
		loop
			exitwhen i > times
			set u = CreateUnit(GetOwningPlayer(Huanyi),'hhh3',YDWECoordinateX(GetUnitX(Huanyi) + GetRandomInt(-100,100)),YDWECoordinateY(GetUnitY(Huanyi) + GetRandomInt(-100,100)),0)
			call UnitApplyTimedLifeBJ( 15.00, 'BHwe',u )
			set i = i +1
		endloop
		if (times > 1) then
	    	call CreateSpellTextTag(I2S(times)+"重施法",Huanyi,0,100,0,4)
		endif
	    call PrintSpellName(GetOwningPlayer(Huanyi),GetAbilityName('AHH9'))
	    set u = null
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    冰火双绝，h01B
	*/
	private function FireWater takes nothing returns nothing
		local integer times = GetMultiSpell()
		local real damage = RDamageHuanyi * 0.6
		local integer i = 6 * times
		if (times > 1) then
	    	call CreateSpellTextTag(I2S(times)+"重施法",Huanyi,0,100,0,4)
		endif
	    call PrintSpell(GetOwningPlayer(Huanyi),GetAbilityName('AHHA'),damage)
		loop
			set i = i - 1
	 		call SimulateSpell4(Huanyi,YDWECoordinateX(GetUnitX(Huanyi)+GetRandomReal(-600,600)),YDWECoordinateY(GetUnitY(Huanyi)+GetRandomReal(-600,600)),'A05S',1,6,"blizzard")
	 		call SimulateSpell4(Huanyi,YDWECoordinateX(GetUnitX(Huanyi)+GetRandomReal(-600,600)),YDWECoordinateY(GetUnitY(Huanyi)+GetRandomReal(-600,600)),'A00U',1,6,"blizzard")
			exitwhen i <= 0
			call YDWEPolledWaitNull(0.5/times)
		endloop
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    万象归影
	*/
	private function FireLumber takes real x,real y returns nothing
		local integer times = GetMultiSpell()
		local real damage = RDamageHuanyi * 0.15
		local integer i = 1
		local integer ii = 1
		local real range = 150 * times
		if (IsInForbitRegion(x,y,Huanyi)) then
	        call DisplayTextToPlayer( GetOwningPlayer(Huanyi), 0, 0, "|cFFFF66CC【消息】|r此处禁止瞬移到达." )
	        return
		endif
		if (times > 1) then
	    	call CreateSpellTextTag(I2S(times)+"重施法",Huanyi,0,100,0,4)
		endif
		call SetUnitManaBJ(Huanyi,GetUnitState(Huanyi,UNIT_STATE_MANA) - 75)
	    call PrintSpell(GetOwningPlayer(Huanyi),GetAbilityName('AHHB'),damage)
		call SetUnitX(Huanyi,x)
		call SetUnitY(Huanyi,y)
		call IssueImmediateOrder(Huanyi,"stop")
		call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\NightElf\\Blink\\BlinkCaster.mdl", x, y ))
		loop
			exitwhen i > times - 1
			set ii = 1
			loop
				exitwhen ii > i * 1 + 4
				call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\NightElf\\Blink\\BlinkCaster.mdl", YDWECoordinateX(x+ 150 * i *CosBJ(360 * ii/(i * 1 + 4))), YDWECoordinateY(y + 150 * i * SinBJ(360 * ii/(i * 1 + 4))) ))
				set ii = ii + 1
			endloop
			set i = i +1
		endloop
		call DamageArea(Huanyi,x,y,range,damage)
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    火轮烁日
	*/
	private function FireWind takes real x2,real y2 returns nothing
		local integer times = GetMultiSpell()
		local real damage = RDamageHuanyi
		local integer i = 1
	    local real x1
	    local real y1
	    local real facing
		local unit u
		if (times > 1) then
	    	call CreateSpellTextTag(I2S(times)+"重施法",Huanyi,0,100,0,4)
		endif
	    call PrintSpell(GetOwningPlayer(Huanyi),GetAbilityName('AHHC'),damage)
		loop
			set times = times - 1
		    set x1 = GetUnitX(Huanyi)
		    set y1 = GetUnitY(Huanyi)
		    set facing = Atan2BJ(y2-y1,x2-x1)
			set u = CreateUnit(GetOwningPlayer(Huanyi),'hhh4',x1,y1,facing)
	    	call UnitApplyTimedLifeBJ( 2, 'BHwe', u)
		    call YDWETimerPatternRushSlide( u, facing , 1400, 2, 0.05, damage, 300., false, true, true, "origin", "", "Abilities\\Spells\\Other\\Incinerate\\FireLordDeathExplode.mdl" )
			exitwhen times <= 0
			call YDWEPolledWaitNull(0.5)
		endloop
	    set u = null
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    幻冥天泉
	*/
	private function WaterWindTimer takes nothing returns nothing
		local timer t = GetExpiredTimer()
		local integer id = GetHandleId(t)
		local unit u = LoadUnitHandle(spellTable,id,kUHuanyiQuan)
		local group l_group = CreateGroup()
		local unit l_unit
		if (IsUnitAliveBJ(u)) then
			call GroupEnumUnitsInRange(l_group, GetUnitX(u), GetUnitY(u), 600, null)
			loop
			    set l_unit = FirstOfGroup(l_group)
			    exitwhen l_unit == null
			    call GroupRemoveUnit(l_group, l_unit)
			    if (IsAlly(l_unit,Huanyi) and IsUnitAliveBJ(l_unit)) then
			    	call RecoverUnitHP(l_unit,0.3)
			    	call RecoverUnitMP(l_unit,20)
			    	call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Items\\AIma\\AImaTarget.mdl", GetUnitX(l_unit), GetUnitY(l_unit) ))
			    endif
			endloop
			call DestroyGroup(l_group)
			set l_group = null
			set l_unit =null
		else
			call RemoveUnit(u)
			call FlushChildHashtable(spellTable,id)
			call PauseTimer(t)
			call DestroyTimer(t)
		endif
		set u = null
		set t = null
		call DestroyGroup(l_group)
		set l_unit = null
		set l_group = null
	endfunction
	private function WaterWind takes real x,real y returns nothing
		local integer times = GetMultiSpell()
		local timer t = CreateTimer()
		local unit u = CreateUnit(GetOwningPlayer(Huanyi),'hhh5',x,y,0)
		if (times > 1) then
	    	call CreateSpellTextTag(I2S(times)+"重施法",Huanyi,0,100,0,4)
		endif
    	call UnitApplyTimedLifeBJ( 15*times, 'BHwe', u)
		call SaveUnitHandle(spellTable,GetHandleId(t),kUHuanyiQuan,u)
		call TimerStart(t,1,true,function WaterWindTimer)
	    call PrintSpellContent(GetOwningPlayer(Huanyi),GetAbilityName('AHHE'),"持续"+I2S(15*times)+"秒。")
		set t = null
		set u = null
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    沧怒古参
	*/
	private function WaterLumberWindTimer takes nothing returns nothing
		local integer id = GetHandleId(TGuCan)
		local integer times = LoadInteger(spellTable,id,kIGuCan)
		local integer i = 1
		local integer ii = 1
		if (IsUnitAliveBJ(Huanyi)) then
			call DestroyEffect(AddSpecialEffect("Objects\\Spawnmodels\\NightElf\\NECancelDeath\\NECancelDeath.mdl", GetUnitX(UGucan), GetUnitY(UGucan) ))
			loop
				exitwhen i > times - 1
				set ii = 1
				loop
					exitwhen ii > i * 1 + 2
					call DestroyEffect(AddSpecialEffect("Objects\\Spawnmodels\\NightElf\\NECancelDeath\\NECancelDeath.mdl", YDWECoordinateX(GetUnitX(UGucan)+ 150 * i* CosBJ(360 * ii/(i * 1 + 2))), YDWECoordinateY(GetUnitY(UGucan) + 150 * i * SinBJ(360 * ii/(i * 1 + 2))) ))
					set ii = ii +1
				endloop
				set i = i +1
			endloop
			call DamageAreaMirror(Huanyi,GetUnitX(UGucan),GetUnitY(UGucan),times * 150,RDamageHuanyi*0.15)
		else
			call RemoveUnit(UGucan)
			set UGucan = null
			call FlushChildHashtable(spellTable,id)
			call PauseTimer(TGuCan)
			call DestroyTimer(TGuCan)
			set TGuCan = null
		endif
	endfunction
	private function WaterLumberWind takes real x,real y returns nothing
		local integer times = GetMultiSpell()
		if (UGucan != null) then
			call RemoveUnit(UGucan)
		endif
		if (TGuCan != null) then
			call PauseTimer(TGuCan)
			call DestroyTimer(TGuCan)
		endif
		set TGuCan = CreateTimer()
		set UGucan = CreateUnit(GetOwningPlayer(Huanyi),'hhh6',x,y,270)
		if (times > 1) then
	    	call CreateSpellTextTag(I2S(times)+"重施法",Huanyi,0,100,0,4)
		endif
    	call SetUnitScalePercent( UGucan, 100.00 + times * 20.00 , 100.00 + times * 20.00, 100.00 + times * 20.00 )
    	call SetUnitAnimation( UGucan, "stand birth alternate work upgrade" )
		call SaveInteger(spellTable,GetHandleId(TGuCan),kIGuCan,times)
		call TimerStart(TGuCan,1,true,function WaterLumberWindTimer)
	    call PrintSpellName(GetOwningPlayer(Huanyi),GetAbilityName('AHHG'))
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    雨玥千里
	*/
	private function FireLumberWind takes nothing returns nothing
		local integer times = GetMultiSpell()
		if (times > 1) then
	    	call CreateSpellTextTag(I2S(times)+"重施法",Huanyi,0,100,0,4)
		endif
	    call PrintSpellContent(GetOwningPlayer(Huanyi),GetAbilityName('AHHH'),",眩晕"+I2S(times*2)+"秒。")
 		call SimulateSpell(Huanyi,Huanyi,'A0BI',times,6,"stomp",false,true,false)
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    残月流星
	*/
	private function FireWaterWind takes real x,real y returns nothing
		local integer times = GetMultiSpell()
		local real damage = RDamageHuanyi * 1.5
		local unit u
		local integer i = 1
		if (times > 1) then
	    	call CreateSpellTextTag(I2S(times)+"重施法",Huanyi,0,100,0,4)
		endif
	    call PrintSpell(GetOwningPlayer(Huanyi),GetAbilityName('AHHI'),damage)
		loop
			set times = times - 1
			set u = CreateUnit(GetOwningPlayer(Huanyi),'hhh7',x,y,0)
    		call SetUnitFlyHeight( u, 0.00, 333.00 )
			exitwhen times <= 0
			call YDWEPolledWaitNull(0.5)
		endloop
		set u = null
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    引力界场
	*/
	private function FireWaterLumber takes real x,real y returns nothing
		local integer times = GetMultiSpell()
		local integer i = 1
		local unit u
	    local Attract attract
	    if (IsTerrainPathable(x, y, PATHING_TYPE_WALKABILITY)) then
	    	call DisplayTextToPlayer(GetOwningPlayer(Huanyi), 0., 0., "|cFFFF66CC【消息】|r目标地点不能通行,技能施法无效！")
	    	return
	    endif
		set u = CreateUnit(GetOwningPlayer(Huanyi),'hhh8',x,y,0)
	    set attract = Attract.create(u,I3(IsInDiamondRegion(x,y),1200,900 * times),0.05,50 * times)
		if (times > 1) then
	    	call CreateSpellTextTag(I2S(times)+"重施法",Huanyi,0,100,0,4)
		endif
	    call PrintSpellContent(GetOwningPlayer(Huanyi),GetAbilityName('AHHJ'),"范围"+I2S(900 * times) +"s.")
		call UnitApplyTimedLifeBJ( 3, 'BHwe', u)
		call attract.SetForbitHero()
	    call attract.start()
	    set u = null
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    寰宇归一
	*/
	private function FireWaterLumberWindTimer takes nothing returns nothing
		local timer t = GetExpiredTimer()
		local real attrTimes = LoadReal(spellTable,GetHandleId(t),kHuanyuTimes)
		call AddIntPercentImme(GetConvertedPlayerId(GetOwningPlayer(Huanyi)),-1 * attrTimes)
		call AddAgiPercentImme(GetConvertedPlayerId(GetOwningPlayer(Huanyi)),-1 * attrTimes)
		call AddStrPercentImme(GetConvertedPlayerId(GetOwningPlayer(Huanyi)),-1 * attrTimes)
		call FlushChildHashtable(spellTable,GetHandleId(t))
		call PauseTimer(t)
		call DestroyTimer(t)
		set t = null
	endfunction
	private function FireWaterLumberWind takes nothing returns nothing
		local integer times = GetMultiSpell()
		local real attrTimes = times * 0.2
		local real time = times * 10
		local timer t = CreateTimer()
		call SaveReal(spellTable,GetHandleId(t),kHuanyuTimes,attrTimes)
		call TimerStart(t,time,false,function FireWaterLumberWindTimer)
		call AddIntPercentImme(GetConvertedPlayerId(GetOwningPlayer(Huanyi)),attrTimes)
		call AddAgiPercentImme(GetConvertedPlayerId(GetOwningPlayer(Huanyi)),attrTimes)
		call AddStrPercentImme(GetConvertedPlayerId(GetOwningPlayer(Huanyi)),attrTimes)
		call YDWETimerDestroyEffect(time,AddSpecialEffectTargetUnitBJ("origin",Huanyi,"war3mapImported\\blackbird.mdx"))
		if (times > 1) then
	    	call CreateSpellTextTag(I2S(times)+"重施法",Huanyi,0,100,0,4)
		endif
	    call PrintSpellContent(GetOwningPlayer(Huanyi),GetAbilityName('AHHK'),"成功增加"+I2S(times*20)+"%的三围属性，持续"+I2S(times * 10)+"秒。")
	    set t = null
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    复苏
	*/
	private function Fusu takes nothing returns nothing
		local real x = GetSpellTargetX()
		local real y = GetSpellTargetY()
        call PlaySoundBJ(gg_snd_huanyi_5)
		//幻元伏心
		call None()
		call YDWEPolledWaitNull(1)
		//七炎焚狱
		if (GetUnitState(Huanyi,UNIT_STATE_MANA) < 100) then
	    	call PrintSpellContent(GetOwningPlayer(Huanyi),GetAbilityName('AHH4'),",施法结束.")
			return
		endif
		call RecoverUnitMP(Huanyi,-100)
		call Fire(x,y)
		call YDWEPolledWaitNull(1)
		//冰芯之铠
		if (GetUnitState(Huanyi,UNIT_STATE_MANA) < 15) then
	    	call PrintSpellContent(GetOwningPlayer(Huanyi),GetAbilityName('AHH4'),",施法结束.")
			return
		endif
		call RecoverUnitMP(Huanyi,-15)
 		call SimulateSpell(Huanyi,Huanyi,'AHH7',GetHeroLevel(Huanyi)/2,5,"frostarmoron",false,false,true)
	    call PrintSpellName(GetOwningPlayer(Huanyi),GetAbilityName('AHH7'))
		call YDWEPolledWaitNull(1)
 		//天古木精
		if (GetUnitState(Huanyi,UNIT_STATE_MANA) < 100) then
	    	call PrintSpellContent(GetOwningPlayer(Huanyi),GetAbilityName('AHH4'),",施法结束.")
			return
		endif
		call RecoverUnitMP(Huanyi,-100)
		call Lumber()
		call YDWEPolledWaitNull(1)
		//幻化残卷
		if (GetUnitState(Huanyi,UNIT_STATE_MANA) < 200) then
	    	call PrintSpellContent(GetOwningPlayer(Huanyi),GetAbilityName('AHH4'),",施法结束.")
			return
		endif
		call RecoverUnitMP(Huanyi,-200)
		call Wind()
		call YDWEPolledWaitNull(1)
		//冰火双绝
		if (GetUnitState(Huanyi,UNIT_STATE_MANA) < 150) then
	    	call PrintSpellContent(GetOwningPlayer(Huanyi),GetAbilityName('AHH4'),",施法结束.")
			return
		endif
		call RecoverUnitMP(Huanyi,-150)
		call FireWater()
		call YDWEPolledWaitNull(1)
		//万象归影
		if (GetUnitState(Huanyi,UNIT_STATE_MANA) < 100) then
	    	call PrintSpellContent(GetOwningPlayer(Huanyi),GetAbilityName('AHH4'),",施法结束.")
			return
		endif
		call RecoverUnitMP(Huanyi,-100)
		call FireLumber(x,y)
		call YDWEPolledWaitNull(1)
		//火轮烁日
		if (GetUnitState(Huanyi,UNIT_STATE_MANA) < 150) then
	    	call PrintSpellContent(GetOwningPlayer(Huanyi),GetAbilityName('AHH4'),",施法结束.")
			return
		endif
		call RecoverUnitMP(Huanyi,-150)
		call FireWind(x,y)
		call YDWEPolledWaitNull(1)
		//幻冥天泉
		if (GetUnitState(Huanyi,UNIT_STATE_MANA) < 300) then
	    	call PrintSpellContent(GetOwningPlayer(Huanyi),GetAbilityName('AHH4'),",施法结束.")
			return
		endif
		call RecoverUnitMP(Huanyi,-300)
		call WaterWind(x,y)
		call YDWEPolledWaitNull(1)
		//沧怒古参
		if (GetUnitState(Huanyi,UNIT_STATE_MANA) < 1500) then
	    	call PrintSpellContent(GetOwningPlayer(Huanyi),GetAbilityName('AHH4'),",施法结束.")
			return
		endif
		call RecoverUnitMP(Huanyi,-1500)
		call WaterLumberWind(x,y)
		call YDWEPolledWaitNull(1)
		//雨玥千里
		if (GetUnitState(Huanyi,UNIT_STATE_MANA) < 200) then
	    	call PrintSpellContent(GetOwningPlayer(Huanyi),GetAbilityName('AHH4'),",施法结束.")
			return
		endif
		call RecoverUnitMP(Huanyi,-200)
		call FireLumberWind()
		call YDWEPolledWaitNull(1)
		//残月流星
		if (GetUnitState(Huanyi,UNIT_STATE_MANA) < 100) then
	    	call PrintSpellContent(GetOwningPlayer(Huanyi),GetAbilityName('AHH4'),",施法结束.")
			return
		endif
		call RecoverUnitMP(Huanyi,-100)
		call FireWaterWind(x,y)
		call YDWEPolledWaitNull(1)
		//引力界场
		if (GetUnitState(Huanyi,UNIT_STATE_MANA) < 360) then
	    	call PrintSpellContent(GetOwningPlayer(Huanyi),GetAbilityName('AHH4'),",施法结束.")
			return
		endif
		call RecoverUnitMP(Huanyi,-360)
		call FireWaterLumber(x,y)
		call YDWEPolledWaitNull(1)
		//寰宇归一
		if (GetUnitState(Huanyi,UNIT_STATE_MANA) < 800) then
	    	call PrintSpellContent(GetOwningPlayer(Huanyi),GetAbilityName('AHH4'),",施法结束.")
			return
		endif
		call RecoverUnitMP(Huanyi,-800)
		call FireWaterLumberWind()
	    call PrintSpellContent(GetOwningPlayer(Huanyi),GetAbilityName('AHH4'),",施法结束.")
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    幻逸升级后刷新冰甲的等级
	*/
	private function TSpellHuanyi2Act takes nothing returns nothing
		call SetUnitAbilityLevel(Huanyi,'AHH7',IMinBJ(100,GetHeroLevel(Huanyi)/2))
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    幻逸魔能等级减少受到的伤害
	*/
	private function TSpellHuanyi3Con takes nothing returns boolean
		return IsFourthSpellOK(Huanyi) == true and GetUnitAbilityLevel(Huanyi,'AHH3') == 1 and IMoneng <= 5 and GetRandomInt(1,2) == 1
	endfunction
	private function TSpellHuanyi3Act takes nothing returns nothing
		call SetUnitLifeBJ(Huanyi,GetUnitState(Huanyi,UNIT_STATE_LIFE)+GetEventDamage())
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    刷新魔能
	*/
	private function FlashPowerData takes nothing returns nothing
		call SetTextTagPosUnitBJ(TTMoneng,Huanyi,20)
		if ((GetUnitState(Huanyi,UNIT_STATE_MANA) >= GetUnitState(Huanyi,UNIT_STATE_MAX_MANA) * 0.9) and IMoneng < 10) then
			call SetUnitManaPercentBJ(Huanyi,30)
			call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Human\\Avatar\\AvatarCaster.mdl", GetUnitX(Huanyi), GetUnitY(Huanyi) ))
			set IMoneng = IMoneng + 1
			call AddSpellPercent(GetConvertedPlayerId(GetOwningPlayer(Huanyi)),0.1)
			if (ELowMoneng != null and IMoneng > 5) then
				call DestroyEffect(ELowMoneng)
				set ELowMoneng = null
			endif
		elseif((GetUnitState(Huanyi,UNIT_STATE_MANA) < GetUnitState(Huanyi,UNIT_STATE_MAX_MANA) * 0.2)and IMoneng > 0) then
			call SetUnitManaPercentBJ(Huanyi,80)
			set IMoneng = IMoneng - 1
	    	call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Orc\\HealingWave\\HealingWaveTarget.mdl", GetUnitX(Huanyi), GetUnitY(Huanyi) ))
			call AddSpellPercent(GetConvertedPlayerId(GetOwningPlayer(Huanyi)),- 0.1)
			if (ELowMoneng == null and IMoneng <= 5) then
				set ELowMoneng = AddSpecialEffectTargetUnitBJ("origin",Huanyi,"Abilities\\Spells\\Human\\ManaShield\\ManaShieldCaster.mdl")
			endif
	    else
	    	return
		endif
		call SetTextTagTextBJ(TTMoneng,I2S(IMoneng) + "级魔能",20)
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    初始化魔能
	*/
	private function InitPower takes nothing returns nothing
		local timer ti = CreateTimer()
		set IMoneng = 0
		set TTMoneng = CreateTextTagUnitBJ( "0级魔能", Huanyi, 0, 20, 0, 50, 100, 0 )
		call TimerStart(ti,0.05,true,function FlashPowerData)
		set ELowMoneng = AddSpecialEffectTargetUnitBJ("origin",Huanyi,"Abilities\\Spells\\Human\\ManaShield\\ManaShieldCaster.mdl")
		set ti = null
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    根据元素激活与否去设置相应的技能
	*/
	private function SetHuanyiSpell takes nothing returns nothing
		call SetPlayerAbilityAvailable(GetOwningPlayer(Huanyi),ICurrentSpell,false)
		if (ICurrentSpell == 'AHHF') then
			call UnitRemoveAbility(Huanyi,'AHHF')
		endif
		//0排列
		if (not(IsFire) and not(IsWater) and not(IsLumber) and not(IsWind)) then
			set ICurrentSpell = 'AHH5'
		//1排列
		elseif ((IsFire) and not(IsWater) and not(IsLumber) and not(IsWind)) then
			set ICurrentSpell = 'AHH6'
		elseif (not(IsFire) and (IsWater) and not(IsLumber) and not(IsWind)) then
			set ICurrentSpell = 'AHH7'
		elseif (not(IsFire) and not(IsWater) and (IsLumber) and not(IsWind)) then
			set ICurrentSpell = 'AHH8'
		elseif (not(IsFire) and not(IsWater) and not(IsLumber) and (IsWind)) then
			set ICurrentSpell = 'AHH9'
		//2排列
		elseif ((IsFire) and (IsWater) and not(IsLumber) and not(IsWind)) then
			set ICurrentSpell = 'AHHA'
		elseif ((IsFire) and not(IsWater) and (IsLumber) and not(IsWind)) then
			set ICurrentSpell = 'AHHB'
		elseif ((IsFire) and not(IsWater) and not(IsLumber) and (IsWind)) then
			set ICurrentSpell = 'AHHC'
		elseif (not(IsFire) and (IsWater) and (IsLumber) and not(IsWind)) then
			set ICurrentSpell = 'AHHD'
		elseif (not(IsFire) and (IsWater) and not(IsLumber) and (IsWind)) then
			set ICurrentSpell = 'AHHE'
		elseif (not(IsFire) and not(IsWater) and (IsLumber) and (IsWind)) then
			set ICurrentSpell = 'AHHF'
			call UnitAddAbility(Huanyi,'AHHF')
		//1排列
		elseif (not(IsFire) and (IsWater) and (IsLumber) and (IsWind)) then
			set ICurrentSpell = 'AHHG'
		elseif ((IsFire) and not(IsWater) and (IsLumber) and (IsWind)) then
			set ICurrentSpell = 'AHHH'
		elseif ((IsFire) and (IsWater) and not(IsLumber) and (IsWind)) then
			set ICurrentSpell = 'AHHI'
		elseif ((IsFire) and (IsWater) and (IsLumber) and not(IsWind)) then
			set ICurrentSpell = 'AHHJ'
		//0排列
		else
			set ICurrentSpell = 'AHHK'
		endif
		if not(BTianfu) then
			call SetPlayerAbilityAvailable(GetOwningPlayer(Huanyi),ICurrentSpell,true)
		endif
		if (TiHuanyiTiaozhan != null) then
			call HuanyiTiaozhanPanding()
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    主英雄技能判断
	*/
	private function TSpellHuanyiAct takes nothing returns nothing
		//四相
		if (GetSpellAbilityId() == 'AHH0') then
			set IsFire = not (IsFire)
			call SetHuanyiSpell()
		elseif (GetSpellAbilityId() == 'AHH1') then
			set IsWater = not (IsWater)
			call SetHuanyiSpell()
		elseif (GetSpellAbilityId() == 'AHH2') then
			set IsLumber = not (IsLumber)
			call SetHuanyiSpell()
		elseif (GetSpellAbilityId() == 'AHH3') then
			set IsWind = not (IsWind)
			call SetHuanyiSpell()
		//复苏
		elseif (GetSpellAbilityId() == 'AHH4') then
			call Fusu()
		//幻元伏心
		elseif (GetSpellAbilityId() == 'AHH5') then
			call None()
		//七炎焚狱
		elseif (GetSpellAbilityId() == 'AHH6') then
			call Fire(GetSpellTargetX(),GetSpellTargetY())
		//天古木精
		elseif (GetSpellAbilityId() == 'AHH8') then
			call Lumber()
		//幻化残卷
		elseif (GetSpellAbilityId() == 'AHH9') then
			call Wind()
		//冰火双绝
		elseif (GetSpellAbilityId() == 'AHHA') then
			call FireWater()
		//万象归影
		elseif (GetSpellAbilityId() == 'AHHB') then
			call FireLumber(GetSpellTargetX(),GetSpellTargetY())
		//火轮烁日
		elseif (GetSpellAbilityId() == 'AHHC') then
			call FireWind(GetSpellTargetX(),GetSpellTargetY())
		//幻冥天泉
		elseif (GetSpellAbilityId() == 'AHHE') then
			call WaterWind(GetSpellTargetX(),GetSpellTargetY())
		//沧怒古参
		elseif (GetSpellAbilityId() == 'AHHG') then
			call WaterLumberWind(GetSpellTargetX(),GetSpellTargetY())
		//雨玥千里
		elseif (GetSpellAbilityId() == 'AHHH') then
			call FireLumberWind()
		//残月流星
		elseif (GetSpellAbilityId() == 'AHHI') then
			call FireWaterWind(GetSpellTargetX(),GetSpellTargetY())
		//引力界场
		elseif (GetSpellAbilityId() == 'AHHJ') then
			call FireWaterLumber(GetSpellTargetX(),GetSpellTargetY())
		//寰宇归一
		elseif (GetSpellAbilityId() == 'AHHK') then
			call FireWaterLumberWind()
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    刷新伤害
	*/
	private function FlashHuanyiDamage takes nothing returns nothing
		set RDamageHuanyi = GetDamageInt(Huanyi)
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    英雄学习技能
	*/
	//按照12345来判断
	function LearnSkillHuanyiI takes unit learner,integer whichSpell returns nothing
		local integer i
		if (learner == Huanyi) then
			if (whichSpell == 2 and IsSecondSpellOK(Huanyi) == true and GetUnitAbilityLevel(Huanyi,'AHH1') == 1) then
				//技能2初始化
				call InitPower()
			elseif (whichSpell == 4 and IsFourthSpellOK(Huanyi) == true and GetUnitAbilityLevel(Huanyi,'AHH3') == 1) then
				call InitHuanyiAura()
				call AddSpecialEffectTargetUnitBJ("origin",Huanyi,"war3mapImported\\sichongjiejie_b.mdx")
			endif
		endif
	endfunction
	function LearnSkillHuanyi takes unit learner,integer learnSpellID returns nothing
		if (learner == Huanyi) then
			if (learnSpellID == 'AHH0') then
				call LearnSkillHuanyiI(learner,1)
			elseif (learnSpellID == 'AHH1') then
				call LearnSkillHuanyiI(learner,2)
			elseif (learnSpellID == 'AHH2') then
				call LearnSkillHuanyiI(learner,3)
			elseif (learnSpellID == 'AHH3') then
				call LearnSkillHuanyiI(learner,4)
			elseif (learnSpellID == 'AHH4') then
				call LearnSkillHuanyiI(learner,5)
			endif
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    幻逸皮肤
	*/
	private function InitHuanyiSpin takes unit u returns unit
		if (IsHuanyiSpin1(GetOwningPlayer(u))) then
			set udg_H[GetConvertedPlayerId(GetOwningPlayer(u))] = CreateUnit(GetOwningPlayer(u),'H026',GetUnitX(u),GetUnitY(u),0)
			set gg_unit_Hant_0205 = udg_H[GetConvertedPlayerId(GetOwningPlayer(u))]
			call UnitAddItemByIdSwapped('I006', udg_H[GetConvertedPlayerId(GetOwningPlayer(u))])
			call AddSpellPercent(GetConvertedPlayerId(GetOwningPlayer(u)),0.1)
			call SetUnitManaPercentBJ(udg_H[GetConvertedPlayerId(GetOwningPlayer(u))],1000)
			call RemoveUnit(u)
			return udg_H[GetConvertedPlayerId(GetOwningPlayer(u))]
		else
			return u
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    初始化新英雄,选取时调用
	*/
	function InitHuanyi takes unit u returns nothing
		local trigger t = CreateTrigger()
		set Huanyi = InitHuanyiSpin(u)
		set ICurrentSpell = 'AHH5'
		//主英雄技能
		set TSpellHuanyi = CreateTrigger()
	    call TriggerRegisterUnitEvent(TSpellHuanyi,Huanyi,EVENT_UNIT_SPELL_EFFECT)
	    call TriggerAddAction(TSpellHuanyi, function TSpellHuanyiAct)
	    //魔能等级低于5则减少受到的50%伤害
	    call TriggerRegisterUnitEvent(t,Huanyi,EVENT_UNIT_DAMAGED)
	    call TriggerAddCondition(t,Condition(function TSpellHuanyi3Con))
	    call TriggerAddAction(t,function TSpellHuanyi3Act)
	    //刷新伤害
	    call TimerStart(CreateTimer(),1,true,function FlashHuanyiDamage)
	    //冰甲的等级刷新
	    set t = CreateTrigger()
	    call TriggerRegisterUnitEvent(t,Huanyi,EVENT_UNIT_HERO_LEVEL)
	    call TriggerAddAction(t,function TSpellHuanyi2Act)
	    set t = null
	    //初始化技能状态
	    call UnitAddAbility(Huanyi,'AHH6')
	    call UnitAddAbility(Huanyi,'AHH7')
	    call UnitAddAbility(Huanyi,'AHH8')
	    call UnitAddAbility(Huanyi,'AHH9')
	    call UnitAddAbility(Huanyi,'AHHA')
	    call UnitAddAbility(Huanyi,'AHHB')
	    call UnitAddAbility(Huanyi,'AHHC')
	    call UnitAddAbility(Huanyi,'AHHD')
	    call UnitAddAbility(Huanyi,'AHHE')
	    call UnitAddAbility(Huanyi,'AHHG')
	    call UnitAddAbility(Huanyi,'AHHH')
	    call UnitAddAbility(Huanyi,'AHHI')
	    call UnitAddAbility(Huanyi,'AHHJ')
	    call UnitAddAbility(Huanyi,'AHHK')
		call SetPlayerAbilityAvailable(GetOwningPlayer(Huanyi),'AHH6',false)
		call SetPlayerAbilityAvailable(GetOwningPlayer(Huanyi),'AHH7',false)
		call SetPlayerAbilityAvailable(GetOwningPlayer(Huanyi),'AHH8',false)
		call SetPlayerAbilityAvailable(GetOwningPlayer(Huanyi),'AHH9',false)
		call SetPlayerAbilityAvailable(GetOwningPlayer(Huanyi),'AHHA',false)
		call SetPlayerAbilityAvailable(GetOwningPlayer(Huanyi),'AHHB',false)
		call SetPlayerAbilityAvailable(GetOwningPlayer(Huanyi),'AHHC',false)
		call SetPlayerAbilityAvailable(GetOwningPlayer(Huanyi),'AHHD',false)
		call SetPlayerAbilityAvailable(GetOwningPlayer(Huanyi),'AHHE',false)
		call SetPlayerAbilityAvailable(GetOwningPlayer(Huanyi),'AHHF',false)
		call SetPlayerAbilityAvailable(GetOwningPlayer(Huanyi),'AHHG',false)
		call SetPlayerAbilityAvailable(GetOwningPlayer(Huanyi),'AHHH',false)
		call SetPlayerAbilityAvailable(GetOwningPlayer(Huanyi),'AHHI',false)
		call SetPlayerAbilityAvailable(GetOwningPlayer(Huanyi),'AHHJ',false)
		call SetPlayerAbilityAvailable(GetOwningPlayer(Huanyi),'AHHK',false)
		//幻逸回魔
		call SetPlayerAbilityAvailable(GetOwningPlayer(Huanyi),'A0HX',false)
	endfunction
endlibrary
/*
    英雄星胧的技能
*/
library_once Xinglong requires SpellBase,Printer,Attr,Aura,Spin
	globals
		private trigger TSpellXinglong = null
		private trigger TSpellXinglongUpdate = null
		private trigger TSpellXinglongAttack = null
		private trigger TSpellXinglongDamage = null
		//是否已经变身
		private boolean BBianshen = false
		//伤害值
		private real XinglongDamage = 0
		//显示特效的flag
		//private boolean BEffUpdate = false
		//伤害的指示器
		private boolean BDamage = false
		//轮回加属性时间
		private integer BAttrTime = 0
		//待选光环数
		integer IChooseAura = 0
		//当前吐息数
		integer ITuxi = 0
		//龙皇轮回
		private real RLunhui = 0.
		private timer TLunhui = null
		private unit ULunhui = null
		private texttag TTLunhui = null
		private integer ILunhui = 0
		//皮肤自增值
		private integer ISpinValue = 1
	endglobals
//---------------------------------------------------------------------------------------------------
	/*
	    统计龙皇皮肤值
	*/
	function IncreaseXinglongSpin takes nothing returns nothing
		if not (GetXinglong1Spin(GetOwningPlayer(xinglong))) then
			set ISpinValue = ISpinValue + 1
			if (ModuloInteger(ISpinValue,1000) == 0) then
				call DisplayTextToPlayer(GetOwningPlayer(xinglong), 0., 0., "【|cffff00ff绯想龙域|r】完成进度"+I2S(ISpinValue)+"/30000.")
			endif
			debug if (ISpinValue >= 30000) then
				debug call SetXinglong1SpinOK(GetOwningPlayer(xinglong))
			debug endif
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    判断是不是龙
	*/
	function IsLong takes nothing returns boolean
		return GetUnitTypeId(xinglong) == 'H01I' or GetUnitTypeId(xinglong) == 'H02O'
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
		马甲的死亡触发效果
	*/
	function SimulateDeathXinglong takes unit u returns nothing
		if (GetUnitTypeId(u) == 'h01L') then
			call DamageArea(xinglong,GetUnitX(u),GetUnitY(u),600,XinglongDamage*R3(IsLong(),1.5,1)/10*GetUnitUserData(u))
 			call DestroyEffect(AddSpecialEffect("war3mapImported\\IceStomp.mdx", GetUnitX(u),GetUnitY(u) ))
		endif
		if (GetUnitTypeId(u) == 'h01J') then
			set ILunhui = ILunhui + 1
			if (ILunhui >= 10) then
				set ILunhui = 0
				call DamageAreaMirror(xinglong,GetUnitX(u),GetUnitY(u),900,XinglongDamage*2.5)
			endif
			call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Other\\Doom\\DoomDeath.mdl", GetUnitX(u),GetUnitY(u) ))
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    龙皇附体
	*/
	private function Longhuangfuti takes nothing returns nothing
		if (GetUnitTypeId(xinglong) == 'Hapm' or GetUnitTypeId(xinglong) == 'H02L') then
			if (not(BBianshen)) then
				call AddDamagePercent(GetConvertedPlayerId(GetOwningPlayer(xinglong)),0.2*(1+IJ2(xinglong,1,0)+IJ3(xinglong,1,0)))
				call AddDefensePercent(GetConvertedPlayerId(GetOwningPlayer(xinglong)),0.1*(1+IJ2(xinglong,1,0)+IJ3(xinglong,1,0)))
			endif
			set BBianshen = true
			call YDWEPolledWaitNull(0.01)
			call AddAttack(xinglong,0)
			call AddDefense(xinglong,0)
			call AddHP(xinglong,0)
		elseif(GetUnitTypeId(xinglong) == 'H01I' or GetUnitTypeId(xinglong) == 'H02O') then
			set BBianshen = false
			call AddDamagePercent(GetConvertedPlayerId(GetOwningPlayer(xinglong)),-0.2 *(1+IJ2(xinglong,1,0)+IJ3(xinglong,1,0)))
			call AddDefensePercent(GetConvertedPlayerId(GetOwningPlayer(xinglong)),-0.1*(1+IJ2(xinglong,1,0)+IJ3(xinglong,1,0)))
			call YDWEPolledWaitNull(0.01)
			call AddAttack(xinglong,0)
			call AddDefense(xinglong,0)
			call AddHP(xinglong,0)
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    龙皇吐息
	*/
	private function Longhuangtuxi2 takes boolean diyfacing,real x,real y ,real damage,integer times returns nothing
		local real facing = R3(diyfacing,GetFacingBetweenXY(GetUnitX(xinglong),GetUnitY(xinglong),x,y),GetUnitFacing(xinglong))
		local real distance = R3(diyfacing,GetDistance(GetUnitX(xinglong),GetUnitY(xinglong),x,y),1200)
		local unit u = CreateUnit(GetOwningPlayer(xinglong),'h01L',GetUnitX(xinglong),GetUnitY(xinglong),facing)
    	call SetUnitScalePercent( u, 100.00 + times * 10.00 , 100.00 + times * 10.00, 100.00 + times * 10.00 )
    	call SetUnitUserData(u,times)
    	call UnitApplyTimedLifeBJ( distance/900, 'BHwe', u)
	    call YDWETimerPatternRushSlide( u, facing , distance, distance/900, 0.05, damage / 10 * times, 180+times*20., false, true, true, "origin", "", "Abilities\\Spells\\Undead\\FrostNova\\FrostNovaTarget.mdl" )
	endfunction
	private function Longhuangtuxi takes real x, real y,integer abilityID,real rate returns nothing
		local integer times = I3((IsSecondSpellOK(xinglong) and GetUnitAbilityLevel(xinglong,'A0JO') == 1),3,1)
		local integer i = 1
		if (ITuxi >= 3) then
			return
		endif
		set ITuxi = ITuxi + 1
		if (abilityID != 0) then
	    	call PrintSpell(GetOwningPlayer(xinglong),GetAbilityName(abilityID),XinglongDamage)
		endif
		call Longhuangtuxi2(true,GetSpellTargetX(),GetSpellTargetY(),XinglongDamage*rate,10)
		if (IsSecondSpellOK(xinglong) and GetUnitAbilityLevel(xinglong,'A0JO') == 1) then
			call YDWEPolledWaitNull(0.5)
			loop
				exitwhen i > 5
				if (GetRandomInt(1,100) > I3(BJuexing3[GetConvertedPlayerId(GetOwningPlayer(xinglong))] and IsLong(),0,(i*10))) then
					call Longhuangtuxi2(false,0,0,XinglongDamage*rate*0.1*i*2,i*2)
	    			call CreateSpellTextTag(I2S(i)+"次共鸣！",xinglong,100,0,0,3)
					call YDWEPolledWaitNull(0.5)
	    		else
	    			exitwhen true
				endif
				set i = i + 1
			endloop
		endif
		set ITuxi = ITuxi - 1
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    龙皇共鸣
	*/
	private function Longhuanggongming takes nothing returns nothing
		call UnitRemoveAbility(xinglong,'A0JN')
		call UnitAddAbility(xinglong,'A0JN')
    	call PrintSpellContent(GetOwningPlayer(xinglong),GetAbilityName('A0JO'),"，刷新成功。")
		call UnitDamageTarget( xinglong, xinglong, GetUnitState(xinglong,UNIT_STATE_MAX_LIFE)*0.2, false, true, ATTACK_TYPE_CHAOS, DAMAGE_TYPE_SLOW_POISON, WEAPON_TYPE_WHOKNOWS )
		call DestroyEffect(AddSpecialEffect("war3mapImported\\longj2.mdl", GetUnitX(xinglong), GetUnitY(xinglong) ))
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    攻击被动
	*/
	private function TSpellXinglongAttackCon takes nothing returns boolean
		return GetAttacker() == xinglong
	endfunction
	private function TSpellXinglongAttackAct takes nothing returns nothing
		if (IsSecondSpellOK(xinglong) and GetUnitState(xinglong,UNIT_STATE_MANA) >= 250 and GetRandomInt(1,20) == 1 and GetUnitAbilityLevel(xinglong,'A0JO') == 1) then
			call Longhuangtuxi(GetUnitX(GetAttackedUnitBJ()),GetUnitY(GetAttackedUnitBJ()),'A0JO',0.33)
		endif
		if (IsThirdSpellOK(xinglong) and GetUnitState(xinglong,UNIT_STATE_MANA) >= 400 and GetRandomInt(1,10) == 1 and GetUnitAbilityLevel(xinglong,'A0JP') == 1) then
			call UnitDamageTarget( xinglong, GetAttackedUnitBJ(), (GetAttack(xinglong)+GetHeroStr(xinglong,false))*3* SquareRoot(I2R(GetHeroLevel(xinglong)))*R3(IsLong(),2,1), false, true, ATTACK_TYPE_MAGIC, DAMAGE_TYPE_MAGIC, WEAPON_TYPE_WHOKNOWS )
			call CreateSpellTextTag("弑",GetAttackedUnitBJ(),100,0,100,3)
			call DestroyEffect(AddSpecialEffect("Objects\\Spawnmodels\\Orc\\Orcblood\\BattrollBlood.mdl", GetUnitX(GetAttackedUnitBJ()), GetUnitY(GetAttackedUnitBJ()) ))
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    龙皇凝性的伤害被动
	*/
    private function TSpellXinglongDamageCon takes nothing returns boolean
    	return IsThirdSpellOK(xinglong) and GetEventDamage() < GetUnitState(xinglong,UNIT_STATE_MAX_LIFE) and GetUnitAbilityLevel(xinglong,'A0JP') == 1 and IsUnitInUnitBack(xinglong,GetEventDamageSource(),60) and GetEventDamage() > 0 and GetEventDamageSource() != xinglong
    endfunction
    private function TSpellXinglongDamageAct takes nothing returns nothing
		call SetUnitLifeBJ(xinglong,GetUnitState(xinglong,UNIT_STATE_LIFE)+GetEventDamage()*2)
    	if not(BDamage) then
    		set BDamage = true
    		call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Undead\\ReplenishHealth\\ReplenishHealthCasterOverhead.mdl", GetUnitX(xinglong), GetUnitY(xinglong) ))
    		call YDWEPolledWaitNull(1)
    		set BDamage = false
    	endif
    endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    龙皇轮回
	*/
	//伤害的计时器
	private function LonghuanglunhuiDamageTimer takes nothing returns nothing
		if (RLunhui >= 0.) then
			set RLunhui = RLunhui - 0.1
			call SetTextTagTextBJ(TTLunhui,R2S(RLunhui)+"s",20)
    		call SetUnitFlyHeight(CreateUnit(GetOwningPlayer(xinglong),'h01J',YDWECoordinateX(GetUnitX(ULunhui)+GetRandomReal(-900,900)), YDWECoordinateY(GetUnitY(ULunhui)+GetRandomReal(-900,900)),0), 0.00, 500.00 )
		else
			call PauseTimer(TLunhui)
			call DestroyTimer(TLunhui)
			set TLunhui = null
			call RemoveUnit(ULunhui)
			call DestroyTextTag(TTLunhui)
			set ULunhui = null
			set TTLunhui = null
		endif
	endfunction
	private function Longhuanglunhui takes nothing returns nothing
		local integer i = GetHeroLevel(xinglong)
		set RLunhui = RMaxBJ(5.0,RLunhui)
		if (TLunhui == null) then
			set TLunhui = CreateTimer()
			set ULunhui = CreateUnit(GetOwningPlayer(xinglong),'h01K',GetUnitX(xinglong),GetUnitY(xinglong),0)
			set TTLunhui = CreateTextTagUnitBJ( R2S(RLunhui)+"s", xinglong, 20, 20, 0, 0, 100, 0 )
		endif
		call SetUnitX(ULunhui,GetUnitX(xinglong))
		call SetUnitY(ULunhui,GetUnitY(xinglong))
		//call SetTextTagPos(TTLunhui,GetUnitX(ULunhui),GetUnitY(ULunhui),0)
        call PlaySoundBJ(gg_snd_xinglong_4)
		call PrintSpellName(GetOwningPlayer(xinglong),GetAbilityName('A0JQ'))
		// call UnitAddAbility(xinglong,'A0K1')
		// call UnitMakeAbilityPermanent(xinglong,true,'A0K1')
		//不断伤害
		call TimerStart(TLunhui,0.1,true,function LonghuanglunhuiDamageTimer)
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    主英雄使用技能
	*/
	private function TSpellXinglongAct takes nothing returns nothing
		if (GetSpellAbilityId() == 'A0JN') then
			//龙皇吐息
			call Longhuangtuxi(GetSpellTargetX(),GetSpellTargetY(),'A0JN',1)
		elseif (GetSpellAbilityId() == 'A0JO') then
			//龙皇共鸣
			call Longhuanggongming()
		elseif (GetSpellAbilityId() == 'A0JQ') then
			//龙皇轮回
			call Longhuanglunhui()
		elseif (GetSpellAbilityId() == 'AEme' or GetSpellAbilityId() == 'A0NG') then
			//龙皇附体
			call Longhuangfuti()
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    星胧升级后
	*/
	private function TSpellXinglongUpdateAct takes nothing returns nothing
		call IncreaseXinglongSpin()
		if (IsFourthSpellOK(xinglong) and GetUnitAbilityLevel(xinglong,'A0JQ') == 1 and GetUnitLevel(xinglong) >= 101) then
			//龙皇轮回，伤害并眩晕，还有特效
		    call SetHeroLevelBJ( xinglong, 1, false )
		    call UnitAddAbility(xinglong,'A0JN')
		    call UnitAddAbility(xinglong,'A0JO')
		    call UnitAddAbility(xinglong,'A0JP')
		    call UnitAddAbility(xinglong,'A0JQ')
		    call UnitAddAbility(xinglong,'A0JR')
	    	call CreateUnitEffect(GetOwningPlayer(xinglong),'h01M',GetUnitX(xinglong),GetUnitY(xinglong),0)
			//call CreateEffect2(GetUnitX(xinglong), GetUnitY(xinglong))
	    	//call PrintSpell(GetOwningPlayer(xinglong),GetAbilityName('A0JQ'),XinglongDamage*10)
	    	//call PolledWait(1)
			//call DamageArea(xinglong,GetUnitX(xinglong), GetUnitY(xinglong),1800,XinglongDamage *3)
	    	return
		endif
		//if (IsSecondSpellOK(xinglong) and GetUnitAbilityLevel(xinglong,'A0JO') == 1 and not(BEffUpdate)) then
		//	call DamageArea(xinglong,GetUnitX(xinglong), GetUnitY(xinglong),1800,XinglongDamage * 0.5)
		//	call CreateEffect1(GetUnitX(xinglong), GetUnitY(xinglong))
		//	set BEffUpdate = true
		//	call PolledWait(2)
		//	set BEffUpdate = false
		//endif
		set RLunhui = RMinBJ(30.,RLunhui + 1.0)
    	call SetUnitLifePercentBJ(xinglong,100)
    	call SetUnitManaBJ(xinglong,GetUnitState(xinglong,UNIT_STATE_MANA)+200)
    	call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Orc\\HealingWave\\HealingWaveTarget.mdl", GetUnitX(xinglong), GetUnitY(xinglong) ))
    	//if (IsFourthSpellOK(xinglong) and GetUnitAbilityLevel(xinglong,'A0JQ') == 1) then
    	//	set BAttrTime = BAttrTime + 2
//
    	//	if (GetUnitAbilityLevel(xinglong,'A0K2') != 1) then
    	//		call UnitAddAbility(xinglong,'A0K2')
    	//		call UnitMakeAbilityPermanent(xinglong,true,'A0K2')
		//		call AddIntPercentImme(GetConvertedPlayerId(GetOwningPlayer(xinglong)),0.3)
		//		call AddAgiPercentImme(GetConvertedPlayerId(GetOwningPlayer(xinglong)),0.3)
		//		call AddStrPercentImme(GetConvertedPlayerId(GetOwningPlayer(xinglong)),0.3)
    	//	endif
    	//endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    刷新伤害值，及判断形态扣血
	*/
	private function FlashXinglongDamage takes nothing returns nothing
		set XinglongDamage = GetDamageStr(xinglong)
		if (IsLong() and IsUnitAliveBJ(xinglong)) then
			call DestroyEffect(AddSpecialEffect("Objects\\Spawnmodels\\Orc\\Orcblood\\BattrollBlood.mdl", GetUnitX(xinglong), GetUnitY(xinglong) ))
			call UnitDamageTarget( xinglong, xinglong, GetUnitState(xinglong,UNIT_STATE_MAX_LIFE)*0.1, false, true, ATTACK_TYPE_CHAOS, DAMAGE_TYPE_SLOW_POISON, WEAPON_TYPE_WHOKNOWS )
		endif
    	// if (IsFourthSpellOK(xinglong) and GetUnitAbilityLevel(xinglong,'A0JQ') == 1 and BAttrTime != 0) then
    	// 	set BAttrTime = BAttrTime - 1
    	// 	if (BAttrTime == 0) then
    	// 		call UnitRemoveAbility(xinglong,'A0K2')
		// 		call AddIntPercentImme(GetConvertedPlayerId(GetOwningPlayer(xinglong)),-0.3)
		// 		call AddAgiPercentImme(GetConvertedPlayerId(GetOwningPlayer(xinglong)),-0.3)
		// 		call AddStrPercentImme(GetConvertedPlayerId(GetOwningPlayer(xinglong)),-0.3)
    	// 	endif
    	// endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    选择光环后
	*/
	function ChooseAura takes unit u returns nothing
		call InitSpecifyAura(u)
		if (GetHeroIndex(GetUnitTypeId(u)) == 1) then
			call UnitRemoveAbility(u,'AOre')
		endif
		call KillUnit(u)
		call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Human\\Thunderclap\\ThunderClapCaster.mdl", GetUnitX(u), GetUnitY(u) ))
		set IChooseAura = IChooseAura - 1
		if (IChooseAura == 0) then
    		call SetCameraBoundsToRectForPlayerBJ( GetOwningPlayer(xinglong), GetPlayableMapRect() )
	    	call PanCameraToTimedForPlayer( GetOwningPlayer(xinglong), GetUnitX(xinglong),GetUnitY(xinglong), 0.20 )
	    	set udg_T1[GetConvertedPlayerId(GetOwningPlayer(xinglong))] = true
	    else
	    	call DisplayTextToPlayer(GetOwningPlayer(xinglong), 0., 0., "|cFFFF66CC【消息】|r请双击选择你需要的"+I2S(IChooseAura)+"个英雄光环.")
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	     初始化选光环
	*/
	function InitChooseAura takes nothing returns nothing
		local dialog d = DialogCreate()
        local string s = "
        	请双击英雄选择你需要的"+I2S(IChooseAura)+"个英雄光环."
        call DialogSetMessage( d, s )
        call DialogAddButton( d, "确定|cffff6800(Esc)|r",512)
        call DialogDisplay( GetOwningPlayer(xinglong), d, true )
        set d = null
	    call PanCameraToTimedForPlayer( GetOwningPlayer(xinglong), GetRectCenterX(gg_rct_______c1),GetRectCenterY(gg_rct_______c1), 0.20 )
	    call SetCameraBoundsToRectForPlayerBJ( GetOwningPlayer(xinglong), gg_rct_______c1 )
	    call DisplayTextToPlayer(GetOwningPlayer(xinglong), 0., 0., "|cFFFF66CC【消息】|r请双击选择你需要的"+I2S(IChooseAura)+"个英雄光环.")
	    set udg_T1[GetConvertedPlayerId(GetOwningPlayer(xinglong))] = false
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    复活后如果是龙化就取消属性加成
	*/
	function AfterReviveXinglong takes unit u returns nothing
		if (u == xinglong and BBianshen) then
			set BBianshen = false
			call AddDamagePercent(GetConvertedPlayerId(GetOwningPlayer(xinglong)),-0.2*(1+IJ2(xinglong,1,0)+IJ3(xinglong,1,0)))
			call AddDefensePercent(GetConvertedPlayerId(GetOwningPlayer(xinglong)),-0.1*(1+IJ2(xinglong,1,0)+IJ3(xinglong,1,0)))
			call YDWEPolledWaitNull(0.01)
			call AddAttack(xinglong,0)
			call AddDefense(xinglong,0)
			call AddHP(xinglong,0)
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    英雄学习技能
	*/
	//按照12345来判断
	function LearnSkillXinglongI takes unit learner,integer whichSpell returns nothing
		local integer i
		if (learner == xinglong) then
			if (whichSpell == 3 and IsThirdSpellOK(xinglong) and GetUnitAbilityLevel(xinglong,'A0JP') == 1) then
				set IChooseAura = IChooseAura + 1
				call InitChooseAura()
			elseif (whichSpell == 5 and IsFifthSpellOK(xinglong) and GetUnitAbilityLevel(xinglong,'A0JR') == 1) then
				set IChooseAura = IChooseAura + 3
				call InitChooseAura()
			endif
		endif
	endfunction
	function LearnSkillXinglong takes unit learner,integer learnSpellID returns nothing
		if (learner == xinglong) then
			if (learnSpellID == 'A0JN') then
				call LearnSkillXinglongI(learner,1)
			elseif (learnSpellID == 'A0JO') then
				call LearnSkillXinglongI(learner,2)
			elseif (learnSpellID == 'A0JP') then
				call LearnSkillXinglongI(learner,3)
			elseif (learnSpellID == 'A0JQ') then
				call LearnSkillXinglongI(learner,4)
			elseif (learnSpellID == 'A0JR') then
				call LearnSkillXinglongI(learner,5)
			endif
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    星胧皮肤
	*/
	private function InitXinglongSpin takes unit u returns unit
		if (IsXinglongSpin1(GetOwningPlayer(u))) then
			set udg_H[GetConvertedPlayerId(GetOwningPlayer(u))] = CreateUnit(GetOwningPlayer(u),'H02L',GetUnitX(u),GetUnitY(u),0)
			call UnitAddItemByIdSwapped('I006', udg_H[GetConvertedPlayerId(GetOwningPlayer(u))])
			set BSpinXinglong = true
	    	set udg_I_Jingyan[GetConvertedPlayerId(GetOwningPlayer(u))] = udg_I_Jingyan[GetConvertedPlayerId(GetOwningPlayer(u))] + 0.5
			call SetUnitManaPercentBJ(udg_H[GetConvertedPlayerId(GetOwningPlayer(u))],1000)
			call RemoveUnit(u)
			return udg_H[GetConvertedPlayerId(GetOwningPlayer(u))]
		else
			return u
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    初始化英雄
	*/
	function InitXinglong takes unit u returns nothing
		set xinglong = InitXinglongSpin(u)
		set TSpellXinglong = CreateTrigger()
	    call TriggerRegisterUnitEvent(TSpellXinglong,xinglong,EVENT_UNIT_SPELL_EFFECT)
	    call TriggerAddAction(TSpellXinglong, function TSpellXinglongAct)
	    set udg_I_Jingyan[GetConvertedPlayerId(GetOwningPlayer(xinglong))] = udg_I_Jingyan[GetConvertedPlayerId(GetOwningPlayer(xinglong))] + 5.
	    //刷新伤害,还有每秒判断形态是否扣血,还有加属性的判断
	    call TimerStart(CreateTimer(),1,true,function FlashXinglongDamage)
	    //升级回血及造成伤害
	    set TSpellXinglongUpdate = CreateTrigger()
	    call TriggerRegisterUnitEvent( TSpellXinglongUpdate, xinglong, EVENT_UNIT_HERO_LEVEL )
	    call TriggerAddAction(TSpellXinglongUpdate, function TSpellXinglongUpdateAct)
	    //攻击触发事件，星胧
	    set TSpellXinglongAttack = CreateTrigger()
	    call TriggerRegisterAnyUnitEventBJ( TSpellXinglongAttack, EVENT_PLAYER_UNIT_ATTACKED )
	    call TriggerAddCondition(TSpellXinglongAttack, Condition(function TSpellXinglongAttackCon))
	    call TriggerAddAction(TSpellXinglongAttack, function TSpellXinglongAttackAct)
	    //伤害免疫事件
	    set TSpellXinglongDamage = CreateTrigger()
	    call TriggerRegisterUnitEvent( TSpellXinglongDamage, xinglong, EVENT_UNIT_DAMAGED )
	    call TriggerAddCondition(TSpellXinglongDamage, Condition(function TSpellXinglongDamageCon))
	    call TriggerAddAction(TSpellXinglongDamage, function TSpellXinglongDamageAct)
	endfunction
endlibrary
/*
    英雄离魑的技能
*/
library_once Lichi requires SpellBase,Printer,Attr,Aura,Spin
	globals
		private trigger TSpellLichi = null
		private trigger TSpellLichiDamage = null
		private trigger TAttackLichi = null
		//伤害值
		private real LichiDamage = 0
		//记录点
		private real NiLiX = 0.
		private real NiLiY = 0.
		//幻影
		integer IMaxHuanying = 0
		private unit array UHuan
		//幻影攻击目标
		private boolean BHuanAttack = false
		//0是静止,1是移动,2是攻击
		private integer ILichiDoing = 0
		//统计值
		private integer IHuanyingCount = 0
		//第二个技能的冷却期
		private boolean BTongyun = false
		//湮魂印连结效果
		private Connect array CYanhun
		integer Iyanhun = 0
		unit Uyanhun = null
		//神月缺的单位组
		private integer IShenyue = 0
		private group array GShenyue
		private boolean BShenyue = false
		//囚天地
		private trigger TSpellLichi51 = null
		private trigger TSpellLichi52 = null
		private integer IQiutian = 0
		//皮肤统计
		private integer ISpinLichi = 0
	endglobals
//---------------------------------------------------------------------------------------------------
	/*
	    皮肤统计
	*/
	private function SpinTongji takes nothing returns nothing
		if not (GetLichi1Spin(GetOwningPlayer(lichi))) then
			set ISpinLichi = ISpinLichi + 1
			if (ModuloInteger(ISpinLichi,10) == 0) then
				call DisplayTextToPlayer(GetOwningPlayer(lichi), 0., 0., "【|cffff6800谜幻逸空|r】完成进度"+I2S(ISpinLichi)+"/100.")
			endif
			debug if (ISpinLichi >= 100) then
				debug call SetLichiSpinOK(GetOwningPlayer(lichi))
			debug endif
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    判断单位是否是离魑皮肤
	*/
	function IsLichiSpin takes nothing returns boolean
		return GetUnitTypeId(lichi) == 'H02E'
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
		马甲的死亡触发效果
	*/
	function SimulateDeathLichi takes unit u returns nothing
		if (GetUnitTypeId(u) == 'h02A') then
			call DamageArea(lichi,GetUnitX(u),GetUnitY(u),350,LichiDamage * 0.25)
 			call DestroyEffect(AddSpecialEffect("Objects\\Spawnmodels\\Undead\\UndeadDissipate\\UndeadDissipate.mdl", GetUnitX(u),GetUnitY(u) ))
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    伤害
	*/
	function SimulateDamageLichi takes unit u returns boolean
		//幻影
		if (GetUnitTypeId(u) == 'h028' or GetUnitTypeId(u) == 'h02F') then
			call UnitDamageTarget( lichi, GetTriggerUnit(), LichiDamage * 0.05 * IJ3(lichi,2,1) , false, true, ATTACK_TYPE_MAGIC, DAMAGE_TYPE_MAGIC, WEAPON_TYPE_WHOKNOWS )
			return true
		endif
		if (GetUnitTypeId(u) == 'h02A') then
			call UnitDamageTarget( lichi, GetTriggerUnit(), LichiDamage * 0.01 , false, true, ATTACK_TYPE_MAGIC, DAMAGE_TYPE_MAGIC, WEAPON_TYPE_WHOKNOWS )
			return true
		endif
		return false
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    获取某个幻影对应的位置，下面的话是负数形式
	*/
	private function GetHuanyingIndex takes integer id returns integer
		if (ModuloInteger(id,2) == 1) then
			// 奇数
			return (id/2)+1
		else
			return -1 * (id/2)
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    获取幻影的数量
	*/
	private function GetHuanyingCount takes nothing returns integer
		local integer i = 1
		local integer result = 0
		loop
			exitwhen i > IMaxHuanying
			if (UHuan[i] != null) then
				set result = result + 1
			endif
			set i = i +1
		endloop
		return result
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    创建一个分身
	*/
	function CreateHuanying takes nothing returns nothing
		local integer i = 1
		local integer index = 0
		loop
			exitwhen i > IMaxHuanying
			if (UHuan[i] == null) then
				set index = GetHuanyingIndex(i)
				set UHuan[i] = CreateUnit(GetOwningPlayer(lichi),I3(IsLichiSpin(),'h02F','h028'),GetUnitX(lichi) + IAbsBJ(index) * 150 * CosBJ(GetUnitFacing(lichi)+R3(index > 0,90.,-90.)),GetUnitY(lichi) + IAbsBJ(index) * 150 * SinBJ(GetUnitFacing(lichi)+R3(index > 0,90.,-90.)),GetUnitFacing(lichi))
				call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Undead\\RaiseSkeletonWarrior\\RaiseSkeleton.mdl", GetUnitX(UHuan[i]),GetUnitY(UHuan[i]) ))
        		call UnitAddType( UHuan[i], UNIT_TYPE_PEON )
    			call SetUnitAcquireRange( UHuan[i], 1.00 )
        		call IssueTargetOrder(UHuan[i],"attack",lichi)
				return
			endif
			set i = i +1
		endloop
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    杀怪统计创造分身
	*/
	function KillCountHuanying takes integer i returns nothing
		if (BTianfu) then
			return
		endif
		set IHuanyingCount = IHuanyingCount + i
		if (IHuanyingCount >= 200) then
			call CreateHuanying()
			set IHuanyingCount = 0
		elseif (ModuloInteger(IHuanyingCount,50) == 0) then
    		call CreateTextTagA("影:"+I2S(IHuanyingCount),lichi,0,100,100,3,12)
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    一样的步调
	*/
	private function JudgeLichiMove takes nothing returns nothing
		local integer i
		local integer index
    	if (NiLiX != GetUnitX(lichi) or NiLiY != GetUnitY(lichi)) then
    		set NiLiX = GetUnitX(lichi)
    		set NiLiY = GetUnitY(lichi)
    		set i = 1
    		loop
    			exitwhen i > IMaxHuanying
				set index = GetHuanyingIndex(i)
    			call SetUnitX(UHuan[i],GetUnitX(lichi) + IAbsBJ(index) * 150 * CosBJ(GetUnitFacing(lichi)+R3(index > 0,90.,-90.)))
    			call SetUnitY(UHuan[i],GetUnitY(lichi) + IAbsBJ(index) * 150 * SinBJ(GetUnitFacing(lichi)+R3(index > 0,90.,-90.)))
    			call SetUnitFacing(UHuan[i],GetUnitFacing(lichi))
    			set i = i +1
    		endloop
    		//移动
    		if (ILichiDoing != 1) then
    			set ILichiDoing = 1
    			set i = 1
    			loop
    				exitwhen i > IMaxHuanying
        			call IssueImmediateOrder(UHuan[i],"stop")
	    			call SetUnitAnimationByIndex( UHuan[i], 2 )
    				set i = i +1
    			endloop
    		endif
    	else
    		//静止
    		if (ILichiDoing == 1) then
    			set ILichiDoing = 0
    			call SetUnitAnimationByIndex( lichi, 1 )
    			set i = 1
    			loop
    				exitwhen i > IMaxHuanying
	    			call SetUnitAnimationByIndex( UHuan[i], 1 )
        			call IssueImmediateOrder(UHuan[i],"stop")
    				set i = i +1
    			endloop
    		endif
    	endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    殉-影炎绝
	*/
	//神月盈爆炸
	private function ShenyueyingBoom takes nothing returns nothing
		local integer i = 1
		local real x = GetUnitX(lichi)
		local real y = GetUnitY(lichi)
		local real damage = LichiDamage * 5
		call DestroyEffect(AddSpecialEffect("war3mapImported\\DarkNova.mdx", x, y ))
		loop
			exitwhen i > 6
			call DestroyEffect(AddSpecialEffect("war3mapImported\\DarkNova.mdx", YDWECoordinateX(x + 900 * CosBJ(i*60)), YDWECoordinateY(y + 900 * SinBJ(i*60)) ))
			set i = i +1
		endloop
	    call PrintSpell(GetOwningPlayer(lichi),GetAbilityName('A0MP'),damage)
		call DamageArea(lichi,x,y,1800,damage)
		call SpinTongji()
	endfunction
	//神月盈判断
	private function ShenyueyingJudge takes nothing returns nothing
		if not(BShenyue) then
			if (IsUnitInGroup(GetEnumUnit(),GShenyue[1]) and IsUnitInGroup(GetEnumUnit(),GShenyue[2]) and IsUnitInGroup(GetEnumUnit(),GShenyue[3]) and IsUnitInGroup(GetEnumUnit(),GShenyue[4])) then
				set BShenyue = true
			endif
		endif
	endfunction
	//伤害并进行统计
	private function ShenyueyingCount takes real x,real y,real damage returns nothing
        local group l_group = CreateGroup()
        local unit l_unit
        set IShenyue = I3(IShenyue >= 4,1,IShenyue + 1)
        call GroupClear(GShenyue[IShenyue])
        call GroupEnumUnitsInRange(l_group, x, y, 350 + RJ3(lichi,50,0), null)
        loop
            set l_unit = FirstOfGroup(l_group)
            exitwhen l_unit == null
            call GroupRemoveUnit(l_group, l_unit)
            if (IsEnemy(l_unit,lichi)) then
                call UnitDamageTarget( lichi, l_unit, damage, false, true, ATTACK_TYPE_MAGIC, DAMAGE_TYPE_MAGIC, WEAPON_TYPE_WHOKNOWS )
                call GroupAddUnit(GShenyue[IShenyue],l_unit)
            endif
        endloop
        call DestroyGroup(l_group)
        set l_group = null
        set l_unit =null
        call ForGroup(GShenyue[IShenyue],function ShenyueyingJudge)
        //如果有就爆炸
        if (BShenyue) then
        	call ShenyueyingBoom()
        endif
        set BShenyue = false
	endfunction
	private function Yingyanjue takes integer abilityID,real x,real y returns nothing
		local real damage = LichiDamage
		local integer i = 1
		local integer index = 0
		local real nx = 0.
		local real ny = 0.
	    call PrintSpell(GetOwningPlayer(lichi),GetAbilityName(abilityID),damage)
	    call DestroyEffect(AddSpecialEffect("war3mapImported\\lichi1.mdx", x, y ))
	    if (IsFourthSpellOK(lichi) and GetUnitAbilityLevel(lichi,'A0MP') == 1 and abilityID != 'A0MN') then
	    	call ShenyueyingCount(x,y,damage)
	    else
			call DamageArea(lichi,x,y,350 + RJ3(lichi,50,0) + R3(IsLichiSpin(),25,0),damage)
	    endif
		loop
			exitwhen i > IMaxHuanying
			if (UHuan[i] != null) then
				set index = GetHuanyingIndex(i)
				set nx = x + IAbsBJ(index) * 150 * CosBJ(GetUnitFacing(lichi)+R3(index > 0,90.,-90.))
				set ny = y + IAbsBJ(index) * 150 * SinBJ(GetUnitFacing(lichi)+R3(index > 0,90.,-90.))
				call DamageArea(lichi,nx,ny,350 + RJ3(lichi,50,0) + R3(IsLichiSpin(),25,0),damage)
	    		call DestroyEffect(AddSpecialEffect("war3mapImported\\lichi1.mdx", nx,ny ))
    		    call SetUnitAnimation( UHuan[i], "Spell Throw" )
			endif
			set i = i +1
		endloop
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    攻击与被攻击事件
	*/
   	private function TAttackLichiCon takes nothing returns boolean
    	return GetAttacker() == lichi or GetAttackedUnitBJ() == lichi
    endfunction
    private function TAttackLichiAct takes nothing returns nothing
    	local integer i
    	if (GetAttacker() == lichi) then
    		//英雄攻击,命令幻影攻击
    		if not(BHuanAttack) then
    			set BHuanAttack = true
    			set i = 1
    			loop
    				exitwhen i > IMaxHuanying
					if (UHuan[i] != null) then
        				call IssueTargetOrder( UHuan[i], "attack", GetAttackedUnitBJ() )
					endif
    				set i = i +1
    			endloop
    			call YDWEPolledWaitNull(0.6)
    			set BHuanAttack = false
    		endif
    	else
    		//英雄被攻击，放第二个技能
    		if (not(BTongyun) and IsSecondSpellOK(lichi) and GetUnitAbilityLevel(lichi,'A0MN') == 1 and GetUnitState(lichi,UNIT_STATE_MANA) > 200 and GetRandomInt(1,20) == 1) then
    			set BTongyun = true
    			call Yingyanjue('A0MN',GetUnitX(GetAttacker()),GetUnitY(GetAttacker()))
    			call YDWEPolledWaitNull(10)
    			set BTongyun = false
    		endif
    	endif
    endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    替死
	*/
    private function TSpellLichiDamageCon takes nothing returns boolean
    	return GetEventDamage() > GetUnitState(lichi,UNIT_STATE_LIFE) and not(BTianfu)
    endfunction
    private function TSpellLichiDamageAct takes nothing returns nothing
    	local integer i = 1
    	loop
    		exitwhen i > IMaxHuanying
    		if (UHuan[i] != null) then
    			call KillUnit(UHuan[i])
				call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Human\\Resurrect\\ResurrectCaster.mdl", GetUnitX(UHuan[i]), GetUnitY(UHuan[i]) ))
    			set UHuan[i] = null
				call ImmuteDamageInterval(lichi,1)
				call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Human\\Resurrect\\ResurrectCaster.mdl", GetUnitX(lichi), GetUnitY(lichi) ))
				call SetUnitLifePercentBJ(lichi,100)
				call PrintSpellContent(GetOwningPlayer(lichi),GetAbilityName('A0MH'),"续命.")
			    call PlaySoundBJ( gg_snd_Baodiao )
    			return
    		endif
    		set i = i +1
    	endloop
    endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    湮魂印
	*/
	//清除湮魂印的遗留物
	private function ClearYanhun takes nothing returns nothing
		local integer i = 0
		set Iyanhun = 0
		set Uyanhun = null
		loop
			exitwhen i > IMaxHuanying
			if (CYanhun[i] != 0 and UHuan[i] != null) then
				call CYanhun[i].destroy()
				set CYanhun[i] = 0
			endif
			set i = i +1
		endloop
	endfunction
	private function YanhunyinTimer takes nothing returns nothing
		local timer t = GetExpiredTimer()
		local integer count = GetHuanyingCount()
		if (IsUnitAliveBJ(Uyanhun) and IsUnitAliveBJ(lichi) and GetUnitDistance(Uyanhun,lichi) < 2000) then
			call UnitDamageTarget( lichi, Uyanhun, GetUnitState(lichi,UNIT_STATE_MAX_LIFE)*0.1*count, false, true, ATTACK_TYPE_CHAOS, DAMAGE_TYPE_SLOW_POISON, WEAPON_TYPE_WHOKNOWS )
			call SetUnitLifeBJ(lichi,GetUnitState(lichi,UNIT_STATE_LIFE) + GetUnitState(lichi,UNIT_STATE_MAX_LIFE) * 0.1 * count)
			call SetUnitManaBJ(Uyanhun,GetUnitState(Uyanhun,UNIT_STATE_MANA) - 5 *count)
			call SetUnitManaBJ(lichi,GetUnitState(lichi,UNIT_STATE_MANA) + 5 * count)
		else
			call PauseTimer(t)
			call DestroyTimer(t)
			call ClearYanhun()
		endif
		set t = null
	endfunction
	private function Yanhunyin takes unit u returns nothing
		local integer i = 1
		local timer t = CreateTimer()
		call ClearYanhun()
		set Iyanhun = 1
		loop
			exitwhen i > IMaxHuanying
     		if (UHuan[i] != null) then
				set CYanhun[i] = Connect.create(UHuan[i],u,"LEAS")
				call CYanhun[i].setDieVanish()
				set Iyanhun = Iyanhun + 1
    		endif
			set i = i + 1
		endloop
		set CYanhun[0] = Connect.create(lichi,u,"LEAS")
		call CYanhun[0].setDieVanish()
		set Uyanhun = u
		call TimerStart(t,1,true,function YanhunyinTimer)
		set t = null
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    神月盈
	*/
	private function ShenyueyingTimer takes nothing returns nothing
		local timer t = GetExpiredTimer()
		local integer i = 1
		if not(BJuexing1[GetConvertedPlayerId(GetOwningPlayer(lichi))]) then
	    	call UnitRemoveAbility(lichi,'A0B9')
	    	loop
	    		exitwhen i > IMaxHuanying
	    		if (UHuan[i] != null) then
	    			call UnitRemoveAbility(UHuan[i],'A0B9')
	    		endif
	    		set i = i +1
	    	endloop
		endif
		call CreateSpellTextTag("神月盈时间到！",lichi,0,50,100,3)
		call PauseTimer(t)
		call DestroyTimer(t)
		set t = null
	endfunction
	private function Shenyueying takes nothing returns nothing
		local integer i = 1
		call DestroyEffect( AddSpecialEffect("Abilities\\Spells\\Human\\Avatar\\AvatarCaster.mdl", GetUnitX(lichi),GetUnitY(lichi)) )
	    call UnitAddAbility(lichi,'A0B9')
		loop
			exitwhen i > IMaxHuanying
     		if (UHuan[i] != null) then
				call DestroyEffect( AddSpecialEffect("Abilities\\Spells\\Human\\Avatar\\AvatarCaster.mdl", GetUnitX(UHuan[i]),GetUnitY(UHuan[i])) )
	    		call UnitAddAbility(UHuan[i],'A0B9')
    		    call SetUnitAnimation( UHuan[i], "Spell Throw" )
    		endif
			set i = i +1
		endloop
		call TimerStart(CreateTimer(),20,false,function ShenyueyingTimer)
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    囚天地
	*/
	private function QiutiandiSmart takes real x,real y returns nothing
		local unit u = null
		if (GetDistance(GetUnitX(lichi),GetUnitY(lichi),x,y) > 1200) then
			return
		endif
		set u = CreateUnit(GetOwningPlayer(lichi),'h02A',x,y,0)
		set IQiutian = IQiutian + 1
		if (IQiutian >= 30) then
			set IQiutian = 0
			call SetUnitLifePercentBJ(lichi,100)
			call ImmuteDamageInterval(lichi,2)
			call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Human\\Resurrect\\ResurrectCaster.mdl", x,y ))
		endif
		call UnitApplyTimedLifeBJ( 3, 'BHwe',u )
        call IssuePointOrder(lichi,"move",GetUnitX(lichi),GetUnitY(lichi))
		set u = null
	endfunction
	private function Qiutiandi takes nothing returns nothing
		local real time = GetUnitState(lichi,UNIT_STATE_MANA) * 0.01 * 0.5
		local unit u = CreateUnit(GetOwningPlayer(lichi),'h029',GetUnitX(lichi),GetUnitY(lichi),0)
	    local Attract attract = Attract.create(u,1200,0.05,20)
	    call attract.start()
		call UnitApplyTimedLifeBJ( time, 'BHwe',u )
		call PlaySoundBJ( gg_snd_lichidazhao )
	    call EnableTrigger(TSpellLichi51)
	    call EnableTrigger(TSpellLichi52)
	    call PrintSpellContent(GetOwningPlayer(lichi),GetAbilityName(GetSpellAbilityId()),"持续"+I2S(R2I(time))+"s.")
	    call SetUnitManaPercentBJ(lichi,0)
	    call YDWEPolledWaitNull(time)
	    call DisableTrigger(TSpellLichi51)
	    call DisableTrigger(TSpellLichi52)
	    call PrintSpellContent(GetOwningPlayer(lichi),GetAbilityName('A0MQ'),",施法结束.")
	    set u = null
	endfunction
	private function TSpellLichi5Con takes nothing returns boolean
	    return ((GetIssuedOrderIdBJ() == String2OrderIdBJ("smart")))
	endfunction
	private function TSpellLichi51Act takes nothing returns nothing
	    call QiutiandiSmart(GetUnitX(GetOrderTargetUnit()),GetUnitY(GetOrderTargetUnit()))
	endfunction
	private function TSpellLichi52Act takes nothing returns nothing
	    call QiutiandiSmart(GetOrderPointX(),GetOrderPointY())
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    主英雄使用技能
	*/
	private function TSpellLichiAct takes nothing returns nothing
		if (GetSpellAbilityId() == 'A0MJ') then
			call Yingyanjue(GetSpellAbilityId(),GetUnitX(lichi) + 250 * CosBJ(GetUnitFacing(lichi)),GetUnitY(lichi) + 250 * SinBJ(GetUnitFacing(lichi)))
		elseif (GetSpellAbilityId() == 'A0MK') then
			call Yingyanjue(GetSpellAbilityId(),GetUnitX(lichi) + 500 * CosBJ(GetUnitFacing(lichi)),GetUnitY(lichi) + 500 * SinBJ(GetUnitFacing(lichi)))
		elseif (GetSpellAbilityId() == 'A0ML') then
			call Yingyanjue(GetSpellAbilityId(),GetUnitX(lichi) + 750 * CosBJ(GetUnitFacing(lichi)),GetUnitY(lichi) + 750 * SinBJ(GetUnitFacing(lichi)))
		elseif (GetSpellAbilityId() == 'A0MM') then
			call Yingyanjue(GetSpellAbilityId(),GetUnitX(lichi) + 1000 * CosBJ(GetUnitFacing(lichi)),GetUnitY(lichi) + 1000 * SinBJ(GetUnitFacing(lichi)))
		elseif (GetSpellAbilityId() == 'A0MO') then
			//湮魂印
			call Yanhunyin(GetSpellTargetUnit())
		elseif (GetSpellAbilityId() == 'A0MP') then
			//神月盈
			call Shenyueying()
		elseif (GetSpellAbilityId() == 'A0MQ') then
			//囚天地
			call Qiutiandi()
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    刷新伤害值
	*/
	private function FlashLichiDamage takes nothing returns nothing
		set LichiDamage = GetDamageInt(lichi)
		if (IsSecondSpellOK(lichi) and GetUnitAbilityLevel(lichi,'A0MN') == 1) then
			if (GetUnitLifePercent(lichi) < 98) then
				call SetUnitLifeBJ(lichi,(GetUnitState(lichi,UNIT_STATE_LIFE)/6) * 5 + GetUnitState(lichi,UNIT_STATE_MAX_LIFE) / 6)
		    	call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Items\\AIma\\AImaTarget.mdl", GetUnitX(lichi), GetUnitY(lichi) ))
			endif
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    英雄学习技能
	*/
	//按照12345来判断
	function LearnSkillLichiI takes unit learner,integer whichSpell returns nothing
		local integer i
		if (learner == lichi) then
			if (whichSpell == 3 and IsThirdSpellOK(lichi) and GetUnitAbilityLevel(lichi,'A0MO') == 1) then
				call InitLichiAura()
				call AddSpecialEffectTargetUnitBJ("origin",lichi,"war3mapImported\\yanbao.mdx")
			endif
		endif
	endfunction
	function LearnSkillLichi takes unit learner,integer learnSpellID returns nothing
		if (learner == lichi) then
			if (learnSpellID == 'A0MI') then
				call LearnSkillLichiI(learner,1)
			elseif (learnSpellID == 'A0MN') then
				call LearnSkillLichiI(learner,2)
			elseif (learnSpellID == 'A0MO') then
				call LearnSkillLichiI(learner,3)
			elseif (learnSpellID == 'A0MP') then
				call LearnSkillLichiI(learner,4)
			elseif (learnSpellID == 'A0MQ') then
				call LearnSkillLichiI(learner,5)
			endif
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    离魑皮肤
	*/
	private function InitLichiSpin takes unit u returns unit
		if (IsLichiSpin1(GetOwningPlayer(u))) then
			set udg_H[GetConvertedPlayerId(GetOwningPlayer(u))] = CreateUnit(GetOwningPlayer(u),'H02E',GetUnitX(u),GetUnitY(u),0)
			call UnitAddItemByIdSwapped('I006', udg_H[GetConvertedPlayerId(GetOwningPlayer(u))])
			call SetUnitManaPercentBJ(udg_H[GetConvertedPlayerId(GetOwningPlayer(u))],100)
			call RemoveUnit(u)
			return udg_H[GetConvertedPlayerId(GetOwningPlayer(u))]
		else
			return u
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    初始化英雄
	*/
	function InitLichi takes unit u returns nothing
		local integer i = 1
		loop
			exitwhen i > 4
			set GShenyue[i] = CreateGroup()
			set i = i +1
		endloop
		set lichi = InitLichiSpin(u)
		set UHuan[0] = lichi
		//上限是4
		set IMaxHuanying = 4
		//施法总事件
		set TSpellLichi = CreateTrigger()
	    call TriggerRegisterUnitEvent(TSpellLichi,lichi,EVENT_UNIT_SPELL_EFFECT)
	    call TriggerAddAction(TSpellLichi, function TSpellLichiAct)
	    //初始加成
	    call AddAttackPercent(GetConvertedPlayerId(GetOwningPlayer(lichi)),5.)
	    call AddIntPercent(GetConvertedPlayerId(GetOwningPlayer(lichi)),0.5)
	    //刷新伤害,还有每秒判断形态是否扣血,还有加属性的判断
	    call TimerStart(CreateTimer(),1,true,function FlashLichiDamage)
	    call UnitRemoveAbility(lichi,'A0B9')
	    //一致的步调动作与位置
	    call TimerStart(CreateTimer(),0.05,true,function JudgeLichiMove)
	    //call TimerStart(CreateTimer(),0.055,true,function JudgeLichiPos)
	    //攻击与被攻击事件
		set TAttackLichi = CreateTrigger()
	    call TriggerRegisterAnyUnitEventBJ(TAttackLichi,EVENT_PLAYER_UNIT_ATTACKED)
	    call TriggerAddCondition(TAttackLichi, Condition(function TAttackLichiCon))
	    call TriggerAddAction(TAttackLichi, function TAttackLichiAct)
	    //伤害免疫事件
	    set TSpellLichiDamage = CreateTrigger()
	    call TriggerRegisterUnitEvent( TSpellLichiDamage, lichi, EVENT_UNIT_DAMAGED )
	    call TriggerAddCondition(TSpellLichiDamage, Condition(function TSpellLichiDamageCon))
	    call TriggerAddAction(TSpellLichiDamage, function TSpellLichiDamageAct)
	    //囚天地
	    set TSpellLichi51 = CreateTrigger()
	    call TriggerRegisterUnitEvent( TSpellLichi51, lichi, EVENT_UNIT_ISSUED_TARGET_ORDER )
	    call TriggerAddCondition(TSpellLichi51, Condition(function TSpellLichi5Con))
	    call TriggerAddAction(TSpellLichi51, function TSpellLichi51Act)
	    call DisableTrigger(TSpellLichi51)
	    set TSpellLichi52 = CreateTrigger()
	    call TriggerRegisterUnitEvent( TSpellLichi52, lichi, EVENT_UNIT_ISSUED_POINT_ORDER )
	    call TriggerAddCondition(TSpellLichi52, Condition(function TSpellLichi5Con))
	    call TriggerAddAction(TSpellLichi52, function TSpellLichi52Act)
	    call DisableTrigger(TSpellLichi52)
	    call CreateHuanying()
	    call CreateHuanying()
	endfunction
endlibrary
///#include  "edit/Diamond.j"
/*
    英雄霄霆的技能
*/
library_once Xiaoting requires SpellBase,Printer,Attr,Aura,Diamond,Diffculty
	globals
		/*
		    技能触发
		*/
		private trigger TSpellXiaoting = null
		private trigger TAttackXT = null
		/*
		    伤害
		*/
		private real RDamageXiaoting = 0.
		/*
		    元素状态
		*/
		integer ISpellState = 0
		/*
		    Combo数
		*/
		integer ICombo = 0
		/*
		    箭的单位
		*/
		private integer IMaxCombo = 0
		private timer TArrow = null
		private unit array UArrow
		private group array GArrow
		//整秒读数
		private integer IZhengmiao = 0
		//反弹读秒
		private integer IFantan = 0
		//绝焱读秒
		private integer IJueyan = 0
		//静止布尔
		private boolean BJingzhi = false
		//御箭
		private boolean BYujian = false
		//Combo判断
		private timer TComboAdd = null
		//两个科技(前者射出,后者未射出)
		private unit UJianKeji1 = null
		private unit UJianKeji2 = null
		/*
			增益值
		*/
		private real RAddtion = 0.
		//攻击保留特效
		private effect EAttackXT = null
		private integer IAttackAdd = 0
		private integer ITimeAttackadd = 0
		//分裂时间
		private timer TFenlie = null
		//大招持续
		private timer TDazhao = null
		//衰减
		private boolean array BShuaijian
	endglobals
//---------------------------------------------------------------------------------------------------
	/*
	    攻击加攻击
	*/
    private function TAttackXTCon takes nothing returns boolean
    	return GetAttacker() == xiaoting
    endfunction
    private function TAttackXTAct takes nothing returns nothing
    	local integer attack = IMinBJ(500000000,IAttackAdd + GetHeroAgi(xiaoting,true)/4)
    	if (EAttackXT == null) then
			set EAttackXT = AddSpecialEffectTargetUnitBJ("overhead",xiaoting,"Abilities\\Spells\\Human\\InnerFire\\InnerFireTarget.mdl")
    	endif
    	call AddAttack(xiaoting,attack - IAttackAdd)
    	set IAttackAdd = attack
    	set ITimeAttackadd = 5
    endfunction
    //时间减少
    private function AttackTimeReduce takes nothing returns nothing
    	set ITimeAttackadd = IMaxBJ(0,ITimeAttackadd - 1)
    	if (ITimeAttackadd == 0 and EAttackXT != null) then
    		call DestroyEffect(EAttackXT)
    		set EAttackXT = null
	    	call AddAttack(xiaoting,0 - IAttackAdd)
	    	set IAttackAdd = 0
    	endif
    endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    获取combo对应的层数
	*/
	private function GetComboMulti takes nothing returns integer
		if not(IsFourthSpellOK(xiaoting) and GetUnitAbilityLevel(xiaoting,'A0LZ') == 1) then
			return 1
		endif
		if (ICombo > 40) then
			return 4
		elseif (ICombo > 20) then
			return 3
		elseif (ICombo > 10) then
			return 2
		else
			return 1
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    获取Combo消逝时间
	*/
	//private function GetComboTime takes nothing returns real
	//	if (ICombo > 80) then
	//		return 1.
	//	elseif (ICombo > 60) then
	//		return 2.
	//	elseif (ICombo > 40) then
	//		return 3.
	//	elseif (ICombo > 20) then
	//		return 4.
	//	else
	//		return 5.
	//	endif
	//endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    马甲的攻击伤害
	*/
	function SimulateDamageXiaoting takes unit u returns boolean
		//绝焱
		if (GetUnitTypeId(u) == 'h022') then
			call UnitDamageTarget( xiaoting, GetTriggerUnit(), RDamageXiaoting * 1.2 * GetComboMulti(), false, true, ATTACK_TYPE_MAGIC, DAMAGE_TYPE_MAGIC, WEAPON_TYPE_WHOKNOWS )
			return true
		endif
		return false
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    科技
	*/
	private function SetShe1Tech takes nothing returns nothing
		if (UJianKeji2 != null) then
			call RemoveUnit(UJianKeji2)
			set UJianKeji2 = null
		endif
		if (UJianKeji1 == null) then
			set UJianKeji1 = CreateUnit(GetOwningPlayer(xiaoting),'h01Z',0,0,0)
			call ShowUnitHide(UJianKeji1)
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    科技
	*/
	private function SetShe2Tech takes nothing returns nothing
		if (UJianKeji1 != null) then
			call RemoveUnit(UJianKeji1)
			set UJianKeji1 = null
		endif
		if (UJianKeji2 == null) then
			set UJianKeji2 = CreateUnit(GetOwningPlayer(xiaoting),'h020',0,0,0)
			call ShowUnitHide(UJianKeji2)
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    清除指定箭
	*/
	private function ClearRestArrow takes integer start returns nothing
		local integer i = start
		loop
			exitwhen i > 16
			if (UArrow[i] != null) then
				call RemoveUnit(UArrow[i])
				set UArrow[i] = null
				call DestroyGroup(GArrow[i])
				set GArrow[i] = null
				set BShuaijian[i] = false
			endif
			set i = i +1
		endloop
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    清除所有箭有关的东西
	*/
	private function ClearAllArrow takes nothing returns nothing
		call PauseTimer(TArrow)
		call DestroyTimer(TArrow)
		set IZhengmiao = 0
		set TArrow = null
		call ClearRestArrow(1)
		set IFantan = 0
		set IJueyan = 0
		set BJingzhi = false
		set BYujian = false
		call SetShe1Tech()
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    创建绝焱
	*/
	private function CreateJueyan takes unit u returns nothing
		local unit temp = CreateUnit(GetOwningPlayer(xiaoting),'h022',GetUnitX(u),GetUnitY(u),0)
		call UnitApplyTimedLifeBJ( 10.00, 'BHwe',temp )
		set temp = null
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    判断冰墙
	*/
	private function BingqiangFilter takes nothing returns boolean
		return GetUnitTypeId(GetFilterUnit()) == 'hwtw'
	endfunction
	private function PingzhangFilter takes nothing returns boolean
		return GetUnitTypeId(GetFilterUnit()) == 'h021'
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    重新创建一个箭,并换角度
	*/
	private function ChangeFacing takes integer i,real facing returns nothing
		local unit temp = CreateUnit(GetOwningPlayer(xiaoting),'h024',GetUnitX(UArrow[i]),GetUnitY(UArrow[i]),facing)
		call RemoveUnit(UArrow[i])
		set UArrow[i] = temp
		set temp = null
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    箭的运动
	*/
	private function FlashArrowMove takes integer index returns nothing
		local real x = GetUnitX(UArrow[index])
		local real y = GetUnitY(UArrow[index])
        local real xp = x + 100. * CosBJ(GetUnitFacing(UArrow[index]))
        local real yp = y + 100. * SinBJ(GetUnitFacing(UArrow[index]))
        local group l_group = null
        local unit l_unit
        local integer times = GetComboMulti()
        local real radius = 200
        local integer IBing = 0
        local boolean isBingqiang = false
        //如果英雄死亡则清除
        if (BHeroDeath[GetConvertedPlayerId(GetOwningPlayer(xiaoting))] and not(BJuexing3[GetConvertedPlayerId(GetOwningPlayer(xiaoting))])) then
        	call ClearAllArrow()
        	return
        endif
        //御箭
        if (BYujian and index == 1) then
    		call RecoverUnitHP(xiaoting,0.1)
        	call SetUnitManaPercentBJ(xiaoting,100)
        	call SetUnitX(xiaoting,GetUnitX(UArrow[1]))
        	call SetUnitY(xiaoting,GetUnitY(UArrow[1]))
        endif
        if (BJingzhi) then
        	if (IZhengmiao == 1) then
        		call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Other\\Charm\\CharmTarget.mdl", GetUnitX(UArrow[index]),GetUnitY(UArrow[index]) ))
        	endif
        	return
        endif
        set l_group = CreateGroup()
        call GroupEnumUnitsInRange(l_group, x, y, radius, null)
        loop
            set l_unit = FirstOfGroup(l_group)
            exitwhen l_unit == null
            call GroupRemoveUnit(l_group, l_unit)
            if (IsEnemy(l_unit,xiaoting) and not(IsUnitInGroup(l_unit,GArrow[index]))) then
            	call UnitDamageTarget( xiaoting, l_unit, RDamageXiaoting * R3(BShuaijian[index],0.2,1), false, true, ATTACK_TYPE_MAGIC, DAMAGE_TYPE_MAGIC, WEAPON_TYPE_WHOKNOWS )
            	call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Other\\Stampede\\StampedeMissileDeath.mdl", GetUnitX(l_unit),GetUnitY(l_unit) ))
            	call GroupAddUnit(GArrow[index],l_unit)
            endif
        endloop
        call DestroyGroup(l_group)
        set l_group = null
        set l_unit =null
        set l_group = CreateGroup()
        call GroupEnumUnitsInRange(l_group, xp, yp, 100, Condition(function BingqiangFilter))
        if (CountUnitsInGroup(l_group) > 0) then
        	set IBing = I3(CountUnitsInGroup(l_group) > 0,GetUnitUserData( FirstOfGroup(l_group)),0)
        	set isBingqiang = true
        else
	        call GroupEnumUnitsInRange(l_group, xp, yp, 100, Condition(function PingzhangFilter))
        	set IBing = I3(CountUnitsInGroup(l_group) > 0,GetUnitUserData( FirstOfGroup(l_group)),0)
        endif
        call DestroyGroup(l_group)
        set l_group = null
        //反弹与静滞
    	if (IsTerrainPathable(xp, yp, PATHING_TYPE_WALKABILITY) or IBing != 0) then
    		if (xp > yd_MapMaxX or xp < yd_MapMinX) then
					call ChangeFacing(index,180-GetUnitFacing(UArrow[index]))
        			return
        	elseif(yp > yd_MapMaxY or yp < yd_MapMinY) then
					call ChangeFacing(index,-GetUnitFacing(UArrow[index]))
        			return
    		endif
	        if (IFantan > 0) then
        		if (IBing != 0) then
        			call GroupClear(GArrow[index])
					call ChangeFacing(index,R3(IBing >= 1000,180+GetUnitFacing(UArrow[index]),2*IBing-GetUnitFacing(UArrow[index])))
					if not (isBingqiang) then
						set BShuaijian[index] = true
					else
						set BShuaijian[index] = false
					endif
					return
        		endif
        		if not(IsTerrainPathable(xp, y, PATHING_TYPE_WALKABILITY)) then
        			call GroupClear(GArrow[index])
					call ChangeFacing(index,-GetUnitFacing(UArrow[index]))
					set BShuaijian[index] = true
        		elseif not(IsTerrainPathable(x, yp, PATHING_TYPE_WALKABILITY)) then
        			call GroupClear(GArrow[index])
					call ChangeFacing(index,180-GetUnitFacing(UArrow[index]))
					set BShuaijian[index] = true
        		elseif not(IsTerrainPathable(x, y, PATHING_TYPE_WALKABILITY)) then
					call ChangeFacing(index,180+GetUnitFacing(UArrow[index]))
        			call GroupClear(GArrow[index])
					set BShuaijian[index] = true
        		else
		        	call SetUnitX(UArrow[index],YDWECoordinateX(xp))
		        	call SetUnitY(UArrow[index],YDWECoordinateY(yp))
				    //绝焱
			        if (IJueyan > 0) then
			        	if (ModuloInteger(IZhengmiao,3) == 0) then
			        		call CreateJueyan(UArrow[index])
			        	endif
			        endif
        		endif
        	else
	        	call SetUnitX(UArrow[index],YDWECoordinateX(xp))
	        	call SetUnitY(UArrow[index],YDWECoordinateY(yp))
	        	//绝焱
		        if (IJueyan > 0) then
		        	if (ModuloInteger(IZhengmiao,3) == 0) then
		        		call CreateJueyan(UArrow[index])
		        	endif
		        endif
			endif
    	else
        	call SetUnitX(UArrow[index],YDWECoordinateX(xp))
        	call SetUnitY(UArrow[index],YDWECoordinateY(yp))
	        //绝焱
	        if (IJueyan > 0) then
	        	if (ModuloInteger(IZhengmiao,3) == 0) then
	        		call CreateJueyan(UArrow[index])
	        	endif
	        endif
    	endif
	endfunction
	private function FlashArrowMoveTimer takes nothing returns nothing
		local integer i = 1
		set IZhengmiao = I3(IZhengmiao >= 20,1,IZhengmiao + 1)
		if (IZhengmiao == 1) then
			set IFantan = I3(IFantan > 0,IFantan - 1,0)
			set IJueyan = I3(IJueyan > 0,IJueyan - 1,0)
		endif
		loop
			exitwhen i > IMaxCombo
			if (UArrow[i] != null) then
				call FlashArrowMove(i)
			endif
			set i = i +1
		endloop
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    贯虹箭
	*/
	private function Guanhongjian takes real x,real y,real facing,boolean spellID returns nothing
		local integer i = 1
		call SetShe2Tech()
		if (spellID) then
	    	call PrintSpell(GetOwningPlayer(xiaoting),GetAbilityName(GetSpellAbilityId()),RDamageXiaoting * GetComboMulti())
		endif
		loop
			exitwhen i > IMaxCombo
			if (UArrow[i] == null) then
				set UArrow[i] = CreateUnit(GetOwningPlayer(xiaoting),'h024',x,y,facing)
				if (TArrow == null) then
					set TArrow = CreateTimer()
					set IZhengmiao = 1
					call TimerStart(TArrow,0.05,true,function FlashArrowMoveTimer)
				endif
				set GArrow[i] = CreateGroup()
				return
			endif
			set i = i +1
		endloop
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    折返
	*/
	private function Zhefan takes nothing returns nothing
		set IFantan = 5
	    call PrintSpellContent(GetOwningPlayer(xiaoting),GetAbilityName(GetSpellAbilityId()),"折返剩余时间" + I2S(IFantan)+"s.")
	    call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\NightElf\\BattleRoar\\RoarCaster.mdl", GetUnitX(xiaoting), GetUnitY(xiaoting) ))
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    炎止
	*/
	private function Yanzhi takes nothing returns nothing
		local integer i = 1
		local group g = CreateGroup()
		local group temp = null
		local unit l_unit = null
		if (BJingzhi) then
			call ClearAllArrow()
			return
		endif
		loop
			exitwhen i > IMaxCombo
			if (UArrow[i] != null) then
				set temp = GetEnemyGroup(GetOwningPlayer(xiaoting),GetUnitX(UArrow[i]),GetUnitY(UArrow[i]),900)
				call GroupAddGroup(temp,g)
				call DestroyGroup(temp)
				//call DamageArea(xiaoting,GetUnitX(UArrow[i]),GetUnitY(UArrow[i]),900,RDamageXiaoting* 0.50 * (GetComboMulti() + 1))
				call DestroyEffect(AddSpecialEffect("Objects\\Spawnmodels\\Other\\NeutralBuildingExplosion\\NeutralBuildingExplosion.mdl", GetUnitX(UArrow[i]),GetUnitY(UArrow[i]) ))
			endif
			set i = i +1
		endloop
		//伤害
		loop
		    set l_unit = FirstOfGroup(g)
		    exitwhen l_unit == null
		    call GroupRemoveUnit(g, l_unit)
		    call UnitDamageTarget( xiaoting, l_unit, RDamageXiaoting* 0.50 * (GetComboMulti() + 1), false, true, ATTACK_TYPE_MAGIC, DAMAGE_TYPE_MAGIC, WEAPON_TYPE_WHOKNOWS )
		endloop
		call ClearAllArrow()
	    call PrintSpell(GetOwningPlayer(xiaoting),GetAbilityName(GetSpellAbilityId()),RDamageXiaoting* 0.50 * (GetComboMulti() + 1))
	    call DestroyGroup(g)
	    set g = null
	    set temp = null
	    set l_unit = null
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    沉默
	*/
	private function Chenmo takes nothing returns nothing
		local integer i = 1
		loop
			exitwhen i > IMaxCombo
			if (UArrow[i] != null) then
				call ChangeFacing(i,GetFacingBetweenXY(GetUnitX(UArrow[i]),GetUnitY(UArrow[i]),GetSpellTargetX(),GetSpellTargetY()))
			    call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Human\\MassTeleport\\MassTeleportCaster.mdl", GetUnitX(UArrow[i]), GetUnitY(UArrow[i]) ))
			endif
			set i = i +1
		endloop
	    call PrintSpellName(GetOwningPlayer(xiaoting),GetAbilityName(GetSpellAbilityId()))
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    追心
	*/
	private function Zhuixin takes nothing returns nothing
		local integer i = 1
		loop
			exitwhen i > IMaxCombo
			if (UArrow[i] != null) then
				call ChangeFacing(i,GetFacingBetweenXY(GetUnitX(UArrow[i]),GetUnitY(UArrow[i]),GetUnitX(xiaoting),GetUnitY(xiaoting)))
			    call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Human\\MassTeleport\\MassTeleportCaster.mdl", GetUnitX(UArrow[i]), GetUnitY(UArrow[i]) ))
			endif
			set i = i +1
		endloop
	    call PrintSpellName(GetOwningPlayer(xiaoting),GetAbilityName(GetSpellAbilityId()))
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    冰墙
	*/
	private function Bingqiang takes nothing returns nothing
	    local integer i = 1
	    local real facing = Atan2BJ(GetSpellTargetY()-GetUnitY(xiaoting),GetSpellTargetX()-GetUnitX(xiaoting))
	    local unit u = null
	    loop
	    	exitwhen i > (6 + 4 * GetComboMulti())
	    	set u = CreateUnit(GetOwningPlayer(xiaoting),'hwtw',YDWECoordinateX(GetUnitX(xiaoting) + 200.00 * I2R(i) * CosBJ(facing) ), YDWECoordinateY(GetUnitY(xiaoting) + 200.00 * I2R(i) * SinBJ(facing) ),0)
	    	if (i == 1 or i == (6 + 4 * GetComboMulti())) then
	    	endif
	    	call SetUnitUserData(u,R2I(facing)+I3((i == 1 or i == (6 + 4 * GetComboMulti())),2000,0))
	    	call UnitApplyTimedLifeBJ( 12.00 + RJ2(xiaoting,5,0), 'BHwe',u )
	    	set i = i +1
	    endloop
	    call PrintSpellName(GetOwningPlayer(xiaoting),GetAbilityName(GetSpellAbilityId()))
	    set u = null
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    静体
	*/
	private function JingtiTimer takes nothing returns nothing
		local timer t = GetExpiredTimer()
		local real intTimes = LoadReal(spellTable,GetHandleId(t),1)
		call AddAgiPercentImme(GetConvertedPlayerId(GetOwningPlayer(xiaoting)),-1 * intTimes)
		call FlushChildHashtable(spellTable,GetHandleId(t))
		call PauseTimer(t)
		call DestroyTimer(t)
		set t = null
	endfunction
	private function Jingti takes nothing returns nothing
		local real intTimes = 0.25 + GetComboMulti() * 0.25
		local timer t = CreateTimer()
		call SaveReal(spellTable,GetHandleId(t),1,intTimes)
		call TimerStart(t,30,false,function JingtiTimer)
		call AddAgiPercentImme(GetConvertedPlayerId(GetOwningPlayer(xiaoting)),intTimes)
		call YDWETimerDestroyEffect(30,AddSpecialEffectTargetUnitBJ("overhead",xiaoting,"war3mapImported\\state_xiaoting.mdx"))
	    call PrintSpellContent(GetOwningPlayer(xiaoting),GetAbilityName(GetSpellAbilityId()),"成功增加"+I2S(25 +GetComboMulti()*25)+"%的敏捷，持续30秒。")
	    set t = null
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    分裂
	*/
	private function FenlieTimeout takes nothing returns nothing
		call ClearRestArrow(2)
    	call CreateSpellTextTag("分裂箭时间到",xiaoting,0,100,0,3)
	endfunction
	private function Fenlie takes nothing returns nothing
		local integer i = 1
		local integer max = 0
		loop
			exitwhen i > IMaxCombo
			if (UArrow[i] == null) then
				set max = i - 1
				exitwhen true
			endif
			set i = i +1
		endloop
		set i = 1
		loop
			exitwhen i > max
			if (UArrow[i] != null) then
				call Guanhongjian(GetUnitX(UArrow[i]),GetUnitY(UArrow[i]),GetUnitFacing(UArrow[i])+GetRandomReal(-15,15),false)
				call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Orc\\MirrorImage\\MirrorImageCaster.mdl", GetUnitX(UArrow[i]),GetUnitY(UArrow[i]) ))
			endif
			set i = i +1
		endloop
	    call PrintSpellName(GetOwningPlayer(xiaoting),GetAbilityName(GetSpellAbilityId()))
	    call TimerStart(TFenlie,7,false,function FenlieTimeout)
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    瞬体
	*/
	private function Shunti takes nothing returns nothing
		local integer i = 1
		loop
			exitwhen i > IMaxCombo
			if (UArrow[i] != null) then
			    call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\NightElf\\Blink\\BlinkCaster.mdl", GetUnitX(UArrow[i]), GetUnitY(UArrow[i]) ))
			    call SetUnitX(UArrow[i],GetUnitX(xiaoting))
				call SetUnitY(UArrow[i],GetUnitY(xiaoting))
			endif
			set i = i +1
		endloop
	    call PrintSpellName(GetOwningPlayer(xiaoting),GetAbilityName(GetSpellAbilityId()))
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    渡越
	*/
    private function DuyueTimer takes nothing returns nothing
    	local timer t = GetExpiredTimer()
    	local integer id = GetHandleId(t)
    	local Attract attract = LoadInteger(spellTable,id,1)
    	call attract.destroy()
		call PauseTimer(t)
		call FlushChildHashtable(spellTable,id)
		call DestroyTimer(t)
    	set t = null
    endfunction
	private function Duyue takes nothing returns nothing
		local integer i = 1
	    local timer t = CreateTimer()
	    local Attract attract = Attract.create(xiaoting,I3(IsInDiamondRegion(GetUnitX(xiaoting),GetUnitY(xiaoting)),900,900*GetComboMulti()),0.05,50 * GetComboMulti())
	    call PrintSpellContent(GetOwningPlayer(xiaoting),GetAbilityName(GetSpellAbilityId()),"范围"+I2S(900*GetComboMulti()) +".")
		call YDWETimerDestroyEffect(3,AddSpecialEffectTargetUnitBJ("chest",xiaoting,"war3mapImported\\hole.mdl"))
		call attract.SetForbitHero()
		call attract.SetDeathContinue()
	    call attract.start()
	    call SaveInteger(spellTable,GetHandleId(t),1,attract)
	    call TimerStart(t,3,false,function DuyueTimer)
	    set t = null
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    御箭
	*/
	private function Yujian takes nothing returns nothing
		set BYujian = not(BYujian)
		if (BYujian) then
			call PrintSpellContent(GetOwningPlayer(xiaoting),GetAbilityName(GetSpellAbilityId()),"开启御箭形态.")
		else
			call PrintSpellContent(GetOwningPlayer(xiaoting),GetAbilityName(GetSpellAbilityId()),"关闭御箭形态.")
		endif
	    call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\NightElf\\BattleRoar\\RoarCaster.mdl", GetUnitX(xiaoting), GetUnitY(xiaoting) ))
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    绝焱
	*/
	private function Jueyan takes nothing returns nothing
		set IJueyan = IJueyan + 2
	    call PrintSpellName(GetOwningPlayer(xiaoting),GetAbilityName(GetSpellAbilityId()))
	    call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\NightElf\\BattleRoar\\RoarCaster.mdl", GetUnitX(xiaoting), GetUnitY(xiaoting) ))
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    静滞
	*/
	private function Jingzhi takes nothing returns nothing
		set BJingzhi = not(BJingzhi)
		if (BJingzhi) then
			call PrintSpellContent(GetOwningPlayer(xiaoting),GetAbilityName(GetSpellAbilityId()),"开启静滞形态.")
		else
			call PrintSpellContent(GetOwningPlayer(xiaoting),GetAbilityName(GetSpellAbilityId()),"关闭静滞形态.")
		endif
	    call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\NightElf\\BattleRoar\\RoarCaster.mdl", GetUnitX(xiaoting), GetUnitY(xiaoting) ))
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    箭灵
	*/
	private function Jianling takes nothing returns nothing
		local integer times = GetComboMulti()
		local integer attack = IMinBJ(1000000000,(GetHeroInt(xiaoting,true) + GetAttack(xiaoting)) * 4)
		local integer defense =(GetHeroAgi(xiaoting,true)/100 + GetDefense(xiaoting))
		local integer hp =(GetHeroStr(xiaoting,true) * 10 + GetHP(xiaoting))
		local unit u
		local integer i = 1
		loop
			exitwhen i > IMaxCombo
			if (UArrow[i] != null) then
				set u = CreateUnit(GetOwningPlayer(xiaoting),'n01V',GetUnitX(UArrow[i]),GetUnitY(UArrow[i]),0)
				call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Undead\\AnimateDead\\AnimateDeadTarget.mdl", GetUnitX(u),GetUnitY(u) ))
				call UnitApplyTimedLifeBJ( 180.00, 'BHwe',u )
				call SetAttack(u,attack)
				call SetDefense(u,defense)
				call SetHP(u,hp)
			endif
			set i = i +1
		endloop
	    call PrintSpellName(GetOwningPlayer(xiaoting),GetAbilityName(GetSpellAbilityId()))
	    set u = null
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    穿刺
	*/
	private function Gangti takes nothing returns nothing
		local real defenseAdd = 2. + 1. *GetComboMulti()
		call AddDefensePercent(GetConvertedPlayerId(GetOwningPlayer(xiaoting)),defenseAdd)
		call AddDefense(xiaoting,0)
		call PrintSpellContent(GetOwningPlayer(xiaoting),GetAbilityName(GetSpellAbilityId()),"防御成功增加" + I2S(200 + 100 * GetComboMulti())+"%.")
	    call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\NightElf\\BattleRoar\\RoarCaster.mdl", GetUnitX(xiaoting), GetUnitY(xiaoting) ))
	    call YDWEPolledWaitNull(10)
		call AddDefensePercent(GetConvertedPlayerId(GetOwningPlayer(xiaoting)),-1 * defenseAdd)
		call AddDefense(xiaoting,0)
		call PrintSpellContent(GetOwningPlayer(xiaoting),GetAbilityName(GetSpellAbilityId()),"防御增益效果结束.")
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    屏障
	*/
	private function PingzhangTimer takes nothing returns nothing
		local timer t = GetExpiredTimer()
		local integer id = GetHandleId(t)
		local unit u = LoadUnitHandle(spellTable,id,1)
		local group l_group = CreateGroup()
		local unit l_unit
		if (IsUnitAliveBJ(u)) then
			call GroupEnumUnitsInRange(l_group, GetUnitX(u), GetUnitY(u), 600, null)
			loop
			    set l_unit = FirstOfGroup(l_group)
			    exitwhen l_unit == null
			    call GroupRemoveUnit(l_group, l_unit)
			    if (IsAlly(l_unit,xiaoting)) then
			    	call RecoverUnitHP(l_unit,0.3)
			    	call RecoverUnitMP(l_unit,20)
			    endif
			endloop
			call DestroyGroup(l_group)
			set l_group = null
			set l_unit =null
		else
			call AddDamagePercent(GetConvertedPlayerId(GetOwningPlayer(xiaoting)),-0.3)
			call RemoveUnit(u)
			call FlushChildHashtable(spellTable,id)
			call PauseTimer(t)
			call DestroyTimer(t)
		endif
		set u = null
		set t = null
		call DestroyGroup(l_group)
		set l_unit = null
		set l_group = null
	endfunction
	private function Pingzhang takes nothing returns nothing
		local integer i = 1
		local unit u = null
		local timer t = CreateTimer()
		local unit temp = CreateUnit(GetOwningPlayer(xiaoting),'h023',GetUnitX(xiaoting),GetUnitY(xiaoting),0)
		call UnitApplyTimedLifeBJ( 10, 'BHwe',temp )
		call AddDamagePercent(GetConvertedPlayerId(GetOwningPlayer(xiaoting)),0.3)
		call PrintSpellName(GetOwningPlayer(xiaoting),GetAbilityName(GetSpellAbilityId()))
		loop
			exitwhen i > 24
			set u = CreateUnit(GetOwningPlayer(xiaoting),'h021',YDWECoordinateX(GetUnitX(xiaoting) + 600 * CosBJ(i*15)), YDWECoordinateY(GetUnitY(xiaoting) + 600 * SinBJ(i*15)),0)
	    	call SetUnitUserData(u,i*15+90)
 			call UnitApplyTimedLifeBJ( 10, 'BHwe',u )
			set i = i +1
		endloop
		//不断伤害
		call SaveUnitHandle(spellTable,GetHandleId(t),1,temp)
		call TimerStart(t,1,true,function PingzhangTimer)
        call PlaySoundBJ(gg_snd_xiaoting1)
		//快速升级
		set t = null
		set u = null
		set temp = null
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    箭绝天技
	*/
	private function JianjuetianjiTimeout takes nothing returns nothing
        call AddDamagePercent(GetConvertedPlayerId(GetOwningPlayer(xiaoting)),-0.6)
		call PrintSpellContent(GetOwningPlayer(xiaoting),GetAbilityName('A0M3'),"断了.")
		call PauseTimer(TDazhao)
		call DestroyTimer(TDazhao)
		set TDazhao = null
	endfunction
	private function Jianjuetianji takes nothing returns nothing
		call DestroyEffect(AddSpecialEffect("war3mapImported\\xiaoting_pingzhang.mdx", GetUnitX(xiaoting),GetUnitY(xiaoting) ))
		if (TDazhao == null) then
			call PrintSpellName(GetOwningPlayer(xiaoting),GetAbilityName(GetSpellAbilityId()))
	        //call PlaySoundBJ(gg_snd_xiaoting2)
	        call AddDamagePercent(GetConvertedPlayerId(GetOwningPlayer(xiaoting)),0.6)
	        set TDazhao = CreateTimer()
		endif
		call TimerStart(TDazhao,5,false,function JianjuetianjiTimeout)
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    根据当前技能套设定相关的技能
	*/
	private function SetSpellSet takes integer i returns nothing
		set ISpellState = i
		if (i == 0) then
			call SetPlayerAbilityAvailable(GetOwningPlayer(xiaoting),'A0LO',false)
			call SetPlayerAbilityAvailable(GetOwningPlayer(xiaoting),'A0LR',false)
			call SetPlayerAbilityAvailable(GetOwningPlayer(xiaoting),'A0LV',false)
			call SetPlayerAbilityAvailable(GetOwningPlayer(xiaoting),'A0M0',false)
			call SetPlayerAbilityAvailable(GetOwningPlayer(xiaoting),'A0LQ',false)
			call SetPlayerAbilityAvailable(GetOwningPlayer(xiaoting),'A0LS',false)
			call SetPlayerAbilityAvailable(GetOwningPlayer(xiaoting),'A0LX',false)
			call SetPlayerAbilityAvailable(GetOwningPlayer(xiaoting),'A0M2',false)
			call SetPlayerAbilityAvailable(GetOwningPlayer(xiaoting),'A0LP',false)
			call SetPlayerAbilityAvailable(GetOwningPlayer(xiaoting),'A0LU',false)
			call SetPlayerAbilityAvailable(GetOwningPlayer(xiaoting),'A0LW',false)
			call SetPlayerAbilityAvailable(GetOwningPlayer(xiaoting),'A0M1',false)
			call SetPlayerAbilityAvailable(GetOwningPlayer(xiaoting),'A0LN',true)
			call SetPlayerAbilityAvailable(GetOwningPlayer(xiaoting),'A0LT',true)
			call SetPlayerAbilityAvailable(GetOwningPlayer(xiaoting),'A0LY',true)
			call SetPlayerAbilityAvailable(GetOwningPlayer(xiaoting),'A0LZ',true)
		elseif (i == 1) then
			call SetPlayerAbilityAvailable(GetOwningPlayer(xiaoting),'A0LO',false)
			call SetPlayerAbilityAvailable(GetOwningPlayer(xiaoting),'A0LR',false)
			call SetPlayerAbilityAvailable(GetOwningPlayer(xiaoting),'A0LV',false)
			call SetPlayerAbilityAvailable(GetOwningPlayer(xiaoting),'A0M0',false)
			call SetPlayerAbilityAvailable(GetOwningPlayer(xiaoting),'A0LP',false)
			call SetPlayerAbilityAvailable(GetOwningPlayer(xiaoting),'A0LU',false)
			call SetPlayerAbilityAvailable(GetOwningPlayer(xiaoting),'A0LW',false)
			call SetPlayerAbilityAvailable(GetOwningPlayer(xiaoting),'A0M1',false)
			call SetPlayerAbilityAvailable(GetOwningPlayer(xiaoting),'A0LN',false)
			call SetPlayerAbilityAvailable(GetOwningPlayer(xiaoting),'A0LT',false)
			call SetPlayerAbilityAvailable(GetOwningPlayer(xiaoting),'A0LY',false)
			call SetPlayerAbilityAvailable(GetOwningPlayer(xiaoting),'A0LZ',false)
			call SetPlayerAbilityAvailable(GetOwningPlayer(xiaoting),'A0LQ',true)
			call SetPlayerAbilityAvailable(GetOwningPlayer(xiaoting),'A0LS',true)
			call SetPlayerAbilityAvailable(GetOwningPlayer(xiaoting),'A0LX',true)
			call SetPlayerAbilityAvailable(GetOwningPlayer(xiaoting),'A0M2',true)
		elseif (i == 2) then
			call SetPlayerAbilityAvailable(GetOwningPlayer(xiaoting),'A0LO',false)
			call SetPlayerAbilityAvailable(GetOwningPlayer(xiaoting),'A0LR',false)
			call SetPlayerAbilityAvailable(GetOwningPlayer(xiaoting),'A0LV',false)
			call SetPlayerAbilityAvailable(GetOwningPlayer(xiaoting),'A0M0',false)
			call SetPlayerAbilityAvailable(GetOwningPlayer(xiaoting),'A0LN',false)
			call SetPlayerAbilityAvailable(GetOwningPlayer(xiaoting),'A0LT',false)
			call SetPlayerAbilityAvailable(GetOwningPlayer(xiaoting),'A0LY',false)
			call SetPlayerAbilityAvailable(GetOwningPlayer(xiaoting),'A0LZ',false)
			call SetPlayerAbilityAvailable(GetOwningPlayer(xiaoting),'A0LQ',false)
			call SetPlayerAbilityAvailable(GetOwningPlayer(xiaoting),'A0LS',false)
			call SetPlayerAbilityAvailable(GetOwningPlayer(xiaoting),'A0LX',false)
			call SetPlayerAbilityAvailable(GetOwningPlayer(xiaoting),'A0M2',false)
			call SetPlayerAbilityAvailable(GetOwningPlayer(xiaoting),'A0LP',true)
			call SetPlayerAbilityAvailable(GetOwningPlayer(xiaoting),'A0LU',true)
			call SetPlayerAbilityAvailable(GetOwningPlayer(xiaoting),'A0LW',true)
			call SetPlayerAbilityAvailable(GetOwningPlayer(xiaoting),'A0M1',true)
		elseif (i == 3) then
			call SetPlayerAbilityAvailable(GetOwningPlayer(xiaoting),'A0LN',false)
			call SetPlayerAbilityAvailable(GetOwningPlayer(xiaoting),'A0LT',false)
			call SetPlayerAbilityAvailable(GetOwningPlayer(xiaoting),'A0LY',false)
			call SetPlayerAbilityAvailable(GetOwningPlayer(xiaoting),'A0LZ',false)
			call SetPlayerAbilityAvailable(GetOwningPlayer(xiaoting),'A0LQ',false)
			call SetPlayerAbilityAvailable(GetOwningPlayer(xiaoting),'A0LS',false)
			call SetPlayerAbilityAvailable(GetOwningPlayer(xiaoting),'A0LX',false)
			call SetPlayerAbilityAvailable(GetOwningPlayer(xiaoting),'A0M2',false)
			call SetPlayerAbilityAvailable(GetOwningPlayer(xiaoting),'A0LP',false)
			call SetPlayerAbilityAvailable(GetOwningPlayer(xiaoting),'A0LU',false)
			call SetPlayerAbilityAvailable(GetOwningPlayer(xiaoting),'A0LW',false)
			call SetPlayerAbilityAvailable(GetOwningPlayer(xiaoting),'A0M1',false)
			call SetPlayerAbilityAvailable(GetOwningPlayer(xiaoting),'A0LO',true)
			call SetPlayerAbilityAvailable(GetOwningPlayer(xiaoting),'A0LR',true)
			call SetPlayerAbilityAvailable(GetOwningPlayer(xiaoting),'A0LV',true)
			call SetPlayerAbilityAvailable(GetOwningPlayer(xiaoting),'A0M0',true)
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    COMBO相关
	*/
	//加属性
	private function FlashComboShuxing takes nothing returns nothing
		local real delta = R3(GetComboMulti()== 1,0.,0.25 + 0.25 * GetComboMulti())
		if (RAddtion != delta) then
			call AddStrPercentImme(GetConvertedPlayerId(GetOwningPlayer(xiaoting)), delta - RAddtion )
			call AddIntPercentImme(GetConvertedPlayerId(GetOwningPlayer(xiaoting)), delta - RAddtion )
			call AddAgiPercentImme(GetConvertedPlayerId(GetOwningPlayer(xiaoting)), delta - RAddtion )
			set RAddtion = delta
			call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Demon\\DarkPortal\\DarkPortalTarget.mdl", GetUnitX(xiaoting), GetUnitY(xiaoting) ))
    		call CreateSpellTextTag(I2S(R2I(delta*100))+"%全属性提高",xiaoting,0,100,0,3)
		endif
	endfunction
	//判断16个都是否一致
	private function ComboDuan takes nothing returns nothing
		set ICombo = 0
    	call CreateSpellTextTag("Combo断了",xiaoting,0,100,0,3)
    	call FlashComboShuxing()
	endfunction
	private function AddCombo takes nothing returns nothing
		if not(IsSecondSpellOK(xiaoting) == true and GetUnitAbilityLevel(xiaoting,'A0LT') == 1) then
			return
		endif
		set ICombo = ICombo + 1
		call TimerStart(TComboAdd,RMaxBJ(0.1,I2R(5 + IJ1(xiaoting,1,0)+IJ3(xiaoting,1,0) - (ICombo / 20)))/R3(IsWanjie(),2.0,1.0),false,function ComboDuan)
    	call CreateSpellTextTag("Combo:"+I2S(ICombo),xiaoting,100,0,0,3)
		if (GetComboMulti() == 4 and IMaxCombo != 16) then
			set IMaxCombo = 16
		elseif (GetComboMulti() == 3 and IMaxCombo != 12) then
			set IMaxCombo = 12
			call ClearRestArrow(13)
		elseif (GetComboMulti() == 2 and IMaxCombo != 8) then
			set IMaxCombo = 8
			call ClearRestArrow(9)
		elseif (GetComboMulti() == 1 and IMaxCombo != 4) then
			set IMaxCombo = 4
			call ClearRestArrow(5)
		endif
    	call FlashComboShuxing()
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    主英雄技能判断
	*/
	private function TSpellXiaotingAct takes nothing returns nothing
		//切换技能套
		if (GetSpellAbilityId() == 'A0LJ') then
			call SetPlayerAbilityAvailable(GetOwningPlayer(xiaoting),'A0LJ',false)
			call SetPlayerAbilityAvailable(GetOwningPlayer(xiaoting),'A0LK',true)
			call SetUnitAbilityLevel(xiaoting,'A0LK',1+IJ1(xiaoting,1,0)+IJ2(xiaoting,1,0)+IJ3(xiaoting,1,0))
			call SetSpellSet(1)
			set ICombo = ICombo + IJ1(xiaoting,1,0) * IJ3(xiaoting,2,1)
		elseif (GetSpellAbilityId() == 'A0LK') then
			call SetPlayerAbilityAvailable(GetOwningPlayer(xiaoting),'A0LK',false)
			call SetPlayerAbilityAvailable(GetOwningPlayer(xiaoting),'A0LL',true)
			call SetUnitAbilityLevel(xiaoting,'A0LL',1+IJ1(xiaoting,1,0)+IJ2(xiaoting,1,0)+IJ3(xiaoting,1,0))
			call SetSpellSet(2)
			set ICombo = ICombo + IJ1(xiaoting,1,0) * IJ3(xiaoting,2,1)
		elseif (GetSpellAbilityId() == 'A0LL') then
			call SetPlayerAbilityAvailable(GetOwningPlayer(xiaoting),'A0LL',false)
			call SetPlayerAbilityAvailable(GetOwningPlayer(xiaoting),'A0LM',true)
			call SetUnitAbilityLevel(xiaoting,'A0LM',1+IJ1(xiaoting,1,0)+IJ2(xiaoting,1,0)+IJ3(xiaoting,1,0))
			call SetSpellSet(3)
			set ICombo = ICombo + IJ1(xiaoting,1,0) * IJ3(xiaoting,2,1)
		elseif (GetSpellAbilityId() == 'A0LM') then
			call SetPlayerAbilityAvailable(GetOwningPlayer(xiaoting),'A0LM',false)
			call SetPlayerAbilityAvailable(GetOwningPlayer(xiaoting),'A0LJ',true)
			call SetUnitAbilityLevel(xiaoting,'A0LJ',1+IJ1(xiaoting,1,0)+IJ2(xiaoting,1,0)+IJ3(xiaoting,1,0))
			call SetSpellSet(0)
			set ICombo = ICombo + IJ1(xiaoting,1,0) * IJ3(xiaoting,2,1)
		//大招-箭绝天技
		elseif (GetSpellAbilityId() == 'A0M3') then
			call AddCombo()
			call Jianjuetianji()
		//贯虹箭
		elseif (GetSpellAbilityId() == 'A0LN') then
			call AddCombo()
			call Guanhongjian(GetSpellTargetX(),GetSpellTargetY(),GetFacingBetweenXY(GetUnitX(xiaoting),GetUnitY(xiaoting),GetSpellTargetX(),GetSpellTargetY()),true)
			call UnitRemoveAbility(xiaoting,'A0LO')
			call UnitAddAbility(xiaoting,'A0LO')
			if (IsFifthSpellOK(xiaoting)and GetUnitAbilityLevel(xiaoting,'A0M3') == 1) then
				call UnitRemoveAbility(xiaoting,'A0M3')
				call UnitAddAbility(xiaoting,'A0M3')
			endif
		//箭技-折返
		elseif (GetSpellAbilityId() == 'A0LO') then
			call AddCombo()
			call Zhefan()
			if (IsFifthSpellOK(xiaoting)and GetUnitAbilityLevel(xiaoting,'A0M3') == 1) then
				call UnitRemoveAbility(xiaoting,'A0M3')
				call UnitAddAbility(xiaoting,'A0M3')
			endif
		//箭技-炎止
		elseif (GetSpellAbilityId() == 'A0LP') then
			call AddCombo()
			call Yanzhi()
			call UnitRemoveAbility(xiaoting,'A0LO')
			call UnitAddAbility(xiaoting,'A0LO')
			if (IsFifthSpellOK(xiaoting)and GetUnitAbilityLevel(xiaoting,'A0M3') == 1) then
				call UnitRemoveAbility(xiaoting,'A0M3')
				call UnitAddAbility(xiaoting,'A0M3')
			endif
		//箭技-沉默
		elseif (GetSpellAbilityId() == 'A0LQ') then
			call AddCombo()
			call Chenmo()
			call UnitRemoveAbility(xiaoting,'A0LO')
			call UnitAddAbility(xiaoting,'A0LO')
			if (IsFifthSpellOK(xiaoting)and GetUnitAbilityLevel(xiaoting,'A0M3') == 1) then
				call UnitRemoveAbility(xiaoting,'A0M3')
				call UnitAddAbility(xiaoting,'A0M3')
			endif
		//箭技-瞬体
		elseif (GetSpellAbilityId() == 'A0LT') then
			call AddCombo()
			call Shunti()
			call UnitRemoveAbility(xiaoting,'A0LO')
			call UnitAddAbility(xiaoting,'A0LO')
			if (IsFifthSpellOK(xiaoting)and GetUnitAbilityLevel(xiaoting,'A0M3') == 1) then
				call UnitRemoveAbility(xiaoting,'A0M3')
				call UnitAddAbility(xiaoting,'A0M3')
			endif
		//绝技-冰墙
		elseif (GetSpellAbilityId() == 'A0LR') then
			call AddCombo()
			call Bingqiang()
			if (IsFifthSpellOK(xiaoting)and GetUnitAbilityLevel(xiaoting,'A0M3') == 1) then
				call UnitRemoveAbility(xiaoting,'A0M3')
				call UnitAddAbility(xiaoting,'A0M3')
			endif
		//绝技-静体
		elseif (GetSpellAbilityId() == 'A0LU') then
			call AddCombo()
			call Jingti()
			call UnitRemoveAbility(xiaoting,'A0LO')
			call UnitAddAbility(xiaoting,'A0LO')
			if (IsFifthSpellOK(xiaoting)and GetUnitAbilityLevel(xiaoting,'A0M3') == 1) then
				call UnitRemoveAbility(xiaoting,'A0M3')
				call UnitAddAbility(xiaoting,'A0M3')
			endif
		//箭技-分裂
		elseif (GetSpellAbilityId() == 'A0LS') then
			call AddCombo()
			call Fenlie()
			call UnitRemoveAbility(xiaoting,'A0LO')
			call UnitAddAbility(xiaoting,'A0LO')
			if (IsFifthSpellOK(xiaoting)and GetUnitAbilityLevel(xiaoting,'A0M3') == 1) then
				call UnitRemoveAbility(xiaoting,'A0M3')
				call UnitAddAbility(xiaoting,'A0M3')
			endif
		//箭技-渡越
		elseif (GetSpellAbilityId() == 'A0LV') then
			call AddCombo()
			call Duyue()
			call UnitRemoveAbility(xiaoting,'A0LO')
			call UnitAddAbility(xiaoting,'A0LO')
			if (IsFifthSpellOK(xiaoting)and GetUnitAbilityLevel(xiaoting,'A0M3') == 1) then
				call UnitRemoveAbility(xiaoting,'A0M3')
				call UnitAddAbility(xiaoting,'A0M3')
			endif
		//箭技-追心
		elseif (GetSpellAbilityId() == 'A0LY') then
			call AddCombo()
			call Zhuixin()
			call UnitRemoveAbility(xiaoting,'A0LO')
			call UnitAddAbility(xiaoting,'A0LO')
			if (IsFifthSpellOK(xiaoting)and GetUnitAbilityLevel(xiaoting,'A0M3') == 1) then
				call UnitRemoveAbility(xiaoting,'A0M3')
				call UnitAddAbility(xiaoting,'A0M3')
			endif
		//箭技-御箭
		elseif (GetSpellAbilityId() == 'A0LW') then
			call AddCombo()
			call Yujian()
			call UnitRemoveAbility(xiaoting,'A0LO')
			call UnitAddAbility(xiaoting,'A0LO')
			if (IsFifthSpellOK(xiaoting)and GetUnitAbilityLevel(xiaoting,'A0M3') == 1) then
				call UnitRemoveAbility(xiaoting,'A0M3')
				call UnitAddAbility(xiaoting,'A0M3')
			endif
		//箭技-绝焱
		elseif (GetSpellAbilityId() == 'A0LX') then
			call AddCombo()
			call Jueyan()
			call UnitRemoveAbility(xiaoting,'A0LO')
			call UnitAddAbility(xiaoting,'A0LO')
			if (IsFifthSpellOK(xiaoting)and GetUnitAbilityLevel(xiaoting,'A0M3') == 1) then
				call UnitRemoveAbility(xiaoting,'A0M3')
				call UnitAddAbility(xiaoting,'A0M3')
			endif
		//箭技-静滞
		elseif (GetSpellAbilityId() == 'A0LZ') then
			call AddCombo()
			call Jingzhi()
			call UnitRemoveAbility(xiaoting,'A0LO')
			call UnitAddAbility(xiaoting,'A0LO')
			if (IsFifthSpellOK(xiaoting)and GetUnitAbilityLevel(xiaoting,'A0M3') == 1) then
				call UnitRemoveAbility(xiaoting,'A0M3')
				call UnitAddAbility(xiaoting,'A0M3')
			endif
		//箭技-箭灵
		elseif (GetSpellAbilityId() == 'A0M0') then
			call AddCombo()
			call Jianling()
			if (IsFifthSpellOK(xiaoting)and GetUnitAbilityLevel(xiaoting,'A0M3') == 1) then
				call UnitRemoveAbility(xiaoting,'A0M3')
				call UnitAddAbility(xiaoting,'A0M3')
			endif
		//箭技-穿刺
		elseif (GetSpellAbilityId() == 'A0M1') then
			call AddCombo()
			call Gangti()
			call UnitRemoveAbility(xiaoting,'A0LO')
			call UnitAddAbility(xiaoting,'A0LO')
			if (IsFifthSpellOK(xiaoting)and GetUnitAbilityLevel(xiaoting,'A0M3') == 1) then
				call UnitRemoveAbility(xiaoting,'A0M3')
				call UnitAddAbility(xiaoting,'A0M3')
			endif
		//绝技-屏障
		elseif (GetSpellAbilityId() == 'A0M2') then
			call AddCombo()
			call Pingzhang()
			call UnitRemoveAbility(xiaoting,'A0LO')
			call UnitAddAbility(xiaoting,'A0LO')
			if (IsFifthSpellOK(xiaoting)and GetUnitAbilityLevel(xiaoting,'A0M3') == 1) then
				call UnitRemoveAbility(xiaoting,'A0M3')
				call UnitAddAbility(xiaoting,'A0M3')
			endif
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    刷新伤害
	*/
	private function FlashXiaotingDamage takes nothing returns nothing
		set RDamageXiaoting = GetDamageAgi(xiaoting)
		call AttackTimeReduce()
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    英雄学习技能
	*/
	//按照12345来判断
	function LearnSkillXiaotingI takes unit learner,integer whichSpell returns nothing
		local integer i
		if (learner == xiaoting) then
			if (whichSpell == 1) then
			    call UnitAddAbility(xiaoting,'A0LO')
			    call UnitAddAbility(xiaoting,'A0LP')
			    call UnitAddAbility(xiaoting,'A0LQ')
			elseif (whichSpell == 2 and IsSecondSpellOK(xiaoting) == true and GetUnitAbilityLevel(xiaoting,'A0LT') == 1) then
				//技能2初始化
			    call UnitAddAbility(xiaoting,'A0LR')
			    call UnitAddAbility(xiaoting,'A0LU')
			    call UnitAddAbility(xiaoting,'A0LS')
			elseif (whichSpell == 3 and IsThirdSpellOK(xiaoting) == true and GetUnitAbilityLevel(xiaoting,'A0LY') == 1) then
				call InitXiaotingAura()
				call AddSpecialEffectTargetUnitBJ("origin",xiaoting,"war3mapImported\\oakaura.mdx")
			    call UnitAddAbility(xiaoting,'A0LV')
			    call UnitAddAbility(xiaoting,'A0LW')
			    call UnitAddAbility(xiaoting,'A0LX')
			elseif (whichSpell == 4 and IsFourthSpellOK(xiaoting) == true and GetUnitAbilityLevel(xiaoting,'A0LZ') == 1) then
			    call UnitAddAbility(xiaoting,'A0M0')
			    call UnitAddAbility(xiaoting,'A0M1')
			    call UnitAddAbility(xiaoting,'A0M2')
			elseif (whichSpell == 5 and IsFifthSpellOK(xiaoting) == true and GetUnitAbilityLevel(xiaoting,'A0M3') == 1) then
			endif
		endif
	endfunction
	function LearnSkillXiaoting takes unit learner,integer learnSpellID returns nothing
		if (learner == xiaoting) then
			if (learnSpellID == 'A0LN') then
				call LearnSkillXiaotingI(learner,1)
			elseif (learnSpellID == 'A0LT') then
				call LearnSkillXiaotingI(learner,2)
			elseif (learnSpellID == 'A0LY') then
				call LearnSkillXiaotingI(learner,3)
			elseif (learnSpellID == 'A0LZ') then
				call LearnSkillXiaotingI(learner,4)
			elseif (learnSpellID == 'A0M3') then
				call LearnSkillXiaotingI(learner,5)
			endif
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    初始化新英雄,选取时调用
	*/
	function InitXiaoting takes unit u returns nothing
		set xiaoting = u
		//主英雄技能
		set TSpellXiaoting = CreateTrigger()
	    call TriggerRegisterUnitEvent(TSpellXiaoting,u,EVENT_UNIT_SPELL_EFFECT)
	    call TriggerAddAction(TSpellXiaoting, function TSpellXiaotingAct)
	    //刷新伤害
	    call TimerStart(CreateTimer(),1,true,function FlashXiaotingDamage)
	    set TAttackXT = CreateTrigger()
	    call TriggerRegisterAnyUnitEventBJ(TAttackXT,EVENT_PLAYER_UNIT_ATTACKED)
	    call TriggerAddCondition(TAttackXT, Condition(function TAttackXTCon))
	    call TriggerAddAction(TAttackXT, function TAttackXTAct)
	    set TComboAdd = CreateTimer()
	    set TFenlie = CreateTimer()
	    //初始化技能状态
		call SetPlayerAbilityAvailable(GetOwningPlayer(xiaoting),'A0LO',false)
		call SetPlayerAbilityAvailable(GetOwningPlayer(xiaoting),'A0LP',false)
		call SetPlayerAbilityAvailable(GetOwningPlayer(xiaoting),'A0LQ',false)
		call SetPlayerAbilityAvailable(GetOwningPlayer(xiaoting),'A0LR',false)
		call SetPlayerAbilityAvailable(GetOwningPlayer(xiaoting),'A0LU',false)
		call SetPlayerAbilityAvailable(GetOwningPlayer(xiaoting),'A0LS',false)
		call SetPlayerAbilityAvailable(GetOwningPlayer(xiaoting),'A0LV',false)
		call SetPlayerAbilityAvailable(GetOwningPlayer(xiaoting),'A0LW',false)
		call SetPlayerAbilityAvailable(GetOwningPlayer(xiaoting),'A0LX',false)
		call SetPlayerAbilityAvailable(GetOwningPlayer(xiaoting),'A0M0',false)
		call SetPlayerAbilityAvailable(GetOwningPlayer(xiaoting),'A0M1',false)
		call SetPlayerAbilityAvailable(GetOwningPlayer(xiaoting),'A0M2',false)
		call SetPlayerAbilityAvailable(GetOwningPlayer(xiaoting),'A0LK',false)
		call SetPlayerAbilityAvailable(GetOwningPlayer(xiaoting),'A0LL',false)
		call SetPlayerAbilityAvailable(GetOwningPlayer(xiaoting),'A0LM',false)
		//箭分裂的上限
		set IMaxCombo = 4
		//科技
		call SetShe1Tech()
	endfunction
endlibrary
library_once Juexing initializer InitJuexing requires LHBase,Moqi,Seyu,Mengji,Xinglong,Huanyi,Lichi,Xiaoting
//---------------------------------------------------------------------------------------------------
	/*
	    天赋禁用
	*/
	function ForbidTianfu takes nothing returns nothing
		local integer i = 1
		set BTianfu = true
		loop
			exitwhen i > 6
			if ((GetPlayerSlotState(ConvertedPlayer(i)) == PLAYER_SLOT_STATE_PLAYING) and (GetPlayerController(ConvertedPlayer(i)) == MAP_CONTROL_USER)) then
				call UnitAddAbility(udg_H[i],'A0KK')
				if (udg_H[i] == Huanyi) then
					call SetPlayerAbilityAvailable(ConvertedPlayer(i),ICurrentSpell,false)
				elseif (udg_H[i] == mengji) then
					call SetPlayerAbilityAvailable(ConvertedPlayer(i),'A0GX',false)
					call SetPlayerAbilityAvailable(ConvertedPlayer(i),'A0GY',false)
				elseif (udg_H[i] == xiaoting) then
					call SetPlayerAbilityAvailable(ConvertedPlayer(i),'A0LK',false)
					call SetPlayerAbilityAvailable(ConvertedPlayer(i),'A0LL',false)
					call SetPlayerAbilityAvailable(ConvertedPlayer(i),'A0LM',false)
					call SetPlayerAbilityAvailable(ConvertedPlayer(i),'A0LJ',false)
				else
					call SetPlayerAbilityAvailable(ConvertedPlayer(i),GetHeroTianFu(udg_H[i]),false)
				endif
			endif
			set i = i +1
		endloop
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    天赋允许
	*/
	function AllowTianfu takes nothing returns nothing
		local integer i = 1
		set BTianfu = false
		loop
			exitwhen i > 6
			if ((GetPlayerSlotState(ConvertedPlayer(i)) == PLAYER_SLOT_STATE_PLAYING) and (GetPlayerController(ConvertedPlayer(i)) == MAP_CONTROL_USER)) then
				call UnitRemoveAbility(udg_H[i],'A0KK')
				if (udg_H[i] == Huanyi) then
					call SetPlayerAbilityAvailable(ConvertedPlayer(i),ICurrentSpell,true)
				elseif (udg_H[i] == mengji) then
					call SetPlayerAbilityAvailable(ConvertedPlayer(i),'A0GX',true)
					call SetPlayerAbilityAvailable(ConvertedPlayer(i),'A0GY',true)
				elseif (udg_H[i] == xiaoting) then
					if (ISpellState == 0) then
						call SetPlayerAbilityAvailable(ConvertedPlayer(i),'A0LK',true)
						call SetPlayerAbilityAvailable(ConvertedPlayer(i),'A0LL',false)
						call SetPlayerAbilityAvailable(ConvertedPlayer(i),'A0LM',false)
						call SetPlayerAbilityAvailable(ConvertedPlayer(i),'A0LJ',false)
					elseif (ISpellState == 1) then
						call SetPlayerAbilityAvailable(ConvertedPlayer(i),'A0LL',true)
						call SetPlayerAbilityAvailable(ConvertedPlayer(i),'A0LK',false)
						call SetPlayerAbilityAvailable(ConvertedPlayer(i),'A0LM',false)
						call SetPlayerAbilityAvailable(ConvertedPlayer(i),'A0LJ',false)
					elseif (ISpellState == 2) then
						call SetPlayerAbilityAvailable(ConvertedPlayer(i),'A0LM',true)
						call SetPlayerAbilityAvailable(ConvertedPlayer(i),'A0LK',false)
						call SetPlayerAbilityAvailable(ConvertedPlayer(i),'A0LL',false)
						call SetPlayerAbilityAvailable(ConvertedPlayer(i),'A0LJ',false)
					elseif (ISpellState == 3) then
						call SetPlayerAbilityAvailable(ConvertedPlayer(i),'A0LJ',true)
						call SetPlayerAbilityAvailable(ConvertedPlayer(i),'A0LK',false)
						call SetPlayerAbilityAvailable(ConvertedPlayer(i),'A0LL',false)
						call SetPlayerAbilityAvailable(ConvertedPlayer(i),'A0LM',false)
					endif
				else
					call SetPlayerAbilityAvailable(ConvertedPlayer(i),GetHeroTianFu(udg_H[i]),true)
				endif
			endif
			set i = i +1
		endloop
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    循环禁用天赋
	*/
	struct TianfuForbidder
		private real IForbid
		private real IAllow
		private timer t
		static method allowTimer takes nothing returns nothing
			local thistype this = thistype[GetExpiredTimer()]
			call AllowTianfu()
			call PauseTimer(.t)
			call TimerStart(.t,.IAllow,false,function thistype.forbitTimer)
		endmethod
		static method forbitTimer takes nothing returns nothing
			local thistype this = thistype[GetExpiredTimer()]
			call ForbidTianfu()
			call PauseTimer(.t)
			call TimerStart(.t,.IForbid,false,function thistype.allowTimer)
		endmethod
		static method operator [] takes handle h returns thistype
            return YDWEGetIntegerByString("SPellBase", I2S(YDWEH2I(h)))
        endmethod
        static method operator []= takes handle h, thistype value returns nothing
            call YDWESaveIntegerByString("SPellBase", I2S(YDWEH2I(h)), value)
        endmethod
        static method flush takes handle h returns nothing
            call YDWEFlushStoredIntegerByString("SPellBase", I2S(YDWEH2I(h)))
        endmethod
        static method create takes unit caster,real forbidTime,real allowTime returns thistype
		   	local thistype this = thistype.allocate()
			set .IForbid = forbidTime
			set .IAllow = allowTime
			set .t = CreateTimer()
			set thistype[.t] = integer(this)
			call TimerStart(.t,allowTime,false,function thistype.forbitTimer)
			return this
		endmethod
		method onDestroy takes nothing returns nothing
			call thistype.flush(.t)
			call AllowTianfu()
			set .IForbid = 0
			set .IAllow = 0
			call PauseTimer(.t)
			call DestroyTimer(.t)
			set .t = null
		endmethod
	endstruct
//---------------------------------------------------------------------------------------------------
	/*
	    一段觉醒
	*/
	function InitHeroJuexing1 takes unit u returns nothing
		local integer i = GetHeroTianFu(u)
		if (JJ4 and playerName[GetConvertedPlayerId(GetOwningPlayer(u))] == "无心使者") then
			return
		endif
		call SetUnitAbilityLevel(u,i,2)
		call DisplayTextToPlayer(GetOwningPlayer(u), 0., 0., "|cFFFF66CC【消息】|r你的"+GetAbilityName(i)+"技能一阶觉醒了!")
		call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Human\\Resurrect\\ResurrectTarget.mdl", GetUnitX(u), GetUnitY(u) ))
		set BJuexing1[GetConvertedPlayerId(GetOwningPlayer(u))] = true
		if (u == seyu) then
			call JuexingSeyu1()
		elseif (u == Huanyi) then
			call UnitAddAbility(Huanyi,'A0HX')
		elseif (u == sichen) then
			call SetPlayerStateBJ( GetOwningPlayer(sichen), PLAYER_STATE_RESOURCE_FOOD_CAP, ( GetPlayerState(GetOwningPlayer(sichen), PLAYER_STATE_RESOURCE_FOOD_CAP) + 2 ) )
		elseif (u == hanshang) then
			call AddMoneyPercent(GetConvertedPlayerId(GetOwningPlayer(hanshang)),0.25)
		elseif (u == lichi) then
	    	call UnitAddAbility(lichi,'A0B9')
		elseif (u == xinglong and IsLong()) then
			call AddDamagePercent(GetConvertedPlayerId(GetOwningPlayer(xinglong)),0.2)
			call AddDefensePercent(GetConvertedPlayerId(GetOwningPlayer(xinglong)),0.1)
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    二段觉醒
	*/
	function InitHeroJuexing2 takes unit u returns nothing
		local integer i = GetHeroTianFu(u)
		if (JJ4 and playerName[GetConvertedPlayerId(GetOwningPlayer(u))] == "无心使者") then
			return
		endif
		call SetUnitAbilityLevel(u,i,3)
		call DisplayTextToPlayer(GetOwningPlayer(u), 0., 0., "|cFFFF66CC【消息】|r你的"+GetAbilityName(i)+"技能二阶觉醒了!")
		call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Human\\Resurrect\\ResurrectTarget.mdl", GetUnitX(u), GetUnitY(u) ))
		set BJuexing2[GetConvertedPlayerId(GetOwningPlayer(u))] = true
		if (u == moqi) then
			call JuexingMoqi2()
		elseif (u == seyu) then
			call JuexingSeyu2()
		elseif (u == lichi) then
			set IMaxHuanying = 5
		elseif (u == chenji) then
			call TriggerExecute( gg_trg_____________127 )
		elseif (u == sichen) then
			call SetPlayerStateBJ( GetOwningPlayer(sichen), PLAYER_STATE_RESOURCE_FOOD_CAP, ( GetPlayerState(GetOwningPlayer(sichen), PLAYER_STATE_RESOURCE_FOOD_CAP) + 2 ) )
		elseif (u == xinglong and IsLong()) then
			call AddDamagePercent(GetConvertedPlayerId(GetOwningPlayer(xinglong)),0.2)
			call AddDefensePercent(GetConvertedPlayerId(GetOwningPlayer(xinglong)),0.1)
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    三段觉醒
	*/
	function InitHeroJuexing3 takes unit u returns nothing
		local integer i = GetHeroTianFu(u)
		if (JJ4 and playerName[GetConvertedPlayerId(GetOwningPlayer(u))] == "无心使者") then
			return
		endif
		call SetUnitAbilityLevel(u,i,4)
		call DisplayTextToPlayer(GetOwningPlayer(u), 0., 0., "|cFFFF66CC【消息】|r你的"+GetAbilityName(i)+"技能三阶觉醒了!")
		call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Human\\Resurrect\\ResurrectTarget.mdl", GetUnitX(u), GetUnitY(u) ))
		set BJuexing3[GetConvertedPlayerId(GetOwningPlayer(u))] = true
		if (u == kaisa) then
			call AddStrPercentImme(GetConvertedPlayerId(GetOwningPlayer(kaisa)),0.5)
		elseif (u == yanmie) then
			call AddAgiPercentImme(GetConvertedPlayerId(GetOwningPlayer(yanmie)),0.4)
		elseif (u == bajue) then
			call AddStrPercentImme(GetConvertedPlayerId(GetOwningPlayer(bajue)),0.6)
		elseif (u == xiaoyue) then
			call UnitAddAbility(gg_unit_h00K_0254,'A0IN')
		elseif (u == lingxue) then
			call AddIntPercentImme(GetConvertedPlayerId(GetOwningPlayer(lingxue)),1)
		elseif (u == sheyan) then
			call AddIntPercentImme(GetConvertedPlayerId(GetOwningPlayer(sheyan)),0.4)
		elseif (u == Heiyan) then
			call AddSpellPercent(GetConvertedPlayerId(GetOwningPlayer(Heiyan)),1)
		elseif (u == cangling) then
			call AddHP(cangling,40000000)
		elseif (u == mengji) then
			call RuohuanmengChatBack()
		elseif (u == sichen) then
			call SetPlayerStateBJ( GetOwningPlayer(sichen), PLAYER_STATE_RESOURCE_FOOD_CAP, ( GetPlayerState(GetOwningPlayer(sichen), PLAYER_STATE_RESOURCE_FOOD_CAP) + 2 ) )
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    取消觉醒
	*/
	private function CancelJuexing takes unit u returns nothing
		local integer i = GetHeroTianFu(u)
		if (JJ4 and playerName[GetConvertedPlayerId(GetOwningPlayer(u))] == "无心使者") then
			return
		endif
		call SetUnitAbilityLevel(u,i,1)
		call DisplayTextToPlayer(GetOwningPlayer(u), 0., 0., "|cFFFF66CC【消息】|r你的"+GetAbilityName(i)+"技能觉醒失效了!")
		call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Human\\Resurrect\\ResurrectTarget.mdl", GetUnitX(u), GetUnitY(u) ))
		if (u == sichen) then
			if (BJuexing3[GetConvertedPlayerId(GetOwningPlayer(sichen))]) then
				call SetPlayerStateBJ( GetOwningPlayer(sichen), PLAYER_STATE_RESOURCE_FOOD_CAP, ( GetPlayerState(GetOwningPlayer(sichen), PLAYER_STATE_RESOURCE_FOOD_CAP) - 2 ) )
			endif
			if (BJuexing2[GetConvertedPlayerId(GetOwningPlayer(sichen))]) then
				call SetPlayerStateBJ( GetOwningPlayer(sichen), PLAYER_STATE_RESOURCE_FOOD_CAP, ( GetPlayerState(GetOwningPlayer(sichen), PLAYER_STATE_RESOURCE_FOOD_CAP) - 2 ) )
			endif
			if (BJuexing1[GetConvertedPlayerId(GetOwningPlayer(sichen))]) then
				call SetPlayerStateBJ( GetOwningPlayer(sichen), PLAYER_STATE_RESOURCE_FOOD_CAP, ( GetPlayerState(GetOwningPlayer(sichen), PLAYER_STATE_RESOURCE_FOOD_CAP) - 2 ) )
			endif
		endif
		if (u == xinglong and IsLong()) then
			if (BJuexing1[GetConvertedPlayerId(GetOwningPlayer(sichen))]) then
				call AddDamagePercent(GetConvertedPlayerId(GetOwningPlayer(xinglong)),-0.2)
				call AddDefensePercent(GetConvertedPlayerId(GetOwningPlayer(xinglong)),-0.1)
			endif
			if (BJuexing2[GetConvertedPlayerId(GetOwningPlayer(sichen))]) then
				call AddDamagePercent(GetConvertedPlayerId(GetOwningPlayer(xinglong)),-0.2)
				call AddDefensePercent(GetConvertedPlayerId(GetOwningPlayer(xinglong)),-0.1)
			endif
		endif
		if (u == kaisa and BJuexing3[GetConvertedPlayerId(GetOwningPlayer(kaisa))]) then
			call AddStrPercentImme(GetConvertedPlayerId(GetOwningPlayer(kaisa)),-0.5)
		elseif (u == yanmie and BJuexing3[GetConvertedPlayerId(GetOwningPlayer(yanmie))]) then
			call AddAgiPercentImme(GetConvertedPlayerId(GetOwningPlayer(yanmie)),-0.4)
		elseif (u == bajue and BJuexing3[GetConvertedPlayerId(GetOwningPlayer(bajue))]) then
			call AddStrPercentImme(GetConvertedPlayerId(GetOwningPlayer(bajue)),-0.6)
		elseif (u == xiaoyue and BJuexing3[GetConvertedPlayerId(GetOwningPlayer(xiaoyue))]) then
			call UnitRemoveAbility(gg_unit_h00K_0254,'A0IN')
		elseif (u == lingxue and BJuexing3[GetConvertedPlayerId(GetOwningPlayer(lingxue))]) then
			call AddIntPercentImme(GetConvertedPlayerId(GetOwningPlayer(lingxue)),-1)
		elseif (u == sheyan and BJuexing3[GetConvertedPlayerId(GetOwningPlayer(sheyan))]) then
			call AddIntPercentImme(GetConvertedPlayerId(GetOwningPlayer(sheyan)),-0.4)
		elseif (u == Heiyan and BJuexing3[GetConvertedPlayerId(GetOwningPlayer(Heiyan))]) then
			call AddSpellPercent(GetConvertedPlayerId(GetOwningPlayer(Heiyan)),-1)
		elseif (u == cangling and BJuexing3[GetConvertedPlayerId(GetOwningPlayer(cangling))]) then
			call AddHP(cangling,-40000000)
		elseif (u == hanshang) then
			call AddMoneyPercent(GetConvertedPlayerId(GetOwningPlayer(hanshang)),-0.25)
		endif
		set BJuexing1[GetConvertedPlayerId(GetOwningPlayer(u))] = false
		set BJuexing2[GetConvertedPlayerId(GetOwningPlayer(u))] = false
		set BJuexing3[GetConvertedPlayerId(GetOwningPlayer(u))] = false
		if (u == moqi) then
			call QJuexingMoqi()
		elseif (u == seyu) then
			call QJuexingSeyu()
		elseif (u == chenji) then
			call TriggerExecute( gg_trg_____________129 )
		elseif (u == Huanyi) then
			call UnitRemoveAbility(Huanyi,'A0HX')
		elseif (u == mengji) then
			call RuohuanmengChatBack()
		elseif (u == lichi) then
	    	call UnitRemoveAbility(lichi,'A0B9')
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    大招
	*/
	private function CreateEffect12Yanyanhuo takes real x,real y returns nothing
		local integer i = 1
		call DestroyEffect(AddSpecialEffect("Objects\\Spawnmodels\\Other\\NeutralBuildingExplosion\\NeutralBuildingExplosion.mdl", x, y ))
		loop
			exitwhen i > 6
			call DestroyEffect(AddSpecialEffect("Objects\\Spawnmodels\\Other\\NeutralBuildingExplosion\\NeutralBuildingExplosion.mdl", YDWECoordinateX(x + 900 * CosBJ(i*60)), YDWECoordinateY(y + 900 * SinBJ(i*60)) ))
			set i = i +1
		endloop
	endfunction
	private function YanyanhuoTimer12 takes nothing returns nothing
		local timer t = GetExpiredTimer()
		local integer id = GetHandleId(t)
		local unit u = LoadUnitHandle(spellTable,id,1)
		local unit caster = LoadUnitHandle(spellTable,id,2)
		local integer index = LoadInteger(spellTable,id,3)
		if (IsUnitAliveBJ(u) or index <= 80) then
			call SaveInteger(spellTable,GetHandleId(t),3,index + 1)
			if (ModuloInteger(index,10) == 0) then
				call DamageArea(caster,GetUnitX(u), GetUnitY(u),1800,GetDamageBase(caster) * 2)
			endif
			call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Other\\Doom\\DoomDeath.mdl", YDWECoordinateX(GetUnitX(u) + (81- index) * 25 * CosBJ(index * 45)),YDWECoordinateY(GetUnitY(u) + (81- index) * 25 * SinBJ(index * 45)) ))
			call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Other\\Doom\\DoomDeath.mdl", YDWECoordinateX(GetUnitX(u) + (81- index) * 25 * CosBJ(index * (-45) + 180)),YDWECoordinateY(GetUnitY(u) * 25 + (81- index) * SinBJ(index * (-45) + 180)) ))
		else
			call CreateEffect12Yanyanhuo(GetUnitX(u), GetUnitY(u))
			call DamageArea(caster,GetUnitX(u), GetUnitY(u),1800,GetDamageBase(caster) * 5)
			call RemoveUnit(u)
			call PauseTimer(t)
			call FlushChildHashtable(spellTable,id)
			call DestroyTimer(t)
		endif
		set u = null
		set t = null
	endfunction
	function Yanyanhuo12 takes unit caster returns nothing
		local timer t = CreateTimer()
		local unit u = CreateUnit(GetOwningPlayer(caster),'h02I',GetUnitX(caster),GetUnitY(caster),0)
		call UnitApplyTimedLifeBJ( 8, 'BHwe',u )
		call UnitMakeAbilityPermanent(xinglong,true,'A0K1')
		//不断伤害
		call ImmuteDamageInterval(caster,8)
		call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Human\\Resurrect\\ResurrectCaster.mdl", GetUnitX(caster), GetUnitY(caster) ))
		call SaveUnitHandle(spellTable,GetHandleId(t),1,u)
		call SaveUnitHandle(spellTable,GetHandleId(t),2,caster)
		call SaveInteger(spellTable,GetHandleId(t),3,1)
		call AddDamagePercent(GetConvertedPlayerId(GetOwningPlayer(caster)),0.6)
		call TimerStart(t,0.1,true,function YanyanhuoTimer12)
		set t = null
		set u = null
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    装备灯的事件
	*/
	private function TDengEquitCon takes nothing returns boolean
		return (GetManipulatingUnit() == udg_H[GetConvertedPlayerId(GetOwningPlayer(GetManipulatingUnit()))]) and IsDeng(GetManipulatedItem())
	endfunction
	private function TDengEquitAct takes nothing returns nothing
		local integer i = 1
		local integer dengCount = 0
		loop
			exitwhen i > 6
			if(IsDeng(UnitItemInSlotBJ(GetTriggerUnit(),i))) then
				set dengCount = dengCount + 1
			endif
			set i = i +1
		endloop
		//如果计数君大于1则丢掉
		if (dengCount > 1) then
			call DisplayTextToPlayer(GetOwningPlayer(GetTriggerUnit()),0.,0.,"|cFFFF66CC【消息】|r你只能同时装备上一个秘境至宝！")
			call YDWEPolledWaitNull(0.01)
			call UnitRemoveItemSwapped(GetManipulatedItem(),GetTriggerUnit())
			return
		elseif (dengCount == 1) then
			if (GetDeng(GetTriggerUnit())>= 3) then
				call InitHeroJuexing1(GetTriggerUnit())
			endif
			if (GetDeng(GetTriggerUnit())>= 7) then
				call InitHeroJuexing2(GetTriggerUnit())
			endif
			if (GetDeng(GetTriggerUnit())>= 12) then
				call InitHeroJuexing3(GetTriggerUnit())
			endif
		endif
	endfunction
	private function TDengDropAct takes nothing returns nothing
		local integer i = 1
		local integer dengCount = 0
		loop
			exitwhen i > 6
			if(IsDeng(UnitItemInSlotBJ(GetTriggerUnit(),i))) then
				set dengCount = dengCount + 1
			endif
			set i = i +1
		endloop
		if (dengCount <= 1 and GetDeng(GetTriggerUnit())>= 3) then
			call CancelJuexing(GetTriggerUnit())
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	private function InitJuexing takes nothing returns nothing
		//只能同时装备一个灯
		local trigger t = CreateTrigger()
		call TriggerRegisterAnyUnitEventBJ(t,EVENT_PLAYER_UNIT_PICKUP_ITEM)
		call TriggerAddCondition(t,Condition(function TDengEquitCon))
		call TriggerAddAction(t,function TDengEquitAct)
		//丢弃灯事件
		set t =CreateTrigger()
		call TriggerRegisterAnyUnitEventBJ(t,EVENT_PLAYER_UNIT_DROP_ITEM)
		call TriggerAddCondition(t,Condition(function TDengEquitCon))
		call TriggerAddAction(t,function TDengDropAct)
		set t = null
	endfunction
endlibrary
///#include  "edit/Beast.j"
///#include  "edit/Netversion.j"
library_once PIV initializer InitPIV requires LHBase,Beast,Version,Attr,SpellBase,Juexing
	globals
		private boolean isFirst = true
		private hashtable PIVTable = InitHashtable()
		key kPIV
	    key kPIVStr
	    key kPIVPlayer
	    key kPIVPointer
	    trigger T17Wan = null
	    //信哲
	    boolean BX1 = false
	    boolean BX2 = false
	endglobals
//---------------------------------------------------------------------------------------------------
	/*
	    定制初始化
	*/
	private function XinzheCon takes nothing returns boolean
		return (GetIssuedOrderIdBJ() == String2OrderIdBJ("smart"))
	endfunction
	private function XinzheAct takes nothing returns nothing
		if (IsInForbitRegion(GetOrderPointX(),GetOrderPointY(),GetTriggerUnit())) then
			call IssueImmediateOrder( GetTriggerUnit(), "stop" )
	        call DisplayTextToPlayer( GetOwningPlayer(GetTriggerUnit()), 0, 0, "|cFFFF66CC【消息】|r此处禁止瞬移到达." )
	        return
		endif
		call SetUnitX(GetTriggerUnit(),GetOrderPointX())
		call SetUnitY(GetTriggerUnit(),GetOrderPointY())
		if (BX1) then
			call DamageArea(GetTriggerUnit(),GetUnitX(GetTriggerUnit()),GetUnitY(GetTriggerUnit()),600,GetDamageBase(GetTriggerUnit())*0.8)
		endif
	endfunction
	function InitXinzhe takes unit u returns nothing
		local trigger t = CreateTrigger()
    	call TriggerRegisterUnitEvent( t, u, EVENT_UNIT_ISSUED_POINT_ORDER )
		call TriggerAddCondition(t, Condition(function XinzheCon))
		call TriggerAddAction(t, function XinzheAct)
		set t = null
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    京剧
	*/
	private function JingjuCondition takes nothing returns boolean
		return GetUnitTypeId(GetFilterUnit()) == 'n006' or GetUnitTypeId(GetFilterUnit()) == 'n00Y'
	endfunction
	private function JingjuDiyuhuo takes nothing returns nothing
		call RecoverUnitHP(GetEnumUnit(),0.3)
	endfunction
	private function JingjuTimer takes nothing returns nothing
		local timer t = GetExpiredTimer()
		local integer id = GetHandleId(t)
		local unit u = LoadUnitHandle(LHTable,id,1)
		local group g = YDWEGetUnitsOfPlayerMatchingNull(GetOwningPlayer(u), Condition(function JingjuCondition))
		call RecoverUnitHP(u,0.1)
		call ForGroupBJ( g, function JingjuDiyuhuo )
		set u = null
		call DestroyGroup(g)
		set t = null
		set g = null
	endfunction
	function InitJingju takes unit u returns nothing
		local timer t = CreateTimer()
		call SaveUnitHandle(LHTable,GetHandleId(t),1,u)
		call TimerStart(t,1,true,function JingjuTimer)
		set t = null
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    列表是否含有名单
	*/
	private function TableHas takes integer i returns boolean
		return HaveSavedBoolean(PIVTable,kPIV,i)
	endfunction
//---------------------------------------------------------------------------------------------------
    /*
        获取激活码
    */
    private function GetPIVCode takes string s returns integer
        local string result = s
        local integer i = 1
        loop
            exitwhen i > 6
            set result = I2S(StringHash(result))
            set i = i +1
        endloop
        return S2I(SubStringBJ(result,2,StringLength(result)))
    endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    初始化玩家
	*/
	private function InitPlayerPIV takes player p returns nothing
		if (isFirst) then
			set isFirst = false
			set udg_I_Er_diansi[1] = udg_I_Er_diansi[1] + 2
			call BJDebugMsg("|cFFFF66CC【消息】|r你们已激活在任意难度下获得24+5+2波的特权.")
			call BJDebugMsg("|cFFFF66CC【消息】|r基地获得了额外的2次防护罩.")
		endif
		set sPIV[GetConvertedPlayerId(p)] = true
		call DisplayTextToPlayer(p, 0., 0., "|cFFFF66CC【消息】|r激活成功,你已经获得永久赞助特权，如果要关闭赞助功能,请输入-zz")
		debug call SavePIV(p,GetPIVCode(GetPlayerName(p)))
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    初始化英雄
	*/
	private function InitDingzhi takes unit u returns nothing
		if (playerName[GetConvertedPlayerId(GetOwningPlayer(u))] == "无心使者") then
			call UnitAddItemByIdSwapped('IXU1', u)
	        call SaveInteger(YDHT,GetHandleId(GetLastCreatedItem()),0xA75AD423,GetConvertedPlayerId(GetOwningPlayer(u)))
			call UnitAddItemByIdSwapped('IXU1', u)
	        call SaveInteger(YDHT,GetHandleId(GetLastCreatedItem()),0xA75AD423,GetConvertedPlayerId(GetOwningPlayer(u)))
	        call AddMoneyPercent(GetConvertedPlayerId(GetOwningPlayer(u)),5)
	        call AddMoneyPercent(GetConvertedPlayerId(GetOwningPlayer(u)),5)
	        call AddHPPercent(GetConvertedPlayerId(GetOwningPlayer(u)),2.0)
	        call AddIntPercent(GetConvertedPlayerId(GetOwningPlayer(u)),0.7)
	        call AddAgiPercent(GetConvertedPlayerId(GetOwningPlayer(u)),0.7)
	        call AddStrPercent(GetConvertedPlayerId(GetOwningPlayer(u)),0.7)
    		call SetPlayerTechResearchedSwap( 'R01K', 1 , GetOwningPlayer(u))
    		call SetPlayerTechResearchedSwap( 'R006', 1 , GetOwningPlayer(u))
    		call SetPlayerTechResearchedSwap( 'R007', 1 , GetOwningPlayer(u))
    		call SetPlayerTechResearchedSwap( 'R008', 1 , GetOwningPlayer(u))
    		call SetPlayerTechResearchedSwap( 'R009', 1 , GetOwningPlayer(u))
    		call SetPlayerTechResearchedSwap( 'R00A', 1 , GetOwningPlayer(u))
    		call SetPlayerTechResearchedSwap( 'R00B', 1 , GetOwningPlayer(u))
			call InitJingju(u)
	    	set udg_I_Jingyan[GetConvertedPlayerId(GetOwningPlayer(u))] = udg_I_Jingyan[GetConvertedPlayerId(GetOwningPlayer(u))] + 2.5
			call SetPlayerStateBJ( GetOwningPlayer(u), PLAYER_STATE_RESOURCE_FOOD_CAP, ( GetPlayerState(GetOwningPlayer(u), PLAYER_STATE_RESOURCE_FOOD_CAP) + 10 ) )
		elseif (playerName[GetConvertedPlayerId(GetOwningPlayer(u))] == "信哲大人") then
			set BGoldGongxiang[GetConvertedPlayerId(GetOwningPlayer(u))] = true
	        call AddMoneyPercent(GetConvertedPlayerId(GetOwningPlayer(u)),1.5)
	        call AddIntPercent(GetConvertedPlayerId(GetOwningPlayer(u)),1.5)
	        call AddAgiPercent(GetConvertedPlayerId(GetOwningPlayer(u)),1.5)
	        call AddStrPercent(GetConvertedPlayerId(GetOwningPlayer(u)),1.5)
	        call AddSpellPercent(GetConvertedPlayerId(GetOwningPlayer(u)),4.)
	        call UnitAddAbility(u,'A0MF')
            call UnitMakeAbilityPermanent(u,true,'A0MF')
            call UnitMakeAbilityPermanent(u,true,'A0MG')
			call SetPlayerAbilityAvailable(GetOwningPlayer(u),'A0MF',false)
			call InitXinzhe(u)
		endif
	endfunction
	function InitPIVHero takes unit u returns nothing
		debug call InitDingzhi(u)
		if (IsPIV(GetOwningPlayer(u))) then
			call UnitAddItemByIdSwapped('IXU1', u)
	        call SaveInteger(YDHT,GetHandleId(GetLastCreatedItem()),0xA75AD423,GetConvertedPlayerId(GetOwningPlayer(u)))
			call AdjustPlayerStateBJ( 8000, GetOwningPlayer(u) , PLAYER_STATE_RESOURCE_GOLD )
			call Discolor(u)
			return
		endif
		if ((not(IsPIV(GetOwningPlayer(u)))) and IsColorSpin(GetOwningPlayer(u))) then
			call Discolor(u)
		endif
		debug call GetPlatformLevelGold(GetOwningPlayer(u))
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    VIP验证
	*/
	function CertificatePIV takes player p,string vCode returns nothing
		if (vCode == null and TableHas(GetPIVCode(GetPlayerName(p)))) then
			call InitPlayerPIV(p)
			return
		endif
		if (I2S(GetPIVCode(GetPlayerName(p))) == vCode) then
			call InitPlayerPIV(p)
			return
		endif
		if (vCode != null) then
			call DisplayTextToPlayer(p, 0., 0., "|cFFFF66CC【消息】|r激活码不正确！")
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    VIP验证
	*/
    function ChatPIV takes nothing returns nothing
        local string chat = GetEventPlayerChatString()
        local string vCode = SubStringBJ(chat,2,StringLength(chat))
		call CertificatePIV(GetTriggerPlayer(),vCode)
    endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    对话框输入验证码
	*/
	private function PIVDialogClick takes nothing returns nothing
	    local dialog d = GetClickedDialogBJ()
	    local integer i = 0
	    local string s = LoadStr(PIVTable,GetHandleId(d),kPIVStr)
	    local player p = LoadPlayerHandle(PIVTable,GetHandleId(d),kPIVPlayer)
	    //验证
	    if (GetClickedButtonBJ() == LoadButtonHandle(PIVTable,GetHandleId(d),10)) then
	        call CertificatePIV(p,s)
	        call FlushChildHashtable(PIVTable,GetHandleId(d))
        	call DialogDisplay( p, d, false )
	        call DialogClear(d)
	        call DialogDestroy(d)
	        set d = null
	        set s = null
	        set p = null
	        call DestroyTrigger(GetTriggeringTrigger())
	        return
	    endif
	    //输入
	    loop
	        exitwhen i > 9
	        if (GetClickedButtonBJ() == LoadButtonHandle(PIVTable,GetHandleId(d),i)) then
	            set s = s + I2S(i)
	            call SaveStr(PIVTable,GetHandleId(d),kPIVStr,s)
	            exitwhen true
	        endif
	        set i = i +1
	    endloop
	    call DialogSetMessage( d, "激活码:"+s )
        call DialogDisplay( p, d, true )
	    set d = null
	    set s = null
	    set p = null
	endfunction
	function CreatePIVDialog takes nothing returns nothing
	    local trigger t
	    local dialog d
		if (IsPIV(GetTriggerPlayer())) then
			call DisplayTextToPlayer(GetTriggerPlayer(), 0., 0., "|cFFFF66CC【消息】|r你已激活了永久赞助权限,无须重复激活！")
			return
		endif
		if (udg_H[GetConvertedPlayerId(GetTriggerPlayer())] != null) then
			call DisplayTextToPlayer(GetTriggerPlayer(), 0., 0., "|cFFFF66CC【消息】|r激活失败,请在选择英雄前激活！")
			return
		endif
	    set t = CreateTrigger()
	    set d = DialogCreate()
	    call DialogSetMessage( d, "请从第1位开始依次输入激活码" )
	    call SaveButtonHandle(PIVTable,GetHandleId(d),0,DialogAddButton( d, "0",'0'))
	    call SaveButtonHandle(PIVTable,GetHandleId(d),1,DialogAddButton( d, "1",'1'))
	    call SaveButtonHandle(PIVTable,GetHandleId(d),2,DialogAddButton( d, "2",'2'))
	    call SaveButtonHandle(PIVTable,GetHandleId(d),3,DialogAddButton( d, "3",'3'))
	    call SaveButtonHandle(PIVTable,GetHandleId(d),4,DialogAddButton( d, "4",'4'))
	    call SaveButtonHandle(PIVTable,GetHandleId(d),5,DialogAddButton( d, "5",'5'))
	    call SaveButtonHandle(PIVTable,GetHandleId(d),6,DialogAddButton( d, "6",'6'))
	    call SaveButtonHandle(PIVTable,GetHandleId(d),7,DialogAddButton( d, "7",'7'))
	    call SaveButtonHandle(PIVTable,GetHandleId(d),8,DialogAddButton( d, "8",'8'))
	    call SaveButtonHandle(PIVTable,GetHandleId(d),9,DialogAddButton( d, "9",'9'))
	    call SaveButtonHandle(PIVTable,GetHandleId(d),10,DialogAddButton( d, "输入完毕|cffff6800(Esc)|r",512))
	    call SaveStr(PIVTable,GetHandleId(d),kPIVStr,"")
	    call SavePlayerHandle(PIVTable,GetHandleId(d),kPIVPlayer,GetTriggerPlayer())
	    call SaveInteger(PIVTable,GetHandleId(d),kPIVPointer,1)
	    call DialogDisplay( GetTriggerPlayer(), d, true )
	    call TriggerRegisterDialogEvent( t, d )
	    call TriggerAddAction(t, function PIVDialogClick)
	    set d = null
	    set t = null
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    17玩吧激活码
	*/
	function Qskc_GetL takes player l100,string str,integer l10O,integer l1O0 returns boolean
		local integer OO11=0
		local integer lI0O=0
		local integer l0O1=0
		local integer O011=0
		local integer llO0=0
		local integer ll0O= 0
		local integer O01l= 0
		local string OOll=SubStringBJ(str, 11, 9999)
		local string OOl1=SubStringBJ(str, 1, 10)
		local integer llOO=StringLength(OOll)-2
		local integer O0l1=IAbsBJ(StringHash(GetPlayerName(l100)))
		set ll0O=StringHash(OOll)
		set ll0O=ll0O+StringHash(I2S(StringLength(OOll)))
		loop
		exitwhen llO0>=StringLength(OOll)
		set ll0O=ll0O+StringHash(SubString(OOll,llO0,llO0+1))
		set O01l=S2I(SubStringBJ(R2S(IAbsBJ(ll0O)),1,2))+S2I(SubStringBJ(R2S(IAbsBJ(ll0O)),3,4))
		set llO0=llO0+1
		endloop
		if StringLength(str)<90 then
		return false
		endif
		loop
		exitwhen O011>=O01l
		set O0l1 =IAbsBJ(StringHash(I2S(O0l1)))
		set O011 = O011 + 1
		endloop
		if O0l1<$3B9ACA00 then
		set O0l1=O0l1+$3B9ACA00
		endif
		loop
		exitwhen OO11>llOO
		set lI0O=lI0O+StringHash(SubString(OOll,OO11,OO11+2))+StringHash(I2S(l0O1))
		set l0O1=l0O1+StringHash(I2S(lI0O))-StringHash(SubString(OOll,OO11,OO11+2))
		set OO11=OO11+1
		endloop
		return lI0O==l10O and l0O1==l1O0 and I2S(O0l1)==OOl1
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    新密钥验证
	*/
	function Fgetc_GetL takes player l1000,string l1OOO,integer l10OO,integer l1O00 returns boolean
		local integer OO111=0
		local integer lI0OO=0
		local integer l0O11=0
		local integer O0111=0
		local integer llO00=0
		local integer ll0OO=0
		local integer O01ll=0
		local integer O10ll=0
		local integer O1l0l=0
		local integer llOOO=0
		local string lllOO= ""
		local string ll1OO= ""
		local string array l1lOO
		local integer O0l11=IAbsBJ(StringHash(GetPlayerName(l1000)))
		local integer l11O0=IAbsBJ(StringHash(GetPlayerName(l1000)))
		local string OOl11=SubStringBJ(l1OOO, 1, 10)
		local string OOlll=SubStringBJ(l1OOO, 11, 9999)
		set l1lOO[0] = SubStringBJ(OOlll,1,3)
		set l1lOO[1] = SubStringBJ(OOlll,9,11)
		set l1lOO[2] = SubStringBJ(OOlll,16,19)
		set l1lOO[3] = SubStringBJ(OOlll,4,8)
		set l1lOO[4] = SubStringBJ(OOlll,12,15)
		set l1lOO[5] = SubStringBJ(OOlll,20,999)
		set lllOO=l1lOO[0]+l1lOO[1]+l1lOO[2]
		set ll1OO=l1lOO[3]+l1lOO[4]+l1lOO[5]
		set llOOO=StringLength(ll1OO)-2
		set ll0OO=StringHash(ll1OO)
		set ll0OO=ll0OO+StringHash(I2S(StringLength(ll1OO)))
		loop
		exitwhen llO00>=StringLength(ll1OO)
		set ll0OO=ll0OO+StringHash(SubString(ll1OO,llO00,llO00+1))
		set O01ll=S2I(SubStringBJ(I2S(IAbsBJ(ll0OO)),1,2))+S2I(SubStringBJ(I2S(IAbsBJ(ll0OO)),3,4))
		set O10ll=S2I(SubStringBJ(I2S(IAbsBJ(ll0OO)),4,5))+S2I(SubStringBJ(I2S(IAbsBJ(ll0OO)),6,7))
		set llO00=llO00+1
		endloop
		loop
		exitwhen O0111>=O01ll
		set O0l11 =IAbsBJ(StringHash(I2S(O0l11))+$77359400)
		set O0111 = O0111 + 1
		endloop
		loop
		exitwhen O1l0l>=O10ll
		set l11O0 =IAbsBJ(StringHash(I2S(l11O0))+$77359400)
		set O1l0l = O1l0l + 1
		endloop
		if O0l11<$3B9ACA00 then
		set O0l11=O0l11+$3B9ACA00
		endif
		if l11O0<$3B9ACA00 then
		set l11O0=l11O0+$3B9ACA00
		endif
		loop
		exitwhen OO111>llOOO
		set lI0OO=lI0OO+StringHash(SubString(ll1OO,OO111,OO111+2))+StringHash(I2S(l0O11))
		set l0O11=l0O11+StringHash(I2S(lI0OO))-StringHash(SubString(ll1OO,OO111,OO111+2))
		set OO111=OO111+1
		endloop
		return lI0OO==l10OO and l0O11==l1O00 and I2S(O0l11)==OOl11 and I2S(l11O0)==lllOO
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    17玩吧验证
	*/
	private function Verify17Wanba takes nothing returns nothing
	    if ((Qskc_GetL(GetTriggerPlayer(),GetEventPlayerChatString(),-117135511,628755061)) or Fgetc_GetL(GetTriggerPlayer(),GetEventPlayerChatString(),-1139053518,43777771)) then
		    if (IsPIV(GetTriggerPlayer())) then
				call DisplayTextToPlayer(GetTriggerPlayer(), 0., 0., "|cFFFF66CC【消息】|r你已激活了永久赞助权限,无须重复激活！")
				return
			endif
			if (udg_H[GetConvertedPlayerId(GetTriggerPlayer())] != null) then
				call DisplayTextToPlayer(GetTriggerPlayer(), 0., 0., "|cFFFF66CC【消息】|r激活失败,请在选择英雄前激活！")
				return
			endif
			call InitPlayerPIV(GetTriggerPlayer())
		elseif ((Fgetc_GetL(GetTriggerPlayer(),GetEventPlayerChatString(),-767946655,-1650132445))) then
			if not(DEBUG_MODE) then
				call BJDebugMsg("|cFFFF66CC【消息】|r你已激活了所有皮肤使用权限！")
				call ActivateAllSpin(GetTriggerPlayer())
			else
				call BJDebugMsg("|cFFFF66CC【消息】|rspin.")
			endif
			debug call SetSeyuSpinOK(GetTriggerPlayer())
			debug call SetXiaoyueSpinOK(GetTriggerPlayer())
			debug call SetYanmieSpinOK(GetTriggerPlayer())
			debug call SetXuanxue1SpinOK(GetTriggerPlayer())
			debug call SetTaiyaSpinOK(GetTriggerPlayer())
			debug call SetChenji1SpinOK(GetTriggerPlayer())
			debug call SetHanshang1SpinOK(GetTriggerPlayer())
			debug call SetLingxueSpinOK(GetTriggerPlayer())
			debug call SetChenji2SpinOK(GetTriggerPlayer())
			debug call SetMoqiSpinOK(GetTriggerPlayer())
			debug call SetKaisaSpinOK(GetTriggerPlayer())
			debug call SetXuanxue2SpinOK(GetTriggerPlayer())
			debug call SetBajueSpinOK(GetTriggerPlayer())
			debug call SetSheyanSpinOK(GetTriggerPlayer())
			debug call SetHuanyiSpinOK(GetTriggerPlayer())
			debug call SetSichenSpinOK(GetTriggerPlayer())
			debug call SetLichiSpinOK(GetTriggerPlayer())
			debug call SetHeiyanSpinOK(GetTriggerPlayer())
			debug call SetCanglingSpinOK(GetTriggerPlayer())
			debug call SetHanshang2SpinOK(GetTriggerPlayer())
			debug call SetXinglong1SpinOK(GetTriggerPlayer())
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    关掉赞助指令
	*/
	function CancelVIP takes player p returns nothing
	    if not(IsPIV(p)) then
			call DisplayTextToPlayer(GetTriggerPlayer(), 0., 0., "|cFFFF66CC【消息】|r你并非永久赞助,关闭失败.")
			return
		endif
		if (udg_H[GetConvertedPlayerId(p)] != null) then
			call DisplayTextToPlayer(p, 0., 0., "|cFFFF66CC【消息】|r该功能仅在选择英雄前输入有效.")
			return
		endif
		call DisplayTextToPlayer(p, 0., 0., "|cFFFF66CC【消息】|r关闭赞助功能成功.")
		set sPIV[GetConvertedPlayerId(p)] = false
		if not(hasPIV()) then
			set isFirst = true
			set udg_I_Er_diansi[1] = 1
			call BJDebugMsg("|cFFFF66CC【消息】|r你们已失去在任意难度下获得24+5波的特权.")
			call BJDebugMsg("|cFFFF66CC【消息】|r基地失去了额外的2次防护罩.")
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    初始化
	*/
	function InitAllPIV takes nothing returns nothing
		local integer i = 1
		loop
			exitwhen i > 6
			call CertificatePIV(ConvertedPlayer(i),null)
			debug if (IsSavePIV(ConvertedPlayer(i),GetPIVCode(GetPlayerName(ConvertedPlayer(i))))) then
			debug call CertificatePIV(ConvertedPlayer(i),I2S(GetPIVCode(GetPlayerName(ConvertedPlayer(i)))))
			debug endif
			set i = i +1
		endloop
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    300秒后关闭入口
	*/
	function ClosePIV takes nothing returns nothing
		call FlushParentHashtable(PIVTable)
	endfunction
//---------------------------------------------------------------------------------------------------
	private function InitPIV takes nothing returns nothing
		local integer i = 1
		local trigger t = CreateTrigger()
		loop
			exitwhen i > 6
			set sPIV[i] = false
			set i = i +1
		endloop
		call SaveBoolean(PIVTable,kPIV,560584534,true)
		//call SaveBoolean(PIVTable,kPIV,805389327,true)
		//2.64:
		call SaveBoolean(PIVTable,kPIV,1386963254,true)
		call SaveBoolean(PIVTable,kPIV,920323633,true)
		call SaveBoolean(PIVTable,kPIV,2028760546,true)
		call SaveBoolean(PIVTable,kPIV,76404545,true)
		call SaveBoolean(PIVTable,kPIV,772953595,true)
		call SaveBoolean(PIVTable,kPIV,122150585,true)
		call SaveBoolean(PIVTable,kPIV,1866394937,true)
		call SaveBoolean(PIVTable,kPIV,668865994,true)
		call SaveBoolean(PIVTable,kPIV,11465124,true)
		call SaveBoolean(PIVTable,kPIV,1483305270,true)
		call SaveBoolean(PIVTable,kPIV,89160614,true)
		call SaveBoolean(PIVTable,kPIV,416503868,true)
		call SaveBoolean(PIVTable,kPIV,366425370,true)
		call SaveBoolean(PIVTable,kPIV,24682425,true)
		call SaveBoolean(PIVTable,kPIV,838476900,true)
		call SaveBoolean(PIVTable,kPIV,21235704,true)
		call SaveBoolean(PIVTable,kPIV,259338775,true)
		call SaveBoolean(PIVTable,kPIV,1945313488,true)
		call SaveBoolean(PIVTable,kPIV,185409653,true)
		call SaveBoolean(PIVTable,kPIV,848895504,true)
		call SaveBoolean(PIVTable,kPIV,970908405,true)
		call SaveBoolean(PIVTable,kPIV,1406966725,true)
		call SaveBoolean(PIVTable,kPIV,476387019,true)
		call SaveBoolean(PIVTable,kPIV,1407806903,true)
		call SaveBoolean(PIVTable,kPIV,39350822,true)
		call SaveBoolean(PIVTable,kPIV,947015907,true)
		call SaveBoolean(PIVTable,kPIV,1524326451,true)
		call SaveBoolean(PIVTable,kPIV,1199483482,true)
		call SaveBoolean(PIVTable,kPIV,85817056,true)
		call SaveBoolean(PIVTable,kPIV,1884797690,true)
		call SaveBoolean(PIVTable,kPIV,138245006,true)
		call SaveBoolean(PIVTable,kPIV,55883798,true)
		call SaveBoolean(PIVTable,kPIV,237209239,true)
		call SaveBoolean(PIVTable,kPIV,208207478,true)
		call SaveBoolean(PIVTable,kPIV,764958705,true)
		call SaveBoolean(PIVTable,kPIV,1556955637,true)
		call SaveBoolean(PIVTable,kPIV,769983234,true)
		call SaveBoolean(PIVTable,kPIV,1018574645,true)
		call SaveBoolean(PIVTable,kPIV,1602970119,true)
		call SaveBoolean(PIVTable,kPIV,1968941945,true)
		call SaveBoolean(PIVTable,kPIV,281722192,true)
		call SaveBoolean(PIVTable,kPIV,55774054,true)
		call SaveBoolean(PIVTable,kPIV,1794669457,true)
		call SaveBoolean(PIVTable,kPIV,4775200,true)
		call SaveBoolean(PIVTable,kPIV,5934560,true)
		call SaveBoolean(PIVTable,kPIV,1556972891,true)
		call SaveBoolean(PIVTable,kPIV,1308263866,true)
		call SaveBoolean(PIVTable,kPIV,819949938,true)
		call SaveBoolean(PIVTable,kPIV,935082247,true)
		call SaveBoolean(PIVTable,kPIV,874526666,true)
		call SaveBoolean(PIVTable,kPIV,274143214,true)
		call SaveBoolean(PIVTable,kPIV,242646218,true)
		call SaveBoolean(PIVTable,kPIV,42780764,true)
		call SaveBoolean(PIVTable,kPIV,15784280,true)
		call SaveBoolean(PIVTable,kPIV,1846898150,true)
		call SaveBoolean(PIVTable,kPIV,162418494,true)
		call SaveBoolean(PIVTable,kPIV,1028656343,true)
		call SaveBoolean(PIVTable,kPIV,871412081,true)
		call SaveBoolean(PIVTable,kPIV,724251537,true)
		call SaveBoolean(PIVTable,kPIV,572061793,true)
		call SaveBoolean(PIVTable,kPIV,1562039753,true)
		call SaveBoolean(PIVTable,kPIV,27535638,true)
		call SaveBoolean(PIVTable,kPIV,2856770,true)
		call SaveBoolean(PIVTable,kPIV,29748027,true)
		call SaveBoolean(PIVTable,kPIV,78547297,true)
		call SaveBoolean(PIVTable,kPIV,1691009533,true)
		call SaveBoolean(PIVTable,kPIV,108509507,true)
		call SaveBoolean(PIVTable,kPIV,863575409,true)
		call SaveBoolean(PIVTable,kPIV,47256210,true)
		call SaveBoolean(PIVTable,kPIV,386002974,true)
		call SaveBoolean(PIVTable,kPIV,253021838,true)
		call SaveBoolean(PIVTable,kPIV,4943346,true)
		call SaveBoolean(PIVTable,kPIV,655724335,true)
		call SaveBoolean(PIVTable,kPIV,1300925723,true)
		call SaveBoolean(PIVTable,kPIV,526128524,true)
		call SaveBoolean(PIVTable,kPIV,527932086,true)
		call SaveBoolean(PIVTable,kPIV,491536351,true)
		call SaveBoolean(PIVTable,kPIV,765412438,true)
		call SaveBoolean(PIVTable,kPIV,1807059619,true)
		call SaveBoolean(PIVTable,kPIV,158219634,true)
		call SaveBoolean(PIVTable,kPIV,812702019,true)
		call SaveBoolean(PIVTable,kPIV,93444649,true)
		call SaveBoolean(PIVTable,kPIV,1652902274,true)
		call SaveBoolean(PIVTable,kPIV,42083283,true)
		call SaveBoolean(PIVTable,kPIV,79706688,true)
		call SaveBoolean(PIVTable,kPIV,81738293,true)
		call SaveBoolean(PIVTable,kPIV,3334224,true)
		call SaveBoolean(PIVTable,kPIV,705577564,true)
		call SaveBoolean(PIVTable,kPIV,1834015365,true)
		call SaveBoolean(PIVTable,kPIV,249745215,true)
		call SaveBoolean(PIVTable,kPIV,936721376,true)
		call SaveBoolean(PIVTable,kPIV,96122563,true)
		call SaveBoolean(PIVTable,kPIV,242232349,true)
		call SaveBoolean(PIVTable,kPIV,99200445,true)
		call SaveBoolean(PIVTable,kPIV,17295550,true)
		call SaveBoolean(PIVTable,kPIV,192227001,true)
		call SaveBoolean(PIVTable,kPIV,500660555,true)
		call SaveBoolean(PIVTable,kPIV,1321008731,true)
		call SaveBoolean(PIVTable,kPIV,917107829,true)
		call SaveBoolean(PIVTable,kPIV,1277254148,true)
		call SaveBoolean(PIVTable,kPIV,556905161,true)
		call SaveBoolean(PIVTable,kPIV,55162747,true)
		call SaveBoolean(PIVTable,kPIV,395306233,true)
		call SaveBoolean(PIVTable,kPIV,442043076,true)
		call SaveBoolean(PIVTable,kPIV,987238722,true)
		call SaveBoolean(PIVTable,kPIV,454437652,true)
		call SaveBoolean(PIVTable,kPIV,50731632,true)
		call SaveBoolean(PIVTable,kPIV,1088397663,true)
		call SaveBoolean(PIVTable,kPIV,1193547207,true)
		call SaveBoolean(PIVTable,kPIV,263166628,true)
		call SaveBoolean(PIVTable,kPIV,991993981,true)
		call SaveBoolean(PIVTable,kPIV,343567476,true)
		call SaveBoolean(PIVTable,kPIV,41292785,true)
		call SaveBoolean(PIVTable,kPIV,199066564,true)
		call SaveBoolean(PIVTable,kPIV,58301014,true)
		call SaveBoolean(PIVTable,kPIV,975300858,true)
		call SaveBoolean(PIVTable,kPIV,24962383,true)
		call SaveBoolean(PIVTable,kPIV,6484930,true)
		call SaveBoolean(PIVTable,kPIV,922261063,true)
		call SaveBoolean(PIVTable,kPIV,9423109,true)
		call SaveBoolean(PIVTable,kPIV,388868057,true)
		call SaveBoolean(PIVTable,kPIV,61444830,true)
		call SaveBoolean(PIVTable,kPIV,89183810,true)
		call SaveBoolean(PIVTable,kPIV,255054188,true)
		call SaveBoolean(PIVTable,kPIV,589040132,true)
		call SaveBoolean(PIVTable,kPIV,46380924,true)
		call TriggerRegisterPlayerChatEvent( t, Player(0), "##", true )
		call TriggerRegisterPlayerChatEvent( t, Player(1), "##", true )
		call TriggerRegisterPlayerChatEvent( t, Player(2), "##", true )
		call TriggerRegisterPlayerChatEvent( t, Player(3), "##", true )
		call TriggerRegisterPlayerChatEvent( t, Player(4), "##", true )
		call TriggerRegisterPlayerChatEvent( t, Player(5), "##", true )
	    call TriggerAddAction(t, function CreatePIVDialog)
	    set T17Wan = CreateTrigger()
		call TriggerRegisterPlayerChatEvent( T17Wan, Player(0), "", false )
		call TriggerRegisterPlayerChatEvent( T17Wan, Player(1), "", false )
		call TriggerRegisterPlayerChatEvent( T17Wan, Player(2), "", false )
		call TriggerRegisterPlayerChatEvent( T17Wan, Player(3), "", false )
		call TriggerRegisterPlayerChatEvent( T17Wan, Player(4), "", false )
		call TriggerRegisterPlayerChatEvent( T17Wan, Player(5), "", false )
	    call TriggerAddAction(T17Wan, function Verify17Wanba)
	    set t = null
	endfunction
endlibrary
library_once Box requires LHBase,Version,ChallangerDZ,PIV,Structs
	globals
		TextTagBind array TTBBox
	endglobals
//---------------------------------------------------------------------------------------------------
	/*
	    目前可以加3字的人
	*/
	private function Is3Size takes player p returns boolean
		if (playerName[GetConvertedPlayerId(p)] == "samwinn" or playerName[GetConvertedPlayerId(p)] == "司宸" or playerName[GetConvertedPlayerId(p)] == "雪落无痕Diana" or playerName[GetConvertedPlayerId(p)] == "天子脚下一堆坑") then
			return true
		endif
		return false
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    创建并绑定文字
	*/
	private function InitBoxWord takes player p returns nothing
		local integer index = GetConvertedPlayerId(p)
		set TTBBox[index] = TextTagBind.create(UDepot[index],50,50)
		call TTBBox[index].setContent(S3(StringLength(SBoxWord[index]) < 1,"输入-ck改头衔",SBoxWord[index]))
		call TTBBox[index].setSize(12.)
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    使用自定义指令后
	*/
	function SetDIYBoxName takes player p,string s returns nothing
		if (ModuloInteger(StringLength(s),3) == 0) then
			if ((StringLength(s) > (((DzAPI_Map_GetMapLevel(p)/10) + 2 + I3(Is3Size(p),3,0))*3))) then
				call DisplayTextToPlayer(p, 0., 0., "|cFFFF66CC【消息】|r你地图等级当前为"+I2S(DzAPI_Map_GetMapLevel(p))+"级,最多可自定义"+I2S(((DzAPI_Map_GetMapLevel(p)/10) + 2 + I3(Is3Size(p),3,0)))+"个字.")
				call DisplayTextToPlayer(p, 0., 0., "|cFFFF66CC【消息】|r每10级可以额外获得1个字.")
				return
			endif
			set SBoxWord[GetConvertedPlayerId(p)] = s
			call DisplayTextToPlayer(p, 0., 0., "|cFFFF66CC【消息】|r成功修改头衔!")
			call DzAPI_Map_StoreString( p, "SBoxWord", SBoxWord[GetConvertedPlayerId(p)] )
			if (TTBBox[GetConvertedPlayerId(p)] != 0) then
				call TTBBox[GetConvertedPlayerId(p)].setContent(SBoxWord[GetConvertedPlayerId(p)])
			endif
		else
			call DisplayTextToPlayer(p, 0., 0., "|cFFFF66CC【消息】|r头衔格式不对！不允许中英(或数字)混杂输入。")
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    技能
	*/
	function Duihuanjinbi takes nothing returns nothing
		if (GetPlayerState(GetOwningPlayer(GetTriggerUnit()), PLAYER_STATE_RESOURCE_LUMBER) >= 10) then
        	call AdjustPlayerStateBJ( -10 , GetOwningPlayer(GetTriggerUnit()) , PLAYER_STATE_RESOURCE_LUMBER )
        	call AdjustPlayerStateBJ( 10000 , GetOwningPlayer(GetTriggerUnit()) , PLAYER_STATE_RESOURCE_GOLD )
        else
        	call DisplayTextToPlayer(GetOwningPlayer(GetTriggerUnit()), 0., 0., "|cFFFF66CC【消息】|r你的木材不足.")
		endif
	endfunction
	function DuihuanMucai takes nothing returns nothing
		if (GetPlayerState(GetOwningPlayer(GetTriggerUnit()), PLAYER_STATE_RESOURCE_GOLD) >= 10000) then
        	call AdjustPlayerStateBJ( 10 , GetOwningPlayer(GetTriggerUnit()) , PLAYER_STATE_RESOURCE_LUMBER )
        	call AdjustPlayerStateBJ( -10000 , GetOwningPlayer(GetTriggerUnit()) , PLAYER_STATE_RESOURCE_GOLD )
        else
        	call DisplayTextToPlayer(GetOwningPlayer(GetTriggerUnit()), 0., 0., "|cFFFF66CC【消息】|r你的金币不足.")
		endif
	endfunction
	function Wanwuqiyuan takes nothing returns nothing
		call UnitAddItemByIdSwapped('I006', GetTriggerUnit())
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    获取对应的仓库
	*/
	private function GetBoxName takes integer i returns string
		if (i == 1) then
			return "倾雪寒晶"
		elseif (i == 2) then
			return "救死扶伤"
		elseif (i == 3) then
			return "货币达人"
		elseif (i == 4) then
			return "心寞孤客"
		elseif (i == 5) then
			return "瞬息万年"
		elseif (i == 6) then
			return "紫雷之极"
		elseif (i == 7) then
			return "万物之源"
		elseif (i == 8) then
			return "熔炎火炮"
		elseif (i == 9) then
			return "紫薇上神"
		endif
		return ""
	endfunction
	private function GetBoxCondition takes integer i returns string
		if (i == 1) then
			return "|cff33cccc(完成挑战>10%解锁)|r"
		elseif (i == 2) then
			return "|cff33cccc(完成挑战>25%解锁)|r"
		elseif (i == 3) then
			return "|cff33cccc(完成挑战>50%解锁)|r"
		elseif (i == 4) then
			return "|cff33cccc(完成挑战>75%解锁)|r"
		elseif (i == 5) then
			return "|cff33cccc(完成挑战>99%解锁)|r"
		elseif (i == 6) then
			return "|cff33cccc(地图等级大于18级解锁)|r"
		elseif (i == 7) then
			return "|cff33cccc(加入指定公会[点击查看]解锁)|r"
		elseif (i == 8) then
			return "|cff33cccc(获取赞助权限解锁)|r"
		elseif (i == 9) then
			return "|cff33cccc(击败傀儡樱乐与梵胤解锁)|r"
		endif
		return ""
	endfunction
	private function GetBoxType takes integer i returns integer
		if (i == 1) then
			return 'n01R'
		elseif (i == 2) then
			return 'n01Z'
		elseif (i == 3) then
			return 'n026'
		elseif (i == 4) then
			return 'n027'
		elseif (i == 5) then
			return 'n020'
		elseif (i == 6) then
			return 'n021'
		elseif (i == 7) then
			return 'n024'
		elseif (i == 8) then
			return 'n025'
		elseif (i == 9) then
			return 'n02D'
		endif
		return 0
	endfunction
	private function GetBoxAbility takes integer i returns integer
		if (i == 1) then
			return 'A0KW'
		elseif (i == 2) then
			return 'A0MD'
		elseif (i == 3) then
			return 'A0MY'
		elseif (i == 4) then
			return 'A0MZ'
		elseif (i == 5) then
			return 'A0MX'
		elseif (i == 6) then
			return 'Aprg'
		elseif (i == 7) then
			return 'A0N0'
		elseif (i == 8) then
			return 'A0N1'
		elseif (i == 9) then
			return 'A0N7'
		endif
		return 0
	endfunction
	private function IsBoxAccess takes player p,integer i returns boolean
		if (i == 1) then
			return IsHasCangku(p,i) or GetCompleteRate(p) >= 0.1 or GetBit(Greward[GetConvertedPlayerId(p)],1) > 0
		elseif (i == 2) then
			return IsHasCangku(p,i) or GetCompleteRate(p) >= 0.25 or GetBit(Greward[GetConvertedPlayerId(p)],2) > 0
		elseif (i == 3) then
			return IsHasCangku(p,i) or GetCompleteRate(p) >= 0.5 or GetBit(Greward[GetConvertedPlayerId(p)],5) > 0
		elseif (i == 4) then
			return IsHasCangku(p,i) or GetCompleteRate(p) >= 0.75 or GetBit(Greward[GetConvertedPlayerId(p)],6) > 0
		elseif (i == 5) then
			return IsHasCangku(p,i) or GetCompleteRate(p) >= 0.99 or GetBit(Greward[GetConvertedPlayerId(p)],3) > 0
		elseif (i == 6) then
			return IsHasCangku(p,i) or DzAPI_Map_GetMapLevel(p) >= 18 or GetBit(Greward[GetConvertedPlayerId(p)],4) > 0
		elseif (i == 7) then
			return IsHasCangku(p,i) or GetBit(Greward[GetConvertedPlayerId(p)],7) > 0
			// return IsHasCangku(p,i) or (DzAPI_Map_GetGuildName(p) == "Crainax" or DzAPI_Map_GetGuildName(p) == "大佬娱乐会所" or DzAPI_Map_GetGuildName(p) == "万劫封帝" or DzAPI_Map_GetGuildName(p) == "万劫录") or GetBit(Greward[GetConvertedPlayerId(p)],7) > 0 todo: 网易删除了这个API
		elseif (i == 8) then
			return IsHasCangku(p,i) or IsPIV(p) or GetBit(Greward[GetConvertedPlayerId(p)],8) > 0
		elseif (i >= 9) then
			return IsHasCangku(p,i)
		endif
		return false
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    切换仓库皮肤
	*/
	private function CreateNewBox takes player p,integer i returns nothing
		local integer ii = 1
		local real x = GetUnitX(UDepot[GetConvertedPlayerId(p)])
		local real y = GetUnitY(UDepot[GetConvertedPlayerId(p)])
		loop
			exitwhen ii > 6
    		call UnitRemoveItemSwapped( UnitItemInSlotBJ(UDepot[GetConvertedPlayerId(p)], ii), UDepot[GetConvertedPlayerId(p)] )
			set ii = ii +1
		endloop
		call RemoveUnit(UDepot[GetConvertedPlayerId(p)])
		set UDepot[GetConvertedPlayerId(p)] = CreateUnit(p, GetBoxType(i), x, y, 270.000)
		if (GetDiffculty() <= 8 or i >= 9) then
			call UnitAddAbility(UDepot[GetConvertedPlayerId(p)],GetBoxAbility(i))
		endif
	endfunction
	private function ChooseBoxClick takes nothing returns nothing
	    local dialog d = GetClickedDialogBJ()
	    local player p = LoadPlayerHandle(LHTable,GetHandleId(d),11)
	    local integer i = 1
	    loop
	    	exitwhen i > 9
	        if (GetClickedButtonBJ() == LoadButtonHandle(LHTable,GetHandleId(d),i)) then
				if (i == 7) then
					call DisplayTextToPlayer(p, 0., 0., "|cFFFF66CC【消息】|r加入以下这4个公会之一即可:<小可爱>Crainax/<逆苍天>大佬娱乐会所/<万劫>万劫封帝/<六界王＞万劫录。")
					call DisplayTextToPlayer(p, 0., 0., "|cFFFF66CC【备注】|r<轮回>六界联盟公会会长已经被不法手段窃取,故该公会已不属于认证轮回公会!")
				endif
	        	if (IsBoxAccess(p,i)) then
	    			call CreateNewBox(p,i)
	    			call InitBoxWord(p)
	        	endif
			endif
	    	set i = i +1
	    endloop
        call FlushChildHashtable(LHTable,GetHandleId(d))
    	call DialogDisplay( Player(0), d, false )
        call DialogClear(d)
        call DialogDestroy(d)
        set d = null
        call DestroyTrigger(GetTriggeringTrigger())
	endfunction
	function ChangeSpinDialog takes player p returns nothing
	    local trigger t = CreateTrigger()
	    local dialog d = DialogCreate()
	    local integer i = 1
	    call DialogSetMessage( d, "
	    完成挑战:("+I2S(GetAllComplete(p)) +"/"+I2S(COUNT_CHALLANGER * 3)+"="+I2S(R2I( GetCompleteRate(p)*100))+"%)"+"
	    箱子变形:" )
    	call SaveButtonHandle(LHTable,GetHandleId(d),9,DialogAddButtonBJ( d, GetBoxName(9) + S3(IsBoxAccess(p,9),"|cffff9900(已解锁)|r",GetBoxCondition(9))))
	    loop
	    	exitwhen i > 8
	    	call SaveButtonHandle(LHTable,GetHandleId(d),i,DialogAddButtonBJ( d, GetBoxName(i) + S3(IsBoxAccess(p,i),"|cffff9900(已解锁)|r",GetBoxCondition(i))))
	    	set i = i +1
	    endloop
    	call SaveButtonHandle(LHTable,GetHandleId(d),10,DialogAddButton( d, "取消|cffff6800(Esc)|r",512))
    	call SavePlayerHandle(LHTable,GetHandleId(d),11,p)
	    call DialogDisplay( p, d, true )
	    call TriggerRegisterDialogEvent( t, d )
	    call TriggerAddAction(t, function ChooseBoxClick)
	    set d = null
	    set t = null
	endfunction
//---------------------------------------------------------------------------------------------------
endlibrary
library_once Battle initializer InitBattle requires LHBase,Diffculty
	globals
		boolean array BSkip
	endglobals
//---------------------------------------------------------------------------------------------------
	/*
	    开启极速模式
	*/
	function TStartFastMonsterAct takes nothing returns nothing
		local integer i = 1
		if (GetItemTypeId(GetSoldItem()) == 'I04P') then
			set BSkip[GetConvertedPlayerId(GetOwningPlayer(GetBuyingUnit()))] = true
	        call PingMinimap( 8189.00, 1461, 8.00 )
			loop
				exitwhen i > 6
				if ((GetPlayerSlotState(ConvertedPlayer(i)) == PLAYER_SLOT_STATE_PLAYING) and (GetPlayerController(ConvertedPlayer(i)) == MAP_CONTROL_USER)) then
					if (BSkip[i]) then
	    				call BJDebugMsg("|cFFFF66CC【消息】|r"+GetUnitName(udg_H[i])+"打开了急速出怪的开关,需要全员打开才能急速出怪！")
	    			else
	    				call BJDebugMsg("|cFFFF66CC【消息】|r"+GetUnitName(udg_H[i])+"还未打开急速出怪的开关,需要全员打开才能急速出怪！")
					endif
				endif
				set i = i +1
			endloop
		endif
	    if ((GetItemTypeId(GetSoldItem()) == 'ssan')) then
	        call SetUnitUserData( gg_unit_ndrz_0019, 1 )
	        call DisplayTextToForce( GetPlayersAll(), "|cFFFF66CC【消息】|r出怪间隔被调整成了1s。|cffffff00（此时很危险！）|r" )
	    endif
	    if ((GetItemTypeId(GetSoldItem()) == 'sreg')) then
	        call SetUnitUserData( gg_unit_ndrz_0019, 2 )
	        call DisplayTextToForce( GetPlayersAll(), "|cFFFF66CC【消息】|r出怪间隔被调整成了2s。|cffffff00（此时较危险！）|r" )
	    endif
	    if ((GetItemTypeId(GetSoldItem()) == 'stwp')) then
	        call SetUnitUserData( gg_unit_ndrz_0019, 3 )
	        call DisplayTextToForce( GetPlayersAll(), "|cFFFF66CC【消息】|r出怪间隔被调整成了3s。" )
	    endif
	    if ((GetItemTypeId(GetSoldItem()) == 'mcri')) then
	        call SetUnitUserData( gg_unit_ndrz_0019, 4 )
	        call DisplayTextToForce( GetPlayersAll(), "|cFFFF66CC【消息】|r出怪间隔被调整成了4s。" )
	    endif
	    if ((GetItemTypeId(GetSoldItem()) == 'pnvl')) then
	        call SetUnitUserData( gg_unit_ndrz_0019, 5 )
	        call DisplayTextToForce( GetPlayersAll(), "|cFFFF66CC【消息】|r出怪间隔被调整成了5s。|cffffff00（此时较安全。）|r" )
	    endif
	    if ((GetItemTypeId(GetSoldItem()) == 'pclr')) then
	        call SetUnitUserData( gg_unit_ndrz_0019, 6 )
	        call DisplayTextToForce( GetPlayersAll(), "|cFFFF66CC【消息】|r出怪间隔被调整成了6s。|cffffff00（此时很安全。）|r" )
	    endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    是否是极速模式
	*/
	private function IsFastly takes nothing returns boolean
		local integer i = 1
		local integer count = 0
		loop
			exitwhen i > 6
			if ((GetPlayerSlotState(ConvertedPlayer(i)) == PLAYER_SLOT_STATE_PLAYING) and (GetPlayerController(ConvertedPlayer(i)) == MAP_CONTROL_USER) and BSkip[i]) then
				set count = count + 1
			endif
			set i = i +1
		endloop
		return count >= udg_RENSHU
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    战斗调整
	*/
	function GetMonsterSpeed takes nothing returns real
		if (IsFastly()) then
			return 3.
		endif
		return I2R(GetUnitUserData(gg_unit_ndrz_0019))
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    刷怪数量
	*/
	function GetFastMonsterCount takes integer i returns integer
		if (IsFastly() or CT5()) then
			return i/3
		endif
		return CModeH(i,i/2)
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    两波间隔
	*/
	function GetBoSpeed takes nothing returns real
		if (IsFastly() or (IsKuanghuan() and IsTianyan and udg_Bo >= 8)) then
			return 51.
		else
			return RCModeH(300.,150.)
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    傀儡时间
	*/
	function GetWangSpeed takes nothing returns real
		//return 60.
		if (IsFastly()) then
			return 60.
		else
			return 420.
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    初始化
	*/
	private function InitBattle takes nothing returns nothing
		local integer i = 1
    	local trigger t = CreateTrigger()
		loop
			exitwhen i > 6
			set BSkip[i] = false
			if ((GetPlayerSlotState(ConvertedPlayer(i)) == PLAYER_SLOT_STATE_PLAYING) and GetPlayerController(ConvertedPlayer(i)) == MAP_CONTROL_USER) then
				set BSkip[i] = false
			endif
			set i = i +1
		endloop
	    call TriggerRegisterAnyUnitEventBJ( t, EVENT_PLAYER_UNIT_SELL_ITEM )
	    call TriggerAddAction(t, function TStartFastMonsterAct)
	    set t = null
	endfunction
endlibrary
///#include  "edit/NetVersion.j"
library_once Boss initializer InitBoss requires LHBase,SpellBase,Attr,Diffculty,Juexing,Battle,Version
	globals
		/*
		    哈希表
		*/
		hashtable bossTable = null
		private trigger TSpellZuo = null
		private trigger TSpellYou = null
		/*
		    导弹计时器
		*/
		private timer TiMissile = null
		//生命联结
		timer TLifeConnect = null
		private lightning array LLifeConnect
		unit UChuanzhang = null
		unit UXiaoY = null
		MultiLife MLChuanzhang = 0
		MultiLife MLXiaoY = 0
		//落时提醒:
		private integer ILuoshi = 0
		//计时器
		timer TiRenYao
		timerdialog TiDiaRenYao
		//大肉棒的数量
		integer IRoubang = 0
		//天赋禁用器
		TianfuForbidder TFChuan = 0
		//肉棒指示器
		timer TRBChuan = null
		//触发器-判断人妖死亡状态
		private trigger TDeathRenyao = null
		//生命联结解药
		boolean BGongxiang = false
		//BOSS伤害统计
		DamageTJ DTJ1 = 0
		DamageTJ DTJ2 = 0
		DamageTJ DTJ3 = 0
		//鬼与仙
		SuperShield TShieldGhost = 0
		SuperShield TShieldAngle = 0
		unit UGhost = null
		unit UAngle = null
		MultiLife MLGhost = 0
		MultiLife MLAngle = 0
		timer TiGhostAngle = null
		timerdialog TiDiaGhostAngle = null
		trigger TSpellGhost = null
		timer TGhostShiye = null
		timer TAngleQuestion = null
		private integer IGuangmang = 0
		trigger TDeathGhostAngle = null
		timer TGhostShiye2 = null
		integer IKongshen = 0
	endglobals
//---------------------------------------------------------------------------------------------------
	/*
	    给BOSS加上只打基地的指令:挑战
	*/
	function BossAddOnlyAttack takes unit u returns boolean
		if (CT7()) then
			call OnlyAttackBase.create(u)
			return true
		endif
		return false
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    伤害统计系统
	*/
	struct DamageTJ
		private real array RTongji [7]
		private trigger t
		private unit monitor
		private static method DamageCon takes nothing returns boolean
			return GetEventDamage() > 10000000
		endmethod
		private static method DamageAct takes nothing returns nothing
			local thistype this = thistype[GetTriggeringTrigger()]
			local integer index = GetConvertedPlayerId(GetOwningPlayer(GetEventDamageSource()))
			set .RTongji[index] = .RTongji[index] + (GetEventDamage()/10000000.)
		endmethod
		//输出伤害显示
		method show takes nothing returns nothing
			local integer i = 1
			call BJDebugMsg("※※※※※※※※※※※※※※※※※※※※※※※※※※※※※※※※※※")
			call BJDebugMsg("|cffff6800【总伤害统计】|r"+GetUnitName(.monitor))
			loop
				exitwhen i > 6
				if ((GetPlayerSlotState(ConvertedPlayer(i)) == PLAYER_SLOT_STATE_PLAYING) and (GetPlayerController(ConvertedPlayer(i)) == MAP_CONTROL_USER)) then
					call BJDebugMsg(GetPlayerName(ConvertedPlayer(i)) +":" + R2S(.RTongji[i] / 10) +"亿伤害。")
				endif
				set i = i +1
			endloop
			call .destroy()
		endmethod
        static method operator [] takes handle h returns thistype
            return YDWEGetIntegerByString("damageTJ", I2S(YDWEH2I(h)))
        endmethod
        static method operator []= takes handle h, thistype value returns nothing
            call YDWESaveIntegerByString("damageTJ", I2S(YDWEH2I(h)), value)
        endmethod
        static method flush takes handle h returns nothing
            call YDWEFlushStoredIntegerByString("damageTJ", I2S(YDWEH2I(h)))
        endmethod
		static method create takes unit monitor returns thistype
		   	local thistype this = thistype.allocate()
			local integer i = 1
			set .t = CreateTrigger()
			set .monitor = monitor
			loop
				exitwhen i > 6
				set .RTongji[i] = 0.
				set i = i +1
			endloop
			call TriggerRegisterUnitEvent(.t,monitor,EVENT_UNIT_DAMAGED)
		    call TriggerAddCondition(.t,Condition(function thistype.DamageCon))
		    call TriggerAddAction(.t,function thistype.DamageAct)
			set thistype[.t] = integer(this)
			return this
		endmethod
		method onDestroy takes nothing returns nothing
			local integer i = 1
			call thistype.flush(.t)
			set .monitor = null
			loop
				exitwhen i > 6
				set .RTongji[i] = 0
				set i = i +1
			endloop
			call DestroyTrigger(.t)
			set .t = null
		endmethod
	endstruct
//---------------------------------------------------------------------------------------------------
	/*
	    航海领域
	*/
	private function HaiHangTimer takes nothing returns nothing
		local timer t = GetExpiredTimer()
		local real x
		local real y
		local unit temp
		local integer times = IMaxBJ(1,MLChuanzhang.getTimes())
		if (IsUnitAliveBJ(UChuanzhang) or GetUnitAbilityLevel(UChuanzhang,'A0KH') > 0) then
			set x = YDWECoordinateX(GetUnitX(UChuanzhang) + GetRandomReal(-900,900))
			set y = YDWECoordinateY(GetUnitY(UChuanzhang) + GetRandomReal(-900,900))
			set temp = CreateUnit(Player(10),'h01S',x,y,GetRandomReal(0,360))
			call SetUnitAbilityLevel(temp,'A0KI',udg_Nandu_JJJ)
			call UnitApplyTimedLifeBJ( 2.50 * times, 'BHwe', temp)
			call DestroyEffect(AddSpecialEffect("Objects\\Spawnmodels\\Naga\\NagaDeath\\NagaDeath.mdl", x, y ))
		else
			call PauseTimer(t)
			call DestroyTimer(t)
		endif
		set t = null
		set temp = null
	endfunction
	function InitHanghai takes nothing returns nothing
		local timer t = CreateTimer()
		call TimerStart(t,3,true,function HaiHangTimer)
		set t = null
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    计时秒杀
	*/
	private function TimerStoneKaipaoTimer takes nothing returns nothing
		local timer t = GetExpiredTimer()
		local integer id = GetHandleId(t)
		local group l_group = CreateGroup()
		local unit l_unit
		call GroupEnumUnitsInRange(l_group, LoadReal(LHTable,GetHandleId(t),1), LoadReal(LHTable,GetHandleId(t),2), 300, null)
		loop
		    set l_unit = FirstOfGroup(l_group)
		    exitwhen l_unit == null
		    call GroupRemoveUnit(l_group, l_unit)
		    if(IsEnemyM(l_unit,UXiaoY)) then
		    	call UnitDamageTarget( UXiaoY, l_unit, GetUnitState(l_unit,UNIT_STATE_MAX_LIFE)*2, false, true, ATTACK_TYPE_CHAOS, DAMAGE_TYPE_SLOW_POISON, WEAPON_TYPE_WHOKNOWS )
		    endif
		endloop
		call DestroyGroup(l_group)
		set l_group = null
		set l_unit =null
		call PauseTimer(t)
		call FlushChildHashtable(LHTable,id)
		call DestroyTimer(t)
		set t = null
	endfunction
	private function TimerStoneKaipao takes unit u returns nothing
		local timer t = CreateTimer()
		call SaveReal(LHTable,GetHandleId(t),1,GetUnitX(u))
		call SaveReal(LHTable,GetHandleId(t),2,GetUnitY(u))
		call DestroyEffect(AddSpecialEffect("Units\\Demon\\Infernal\\InfernalBirth.mdl", GetUnitX(u),GetUnitY(u) ))
		call TimerStart(t,1,false,function TimerStoneKaipaoTimer)
		set t = null
	endfunction
	private function TimerStoneKill takes nothing returns nothing
		local timer t = GetExpiredTimer()
		local integer i = 1
		if (IsUnitAliveBJ(UXiaoY) or GetUnitAbilityLevel(UXiaoY,'A0KH') > 0) then
			set ILuoshi = ILuoshi - 1
			if (ILuoshi > 3) then
				set t = null
				return
			endif
			loop
				exitwhen i > 6
	            if ((GetPlayerSlotState(ConvertedPlayer(i)) == PLAYER_SLOT_STATE_PLAYING) and (GetPlayerController(ConvertedPlayer(i)) == MAP_CONTROL_USER) and udg_H[i] != null) then
	            	if (ILuoshi <= 0) then
	            		call TimerStoneKaipao(udg_H[i])
	            	else
	    				call CreateSpellTextTag("落石:"+I2S(ILuoshi)+"s",udg_H[i],100,0,0,2)
        				call PlaySoundBJ(gg_snd_Clock)
	            	endif
            	endif
				set i = i +1
			endloop
        	if (ILuoshi <= 0) then
				set ILuoshi = 15 - NanDiff * 2
			endif
		else
			set ILuoshi = 0
			call PauseTimer(t)
			call DestroyTimer(t)
		endif
		set t = null
	endfunction
	function InitTimerStoneKill takes nothing returns nothing
		local timer t = CreateTimer()
		set ILuoshi = 15 - NanDiff * 2
		call TimerStart(t,1,true,function TimerStoneKill)
		set t = null
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    法伤变负
	*/
	private function StartFashangTimer takes nothing returns nothing
		local timer t = GetExpiredTimer()
		local integer id = GetHandleId(t)
		local integer playerID = LoadInteger(LHTable,id,1)
		local real value = LoadReal(LHTable,id,2)
		call AddSpellPercent(playerID,value)
		call DisplayTextToPlayer(ConvertedPlayer(playerID), 0., 0., "|cffff0000【注意】你的法伤恢复了,可以正常使用技能了!|r")
		call DisplayTextToPlayer(ConvertedPlayer(playerID), 0., 0., "|cffff0000【注意】你的法伤恢复了,可以正常使用技能了!|r")
		call DisplayTextToPlayer(ConvertedPlayer(playerID), 0., 0., "|cffff0000【注意】你的法伤恢复了,可以正常使用技能了!|r")
		call PauseTimer(t)
		call FlushChildHashtable(LHTable,id)
		call DestroyTimer(t)
		set t = null
	endfunction
	private function StartFashang takes integer playerID returns nothing
		local timer t = null
		if (udg_I_Jinengjiacheng[playerID] <= 0) then
			return
		endif
		set t = CreateTimer()
		call SaveInteger(LHTable,GetHandleId(t),1,playerID)
		call SaveReal(LHTable,GetHandleId(t),2,2 * udg_I_Jinengjiacheng[playerID])
		call AddSpellPercent(playerID,-2 * udg_I_Jinengjiacheng[playerID])
		call DisplayTextToPlayer(ConvertedPlayer(playerID), 0., 0., "|cffff0000【注意】你的法伤变成了负数状态,请谨慎使用技能!|r")
		call DisplayTextToPlayer(ConvertedPlayer(playerID), 0., 0., "|cffff0000【注意】你的法伤变成了负数状态,请谨慎使用技能!|r")
		call DisplayTextToPlayer(ConvertedPlayer(playerID), 0., 0., "|cffff0000【注意】你的法伤变成了负数状态,请谨慎使用技能!|r")
		call TimerStart(t,2*udg_Nandu_JJJ,true,function StartFashangTimer)
		set t = null
	endfunction
	private function FashangfuTimer takes nothing returns nothing
		local timer t = GetExpiredTimer()
		local integer id = GetHandleId(t)
		local group l_group = null
		local unit l_unit = null
    	call CreateUnitEffect(Player(11),'h01M',GetUnitX(UXiaoY),GetUnitY(UXiaoY),0)
		call CreateSpellTextTag("1800范围法伤皆负!",UXiaoY,100,0,0,4)
		if (IsUnitAliveBJ(UXiaoY) or GetUnitAbilityLevel(UXiaoY,'A0KH') > 0) then
			set l_group = CreateGroup()
			call GroupEnumUnitsInRange(l_group, GetUnitX(UXiaoY),GetUnitY(UXiaoY), 1800, null)
			loop
			    set l_unit = FirstOfGroup(l_group)
			    exitwhen l_unit == null
			    call GroupRemoveUnit(l_group, l_unit)
			    if (udg_H[GetConvertedPlayerId(GetOwningPlayer(l_unit))] == l_unit) then
			    	call StartFashang(GetConvertedPlayerId(GetOwningPlayer(l_unit)))
			    endif
			endloop
			call DestroyGroup(l_group)
			set l_group = null
			set l_unit =null
		else
			call PauseTimer(t)
			call FlushChildHashtable(spellTable,id)
			call DestroyTimer(t)
		endif
		set t = null
	endfunction
	function InitFashangfuTimer takes nothing returns nothing
		local timer t = CreateTimer()
		call TimerStart(t,20,true,function FashangfuTimer)
		set t = null
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    生命联结
	*/
	function InitConnectLine takes nothing returns nothing
		local integer i = 1
		local unit temp = null
		loop
			exitwhen i > 6
			if ((GetPlayerSlotState(ConvertedPlayer(i)) == PLAYER_SLOT_STATE_PLAYING) and (GetPlayerController(ConvertedPlayer(i)) == MAP_CONTROL_USER) and udg_H[i] != null) then
				if (temp != null) then
					set LLifeConnect[i-1] = AddLightning( "HWPB", true , GetUnitX(temp),GetUnitY(temp),GetUnitX(udg_H[i]),GetUnitY(udg_H[i]))
				endif
				set temp = udg_H[i]
			endif
			set i = i +1
		endloop
		set temp = null
	endfunction
	//删除生命连结
	function DestroyConnection takes nothing returns nothing
		local integer i = 1
		loop
			exitwhen i > 6
			if (LLifeConnect[i] != null) then
				call DestroyLightningBJ(LLifeConnect[i])
			endif
			set i = i +1
		endloop
		call PauseTimer(TLifeConnect)
		call DestroyTimer(TLifeConnect)
		set TLifeConnect = null
		set BGongxiang = false
	endfunction
	private function LifeConnectTimer takes nothing returns nothing
		local integer i = 1
		local unit temp = null
		if (IsUnitAliveBJ(UXiaoY) or GetUnitAbilityLevel(UXiaoY,'A0KH') > 0) then
			loop
				exitwhen i > 6
				if ((GetPlayerSlotState(ConvertedPlayer(i)) == PLAYER_SLOT_STATE_PLAYING) and (GetPlayerController(ConvertedPlayer(i)) == MAP_CONTROL_USER) and udg_H[i] != null) then
					if (temp != null) then
	    				call MoveLightning( LLifeConnect[i-1],true, GetUnitX(temp),GetUnitY(temp),GetUnitX(udg_H[i]),GetUnitY(udg_H[i]) )
					endif
					set temp = udg_H[i]
				endif
				set i = i +1
			endloop
			set temp = null
		else
			call DestroyConnection()
		endif
	endfunction
	//一起死吧~
	function DieTogether takes nothing returns nothing
		local integer i = 1
		loop
			exitwhen i > 6
			if ((GetPlayerSlotState(ConvertedPlayer(i)) == PLAYER_SLOT_STATE_PLAYING) and (GetPlayerController(ConvertedPlayer(i)) == MAP_CONTROL_USER) and udg_H[i] != null and IsUnitAliveBJ(udg_H[i])) then
				call UnitDamageTarget( GetKillingUnitBJ(), udg_H[i], GetUnitState(udg_H[i],UNIT_STATE_MAX_LIFE) * 2, false, true, ATTACK_TYPE_CHAOS, DAMAGE_TYPE_SLOW_POISON, WEAPON_TYPE_WHOKNOWS )
			endif
			set i = i +1
		endloop
		call BJDebugMsg("|cFFFF66CC【消息】|r由于受到生命共享的影响,你们所有英雄受到了致死伤害.")
		debug set BShengming = true
	endfunction
	//开始联结之路
	function StartLifeConnect takes nothing returns nothing
		if (udg_RENSHU < 2) then
			return
		endif
		set TLifeConnect = CreateTimer()
		call InitConnectLine()
		call TimerStart(TLifeConnect,0.05,true,function LifeConnectTimer)
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    瞬闪攻击
	*/
	private function GetFocusTarget takes nothing returns unit
		local integer i = 1
		loop
			exitwhen i > 6
			if (udg_H[i] != null and IsEnemyMP(udg_H[i],Player(10))) then
				return udg_H[i]
			endif
			set i = i +1
		endloop
		return null
	endfunction
    private function FlashHeroLocation takes nothing returns nothing
        local timer t = GetExpiredTimer()
        local unit target = null
        if (UGhost != null) then
            set target = U3(GetFocusTarget() != null,GetFocusTarget(),gg_unit_haro_0030)
            call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\NightElf\\Blink\\BlinkTarget.mdl", GetUnitX(UGhost),GetUnitY(UGhost) ))
            call SetUnitX(UGhost,GetUnitX(target))
            call SetUnitY(UGhost,GetUnitY(target))
            call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\NightElf\\Blink\\BlinkTarget.mdl", GetUnitX(UGhost),GetUnitY(UGhost) ))
            if (target != gg_unit_haro_0030) then
            	call IssueTargetOrder(UGhost,"attack",target)
            else
            	call IssuePointOrderLocBJ(UGhost,"attack",udg_Point_Fuhuo)
            endif
        else
            call PauseTimer(t)
            call DestroyTimer(t)
        endif
        set t = null
    endfunction
	function InitShunshan takes nothing returns nothing
		local timer t = CreateTimer()
		call TimerStart(t,5,true,function FlashHeroLocation)
		set t = null
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    视野无效化
	*/
	private function GetShiyanCon takes nothing returns boolean
		local integer i = 1
		local integer count = 0
		loop
			exitwhen i > 6
			if (YDWEUnitHasItemOfTypeBJNull(udg_H[i],'I05U')) then
				set count = count + 1
			endif
			set i = i +1
		endloop
		set count = count - I3(IsTianyan,3,0)
		return GetRandomInt(1,udg_RENSHU) <= count
	endfunction
	private function ShiyeLiangTimer takes nothing returns nothing
		call CinematicFadeBJ( bj_CINEFADETYPE_FADEIN, 2, "ReplaceableTextures\\CameraMasks\\Black_mask.blp", 0, 0, 0, 0 )
		call PauseTimer(TGhostShiye2)
		call DestroyTimer(TGhostShiye2)
		set TGhostShiye2 = null
	endfunction
	private function ShiyeAnTimer takes nothing returns nothing
		if not(GetShiyanCon()) then
			call CinematicFadeBJ( bj_CINEFADETYPE_FADEOUT, 2, "ReplaceableTextures\\CameraMasks\\Black_mask.blp", 0, 0, 0, 0 )
			set TGhostShiye2 = CreateTimer()
			call TimerStart(TGhostShiye2,7,false,function ShiyeLiangTimer)
			call BJDebugMsg("|cFFFF66CC【消息】|r天渐渐的暗了下来...")
		else
			call BJDebugMsg("|cFFFF66CC【消息】|r受到战法双魂-夕的照耀,天空保持着常亮.")
		endif
	endfunction
	function InitShiyeTimer takes nothing returns nothing
		set TGhostShiye = CreateTimer()
		call TimerStart(TGhostShiye,27-2*udg_Nandu_JJJ,true,function ShiyeAnTimer)
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    免疫外圈伤害
	*/
	function TSpellGhostCon takes nothing returns boolean
	    return (GetUnitDistance(GetEventDamageSource(),UGhost) > 1800. and (GetEventDamage() > 100))
	endfunction
	function TSpellGhostAct takes nothing returns nothing
		call SetUnitLifeBJ(UGhost,GetUnitState(UGhost,UNIT_STATE_LIFE)+GetEventDamage())
		if (GetRandomInt(1,5) == 1) then
    		call CreateSpellTextTag("1800范围外免疫！",UGhost,0,0,100,2)
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    提问间隔
	*/
	private function AfterQuestionSucceed takes nothing returns nothing
		if (IsUnitAliveBJ(UGhost)) then
	    	call RecoverUnitHP(UGhost,-0.1)
		endif
		if (IsUnitAliveBJ(UAngle)) then
	    	call RecoverUnitHP(UAngle,-0.1)
		endif
		debug set IKongshen = IKongshen + 1
		if (IKongshen >= 30) then
			debug call SaveAllPlayerAchievement(415)
		elseif (ModuloInteger(IKongshen,5) == 0) then
			call BJDebugMsg("|cFFFF66CC【消息】|r你们总共答对了"+I2S(IKongshen)+"道题.")
		endif
	endfunction
	private function QuestionTimer takes nothing returns nothing
		call Questions.create(ConvertedPlayer(GetNextPlayerID()),udg_Nandu_JJJ+4,5,AfterSucceed.AfterQuestionSucceed)
	endfunction
	function InitQuestionTimer takes nothing returns nothing
		set TAngleQuestion = CreateTimer()
		call TimerStart(TAngleQuestion,23-2*udg_Nandu_JJJ,true,function QuestionTimer)
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    光芒万丈
	*/
	private function GuangmangBoom2 takes nothing returns nothing
		local integer i = 1
        call KillAreaPlayerEnemy(UAngle,GetUnitX(UAngle),GetUnitY(UAngle),1000,Player(10))
        loop
        	exitwhen i > 12
                call UnitApplyTimedLifeBJ( 5, 'BHwe', CreateUnit(GetOwningPlayer(UAngle),'h00J',GetUnitX(UAngle),GetUnitY(UAngle),i* (360 / 12) ))
        	set i = i +1
        endloop
	endfunction
	private function GuangmangBoom takes nothing returns nothing
		local timer t = GetExpiredTimer()
		local integer i = 1
		if (IsUnitAliveBJ(UAngle) or GetUnitAbilityLevel(UAngle,'A0KH') > 0) then
			set IGuangmang = IGuangmang - 1
			if (IGuangmang > 3) then
				set t = null
				return
			elseif (IGuangmang == 3) then
				call UnitApplyTimedLifeBJ( 3.00, 'BHwe',CreateUnit(Player(10),'h02K',GetUnitX(UAngle),GetUnitY(UAngle),0) )
			else
				call CreateSpellTextTag("光芒:"+I2S(IGuangmang)+"s",UAngle,100,0,100,2)
			endif
			if (IGuangmang <= 0) then
				set IGuangmang = 15 - NanDiff * 2
				call GuangmangBoom2()
			endif
		else
			set IGuangmang = 0
			call PauseTimer(t)
			call DestroyTimer(t)
		endif
		set t = null
	endfunction
	function InitGuangmang takes nothing returns nothing
		local timer t = CreateTimer()
		set IGuangmang = 15 - NanDiff * 2
		call TimerStart(t,1,true,function GuangmangBoom)
		set t = null
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    英雄敌队化
	*/
	private function DestroyDiduihua takes nothing returns nothing
		local integer i = 1
		local integer j = 1
		loop
			exitwhen i > 6
			if ((GetPlayerSlotState(ConvertedPlayer(i)) == PLAYER_SLOT_STATE_PLAYING) and (GetPlayerController(ConvertedPlayer(i)) == MAP_CONTROL_USER)) then
				set j = 1
				loop
					exitwhen j > 6
					if (i != j) then
    					call SetPlayerAllianceStateBJ( ConvertedPlayer(i), ConvertedPlayer(j), bj_ALLIANCE_ALLIED )
					endif
					set j = j +1
				endloop
			endif
			set i = i +1
		endloop
	endfunction
	function InitDiduihua takes nothing returns nothing
		local integer i = 1
		local integer j = 1
		loop
			exitwhen i > 6
			if ((GetPlayerSlotState(ConvertedPlayer(i)) == PLAYER_SLOT_STATE_PLAYING) and (GetPlayerController(ConvertedPlayer(i)) == MAP_CONTROL_USER)) then
				set j = 1
				loop
					exitwhen j > 6
					if (i != j) then
    					call SetPlayerAllianceStateBJ( ConvertedPlayer(i), ConvertedPlayer(j), bj_ALLIANCE_UNALLIED )
					endif
					set j = j +1
				endloop
			endif
			set i = i +1
		endloop
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    复活后伤害
	*/
	function ReviveDamage takes unit u returns nothing
		if (UAngle != null) then
			if (not(YDWEUnitHasItemOfTypeBJNull(u,'I07K') or YDWEUnitHasItemOfTypeBJNull(u,'I07J') or YDWEUnitHasItemOfTypeBJNull(u,'I07I')) and GetRandomInt(1,2) == 1 and GetDiffculty() >= 6) then
	    		call RecoverUnitHP(u,-1.2)
	    		call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Other\\Doom\\DoomDeath.mdl", GetUnitX(u),GetUnitY(u) ))
				call CreateSpellTextTag("复活之火",u,0,100,0,2)
			endif
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	function CycleFangKa takes nothing returns nothing
		local timer t = GetExpiredTimer()
		local integer id = GetHandleId(t)
		local unit u = LoadUnitHandle(bossTable,id,1)
		local real x2 = GetUnitX(u)
		local real y2 = GetUnitY(u)
		local real x1
		local real y1
		local real distance
		local real facing
		local integer count = 0
		local group l_group = CreateGroup()
		local unit l_unit
		if (IsUnitAliveBJ(u)) then
			call GroupEnumUnitsInRange(l_group, x2, y2, 900, null)
			loop
			    set l_unit = FirstOfGroup(l_group)
			    exitwhen l_unit == null
			    call GroupRemoveUnit(l_group, l_unit)
			    if((IsUnitAliveBJ(l_unit) == true) and (GetUnitAbilityLevel(l_unit,'Avul') < 1) and (GetUnitPointValue(l_unit) != 123) and (IsUnitEnemy(l_unit, Player(11)) == true) and (not(IsTerrainPathable(GetUnitX(l_unit), GetUnitY(l_unit), PATHING_TYPE_WALKABILITY)))) then
			    	set count = count +1
			    endif
			endloop
			if(count == 0) then
		    	set x1 = GetRectCenterX(gg_rct________1)
		    	set y1 = GetRectCenterY(gg_rct________1)
		    	set distance = SquareRoot((x1-x2)*(x1-x2)+(y1-y2)*(y1-y2))
		    	if( distance > 600)then
			    	set facing = Atan2BJ(y1-y2,x1-x2)
			    	call SetUnitX(u,YDWECoordinateX(x2+CosBJ(facing)*40))
			    	call SetUnitY(u,YDWECoordinateY(y2+SinBJ(facing)*40))
		    	endif
			endif
		else
			call PauseTimer(t)
			call DestroyTimer(t)
	    	call FlushChildHashtable( bossTable, id )
		endif
		set t = null
		set u = null
		call DestroyGroup(l_group)
		set l_group = null
		set l_unit =null
	endfunction
	/*
	    防卡BOSS
	*/
	function StartFangKa takes unit fangka returns nothing
		local timer t =CreateTimer()
	    call SaveUnitHandle( bossTable, GetHandleId(t), 1, fangka )
		call TimerStart(t,0.1,true,function CycleFangKa)
		set t = null
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    左护法的一个技能,锁链
	*/
	function TSpellZuoCon takes nothing returns boolean
	    return ((IsUnitAliveBJ(GetAttackedUnitBJ()) == true) and (IsUnitIllusionBJ(GetAttackedUnitBJ()) != true) and (GetRandomInt(1, 10) == 1))
	endfunction
	function TSpellZuoAct takes nothing returns nothing
	    call DisableTrigger( GetTriggeringTrigger() )
 		call SimulateSpell(GetAttackedUnitBJ(),GetAttacker(),'AB00',udg_Nandu_JJJ,5,"magicleash",false,false,true)
	    call CreateSpellTextTag("死亡枷锁！",gg_unit_Uear_0242,100,75,0,2)
	    call YDWEPolledWaitNull(4.00)
	    call EnableTrigger( GetTriggeringTrigger() )
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    右护法的一个技能,导弹
	*/
	function TSpellYouCon takes nothing returns boolean
	    return ((IsUnitAliveBJ(GetAttackedUnitBJ()) == true) and (IsUnitIllusionBJ(GetAttackedUnitBJ()) != true) and (GetRandomInt(1, 10) == 1))
	endfunction
	function TSpellYouAct takes nothing returns nothing
	    call DisableTrigger( GetTriggeringTrigger() )
 		call SimulateSpell(GetAttackedUnitBJ(),GetAttacker(),'ANc2',udg_Nandu_JJJ,5,"clusterrockets",true,false,false)
	    call CreateSpellTextTag("异界冰封！",gg_unit_Npld_0253,25,100,25,2)
	    call YDWEPolledWaitNull(4.00)
	    call EnableTrigger( GetTriggeringTrigger() )
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    导弹
	*/
	function startMissile takes nothing returns nothing
		call Missile.create(gg_unit_Nkjx_0241,'hs01',"Units\\Demon\\Infernal\\InfernalBirth.mdl",300,1800,3,1,1000000000)
	endfunction
	function refreshMissile takes nothing returns nothing
		local real interval
		local timer t = GetExpiredTimer()
		if(IsUnitAliveBJ(gg_unit_Nkjx_0241) == true) then
			set interval = (GetUnitState(gg_unit_Nkjx_0241,UNIT_STATE_LIFE) / GetUnitState(gg_unit_Nkjx_0241,UNIT_STATE_MAX_LIFE) * 0.2) + 0.2
			call TimerStart(TiMissile,interval,true,function startMissile)
		else
			call PauseTimer(t)
			call DestroyTimer(t)
			call PauseTimer(TiMissile)
			call DestroyTimer(TiMissile)
		endif
		set t = null
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    冥王三巨头的技能初始化
	*/
	function InitMingwang takes nothing returns nothing
		local timer refresh = CreateTimer()
		/*
		    冥王的吸
		*/
        local Attract attract = Attract.create(gg_unit_Nkjx_0241,1800,0.05,10)
        call attract.start()
        set DTJ1 = DamageTJ.create(gg_unit_Nkjx_0241)
        set DTJ2 = DamageTJ.create(gg_unit_Uear_0242)
        set DTJ3 = DamageTJ.create(gg_unit_Npld_0253)
        //左右护法的技能
	    set TSpellZuo = CreateTrigger()
	    call TriggerRegisterUnitEvent(TSpellZuo, gg_unit_Uear_0242, EVENT_UNIT_ATTACKED)
	    call TriggerAddCondition(TSpellZuo, Condition(function TSpellZuoCon))
	    call TriggerAddAction(TSpellZuo, function TSpellZuoAct)
	    set TSpellYou = CreateTrigger()
	    call TriggerRegisterUnitEvent(TSpellYou, gg_unit_Npld_0253, EVENT_UNIT_ATTACKED)
	    call TriggerAddCondition(TSpellYou, Condition(function TSpellYouCon))
	    call TriggerAddAction(TSpellYou, function TSpellYouAct)
	    //冥刹的死亡导弹
		set TiMissile = CreateTimer()
		//开始疯狂导弹
		call TimerStart(TiMissile,0.4,true,function startMissile)
		call TimerStart(refresh,3,true,function refreshMissile)
		set refresh = null
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    冥王三巨头的技能善后
	*/
	function DestroyMingwang takes nothing returns nothing
		call DestroyTrigger(TSpellZuo)
		call DestroyTrigger(TSpellYou)
	endfunction
//---------------------------------------------------------------------------------------------------
	function InitSaisilier takes unit u returns nothing
        local Attract attract = Attract.create(u,1800,0.05,14)
        call attract.start()
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    不断攻击基地或者周围
	*/
	private function EnemyFilter takes nothing returns boolean
		return IsEnemyMP(GetFilterUnit(),Player(11))
	endfunction
    private function JudgeBossAttackTimer takes nothing returns nothing
    	local timer t = GetExpiredTimer()
    	local integer id = GetHandleId(t)
    	local unit u = LoadUnitHandle(LHTable,id,1)
    	local group l_group = CreateGroup()
    	call GroupEnumUnitsInRange(l_group, GetUnitX(u),GetUnitY(u), 900, Condition(function EnemyFilter))
    	if (IsUnitInGroup(gg_unit_haro_0030,l_group)) then
    		call GroupRemoveUnit(l_group,gg_unit_haro_0030)
    	endif
    	if (IsUnitAliveBJ(u) or GetUnitAbilityLevel(u,'A0KH') > 0) then
    		if (CountUnitsInGroup(l_group) >= 1) then
    			call IssueTargetOrder(u,"attack",GroupPickRandomUnit(l_group))
    		else
    			call IssuePointOrderLoc(u,"attack",udg_Point_Fuhuo)
    		endif
    	else
    		call PauseTimer(t)
    		call FlushChildHashtable(LHTable,id)
    		call DestroyTimer(t)
    	endif
    	call DestroyGroup(l_group)
    	set l_group = null
    	set u = null
    	set t = null
    endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    大肉棒判断
	*/
	private function DaroubangJudge takes nothing returns nothing
		if (MLChuanzhang.getTimes()>IRoubang) then
			set IRoubang = MLChuanzhang.getTimes()
	    	call Roubang.create(UChuanzhang,10,100,1.33*IRoubang,GetRandomReal(0,360),'h01T')
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
		鬼仙死亡
	*/
	private function TDeathGhostAngleAct takes nothing returns nothing
		if (GetDyingUnit() == UGhost) then
			call MLGhost.destroy()
			call TShieldGhost.destroy()
			call PauseTimer(TGhostShiye)
			call DestroyTimer(TGhostShiye)
			set TGhostShiye = null
			call DestroyTrigger(TSpellGhost)
			set UGhost = null
		endif
		if (GetDyingUnit() == UAngle) then
			call MLAngle.destroy()
			call TShieldAngle.destroy()
			call PauseTimer(TAngleQuestion)
			call DestroyTimer(TAngleQuestion)
			set TAngleQuestion = null
			set IGuangmang = 0
			call DestroyDiduihua()
			set UAngle = null
		endif
		if (not(IsUnitAliveBJ(UGhost)) and GetUnitAbilityLevel(UGhost,'A0KH') < 1 and not(IsUnitAliveBJ(UAngle)) and GetUnitAbilityLevel(UAngle,'A0KH') < 1) then
		    call PauseTimer( udg_Time_BOSS )
		    call DestroyTimer(udg_Time_BOSS)
	    	call DestroyTimerDialog( udg_Timer_BOSS )
			call CinematicModeBJ( true, GetPlayersAll() )
		    call TransmissionFromUnitWithNameBJ( GetPlayersAll(), udg_H[GetConvertedPlayerId(GetFirstPlayer())], GetUnitName(udg_H[GetConvertedPlayerId(GetFirstPlayer())]), null, "看似这场战争暂时性的结束了...不过看似这背后并不简单?", bj_TIMETYPE_ADD, 2.00, true )
		    call YDWEPolledWaitNull(2.00)
		    call TransmissionFromUnitWithNameBJ( GetPlayersAll(), udg_H[GetConvertedPlayerId(GetFirstPlayer())], GetUnitName(udg_H[GetConvertedPlayerId(GetFirstPlayer())]), null, "游戏将在60秒后结束...", bj_TIMETYPE_ADD, 2.00, true )
		    call YDWEPolledWaitNull(2.00)
	        call DTJ1.show()
	        call DTJ2.show()
	        set DTJ1 = 0
	        set DTJ2 = 0
		    call PrintMengjiPassword()
		    call PrintMengjiPassword()
		    call PrintMengjiPassword()
		    call PrintMengjiPassword()
		    call PrintCanglingPassword()
		    call PrintCanglingPassword()
		    call PrintCanglingPassword()
		    call PrintCanglingPassword()
		    call PrintXinglongPassword()
		    call PrintXinglongPassword()
		    call PrintXinglongPassword()
		    call PrintXinglongPassword()
		    call PrintXiaotingPassword()
		    call PrintXiaotingPassword()
		    call PrintXiaotingPassword()
		    call PrintXiaotingPassword()
		    debug call SaveAchievementKuilei2()
		    ////debug call CreateAllYuebing()
		    call CinematicModeBJ( false, GetPlayersAll() )
		    call YDWEPolledWaitNull(60.00)
		    call ForForce( GetPlayersAll(), function ShengliAll )
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    生命变化的重新设置1段无敌
	*/
	private function AfterBossLessLife takes unit u returns nothing
		if (u == UGhost) then
			call TShieldGhost.destroy()
	        set TShieldGhost = SuperShield.create(UGhost,1)
	        call TShieldGhost.SetDeathContinue()
		elseif (u == UAngle) then
			call TShieldAngle.destroy()
	        set TShieldAngle = SuperShield.create(UAngle,1)
	        call TShieldAngle.SetDeathContinue()
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    初始化鬼与仙
	*/
	private function InitGhostAngle takes nothing returns nothing
		local timer t = null
		call ShowGameHintAll("
		    |cffffff00上路BOSS(鬼王傀儡) 技能:|r
	        4次生命,1段无敌
	        瞬闪攻击
	        视野无效化
	        圈外免疫
	        百分比攻击
	        |cff00ccff下路BOSS(仙王傀儡) 技能:|r
	        4次生命,1段无敌
	        数学提问(回答错误会扣防护罩)
	        光芒万丈(读秒预判)
	        英雄敌队化(各自为战)
	        复活之火(复活后的伤害)
	        |cffff0000BOSS正式进攻!|r")
		//call PolledWait(10)
		set UGhost = CreateUnit(Player(11),'N02B',GetRectCenterX(gg_rct________3),GetRectCenterY(gg_rct________3),90)
		set UAngle = CreateUnit(Player(11),'N02C',GetRectCenterX(gg_rct________6),GetRectCenterY(gg_rct________6),270)
		//多条命
		set MLGhost = MultiLife.create(UGhost,I3(renshu == 1 or GetDiffculty() < 5,2,I3(IsWanjie(),4,3)))
		set MLAngle = MultiLife.create(UAngle,I3(renshu == 1 or GetDiffculty() < 5,2,I3(IsWanjie(),4,3)))
		call MLGhost.setAL(AfterLessLife.AfterBossLessLife)
		call MLAngle.setAL(AfterLessLife.AfterBossLessLife)
        set TShieldGhost = SuperShield.create(UGhost,1)
        call TShieldGhost.SetDeathContinue()
        set TShieldAngle = SuperShield.create(UAngle,1)
        call TShieldAngle.SetDeathContinue()
		call SetUnitAbilityLevel(UAngle,'A0AG',udg_Nandu_JJJ)
		call SetUnitAbilityLevel(UGhost,'A0AG',udg_Nandu_JJJ)
		call StartFangKa( UGhost )
		call StartFangKa( UAngle )
	    call PauseTimer( TiGhostAngle )
	    call DestroyTimer(TiGhostAngle)
    	call DestroyTimerDialog( TiDiaGhostAngle )
        set DTJ1 = DamageTJ.create(UAngle)
        set DTJ2 = DamageTJ.create(UGhost)
        set udg_Time_BOSS = CreateTimer()
	    call StartTimerBJ( udg_Time_BOSS, false, 1200.00 )
	    call CreateTimerDialogBJ( udg_Time_BOSS, "限时击杀时间" )
	    set udg_Timer_BOSS = GetLastCreatedTimerDialogBJ()
	    call TimerDialogDisplayBJ( true, udg_Timer_BOSS )
	    if (not(CT7())) then
		    set t = CreateTimer()
		    call SaveUnitHandle(LHTable,GetHandleId(t),1,UAngle)
		    call TimerStart(t,1,true,function JudgeBossAttackTimer)
		    set t = CreateTimer()
		    call SaveUnitHandle(LHTable,GetHandleId(t),1,UGhost)
		    call TimerStart(t,1,true,function JudgeBossAttackTimer)
		    set t = null
		else
			call BossAddOnlyAttack(UAngle)
			call BossAddOnlyAttack(UGhost)
	    endif
	    //鬼王技能
		call InitShiyeTimer()
		set TSpellGhost = CreateTrigger()
		call TriggerRegisterUnitEvent(TSpellGhost,UGhost,EVENT_UNIT_DAMAGED)
		call TriggerAddCondition(TSpellGhost, Condition(function TSpellGhostCon))
		call TriggerAddAction(TSpellGhost, function TSpellGhostAct)
		if (GetDiffculty() >= 6) then
			call InitShunshan()
		endif
	    //仙帝技能
		call InitQuestionTimer()
		call InitGuangmang()
	    if (GetDiffculty() >= 6) then
	    	call InitDiduihua()
	    endif
    	set TDeathGhostAngle = CreateTrigger()
    	call TriggerAddAction(TDeathGhostAngle, function TDeathGhostAngleAct)
    	call TriggerRegisterUnitEvent( TDeathGhostAngle, UGhost, EVENT_UNIT_DEATH )
    	call TriggerRegisterUnitEvent( TDeathGhostAngle, UAngle, EVENT_UNIT_DEATH )
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    开始鬼王与仙王的计时器
	*/
	function StartGhostAngleTimer takes nothing returns nothing
        set TiGhostAngle = CreateTimer()
        set TiDiaGhostAngle = CreateTimerDialogBJ(TiGhostAngle,"六界傀儡2")
	    call PauseTimer( udg_Double_M[1] )
	    call DestroyTimer(udg_Double_M[1])
    	call DestroyTimerDialog( udg_Double_Me )
        call TimerStart(TiGhostAngle,GetWangSpeed(),false,function InitGhostAngle)
        call TimerDialogDisplay(TiDiaGhostAngle,true)
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    人妖死亡后的判断
	*/
	private function TDeathRenyaoAct takes nothing returns nothing
		if (GetDyingUnit() == UXiaoY) then
			call DestroyConnection()
		endif
		if (GetDyingUnit() == UChuanzhang) then
		    call TFChuan.destroy()
		    call PauseTimer(TRBChuan)
		    call DestroyTimer(TRBChuan)
		endif
		if (not(IsUnitAliveBJ(UXiaoY)) and GetUnitAbilityLevel(UXiaoY,'A0KH') < 1 and not(IsUnitAliveBJ(UChuanzhang)) and GetUnitAbilityLevel(UChuanzhang,'A0KH') < 1) then
		    call PauseTimer( udg_Time_BOSS )
		    call DestroyTimer(udg_Time_BOSS)
	    	call DestroyTimerDialog( udg_Timer_BOSS )
			//call CinematicModeBJ( true, GetPlayersAll() )
		    //call TransmissionFromUnitWithNameBJ( GetPlayersAll(), udg_H[GetConvertedPlayerId(GetFirstPlayer())], GetUnitName(udg_H[GetConvertedPlayerId(GetFirstPlayer())]), null, "看似这场战争暂时性的结束了...不过看似这背后并不简单?", bj_TIMETYPE_ADD, 2.00, true )
		   // call PolledWait(2.00)
		   // call TransmissionFromUnitWithNameBJ( GetPlayersAll(), udg_H[GetConvertedPlayerId(GetFirstPlayer())], GetUnitName(udg_H[GetConvertedPlayerId(GetFirstPlayer())]), null, "游戏将在60秒后结束...", bj_TIMETYPE_ADD, 2.00, true )
		    debug call SaveAchievement()
		    //call PolledWait(2.00)
	        call DTJ1.show()
	        call DTJ2.show()
	        set DTJ1 = 0
	        set DTJ2 = 0
		    debug call SaveAchievementKuilei1()
		    //call CinematicModeBJ( false, GetPlayersAll() )
		    //debug call CreateAllYuebing()
		    call StartGhostAngleTimer()
		    call BJDebugMsg("|cffff0000【注意】第二波傀儡将于7分钟后进攻!|r")
		    call BJDebugMsg("|cffff0000【注意】第二波傀儡将于7分钟后进攻!|r")
		    call BJDebugMsg("|cffff0000【注意】第二波傀儡将于7分钟后进攻!|r")
		    call BJDebugMsg("|cffff0000【注意】第二波傀儡将于7分钟后进攻!|r")
		    call BJDebugMsg("|cffff0000【注意】第二波傀儡将于7分钟后进攻!|r")
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    初始化人与妖
	*/
	private function InitRenYao takes nothing returns nothing
		local timer t = null
		call ShowGameHintAll("
		    |cffffff00上路BOSS(人王傀儡) 技能:|r
	        3次生命
	        火焰之棒(每死一次多一条棒,速度更快,注意躲开)
	        航海领域(眩晕攻击)
	        天赋禁用(周期性技能)
	        |cff00ccff下路BOSS(妖王傀儡) 技能:|r
	        3次生命
	        生命共享(任一队友死亡则全队死亡)
	        法伤变负(周期性技能,范围有效)
	        陨石坠落(注意倒计时!)
	        |cffff0000BOSS正式进攻!|r")
		//call PolledWait(10)
		set UXiaoY = CreateUnit(Player(11),'N01O',GetRectCenterX(gg_rct________6),GetRectCenterY(gg_rct________6),90)
		set UChuanzhang = CreateUnit(Player(11),'N01P',GetRectCenterX(gg_rct________3),GetRectCenterY(gg_rct________3),270)
		//多条命
		set MLChuanzhang = MultiLife.create(UChuanzhang,I3(renshu == 1 or GetDiffculty() < 5,1,I3(IsWanjie(),3,2)))
		set MLXiaoY = MultiLife.create(UXiaoY,I3(renshu == 1 or GetDiffculty() < 5,1,I3(IsWanjie(),3,2)))
		call SetUnitAbilityLevel(UXiaoY,'A0AG',udg_Nandu_JJJ)
		call SetUnitAbilityLevel(UChuanzhang,'A0AG',udg_Nandu_JJJ)
		call StartFangKa( UXiaoY )
		call StartFangKa( UChuanzhang )
	    call PauseTimer( TiRenYao )
	    call DestroyTimer(TiRenYao)
    	call DestroyTimerDialog( TiDiaRenYao )
        set DTJ1 = DamageTJ.create(UXiaoY)
        set DTJ2 = DamageTJ.create(UChuanzhang)
	    call StartTimerBJ( udg_Time_BOSS, false, 1200.00 )
	    call CreateTimerDialogBJ( udg_Time_BOSS, "限时击杀时间" )
	    set udg_Timer_BOSS = GetLastCreatedTimerDialogBJ()
	    call TimerDialogDisplayBJ( true, udg_Timer_BOSS )
	    if (not(CT7())) then
		    set t = CreateTimer()
		    call SaveUnitHandle(LHTable,GetHandleId(t),1,UXiaoY)
		    call TimerStart(t,1,true,function JudgeBossAttackTimer)
		    set t = CreateTimer()
		    call SaveUnitHandle(LHTable,GetHandleId(t),1,UChuanzhang)
		    call TimerStart(t,1,true,function JudgeBossAttackTimer)
		    set t = null
		else
			call BossAddOnlyAttack(UXiaoY)
			call BossAddOnlyAttack(UChuanzhang)
	    endif
	    //小Y技能
	    call InitFashangfuTimer()
	    if (GetDiffculty() >= 6) then
	   		call InitTimerStoneKill()
	    endif
	    call StartLifeConnect()
	    //船长技能
	    call InitHanghai()
	    set TFChuan = TianfuForbidder.create(UChuanzhang,GetForbidTianfuTime(),10.-GetForbidTianfuTime())
	    set TRBChuan = CreateTimer()
	    call TimerStart(TRBChuan,1,true,function DaroubangJudge)
    	set TDeathRenyao = CreateTrigger()
    	call TriggerAddAction(TDeathRenyao, function TDeathRenyaoAct)
    	call TriggerRegisterUnitEvent( TDeathRenyao, UXiaoY, EVENT_UNIT_DEATH )
    	call TriggerRegisterUnitEvent( TDeathRenyao, UChuanzhang, EVENT_UNIT_DEATH )
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    开始人王与妖王的计时器
	*/
	function StartRenYaoTimer takes nothing returns nothing
        set TiRenYao = CreateTimer()
        set TiDiaRenYao = CreateTimerDialogBJ(TiRenYao,"六界傀儡1")
	    call PauseTimer( udg_Double_M[1] )
	    call DestroyTimer(udg_Double_M[1])
    	call DestroyTimerDialog( udg_Double_Me )
        call TimerStart(TiRenYao,GetWangSpeed(),false,function InitRenYao)
        call TimerDialogDisplay(TiDiaRenYao,true)
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    伤害判定
	*/
	function SimulateDamageBoss takes unit u returns boolean
		if (GetUnitTypeId(u) == 'h01S') then
			call DisableTrigger(GetTriggeringTrigger())
			if (IsUnitType(GetTriggerUnit(), UNIT_TYPE_MAGIC_IMMUNE) and playerName[GetConvertedPlayerId(GetOwningPlayer(GetTriggerUnit()))] != "信哲大人") then
				call UnitDamageTarget( u, GetTriggerUnit(), GetUnitState(GetTriggerUnit(),UNIT_STATE_MAX_LIFE)*2, false, true, ATTACK_TYPE_CHAOS, DAMAGE_TYPE_SLOW_POISON, WEAPON_TYPE_WHOKNOWS )
			endif
			call EnableTrigger(GetTriggeringTrigger())
			return true
		endif
		if (GetUnitTypeId(u) == 'h01T' and IsUnitAliveBJ(UChuanzhang) and IsUnitDeadBJ(GetTriggerUnit())) then
			call RecoverUnitHP(UChuanzhang,0.005)
			return true
		endif
		return false
	endfunction
//---------------------------------------------------------------------------------------------------
	private function InitBoss takes nothing returns nothing
		set bossTable = InitHashtable()
	endfunction
endlibrary
library_once Arena initializer InitArena requires LHBase,SpellBase,Diffculty,Boss,Version
	globals
		constant integer ARENA_MAX_LEVEL = 50
		/*
		    功能
		*/
		private trigger TDieEvent = null
		/*
		    技能
		*/
		private trigger TSpellLinger = null
		private trigger TSpellZhousi = null
		private trigger TSpellXuemo1 = null
		private trigger TSpellXuemo2 = null
		private trigger TSpellWuxin = null
		private trigger TSpellFuwang = null
		private trigger TSpellMeidusha1 = null
		private trigger TSpellMeidusha2 = null
		private trigger TSpellKiller1 = null
		private trigger TSpellKiller2 = null
		private trigger TSpellJinxuan1 = null
		private trigger TSpellJinxuan2 = null
		private trigger TSpellJinxuan3 = null
		private trigger TSpellJinxuan4 = null
		private trigger TSpellYuansha = null
		/*
		    当前挑战的人的位置
		*/
		private integer array currentArena
		/*
		    当前擂台的能力等级
		*/
		private integer currentLevel = 1
		/*
		    擂主
		*/
		private unit challenager = null
		/*
		    挑战者
		*/
		private unit defier = null
		/*
		    漂浮文字
		*/
		private texttag textTag_Level = null
	endglobals
//---------------------------------------------------------------------------------------------------
	/*
	    刷新擂台等级并提高能力.
	*/
	private function updateLevel takes nothing returns nothing
		local timer t = GetExpiredTimer()
		local integer int = GetHeroInt(challenager,true)
		local integer agi = GetHeroAgi(challenager,true)
		local integer str = GetHeroStr(challenager,true)
		if( IsUnitAliveBJ(challenager) and ( currentLevel < ARENA_MAX_LEVEL)) then
			call DestroyEffect( AddSpecialEffect("Abilities\\Spells\\Human\\Avatar\\AvatarCaster.mdl", GetUnitX(challenager), GetUnitY(challenager)) )
			call SetHeroInt(challenager,GetLimit(int + int / currentLevel) ,true)
			call SetHeroAgi(challenager,GetLimit(agi + agi / currentLevel) , true)
			call SetHeroStr(challenager,GetLimit(str + str / currentLevel) , true)
			set currentLevel = currentLevel + 1
			//设置技能等级
			call IncUnitAbilityLevel(challenager,'ACbh')
			call IncUnitAbilityLevel(challenager,'A0ET')
			call IncUnitAbilityLevel(challenager,'A0EU')
			call IncUnitAbilityLevel(challenager,'ACt2')
			call IncUnitAbilityLevel(challenager,'AL04')
			call IncUnitAbilityLevel(challenager,'AL05')
			call IncUnitAbilityLevel(challenager,'A0EY')
			call IncUnitAbilityLevel(challenager,'A0H6')
			call IncUnitAbilityLevel(challenager,'A0H7')
			call SetTextTagTextBJ(textTag_Level,I2S(currentLevel) + "级",20)
		else
			call PauseTimer(t)
			call DestroyTimer(t)
		endif
		set t = null
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
		更新擂台等级的位置
	*/
	private function updateLevelLoc takes nothing returns nothing
		local timer t = GetExpiredTimer()
		if (IsUnitAliveBJ(challenager)) then
			call SetTextTagPosUnitBJ(textTag_Level,challenager,25)
		else
			call DestroyTextTag(textTag_Level)
			call PauseTimer(t)
			call DestroyTimer(t)
		endif
		set t = null
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    灵儿技能
	    强制把敌人射到墙角,每两秒也会强制把所有人拉到那里
	*/
	private function TSpellLingerCon takes nothing returns boolean
	    return ((GetAttacker() == challenager) and (IsUnitAliveBJ(GetAttacker()) == true) and (IsUnitIllusionBJ(GetAttacker()) != true) and RectContainsUnit(gg_rct_Arena_all,GetAttackedUnitBJ()))
	endfunction
	private function TSpellLingerAct takes nothing returns nothing
		call SetUnitX(GetAttackedUnitBJ(),GetRectCenterX(gg_rct_Arena_1))
		call SetUnitY(GetAttackedUnitBJ(),GetRectCenterY(gg_rct_Arena_1))
	endfunction
	/*
	    每2秒就群射一次
	*/
	private function LingerAssemble takes nothing returns nothing
		local real x = GetRectCenterX(gg_rct_Arena_1)
		local real y = GetRectCenterY(gg_rct_Arena_1)
		local group l_group = CreateGroup()
		local unit l_unit
		local timer t = GetExpiredTimer()
		if (IsUnitAliveBJ(challenager)) then
			call GroupEnumUnitsInRange(l_group, GetUnitX(challenager), GetUnitY(challenager), 900, null)
			loop
			    set l_unit = FirstOfGroup(l_group)
			    exitwhen l_unit == null
			    call GroupRemoveUnit(l_group, l_unit)
			    if (IsEnemy(GetEnumUnit(),challenager)) then
					call SetUnitX(GetAttackedUnitBJ(),GetRectCenterX(gg_rct_Arena_1))
					call SetUnitY(GetAttackedUnitBJ(),GetRectCenterY(gg_rct_Arena_1))
			    endif
			endloop
	    	call CreateSpellTextTag("万箭定心！",challenager,100,100,0,2)
		else
			call PauseTimer(t)
			call DestroyTimer(t)
		endif
		call DestroyGroup(l_group)
		set t = null
		set l_group = null
		set l_unit =null
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    宙斯的技能
	*/
	private function TSpellZhousiCon takes nothing returns boolean
	    return ((GetAttacker() == challenager) and (IsUnitAliveBJ(challenager) == true) and (IsUnitIllusionBJ(challenager) != true) and (GetRandomInt(1, 40) == 1) and (GetUnitStateSwap(UNIT_STATE_MANA, challenager) > 200.00))
	endfunction
	private function TSpellZhousiAct takes nothing returns nothing
		local integer i = 1
	    loop
	    	exitwhen i > 6
	    	call DestroyEffect( AddSpecialEffect("Abilities\\Spells\\Human\\Thunderclap\\ThunderClapCaster.mdl", GetUnitX(challenager) + SinBJ(i * 60) * 400, GetUnitY(challenager) + CosBJ(i * 60) * 400) )
	    	set i = i +1
	    endloop
		call DamageArea(challenager,GetUnitX(challenager),GetUnitY(challenager),600,300000 + 15000 *currentLevel)
	    call CreateSpellTextTag("千煞破击！",challenager,100,0,0,2)
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
		血魔技能1：召唤5个敌方单位复制
	*/
	private function TSpellXuemo1Con takes nothing returns boolean
	    return ((GetAttacker() == challenager) and (IsUnitAliveBJ(GetAttacker()) == true) and (IsUnitIllusionBJ(GetAttacker()) != true) and (GetRandomInt(1, 40) == 1))
	endfunction
	private function TSpellXuemo1Act takes nothing returns nothing
		local unit u
		local integer i = 1
	    loop
	    	exitwhen i > 5
	        set u = CreateUnit(GetOwningPlayer(GetAttacker()),'h000',GetUnitX(GetAttackedUnitBJ()),GetUnitY(GetAttackedUnitBJ()),0)
	        call UnitApplyTimedLifeBJ( 5.00, 'BHwe',u )
	        call UnitAddAbilityBJ( 'A0EV',u )
	        call SetUnitAbilityLevel(u,'A0EV',IMinBJ(currentLevel,20))
	        call IssueTargetOrderById(u, 852274, GetAttackedUnitBJ() )
	    	set i = i +1
	    endloop
	    call CreateSpellTextTag("幻魔灵枭！",challenager,100,0,0,2)
	    set u = null
	endfunction
	/*
	    血魔技能2：被攻击几率施放流星雨。
	*/
	private function TSpellXuemo2Con takes nothing returns boolean
	    return ((GetAttackedUnitBJ() == challenager) and (IsUnitAliveBJ(GetAttackedUnitBJ()) == true) and (IsUnitIllusionBJ(GetAttackedUnitBJ()) != true) and (GetRandomInt(1, 20) == 1) and (GetUnitStateSwap(UNIT_STATE_MANA, GetAttackedUnitBJ()) > 200.00))
	endfunction
	private function TSpellXuemo2Act takes nothing returns nothing
		local location point = GetUnitLoc(GetAttacker())
	    local unit u = CreateUnit(GetOwningPlayer(GetAttackedUnitBJ()),'h000',GetUnitX(GetAttacker()),GetUnitY(GetAttacker()),0)
	    call UnitApplyTimedLifeBJ( 5.00, 'BHwe',u )
        call UnitAddAbilityBJ( 'AL01',u )
        call SetUnitAbilityLevel(u,'AL01',IMinBJ(currentLevel,20))
	    call IssuePointOrderLoc( u, "rainoffire", point )
	    call RemoveLocation( point )
	    set u = null
	    set point = null
	    call CreateSpellTextTag("天玄星陨！",challenager,0,100,100,2)
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    无心技能:攻击掉1%血
	*/
	private function TSpellWuxinCon takes nothing returns boolean
	    return ((GetAttacker() == challenager) and (IsUnitAliveBJ(GetAttacker()) == true) and (IsUnitIllusionBJ(GetAttacker()) != true))
	endfunction
	private function TSpellWuxinAct takes nothing returns nothing
		call DestroyEffect(AddSpecialEffect("Objects\\Spawnmodels\\Human\\HumanLargeDeathExplode\\HumanLargeDeathExplode.mdl", GetUnitX(GetAttackedUnitBJ()), GetUnitY(GetAttackedUnitBJ())))
		call UnitDamageTarget( challenager, GetAttackedUnitBJ(), ( 0.01 * GetUnitStateSwap(UNIT_STATE_LIFE, GetAttackedUnitBJ()) ), false, true, ATTACK_TYPE_CHAOS, DAMAGE_TYPE_POISON, WEAPON_TYPE_WHOKNOWS )
	endfunction
	private function WuxinFlash takes nothing returns nothing
		//5秒沉默切换
		if(IsUnitAliveBJ(challenager) and GetUnitTypeId(challenager) == 'O003') then
			if (GetUnitUserData(challenager) == 0) then
 				call SimulateSpell(challenager,challenager,'A0M8',1,5,"silence",true,false,false)
 				call SetUnitUserData(challenager,1)
			else
 				call SimulateSpell(challenager,challenager,'A0M9',1,5,"silence",true,false,false)
 				call SetUnitUserData(challenager,0)
			endif
		else
			call PauseTimer(GetExpiredTimer())
			call DestroyTimer(GetExpiredTimer())
			return
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    斧王技能：攻击15%几率10%生命攻击，重击
	*/
	private function TSpellFuwangCon takes nothing returns boolean
	    return ((GetAttacker() == challenager) and (IsUnitAliveBJ(GetAttacker()) == true) and (IsUnitIllusionBJ(GetAttacker()) != true) and (GetRandomInt(1, 10) == 1))
	endfunction
	private function TSpellFuwangAct takes nothing returns nothing
		call DestroyEffect(AddSpecialEffect("Objects\\Spawnmodels\\Human\\HumanLargeDeathExplode\\HumanLargeDeathExplode.mdl", GetUnitX(GetAttackedUnitBJ()), GetUnitY(GetAttackedUnitBJ())))
		call UnitDamageTarget( challenager, GetAttackedUnitBJ(), ( 0.1 * GetUnitStateSwap(UNIT_STATE_LIFE, GetAttackedUnitBJ()) ), false, true, ATTACK_TYPE_CHAOS, DAMAGE_TYPE_POISON, WEAPON_TYPE_WHOKNOWS )
	    call CreateSpellTextTag("淘汰之刃！",challenager,0,100,0,2)
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    美杜莎技能1：召唤毒蛇守卫，不杀死自己是无敌的
	*/
	/*
	    Timer判断螣蛇的数量，决定美杜莎无敌状态
	*/
	private function TSpellMeidusha1Invu takes nothing returns nothing
		local group l_group = CreateGroup()
		local unit l_unit
		local integer count = 0
		local timer t = GetExpiredTimer()
		call GroupEnumUnitsInRange(l_group, GetUnitX(challenager), GetUnitY(challenager), 1800, null)
		loop
		    set l_unit = FirstOfGroup(l_group)
		    exitwhen l_unit == null
		    call GroupRemoveUnit(l_group, l_unit)
			if ((GetUnitTypeId(l_unit) == 'osp1') and GetOwningPlayer(l_unit) == Player(10) and IsUnitAliveBJ(l_unit) == true ) then
				set count = count + 1
			endif
		endloop
		if (count == 0) then
			call SetUnitInvulnerable(challenager,false)
			call PauseTimer(t)
			call DestroyTimer(t)
		endif
		call DestroyGroup(l_group)
		set l_group = null
		set l_unit =null
		set t = null
	endfunction
	/*
	    触发器
	*/
	private function TSpellMeidusha1Con takes nothing returns boolean
	    return ((GetAttacker() == challenager) and (IsUnitAliveBJ(GetAttacker()) == true) and (IsUnitIllusionBJ(GetAttacker()) != true) and (GetRandomInt(1, 60) == 1) )
	endfunction
	private function TSpellMeidusha1Act takes nothing returns nothing
		local location point = GetUnitLoc(GetAttackedUnitBJ())
		local timer t = CreateTimer()
	    local unit u = CreateUnit(GetOwningPlayer(GetAttacker()),'h000',GetUnitX(GetAttackedUnitBJ()),GetUnitY(GetAttackedUnitBJ()),0)
	    call UnitApplyTimedLifeBJ( 5.00, 'BHwe',u )
        call UnitAddAbilityBJ( 'Arsw',u )
	    call IssuePointOrderLoc( u, "ward", point )
	    call CreateSpellTextTag("阴魂螣蛇！",challenager,0,0,0,2)
	    call RemoveLocation( point )
	    call SetUnitInvulnerable(challenager,TRUE)
	    call TimerStart(t,0.3,true,function TSpellMeidusha1Invu)
	    set u = null
	    set point = null
	    set t = null
	endfunction
	/*
	    美杜莎技能2：石化凝视，冻结所有敌人3秒
	*/
	private function TSpellMeidusha2Con takes nothing returns boolean
	    return ((GetAttackedUnitBJ() == challenager) and (IsUnitAliveBJ(GetAttackedUnitBJ()) == true) and (IsUnitIllusionBJ(GetAttackedUnitBJ()) != true) and (GetRandomInt(1, 80) == 1))
	endfunction
	private function TSpellMeidusha2Act takes nothing returns nothing
		local group l_group = CreateGroup()
		local group l_pausinggroup = CreateGroup()
		local unit l_unit = null
		call GroupEnumUnitsInRange(l_group, GetUnitX(GetAttackedUnitBJ()), GetUnitY(GetAttackedUnitBJ()), 900, null)
		loop
		    set l_unit = FirstOfGroup(l_group)
		    exitwhen l_unit == null
		    call GroupRemoveUnit(l_group, l_unit)
		    if(IsEnemy(l_unit,challenager))then
				call PauseUnitBJ(true,l_unit)
				call GroupAddUnit(l_pausinggroup,l_unit)
				call DestroyEffect(AddSpecialEffect("Objects\\Spawnmodels\\Naga\\NagaDeath\\NagaDeath.mdl", GetUnitX(l_unit), GetUnitY(l_unit)))
		    endif
		endloop
	    call CreateSpellTextTag("石化凝视！",challenager,51,51,51,2)
		call DestroyGroup(l_group)
		set l_group = null
		call YDWEPolledWaitNull(3.00)
		loop
		    set l_unit = FirstOfGroup(l_pausinggroup)
		    exitwhen l_unit == null
		    call GroupRemoveUnit(l_pausinggroup, l_unit)
			call PauseUnitBJ(false,l_unit)
			call DestroyEffect(AddSpecialEffect("Objects\\Spawnmodels\\Naga\\NagaDeath\\NagaDeath.mdl", GetUnitX(l_unit), GetUnitY(l_unit)))
		endloop
		call DestroyGroup(l_pausinggroup)
		set l_pausinggroup = null
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    杀手技能1：暗影突袭攻击方
	*/
	function TSpellKiller1Con takes nothing returns boolean
	    return ((GetAttackedUnitBJ() == challenager) and (IsUnitAliveBJ(GetAttackedUnitBJ()) == true) and (IsUnitIllusionBJ(GetAttackedUnitBJ()) != true) and (GetRandomInt(1, 20) == 1) and (GetUnitAbilityLevel(GetAttacker(),'Amim') < 1) and UnitHasBuffBJ(GetAttacker(),'BEsh') != true )
	endfunction
	function TSpellKiller1Act takes nothing returns nothing
	    local unit u = CreateUnit(GetOwningPlayer(GetAttackedUnitBJ()),'h000',GetUnitX(GetAttacker()),GetUnitY(GetAttacker()),0)
	    call UnitApplyTimedLifeBJ( 5.00, 'BHwe',u )
        call UnitAddAbilityBJ( 'AL02',u )
        call SetUnitAbilityLevel(u,'AL02',IMinBJ(currentLevel,20))
	    call IssueTargetOrder(u,"shadowstrike",GetAttacker())
	    call CreateSpellTextTag("致命毒镖！",challenager,0,0,0,2)
	    set u = null
	endfunction
	/*
	    杀手技能2：根缠干敌人
	*/
	function TSpellKiller2Con takes nothing returns boolean
	    return ((GetAttacker() == challenager) and (IsUnitAliveBJ(GetAttacker()) == true) and (IsUnitIllusionBJ(GetAttacker()) != true) and (GetRandomInt(1, 80) == 1) and (GetUnitStateSwap(UNIT_STATE_MANA, GetAttacker()) > 200.00))
	endfunction
	function TSpellKiller2Act takes nothing returns nothing
 		call SimulateSpell(GetAttacker(),GetAttackedUnitBJ(),'A0AC',1,5,"entanglingroots",false,false,true)
	    call CreateSpellTextTag("冰封囚笼！",challenager,0,255,0,2)
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    瑾轩技能1：攻击有一定的几率在目标释放雷阵雨
	*/
	function TSpellJinxuan1Con takes nothing returns boolean
	    return ((GetAttacker() == challenager) and (IsUnitIllusionBJ(GetAttacker()) != true) and (IsUnitAliveBJ(GetAttacker()) == true) and (GetRandomInt(1, 70) == 1) and (GetUnitStateSwap(UNIT_STATE_MANA, GetAttacker()) > 200.00))
	endfunction
	function TSpellJinxuan1Act takes nothing returns nothing
 		call SimulateSpell(GetAttacker(),GetAttackedUnitBJ(),'ACrf',IMinBJ(currentLevel,20),6,"rainoffire",true,false,false)
	    call CreateSpellTextTag("瞬闪雷鸣！",challenager,0,0,100,2)
	endfunction
	/*
	    瑾轩技能2：被攻击有一定的几率施放阵阵冲击波
	*/
	function TSpellJinxuan2Con takes nothing returns boolean
	    return ((GetAttackedUnitBJ() == challenager) and (IsUnitAliveBJ(GetAttackedUnitBJ()) == true) and (IsUnitIllusionBJ(GetAttackedUnitBJ()) != true) and (GetRandomInt(1, 50) == 1) and (GetUnitStateSwap(UNIT_STATE_MANA, GetAttackedUnitBJ()) > 200.00))
	endfunction
	function TSpellJinxuan2Act takes nothing returns nothing
 		call SimulateSpell(GetAttackedUnitBJ(),GetAttacker(),'ANst',IMinBJ(currentLevel,20),5,"stampede",true,false,false)
	    call CreateSpellTextTag("逆合玄天！",challenager,0,0,100,2)
	endfunction
	/*
	    瑾轩技能3：攻击有一定的几率向目标放出一道雷神射线，击晕+伤害
	*/
	function TSpellJinxuan3Con takes nothing returns boolean
	    return ((GetAttacker() == challenager) and (IsUnitAliveBJ(GetAttacker()) == true) and (IsUnitIllusionBJ(GetAttacker()) != true) and (GetRandomInt(1, 70) == 1) and (GetUnitStateSwap(UNIT_STATE_MANA, GetAttacker()) > 200.00))
	endfunction
	function TSpellJinxuan3Act takes nothing returns nothing
 		call SimulateSpell(GetAttacker(),GetAttackedUnitBJ(),'AHtb',IMinBJ(currentLevel,20),5,"thunderbolt",false,false,true)
	    call CreateSpellTextTag("魔化射线！",challenager,100,0,100,2)
	endfunction
	/*
	    瑾轩技能4： 被攻击时候有一定的几率窃取对方一定的魔法。
	*/
	function TSpellJinxuan4Con takes nothing returns boolean
	    return ((GetAttackedUnitBJ() == challenager) and (IsUnitAliveBJ(GetAttackedUnitBJ()) == true) and (IsUnitIllusionBJ(GetAttackedUnitBJ()) != true) and (GetRandomInt(1, 20) == 1))
	endfunction
	function TSpellJinxuan4Act takes nothing returns nothing
	    call SetUnitManaBJ( GetAttacker(), ( GetUnitStateSwap(UNIT_STATE_MANA, GetAttacker()) - 500.00 ) )
	    call CreateSpellTextTag("魔法窃取！",challenager,0,100,0,2)
	    call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Undead\\AnimateDead\\AnimateDeadTarget.mdl", GetUnitX(GetAttacker()), GetUnitY(GetAttacker()) ))
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    辕煞技能： 免疫外部人员伤害技能
	*/
	function TSpellYuanshaCon takes nothing returns boolean
	    return ((GetOwningPlayer(GetEventDamageSource()) != GetOwningPlayer(defier)) and (GetEventDamage() > 10))
	endfunction
	function TSpellYuanshaAct takes nothing returns nothing
		call SetUnitLifeBJ(challenager,GetUnitState(challenager,UNIT_STATE_LIFE)+GetEventDamage())
		if (GetRandomInt(1,5) == 1) then
	    	call CreateSpellTextTag("局外免疫！",challenager,0,0,100,2)
		endif
	endfunction
	/*
	    辕煞技能2:每1秒闪烁一次
	*/
	private function YuanshaMove takes nothing returns nothing
		local real x = GetRandomReal(GetRectMinX(gg_rct_Arena_Spell),GetRectMaxX(gg_rct_Arena_Spell))
		local real y = GetRandomReal(GetRectMinY(gg_rct_Arena_Spell),GetRectMaxY(gg_rct_Arena_Spell))
		if(IsUnitAliveBJ(challenager)) then
			call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\NightElf\\Blink\\BlinkCaster.mdl", x, y ))
			call SetUnitX(challenager,x)
			call SetUnitY(challenager,y)
		else
			call PauseTimer(GetExpiredTimer())
			call DestroyTimer(GetExpiredTimer())
			return
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    挑战擂台开始Trigger
	*/
	function TArenaStartAct takes nothing returns nothing
		local Attract attract
		//符合条件再开始
	    if ((IsUnitType(GetBuyingUnit(), UNIT_TYPE_HERO) == true)) then
	        if ((challenager == null)) then
	            if ((currentArena[GetConvertedPlayerId(GetOwningPlayer(defier))] != 11)) then
	            	//开始啦
	                call DisplayTextToPlayer( GetOwningPlayer(GetBuyingUnit()), 0, 0, "|cFFFF66CC【消息】|r挑战将在3秒后开始。" )
	                if ((currentArena[GetConvertedPlayerId(GetOwningPlayer(defier))] == 0)) then
	                    set challenager = CreateUnit(Player(10), 'Huth', GetRandomReal(GetRectMinX(gg_rct_Arena_all),GetRectMaxX(gg_rct_Arena_all)),GetRandomReal(GetRectMinY(gg_rct_Arena_all),GetRectMaxY(gg_rct_Arena_all)), 180.00)
	                elseif ((currentArena[GetConvertedPlayerId(GetOwningPlayer(defier))] == 1)) then
	                    set challenager = CreateUnit(Player(10), 'Hpb1', GetRandomReal(GetRectMinX(gg_rct_Arena_all),GetRectMaxX(gg_rct_Arena_all)),GetRandomReal(GetRectMinY(gg_rct_Arena_all),GetRectMaxY(gg_rct_Arena_all)), 180.00)
	                elseif ((currentArena[GetConvertedPlayerId(GetOwningPlayer(defier))] == 2)) then
	                    set challenager = CreateUnit(Player(10), 'Hgam', GetRectCenterX(gg_rct_Arena_2),GetRectCenterY(gg_rct_Arena_2), 180.00)
	                    call TimerStart(CreateTimer(),2,TRUE,function LingerAssemble)
	                    call EnableTrigger( TSpellLinger )
	                elseif ((currentArena[GetConvertedPlayerId(GetOwningPlayer(defier))] == 3)) then
	                    set challenager = CreateUnit(Player(10), 'Hmbr', GetRandomReal(GetRectMinX(gg_rct_Arena_all),GetRectMaxX(gg_rct_Arena_all)),GetRandomReal(GetRectMinY(gg_rct_Arena_all),GetRectMaxY(gg_rct_Arena_all)), 180.00)
	                    set attract = Attract.create(challenager,600,0.05,20)
	                    call attract.start()
						call EnableTrigger( TSpellZhousi )
	                elseif ((currentArena[GetConvertedPlayerId(GetOwningPlayer(defier))] == 4)) then
	                    set challenager = CreateUnit(Player(10), 'Odrt', GetRandomReal(GetRectMinX(gg_rct_Arena_all),GetRectMaxX(gg_rct_Arena_all)),GetRandomReal(GetRectMinY(gg_rct_Arena_all),GetRectMaxY(gg_rct_Arena_all)), 180.00)
	                	call UnitAddAbilityBJ( 'A0F1', challenager )
	                	call UnitAddAbilityBJ( 'Adtg', challenager )
						call EnableTrigger( TSpellXuemo1 )
						call EnableTrigger( TSpellXuemo2 )
	                elseif ((currentArena[GetConvertedPlayerId(GetOwningPlayer(defier))] == 5)) then
	                    set challenager = CreateUnit(Player(10), 'O003', GetRandomReal(GetRectMinX(gg_rct_Arena_all),GetRectMaxX(gg_rct_Arena_all)),GetRandomReal(GetRectMinY(gg_rct_Arena_all),GetRectMaxY(gg_rct_Arena_all)), 180.00)
	                	call UnitAddAbilityBJ( 'A0F1', challenager )
	                	call UnitAddAbilityBJ( 'Adtg', challenager )
						call EnableTrigger( TSpellWuxin )
	                    call TimerStart(CreateTimer(),5,TRUE,function WuxinFlash)
	                elseif ((currentArena[GetConvertedPlayerId(GetOwningPlayer(defier))] == 6)) then
	                    set challenager = CreateUnit(Player(10), 'Ogrh', GetRandomReal(GetRectMinX(gg_rct_Arena_all),GetRectMaxX(gg_rct_Arena_all)),GetRandomReal(GetRectMinY(gg_rct_Arena_all),GetRectMaxY(gg_rct_Arena_all)), 180.00)
	                    set attract = Attract.create(challenager,600,0.05,20)
	                    call attract.start()
	                	call UnitAddAbilityBJ( 'A0F1', challenager )
	                	call UnitAddAbilityBJ( 'Adtg', challenager )
						call EnableTrigger( TSpellFuwang )
	                elseif ((currentArena[GetConvertedPlayerId(GetOwningPlayer(defier))] == 7)) then
	                    set challenager = CreateUnit(Player(10), 'Hvsh', GetRandomReal(GetRectMinX(gg_rct_Arena_all),GetRectMaxX(gg_rct_Arena_all)),GetRandomReal(GetRectMinY(gg_rct_Arena_all),GetRectMaxY(gg_rct_Arena_all)), 180.00)
	                	call UnitAddAbilityBJ( 'Adtg', challenager )
						call EnableTrigger( TSpellMeidusha1 )
						call EnableTrigger( TSpellMeidusha2 )
	                elseif ((currentArena[GetConvertedPlayerId(GetOwningPlayer(defier))] == 8)) then
	                    set challenager = CreateUnit(Player(10), 'Hpb2', GetRandomReal(GetRectMinX(gg_rct_Arena_all),GetRectMaxX(gg_rct_Arena_all)),GetRandomReal(GetRectMinY(gg_rct_Arena_all),GetRectMaxY(gg_rct_Arena_all)), 180.00)
	                	call UnitAddAbilityBJ( 'A0F1', challenager )
	                	call UnitAddAbilityBJ( 'Adtg', challenager )
						call EnableTrigger( TSpellKiller1 )
						call EnableTrigger( TSpellKiller2 )
	                elseif ((currentArena[GetConvertedPlayerId(GetOwningPlayer(defier))] == 9)) then
	                    set challenager = CreateUnit(Player(10), 'Hlgr', GetRandomReal(GetRectMinX(gg_rct_Arena_all),GetRectMaxX(gg_rct_Arena_all)),GetRandomReal(GetRectMinY(gg_rct_Arena_all),GetRectMaxY(gg_rct_Arena_all)), 180.00)
	                	call UnitAddAbilityBJ( 'A0F1', challenager )
	                	call UnitAddAbilityBJ( 'Adtg', challenager )
						call EnableTrigger( TSpellJinxuan1 )
						call EnableTrigger( TSpellJinxuan2 )
						call EnableTrigger( TSpellJinxuan3 )
						call EnableTrigger( TSpellJinxuan4 )
	                elseif ((currentArena[GetConvertedPlayerId(GetOwningPlayer(defier))] == 10)) then
	                    set challenager = CreateUnit(Player(10), 'Hdgo', GetRandomReal(GetRectMinX(gg_rct_Arena_all),GetRectMaxX(gg_rct_Arena_all)),GetRandomReal(GetRectMinY(gg_rct_Arena_all),GetRectMaxY(gg_rct_Arena_all)), 180.00)
	                	call UnitAddAbilityBJ( 'A0F1', challenager )
	                	call UnitAddAbilityBJ( 'Adtg', challenager )
						call EnhanceDiffAttack(challenager)
	                    call TimerStart(CreateTimer(),0.5,TRUE,function YuanshaMove)
						call EnableTrigger( TSpellYuansha )
	                endif
	                //初始化单位
					call SetUnitX(defier,GetRectCenterX(gg_rct_Arena_1))
					call SetUnitY(defier,GetRectCenterY(gg_rct_Arena_1))
	                call SetUnitInvulnerable( challenager, true )
	                call PauseUnitBJ( true, challenager )
	                set currentLevel = 1
	                call UnitAddAbilityBJ( 'A0ES', challenager )
	                call UnitAddAbilityBJ( 'A0B9', challenager )
	                call UnitAddAbilityBJ( 'A09W', challenager )
	                call UnitAddAbilityBJ( 'A0P1', challenager )
                	call BossAddOnlyAttack(challenager)
	                call AddTianyanmokang(challenager)
	                set textTag_Level = CreateTextTagUnitBJ( I2S(currentLevel) + "级", challenager, 0, 20, 100, 0, 0, 0 )
	                call YDWEPolledWaitNull(3.00)
	                if ((challenager != null)) then
	                    call SetUnitInvulnerable( challenager, false )
	                    call PauseUnitBJ( false, challenager )
	                    call DisplayTextToPlayer( GetOwningPlayer(defier), 0, 0, "|cFFFF66CC【消息】|r挑战开始！" )
	                    //5秒更新一次等级
	                    call TimerStart(CreateTimer(),GetArenaUpdateSpeed(),TRUE,function updateLevel)
	                    //0.05秒更新一次等级提示的位置
	                    call TimerStart(CreateTimer(),0.05,TRUE,function updateLevelLoc)
   						call TriggerRegisterUnitEvent(TDieEvent, challenager, EVENT_UNIT_DEATH)
	                else
	                endif
	            else
	                call DisplayTextToPlayer( GetOwningPlayer(GetBuyingUnit()), 0, 0, "|cFFFF66CC【消息】|r擂台已经全部挑战完毕！" )
	            endif
	        else
	            call DisplayTextToPlayer( GetOwningPlayer(GetBuyingUnit()), 0, 0, "|cFFFF66CC【消息】|r请打完这场擂台再挑战新的！（认输方法：输入HG回城）" )
	        endif
	    else
	        call DisplayTextToPlayer( GetOwningPlayer(GetBuyingUnit()), 0, 0, "|cFFFF66CC【消息】|r请让英雄购买！" )
	    endif
	endfunction
	private function TArenaStartCon takes nothing returns boolean
	    return ((GetItemTypeId(GetSoldItem()) == 'I04D') and BuyerFilter(GetBuyingUnit()) == true and (GetBuyingUnit() == defier))
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    离开擂台后判负
	*/
	function TArenaLeaveCon takes nothing returns boolean
	    return ((defier == GetLeavingUnit()) and (IsUnitIllusionBJ(GetLeavingUnit()) != true))
	endfunction
	function TArenaLeaveAct takes nothing returns nothing
	    set defier = null
	    if ((challenager != null)) then
	        call RemoveUnit( challenager )
	        set challenager = null
	        call DestroyTextTag( textTag_Level )
	        call updateLevel()
	    	set currentLevel = 1
	    endif
        call DisableTrigger( TSpellLinger )
		call DisableTrigger( TSpellZhousi )
		call DisableTrigger( TSpellXuemo1 )
		call DisableTrigger( TSpellXuemo2 )
		call DisableTrigger( TSpellFuwang )
		call DisableTrigger( TSpellMeidusha1 )
		call DisableTrigger( TSpellMeidusha2 )
		call DisableTrigger( TSpellKiller1 )
		call DisableTrigger( TSpellKiller2 )
		call DisableTrigger( TSpellJinxuan1 )
		call DisableTrigger( TSpellJinxuan2 )
		call DisableTrigger( TSpellJinxuan3 )
		call DisableTrigger( TSpellJinxuan4 )
		call DisableTrigger( TSpellYuansha )
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    进入挑战场
	*/
	private function TArenaEnterAct takes nothing returns nothing
		local location point
	    if ((GetItemTypeId(GetSoldItem()) == 'fgrd')) then
	        if ((IsUnitType(GetBuyingUnit(), UNIT_TYPE_HERO) == true)) then
	            if ((defier == null)) then
	                set defier = GetBuyingUnit()
	                set point = GetRandomLocInRect(gg_rct_Arena_all)
	                call SetUnitPositionLoc( GetBuyingUnit(), point )
	                call PanCameraToTimedLocForPlayer( GetOwningPlayer(GetBuyingUnit()), point, 0.20 )
	                call DestroyEffect( AddSpecialEffect("Abilities\\Spells\\Human\\MassTeleport\\MassTeleportCaster.mdl", GetUnitX(GetBuyingUnit()), GetUnitY(GetBuyingUnit())) )
	                call RemoveLocation( point )
	                call DisplayTextToPlayer( GetOwningPlayer(GetBuyingUnit()), 0, 0, "|cFFFF66CC【消息】|r回去输入“HG”。" )
	            else
	                call DisplayTextToPlayer( GetOwningPlayer(GetBuyingUnit()), 0, 0, "|cFFFF66CC【消息】|r擂台只支持单挑,里面有人了哦~" )
	            endif
	        else
	            call DisplayTextToPlayer( GetOwningPlayer(GetBuyingUnit()), 0, 0, "|cFFFF66CC【消息】|r请让英雄购买！" )
	        endif
	    else
	    endif
	    set point = null
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    死亡事件:掉落装备
	*/
	function TDieEventConditions takes nothing returns boolean
	    return ((IsUnitIllusionBJ(GetDyingUnit()) != true))
	endfunction
	function TDieEventActions takes nothing returns nothing
	    local integer ty = (GetUnitTypeId(GetDyingUnit()))
	    if (ty == 'Huth') then
	        call CreateItem( 'prvt', GetRectCenterX(gg_rct_Arena_all),GetRectCenterY(gg_rct_Arena_all) )
	    elseif (ty == 'Hpb1') then
	        call CreateItem( 'cnob', GetRectCenterX(gg_rct_Arena_all),GetRectCenterY(gg_rct_Arena_all) )
	    elseif (ty == 'Hgam') then
	        call CreateItem( 'rhth', GetRectCenterX(gg_rct_Arena_all),GetRectCenterY(gg_rct_Arena_all) )
        	call DisableTrigger( TSpellLinger )
	    elseif (ty == 'Hmbr') then
	        call CreateItem( 'hval', GetRectCenterX(gg_rct_Arena_all),GetRectCenterY(gg_rct_Arena_all) )
			call DisableTrigger( TSpellZhousi )
	    elseif (ty == 'Odrt') then
	        call CreateItem( 'afac', GetRectCenterX(gg_rct_Arena_all),GetRectCenterY(gg_rct_Arena_all) )
			call DisableTrigger( TSpellXuemo1 )
			call DisableTrigger( TSpellXuemo2 )
	    elseif (ty == 'O003') then
	        call CreateItem( 'I078', GetRectCenterX(gg_rct_Arena_all),GetRectCenterY(gg_rct_Arena_all) )
			call DisableTrigger( TSpellWuxin )
	    elseif (ty == 'Ogrh') then
	        call CreateItem( 'pmna', GetRectCenterX(gg_rct_Arena_all),GetRectCenterY(gg_rct_Arena_all) )
			call DisableTrigger( TSpellFuwang )
	    elseif (ty == 'Hvsh') then
	        call CreateItem( 'evtl', GetRectCenterX(gg_rct_Arena_all),GetRectCenterY(gg_rct_Arena_all) )
			call DisableTrigger( TSpellMeidusha1 )
			call DisableTrigger( TSpellMeidusha2 )
	    elseif (ty == 'Hpb2') then
	        call CreateItem( 'bspd', GetRectCenterX(gg_rct_Arena_all),GetRectCenterY(gg_rct_Arena_all) )
	        call DisableTrigger( TSpellKiller1 )
			call DisableTrigger( TSpellKiller2 )
	    elseif (ty == 'Hlgr') then
	        call CreateItem( 'mcou', GetRectCenterX(gg_rct_Arena_all),GetRectCenterY(gg_rct_Arena_all) )
	        call DisableTrigger( TSpellJinxuan1 )
			call DisableTrigger( TSpellJinxuan2 )
			call DisableTrigger( TSpellJinxuan3 )
			call DisableTrigger( TSpellJinxuan4 )
		elseif (ty == 'Hdgo') then
			debug call SaveKillLeishi(GetOwningPlayer(defier))
	        call CreateItem( 'ciri', GetRectCenterX(gg_rct_Arena_all),GetRectCenterY(gg_rct_Arena_all) )
			call DisableTrigger( TSpellYuansha )
	    endif
	    set currentLevel = 1
	    set currentArena[GetConvertedPlayerId(GetOwningPlayer(defier))] = currentArena[GetConvertedPlayerId(GetOwningPlayer(defier))] + 1
	    call DisplayTextToPlayer( GetOwningPlayer(defier), 0, 0, "|cFFFF66CC【消息】|r挑战成功!" )
        call PlaySoundBJ(gg_snd_v_leitai)
	    call RemoveUnit( challenager )
	    set challenager = null
	endfunction
//---------------------------------------------------------------------------------------------------
	private function InitArena takes nothing returns nothing
		//挑战开始--买了"挑战开始"
		local trigger t = CreateTrigger()
	    call TriggerRegisterAnyUnitEventBJ( t, EVENT_PLAYER_UNIT_SELL_ITEM )
	    call TriggerAddCondition(t, Condition(function TArenaStartCon))
	    call TriggerAddAction(t, function TArenaStartAct)
	    //离开擂台后判负
	    set t = CreateTrigger()
	    call YDWETriggerRegisterLeaveRectSimpleNull( t, gg_rct_Arena_forbit )
	    call TriggerAddCondition(t, Condition(function TArenaLeaveCon))
	    call TriggerAddAction(t, function TArenaLeaveAct)
	    //进入挑战场--买了"进入擂台"
	    set t = CreateTrigger()
	    call TriggerRegisterAnyUnitEventBJ( t, EVENT_PLAYER_UNIT_SELL_ITEM )
	    call TriggerAddAction(t, function TArenaEnterAct)
	    //擂主死亡事件
	    set TDieEvent = CreateTrigger()
	    call TriggerAddCondition(TDieEvent, Condition(function TDieEventConditions))
	    call TriggerAddAction(TDieEvent, function TDieEventActions)
        //灵儿技能
	    set TSpellLinger = CreateTrigger()
	    call TriggerRegisterAnyUnitEventBJ( TSpellLinger, EVENT_PLAYER_UNIT_ATTACKED )
	    call TriggerAddCondition(TSpellLinger, Condition(function TSpellLingerCon))
	    call TriggerAddAction(TSpellLinger, function TSpellLingerAct)
	    call DisableTrigger(TSpellLinger)
	    //宙斯技能
	    set TSpellZhousi = CreateTrigger()
	    call TriggerRegisterAnyUnitEventBJ( TSpellZhousi, EVENT_PLAYER_UNIT_ATTACKED )
	    call TriggerAddCondition(TSpellZhousi, Condition(function TSpellZhousiCon))
	    call TriggerAddAction(TSpellZhousi, function TSpellZhousiAct)
	    call DisableTrigger(TSpellZhousi)
	    //血魔技能
	    set TSpellXuemo1 = CreateTrigger()
	    call TriggerRegisterAnyUnitEventBJ( TSpellXuemo1, EVENT_PLAYER_UNIT_ATTACKED )
	    call TriggerAddCondition(TSpellXuemo1, Condition(function TSpellXuemo1Con))
	    call TriggerAddAction(TSpellXuemo1, function TSpellXuemo1Act)
	    call DisableTrigger(TSpellXuemo1)
	    set TSpellXuemo2 = CreateTrigger()
	    call TriggerRegisterAnyUnitEventBJ( TSpellXuemo2, EVENT_PLAYER_UNIT_ATTACKED )
	    call TriggerAddCondition(TSpellXuemo2, Condition(function TSpellXuemo2Con))
	    call TriggerAddAction(TSpellXuemo2, function TSpellXuemo2Act)
	    call DisableTrigger(TSpellXuemo2)
    	//无心技能
	    set TSpellWuxin = CreateTrigger()
	    call TriggerRegisterAnyUnitEventBJ( TSpellWuxin, EVENT_PLAYER_UNIT_ATTACKED )
	    call TriggerAddCondition(TSpellWuxin, Condition(function TSpellWuxinCon))
	    call TriggerAddAction(TSpellWuxin, function TSpellWuxinAct)
	    call DisableTrigger(TSpellWuxin)
    	//斧王技能
	    set TSpellFuwang = CreateTrigger()
	    call TriggerRegisterAnyUnitEventBJ( TSpellFuwang, EVENT_PLAYER_UNIT_ATTACKED )
	    call TriggerAddCondition(TSpellFuwang, Condition(function TSpellFuwangCon))
	    call TriggerAddAction(TSpellFuwang, function TSpellFuwangAct)
	    call DisableTrigger(TSpellFuwang)
	    //美杜莎技能
	    set TSpellMeidusha1 = CreateTrigger()
	    call TriggerRegisterAnyUnitEventBJ( TSpellMeidusha1, EVENT_PLAYER_UNIT_ATTACKED )
	    call TriggerAddCondition(TSpellMeidusha1, Condition(function TSpellMeidusha1Con))
	    call TriggerAddAction(TSpellMeidusha1, function TSpellMeidusha1Act)
	    call DisableTrigger(TSpellMeidusha1)
	    set TSpellMeidusha2 = CreateTrigger()
	    call TriggerRegisterAnyUnitEventBJ( TSpellMeidusha2, EVENT_PLAYER_UNIT_ATTACKED )
	    call TriggerAddCondition(TSpellMeidusha2, Condition(function TSpellMeidusha2Con))
	    call TriggerAddAction(TSpellMeidusha2, function TSpellMeidusha2Act)
	    call DisableTrigger(TSpellMeidusha2)
	    //杀手技能
	    set TSpellKiller1 = CreateTrigger()
	    call TriggerRegisterAnyUnitEventBJ( TSpellKiller1, EVENT_PLAYER_UNIT_ATTACKED )
	    call TriggerAddCondition(TSpellKiller1, Condition(function TSpellKiller1Con))
	    call TriggerAddAction(TSpellKiller1, function TSpellKiller1Act)
	    call DisableTrigger(TSpellKiller1)
	    set TSpellKiller2 = CreateTrigger()
	    call TriggerRegisterAnyUnitEventBJ( TSpellKiller2, EVENT_PLAYER_UNIT_ATTACKED )
	    call TriggerAddCondition(TSpellKiller2, Condition(function TSpellKiller2Con))
	    call TriggerAddAction(TSpellKiller2, function TSpellKiller2Act)
	    call DisableTrigger(TSpellKiller2)
        //瑾轩技能
	    set TSpellJinxuan1 = CreateTrigger()
	    call TriggerRegisterAnyUnitEventBJ( TSpellJinxuan1, EVENT_PLAYER_UNIT_ATTACKED )
	    call TriggerAddCondition(TSpellJinxuan1, Condition(function TSpellJinxuan1Con))
	    call TriggerAddAction(TSpellJinxuan1, function TSpellJinxuan1Act)
	    call DisableTrigger(TSpellJinxuan1)
	    set TSpellJinxuan2 = CreateTrigger()
	    call TriggerRegisterAnyUnitEventBJ( TSpellJinxuan2, EVENT_PLAYER_UNIT_ATTACKED )
	    call TriggerAddCondition(TSpellJinxuan2, Condition(function TSpellJinxuan2Con))
	    call TriggerAddAction(TSpellJinxuan2, function TSpellJinxuan2Act)
	    call DisableTrigger(TSpellJinxuan2)
	    set TSpellJinxuan3 = CreateTrigger()
	    call TriggerRegisterAnyUnitEventBJ( TSpellJinxuan3, EVENT_PLAYER_UNIT_ATTACKED )
	    call TriggerAddCondition(TSpellJinxuan3, Condition(function TSpellJinxuan3Con))
	    call TriggerAddAction(TSpellJinxuan3, function TSpellJinxuan3Act)
	    call DisableTrigger(TSpellJinxuan3)
	    set TSpellJinxuan4 = CreateTrigger()
	    call TriggerRegisterAnyUnitEventBJ( TSpellJinxuan4, EVENT_PLAYER_UNIT_ATTACKED )
	    call TriggerAddCondition(TSpellJinxuan4, Condition(function TSpellJinxuan4Con))
	    call TriggerAddAction(TSpellJinxuan4, function TSpellJinxuan4Act)
	    call DisableTrigger(TSpellJinxuan4)
	    //辕煞
	    set TSpellYuansha = CreateTrigger()
	    call TriggerAddCondition(TSpellYuansha, Condition(function TSpellYuanshaCon))
	    call TriggerAddAction(TSpellYuansha, function TSpellYuanshaAct)
	    call DisableTrigger(TSpellYuansha)
	    set t = null
	endfunction
endlibrary
///#include  "edit/Beast.j"
library_once Lingxue requires SpellBase ,Spin
	globals
	endglobals
//---------------------------------------------------------------------------------------------------
	/*
	    复活后关闭碰撞
	*/
	function AfterReviveLingxue takes unit u returns nothing
		if (u == lingxue) then
    		call SetUnitPathing( lingxue, false )
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    凌雪皮肤
	*/
	private function InitLingxueSpin takes unit u returns unit
		if (IsLingxueSpin1(GetOwningPlayer(u))) then
			set udg_H[GetConvertedPlayerId(GetOwningPlayer(u))] = CreateUnit(GetOwningPlayer(u),'H01V',GetUnitX(u),GetUnitY(u),0)
			set gg_unit_Hjai_0014 = udg_H[GetConvertedPlayerId(GetOwningPlayer(u))]
			call UnitAddItemByIdSwapped('I006', udg_H[GetConvertedPlayerId(GetOwningPlayer(u))])
			call AddSpellPercent(GetConvertedPlayerId(GetOwningPlayer(u)),0.1)
			call SetUnitManaPercentBJ(udg_H[GetConvertedPlayerId(GetOwningPlayer(u))],1000)
			call RemoveUnit(u)
			return udg_H[GetConvertedPlayerId(GetOwningPlayer(u))]
		else
			return u
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	function InitLingxue takes unit u returns nothing
		set lingxue = InitLingxueSpin(u)
    	call TriggerRegisterUnitEvent( gg_trg_____________21, lingxue, EVENT_UNIT_DAMAGED )
    	call SetUnitPathing( lingxue, false )
	endfunction
endlibrary
library_once Revive initializer InitRevive requires LHBase,Beast,Lingxue,Xinglong
//---------------------------------------------------------------------------------------------------
function TReviveHeroCon takes nothing returns boolean
    return ((IsUnitIllusionBJ(GetRevivingUnit()) == false) and (GetRevivingUnit() == udg_H[GetConvertedPlayerId(GetOwningPlayer(GetRevivingUnit()))]))
endfunction
function TReviveHeroAct takes nothing returns nothing
	call ReviveBeast(GetRevivingUnit())
	call AfterReviveLingxue(GetRevivingUnit())
	call AfterReviveXinglong(GetRevivingUnit())
	call AfterReviveHeiyan(GetRevivingUnit())
	set BHeroDeath[GetConvertedPlayerId(GetOwningPlayer(GetRevivingUnit()))] = false
	if (GetPlayerSlotState(GetOwningPlayer(GetRevivingUnit())) == PLAYER_SLOT_STATE_LEFT) then
		call SetUnitPosition( GetRevivingUnit(), GetRectCenterX(gg_rct_QuitRegion), GetRectCenterY(gg_rct_QuitRegion) )
	    call SetUnitInvulnerable( GetRevivingUnit(), true )
	    call PauseUnitBJ( true, GetRevivingUnit() )
	    call ShowUnitHide(GetRevivingUnit())
	endif
endfunction
//---------------------------------------------------------------------------------------------------
	private function InitRevive takes nothing returns nothing
		local trigger t = CreateTrigger()
	    call TriggerRegisterAnyUnitEventBJ( t, EVENT_PLAYER_HERO_REVIVE_FINISH )
	    call TriggerAddCondition(t, Condition(function TReviveHeroCon))
	    call TriggerAddAction(t, function TReviveHeroAct)
	endfunction
endlibrary
library_once Purgatory initializer InitPurgatory requires LHBase,ItemBase,ChallangerDZ
//---------------------------------------------------------------------------------------------------
	/*
	    许愿之蛋
	*/
	private function XuyuanClick takes nothing returns nothing
        local dialog d = GetClickedDialogBJ()
        local player p = LoadPlayerHandle(LHTable,GetHandleId(d),4)
        local unit u = udg_H[GetConvertedPlayerId(p)]
        local integer int = 0
        local integer str = 0
        local integer agi = 0
        call RemoveItem(LoadItemHandle(LHTable,GetHandleId(d),5))
        if (GetClickedButtonBJ() == LoadButtonHandle(LHTable,GetHandleId(d),1)) then
        	//回归100级，然后爆炸
        	set int = GetHeroInt(u,false)
        	set str = GetHeroStr(u,false)
        	set agi = GetHeroAgi(u,false)
		    call SetHeroLevelBJ( u, 100, false )
        	call DisplayTextToPlayer(p, 0., 0., "|cFFFF66CC【消息】|r你等级到了100级.")
	    	call CreateUnitEffect(GetOwningPlayer(u),'h01M',GetUnitX(u),GetUnitY(u),0)
	    	call SetHeroInt(u,int,false)
	    	call SetHeroAgi(u,agi,false)
	    	call SetHeroStr(u,str,false)
        endif
        if (GetClickedButtonBJ() == LoadButtonHandle(LHTable,GetHandleId(d),2)) then
        	//立即获取8%的属性
        	if (u != chenji) then
        		call SetHeroInt(u,IMinBJ(1000000000, R2I(I2R(GetHeroInt(u,false)) * 1.08)),false)
        		call SetHeroAgi(u,IMinBJ(1000000000, R2I(I2R(GetHeroAgi(u,false)) * 1.08)),false)
        		call SetHeroStr(u,IMinBJ(1000000000, R2I(I2R(GetHeroStr(u,false)) * 1.08)),false)
        	else
        		call SetHeroStr(u,IMinBJ(1000000000, R2I(I2R(GetHeroStr(u,false)) * 1.08)),false)
        		call SetHeroStr(u,IMinBJ(1000000000, R2I(I2R(GetHeroStr(u,false)) * 1.08)),false)
        		call SetHeroStr(u,IMinBJ(1000000000, R2I(I2R(GetHeroStr(u,false)) * 1.08)),false)
        	endif
	    	call CreateUnitEffect(GetOwningPlayer(u),'h01M',GetUnitX(u),GetUnitY(u),0)
        	call DisplayTextToPlayer(p, 0., 0., "|cFFFF66CC【消息】|r你成功的获得了8%的全属性(直接相乘).")
        endif
        if (GetClickedButtonBJ() == LoadButtonHandle(LHTable,GetHandleId(d),3)) then
        	//立即提高20级
        	call SetHeroLevel(u,GetHeroLevel(u) + 50,true)
        	call DisplayTextToPlayer(p, 0., 0., "|cFFFF66CC【消息】|r你成功的提高了50级.")
	    	call CreateUnitEffect(GetOwningPlayer(u),'h01M',GetUnitX(u),GetUnitY(u),0)
        endif
        if (GetClickedButtonBJ() == LoadButtonHandle(LHTable,GetHandleId(d),5)) then
        	//50个木头
        	call AdjustPlayerStateBJ( 50, p, PLAYER_STATE_RESOURCE_LUMBER )
        	call DisplayTextToPlayer(p, 0., 0., "|cFFFF66CC【消息】|r你成功的获得了50个木头.")
	    	call CreateUnitEffect(GetOwningPlayer(u),'h01M',GetUnitX(u),GetUnitY(u),0)
        endif
        call FlushChildHashtable(LHTable,GetHandleId(d))
        call DialogDisplay( p, d, false )
        call DialogClear(d)
        call DialogDestroy(d)
        set d = null
        set u = null
        set p = null
        call DestroyTrigger(GetTriggeringTrigger())
	endfunction
	function Xuyuan takes player p returns nothing
        local trigger t = CreateTrigger()
        local dialog d = DialogCreate()
        call DialogSetMessage( d, "选择你想要的愿望" )
        if ((udg_H[GetConvertedPlayerId(p)] != sichen and udg_H[GetConvertedPlayerId(p)] != xuanxue) or not IsKuanghuan()) then
        	call SaveButtonHandle(LHTable,GetHandleId(d),3,DialogAddButtonBJ( d, "提高50级"))
        endif
    	call SaveButtonHandle(LHTable,GetHandleId(d),1,DialogAddButtonBJ( d, "等级到100，属性不变"))
        call SaveButtonHandle(LHTable,GetHandleId(d),2,DialogAddButtonBJ( d, "属性立马提高8%(直接相乘)"))
        call SaveButtonHandle(LHTable,GetHandleId(d),5,DialogAddButtonBJ( d, "获得50点木头"))
        call SavePlayerHandle(LHTable,GetHandleId(d),4,p)
        call DialogDisplay( p, d, true )
        call TriggerRegisterDialogEvent( t, d )
        call TriggerAddAction(t, function XuyuanClick)
        set d = null
        set t = null
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    炼狱90层以上怪物的设置
	*/
	function SetPurgatory90UpUnit takes nothing returns nothing
		local integer i = GetConvertedPlayerId(GetOwningPlayer(udg_Unit))
		if ((udg_I_Lianyu[i] >= 92) and (udg_I_Lianyu[i] != 106) and (udg_I_Lianyu[i] < 110) ) then
			call UnitAddItemByIdSwapped(GetRandomPotion(), udg_Unit)
			call DisplayTextToPlayer(GetOwningPlayer(udg_Unit), 0., 0., "|cFFFF6699【炼狱】|r额外奖励"+ GetPlayerName(GetOwningPlayer(udg_Unit)) + GetItemName(GetLastCreatedItem())+".")
		endif
	    if ((udg_I_Lianyu[i] == 91)) then
	        set udg_Lianyu_Unit[i] = 'Nfir'
	        call DisplayTextToForce( GetPlayersAll(), ( "|cFFFF6699【炼狱】|r额外奖励" + ( GetPlayerName(GetOwningPlayer(udg_Unit)) + "|cffffcc001个人口，人口可以用来抓宠物。" ) ) )
	        call SetPlayerStateBJ( GetOwningPlayer(udg_Unit), PLAYER_STATE_RESOURCE_FOOD_CAP, ( GetPlayerState(GetOwningPlayer(udg_Unit), PLAYER_STATE_RESOURCE_FOOD_CAP) + 1 ) )
	    elseif ((udg_I_Lianyu[i] == 92)) then
	        set udg_Lianyu_Unit[i] = 'N00D'
	    elseif ((udg_I_Lianyu[i] == 93)) then
	        set udg_Lianyu_Unit[i] = 'N00E'
	    elseif ((udg_I_Lianyu[i] == 94)) then
	        set udg_Lianyu_Unit[i] = 'N00F'
	    elseif ((udg_I_Lianyu[i] == 95)) then
	        set udg_Lianyu_Unit[i] = 'N00G'
	    elseif ((udg_I_Lianyu[i] == 96)) then
	        set udg_Lianyu_Unit[i] = 'N00J'
	    elseif ((udg_I_Lianyu[i] == 97)) then
	        set udg_Lianyu_Unit[i] = 'N00K'
	    elseif ((udg_I_Lianyu[i] == 98)) then
	        set udg_Lianyu_Unit[i] = 'N00N'
	    elseif ((udg_I_Lianyu[i] == 99)) then
	        set udg_Lianyu_Unit[i] = 'N00O'
	    elseif ((udg_I_Lianyu[i] == 100)) then
	        set udg_Lianyu_Unit[i] = 'N00R'
	    elseif ((udg_I_Lianyu[i] == 101)) then
	        set udg_Lianyu_Unit[i] = 'N00S'
	    elseif ((udg_I_Lianyu[i] == 102)) then
	        set udg_Lianyu_Unit[i] = 'N00V'
	    elseif ((udg_I_Lianyu[i] == 103)) then
	        set udg_Lianyu_Unit[i] = 'N00X'
	    elseif ((udg_I_Lianyu[i] == 104)) then
	        set udg_Lianyu_Unit[i] = 'N010'
	    elseif ((udg_I_Lianyu[i] == 105)) then
	        set udg_Lianyu_Unit[i] = 'N00Z'
	        call DisplayTextToForce( GetPlayersAll(), ( "|cFFFF6699【炼狱】|r额外奖励" + ( GetPlayerName(GetOwningPlayer(udg_Unit)) + "|cffffcc001个人口，人口可以用来抓宠物。" ) ) )
	        call SetPlayerStateBJ( GetOwningPlayer(udg_Unit), PLAYER_STATE_RESOURCE_FOOD_CAP, ( GetPlayerState(GetOwningPlayer(udg_Unit), PLAYER_STATE_RESOURCE_FOOD_CAP) + 1 ) )
	    elseif ((udg_I_Lianyu[i] == 106)) then
	        set udg_Lianyu_Unit[i] = 'N011'
	    elseif ((udg_I_Lianyu[i] == 107)) then
	        set udg_Lianyu_Unit[i] = 'N012'
	    elseif ((udg_I_Lianyu[i] == 108)) then
	        set udg_Lianyu_Unit[i] = 'N013'
	    elseif ((udg_I_Lianyu[i] == 109)) then
	        set udg_Lianyu_Unit[i] = 'N014'
	    elseif ((udg_I_Lianyu[i] == 110)) then
	        set udg_Lianyu_Unit[i] = 'N015'
			call UnitAddItemByIdSwapped('I02U', udg_Unit)
		    call SaveInteger(YDHT,GetHandleId(GetLastCreatedItem()),0xA75AD423,i)
	        call DisplayTextToForce( GetPlayersAll(), ( "|cFFFF6699【炼狱】|r额外奖励" + ( GetPlayerName(GetOwningPlayer(udg_Unit)) + "|cffffcc001个|cffff00ff【地狱】兮月蚕芯|r,可以许一个愿望。" ) ) )
	    elseif ((udg_I_Lianyu[i] == 111)) then
	    	//下一个就是阎王啦
			call UnitAddItemByIdSwapped('I02U', udg_Unit)
		    call SaveInteger(YDHT,GetHandleId(GetLastCreatedItem()),0xA75AD423,i)
	        call DisplayTextToForce( GetPlayersAll(), ( "|cFFFF6699【炼狱】|r额外奖励" + ( GetPlayerName(GetOwningPlayer(udg_Unit)) + "|cffffcc001个|cffff00ff【地狱】兮月蚕芯|r,可以许一个愿望。" ) ) )
	    endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    炼狱掉落的物品
	*/
	function TPurgatoryItemCon takes nothing returns boolean
	    return ((IsUnitIllusionBJ(GetDyingUnit()) != true) and (/*
	    */(GetUnitTypeId(GetDyingUnit()) == 'nfra')/*
	    */or (GetUnitTypeId(GetDyingUnit()) == 'nwld')/*
	    */or (GetUnitTypeId(GetDyingUnit()) == 'nwzd')/*
	    */or (GetUnitTypeId(GetDyingUnit()) == 'ndqp')/*
	    */or (GetUnitTypeId(GetDyingUnit()) == 'nsc2')/*
	    */or (GetUnitTypeId(GetDyingUnit()) == 'nwns')/*
	    */or (GetUnitTypeId(GetDyingUnit()) == 'nsoc')/*
	    */or (GetUnitTypeId(GetDyingUnit()) == 'npfl')/*
	    */or (GetUnitTypeId(GetDyingUnit()) == 'ninm')/*
	    */))
	endfunction
	function TPurgatoryItemAct takes nothing returns nothing
		local integer dyingUnitId = GetUnitTypeId(GetDyingUnit())
		//! textmacro CreatePurgatoryItem takes UnitType,ItemType
		if (dyingUnitId == '$UnitType$') then
			call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Undead\\RaiseSkeletonWarrior\\RaiseSkeleton.mdl", GetUnitX(GetDyingUnit()), GetUnitY(GetDyingUnit()) ))
			call CreateItem('$ItemType$',GetUnitX(GetDyingUnit()),GetUnitY(GetDyingUnit()))
			return
		endif
		//! endtextmacro
		//! runtextmacro CreatePurgatoryItem("nfra","IB00")
		//! runtextmacro CreatePurgatoryItem("nwld","IMJ1")
		//! runtextmacro CreatePurgatoryItem("nwzd","IMJ2")
		//! runtextmacro CreatePurgatoryItem("ndqp","IMJ3")
		//! runtextmacro CreatePurgatoryItem("nsc2","IMJ4")
		//! runtextmacro CreatePurgatoryItem("nwns","IMJ5")
		//! runtextmacro CreatePurgatoryItem("nsoc","IMJ6")
		//! runtextmacro CreatePurgatoryItem("npfl","IMJ7")
		//! runtextmacro CreatePurgatoryItem("ninm","IMJ8")
	endfunction
//---------------------------------------------------------------------------------------------------
	private function InitPurgatory takes nothing returns nothing
		local trigger t = CreateTrigger()
	    call TriggerRegisterAnyUnitEventBJ( t, EVENT_PLAYER_UNIT_DEATH )
	    call TriggerAddCondition(t, Condition(function TPurgatoryItemCon))
	    call TriggerAddAction(t, function TPurgatoryItemAct)
	    set t = null
	endfunction
endlibrary
/*
    使用物品
*/
library_once UseItem initializer InitUse requires LHBase
//---------------------------------------------------------------------------------------------------
    /*
        使用物品(药与魔王之心)
    */
    private function TUseItem takes nothing returns nothing
        if ((GetItemTypeId(GetManipulatedItem()) == 'pomn')) then
            call SetHeroLevelBJ( udg_H[GetConvertedPlayerId(GetOwningPlayer(GetTriggerUnit()))], ( GetHeroLevel(udg_H[GetConvertedPlayerId(GetOwningPlayer(GetTriggerUnit()))]) + 50 ), true )
        elseif ((GetItemTypeId(GetManipulatedItem()) == 'I001')) then
            call SetUnitLifeBJ( udg_H[GetConvertedPlayerId(GetOwningPlayer(GetTriggerUnit()))], ( GetUnitStateSwap(UNIT_STATE_LIFE, udg_H[GetConvertedPlayerId(GetOwningPlayer(GetTriggerUnit()))]) + 10000.00 ) )
            call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Orc\\HealingWave\\HealingWaveTarget.mdl", GetUnitX(udg_H[GetConvertedPlayerId(GetOwningPlayer(GetTriggerUnit()))]), GetUnitY(udg_H[GetConvertedPlayerId(GetOwningPlayer(GetTriggerUnit()))]) ))
        elseif ((GetItemTypeId(GetManipulatedItem()) == 'I02W')) then
            call SetUnitLifeBJ( udg_H[GetConvertedPlayerId(GetOwningPlayer(GetTriggerUnit()))], ( GetUnitStateSwap(UNIT_STATE_LIFE, udg_H[GetConvertedPlayerId(GetOwningPlayer(GetTriggerUnit()))]) + 50000.00 ) )
            call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Orc\\HealingWave\\HealingWaveTarget.mdl", GetUnitX(udg_H[GetConvertedPlayerId(GetOwningPlayer(GetTriggerUnit()))]), GetUnitY(udg_H[GetConvertedPlayerId(GetOwningPlayer(GetTriggerUnit()))]) ))
        elseif ((GetItemTypeId(GetManipulatedItem()) == 'I000')) then
            call SetUnitLifeBJ( udg_H[GetConvertedPlayerId(GetOwningPlayer(GetTriggerUnit()))], ( GetUnitStateSwap(UNIT_STATE_LIFE, udg_H[GetConvertedPlayerId(GetOwningPlayer(GetTriggerUnit()))]) + 250000.00 ) )
            call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Orc\\HealingWave\\HealingWaveTarget.mdl", GetUnitX(udg_H[GetConvertedPlayerId(GetOwningPlayer(GetTriggerUnit()))]), GetUnitY(udg_H[GetConvertedPlayerId(GetOwningPlayer(GetTriggerUnit()))]) ))
        elseif ((GetItemTypeId(GetManipulatedItem()) == 'I002')) then
            call SetUnitLifeBJ( udg_H[GetConvertedPlayerId(GetOwningPlayer(GetTriggerUnit()))], ( GetUnitStateSwap(UNIT_STATE_LIFE, udg_H[GetConvertedPlayerId(GetOwningPlayer(GetTriggerUnit()))]) + 1250000.00 ) )
            call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Orc\\HealingWave\\HealingWaveTarget.mdl", GetUnitX(udg_H[GetConvertedPlayerId(GetOwningPlayer(GetTriggerUnit()))]), GetUnitY(udg_H[GetConvertedPlayerId(GetOwningPlayer(GetTriggerUnit()))]) ))
        elseif ((GetItemTypeId(GetManipulatedItem()) == 'I01D')) then
            call SetUnitLifeBJ( udg_H[GetConvertedPlayerId(GetOwningPlayer(GetTriggerUnit()))], ( GetUnitStateSwap(UNIT_STATE_LIFE, udg_H[GetConvertedPlayerId(GetOwningPlayer(GetTriggerUnit()))]) + 20000000.00 ) )
            call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Orc\\HealingWave\\HealingWaveTarget.mdl", GetUnitX(udg_H[GetConvertedPlayerId(GetOwningPlayer(GetTriggerUnit()))]), GetUnitY(udg_H[GetConvertedPlayerId(GetOwningPlayer(GetTriggerUnit()))]) ))
        endif
    endfunction
//---------------------------------------------------------------------------------------------------
    private function InitUse takes nothing returns nothing
        local trigger t = CreateTrigger()
        call TriggerRegisterAnyUnitEventBJ( t, EVENT_PLAYER_UNIT_USE_ITEM )
        call TriggerAddAction(t, function TUseItem)
        set t = null
    endfunction
endlibrary
// 基础
library_once LHOther initializer InitLHOther requires LHBase,Diffculty
	globals
	endglobals
//---------------------------------------------------------------------------------------------------
	/*
	    平分金钱
	*/
	function PingfenMoney takes player p returns nothing
		local integer i = 1
		local integer count = 0
		local integer lumber = 0
		local integer gold = 0
		loop
			exitwhen i > 6
			if ((GetPlayerSlotState(ConvertedPlayer(i)) == PLAYER_SLOT_STATE_PLAYING) and (GetPlayerController(ConvertedPlayer(i)) == MAP_CONTROL_USER) and (ConvertedPlayer(i) != p)) then
				set count = count + 1
			endif
			set i = i +1
		endloop
		if (count != 0) then
			set lumber = GetPlayerState(p, PLAYER_STATE_RESOURCE_LUMBER) / count
			set gold = GetPlayerState(p, PLAYER_STATE_RESOURCE_GOLD) / count
			call AdjustPlayerStateBJ( -1000000, p, PLAYER_STATE_RESOURCE_LUMBER )
			call AdjustPlayerStateBJ( -1000000, p, PLAYER_STATE_RESOURCE_GOLD )
			set i = 1
			loop
				exitwhen i > 6
				if ((GetPlayerSlotState(ConvertedPlayer(i)) == PLAYER_SLOT_STATE_PLAYING) and (GetPlayerController(ConvertedPlayer(i)) == MAP_CONTROL_USER) and (ConvertedPlayer(i) != p)) then
					call AdjustPlayerStateBJ( lumber, ConvertedPlayer(i), PLAYER_STATE_RESOURCE_LUMBER )
					call AdjustPlayerStateBJ( gold, ConvertedPlayer(i), PLAYER_STATE_RESOURCE_GOLD )
				endif
				set i = i +1
			endloop
		endif
	endfunction
	function DropAllItem takes unit u returns nothing
		local integer i = 1
		loop
			exitwhen i > 6
			if (not(IsMinganItem(UnitItemInSlotBJ(u,i)))) then
				call SetItemPosition(UnitItemInSlotBJ(u,i),GetRectRandomX(gg_rct______________100),GetRectRandomY(gg_rct______________100))
			endif
			set i = i +1
		endloop
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    物品叠加
	*/
	function TOverlayItemAct takes nothing returns boolean
	    return ((GetItemType(GetManipulatedItem()) == ITEM_TYPE_CHARGED))
	endfunction
	function TOverlayItemCon takes nothing returns nothing
	    local integer i = 1
	    loop
	        exitwhen i > 6
	        if ((GetManipulatedItem() != UnitItemInSlotBJ(GetTriggerUnit(), i)) and (GetItemTypeId(GetManipulatedItem()) == GetItemTypeId(UnitItemInSlotBJ(GetTriggerUnit(), i)))) then
	            call SetItemCharges( UnitItemInSlotBJ(GetTriggerUnit(), i), ( GetItemCharges(UnitItemInSlotBJ(GetTriggerUnit(), i)) + GetItemCharges(GetManipulatedItem()) ) )
	            call RemoveItem( GetManipulatedItem() )
	        else
	        endif
	        set i = i + 1
	    endloop
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    不能相互攻击
	*/
	private function TAttackAllyCon takes nothing returns boolean
		return ((GetPlayerController(GetOwningPlayer(GetAttacker())) == MAP_CONTROL_USER) and (GetAttackedUnitBJ() == udg_H[GetConvertedPlayerId(GetOwningPlayer(GetAttackedUnitBJ()))]) and IsUnitAlly(GetAttacker(),GetOwningPlayer(GetAttackedUnitBJ())))
	endfunction
	private function TAttackAllyAct takes nothing returns nothing
			call IssueImmediateOrder(GetAttacker(),"stop")
			if (GetUnitTypeId(GetAttacker()) != 'h028') then
				call DisplayTimedTextToForce( GetPlayersAll(), 20, "|cFFFF66CC【提示】|r有人企图攻击自己的英雄队友，被伟大的Crainax制止了。" )
			endif
	endfunction
//---------------------------------------------------------------------------------------------------
    /*
        获取经验
    */
    function TGetExCon takes nothing returns boolean
        return ((IsPlayerEnemy(GetOwningPlayer(GetDyingUnit()), Player(0)) == true) and (GetOwningPlayer(GetKillingUnitBJ()) != Player(11)) and (GetOwningPlayer(GetKillingUnitBJ()) != Player(10)) and (IsUnitIllusionBJ(GetDyingUnit()) != true) and (GetOwningPlayer(GetKillingUnitBJ()) != Player(PLAYER_NEUTRAL_AGGRESSIVE)) and (GetUnitPointValue(GetDyingUnit()) != 0) and (GetUnitPointValue(GetDyingUnit()) != 123) and (GetPlayerController(GetOwningPlayer(GetDyingUnit())) != MAP_CONTROL_USER))
    endfunction
    function TGetExAct takes nothing returns nothing
       local integer i = 1
       local integer basicEx = 0
       loop
            exitwhen i > 6
            if (udg_H[i] != null and (udg_H[i] != xinglong or BJuexing1[i] or GetOwningPlayer(GetKillingUnitBJ()) == GetOwningPlayer(xinglong))) then
	            set basicEx = GetWanjieInt(R2I(I2R(GetUnitPointValue(GetDyingUnit())) * udg_I_Jingyan[i]),0.75)
	            call AddHeroXPSwapped( CModeH(basicEx,basicEx*2), udg_H[i], true )
            endif
            set i = i + 1
       endloop
    endfunction
//---------------------------------------------------------------------------------------------------
	private function InitLHOther takes nothing returns nothing
		//物品叠加
	    local trigger t = CreateTrigger()
	    call TriggerRegisterAnyUnitEventBJ( t, EVENT_PLAYER_UNIT_PICKUP_ITEM )
	    call TriggerAddCondition(t, Condition(function TOverlayItemAct))
	    call TriggerAddAction(t, function TOverlayItemCon)
	    //队友将不能互相攻击
		set t = CreateTrigger()
		call TriggerRegisterAnyUnitEventBJ(t,EVENT_PLAYER_UNIT_ATTACKED)
		call TriggerAddCondition(t, Condition(function TAttackAllyCon))
		call TriggerAddAction(t, function TAttackAllyAct)
        //获取经验
		set t = CreateTrigger()
        call TriggerRegisterAnyUnitEventBJ( t, EVENT_PLAYER_UNIT_DEATH )
        call TriggerAddCondition(t, Condition(function TGetExCon))
        call TriggerAddAction(t, function TGetExAct)
	    set t = null
	endfunction
endlibrary
// 高难系数
// 装备属性初始化
/*
    物品类型的属性初始化
*/
library_once ItemAttr initializer InitItemAttr requires LHBase,Attr
//---------------------------------------------------------------------------------------------------
	/*
	    力量
	*/
	private function SetItemStr takes integer itemID,integer value returns nothing
		call SaveInteger(YDHT,itemID,0x8D205575,value)
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    敏捷
	*/
	private function SetItemAgi takes integer itemID,integer value returns nothing
		call SaveInteger(YDHT,itemID,0x384C9D86,value)
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    智力
	*/
	private function SetItemInt takes integer itemID,integer value returns nothing
		call SaveInteger(YDHT,itemID,0x1B5C932E,value)
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    3W
	*/
	private function SetItem3W takes integer itemID,integer value returns nothing
		call SaveInteger(YDHT,itemID,0x5BAE281D,value)
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    生命
	*/
	private function SetItemHP takes integer itemID,integer value returns nothing
		call SaveInteger(YDHT,itemID,0xFCD961C9,value)
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    防御
	*/
	private function SetItemDefense takes integer itemID,integer value returns nothing
		call SaveInteger(YDHT,itemID,0x81FD3994,value)
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    攻击
	*/
	private function SetItemAttack takes integer itemID,integer value returns nothing
		call SaveInteger(YDHT,itemID,0x5039AFFB,value)
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    吸血
	*/
	private function SetItemXixue takes integer itemID,integer value returns nothing
		call SaveInteger(YDHT,itemID,0x1ADEDE7B,value)
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    弓直伤
	*/
	private function SetItemZhishang takes integer itemID,integer value returns nothing
		call SaveInteger(YDHT,itemID,0xA6870C96,value)
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    被攻击反击
	*/
	private function SetItemFanji takes integer itemID,integer value returns nothing
		call SaveInteger(YDHT,itemID,0x0F3DF677,value)
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    力量加成
	*/
	private function SetItemStrPerc takes integer itemID,real value returns nothing
		call SaveReal(YDHT,itemID,0x06C64278,value)
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    敏捷加成
	*/
	private function SetItemAgiPerc takes integer itemID,real value returns nothing
		call SaveReal(YDHT,itemID,0x6FFF4132,value)
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    智力加成
	*/
	private function SetItemIntPerc takes integer itemID,real value returns nothing
		call SaveReal(YDHT,itemID,0xC0C6918C,value)
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    攻击加成
	*/
	private function SetItemAttackPerc takes integer itemID,real value returns nothing
		call SaveReal(YDHT,itemID,0x4C0507D9,value)
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    技能伤害加成
	*/
	private function SetItemSpellPerc takes integer itemID,real value returns nothing
		call SaveReal(YDHT,itemID,0xF374F3BD,value)
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    造成伤害加成
	*/
	private function SetItemDamagePerc takes integer itemID,real value returns nothing
		call SaveReal(YDHT,itemID,0xA3BA0D94,value)
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    经验获得率
	*/
	private function SetItemJingyan takes integer itemID,real value returns nothing
		call SaveReal(YDHT,itemID,0x3EBF688A,value)
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    HP加成
	*/
	private function SetItemHPPer takes integer itemID,real value returns nothing
		call SaveReal(YDHT,itemID,0xFAA305CD,value)
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    防御加成
	*/
	private function SetItemDefensePer takes integer itemID,real value returns nothing
		call SaveReal(YDHT,itemID,0x0B6FB20F,value)
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    初始化六涛天虹
	*/
	private function InitErdianQi takes nothing returns nothing
		/*
		    六涛天虹
		*/
		call SetItemStrPerc('I049',0.2)
		call SetItemAgiPerc('I049',0.2)
		call SetItemIntPerc('I049',0.2)
		call SetItemAttackPerc('I049',0.5)
		call SetItemSpellPerc('I049',0.4)
		call SetItemDamagePerc('I049',0.2)
		call SetItemStrPerc('I04A',1)
		call SetItemAgiPerc('I04A',1)
		call SetItemIntPerc('I04A',1)
		call SetItemAttackPerc('I04A',1)
		call SetItemSpellPerc('I04A',1)
		call SetItemDamagePerc('I04A',0.4)
		/*
		    梵天披风
		*/
		call SetItemStr('ciri',400000)
		call SetItemAgi('ciri',400000)
		call SetItemInt('ciri',400000)
		call SetItemDefense('ciri',20000)
		call SetItemHP('ciri',9000000)
		call SetItemSpellPerc('ciri',0.8)
		call SetItemDamagePerc('ciri',0.25)
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    初始化超神器与戒指
	*/
	private function InitErdianBa takes nothing returns nothing
		/*
		    诛神噬魔
		*/
		call SetItemStr('tlum',320000)
		call SetItemAgi('tlum',470000)
		call SetItemInt('tlum',420000)
		call SetItemSpellPerc('tlum',1.3)
		call SetItemXixue('tlum',40000)
		call SetItemZhishang('tlum',8000000)
		call SetItemAttack('tlum',2000000)
		/*
		    鬼戒指
		*/
		call SetItem3W( 'rat9', 3000)
	    call SetItem3W( 'rlif', 9000)
	    call SetItem3W( 'lgdh', 18000)
	    call SetItem3W( 'clfm', 30000)
	    call SetItem3W( 'bgst', 45000)
	    call SetItem3W( 'belv', 63000)
	    call SetItem3W( 'hcun', 84000)
	    call SetItem3W( 'rag1', 108000 )
	    call SetItem3W( 'penr', 135000 )
	    call SetItem3W( 'brac', 165000 )
	    call SetItem3W( 'lhst', 240000 )
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    初始化衣服还有新灯
	*/
	private function InitDengClothes takes nothing returns nothing
		//灯
	    call SetItem3W( 'ILI1', 1000 )
	    call SetItem3W( 'ILI2', 3000 )
	    call SetItem3W( 'ILI3', 7500 )
	    call SetItem3W( 'ILI4', 15000 )
	    call SetItem3W( 'ILI5', 25000 )
	    call SetItem3W( 'ILI6', 40000 )
	    call SetItem3W( 'ILI7', 60000 )
	    call SetItem3W( 'ILI8', 80000 )
	    call SetItem3W( 'ILI9', 120000 )
	    call SetItem3W( 'ILIA', 150000 )
	    call SetItem3W( 'ILIB', 180000 )
	    call SetItem3W( 'ILIC', 200000 )
	    call SetItem3W( 'ILID', 220000 )
	    call SetItem3W( 'ILIE', 250000 )
	    call SetItem3W( 'ILIF', 290000 )
	    call SetItem3W( 'ILIG', 340000 )
	    call SetItem3W( 'ILIH', 380000 )
	    call SetItem3W( 'ILII', 420000 )
	    call SetItem3W( 'ILIJ', 450000 )
	    call SetItem3W( 'ILIK', 490000 )
	    call SetItem3W( 'I07D', 530000 )
		call SetItemXixue( 'ILI3', 8000 )
		call SetItemXixue( 'ILI4', 16000 )
		call SetItemXixue( 'ILI5', 25000 )
		call SetItemXixue( 'ILI6', 34000)
		call SetItemXixue( 'ILI7', 50000)
		call SetItemXixue( 'ILI8', 100000)
		call SetItemXixue( 'ILI9', 200000)
		call SetItemXixue( 'ILIA', 300000)
		call SetItemXixue( 'ILIB', 400000)
		call SetItemXixue( 'ILIC', 600000)
		call SetItemXixue( 'ILID', 800000)
		call SetItemXixue( 'ILIE', 1000000)
		call SetItemXixue( 'ILIF', 1300000)
		call SetItemXixue( 'ILIG', 1500000)
		call SetItemXixue( 'ILIH', 1800000)
		call SetItemXixue( 'ILII', 2200000)
		call SetItemXixue( 'ILIJ', 2800000)
		call SetItemXixue( 'ILIK', 3300000)
		call SetItemXixue( 'I07D', 4000000)
		//衣服
	    call SetItemDefense( 'rej6' , 1500)
	    call SetItemDefense( 'dtsb' , 2000)
	    call SetItemDefense( 'tels' , 3000)
		call SetItemDefense( 'ofir' , 3800)
		call SetItemDefense( 'soul' , 5000)
		call SetItemDefense( 'sbok' , 6000)
		call SetItemDefense( 'arsc' , 9500)
		call SetItemDefense( 'rde0' , 13000)
		call SetItemDefense( 'oflg' , 13000)
		call SetItemDefense( 'frgd' , 16000)
		call SetItemDefense( 'rej4' , 2000)
		call SetItemDefense( 'drph' , 3000)
		call SetItemDefense( 'oven' , 3800)
		call SetItemDefense( 'frhg' , 5000)
		call SetItemDefense( 'mlst' , 6000)
		call SetItemDefense( 'nspi' , 7000)
		call SetItemDefense( 'oli2' , 10500)
		call SetItemDefense( 'rump' , 13000)
		call SetItemDefense( 'shen' , 15000)
		call SetItemDefense( 'stpg' , 19000)
		call SetItemDefense( 'pgin' , 1500)
		call SetItemDefense( 'gobm' , 2000)
		call SetItemDefense( 'gvsm' , 3000)
		call SetItemDefense( 'gldo' , 3800)
		call SetItemDefense( 'gsou' , 5000)
		call SetItemDefense( 'envl' , 6000)
		call SetItemDefense( 'rugt' , 7000)
		call SetItemDefense( 'shdt' , 11000)
		call SetItemDefense( 'crdt' , 13000)
		call SetItemDefense( 'pspd' , 16000)
	    call SetItemHP('rej6' , 200000)
		call SetItemHP('dtsb' , 300000)
		call SetItemHP('tels' , 400000)
		call SetItemHP('ofir' , 500000)
		call SetItemHP('soul' , 600000)
		call SetItemHP('sbok' , 1750000)
		call SetItemHP('arsc' , 2950000)
		call SetItemHP('rde0' , 4200000)
		call SetItemHP('oflg' , 4500000)
		call SetItemHP('frgd' , 6000000)
		call SetItemHP('rej4' , 300000)
		call SetItemHP('drph' , 400000)
		call SetItemHP('oven' , 500000)
		call SetItemHP('frhg' , 600000)
		call SetItemHP('mlst' , 750000)
		call SetItemHP('nspi' , 1950000)
		call SetItemHP('oli2' , 3200000)
		call SetItemHP('rump' , 4500000)
		call SetItemHP('shen' , 2000000)
		call SetItemHP('stpg' , 6500000)
		call SetItemHP('pgin' , 200000)
		call SetItemHP('gobm' , 300000)
		call SetItemHP('gvsm' , 400000)
		call SetItemHP('gldo' , 500000)
		call SetItemHP('gsou' , 600000)
		call SetItemHP('envl' , 1750000)
		call SetItemHP('rugt' , 2950000)
		call SetItemHP('shdt' , 4200000)
		call SetItemHP('crdt' , 4500000)
		call SetItemHP('pspd' , 6000000)
    	call SetItem3W('rej6' , 10000)
		call SetItem3W('dtsb' , 16000)
		call SetItem3W('tels' , 25000)
		call SetItem3W('ofir' , 50000)
		call SetItem3W('soul' , 80000)
		call SetItem3W('sbok' , 120000)
		call SetItem3W('arsc' , 150000)
		call SetItem3W('rde0' , 210000)
		call SetItem3W('oflg' , 270000)
		call SetItem3W('frgd' , 320000)
		call SetItem3W('rej4' , 6000)
		call SetItem3W('drph' , 10000)
		call SetItem3W('oven' , 16000)
		call SetItem3W('frhg' , 35000)
		call SetItem3W('mlst' , 60000)
		call SetItem3W('nspi' , 100000)
		call SetItem3W('oli2' , 130000)
		call SetItem3W('rump' , 160000)
		call SetItem3W('shen' , 220000)
		call SetItem3W('stpg' , 280000)
		call SetItem3W('pgin' , 6000)
		call SetItem3W('gobm' , 10000)
		call SetItem3W('gvsm' , 16000)
		call SetItem3W('gldo' , 35000)
		call SetItem3W('gsou' , 60000)
		call SetItem3W('envl' , 100000)
		call SetItem3W('rugt' , 130000)
		call SetItem3W('shdt' , 160000)
		call SetItem3W('crdt' , 220000)
		call SetItem3W('pspd' , 280000)
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    魔兽
	*/
	private function InitBeast takes nothing returns nothing
		call SetItemJingyan('I01S', 0.50)
	    call SetItemJingyan('IB05', 1.75)
	    call SetItemJingyan('IB03', 1.25)
	    call SetItemJingyan('IB00', 0.50)
	    call SetItemJingyan('IB01', 0.75)
	    call SetItemJingyan('IB09', 3.00)
	    call SetItemJingyan('IB08', 2.50)
	    call SetItemJingyan('IB06', 2.00)
	    call SetItemJingyan('IB07', 2.25)
	    call SetItemJingyan('IB04', 1.50)
	    call SetItemJingyan('IB02', 1.00)
	    call SetItemJingyan('I04X', 3.50)
	    call SetItemJingyan('IB0A', 3.50)
	    call SetItemJingyan('I07O', 4.00)
	    call SetItemJingyan('I07N', 4.00)
	    call SetItemJingyan('ratc', 5.00)
	    call SetItemJingyan('I04L', 6.00)
	    call SetItemJingyan('I04M', 6.00)
	    call SetItemHP('IB05' , 3200000)
		call SetItemHP('IB03' , 800000)
		call SetItemHP('IB00' , 50000)
		call SetItemHP('IB01' , 200000)
		call SetItemHP('IB09' , 20000000)
		call SetItemHP('I04X' , 30000000)
		call SetItemHP('IB0A' , 30000000)
		call SetItemHP('I07O' , 40000000)
		call SetItemHP('I07N' , 40000000)
		call SetItemHP('IB08' , 14000000)
		call SetItemHP('IB06' , 5000000)
		call SetItemHP('IB07' , 7000000)
		call SetItemHP('IB04' , 1600000)
		call SetItemHP('IB02' , 400000)
	    call SetItem3W( 'IB05' , 32000)
	    call SetItem3W( 'IB03' , 15000)
	    call SetItem3W( 'IB01' , 5000)
	    call SetItem3W( 'IB09' , 150000)
	    call SetItem3W( 'I04X' , 220000)
	    call SetItem3W( 'IB0A' , 220000)
	    call SetItem3W( 'I07O' , 270000)
	    call SetItem3W( 'I07N' , 270000)
	    call SetItem3W( 'IB08' , 100000)
	    call SetItem3W( 'IB06' , 50000)
	    call SetItem3W( 'IB07' , 70000)
	    call SetItem3W( 'IB04' , 24000)
	    call SetItem3W( 'IB02' , 8000)
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    擂台初始化
	*/
	private function InitLeitai takes nothing returns nothing
		//擂台
		call SetItem3W( 'prvt' , 1500)
	    call SetItem3W( 'cnob' , 5000)
	    call SetItem3W( 'rhth' , 8000)
	    call SetItemStr( 'hval' , 30000)
	    call SetItem3W( 'afac' , 30000)
	    call SetItem3W( 'pmna' , 80000)
	    call SetItem3W( 'evtl' , 120000)
	    call SetItem3W( 'bspd' , 160000)
	    call SetItem3W( 'mcou' , 250000)
		call SetItemSpellPerc( 'mcou' , 0.70)
		call SetItemAttack( 'mcou' , 2300000)
		call SetItemDefensePer( 'mcou', 0.15)
		call SetItemDamagePerc( 'mcou' , 0.20)
		//皎月
	    call SetItem3W( 'I04L' , 250000)
		call SetItemSpellPerc( 'I04L' , 0.70)
		call SetItemAttack( 'I04L' , 2300000)
		call SetItemDefensePer( 'I04L', 0.15)
		call SetItemDamagePerc( 'I04L' , 0.20)
		//混沌夜哀
	    call SetItem3W( 'I04M' , 250000)
		call SetItemSpellPerc( 'I04M' , 0.70)
		call SetItemAttack( 'I04M' , 2300000)
		call SetItemDefensePer( 'I04M', 0.15)
		call SetItemDamagePerc( 'I04M' , 0.20)
	    call SetItemSpellPerc( 'cnob' , 0.15)
		call SetItemSpellPerc( 'hval' , 0.25)
		call SetItemSpellPerc( 'afac' , 0.40)
		call SetItemSpellPerc( 'pmna' , 0.50)
		call SetItemSpellPerc( 'evtl' , 0.55)
		call SetItemSpellPerc( 'bspd' , 0.65)
		call SetItemSpellPerc( 'rde3' , 0.30)
	    call SetItemAttack( 'rhth' , 35000)
		call SetItemAttack( 'afac' , 200000)
		call SetItemAttack( 'bspd' , 1500000)
	    call SetItemHP( 'rhth' , 100000)
	    call SetItemHP( 'evtl' , 1000000)
	    call SetItemDefense( 'hval' , 1000)
	    call SetItemHPPer( 'pmna' , 0.10)
		call SetItemHPPer( 'rde3' , 0.20)
		call SetItemDefensePer( 'evtl', 0.10)
		call SetItemDefensePer( 'rde3', 0.20)
		call SetItemDamagePerc( 'evtl' , 0.10)
		call SetItemDamagePerc( 'bspd' , 0.15)
		call SetItemDamagePerc( 'rde3' , 0.20)
		call SetItemStrPerc('rde3', 0.20)
		call SetItemAgiPerc( 'rde3', 0.20)
		call SetItemIntPerc( 'rde3', 0.20)
		call SetItemAttackPerc( 'rde3', 0.50)
		call SetItemHPPer( 'ssil' , 0.30)
		call SetItemDefensePer( 'ssil', 0.30)
		call SetItemDamagePerc( 'ssil' , 0.30)
		call SetItemStrPerc('ssil', 0.30)
		call SetItemAgiPerc( 'ssil', 0.30)
		call SetItemIntPerc( 'ssil', 0.30)
		call SetItemAttackPerc( 'ssil', 0.75)
	    call SetItemSpellPerc( 'ssil' , 0.45)
	    //极恶之镜
	    call SetItem3W( 'I078' , 80000)
	    call SetItemSpellPerc( 'I078' , 0.5)
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    超神
	*/
	function InitChaoshen takes nothing returns nothing
	    call SetItemAttack( 'rst1', 1500000)
	    call SetItemSpellPerc( 'rst1', 1.00)
	    call SetItem3W('I05F', 370000)
	    call SetItemHP('I05F', 2500000)
	    call SetItemFanji('I05F' , 5000000)
	    call SetItemSpellPerc( 'I05F', 1.00)
	    call SetItem3W('tbsm', 350000)
	    call SetItemDefense('tbsm', 25000)
	    call SetItemHP('tbsm', 9000000)
	    call SetItem3W('tfar', 420000)
	    call SetItemDefense('tfar', 20000)
	    call SetItemHP('tfar', 7500000)
	    call SetItem3W('tbak', 350000)
	    call SetItemHP('tbak', 7500000)
	    call SetItemDefense('tbak', 20000)
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    初始化混沌装备
	*/
	function InitHundun takes nothing returns nothing
		/*
		    诛神噬魔
		*/
		call SetItemStr('ICS1',360000)
		call SetItemAgi('ICS1',510000)
		call SetItemInt('ICS1',460000)
		call SetItemSpellPerc('ICS1',1.4)
		call SetItemXixue('ICS1',80000)
		call SetItemZhishang('ICS1',10000000)
		call SetItemAttack('ICS1',3000000)
		call SetItemStr('I04W',360000)
		call SetItemAgi('I04W',510000)
		call SetItemInt('I04W',460000)
		call SetItemSpellPerc('I04W',1.4)
		call SetItemXixue('I04W',80000)
		call SetItemZhishang('I04W',10000000)
		call SetItemAttack('I04W',3000000)
		call SetItemStr('I07E',420000)
		call SetItemAgi('I07E',570000)
		call SetItemInt('I07E',520000)
		call SetItemSpellPerc('I07E',1.7)
		call SetItemXixue('I07E',150000)
		call SetItemZhishang('I07E',20000000)
		call SetItemAttack('I07E',4000000)
		call SetItemStr('I07F',420000)
		call SetItemAgi('I07F',570000)
		call SetItemInt('I07F',520000)
		call SetItemSpellPerc('I07F',1.7)
		call SetItemXixue('I07F',150000)
		call SetItemZhishang('I07F',20000000)
		call SetItemAttack('I07F',4000000)
		/*
		    幽冥项链
		*/
		call SetItemHPPer( 'I05T' , 0.35)
		call SetItemDefensePer( 'I05T', 0.35)
		call SetItemDamagePerc( 'I05T' , 0.35)
		call SetItemStrPerc('I05T', 0.35)
		call SetItemAgiPerc( 'I05T', 0.35)
		call SetItemIntPerc( 'I05T', 0.35)
		call SetItemAttackPerc( 'I05T', 0.75)
	    call SetItemSpellPerc( 'I05T' , 0.5)
		call SetItemHPPer( 'I04Y' , 0.35)
		call SetItemDefensePer( 'I04Y', 0.35)
		call SetItemDamagePerc( 'I04Y' , 0.35)
		call SetItemStrPerc('I04Y', 0.35)
		call SetItemAgiPerc( 'I04Y', 0.35)
		call SetItemIntPerc( 'I04Y', 0.35)
		call SetItemAttackPerc( 'I04Y', 0.75)
	    call SetItemSpellPerc( 'I04Y' , 0.5)
		call SetItemHPPer( 'I07G' , 0.4)
		call SetItemDefensePer( 'I07G', 0.4)
		call SetItemDamagePerc( 'I07G' , 0.4)
		call SetItemStrPerc('I07G', 0.4)
		call SetItemAgiPerc( 'I07G', 0.4)
		call SetItemIntPerc( 'I07G', 0.4)
		call SetItemAttackPerc( 'I07G', 0.8)
	    call SetItemSpellPerc( 'I07G' , 0.6)
		call SetItemHPPer( 'I07H' , 0.4)
		call SetItemDefensePer( 'I07H', 0.4)
		call SetItemDamagePerc( 'I07H' , 0.4)
		call SetItemStrPerc('I07H', 0.4)
		call SetItemAgiPerc( 'I07H', 0.4)
		call SetItemIntPerc( 'I07H', 0.4)
		call SetItemAttackPerc( 'I07H', 0.8)
	    call SetItemSpellPerc( 'I07H' , 0.6)
		/*
		    衣服
		*/
	    call SetItem3W('I05Y', 400000)
	    call SetItemDefense('I05Y', 30000)
	    call SetItemHP('I05Y', 15000000)
	    call SetItem3W('I05Z', 470000)
	    call SetItemDefense('I05Z', 25000)
	    call SetItemHP('I05Z', 10000000)
	    call SetItem3W('I060', 400000)
	    call SetItemDefense('I060', 25000)
	    call SetItemHP('I060', 10000000)
	    call SetItem3W('I07K', 470000)
	    call SetItemDefense('I07K', 37000)
	    call SetItemHP('I07K', 20000000)
	    call SetItem3W('I07J', 540000)
	    call SetItemDefense('I07J', 30000)
	    call SetItemHP('I07J', 15000000)
	    call SetItem3W('I07I', 470000)
	    call SetItemDefense('I07I', 30000)
	    call SetItemHP('I07I', 15000000)
	    /*
	        双魂
	    */
	    call SetItemSpellPerc('ICX1',1.5)
	    call SetItemAttack('ICX1',2500000)
	    call SetItemSpellPerc('I05U',1.7)
	    call SetItemAttack('I05U',4000000)
	    /*
	        戒指
	    */
	    call SetItem3W('I05W',400000)
	    call SetItem3W('I05V',300000)
	    call SetItem3W('I07M',470000)
	    call SetItem3W('I07L',370000)
	    /*
	        翅膀
	    */
	    call SetItem3W('I05X',410000)
	    call SetItemHP('I05X',5000000)
	    call SetItemFanji('I05X',80000000)
	    call SetItemSpellPerc('I05X',1.2)
	    call SetItem3W('ICY1',470000)
	    call SetItemHP('ICY1',5000000)
	    call SetItemFanji('ICY1',80000000)
	    call SetItemSpellPerc('ICY1',1.3)
	    call SetItem3W('I07P',480000)
	    call SetItemHP('I07P',8000000)
	    call SetItemFanji('I07P',120000000)
	    call SetItemSpellPerc('I07P',1.4)
	    call SetItem3W('I07Q',550000)
	    call SetItemHP('I07Q',8000000)
	    call SetItemFanji('I07Q',120000000)
	    call SetItemSpellPerc('I07Q',1.5)
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    初始化
	*/
	private function InitItemAttr takes nothing returns nothing
		call InitErdianQi()
		call InitErdianBa()
		call InitDengClothes()
		call InitBeast()
		call InitLeitai()
		call InitChaoshen()
		call InitHundun()
	endfunction
endlibrary
// VIP
// 多面板
// 转生
// 黑店
/*
    黑店
*/
library_once TouristTrap initializer InitTouristTrap requires LHBase
	globals
		/*
		    是否合成过半超神的Flag
		*/
		boolean array HasCombineHalf
	endglobals
//---------------------------------------------------------------------------------------------------
	/*
	    贩卖顶级神器的地方
	*/
	private function TTouristTrapSellCon takes nothing returns boolean
		return (GetUnitTypeId(GetSellingUnit()) == 'uS01')
	endfunction
	private function TTouristTrapSellAct takes nothing returns nothing
		local integer index = GetConvertedPlayerId(GetOwningPlayer(GetBuyingUnit()))
		local integer lumber
		if not (HasCombineHalf[index]) then
			call DisplayTextToPlayer(ConvertedPlayer(index), 0., 0., "|cFFFF66CC【消息】|r你从未合成过任一半超神器！")
			return
		endif
		if (HasLiuli(GetBuyingUnit())) then
			set lumber = 1000
		else
			set lumber = 3000
		endif
		if (GetPlayerState(GetOwningPlayer(GetBuyingUnit()), PLAYER_STATE_RESOURCE_LUMBER) < lumber) then
			call DisplayTextToPlayer(ConvertedPlayer(index), 0., 0., "|cFFFF66CC【消息】|r你没有"+I2S(lumber)+"的木头！")
			return
		endif
		call AdjustPlayerStateBJ(-1*lumber,ConvertedPlayer(index),PLAYER_STATE_RESOURCE_LUMBER)
		call DisplayTextToPlayer(ConvertedPlayer(index), 0., 0., "|cFFFF66CC【消息】|r购买成功！")
		//! textmacro GiveMaxShen takes BuyType,GiveType
			if ((GetItemTypeId(GetSoldItem()) == '$BuyType$')) then
				call UnitAddItemByIdSwapped('$GiveType$',GetBuyingUnit())
        		call SaveInteger(YDHT,GetHandleId(GetLastCreatedItem()),0xA75AD423,GetConvertedPlayerId(GetOwningPlayer(GetBuyingUnit())))
	            return
			endif
		//! endtextmacro
		//! runtextmacro GiveMaxShen("IXU2","olig")
		//! runtextmacro GiveMaxShen("IXU3","srtl")
		//! runtextmacro GiveMaxShen("IXU4","shhn")
		//! runtextmacro GiveMaxShen("IXU5","flag")
		//! runtextmacro GiveMaxShen("IXU6","shcw")
		//! runtextmacro GiveMaxShen("IXU7","shtm")
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    初始化
	*/
	private function InitTouristTrap takes nothing returns nothing
		local trigger t = CreateTrigger()
		call TriggerRegisterAnyUnitEventBJ(t,EVENT_PLAYER_UNIT_SELL_ITEM)
		call TriggerAddCondition(t, Condition(function TTouristTrapSellCon))
		call TriggerAddAction(t, function TTouristTrapSellAct)
		set t = null
	endfunction
endlibrary
// 宠物有关
///#include  "edit/NetVersion.j"
/*
    宠物系统
*/
library_once Pet initializer InitPet requires LHBase,Version,Diffculty,ChallangerDZ
    globals
        group array GPet
    endglobals
//---------------------------------------------------------------------------------------------------
    /*
        创建宠物
    */
    function CreatePet takes player owner,unit pet returns nothing
        local unit u =null
        if (CT1() and GetUnitLevel(pet) > 20) then
            call DisplayTextToPlayer(owner, 0., 0., "|cFFFF66CC【消息】|r目前挑战是力量透支挑战,该挑战下不能捕捉超过20级的怪物.")
            return
        endif
        set u = pet
        call PlaySoundBJ( gg_snd_GoodJob )
        call DestroyEffect( AddSpecialEffect("Abilities\\Spells\\Human\\Resurrect\\ResurrectCaster.mdl", GetUnitX(pet), GetUnitY(pet)) )
        //删除原有的宠物并清空缓存
        call SetUnitOwner( pet, owner, true )
        /*call KillUnit( pet )
        call FlushChildHashtable(YDHT,GetHandleId(pet))
        call YDWEFlushMissionByInteger( YDWEH2I(pet) )
        call RemoveUnit( pet )*/
        //添加技能
        if (IsTianyan) then
            call RemoveDiffAttack(u)
        endif
        call UnitAddAbilityBJ( 'AInv', u )
        call UnitAddAbilityBJ( 'A06E', u )
        call UnitAddAbilityBJ( 'A06F', u )
        call UnitAddAbilityBJ( 'A0P0', u )
        call UnitAddType( u, UNIT_TYPE_PEON )
        call SetUnitAcquireRange( u, 600.00 )
        call UnitAddAbilityBJ( 'A08M', u )
        call GroupAddUnitSimple( u, GPet[GetConvertedPlayerId(owner)] )
        call UnitAddAbilityBJ( 'Avul', u )
        call DisplayTextToPlayer( owner, 0, 0, "|cFFFF66CC【消息】|r捕捉成功！" )
        call IssueTargetOrder(u,"attack",udg_H[GetConvertedPlayerId(owner)])
        call SetPlayerStateBJ( owner, PLAYER_STATE_RESOURCE_FOOD_USED, ( GetPlayerState(owner, PLAYER_STATE_RESOURCE_FOOD_USED) + 1 ) )
        set u = null
    endfunction
//---------------------------------------------------------------------------------------------------
    /*
        抓宠物技能
    */
    function TCatchPetAct takes nothing returns nothing
        //! textmacro CatchPet takes Spell,Net,Limit
            //忠诚单位
            if (GetSpellAbilityId() == '$Spell$') then
                //忠诚单位无效:
                if (IsLoyalUnit(GetSpellTargetUnit())) then
                    call UnitAddItemByIdSwapped( '$Net$', GetTriggerUnit() )
                    call DisplayTextToPlayer( GetOwningPlayer(GetTriggerUnit()), 0, 0, "|cFFFF66CC【消息】|r不能抓忠诚单位。" )
                    return
                endif
                if (GetUnitLevel(GetSpellTargetUnit()) > 19 and GetUnitLevel(GetSpellTargetUnit()) > GetHeroLevel(udg_H[GetConvertedPlayerId(GetOwningPlayer(GetTriggerUnit()))])) then
                    call UnitAddItemByIdSwapped( '$Net$', GetTriggerUnit() )
                    call DisplayTextToPlayer( GetOwningPlayer(GetTriggerUnit()), 0, 0, "|cFFFF66CC【消息】|r你的英雄需要"+I2S(GetUnitLevel(GetSpellTargetUnit()))+"级你才能捕捉该单位." )
                    return
                endif
                if ((GetPlayerState(GetOwningPlayer(GetTriggerUnit()), PLAYER_STATE_RESOURCE_FOOD_USED) >= ( GetPlayerState(GetOwningPlayer(GetTriggerUnit()), PLAYER_STATE_RESOURCE_FOOD_CAP) - 0 ))) then
                    call UnitAddItemByIdSwapped( '$Net$', GetTriggerUnit() )
                    call DisplayTextToPlayer( GetOwningPlayer(GetTriggerUnit()), 0, 0, "|cFFFF66CC【消息】|r你的人口已满,请通过炼狱提升你的人口数." )
                    return
                endif
                if ((GetUnitStateSwap(UNIT_STATE_LIFE, GetSpellTargetUnit()) >= $Limit$)) then
                    call UnitAddItemByIdSwapped( '$Net$', GetTriggerUnit() )
                    call DisplayTextToPlayer( GetOwningPlayer(GetTriggerUnit()), 0, 0, "|cFFFF66CC【消息】|r目标生物HP为"+I2S(R2I(GetUnitState(GetSpellTargetUnit(),UNIT_STATE_LIFE)/10000))+"万血,超过了网的"+I2S($Limit$)+"HP捕捉上限!" )
                    return
                endif
                if (GetSpellAbilityId() == 'A04Q') then
                    debug call SavePetAchievement(GetOwningPlayer(GetTriggerUnit()),GetUnitLevel(GetSpellTargetUnit()))
                endif
                call CreatePet(GetOwningPlayer(GetTriggerUnit()),GetSpellTargetUnit())
                return
            endif
        //! endtextmacro
        //! runtextmacro CatchPet("A06D","I073","10000")
        //! runtextmacro CatchPet("A04P","I074","100000")
        //! runtextmacro CatchPet("A04Q","I075","500000")
        //! runtextmacro CatchPet("A04R","I072","2000000")
        //! runtextmacro CatchPet("A0E1","I071","20000000")
    endfunction
//---------------------------------------------------------------------------------------------------
    /*
        宠物没切换形态时,不能攻击
    */
    function TAttackForbitCon takes nothing returns boolean
        return ((GetUnitAbilityLevelSwapped('A06F', GetAttacker()) == 1) and IsUnitInGroup(GetAttacker(),GPet[GetConvertedPlayerId(GetOwningPlayer(GetAttacker()))]) == true)
    endfunction
    function TAttackForbitAct takes nothing returns nothing
        call DisplayTextToPlayer( GetOwningPlayer(GetAttacker()), 0, 0, "|cFFFF66CC【消息】|r想攻击的话使用技能“切换形态”。" )
        //停止命令
        call IssueImmediateOrderById( GetAttacker(), 851972 )
    endfunction
//---------------------------------------------------------------------------------------------------
    /*
        宠物切换形态
    */
    private function TPetChangeForm takes nothing returns nothing
        //切换形态1:
        if (GetSpellAbilityId() == 'A06G') then
            call UnitAddType( GetTriggerUnit(), UNIT_TYPE_PEON )
            call UnitAddAbilityBJ( 'A06F', GetTriggerUnit() )
            call UnitRemoveAbilityBJ( 'A06G', GetTriggerUnit() )
            call UnitAddAbilityBJ( 'Avul', GetTriggerUnit() )
        endif
        //切换形态2:
        if (GetSpellAbilityId() == 'A06F') then
            call UnitRemoveType( GetTriggerUnit(), UNIT_TYPE_PEON )
            call UnitRemoveAbilityBJ( 'Avul', GetTriggerUnit() )
            call UnitAddAbilityBJ( 'A06G', GetTriggerUnit() )
            call UnitRemoveAbilityBJ( 'A06F', GetTriggerUnit() )
        endif
    endfunction
//---------------------------------------------------------------------------------------------------
    /*
        宠物死亡事件
    */
    private function TPetDeathCon takes nothing returns boolean
        return (IsUnitIllusionBJ(GetDyingUnit()) == false and ((IsUnitInGroup(GetDyingUnit(),GPet[1])) or (IsUnitInGroup(GetDyingUnit(),GPet[2])) or (IsUnitInGroup(GetDyingUnit(),GPet[3])) or (IsUnitInGroup(GetDyingUnit(),GPet[4])) or (IsUnitInGroup(GetDyingUnit(),GPet[5])) or (IsUnitInGroup(GetDyingUnit(),GPet[6]))))
    endfunction
    private function TPetDeathAct takes nothing returns nothing
        local integer index = -1
        local integer i = 1
        local integer ii = 1
        loop
            exitwhen ii > 6
            if (IsUnitInGroup(GetDyingUnit(),GPet[ii]) == true) then
                set index = ii
            endif
            set ii = ii +1
        endloop
        if (index == -1) then
            return
        endif
        call SetPlayerStateBJ( ConvertedPlayer(index), PLAYER_STATE_RESOURCE_FOOD_USED, ( GetPlayerState(ConvertedPlayer(index), PLAYER_STATE_RESOURCE_FOOD_USED) - 1 ) )
        //物品给仓库
        loop
            exitwhen i > 6
            if (IsUnitHasSlot(UDepot[index])) then
                call UnitAddItemSwapped( UnitItemInSlotBJ(GetDyingUnit(), i), UDepot[index] )
            else
                call SetItemPosition(UnitItemInSlotBJ(GetDyingUnit(), i),GetUnitX(UDepot[index]),GetUnitY(UDepot[index]))
            endif
            set i = i +1
        endloop
        call PingMinimapForForce(YDWEGetForceOfPlayerNull(ConvertedPlayer(index)), GetUnitX(UDepot[index]),GetUnitY(UDepot[index]), 10.00)
        call DisplayTextToPlayer( ConvertedPlayer(index), 0, 0, ( "|cFFFF66CC【消息】|r你的宠物“" + ( GetUnitName(GetDyingUnit()) + "”已阵亡，物品存放于你的仓库。" ) ) )
        call FlushChildHashtable(YDHT,GetHandleId(GetDyingUnit()))
        call GroupRemoveUnit(GPet[index],GetDyingUnit())
        call RemoveUnit( GetDyingUnit() )
    endfunction
//---------------------------------------------------------------------------------------------------
    /*
        宠物物品得到丢弃事件
    */
    function TPetItemCon takes nothing returns boolean
        return ((not(IsUnitIllusionBJ(GetTriggerUnit()))) and (IsUnitInGroup(GetTriggerUnit(),GPet[GetConvertedPlayerId(GetOwningPlayer(GetTriggerUnit()))])))
    endfunction
    //得到物品
    function TPetItemPickAct takes nothing returns nothing
        if ((GetItemTypeId(GetManipulatedItem()) == 'sbch') and (GetUnitAbilityLevelSwapped('A06R', GetTriggerUnit()) != 1)) then
            call UnitAddAbilityBJ( 'A06R', GetTriggerUnit() )
        endif
        if ((GetItemTypeId(GetManipulatedItem()) == 'gcel') and (GetUnitAbilityLevelSwapped('A0B9', GetTriggerUnit()) != 1)) then
            call UnitAddAbilityBJ( 'A0B9', GetTriggerUnit() )
        endif
        if ((GetItemTypeId(GetManipulatedItem()) == 'crys') and (GetUnitAbilityLevelSwapped('A0CG', GetTriggerUnit()) != 1)) then
            call UnitAddAbilityBJ( 'A0CG', GetTriggerUnit() )
        endif
    endfunction
    //丢弃物品
    function TPetItemDropAct takes nothing returns nothing
        if ((GetItemTypeId(GetManipulatedItem()) == 'sbch') and (GetUnitAbilityLevelSwapped('A06R', GetTriggerUnit()) == 1)) then
            call UnitRemoveAbility( GetTriggerUnit(), 'A06R' )
        else
        endif
        if ((GetItemTypeId(GetManipulatedItem()) == 'gcel') and (GetUnitAbilityLevelSwapped('A0B9', GetTriggerUnit()) == 1)) then
            call UnitRemoveAbility( GetTriggerUnit(), 'A0B9' )
        else
        endif
        if ((GetItemTypeId(GetManipulatedItem()) == 'crys') and (GetUnitAbilityLevelSwapped('A0CG', GetTriggerUnit()) == 1)) then
            call UnitRemoveAbility( GetTriggerUnit(), 'A0CG' )
        else
        endif
    endfunction
//---------------------------------------------------------------------------------------------------
    private function InitPet takes nothing returns nothing
        local trigger t = CreateTrigger()
        local integer i = 1
        loop
            exitwhen i > 6
            set GPet[i] = CreateGroup()
            set i = i +1
        endloop
        //抓宠物与宠物切换形态
        call TriggerRegisterAnyUnitEventBJ( t, EVENT_PLAYER_UNIT_SPELL_EFFECT )
        call TriggerAddAction(t, function TCatchPetAct)
        call TriggerAddAction(t, function TPetChangeForm)
        //没切换攻击形态时
        set t = CreateTrigger()
        call TriggerRegisterAnyUnitEventBJ( t, EVENT_PLAYER_UNIT_ATTACKED )
        call TriggerAddCondition(t, Condition(function TAttackForbitCon))
        call TriggerAddAction(t, function TAttackForbitAct)
        //宠物死亡事件
        set t = CreateTrigger()
        call TriggerRegisterAnyUnitEventBJ( t, EVENT_PLAYER_UNIT_DEATH )
        call TriggerAddCondition(t, Condition(function TPetDeathCon))
        call TriggerAddAction(t, function TPetDeathAct)
        //宠物获得物品事件
        set t = CreateTrigger()
        call TriggerRegisterAnyUnitEventBJ( t, EVENT_PLAYER_UNIT_PICKUP_ITEM )
        call TriggerAddCondition(t, Condition(function TPetItemCon))
        call TriggerAddAction(t, function TPetItemPickAct)
        //宠物丢弃物品事件
        set t = CreateTrigger()
        call TriggerRegisterAnyUnitEventBJ( t, EVENT_PLAYER_UNIT_DROP_ITEM )
        call TriggerAddCondition(t, Condition(function TPetItemCon))
        call TriggerAddAction(t, function TPetItemDropAct)
        set t = null
    endfunction
endlibrary
// 合成装备
library_once Hundun initializer InitHundunInner requires LHBase,SpellBase,Diffculty,Boss
	globals
		unit UHundun = null
		MultiLife MLHundun = 0
		group GHundunDian = null
		group GHundunAttack = null
		timer THundunDian = null
		trigger THundunSpellDamage = null
		integer hundun1_level = 1
		integer hundun2_level = 1
		integer hundun_playerID = 0
		//混沌2
		Attract AHundun2 = 0
		SuperShield TShieldHundun = 0
	endglobals
//---------------------------------------------------------------------------------------------------
	/*
	    排泄混沌石技能
	*/
	private function ClearGroup takes nothing returns nothing
		call RemoveUnit(GetEnumUnit())
	endfunction
	function DestroyHundun1 takes nothing returns nothing
		if (MLHundun != 0) then
			call MLHundun.destroy()
		endif
		call PauseTimer(THundunDian)
		call DestroyTimer(THundunDian)
		call ForGroup(GHundunDian,function ClearGroup)
		call ForGroup(GHundunAttack,function ClearGroup)
		call DestroyGroup(GHundunDian)
		set MLHundun = 0
		set GHundunDian = null
		set THundunDian = null
		call DestroyGroup(GHundunAttack)
		set GHundunAttack = null
		call DisableTrigger(THundunSpellDamage)
	endfunction
	function DestroyHundun2 takes nothing returns nothing
		call DestroyHundun1()
		call AHundun2.destroy()
		call TShieldHundun.destroy()
		set AHundun2 = 0
		set TShieldHundun = 0
	endfunction
//---------------------------------------------------------------------------------------------------
    /*
        离开混沌区域
    */
    function HundunMonsterFilter takes nothing returns boolean
        return (((IsUnitAliveBJ(GetFilterUnit()) == true) and (GetOwningPlayer(GetFilterUnit()) == Player(10))))
    endfunction
    function HundunPlayerFilter takes nothing returns boolean
        return ((IsUnitType(GetFilterUnit(), UNIT_TYPE_HERO) == true) and (GetPlayerController(GetOwningPlayer(GetFilterUnit())) == MAP_CONTROL_USER) and (IsUnitAliveBJ(GetFilterUnit()) or (GetFilterUnit() == udg_H[GetConvertedPlayerId(GetOwningPlayer(GetFilterUnit()))] and not(IsWanjie()) )))
    endfunction
    function ClearHundunRegion takes rect r returns nothing
        local unit l_unit = null
        local group group2 = YDWEGetUnitsInRectMatchingNull(r, Condition(function HundunMonsterFilter))
        set group2 = YDWEGetUnitsInRectMatchingNull(r, Condition(function HundunMonsterFilter))
        loop
            set l_unit = FirstOfGroup(group2)
            exitwhen l_unit == null
            call GroupRemoveUnit(group2, l_unit)
            call FlushChildHashtable(YDHT,GetHandleId(l_unit))
            call RemoveUnit( l_unit )
        endloop
        call DestroyGroup( group2 )
        set group2 = null
        set l_unit = null
    endfunction
    function TLeaveHundunRegionCon takes nothing returns boolean
        return ((GetPlayerController(GetOwningPlayer(GetLeavingUnit())) == MAP_CONTROL_USER))
    endfunction
    function TLeaveHundunRegionAct takes nothing returns nothing
        local group group1 = YDWEGetUnitsInRectMatchingNull(gg_rct_Hundun, Condition(function HundunPlayerFilter))
        if ((CountUnitsInGroup(group1) == 0)) then
            call ClearHundunRegion(gg_rct_Hundun)
            call DestroyHundun1()
        endif
        call DestroyGroup( group1 )
        set group1 = null
    endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    施放电技能
	*/
	function SpellDian takes unit temp returns nothing
		local integer i = 1
		local integer end = IMaxBJ(1,MLHundun.getTimes()) * 18
		local real random = GetRandomReal(0,360.)
		local unit u = null
		loop
			exitwhen i > (end * 3 / 4)
			set u = CreateUnit(Player(10),'h01O',GetUnitX(temp) + 10 * CosBJ(ModuloReal( i * (360/end) + random,360)),GetUnitY(temp)+ 10 * SinBJ(ModuloReal( i * (360/end) + random,360)),ModuloReal( i * (360/end) + random,360))
        	call YDWEAroundSystem( u, temp, 0.00, 20., 0, 5, 0.05 )
        	call UnitApplyTimedLife( u, 'BHwe', 5 )
			set i = i +1
		endloop
		set u = null
	endfunction
	private function flashDian takes nothing returns nothing
		call SpellDian(GroupPickRandomUnit(GHundunDian))
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    混沌的传送
	*/
	private function HundunTransimit takes nothing returns nothing
		local timer t = GetExpiredTimer()
		local integer id = GetHandleId(t)
		local unit u = LoadUnitHandle(spellTable,id,1)
		if (IsUnitAliveBJ(u)) then
			call TLeaveHundunRegionAct()
		else
			call PauseTimer(t)
			call FlushChildHashtable(spellTable,id)
			call DestroyTimer(t)
		endif
		set u = null
		set t = null
	endfunction
	function StartJudgeTransmitHundun takes unit u returns nothing
		local timer t = CreateTimer()
		call SaveUnitHandle(spellTable,GetHandleId(t),1,u)
		call TimerStart(t,2,true,function HundunTransimit)
		set t = null
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    检测生命设置混沌2的斥力速度与无敌
	*/
	private function Hundun2SetLifeLess takes unit u returns nothing
		call AHundun2.setSpeed(-16)
		call TShieldHundun.destroy()
        set TShieldHundun = SuperShield.create(UHundun,I3(IsWanjie(),3,1))
        call TShieldHundun.SetDeathContinue()
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    初始化混沌石1技能
	*/
	function InitHundun1 takes unit u returns nothing
		local integer i = 1
		local unit temp = null
		set UHundun = u
		call BossAddOnlyAttack(UHundun)
		set MLHundun = MultiLife.create(u,2)
		//召唤电子盟
		set GHundunDian = CreateGroup()
		set GHundunAttack = CreateGroup()
    	call SetPlayerTechResearchedSwap( GetHundunTech(), hundun1_level , Player(10))
		loop
			exitwhen i > (GetDiffculty()/2 + 1)
			set temp = CreateUnit(Player(10),'h01Q',GetRandomReal(GetRectMinX(gg_rct_Hundun),GetRectMaxX(gg_rct_Hundun)),GetRandomReal(GetRectMinY(gg_rct_Hundun),GetRectMaxY(gg_rct_Hundun)),GetRandomReal(0,360))
			call GroupAddUnit(GHundunDian,temp)
			call IssuePointOrder(temp,"patrol",GetRandomReal(GetRectMinX(gg_rct_Hundun),GetRectMaxX(gg_rct_Hundun)),GetRandomReal(GetRectMinY(gg_rct_Hundun),GetRectMaxY(gg_rct_Hundun)))
			set i = i +1
		endloop
		set THundunDian = CreateTimer()
		call TimerStart(THundunDian,(10/(GetDiffculty()/2 + 1)),true,function flashDian)
		//召唤攻击盟
		set i = 1
		loop
			exitwhen i > (GetDiffculty()/2 + 1)
			call GroupAddUnit(GHundunAttack,CreateUnit(Player(10),'h01R',GetRandomReal(GetRectMinX(gg_rct_Hundun),GetRectMaxX(gg_rct_Hundun)),GetRandomReal(GetRectMinY(gg_rct_Hundun),GetRectMaxY(gg_rct_Hundun)),GetRandomReal(0,360)))
			set i = i + 1
		endloop
		call EnableTrigger(THundunSpellDamage)
		set hundun_playerID = GetConvertedPlayerId(GetOwningPlayer(GetBuyingUnit()))
		if (IsWanjie()) then
			call StartJudgeTransmitHundun(u)
		endif
		set temp = null
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    初始化混沌石2技能
	*/
	function InitHundun2 takes unit u returns nothing
		call InitHundun1(u)
    	call SetPlayerTechResearchedSwap( GetHundun2Tech(), hundun2_level , Player(10))
        set AHundun2 = Attract.create(u,3000,0.05,-8)
        call AHundun2.SetDeathContinue()
        call AHundun2.start()
        call MLHundun.setAL(AfterLessLife.Hundun2SetLifeLess)
        set TShieldHundun = SuperShield.create(u,I3(IsWanjie(),3,1))
        call TShieldHundun.SetDeathContinue()
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    混沌死亡
	*/
	function HundunDeath takes nothing returns nothing
		set hundun1_level = hundun1_level + I3(IsTianyan,3,1)
		call DestroyHundun1()
		 if ((hundun_playerID != 0)) then
            call UnitAddItemByIdSwapped('I062', UDepot[hundun_playerID])
            call SetUnitPosition(UDepot[hundun_playerID],GetUnitX(GetDyingUnit()),GetUnitY(GetDyingUnit()))
        else
            call CreateItem('I062',GetUnitX(GetDyingUnit()),GetUnitY(GetDyingUnit()))
        endif
        set hundun_playerID = 0
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    混沌2死亡
	*/
	function Hundun2Death takes nothing returns nothing
		set hundun2_level = hundun2_level + I3(IsTianyan,3,1)
		call DestroyHundun2()
		 if ((hundun_playerID != 0)) then
            call UnitAddItemByIdSwapped('I07R', UDepot[hundun_playerID])
            call SetUnitPosition(UDepot[hundun_playerID],GetUnitX(GetDyingUnit()),GetUnitY(GetDyingUnit()))
        else
            call CreateItem('I07R',GetUnitX(GetDyingUnit()),GetUnitY(GetDyingUnit()))
        endif
        set hundun_playerID = 0
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    施法扣血技能
	*/
	private function THundunSpellDamageCon takes nothing returns boolean
		return udg_H[GetConvertedPlayerId(GetOwningPlayer(GetTriggerUnit()))] == GetTriggerUnit()
	endfunction
	function THundunSpellDamageAct takes nothing returns nothing
		if (YDWEDistanceBetweenUnits(UHundun, GetTriggerUnit()) < 1800) then
			call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Other\\Stampede\\StampedeMissileDeath.mdl", GetUnitX(GetTriggerUnit()),GetUnitY(GetTriggerUnit()) ))
			call UnitDamageTarget( UHundun, GetTriggerUnit(), GetUnitState(GetTriggerUnit(),UNIT_STATE_MAX_LIFE) * 0.1, false, true, ATTACK_TYPE_CHAOS, DAMAGE_TYPE_SLOW_POISON, WEAPON_TYPE_WHOKNOWS )
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    对话框内升级物品,使用次数与materials1一致
	*/
	function DialogCombineClick takes nothing returns nothing
	    local dialog d = GetClickedDialogBJ()
	    local unit u = LoadUnitHandle(itemTable,GetHandleId(d),3)
        call RemoveItem( LoadItemHandle(itemTable,GetHandleId(d),7) )
        call RemoveItem( LoadItemHandle(itemTable,GetHandleId(d),8) )
        if (GetClickedButtonBJ() == LoadButtonHandle(itemTable,GetHandleId(d),1)) then
			call UnitAddItemByIdSwapped( LoadInteger(itemTable,GetHandleId(d),4), u)
	        call SetItemCharges(GetLastCreatedItem(),LoadInteger(itemTable,GetHandleId(d),6))
        endif
        if (GetClickedButtonBJ() == LoadButtonHandle(itemTable,GetHandleId(d),2)) then
			call UnitAddItemByIdSwapped( LoadInteger(itemTable,GetHandleId(d),5), u)
	        call SetItemCharges(GetLastCreatedItem(),LoadInteger(itemTable,GetHandleId(d),6))
        endif
        call FlushChildHashtable(itemTable,GetHandleId(d))
    	call DialogDisplay( GetOwningPlayer(u), d, false )
        call DialogClear(d)
        call DialogDestroy(d)
        call PlaySoundBJ(gg_snd_hecheng_shenqi)
        call BJDebugMsg("|cFFFF66CC【消息】|r"+GetItemName(GetLastCreatedItem())+"降临于世!!!")
        call BJDebugMsg("|cFFFF66CC【消息】|r"+GetItemName(GetLastCreatedItem())+"降临于世!!!")
        call BJDebugMsg("|cFFFF66CC【消息】|r"+GetItemName(GetLastCreatedItem())+"降临于世!!!")
        call BJDebugMsg("|cFFFF66CC【消息】|r"+GetItemName(GetLastCreatedItem())+"降临于世!!!")
        set d = null
        set u = null
        call DestroyTrigger(GetTriggeringTrigger())
	endfunction
	function DialogCombine takes unit buyer,integer materials1,integer materials2,integer targetItem1,integer targetItem2,string targetName1,string targetName2,integer lumber returns nothing
		local trigger t
	    local dialog d
	    local integer i
		if ((GetItemTypeId(YDWEGetItemOfTypeFromUnitBJNull(GetBuyingUnit(), materials1)) == materials1) and (GetItemTypeId(YDWEGetItemOfTypeFromUnitBJNull(GetBuyingUnit(), materials2)) == materials2) and (IsItemPawnable(YDWEGetItemOfTypeFromUnitBJNull(GetBuyingUnit(), materials1))) and (IsItemPawnable(YDWEGetItemOfTypeFromUnitBJNull(GetBuyingUnit(), materials2)))) then
	    	set i = GetItemCharges(YDWEGetItemOfTypeFromUnitBJNull(GetBuyingUnit(), materials1))
			set t = CreateTrigger()
			set d = DialogCreate()
			call DialogSetMessage( d, "你想合成为:" )
			call SaveButtonHandle(itemTable,GetHandleId(d),1,DialogAddButton( d, targetName1,'1'))
			call SaveButtonHandle(itemTable,GetHandleId(d),2,DialogAddButton( d, targetName2,'2'))
			call SaveUnitHandle(itemTable,GetHandleId(d),3,buyer)
			call SaveInteger(itemTable,GetHandleId(d),4,targetItem1)
			call SaveInteger(itemTable,GetHandleId(d),5,targetItem2)
			call SaveInteger(itemTable,GetHandleId(d),6,i)
			call SaveItemHandle(itemTable,GetHandleId(d),7,YDWEGetItemOfTypeFromUnitBJNull(GetBuyingUnit(), materials1))
			call SaveItemHandle(itemTable,GetHandleId(d),8,YDWEGetItemOfTypeFromUnitBJNull(GetBuyingUnit(), materials2))
			call DialogDisplay( GetOwningPlayer(buyer), d, true )
			call TriggerRegisterDialogEvent( t, d )
			call TriggerAddAction(t, function DialogCombineClick)
			set d = null
			set t = null
	    else
	        call DisplayTextToPlayer( GetOwningPlayer(GetBuyingUnit()), 0, 0, "|cFFFF66CC【消息】|r你的材料不足." )
	        call AdjustPlayerStateBJ( lumber, GetOwningPlayer(GetBuyingUnit()), PLAYER_STATE_RESOURCE_LUMBER )
	        return
	    endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    直接合成物品
	*/
	function CombineI takes unit buyer,integer materials1,integer materials2,integer targetItem,integer lumber,boolean hints returns nothing
	    local integer i
		if ((GetItemTypeId(YDWEGetItemOfTypeFromUnitBJNull(GetBuyingUnit(), materials1)) == materials1) and (GetItemTypeId(YDWEGetItemOfTypeFromUnitBJNull(GetBuyingUnit(), materials2)) == materials2) and (IsItemPawnable(YDWEGetItemOfTypeFromUnitBJNull(GetBuyingUnit(), materials1))) and (IsItemPawnable(YDWEGetItemOfTypeFromUnitBJNull(GetBuyingUnit(), materials2)))) then
	    	set i = GetItemCharges(YDWEGetItemOfTypeFromUnitBJNull(GetBuyingUnit(), materials1))
	        call RemoveItem( YDWEGetItemOfTypeFromUnitBJNull(GetBuyingUnit(), materials1) )
	        call RemoveItem( YDWEGetItemOfTypeFromUnitBJNull(GetBuyingUnit(), materials2) )
			call UnitAddItemByIdSwapped( targetItem, GetBuyingUnit())
    		call SetItemCharges(GetLastCreatedItem(),i)
        	call PlaySoundBJ(gg_snd_hecheng_shenqi)
        	call BJDebugMsg("|cFFFF66CC【消息】|r"+GetItemName(GetLastCreatedItem())+"降临于世!!!")
        	call BJDebugMsg("|cFFFF66CC【消息】|r"+GetItemName(GetLastCreatedItem())+"降临于世!!!")
        	call BJDebugMsg("|cFFFF66CC【消息】|r"+GetItemName(GetLastCreatedItem())+"降临于世!!!")
        	call BJDebugMsg("|cFFFF66CC【消息】|r"+GetItemName(GetLastCreatedItem())+"降临于世!!!")
	    else
	    	if (hints) then
	        	call DisplayTextToPlayer( GetOwningPlayer(GetBuyingUnit()), 0, 0, "|cFFFF66CC【消息】|r你的材料不足." )
	    	endif
	        call AdjustPlayerStateBJ( lumber, GetOwningPlayer(GetBuyingUnit()), PLAYER_STATE_RESOURCE_LUMBER )
	        return
	    endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    倚天的加木头
	*/
	function Yitian takes nothing returns nothing
		local integer i = 1
		loop
			exitwhen i > 6
			if ((GetPlayerSlotState(ConvertedPlayer(i)) == PLAYER_SLOT_STATE_PLAYING) and (GetPlayerController(ConvertedPlayer(i)) == MAP_CONTROL_USER) and udg_H[i] != null) then
				if (YDWEUnitHasItemOfTypeBJNull(udg_H[i],'I04L') or YDWEUnitHasItemOfTypeBJNull(udg_H[i],'I04M')) then
				    call AdjustPlayerStateBJ( I3(IsWanjie(),600/udg_RENSHU,600)*CModeH(1,2), ConvertedPlayer(i), PLAYER_STATE_RESOURCE_LUMBER )
				    call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Other\\Transmute\\PileofGold.mdl", GetUnitX(udg_H[i]), GetUnitY(udg_H[i]) ))
				elseif (YDWEUnitHasItemOfTypeBJNull(udg_H[i],'rat6')) then
				    call AdjustPlayerStateBJ( I3(IsWanjie(),500/udg_RENSHU,500)*CModeH(1,2), ConvertedPlayer(i), PLAYER_STATE_RESOURCE_LUMBER )
				    call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Other\\Transmute\\PileofGold.mdl", GetUnitX(udg_H[i]), GetUnitY(udg_H[i]) ))
				endif
			endif
			set i = i +1
		endloop
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    合成皎月
	*/
	function CombineJiaoyue takes unit u returns nothing
		if ((GetItemTypeId(YDWEGetItemOfTypeFromUnitBJNull(u, 'rat6')) == 'rat6') and (GetItemTypeId(YDWEGetItemOfTypeFromUnitBJNull(u, 'ratc')) == 'ratc') and (GetItemTypeId(YDWEGetItemOfTypeFromUnitBJNull(u, 'mcou')) == 'mcou') and (IsItemPawnable(YDWEGetItemOfTypeFromUnitBJNull(u, 'rat6')) ) and (IsItemPawnable(YDWEGetItemOfTypeFromUnitBJNull(u, 'mcou')) ) and (IsItemPawnable(YDWEGetItemOfTypeFromUnitBJNull(u, 'ratc')) )) then
            call YDWEPolledWaitNull(0.01)
            call RemoveItem( YDWEGetItemOfTypeFromUnitBJNull(u, 'ratc') )
            call RemoveItem( YDWEGetItemOfTypeFromUnitBJNull(u, 'mcou') )
            call RemoveItem( YDWEGetItemOfTypeFromUnitBJNull(u, 'rat6') )
            call UnitAddItemById(u, 'I04L')
			call BJDebugMsg("|cFFFF66CC【消息】|r尘封的|cffff00ff【混沌】圣剑-皎月|r降世!!!!!!!")
			call BJDebugMsg("|cFFFF66CC【消息】|r尘封的|cffff00ff【混沌】圣剑-皎月|r降世!!!!!!!")
			call BJDebugMsg("|cFFFF66CC【消息】|r尘封的|cffff00ff【混沌】圣剑-皎月|r降世!!!!!!!")
			return
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    商店合成混沌夜之哀伤
	*/
	function CombineHundunyeai takes nothing returns nothing
		local integer i
		if ((GetItemTypeId(GetSoldItem()) == 'I04Q')) then
		    if ((GetItemTypeId(YDWEGetItemOfTypeFromUnitBJNull(GetBuyingUnit(), 'I04L')) == 'I04L') and (GetItemTypeId(YDWEGetItemOfTypeFromUnitBJNull(GetBuyingUnit(), 'stel')) == 'stel') and (IsItemPawnable(YDWEGetItemOfTypeFromUnitBJNull(GetBuyingUnit(), 'I04L')) == true)) then
		    	set i = GetItemCharges(YDWEGetItemOfTypeFromUnitBJNull(GetBuyingUnit(), 'stel'))
		        call RemoveItem( YDWEGetItemOfTypeFromUnitBJNull(GetBuyingUnit(), 'I04L') )
		        call RemoveItem( YDWEGetItemOfTypeFromUnitBJNull(GetBuyingUnit(), 'stel') )
		        call UnitAddItemByIdSwapped( 'I04M', GetBuyingUnit() )
		        call SetItemCharges(GetLastCreatedItem(),i)
				call BJDebugMsg("|cFFFF66CC【消息】|r尘封的|cFF66CC33【混沌】夜之哀伤|r降世!!!!!!!")
				call BJDebugMsg("|cFFFF66CC【消息】|r尘封的|cFF66CC33【混沌】夜之哀伤|r降世!!!!!!!")
				call BJDebugMsg("|cFFFF66CC【消息】|r尘封的|cFF66CC33【混沌】夜之哀伤|r降世!!!!!!!")
		        return
		    else
		        call DisplayTextToPlayer( GetOwningPlayer(GetBuyingUnit()), 0, 0, "|cFFFF66CC【消息】|r你的材料不足." )
		        call AdjustPlayerStateBJ( 1000, GetOwningPlayer(GetBuyingUnit()), PLAYER_STATE_RESOURCE_LUMBER )
		        return
		    endif
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    合成装备
	*/
	function CombineHundunAll takes nothing returns nothing
		if ((GetItemTypeId(GetSoldItem()) == 'I064')) then
			call DialogCombine(GetBuyingUnit(),'tlum','I062','ICS1','I04W',"|cffffff00【混沌】诛神噬魔-贯|r(强大的破防能力与直刺生命的六元幽冥)","|cffffff00【混沌】诛神噬魔-袭|r(觉醒于融合六界之力的六元幽冥)",1000)
		endif
		if ((GetItemTypeId(GetSoldItem()) == 'I063')) then
			call DialogCombine(GetBuyingUnit(),'ssil','I062','I04Y','I05T',"|cffff9900【混沌】幽冥项链-亡|r(用生命换取贯穿寰宇的力量)","|cffff9900【混沌】幽冥项链-凌|r(源源不断的圣界之力)",1000)
		endif
		if ((GetItemTypeId(GetSoldItem()) == 'I065')) then
			call DialogCombine(GetBuyingUnit(),'lhst','I062','I05W','I05V',"|cffff00ff【混沌】魑魅魍魉-忌|r(更为玄幻的灵魂吸收之力)","|cffff00ff【混沌】魑魅魍魉-禁|r(空间跳跃，厉鬼相随)",1000)
		endif
		if ((GetItemTypeId(GetSoldItem()) == 'I066')) then
			call DialogCombine(GetBuyingUnit(),'I05F','I062','ICY1','I05X',"|cff99cc00【混沌】九渊冥鸢|r(无缺之体,坚不可摧)","|cff99cc00【混沌】绯绫三生燕|r(燎原之火,焚照千里)",1000)
		endif
		if ((GetItemTypeId(GetSoldItem()) == 'I067')) then
			call DialogCombine(GetBuyingUnit(),'IB09','I062','IB0A','I04X',"|cffff00ff【混沌】十翼|r|cffff0000天龙|r(拥有较强群体杀伤能力)","|cffff00ff【混沌】华缈|r|cffff0000弥鹤|r(拥有强大的单体杀伤能力)",1000)
		endif
		if ((GetItemTypeId(GetSoldItem()) == 'I068')) then
			call CombineI(GetBuyingUnit(),'rst1','I062','ICX1',1000,true)
		endif
		if ((GetItemTypeId(GetSoldItem()) == 'I069')) then
			call CombineI(GetBuyingUnit(),'tbsm','I062','I05Y',0,false)
			call CombineI(GetBuyingUnit(),'tfar','I062','I05Z',0,false)
			call CombineI(GetBuyingUnit(),'tbak','I062','I060',0,false)
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    进入混沌之区
	*/
	function EnterHundun takes nothing returns nothing
		local real x
		local real y
		if ((GetItemTypeId(GetSoldItem()) == 'I04T')) then
			set x = GetRectCenterX(gg_rct_Hundun)
			set y = GetRectCenterY(gg_rct_Hundun)
	        call SetUnitX(GetBuyingUnit(),x)
	        call SetUnitY(GetBuyingUnit(),y)
	        call PanCameraToTimedForPlayer(GetOwningPlayer(GetBuyingUnit()),x,y,0.2)
	        call DestroyEffect( AddSpecialEffect("Abilities\\Spells\\Human\\MassTeleport\\MassTeleportCaster.mdl", x, y))
	        call DisplayTextToPlayer( GetOwningPlayer(GetBuyingUnit()), 0, 0, "|cFFFF66CC【消息】|r回去输入“HG”。" )
	    endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    初始化混沌区的技能
	*/
	function InitHundunInner takes nothing returns nothing
        local trigger t = CreateTrigger()
        call YDWETriggerRegisterLeaveRectSimpleNull( t, gg_rct_Hundun )
        call TriggerAddCondition(t, Condition(function TLeaveHundunRegionCon))
        call TriggerAddAction(t, function TLeaveHundunRegionAct)
        set t = null
		set THundunSpellDamage = CreateTrigger()
		call TriggerRegisterAnyUnitEventBJ(THundunSpellDamage,EVENT_PLAYER_UNIT_SPELL_EFFECT)
		call TriggerAddCondition(THundunSpellDamage, Condition(function THundunSpellDamageCon))
		call TriggerAddAction(THundunSpellDamage, function THundunSpellDamageAct)
		call DisableTrigger(THundunSpellDamage)
	endfunction
endlibrary
///#include  "edit/Beast.j"
/*
    合成物品
*/
library_once Combine initializer InitCombine requires LHBase,Beast,Hundun
	private function TCombineAllCon takes nothing returns boolean
		return (IsUnitIllusionBJ(GetManipulatingUnit()) != true)
	endfunction
	private function TCombineAllAct takes nothing returns nothing
		call CombineBeast(GetManipulatingUnit())
		call CombineJiaoyue(GetManipulatingUnit())
	endfunction
	private function TCombineBuyAllCon takes nothing returns boolean
		return BuyerFilter(GetBuyingUnit())
	endfunction
	private function TCombineBuyAllAct takes nothing returns nothing
		call CombineHundunyeai()
		call CombineHundunAll()
	endfunction
//---------------------------------------------------------------------------------------------------
	private function InitCombine takes nothing returns nothing
	    local trigger t = CreateTrigger()
	    call TriggerRegisterAnyUnitEventBJ( t, EVENT_PLAYER_UNIT_PICKUP_ITEM )
	    call TriggerAddCondition(t, Condition(function TCombineAllCon))
	    call TriggerAddAction(t, function TCombineAllAct)
	    set t = CreateTrigger()
	    call TriggerRegisterAnyUnitEventBJ( t, EVENT_PLAYER_UNIT_SELL_ITEM )
	    call TriggerAddCondition(t, Condition(function TCombineBuyAllCon))
	    call TriggerAddAction(t, function TCombineBuyAllAct)
	    set t = null
	endfunction
endlibrary
// 宝石升级
///#include  "edit/NetVersion.j"
/*
    宝石升级装备
*/
library_once Diamond initializer InitDiamond requires LHBase,Diffculty,Version
    globals
        constant string DIAMOND_CANT_UPDATE = "|cFFFF66CC【消息】|r该宝石不能升级该物品。"
        /*
            至少爆一颗的变量
        */
        integer IAtleast1 = 0
        integer IAtleast2 = 0
        integer IAtleast3 = 0
        /*
            裸上提示
        */
        private boolean array BLuoshang1
        private boolean array BLuoshang2
    endglobals
//---------------------------------------------------------------------------------------------------
    /*
        是否在宝石区内
    */
    function IsInDiamondRegion takes real x, real y returns boolean
        local location point = Location(x,y)
        local boolean b = RectContainsLoc(gg_rct_Diamond2,point) or RectContainsLoc(gg_rct_Diamond3,point) or RectContainsLoc(gg_rct________8,point)
        call RemoveLocation(point)
        return b
    endfunction
//---------------------------------------------------------------------------------------------------
    /*
        100%几率成功
    */
    private function Diamond100 takes integer itemID,integer newItemID returns boolean
        local integer charges = 0
        if (GetItemTypeId(GetSpellTargetItem()) == itemID) then
            call DisplayTextToForce( GetPlayersAll(), ( "|cFFFF66CC【消息】|r" + ( GetUnitName(udg_H[GetConvertedPlayerId(GetOwningPlayer(GetTriggerUnit()))]) + "以100%的成功率成功地升级了"+GetItemName(GetSpellTargetItem())+"！" ) ) )
            set charges = GetItemCharges(GetSpellTargetItem())
            call RemoveItem( GetSpellTargetItem() )
            call UnitAddItemByIdSwapped( newItemID, GetTriggerUnit() )
            call SetItemCharges(GetLastCreatedItem(),charges)
            call PlaySoundBJ( gg_snd_Chenggong )
            return true
        endif
        return false
    endfunction
//---------------------------------------------------------------------------------------------------
    /*
        特定几率成功，失败不降级
    */
    private function DiamondA takes integer itemID,integer newItemID,integer poss returns boolean
        //琉璃璞玉
        if (HasLiuli(GetTriggerUnit()) == true) then
            return Diamond100(itemID,newItemID)
        endif
        //非琉璃璞玉
        if (GetItemTypeId(GetSpellTargetItem()) == itemID) then
            if ((GetRandomInt(1, 100) <= poss)) then
                call DisplayTextToForce( GetPlayersAll(), ( "|cFFFF66CC【消息】|r" + ( GetUnitName(udg_H[GetConvertedPlayerId(GetOwningPlayer(GetTriggerUnit()))]) + "以"+I2S(poss)+"%的成功率成功地升级了"+GetItemName(GetSpellTargetItem())+"！" ) ) )
                call RemoveItem( GetSpellTargetItem() )
                call UnitAddItemByIdSwapped( newItemID, GetTriggerUnit() )
                call PlaySoundBJ( gg_snd_Chenggong )
            else
                call DisplayTextToForce( GetPlayersAll(), ( "|cFFFF66CC【消息】|r" + ( GetUnitName(udg_H[GetConvertedPlayerId(GetOwningPlayer(GetTriggerUnit()))]) + "以"+I2S(poss)+"%的成功率升级"+GetItemName(GetSpellTargetItem())+"失败！" ) ) )
                if (GetRandomInt(1,5) == 1) then
                    call DisplayTextToPlayer(GetOwningPlayer(GetTriggerUnit()), 0., 0., "|cFFFF66CC【小提示】|r装备到了+4以后推荐使用祝福/强化/诅咒石去升级.")
                else
                    if (GetRandomInt(1,4) == 1) then
                        call DisplayTextToPlayer(GetOwningPlayer(GetTriggerUnit()), 0., 0., "|cFFFF66CC【小提示】|r|cffff00ff琉璃璞玉|r可以将宝石成功率提升至100%,可以通过42转或者永久赞助(详情按F9)获取.")
                    endif
                endif
                call PlaySoundBJ( gg_snd_f_baoshi )
            endif
            return true
        endif
        return false
    endfunction
//---------------------------------------------------------------------------------------------------
    /*
        特定几率成功，失败降级
    */
    private function DiamondB takes integer itemID,integer newItemID,integer oldItemID,integer poss returns boolean
        //琉璃璞玉
        if (HasLiuli(GetTriggerUnit()) == true) then
            return Diamond100(itemID,newItemID)
        endif
        //非琉璃璞玉
        if (GetItemTypeId(GetSpellTargetItem()) == itemID) then
            if ((GetRandomInt(1, 100) <= poss)) then
                call DisplayTextToForce( GetPlayersAll(), ( "|cFFFF66CC【消息】|r" + ( GetUnitName(udg_H[GetConvertedPlayerId(GetOwningPlayer(GetTriggerUnit()))]) + "以"+I2S(poss)+"%的成功率成功地升级了"+GetItemName(GetSpellTargetItem())+"！" ) ) )
                call RemoveItem( GetSpellTargetItem() )
                call UnitAddItemByIdSwapped( newItemID, GetTriggerUnit() )
                call PlaySoundBJ( gg_snd_Chenggong )
            else
                call DisplayTextToForce( GetPlayersAll(), ( "|cFFFF66CC【消息】|r" + ( GetUnitName(udg_H[GetConvertedPlayerId(GetOwningPlayer(GetTriggerUnit()))]) + "以"+I2S(poss)+"%的成功率升级"+GetItemName(GetSpellTargetItem())+"失败,等级降低！" ) ) )
                if (GetRandomInt(1,5) == 1) then
                    call DisplayTextToPlayer(GetOwningPlayer(GetTriggerUnit()), 0., 0., "|cFFFF66CC【小提示】|r装备到了+4以后推荐使用祝福/强化/诅咒石去升级.")
                else
                    if (GetRandomInt(1,4) == 1) then
                        call DisplayTextToPlayer(GetOwningPlayer(GetTriggerUnit()), 0., 0., "|cFFFF66CC【小提示】|r|cffff00ff琉璃璞玉|r可以将宝石成功率提升至100%,可以通过42转或者永久赞助(详情按F9)获取.")
                    endif
                endif
                call RemoveItem( GetSpellTargetItem() )
                call UnitAddItemByIdSwapped( oldItemID, GetTriggerUnit() )
                call PlaySoundBJ( gg_snd_f_baoshi )
            endif
            return true
        endif
        return false
    endfunction
//---------------------------------------------------------------------------------------------------
    /*
        特定几率成功，失败降2级
    */
    private function DiamondC takes integer itemID,integer newItemID,integer oldItemID,integer poss returns boolean
        //琉璃璞玉
        if (HasLiuli(GetTriggerUnit()) == true) then
            return Diamond100(itemID,newItemID)
        endif
        //非琉璃璞玉
        if (GetItemTypeId(GetSpellTargetItem()) == itemID) then
            if ((GetRandomInt(1, 100) <= poss)) then
                call RemoveItem( GetSpellTargetItem() )
                call DisplayTextToForce( GetPlayersAll(), ( "|cFFFF66CC【消息】|r" + ( GetUnitName(udg_H[GetConvertedPlayerId(GetOwningPlayer(GetTriggerUnit()))]) + "以"+I2S(poss)+"%的成功率成功地升级了"+GetItemName(GetSpellTargetItem())+"！" ) ) )
                call UnitAddItemByIdSwapped( newItemID, GetTriggerUnit() )
                call PlaySoundBJ( gg_snd_Chenggong )
            else
                call RemoveItem( GetSpellTargetItem() )
                call DisplayTextToForce( GetPlayersAll(), ( "|cFFFF66CC【消息】|r" + ( GetUnitName(udg_H[GetConvertedPlayerId(GetOwningPlayer(GetTriggerUnit()))]) + "以"+I2S(poss)+"%的成功率升级"+GetItemName(GetSpellTargetItem())+"失败,等级降低2级！" ) ) )
                if (GetRandomInt(1,5) == 1) then
                    call DisplayTextToPlayer(GetOwningPlayer(GetTriggerUnit()), 0., 0., "|cFFFF66CC【小提示】|r装备到了+4以后推荐使用祝福/强化/诅咒石去升级.")
                else
                    if (GetRandomInt(1,4) == 1) then
                        call DisplayTextToPlayer(GetOwningPlayer(GetTriggerUnit()), 0., 0., "|cFFFF66CC【小提示】|r|cffff00ff琉璃璞玉|r可以将宝石成功率提升至100%,可以通过42转或者永久赞助(详情按F9)获取.")
                    endif
                endif
                call UnitAddItemByIdSwapped( oldItemID, GetTriggerUnit() )
                call PlaySoundBJ( gg_snd_f_baoshi )
            endif
            return true
        endif
        return false
    endfunction
//---------------------------------------------------------------------------------------------------
    /*
        +1宝石
    */
    private function AddOneDiamond takes nothing returns nothing
                //复制出来的不能升级
        if (IsItemPawnable(GetSpellTargetItem()) == false) then
            call UnitAddItemByIdSwapped( 'I02N', GetTriggerUnit() )
            call DisplayTextToPlayer( GetOwningPlayer(GetTriggerUnit()), 0, 0, DIAMOND_CANT_UPDATE )
            return
        endif
        if (Diamond100('I04Z','nflg') == true) then
            return
        endif
        if (Diamond100('I056','spre') == true) then
            return
        endif
        if (Diamond100('I057','fwss') == true) then
            return
        endif
        if (Diamond100('I050','uflg') == true) then
            return
        endif
        if (Diamond100('I055','tgxp') == true) then
            return
        endif
        if (Diamond100('I03Y','dust') == true) then
            return
        endif
        if (Diamond100('rej4','drph') == true) then
            return
        endif
        if (Diamond100('rej6','dtsb') == true) then
            return
        endif
        if (Diamond100('pgin','gobm') == true) then
            return
        endif
        call UnitAddItemByIdSwapped( 'I02N', GetTriggerUnit() )
        call DisplayTextToPlayer( GetOwningPlayer(GetTriggerUnit()), 0, 0, DIAMOND_CANT_UPDATE )
        return
    endfunction
//---------------------------------------------------------------------------------------------------
    /*
        +2宝石
    */
    private function AddSecondDiamond takes nothing returns nothing
        if (IsItemPawnable(GetSpellTargetItem()) == false) then
            call UnitAddItemByIdSwapped( 'I04S', GetTriggerUnit() )
            call DisplayTextToPlayer( GetOwningPlayer(GetTriggerUnit()), 0, 0, DIAMOND_CANT_UPDATE )
            return
        endif
        if (DiamondA('nflg','esaz',90) == true) then
            return
        endif
        if (DiamondA('spre','asbl',90) == true) then
            return
        endif
        if (DiamondA('fwss','ram4',90) == true) then
            return
        endif
        if (DiamondA('uflg','ram3',90) == true) then
            return
        endif
        if (DiamondA('tgxp','ram2',90) == true) then
            return
        endif
        if (DiamondA('dust','ram1',90) == true) then
            return
        endif
        if (DiamondA('drph','oven',90) == true) then
            return
        endif
        if (DiamondA('dtsb','tels',90) == true) then
            return
        endif
        if (DiamondA('gobm','gvsm',90) == true) then
            return
        endif
        call UnitAddItemByIdSwapped( 'I04S', GetTriggerUnit() )
        call DisplayTextToPlayer( GetOwningPlayer(GetTriggerUnit()), 0, 0, DIAMOND_CANT_UPDATE )
        return
    endfunction
//---------------------------------------------------------------------------------------------------
    /*
        +3宝石
    */
    private function AddThirdDiamond takes nothing returns nothing
        if (IsItemPawnable(GetSpellTargetItem()) == false) then
            call UnitAddItemByIdSwapped( 'azhr', GetTriggerUnit() )
            call DisplayTextToPlayer( GetOwningPlayer(GetTriggerUnit()), 0, 0, DIAMOND_CANT_UPDATE )
            return
        endif
        if (DiamondA('esaz','sksh',80) == true) then
            return
        endif
        if (DiamondA('asbl','ocor',80) == true) then
            return
        endif
        if (DiamondA('ram4','rat3',80) == true) then
            return
        endif
        if (DiamondA('ram3','stre',80) == true) then
            return
        endif
        if (DiamondA('ram2','lure',80) == true) then
            return
        endif
        if (DiamondA('ram1','rots',80) == true) then
            return
        endif
        if (DiamondA('oven','frhg',80) == true) then
            return
        endif
        if (DiamondA('tels','ofir',80) == true) then
            return
        endif
        if (DiamondA('gvsm','gldo',80) == true) then
            return
        endif
        call UnitAddItemByIdSwapped( 'azhr', GetTriggerUnit() )
        call DisplayTextToPlayer( GetOwningPlayer(GetTriggerUnit()), 0, 0, DIAMOND_CANT_UPDATE )
        return
    endfunction
//---------------------------------------------------------------------------------------------------
    /*
        +4宝石
    */
    private function AddFourthDiamond takes nothing returns nothing
        if (IsItemPawnable(GetSpellTargetItem()) == false) then
            call UnitAddItemByIdSwapped( 'gmfr', GetTriggerUnit() )
            call DisplayTextToPlayer( GetOwningPlayer(GetTriggerUnit()), 0, 0, DIAMOND_CANT_UPDATE )
            return
        endif
        if not(HasLiuli(GetTriggerUnit())) then
            if not(BLuoshang1[GetConvertedPlayerId(GetOwningPlayer(GetTriggerUnit()))]) then
                set BLuoshang1[GetConvertedPlayerId(GetOwningPlayer(GetTriggerUnit()))] = true
                call ShowGameHint(GetOwningPlayer(GetTriggerUnit()),"
                    小提示
                    3级以上的装备不建议使用未经强化的宝石祼升.
                    因为未经强化的宝石失败率较高,且失败会降级.
                    |cff6699ff祝福石能令装备失败不会降级.
                    强化石能有效提高升级成功率.
                    诅咒石更能提高成功率.|r
                    以上3种宝石能与普通的宝石融合在一起.
                    以上3种宝石均在宝石专区刷怪获取.
    ")
            endif
        endif
        if (DiamondB('sksh','oslo','esaz',70) == true) then
            return
        endif
        if (DiamondB('ocor','blba','asbl',70) == true) then
            return
        endif
        if (DiamondB('rat3','pams','ram4',70) == true) then
            return
        endif
        if (DiamondB('stre','shrs','ram3',70) == true) then
            return
        endif
        if (DiamondB('lure','thdm','ram2',70) == true) then
            return
        endif
        if (DiamondB('rots','tmmt','ram1',70) == true) then
            return
        endif
        if (DiamondB('frhg','mlst','oven',70) == true) then
            return
        endif
        if (DiamondB('ofir','soul','tels',70) == true) then
            return
        endif
        if (DiamondB('gldo','gsou','gvsm',70) == true) then
            return
        endif
        call UnitAddItemByIdSwapped( 'gmfr', GetTriggerUnit() )
        call DisplayTextToPlayer( GetOwningPlayer(GetTriggerUnit()), 0, 0, DIAMOND_CANT_UPDATE )
        return
    endfunction
//---------------------------------------------------------------------------------------------------
    /*
        +4强化宝石
    */
    private function AddFourthStrDiamond takes nothing returns nothing
        if (IsItemPawnable(GetSpellTargetItem()) == false) then
            call UnitAddItemByIdSwapped( 'wolg', GetTriggerUnit() )
            call DisplayTextToPlayer( GetOwningPlayer(GetTriggerUnit()), 0, 0, DIAMOND_CANT_UPDATE )
            return
        endif
        if (DiamondB('sksh','oslo','esaz',90) == true) then
            return
        endif
        if (DiamondB('ocor','blba','asbl',90) == true) then
            return
        endif
        if (DiamondB('rat3','pams','ram4',90) == true) then
            return
        endif
        if (DiamondB('stre','shrs','ram3',90) == true) then
            return
        endif
        if (DiamondB('lure','thdm','ram2',90) == true) then
            return
        endif
        if (DiamondB('rots','tmmt','ram1',90) == true) then
            return
        endif
        if (DiamondB('frhg','mlst','oven',90) == true) then
            return
        endif
        if (DiamondB('ofir','soul','tels',90) == true) then
            return
        endif
        if (DiamondB('gldo','gsou','gvsm',90) == true) then
            return
        endif
        call UnitAddItemByIdSwapped( 'wolg', GetTriggerUnit() )
        call DisplayTextToPlayer( GetOwningPlayer(GetTriggerUnit()), 0, 0, DIAMOND_CANT_UPDATE )
        return
    endfunction
//---------------------------------------------------------------------------------------------------
    /*
        +4祝福宝石
    */
    private function AddFourthBlessDiamond takes nothing returns nothing
        if (IsItemPawnable(GetSpellTargetItem()) == false) then
            call UnitAddItemByIdSwapped( 'skrt', GetTriggerUnit() )
            call DisplayTextToPlayer( GetOwningPlayer(GetTriggerUnit()), 0, 0, DIAMOND_CANT_UPDATE )
            return
        endif
        if (DiamondA('sksh','oslo', 60) == true) then
            return
        endif
        if (DiamondA('ocor','blba', 60) == true) then
            return
        endif
        if (DiamondA('rat3','pams', 60) == true) then
            return
        endif
        if (DiamondA('stre','shrs', 60) == true) then
            return
        endif
        if (DiamondA('lure','thdm', 60) == true) then
            return
        endif
        if (DiamondA('rots','tmmt', 60) == true) then
            return
        endif
        if (DiamondA('frhg','mlst', 60) == true) then
            return
        endif
        if (DiamondA('ofir','soul', 60) == true) then
            return
        endif
        if (DiamondA('gldo','gsou', 60) == true) then
            return
        endif
        call UnitAddItemByIdSwapped( 'skrt', GetTriggerUnit() )
        call DisplayTextToPlayer( GetOwningPlayer(GetTriggerUnit()), 0, 0, DIAMOND_CANT_UPDATE )
        return
    endfunction
//---------------------------------------------------------------------------------------------------
    /*
        +5宝石
    */
    private function AddFifthDiamond takes nothing returns nothing
        if (IsItemPawnable(GetSpellTargetItem()) == false) then
            call UnitAddItemByIdSwapped( 'jpnt', GetTriggerUnit() )
            call DisplayTextToPlayer( GetOwningPlayer(GetTriggerUnit()), 0, 0, DIAMOND_CANT_UPDATE )
            return
        endif
        if not(HasLiuli(GetTriggerUnit())) then
            if not(BLuoshang1[GetConvertedPlayerId(GetOwningPlayer(GetTriggerUnit()))]) then
                set BLuoshang1[GetConvertedPlayerId(GetOwningPlayer(GetTriggerUnit()))] = true
                call ShowGameHint(GetOwningPlayer(GetTriggerUnit()),"
                    小提示
                    3级以上的装备不建议使用未经强化的宝石祼升.
                    因为未经强化的宝石失败率较高,且失败会降级.
                    |cff6699ff祝福石能令装备失败不会降级.
                    强化石能有效提高升级成功率.
                    诅咒石更能提高成功率.|r
                    以上3种宝石能与普通的宝石融合在一起.
                    以上3种宝石均在宝石专区刷怪获取.
    ")
            endif
        endif
        if (DiamondB('oslo','grsl','sksh',60) == true) then
            return
        endif
        if (DiamondB('blba','cosl','ocor',60) == true) then
            return
        endif
        if (DiamondB('pams','jdrn','rat3',60) == true) then
            return
        endif
        if (DiamondB('shrs','kgal','stre',60) == true) then
            return
        endif
        if (DiamondB('thdm','arsh','lure',60) == true) then
            return
        endif
        if (DiamondB('tmmt','brag','rots',60) == true) then
            return
        endif
        if (DiamondB('mlst','nspi','frhg',60) == true) then
            return
        endif
        if (DiamondB('soul','sbok','ofir',60) == true) then
            return
        endif
        if (DiamondB('gsou','envl','gldo',60) == true) then
            return
        endif
        call UnitAddItemByIdSwapped( 'jpnt', GetTriggerUnit() )
        call DisplayTextToPlayer( GetOwningPlayer(GetTriggerUnit()), 0, 0, DIAMOND_CANT_UPDATE )
        return
    endfunction
//---------------------------------------------------------------------------------------------------
    /*
        +5强化宝石
    */
    private function AddFifthStrDiamond takes nothing returns nothing
        if (IsItemPawnable(GetSpellTargetItem()) == false) then
            call UnitAddItemByIdSwapped( 'ledg', GetTriggerUnit() )
            call DisplayTextToPlayer( GetOwningPlayer(GetTriggerUnit()), 0, 0, DIAMOND_CANT_UPDATE )
            return
        endif
        if (DiamondB('oslo','grsl','sksh',80) == true) then
            return
        endif
        if (DiamondB('blba','cosl','ocor',80) == true) then
            return
        endif
        if (DiamondB('pams','jdrn','rat3',80) == true) then
            return
        endif
        if (DiamondB('shrs','kgal','stre',80) == true) then
            return
        endif
        if (DiamondB('thdm','arsh','lure',80) == true) then
            return
        endif
        if (DiamondB('tmmt','brag','rots',80) == true) then
            return
        endif
        if (DiamondB('mlst','nspi','frhg',80) == true) then
            return
        endif
        if (DiamondB('soul','sbok','ofir',80) == true) then
            return
        endif
        if (DiamondB('gsou','envl','gldo',80) == true) then
            return
        endif
        call UnitAddItemByIdSwapped( 'ledg', GetTriggerUnit() )
        call DisplayTextToPlayer( GetOwningPlayer(GetTriggerUnit()), 0, 0, DIAMOND_CANT_UPDATE )
        return
    endfunction
//---------------------------------------------------------------------------------------------------
    /*
        +5祝福宝石
    */
    private function AddFifthBlessDiamond takes nothing returns nothing
        if (IsItemPawnable(GetSpellTargetItem()) == false) then
            call UnitAddItemByIdSwapped( 'wtlg', GetTriggerUnit() )
            call DisplayTextToPlayer( GetOwningPlayer(GetTriggerUnit()), 0, 0, DIAMOND_CANT_UPDATE )
            return
        endif
        if (DiamondA('oslo','grsl', 50) == true) then
            return
        endif
        if (DiamondA('blba','cosl', 50) == true) then
            return
        endif
        if (DiamondA('pams','jdrn', 50) == true) then
            return
        endif
        if (DiamondA('shrs','kgal', 50) == true) then
            return
        endif
        if (DiamondA('thdm','arsh', 50) == true) then
            return
        endif
        if (DiamondA('tmmt','brag', 50) == true) then
            return
        endif
        if (DiamondA('mlst','nspi', 50) == true) then
            return
        endif
        if (DiamondA('soul','sbok', 50) == true) then
            return
        endif
        if (DiamondA('gsou','envl', 50) == true) then
            return
        endif
        call UnitAddItemByIdSwapped( 'wtlg', GetTriggerUnit() )
        call DisplayTextToPlayer( GetOwningPlayer(GetTriggerUnit()), 0, 0, DIAMOND_CANT_UPDATE )
        return
    endfunction
//---------------------------------------------------------------------------------------------------
    /*
        +5诅咒宝石
    */
    private function AddFifthCurseDiamond takes nothing returns nothing
        if (IsItemPawnable(GetSpellTargetItem()) == false) then
            call UnitAddItemByIdSwapped( 'gopr', GetTriggerUnit() )
            call DisplayTextToPlayer( GetOwningPlayer(GetTriggerUnit()), 0, 0, DIAMOND_CANT_UPDATE )
            return
        endif
        if (DiamondC('oslo','grsl','esaz',90) == true) then
            return
        endif
        if (DiamondC('blba','cosl','asbl',90) == true) then
            return
        endif
        if (DiamondC('pams','jdrn','ram4',90) == true) then
            return
        endif
        if (DiamondC('shrs','kgal','ram3',90) == true) then
            return
        endif
        if (DiamondC('thdm','arsh','ram2',90) == true) then
            return
        endif
        if (DiamondC('tmmt','brag','ram1',90) == true) then
            return
        endif
        if (DiamondC('mlst','nspi','oven',90) == true) then
            return
        endif
        if (DiamondC('soul','sbok','tels',90) == true) then
            return
        endif
        if (DiamondC('gsou','envl','gvsm',90) == true) then
            return
        endif
        call UnitAddItemByIdSwapped( 'gopr', GetTriggerUnit() )
        call DisplayTextToPlayer( GetOwningPlayer(GetTriggerUnit()), 0, 0, DIAMOND_CANT_UPDATE )
        return
    endfunction
//---------------------------------------------------------------------------------------------------
    /*
        +6宝石
    */
    private function AddSixthDiamond takes nothing returns nothing
        if (IsItemPawnable(GetSpellTargetItem()) == false) then
            call UnitAddItemByIdSwapped( 'glsk', GetTriggerUnit() )
            call DisplayTextToPlayer( GetOwningPlayer(GetTriggerUnit()), 0, 0, DIAMOND_CANT_UPDATE )
            return
        endif
        if not(HasLiuli(GetTriggerUnit())) then
            if not(BLuoshang1[GetConvertedPlayerId(GetOwningPlayer(GetTriggerUnit()))]) then
                set BLuoshang1[GetConvertedPlayerId(GetOwningPlayer(GetTriggerUnit()))] = true
                call ShowGameHint(GetOwningPlayer(GetTriggerUnit()),"
                    小提示
                    3级以上的装备不建议使用未经强化的宝石祼升.
                    因为未经强化的宝石失败率较高,且失败会降级.
                    |cff6699ff祝福石能令装备失败不会降级.
                    强化石能有效提高升级成功率.
                    诅咒石更能提高成功率.|r
                    以上3种宝石能与普通的宝石融合在一起.
                    以上3种宝石均在宝石专区刷怪获取.
    ")
            endif
        endif
        if (DiamondB('grsl','flag','oslo',50) == true) then
            return
        endif
        if (DiamondB('cosl','shhn','blba',50) == true) then
            return
        endif
        if (DiamondB('jdrn','shcw','pams',50) == true) then
            return
        endif
        if (DiamondB('kgal','shtm','shrs',50) == true) then
            return
        endif
        if (DiamondB('arsh','srtl','thdm',50) == true) then
            return
        endif
        if (DiamondB('brag','olig','tmmt',50) == true) then
            return
        endif
        if (DiamondB('nspi','oli2','mlst',50) == true) then
            return
        endif
        if (DiamondB('sbok','arsc','soul',50) == true) then
            return
        endif
        if (DiamondB('envl','rugt','gsou',50) == true) then
            return
        endif
        call UnitAddItemByIdSwapped( 'glsk', GetTriggerUnit() )
        call DisplayTextToPlayer( GetOwningPlayer(GetTriggerUnit()), 0, 0, DIAMOND_CANT_UPDATE )
        return
    endfunction
//---------------------------------------------------------------------------------------------------
    /*
        +6强化宝石
    */
    private function AddSixthStrDiamond takes nothing returns nothing
        if (IsItemPawnable(GetSpellTargetItem()) == false) then
            call UnitAddItemByIdSwapped( 'dthb', GetTriggerUnit() )
            call DisplayTextToPlayer( GetOwningPlayer(GetTriggerUnit()), 0, 0, DIAMOND_CANT_UPDATE )
            return
        endif
        if (DiamondB('grsl','flag','oslo',70) == true) then
            return
        endif
        if (DiamondB('cosl','shhn','blba',70) == true) then
            return
        endif
        if (DiamondB('jdrn','shcw','pams',70) == true) then
            return
        endif
        if (DiamondB('kgal','shtm','shrs',70) == true) then
            return
        endif
        if (DiamondB('arsh','srtl','thdm',70) == true) then
            return
        endif
        if (DiamondB('brag','olig','tmmt',70) == true) then
            return
        endif
        if (DiamondB('nspi','oli2','mlst',70) == true) then
            return
        endif
        if (DiamondB('sbok','arsc','soul',70) == true) then
            return
        endif
        if (DiamondB('envl','rugt','gsou',70) == true) then
            return
        endif
        call UnitAddItemByIdSwapped( 'dthb', GetTriggerUnit() )
        call DisplayTextToPlayer( GetOwningPlayer(GetTriggerUnit()), 0, 0, DIAMOND_CANT_UPDATE )
        return
    endfunction
//---------------------------------------------------------------------------------------------------
    /*
        +6祝福宝石
    */
    private function AddSixthBlessDiamond takes nothing returns nothing
        if (IsItemPawnable(GetSpellTargetItem()) == false) then
            call UnitAddItemByIdSwapped( 'bzbe', GetTriggerUnit() )
            call DisplayTextToPlayer( GetOwningPlayer(GetTriggerUnit()), 0, 0, DIAMOND_CANT_UPDATE )
            return
        endif
        if (DiamondA('grsl','flag',40) == true) then
            return
        endif
        if (DiamondA('cosl','shhn',40) == true) then
            return
        endif
        if (DiamondA('jdrn','shcw',40) == true) then
            return
        endif
        if (DiamondA('kgal','shtm',40) == true) then
            return
        endif
        if (DiamondA('arsh','srtl',40) == true) then
            return
        endif
        if (DiamondA('brag','olig',40) == true) then
            return
        endif
        if (DiamondA('nspi','oli2',40) == true) then
            return
        endif
        if (DiamondA('sbok','arsc',40) == true) then
            return
        endif
        if (DiamondA('envl','rugt',40) == true) then
            return
        endif
        call UnitAddItemByIdSwapped( 'bzbe', GetTriggerUnit() )
        call DisplayTextToPlayer( GetOwningPlayer(GetTriggerUnit()), 0, 0, DIAMOND_CANT_UPDATE )
        return
    endfunction
//---------------------------------------------------------------------------------------------------
    /*
        +6诅咒宝石
    */
    private function AddSixthCurseDiamond takes nothing returns nothing
        if (IsItemPawnable(GetSpellTargetItem()) == false) then
            call UnitAddItemByIdSwapped( 'dphe', GetTriggerUnit() )
            call DisplayTextToPlayer( GetOwningPlayer(GetTriggerUnit()), 0, 0, DIAMOND_CANT_UPDATE )
            return
        endif
        if (DiamondC('grsl','flag','sksh',80) == true) then
            return
        endif
        if (DiamondC('cosl','shhn','ocor',80) == true) then
            return
        endif
        if (DiamondC('jdrn','shcw','rat3',80) == true) then
            return
        endif
        if (DiamondC('kgal','shtm','stre',80) == true) then
            return
        endif
        if (DiamondC('arsh','srtl','lure',80) == true) then
            return
        endif
        if (DiamondC('brag','olig','rots',80) == true) then
            return
        endif
        if (DiamondC('nspi','oli2','frhg',80) == true) then
            return
        endif
        if (DiamondC('sbok','arsc','ofir',80) == true) then
            return
        endif
        if (DiamondC('envl','rugt','gldo',80) == true) then
            return
        endif
        call UnitAddItemByIdSwapped( 'dphe', GetTriggerUnit() )
        call DisplayTextToPlayer( GetOwningPlayer(GetTriggerUnit()), 0, 0, DIAMOND_CANT_UPDATE )
        return
    endfunction
//---------------------------------------------------------------------------------------------------
    /*
        +7宝石
    */
    private function AddSeventhDiamond takes nothing returns nothing
        if (IsItemPawnable(GetSpellTargetItem()) == false) then
            call UnitAddItemByIdSwapped( 'kygh', GetTriggerUnit() )
            call DisplayTextToPlayer( GetOwningPlayer(GetTriggerUnit()), 0, 0, DIAMOND_CANT_UPDATE )
            return
        endif
        if not(HasLiuli(GetTriggerUnit())) then
            if not(BLuoshang1[GetConvertedPlayerId(GetOwningPlayer(GetTriggerUnit()))]) then
                set BLuoshang1[GetConvertedPlayerId(GetOwningPlayer(GetTriggerUnit()))] = true
                call ShowGameHint(GetOwningPlayer(GetTriggerUnit()),"
                    小提示
                    3级以上的装备不建议使用未经强化的宝石祼升.
                    因为未经强化的宝石失败率较高,且失败会降级.
                    |cff6699ff祝福石能令装备失败不会降级.
                    强化石能有效提高升级成功率.
                    诅咒石更能提高成功率.|r
                    以上3种宝石能与普通的宝石融合在一起.
                    以上3种宝石均在宝石专区刷怪获取.
    ")
            endif
        endif
        if (DiamondB('oli2','rump','nspi',40) == true) then
            return
        endif
        if (DiamondB('arsc','rde0','sbok',40) == true) then
            return
        endif
        if (DiamondB('rugt','shdt','envl',40) == true) then
            return
        endif
        call UnitAddItemByIdSwapped( 'kygh', GetTriggerUnit() )
        call DisplayTextToPlayer( GetOwningPlayer(GetTriggerUnit()), 0, 0, DIAMOND_CANT_UPDATE )
        return
    endfunction
//---------------------------------------------------------------------------------------------------
    /*
        +7强化宝石
    */
    private function AddSeventhStrDiamond takes nothing returns nothing
        if (IsItemPawnable(GetSpellTargetItem()) == false) then
            call UnitAddItemByIdSwapped( 'mort', GetTriggerUnit() )
            call DisplayTextToPlayer( GetOwningPlayer(GetTriggerUnit()), 0, 0, DIAMOND_CANT_UPDATE )
            return
        endif
        if not(HasLiuli(GetTriggerUnit())) then
            if not(BLuoshang2[GetConvertedPlayerId(GetOwningPlayer(GetTriggerUnit()))]) then
                set BLuoshang2[GetConvertedPlayerId(GetOwningPlayer(GetTriggerUnit()))] = true
                call ShowGameHint(GetOwningPlayer(GetTriggerUnit()),"
                小提示
                7级以上的装备几率可能会较低.
                你还可以通过下面2种方式提高成功率:
                1.通过42次转生获取|cffff00ff【虚】琉璃璞玉|r
                (100%的升级成功率,当局无限次使用)
                2.使用杀敌数在基地左边购买|cffff0000血精石|r.
                (100%的升级成功率,消耗品)
    ")
            endif
        endif
        if (DiamondB('oli2','rump','nspi',60) == true) then
            return
        endif
        if (DiamondB('arsc','rde0','sbok',60) == true) then
            return
        endif
        if (DiamondB('rugt','shdt','envl',60) == true) then
            return
        endif
        call UnitAddItemByIdSwapped( 'mort', GetTriggerUnit() )
        call DisplayTextToPlayer( GetOwningPlayer(GetTriggerUnit()), 0, 0, DIAMOND_CANT_UPDATE )
        return
    endfunction
//---------------------------------------------------------------------------------------------------
    /*
        +7祝福宝石
    */
    private function AddSeventhBlessDiamond takes nothing returns nothing
        if (IsItemPawnable(GetSpellTargetItem()) == false) then
            call UnitAddItemByIdSwapped( 'ches', GetTriggerUnit() )
            call DisplayTextToPlayer( GetOwningPlayer(GetTriggerUnit()), 0, 0, DIAMOND_CANT_UPDATE )
            return
        endif
        if not(HasLiuli(GetTriggerUnit())) then
            if not(BLuoshang2[GetConvertedPlayerId(GetOwningPlayer(GetTriggerUnit()))]) then
                set BLuoshang2[GetConvertedPlayerId(GetOwningPlayer(GetTriggerUnit()))] = true
                call ShowGameHint(GetOwningPlayer(GetTriggerUnit()),"
                小提示
                7级以上的装备几率可能会较低.
                你还可以通过下面2种方式提高成功率:
                1.通过42次转生获取|cffff00ff【虚】琉璃璞玉|r
                (100%的升级成功率,当局无限次使用)
                2.使用杀敌数在基地左边购买|cffff0000血精石|r.
                (100%的升级成功率,消耗品)
    ")
            endif
        endif
        if (DiamondA('oli2','rump',30) == true) then
            return
        endif
        if (DiamondA('arsc','rde0',30) == true) then
            return
        endif
        if (DiamondA('rugt','shdt',30) == true) then
            return
        endif
        call UnitAddItemByIdSwapped( 'ches', GetTriggerUnit() )
        call DisplayTextToPlayer( GetOwningPlayer(GetTriggerUnit()), 0, 0, DIAMOND_CANT_UPDATE )
        return
    endfunction
//---------------------------------------------------------------------------------------------------
    /*
        +7诅咒宝石
    */
    private function AddSeventhCurseDiamond takes nothing returns nothing
        if (IsItemPawnable(GetSpellTargetItem()) == false) then
            call UnitAddItemByIdSwapped('cnhn', GetTriggerUnit() )
            call DisplayTextToPlayer( GetOwningPlayer(GetTriggerUnit()), 0, 0, DIAMOND_CANT_UPDATE )
            return
        endif
        if not(HasLiuli(GetTriggerUnit())) then
            if not(BLuoshang2[GetConvertedPlayerId(GetOwningPlayer(GetTriggerUnit()))]) then
                set BLuoshang2[GetConvertedPlayerId(GetOwningPlayer(GetTriggerUnit()))] = true
                call ShowGameHint(GetOwningPlayer(GetTriggerUnit()),"
                小提示
                7级以上的装备几率可能会较低.
                你还可以通过下面2种方式提高成功率:
                1.通过42次转生获取|cffff00ff【虚】琉璃璞玉|r
                (100%的升级成功率,当局无限次使用)
                2.使用杀敌数在基地左边购买|cffff0000血精石|r.
                (100%的升级成功率,消耗品)
    ")
            endif
        endif
        if (DiamondC('oli2','rump','mlst',70) == true) then
            return
        endif
        if (DiamondC('arsc','rde0','soul',70) == true) then
            return
        endif
        if (DiamondC('rugt','shdt','gsou',70) == true) then
            return
        endif
        call UnitAddItemByIdSwapped('cnhn', GetTriggerUnit() )
        call DisplayTextToPlayer( GetOwningPlayer(GetTriggerUnit()), 0, 0, DIAMOND_CANT_UPDATE )
        return
    endfunction
//---------------------------------------------------------------------------------------------------
    /*
        +8宝石
    */
    private function AddEighthDiamond takes nothing returns nothing
        if (IsItemPawnable(GetSpellTargetItem()) == false) then
            call UnitAddItemByIdSwapped( 'sehr', GetTriggerUnit() )
            call DisplayTextToPlayer( GetOwningPlayer(GetTriggerUnit()), 0, 0, DIAMOND_CANT_UPDATE )
            return
        endif
        if not(HasLiuli(GetTriggerUnit())) then
            if not(BLuoshang1[GetConvertedPlayerId(GetOwningPlayer(GetTriggerUnit()))]) then
                set BLuoshang1[GetConvertedPlayerId(GetOwningPlayer(GetTriggerUnit()))] = true
                call ShowGameHint(GetOwningPlayer(GetTriggerUnit()),"
                    小提示
                    3级以上的装备不建议使用未经强化的宝石祼升.
                    因为未经强化的宝石失败率较高,且失败会降级.
                    |cff6699ff祝福石能令装备失败不会降级.
                    强化石能有效提高升级成功率.
                    诅咒石更能提高成功率.|r
                    以上3种宝石能与普通的宝石融合在一起.
                    以上3种宝石均在宝石专区刷怪获取.
    ")
            endif
        endif
        if (DiamondB('rump','shen','oli2',40) == true) then
            return
        endif
        if (DiamondB('rde0','oflg','arsc',40) == true) then
            return
        endif
        if (DiamondB('shdt','crdt','rugt',40) == true) then
            return
        endif
        call UnitAddItemByIdSwapped( 'sehr', GetTriggerUnit() )
        call DisplayTextToPlayer( GetOwningPlayer(GetTriggerUnit()), 0, 0, DIAMOND_CANT_UPDATE )
        return
    endfunction
//---------------------------------------------------------------------------------------------------
    /*
        +8强化宝石
    */
    private function AddEighthStrDiamond takes nothing returns nothing
        if (IsItemPawnable(GetSpellTargetItem()) == false) then
            call UnitAddItemByIdSwapped( 'k3m3', GetTriggerUnit() )
            call DisplayTextToPlayer( GetOwningPlayer(GetTriggerUnit()), 0, 0, DIAMOND_CANT_UPDATE )
            return
        endif
        if not(HasLiuli(GetTriggerUnit())) then
            if not(BLuoshang2[GetConvertedPlayerId(GetOwningPlayer(GetTriggerUnit()))]) then
                set BLuoshang2[GetConvertedPlayerId(GetOwningPlayer(GetTriggerUnit()))] = true
                call ShowGameHint(GetOwningPlayer(GetTriggerUnit()),"
                小提示
                7级以上的装备几率可能会较低.
                你还可以通过下面2种方式提高成功率:
                1.通过42次转生获取|cffff00ff【虚】琉璃璞玉|r
                (100%的升级成功率,当局无限次使用)
                2.使用杀敌数在基地左边购买|cffff0000血精石|r.
                (100%的升级成功率,消耗品)
    ")
            endif
        endif
        if (DiamondB('rump','shen','oli2',60) == true) then
            return
        endif
        if (DiamondB('rde0','oflg','arsc',60) == true) then
            return
        endif
        if (DiamondB('shdt','crdt','rugt',60) == true) then
            return
        endif
        call UnitAddItemByIdSwapped( 'k3m3', GetTriggerUnit() )
        call DisplayTextToPlayer( GetOwningPlayer(GetTriggerUnit()), 0, 0, DIAMOND_CANT_UPDATE )
        return
    endfunction
//---------------------------------------------------------------------------------------------------
    /*
        +8祝福宝石
    */
    private function AddEighthBlessDiamond takes nothing returns nothing
        if (IsItemPawnable(GetSpellTargetItem()) == false) then
            call UnitAddItemByIdSwapped( 'k3m2', GetTriggerUnit() )
            call DisplayTextToPlayer( GetOwningPlayer(GetTriggerUnit()), 0, 0, DIAMOND_CANT_UPDATE )
            return
        endif
        if not(HasLiuli(GetTriggerUnit())) then
            if not(BLuoshang2[GetConvertedPlayerId(GetOwningPlayer(GetTriggerUnit()))]) then
                set BLuoshang2[GetConvertedPlayerId(GetOwningPlayer(GetTriggerUnit()))] = true
                call ShowGameHint(GetOwningPlayer(GetTriggerUnit()),"
                小提示
                7级以上的装备几率可能会较低.
                你还可以通过下面2种方式提高成功率:
                1.通过42次转生获取|cffff00ff【虚】琉璃璞玉|r
                (100%的升级成功率,当局无限次使用)
                2.使用杀敌数在基地左边购买|cffff0000血精石|r.
                (100%的升级成功率,消耗品)
    ")
            endif
        endif
        if (DiamondA('rump','shen',30) == true) then
            return
        endif
        if (DiamondA('rde0','oflg',30) == true) then
            return
        endif
        if (DiamondA('shdt','crdt',30) == true) then
            return
        endif
        call UnitAddItemByIdSwapped( 'k3m2', GetTriggerUnit() )
        call DisplayTextToPlayer( GetOwningPlayer(GetTriggerUnit()), 0, 0, DIAMOND_CANT_UPDATE )
        return
    endfunction
//---------------------------------------------------------------------------------------------------
    /*
        +8诅咒宝石
    */
    private function AddEighthCurseDiamond takes nothing returns nothing
        if (IsItemPawnable(GetSpellTargetItem()) == false) then
            call UnitAddItemByIdSwapped( 'kybl', GetTriggerUnit() )
            call DisplayTextToPlayer( GetOwningPlayer(GetTriggerUnit()), 0, 0, DIAMOND_CANT_UPDATE )
            return
        endif
        if not(HasLiuli(GetTriggerUnit())) then
            if not(BLuoshang2[GetConvertedPlayerId(GetOwningPlayer(GetTriggerUnit()))]) then
                set BLuoshang2[GetConvertedPlayerId(GetOwningPlayer(GetTriggerUnit()))] = true
                call ShowGameHint(GetOwningPlayer(GetTriggerUnit()),"
                小提示
                7级以上的装备几率可能会较低.
                你还可以通过下面2种方式提高成功率:
                1.通过42次转生获取|cffff00ff【虚】琉璃璞玉|r
                (100%的升级成功率,当局无限次使用)
                2.使用杀敌数在基地左边购买|cffff0000血精石|r.
                (100%的升级成功率,消耗品)
    ")
            endif
        endif
        if (DiamondC('rump','shen','nspi',70) == true) then
            return
        endif
        if (DiamondC('rde0','oflg','sbok',70) == true) then
            return
        endif
        if (DiamondC('shdt','crdt','envl',70) == true) then
            return
        endif
        call UnitAddItemByIdSwapped( 'kybl', GetTriggerUnit() )
        call DisplayTextToPlayer( GetOwningPlayer(GetTriggerUnit()), 0, 0, DIAMOND_CANT_UPDATE )
        return
    endfunction
//---------------------------------------------------------------------------------------------------
    /*
        +9宝石
    */
    private function AddNinthDiamond takes nothing returns nothing
        if (IsItemPawnable(GetSpellTargetItem()) == false) then
            call UnitAddItemByIdSwapped( 'bzbf', GetTriggerUnit() )
            call DisplayTextToPlayer( GetOwningPlayer(GetTriggerUnit()), 0, 0, DIAMOND_CANT_UPDATE )
            return
        endif
        if not(HasLiuli(GetTriggerUnit())) then
            if not(BLuoshang1[GetConvertedPlayerId(GetOwningPlayer(GetTriggerUnit()))]) then
                set BLuoshang1[GetConvertedPlayerId(GetOwningPlayer(GetTriggerUnit()))] = true
                call ShowGameHint(GetOwningPlayer(GetTriggerUnit()),"
                    小提示
                    3级以上的装备不建议使用未经强化的宝石祼升.
                    因为未经强化的宝石失败率较高,且失败会降级.
                    |cff6699ff祝福石能令装备失败不会降级.
                    强化石能有效提高升级成功率.
                    诅咒石更能提高成功率.|r
                    以上3种宝石能与普通的宝石融合在一起.
                    以上3种宝石均在宝石专区刷怪获取.
    ")
            endif
        endif
        if (DiamondB ('shen','stpg','rump',40) == true) then
            return
        endif
        if (DiamondB ('oflg','frgd','rde0',40) == true) then
            return
        endif
        if (DiamondB ('crdt','pspd','shdt',40) == true) then
            return
        endif
        call UnitAddItemByIdSwapped( 'bzbf', GetTriggerUnit() )
        call DisplayTextToPlayer( GetOwningPlayer(GetTriggerUnit()), 0, 0, DIAMOND_CANT_UPDATE )
        return
    endfunction
//---------------------------------------------------------------------------------------------------
    /*
        +9强化宝石
    */
    private function AddNinthStrDiamond takes nothing returns nothing
        if (IsItemPawnable(GetSpellTargetItem()) == false) then
            call UnitAddItemByIdSwapped( 'kysn', GetTriggerUnit() )
            call DisplayTextToPlayer( GetOwningPlayer(GetTriggerUnit()), 0, 0, DIAMOND_CANT_UPDATE )
            return
        endif
        if not(HasLiuli(GetTriggerUnit())) then
            if not(BLuoshang2[GetConvertedPlayerId(GetOwningPlayer(GetTriggerUnit()))]) then
                set BLuoshang2[GetConvertedPlayerId(GetOwningPlayer(GetTriggerUnit()))] = true
                call ShowGameHint(GetOwningPlayer(GetTriggerUnit()),"
                小提示
                7级以上的装备几率可能会较低.
                你还可以通过下面2种方式提高成功率:
                1.通过42次转生获取|cffff00ff【虚】琉璃璞玉|r
                (100%的升级成功率,当局无限次使用)
                2.使用杀敌数在基地左边购买|cffff0000血精石|r.
                (100%的升级成功率,消耗品)
    ")
            endif
        endif
        if (DiamondB ('shen','stpg','rump',60) == true) then
            return
        endif
        if (DiamondB ('oflg','frgd','rde0',60) == true) then
            return
        endif
        if (DiamondB ('crdt','pspd','shdt',60) == true) then
            return
        endif
        call UnitAddItemByIdSwapped( 'kysn', GetTriggerUnit() )
        call DisplayTextToPlayer( GetOwningPlayer(GetTriggerUnit()), 0, 0, DIAMOND_CANT_UPDATE )
        return
    endfunction
//---------------------------------------------------------------------------------------------------
    /*
        +9祝福宝石
    */
    private function AddNinthBlessDiamond takes nothing returns nothing
        if (IsItemPawnable(GetSpellTargetItem()) == false) then
            call UnitAddItemByIdSwapped( 'ktrm', GetTriggerUnit() )
            call DisplayTextToPlayer( GetOwningPlayer(GetTriggerUnit()), 0, 0, DIAMOND_CANT_UPDATE )
            return
        endif
        if not(HasLiuli(GetTriggerUnit())) then
            if not(BLuoshang2[GetConvertedPlayerId(GetOwningPlayer(GetTriggerUnit()))]) then
                set BLuoshang2[GetConvertedPlayerId(GetOwningPlayer(GetTriggerUnit()))] = true
                call ShowGameHint(GetOwningPlayer(GetTriggerUnit()),"
                小提示
                7级以上的装备几率可能会较低.
                你还可以通过下面2种方式提高成功率:
                1.通过42次转生获取|cffff00ff【虚】琉璃璞玉|r
                (100%的升级成功率,当局无限次使用)
                2.使用杀敌数在基地左边购买|cffff0000血精石|r.
                (100%的升级成功率,消耗品)
    ")
            endif
        endif
        if (DiamondA('shen','stpg',30) == true) then
            return
        endif
        if (DiamondA('oflg','frgd',30) == true) then
            return
        endif
        if (DiamondA('crdt','pspd',30) == true) then
            return
        endif
        call UnitAddItemByIdSwapped( 'ktrm', GetTriggerUnit() )
        call DisplayTextToPlayer( GetOwningPlayer(GetTriggerUnit()), 0, 0, DIAMOND_CANT_UPDATE )
        return
    endfunction
//---------------------------------------------------------------------------------------------------
    /*
        +9诅咒宝石
    */
    private function AddNinthCurseDiamond takes nothing returns nothing
        if (IsItemPawnable(GetSpellTargetItem()) == false) then
            call UnitAddItemByIdSwapped( 'shwd', GetTriggerUnit() )
            call DisplayTextToPlayer( GetOwningPlayer(GetTriggerUnit()), 0, 0, DIAMOND_CANT_UPDATE )
            return
        endif
        if not(HasLiuli(GetTriggerUnit())) then
            if not(BLuoshang2[GetConvertedPlayerId(GetOwningPlayer(GetTriggerUnit()))]) then
                set BLuoshang2[GetConvertedPlayerId(GetOwningPlayer(GetTriggerUnit()))] = true
                call ShowGameHint(GetOwningPlayer(GetTriggerUnit()),"
                小提示
                7级以上的装备几率可能会较低.
                你还可以通过下面2种方式提高成功率:
                1.通过42次转生获取|cffff00ff【虚】琉璃璞玉|r
                (100%的升级成功率,当局无限次使用)
                2.使用杀敌数在基地左边购买|cffff0000血精石|r.
                (100%的升级成功率,消耗品)
    ")
            endif
        endif
        if (DiamondC ('shen','stpg','oli2',70) == true) then
            return
        endif
        if (DiamondC ('oflg','frgd','arsc',70) == true) then
            return
        endif
        if (DiamondC ('crdt','pspd','rugt',70) == true) then
            return
        endif
        call UnitAddItemByIdSwapped( 'shwd', GetTriggerUnit() )
        call DisplayTextToPlayer( GetOwningPlayer(GetTriggerUnit()), 0, 0, DIAMOND_CANT_UPDATE )
        return
    endfunction
//---------------------------------------------------------------------------------------------------
    /*
        血精石
    */
    private function XueJingDiamond takes nothing returns nothing
        if (IsItemPawnable(GetSpellTargetItem()) == false) then
            call UnitAddItemByIdSwapped( 'k3m1', GetTriggerUnit() )
            call DisplayTextToPlayer( GetOwningPlayer(GetTriggerUnit()), 0, 0, DIAMOND_CANT_UPDATE )
            return
        endif
        if (Diamond100('oli2','rump') == true) then
            return
        endif
        if (Diamond100('arsc','rde0') == true) then
            return
        endif
        if (Diamond100('rugt','shdt') == true) then
            return
        endif
        if (Diamond100('shen','stpg') == true) then
            return
        endif
        if (Diamond100('oflg','frgd') == true) then
            return
        endif
        if (Diamond100('crdt','pspd') == true) then
            return
        endif
        if (Diamond100('rump','shen') == true) then
            return
        endif
        if (Diamond100('rde0','oflg') == true) then
            return
        endif
        if (Diamond100('shdt','crdt') == true) then
            return
        endif
        call UnitAddItemByIdSwapped( 'k3m1', GetTriggerUnit() )
        call DisplayTextToPlayer( GetOwningPlayer(GetTriggerUnit()), 0, 0, DIAMOND_CANT_UPDATE )
        return
    endfunction
//---------------------------------------------------------------------------------------------------
    /*
        二阶混沌之石
    */
    private function Hundun2Diamond takes nothing returns nothing
        if (IsItemPawnable(GetSpellTargetItem()) == false) then
            call UnitAddItemByIdSwapped( 'I07R', GetTriggerUnit() )
            call DisplayTextToPlayer( GetOwningPlayer(GetTriggerUnit()), 0, 0, DIAMOND_CANT_UPDATE )
            return
        endif
        if (Diamond100('I04W','I07E') == true) then
            return
        endif
        if (Diamond100('ICS1','I07F') == true) then
            return
        endif
        if (Diamond100('I04Y','I07G') == true) then
            return
        endif
        if (Diamond100('I05T','I07H') == true) then
            return
        endif
        if (Diamond100('I060','I07I') == true) then
            return
        endif
        if (Diamond100('I05Z','I07J') == true) then
            return
        endif
        if (Diamond100('I05Y','I07K') == true) then
            return
        endif
        if (Diamond100('I04X','I07O') == true) then
            return
        endif
        if (Diamond100('IB0A','I07N') == true) then
            return
        endif
        if (Diamond100('I05X','I07P') == true) then
            return
        endif
        if (Diamond100('ICY1','I07Q') == true) then
            return
        endif
        if (Diamond100('I05W','I07M') == true) then
            return
        endif
        if (Diamond100('I05V','I07L') == true) then
            return
        endif
        if (Diamond100('ICX1','I05U') == true) then
            return
        endif
        call UnitAddItemByIdSwapped( 'I07R', GetTriggerUnit() )
        call DisplayTextToPlayer( GetOwningPlayer(GetTriggerUnit()), 0, 0, DIAMOND_CANT_UPDATE )
        return
    endfunction
//---------------------------------------------------------------------------------------------------
    /*
        技能跳转
    */
    private function TSpellDiamondAct takes nothing returns nothing
        if (GetSpellAbilityId() == 'A02Z') then
            call AddOneDiamond()
        elseif (GetSpellAbilityId() == 'Amnb') then
            call AddSecondDiamond()
        elseif (GetSpellAbilityId() == 'Ambb') then
            call AddThirdDiamond()
        elseif ((GetSpellAbilityId() == 'ACfl')) then
            call AddFourthDiamond()
        elseif ((GetSpellAbilityId() == 'Aenw')) then
            call AddFourthStrDiamond()
        elseif ((GetSpellAbilityId() == 'Aenr')) then
            call AddFourthBlessDiamond()
        elseif ((GetSpellAbilityId() == 'ACcy')) then
            call AddFifthDiamond()
        elseif ((GetSpellAbilityId() == 'ACbn')) then
            call AddFifthStrDiamond()
        elseif ((GetSpellAbilityId() == 'SCc1')) then
            call AddFifthBlessDiamond()
        elseif ((GetSpellAbilityId() == 'ACfb')) then
            call AddFifthCurseDiamond()
        elseif ((GetSpellAbilityId() == 'ACls')) then
            call AddSixthDiamond()
        elseif ((GetSpellAbilityId() == 'ACbf')) then
            call AddSixthStrDiamond()
        elseif ((GetSpellAbilityId() == 'Afod')) then
            call AddSixthBlessDiamond()
        elseif ((GetSpellAbilityId() == 'ACdc')) then
            call AddSixthCurseDiamond()
        elseif ((GetSpellAbilityId() == 'A0DG')) then
            call AddSeventhDiamond()
        elseif ((GetSpellAbilityId() == 'A0DI')) then
            call AddSeventhStrDiamond()
        elseif ((GetSpellAbilityId() == 'A0DH')) then
            call AddSeventhBlessDiamond()
        elseif ((GetSpellAbilityId() == 'A0DN')) then
            call AddSeventhCurseDiamond()
        elseif ((GetSpellAbilityId() == 'A0DJ')) then
            call AddEighthDiamond()
        elseif ((GetSpellAbilityId() == 'A0DK')) then
            call AddEighthStrDiamond()
        elseif ((GetSpellAbilityId() == 'A0DL')) then
            call AddEighthBlessDiamond()
        elseif ((GetSpellAbilityId() == 'A0DM')) then
            call AddEighthCurseDiamond()
        elseif ((GetSpellAbilityId() == 'A0DO')) then
            call AddNinthDiamond()
        elseif ((GetSpellAbilityId() == 'A0DR')) then
            call AddNinthStrDiamond()
        elseif ((GetSpellAbilityId() == 'A0DQ')) then
            call AddNinthBlessDiamond()
        elseif ((GetSpellAbilityId() == 'A0DP')) then
            call AddNinthCurseDiamond()
        elseif ((GetSpellAbilityId() == 'A0EK')) then
            call XueJingDiamond()
        elseif ((GetSpellAbilityId() == 'A0N6')) then
            call Hundun2Diamond()
        endif
    endfunction
//---------------------------------------------------------------------------------------------------
    /*
        宝石区怪物过滤
    */
    function DiamondMonsterFilter takes nothing returns boolean
        return (((IsUnitAliveBJ(GetFilterUnit()) == true) and (GetOwningPlayer(GetFilterUnit()) == Player(10))))
    endfunction
//---------------------------------------------------------------------------------------------------
    /*
        宝石区玩家过滤
    */
    function DiamondPlayerFilter takes nothing returns boolean
        return ((IsUnitType(GetFilterUnit(), UNIT_TYPE_HERO) == true) and (GetPlayerController(GetOwningPlayer(GetFilterUnit())) == MAP_CONTROL_USER) and (IsUnitAliveBJ(GetFilterUnit()) or (GetFilterUnit() == udg_H[GetConvertedPlayerId(GetOwningPlayer(GetFilterUnit()))] and not(IsWanjie()) )))
    endfunction
    function DiamondPlayerFilterOther takes nothing returns boolean
        return ((IsUnitType(GetFilterUnit(), UNIT_TYPE_HERO) == true) and (GetPlayerController(GetOwningPlayer(GetFilterUnit())) == MAP_CONTROL_USER) and (IsUnitAliveBJ(GetFilterUnit()) or (GetFilterUnit() == udg_H[GetConvertedPlayerId(GetOwningPlayer(GetFilterUnit()))] )))
    endfunction
//---------------------------------------------------------------------------------------------------
    /*
        创建宝石怪并给予其技能
    */
    private function CreateDiamonMonster takes integer whichType,integer aLevel returns nothing
        local real x = 0
        local real y = 0
        local unit u
        if (RectContainsUnit(gg_rct________8,GetSellingUnit())) then
            set x = GetRandomReal(GetRectMinX(gg_rct________8),GetRectMaxX(gg_rct________8))
            set y = GetRandomReal(GetRectMinY(gg_rct________8),GetRectMaxY(gg_rct________8))
        elseif (RectContainsUnit(gg_rct_Diamond2,GetSellingUnit())) then
            set x = GetRandomReal(GetRectMinX(gg_rct_Diamond2),GetRectMaxX(gg_rct_Diamond2))
            set y = GetRandomReal(GetRectMinY(gg_rct_Diamond2),GetRectMaxY(gg_rct_Diamond2))
        else
            set x = GetRandomReal(GetRectMinX(gg_rct_Diamond3),GetRectMaxX(gg_rct_Diamond3))
            set y = GetRandomReal(GetRectMinY(gg_rct_Diamond3),GetRectMaxY(gg_rct_Diamond3))
        endif
        set u = CreateUnit(Player(10),whichType,x,y,GetRandomDirectionDeg())
        call EnhanceDiffAttack(u)
        call SetUnitAbilityLevel(u, 'AB01', GetWanjieAddInt(aLevel,9) )
        call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\NightElf\\Blink\\BlinkTarget.mdl", x, y ))
        set u = null
    endfunction
//---------------------------------------------------------------------------------------------------
    /*
        购买开始刷宝石怪
    */
    function TBuyDiamondStartCon takes nothing returns boolean
        return (BuyerFilter(GetBuyingUnit()) and (GetUnitTypeId(GetSellingUnit()) == 'nmr5' or GetUnitTypeId(GetSellingUnit()) == 'nmre' or GetUnitTypeId(GetSellingUnit()) == 'n01D' or GetUnitTypeId(GetSellingUnit()) == 'n01C'))
    endfunction
    function TBuyDiamondStartAct takes nothing returns nothing
        local group group1
        local group group2
        local integer i = 1
        if (RectContainsUnit(gg_rct________8,GetSellingUnit())) then
            set group1 = YDWEGetUnitsInRectMatchingNull(gg_rct________8, Condition(function DiamondMonsterFilter))
            set group2 = YDWEGetUnitsInRectMatchingNull(gg_rct________8, Condition(function DiamondPlayerFilter))
        elseif (RectContainsUnit(gg_rct_Diamond2,GetSellingUnit())) then
            set group1 = YDWEGetUnitsInRectMatchingNull(gg_rct_Diamond2, Condition(function DiamondMonsterFilter))
            set group2 = YDWEGetUnitsInRectMatchingNull(gg_rct_Diamond2, Condition(function DiamondPlayerFilter))
        elseif (RectContainsUnit(gg_rct_Diamond3,GetSellingUnit())) then
            set group1 = YDWEGetUnitsInRectMatchingNull(gg_rct_Diamond3, Condition(function DiamondMonsterFilter))
            set group2 = YDWEGetUnitsInRectMatchingNull(gg_rct_Diamond3, Condition(function DiamondPlayerFilter))
        endif
        //! textmacro StartDiamondMonster takes ItemType,UnitType,Level
        if ((GetItemTypeId(GetSoldItem()) == '$ItemType$')) then
            if ((CountUnitsInGroup(group1) == 0)) then
                if ((CountUnitsInGroup(group2) != 0)) then
                    if (RectContainsUnit(gg_rct________8,GetSellingUnit())) then
                        set IAtleast1 = 21
                    elseif (RectContainsUnit(gg_rct_Diamond2,GetSellingUnit())) then
                        set IAtleast2 = 21
                    elseif (RectContainsUnit(gg_rct_Diamond3,GetSellingUnit())) then
                        set IAtleast3 = 21
                    endif
                    debug set BJiulun = true
                    call DisplayTextToPlayer( GetOwningPlayer(GetBuyingUnit()), 0, 0, "|cFFFF66CC【消息】|r祝你好运!" )
                    set i = 1
                    loop
                        exitwhen i > 20
                        call CreateDiamonMonster('$UnitType$',$Level$)
                        set i = i +1
                    endloop
                else
                    call DisplayTextToPlayer( GetOwningPlayer(GetBuyingUnit()), 0, 0, "|cFFFF66CC【消息】|r没英雄不开刷!" )
                endif
            else
                call DisplayTextToPlayer( GetOwningPlayer(GetBuyingUnit()), 0, 0, "|cFFFF66CC【消息】|r清完这波东西再来买!" )
            endif
        endif
        //! endtextmacro
        //! runtextmacro StartDiamondMonster("rre1","nnmg","1")
        //! runtextmacro StartDiamondMonster("rhe1","nmyr","2")
        //! runtextmacro StartDiamondMonster("guvi","nnsw","3")
        //! runtextmacro StartDiamondMonster("tpow","nsnp","4")
        //! runtextmacro StartDiamondMonster("rhe2","nhyc","5")
        //! runtextmacro StartDiamondMonster("tint","nnrg","6")
        //! runtextmacro StartDiamondMonster("modt","nplb","7")
        //! runtextmacro StartDiamondMonster("sman","ntrv","8")
        //! runtextmacro StartDiamondMonster("sorf","nmmu","9")
        //! runtextmacro StartDiamondMonster("ratf","nanb","5")
        //! runtextmacro StartDiamondMonster("rreb","nanm","5")
        //! runtextmacro StartDiamondMonster("ckng","nane","5")
        call DestroyGroup(group1)
        call DestroyGroup(group2)
        set group1 = null
        set group2 = null
    endfunction
//---------------------------------------------------------------------------------------------------
    /*
        根据死亡单位类型去掉落相对应的宝石
    */
    private function MonsterDropDiamond takes nothing returns boolean
        local integer i = 1
            if ((GetUnitTypeId(GetDyingUnit()) == 'nnmg')) then
                loop
                    exitwhen i > CModeH(1,2) * I3(JJ2,3,1)
                        call CreateItem( 'I02N', GetUnitX(GetDyingUnit()),GetUnitY(GetDyingUnit()) )
                        set i = i + 1
                endloop
                return true
            elseif ((GetUnitTypeId(GetDyingUnit()) == 'nmyr')) then
                loop
                    exitwhen i > CModeH(1,2) * I3(JJ2,3,1)
                    call CreateItem( 'I04S', GetUnitX(GetDyingUnit()),GetUnitY(GetDyingUnit()) )
                    set i = i + 1
                endloop
                return true
            elseif ((GetUnitTypeId(GetDyingUnit()) == 'nnsw')) then
                loop
                    exitwhen i > CModeH(1,2) * I3(JJ2,3,1)
                    call CreateItem( 'azhr', GetUnitX(GetDyingUnit()),GetUnitY(GetDyingUnit()) )
                    set i = i + 1
                endloop
                return true
            elseif ((GetUnitTypeId(GetDyingUnit()) == 'nsnp')) then
                loop
                    exitwhen i > CModeH(1,2) * I3(JJ2,3,1)
                    call CreateItem( 'gmfr', GetUnitX(GetDyingUnit()),GetUnitY(GetDyingUnit()) )
                    set i = i + 1
                endloop
                return true
            elseif ((GetUnitTypeId(GetDyingUnit()) == 'nhyc')) then
                loop
                    exitwhen i > CModeH(1,2) * I3(JJ2,3,1)
                    call CreateItem( 'jpnt', GetUnitX(GetDyingUnit()),GetUnitY(GetDyingUnit()) )
                    set i = i + 1
                endloop
                return true
            elseif ((GetUnitTypeId(GetDyingUnit()) == 'nnrg')) then
                loop
                    exitwhen i > CModeH(1,2) * I3(JJ2,3,1)
                    call CreateItem( 'glsk', GetUnitX(GetDyingUnit()),GetUnitY(GetDyingUnit()) )
                    set i = i + 1
                endloop
                return true
            elseif ((GetUnitTypeId(GetDyingUnit()) == 'nplb')) then
                loop
                    exitwhen i > CModeH(1,2)
                    call CreateItem( 'kygh', GetUnitX(GetDyingUnit()),GetUnitY(GetDyingUnit()) )
                    set i = i + 1
                endloop
                return true
            elseif ((GetUnitTypeId(GetDyingUnit()) == 'ntrv')) then
                loop
                    exitwhen i > CModeH(1,2)
                    call CreateItem( 'sehr', GetUnitX(GetDyingUnit()),GetUnitY(GetDyingUnit()) )
                    set i = i + 1
                endloop
                return true
            elseif ((GetUnitTypeId(GetDyingUnit()) == 'nmmu')) then
                loop
                    exitwhen i > CModeH(1,2)
                    call CreateItem( 'bzbf', GetUnitX(GetDyingUnit()),GetUnitY(GetDyingUnit()) )
                    set i = i + 1
                endloop
                return true
            elseif ((GetUnitTypeId(GetDyingUnit()) == 'nanb')) then
                loop
                    exitwhen i > CModeH(1,2)
                    call CreateItem( 'thle', GetUnitX(GetDyingUnit()),GetUnitY(GetDyingUnit()) )
                    set i = i + 1
                endloop
                return true
            elseif ((GetUnitTypeId(GetDyingUnit()) == 'nanm')) then
                loop
                    exitwhen i > CModeH(1,2)
                    call CreateItem( 'dkfw', GetUnitX(GetDyingUnit()),GetUnitY(GetDyingUnit()) )
                    set i = i + 1
                endloop
                return true
            elseif ((GetUnitTypeId(GetDyingUnit()) == 'nane')) then
                loop
                    exitwhen i > CModeH(1,2)
                    call CreateItem( 'phlt', GetUnitX(GetDyingUnit()),GetUnitY(GetDyingUnit()) )
                    set i = i + 1
                endloop
                return true
            endif
            set i = i +1
        return false
    endfunction
//---------------------------------------------------------------------------------------------------
    /*
        掉落触发的条件
    */
    function TDropDiamondCon takes nothing returns boolean
        return (GetOwningPlayer(GetDyingUnit()) == Player(10) or GetOwningPlayer(GetDyingUnit()) == Player(11)) and not (IsUnitIllusion(GetDyingUnit()))
    endfunction
    /*
        掉落触发的动作
    */
    function TDropDiamondAct takes nothing returns nothing
        if (((GetUnitTypeId(GetDyingUnit()) == 'nnmg') or (GetUnitTypeId(GetDyingUnit()) == 'nmyr') or (GetUnitTypeId(GetDyingUnit()) == 'nnsw') or (GetUnitTypeId(GetDyingUnit()) == 'nsnp') or (GetUnitTypeId(GetDyingUnit()) == 'nhyc') or (GetUnitTypeId(GetDyingUnit()) == 'nnrg') or (GetUnitTypeId(GetDyingUnit()) == 'nplb') or (GetUnitTypeId(GetDyingUnit()) == 'ntrv') or (GetUnitTypeId(GetDyingUnit()) == 'nmmu') or (GetUnitTypeId(GetDyingUnit()) == 'nanb') or (GetUnitTypeId(GetDyingUnit()) == 'nanm') or (GetUnitTypeId(GetDyingUnit()) == 'nane')) and (GetPlayerController(GetOwningPlayer(GetDyingUnit())) == MAP_CONTROL_COMPUTER)) then
            if (RectContainsUnit(gg_rct________8,GetDyingUnit())) then
                set IAtleast1 = ( IAtleast1 - 1 )
                if ((IAtleast1 == 1)) then
                    set IAtleast1 = 100
                    call MonsterDropDiamond()
                    return
                endif
            elseif (RectContainsUnit(gg_rct_Diamond2,GetDyingUnit())) then
                set IAtleast2 = ( IAtleast2 - 1 )
                if ((IAtleast2 == 1)) then
                    set IAtleast2 = 100
                    call MonsterDropDiamond()
                    return
                endif
            elseif (RectContainsUnit(gg_rct_Diamond3,GetDyingUnit())) then
                set IAtleast3 = ( IAtleast3 - 1 )
                if ((IAtleast3 == 1)) then
                    set IAtleast3 = 100
                    call MonsterDropDiamond()
                    return
                endif
            endif
            if ((GetRandomInt(1, 25) == 1) and not(IsTianyan) and IsInDiamondRegion(GetUnitX(GetDyingUnit()),GetUnitY(GetDyingUnit()))) then
                if (MonsterDropDiamond()) then
                    if (RectContainsUnit(gg_rct________8,GetDyingUnit())) then
                        set IAtleast1 = 100
                    elseif (RectContainsUnit(gg_rct_Diamond2,GetDyingUnit())) then
                        set IAtleast2 = 100
                    elseif (RectContainsUnit(gg_rct_Diamond3,GetDyingUnit())) then
                        set IAtleast3 = 100
                    endif
                endif
            endif
        endif
    endfunction
//---------------------------------------------------------------------------------------------------
    /*
        清空宝石区域
    */
    function ClearDiamondRegion takes rect r returns nothing
        local unit l_unit = null
        local group group2 = YDWEGetUnitsInRectMatchingNull(r, Condition(function DiamondMonsterFilter))
        set group2 = YDWEGetUnitsInRectMatchingNull(r, Condition(function DiamondMonsterFilter))
        loop
            set l_unit = FirstOfGroup(group2)
            exitwhen l_unit == null
            call GroupRemoveUnit(group2, l_unit)
            call FlushChildHashtable(YDHT,GetHandleId(l_unit))
            call RemoveUnit( l_unit )
        endloop
        call DestroyGroup( group2 )
        set group2 = null
        set l_unit = null
    endfunction
//---------------------------------------------------------------------------------------------------
    /*
        离开宝石区域
    */
    function TLeaveDiamondRegionCon takes nothing returns boolean
        return ((GetPlayerController(GetOwningPlayer(GetLeavingUnit())) == MAP_CONTROL_USER))
    endfunction
    function TLeaveDiamondRegion1Act takes nothing returns nothing
        local group group1 = YDWEGetUnitsInRectMatchingNull(gg_rct________8, Condition(function DiamondPlayerFilter))
        if ((CountUnitsInGroup(group1) == 0)) then
            call ClearDiamondRegion(gg_rct________8)
        endif
        call DestroyGroup( group1 )
        set group1 = null
    endfunction
    function TLeaveDiamondRegion2Act takes nothing returns nothing
        local group group1 = YDWEGetUnitsInRectMatchingNull(gg_rct_Diamond2, Condition(function DiamondPlayerFilterOther))
        local group group2 = null
        local unit l_unit = null
        if ((CountUnitsInGroup(group1) == 0)) then
            set group2 = YDWEGetUnitsInRectMatchingNull(gg_rct_Diamond2, Condition(function DiamondMonsterFilter))
            loop
                set l_unit = FirstOfGroup(group2)
                exitwhen l_unit == null
                call GroupRemoveUnit(group2, l_unit)
                call FlushChildHashtable(YDHT,GetHandleId(l_unit))
                call RemoveUnit( l_unit )
            endloop
            call DestroyGroup( group2 )
        endif
        call DestroyGroup( group1 )
        set group1 = null
        set group2 = null
        set l_unit = null
    endfunction
    function TLeaveDiamondRegion3Act takes nothing returns nothing
        local group group1 = YDWEGetUnitsInRectMatchingNull(gg_rct_Diamond3, Condition(function DiamondPlayerFilterOther))
        local group group2 = null
        local unit l_unit = null
        if ((CountUnitsInGroup(group1) == 0)) then
            set group2 = YDWEGetUnitsInRectMatchingNull(gg_rct_Diamond3, Condition(function DiamondMonsterFilter))
            loop
                set l_unit = FirstOfGroup(group2)
                exitwhen l_unit == null
                call GroupRemoveUnit(group2, l_unit)
                call FlushChildHashtable(YDHT,GetHandleId(l_unit))
                call RemoveUnit( l_unit )
            endloop
            call DestroyGroup( group2 )
        endif
        call DestroyGroup( group1 )
        set group1 = null
        set group2 = null
        set l_unit = null
    endfunction
//---------------------------------------------------------------------------------------------------
    /*
        宝石对话框
    */
    private function DiamondDialogClick takes nothing returns nothing
        local dialog d = GetClickedDialogBJ()
        local unit u = LoadUnitHandle(LHTable,GetHandleId(d),3)
        if (GetClickedButtonBJ() == LoadButtonHandle(LHTable,GetHandleId(d),1)) then
            call SetUnitX(u,GetRectCenterX(gg_rct_Diamond2))
            call SetUnitY(u,GetRectCenterY(gg_rct_Diamond2))
            call PanCameraToTimedForPlayer(GetOwningPlayer(GetBuyingUnit()),GetRectCenterX(gg_rct_Diamond2),GetRectCenterY(gg_rct_Diamond2),0.2)
            call DestroyEffect( AddSpecialEffect("Abilities\\Spells\\Human\\MassTeleport\\MassTeleportCaster.mdl", GetRectCenterX(gg_rct_Diamond2), GetRectCenterY(gg_rct_Diamond2)))
            call DisplayTextToPlayer( GetOwningPlayer(GetBuyingUnit()), 0, 0, "|cFFFF66CC【消息】|r回去输入“HG”。" )
        endif
        if (GetClickedButtonBJ() == LoadButtonHandle(LHTable,GetHandleId(d),4)) then
            call SetUnitX(u,GetRectCenterX(gg_rct_Diamond3))
            call SetUnitY(u,GetRectCenterY(gg_rct_Diamond3))
            call PanCameraToTimedForPlayer(GetOwningPlayer(GetBuyingUnit()),GetRectCenterX(gg_rct_Diamond3),GetRectCenterY(gg_rct_Diamond3),0.2)
            call DestroyEffect( AddSpecialEffect("Abilities\\Spells\\Human\\MassTeleport\\MassTeleportCaster.mdl", GetRectCenterX(gg_rct_Diamond3), GetRectCenterY(gg_rct_Diamond3)))
            call DisplayTextToPlayer( GetOwningPlayer(GetBuyingUnit()), 0, 0, "|cFFFF66CC【消息】|r回去输入“HG”。" )
        endif
        if (GetClickedButtonBJ() == LoadButtonHandle(LHTable,GetHandleId(d),2)) then
            call SetUnitX(u,GetRectCenterX(gg_rct________8))
            call SetUnitY(u,GetRectCenterY(gg_rct________8))
            call PanCameraToTimedForPlayer(GetOwningPlayer(GetBuyingUnit()),GetRectCenterX(gg_rct________8),GetRectCenterY(gg_rct________8),0.2)
            call DestroyEffect( AddSpecialEffect("Abilities\\Spells\\Human\\MassTeleport\\MassTeleportCaster.mdl", GetRectCenterX(gg_rct________8), GetRectCenterY(gg_rct________8)))
            call DisplayTextToPlayer( GetOwningPlayer(GetBuyingUnit()), 0, 0, "|cFFFF66CC【消息】|r回去输入“HG”。" )
        endif
        call FlushChildHashtable(LHTable,GetHandleId(d))
        call DialogDisplay( GetOwningPlayer(u), d, false )
        call DialogClear(d)
        call DialogDestroy(d)
        set d = null
        set u = null
        call DestroyTrigger(GetTriggeringTrigger())
    endfunction
    function CreateDiamondDialog takes unit u returns nothing
        local trigger t = CreateTrigger()
        local dialog d = DialogCreate()
        call DialogSetMessage( d, "请选择进入的宝石区" )
        call SaveButtonHandle(LHTable,GetHandleId(d),1,DialogAddButtonBJ( d, "低级宝石区1（次）"))
        call SaveButtonHandle(LHTable,GetHandleId(d),4,DialogAddButtonBJ( d, "低级宝石区2（次）"))
        call SaveButtonHandle(LHTable,GetHandleId(d),2,DialogAddButtonBJ( d, "高级宝石区（主）"))
        call SaveUnitHandle(LHTable,GetHandleId(d),3,u)
        call DialogDisplay( GetOwningPlayer(u), d, true )
        call TriggerRegisterDialogEvent( t, d )
        call TriggerAddAction(t, function DiamondDialogClick)
        set d = null
        set t = null
    endfunction
//---------------------------------------------------------------------------------------------------
    /*
        进入宝石区域
    */
    function EnterDiamond takes nothing returns nothing
        if ((GetItemTypeId(GetSoldItem()) == 'rspd')) then
            call CreateDiamondDialog(GetBuyingUnit())
        endif
    endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    宝石初始化
	*/
	private function InitDiamond takes nothing returns nothing
        local trigger t = CreateTrigger()
        call TriggerRegisterAnyUnitEventBJ( t, EVENT_PLAYER_UNIT_SPELL_EFFECT )
        call TriggerAddAction(t, function TSpellDiamondAct)
        //开始刷宝石
        set t = CreateTrigger()
        call TriggerRegisterAnyUnitEventBJ( t, EVENT_PLAYER_UNIT_SELL_ITEM )
        call TriggerAddCondition(t, Condition(function TBuyDiamondStartCon))
        call TriggerAddAction(t, function TBuyDiamondStartAct)
        //宝石怪物掉落
        set t = CreateTrigger()
        call TriggerRegisterAnyUnitEventBJ( t, EVENT_PLAYER_UNIT_DEATH )
        call TriggerAddCondition(t, Condition(function TDropDiamondCon))
        call TriggerAddAction(t, function TDropDiamondAct)
        //宝石区离开事件
        set t = CreateTrigger()
        call YDWETriggerRegisterLeaveRectSimpleNull( t, gg_rct________8 )
        call TriggerAddCondition(t, Condition(function TLeaveDiamondRegionCon))
        call TriggerAddAction(t, function TLeaveDiamondRegion1Act)
        set t = CreateTrigger()
        call YDWETriggerRegisterLeaveRectSimpleNull( t, gg_rct_Diamond2 )
        call TriggerAddCondition(t, Condition(function TLeaveDiamondRegionCon))
        call TriggerAddAction(t, function TLeaveDiamondRegion2Act)
        set t = CreateTrigger()
        call YDWETriggerRegisterLeaveRectSimpleNull( t, gg_rct_Diamond3 )
        call TriggerAddCondition(t, Condition(function TLeaveDiamondRegionCon))
        call TriggerAddAction(t, function TLeaveDiamondRegion3Act)
        set t = null
	endfunction
endlibrary
// 属性加成
// 导入基地有关
/*
    基地有关,不能A队友
*/
library_once CenterBase initializer InitCenterBase requires LHBase,Version
	globals
		trigger TCenterBaseDeath = null
	endglobals
//---------------------------------------------------------------------------------------------------
	/*
		A基地的处死
	*/
	private function TAttackCenterBaseCon takes nothing returns boolean
		return ((IsUnitType(GetAttackedUnitBJ(), UNIT_TYPE_STRUCTURE) == true) and (GetOwningPlayer(GetAttackedUnitBJ()) == Player(6)) and (IsUnitAlly(GetAttacker(), Player(6)) == true))
	endfunction
	private function TAttackCenterBaseAct takes nothing returns nothing
			call IssueImmediateOrder(GetAttacker(),"stop")
			call KillSelf(GetAttacker())
			call DisplayTimedTextToForce( GetPlayersAll(), 30, "|cFFFF66CC【提示】|r有人企图攻打自己的基地，被伟大的Crainax处死了。" )
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    基础爆了的触发
	*/
	//开启防护罩
	private function Kaiqifanghuzhao takes nothing returns nothing
		local real x = GetUnitX(gg_unit_haro_0030)
		local real y = GetUnitY(gg_unit_haro_0030)
		debug local player p = GetSuperLiujiewang()
	    set udg_I_Er_diansi[1] = ( udg_I_Er_diansi[1] - 1 )
	    debug if (p == null) then
		    call DisplayTextToForce( GetPlayersAll(), "|cFFFF66CC【提示】|r防护罩开启，还剩下" + I2S(udg_I_Er_diansi[1]) + "次的防护罩。" )
		    call DisplayTextToForce( GetPlayersAll(), "|cFFFF66CC【提示】|r防护罩开启，还剩下" + I2S(udg_I_Er_diansi[1]) + "次的防护罩。" )
		    call DisplayTextToForce( GetPlayersAll(), "|cFFFF66CC【提示】|r防护罩开启，还剩下" + I2S(udg_I_Er_diansi[1]) + "次的防护罩。" )
		    call DisplayTextToForce( GetPlayersAll(), "|cFFFF66CC【提示】|r防护罩开启，还剩下" + I2S(udg_I_Er_diansi[1]) + "次的防护罩。" )
		    call DisplayTextToForce( GetPlayersAll(), "|cFFFF66CC【提示】|r防护罩开启，还剩下" + I2S(udg_I_Er_diansi[1]) + "次的防护罩。" )
		debug else
		debug call DisplayTextToForce( GetPlayersAll(), ( "|cFFFF66CC【提示】|r" + GetPlayerName(p) + "你作为一个超级六界王竟然让防护罩开启了!仅剩" + ( I2S(udg_I_Er_diansi[1]) + "次防护罩!!!" ) ) )
		debug call DisplayTextToForce( GetPlayersAll(), ( "|cFFFF66CC【提示】|r" + GetPlayerName(p) + "你作为一个超级六界王竟然让防护罩开启了!仅剩" + ( I2S(udg_I_Er_diansi[1]) + "次防护罩!!!" ) ) )
		debug call DisplayTextToForce( GetPlayersAll(), ( "|cFFFF66CC【提示】|r" + GetPlayerName(p) + "你作为一个超级六界王竟然让防护罩开启了!仅剩" + ( I2S(udg_I_Er_diansi[1]) + "次防护罩!!!" ) ) )
		debug call DisplayTextToForce( GetPlayersAll(), ( "|cFFFF66CC【提示】|r" + GetPlayerName(p) + "你作为一个超级六界王竟然让防护罩开启了!仅剩" + ( I2S(udg_I_Er_diansi[1]) + "次防护罩!!!" ) ) )
		debug call DisplayTextToForce( GetPlayersAll(), ( "|cFFFF66CC【提示】|r" + GetPlayerName(p) + "你作为一个超级六界王竟然让防护罩开启了!仅剩" + ( I2S(udg_I_Er_diansi[1]) + "次防护罩!!!" ) ) )
	    debug endif
	    call PlaySoundBJ( gg_snd_kill_boss )
	    call RemoveUnit(gg_unit_haro_0030)
	    set gg_unit_haro_0030 = CreateUnit(Player(6),'haro',x,y,270)
	    call TriggerRegisterUnitEvent( TCenterBaseDeath, gg_unit_haro_0030, EVENT_UNIT_DEATH )
    	call TriggerRegisterUnitEvent( gg_trg____________________035, gg_unit_haro_0030, EVENT_UNIT_DAMAGED )
	    call UnitAddAbility(gg_unit_haro_0030,'Avul')
	    call YDWEPolledWaitNull(30.00)
	    call UnitRemoveAbility(gg_unit_haro_0030,'Avul')
	    call DisplayTextToForce( GetPlayersAll(), "|cFFFF66CC【提示】|r防护罩消失。" )
	    call DisplayTextToForce( GetPlayersAll(), "|cFFFF66CC【提示】|r防护罩消失。" )
	    call DisplayTextToForce( GetPlayersAll(), "|cFFFF66CC【提示】|r防护罩消失。" )
	    call DisplayTextToForce( GetPlayersAll(), "|cFFFF66CC【提示】|r防护罩消失。" )
	    call DisplayTextToForce( GetPlayersAll(), "|cFFFF66CC【提示】|r防护罩消失。" )
	endfunction
	function TCenterBaseDeathAct takes nothing returns nothing
	    if (udg_I_Er_diansi[1] > 0) then
	    	//开启防护罩
	    	call Kaiqifanghuzhao()
	    else
	    	//游戏失败
			call Jidibaozha("
	    		圣光宝石破碎，五界坠入了深渊……
				轮回之狱玩家交流群:413359254
				(开黑、攻略，一应俱全)
")
	    endif
	endfunction
//---------------------------------------------------------------------------------------------------
	private function InitCenterBase takes nothing returns nothing
		local trigger t = CreateTrigger()
		call TriggerRegisterAnyUnitEventBJ(t,EVENT_PLAYER_UNIT_ATTACKED)
		call TriggerAddCondition(t, Condition(function TAttackCenterBaseCon))
		call TriggerAddAction(t, function TAttackCenterBaseAct)
	    set TCenterBaseDeath = CreateTrigger()
	    call TriggerRegisterUnitEvent( TCenterBaseDeath, gg_unit_haro_0030, EVENT_UNIT_DEATH )
	    call TriggerAddAction(TCenterBaseDeath, function TCenterBaseDeathAct)
		set t = null
	endfunction
endlibrary
// 物品技能
///#include  "edit/Continous.j"
library_once Shen requires LHBase,Attr
//---------------------------------------------------------------------------------------------------
	/*
	   神器召唤精灵
	*/
	//清除精灵
	private function ClearJingling takes nothing returns nothing
		call FlushChildHashtable(YDHT,GetHandleId(GetEnumUnit()))
	    call RemoveUnit( GetEnumUnit() )
	endfunction
	function SummonJingling takes item i,unit caster returns nothing
		local integer attack = 0
		local integer defense = 0
		local integer hp = 0
		local integer unitType = 0
		local integer itemType = GetItemTypeId(i)
		local unit u = null
		local string s = null
		local group g = null
		//单位类型
		if (((itemType == 'tlum') or (itemType == 'ICS1') or (itemType == 'I04W'))) then
        	set s = "Objects\\Spawnmodels\\Undead\\UDeathMedium\\UDeath.mdl"
        	set unitType = 'nehy'
		elseif (itemType == 'I04Z' or itemType == 'nflg' or itemType == 'esaz' or itemType == 'sksh' or itemType == 'oslo' or itemType == 'grsl' or itemType == 'flag' ) then
        	set s = "Abilities\\Spells\\Undead\\RaiseSkeletonWarrior\\RaiseSkeleton.mdl"
        	set unitType = 'nbal'
		elseif (itemType == 'I056' or itemType == 'spre' or itemType == 'asbl' or itemType == 'ocor' or itemType == 'blba' or itemType == 'cosl' or itemType == 'shhn') then
        	set s = "Abilities\\Spells\\Human\\Resurrect\\ResurrectTarget.mdl"
        	set unitType = 'nvde'
		elseif (itemType == 'I057' or itemType == 'fwss' or itemType == 'ram4' or itemType == 'rat3' or itemType == 'pams' or itemType == 'jdrn' or itemType == 'shcw') then
        	set s = "Objects\\Spawnmodels\\Naga\\NagaDeath\\NagaDeath.mdl"
        	set unitType = 'hwat'
		elseif (itemType == 'I050' or itemType == 'uflg' or itemType == 'ram3' or itemType == 'stre' or itemType == 'shrs' or itemType == 'kgal' or itemType == 'shtm') then
        	set s = "Abilities\\Spells\\Other\\Doom\\DoomDeath.mdl"
        	set unitType = 'nlv3'
		elseif (itemType == 'I055' or itemType == 'tgxp' or itemType == 'ram2' or itemType == 'lure' or itemType == 'thdm' or itemType == 'arsh' or itemType == 'srtl') then
        	set s = "war3mapImported\\OrbitalRay.mdl"
        	set unitType = 'nsll'
		elseif (itemType == 'I03Y' or itemType == 'dust' or itemType == 'ram1' or itemType == 'rots' or itemType == 'tmmt' or itemType == 'brag' or itemType == 'olig') then
        	set s = "Abilities\\Spells\\NightElf\\Starfall\\StarfallCaster.mdl"
        	set unitType = 'ehpr'
		elseif (itemType == 'tbar') then
        	set s = "Objects\\Spawnmodels\\Naga\\NagaDeath\\NagaDeath.mdl"
        	set unitType = 'nitp'
		elseif (itemType == 'ccmd') then
        	set s = "war3mapImported\\OrbitalRay.mdl"
        	set unitType = 'nadr'
		elseif (itemType == 'iwbr') then
        	set s = "Abilities\\Spells\\Human\\Resurrect\\ResurrectTarget.mdl"
        	set unitType = 'nsgg'
		elseif (itemType == 'I07F' or itemType == 'I07E') then
        	set s = "Abilities\\Spells\\Undead\\DeathCoil\\DeathCoilSpecialArt.mdl"
        	set unitType = 'nbzd'
		endif
		//属性
		if (itemType == 'I04Z' or itemType == 'I056' or itemType == 'I057' or itemType == 'I050' or itemType == 'I055' or itemType == 'I03Y') then
	        set attack = 10000
	    elseif (itemType == 'nflg' or itemType == 'spre' or itemType == 'fwss' or itemType == 'uflg' or itemType == 'tgxp' or itemType == 'dust') then
	        set attack = 300000
	        set defense = 200
	        set hp = 1000000
	    elseif (itemType == 'esaz' or itemType == 'asbl' or itemType == 'ram4' or itemType == 'ram3' or itemType == 'ram2' or itemType == 'ram1') then
	        set attack = 750000
	        set defense = 500
	        set hp = 2500000
	    elseif (itemType == 'sksh' or itemType == 'ocor' or itemType == 'rat3' or itemType == 'stre' or itemType == 'lure' or itemType == 'rots') then
	        set attack = 1200000
	        set defense = 750
	        set hp = 4000000
	    elseif (itemType == 'oslo' or itemType == 'blba' or itemType == 'pams' or itemType == 'shrs' or itemType == 'thdm' or itemType == 'tmmt') then
	        set attack = 1800000
	        set defense = 1000
	        set hp = 6000000
	    elseif (itemType == 'grsl' or itemType == 'cosl' or itemType == 'jdrn' or itemType == 'kgal' or itemType == 'arsh' or itemType == 'brag') then
	        set attack = 2800000
	        set defense = 1500
	        set hp = 10000000
	    elseif (itemType == 'flag' or itemType == 'shhn' or itemType == 'shcw' or itemType == 'shtm' or itemType == 'srtl' or itemType == 'olig') then
	        set attack = 5000000
	        set defense = 2000
	        set hp = 15000000
	    endif
	    //暗的等级
	    if (itemType == 'nflg') then
	        call SetUnitAbilityLevelSwapped( 'ANpi', u, 2 )
	    elseif (itemType == 'esaz') then
	        call SetUnitAbilityLevelSwapped( 'ANpi', u, 3 )
	    elseif (itemType == 'sksh') then
	        call SetUnitAbilityLevelSwapped( 'ANpi', u, 4 )
	    elseif (itemType == 'oslo') then
	        call SetUnitAbilityLevelSwapped( 'ANpi', u, 5 )
	    elseif (itemType == 'grsl') then
	        call SetUnitAbilityLevelSwapped( 'ANpi', u, 6 )
	    elseif (itemType == 'flag') then
	        call SetUnitAbilityLevelSwapped( 'ANpi', u, 7 )
	    endif
		if (unitType != 0) then
		    set g = YDWEGetUnitsOfPlayerAndTypeIdNull(GetOwningPlayer(GetTriggerUnit()), unitType)
		    call ForGroupBJ( g, function ClearJingling )
		    call DestroyGroup( g )
		    set u = CreateUnit(GetOwningPlayer(caster),unitType,GetUnitX(caster),GetUnitY(caster),0)
			if (s != null) then
		    	call DestroyEffect(AddSpecialEffect(s, GetUnitX(u),GetUnitY(u) ))
		    endif
		endif
		if (attack != 0) then
			call SetAttack(u,attack)
		endif
		if (defense != 0) then
			call SetDefense(u,defense)
		endif
		if (hp != 0) then
			call SetHP(u,hp)
		endif
	    set s = null
	    set u = null
	    set g = null
	endfunction
endlibrary
/*
    湮灭
*/
library_once Yanmie requires SpellBase,Spin,Aura,Printer
	globals
		private group GShadow = null
		constant integer ICountShadowMAX = 3
		private integer Ilingyu = 0
		private integer Ishuaxinyifu = 0
		//trigger
		private trigger TSpellYanmie2 = null
		private trigger TSpellYanmie = null
		//雷神
		private real RYingyueX = 0.
		private real RYingyueY = 0.
		private timer TYingyue = null
		private unit UShijie = null
		private integer IYingyue = 0
		private boolean BYingyue = false
		boolean BFanzhuanYM = false
		//轰鸣
		private real RHongmingX = 0.
		private real RHongmingY = 0.
		private timer THongming = null
	endglobals
//---------------------------------------------------------------------------------------------------
	/*
	    马甲伤害
	*/
	private function CreateEffect1 takes real x,real y returns nothing
		local integer i = 1
	    call CreateUnitEffect(GetOwningPlayer(yanmie),'h00C',x,y,0)
		call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Human\\Thunderclap\\ThunderClapCaster.mdl", x, y ))
		loop
			exitwhen i > 6
			call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Human\\Thunderclap\\ThunderClapCaster.mdl", YDWECoordinateX(x + 600 * CosBJ(i*60)), YDWECoordinateY(y + 600 * SinBJ(i*60)) ))
	   		call CreateUnitEffect(GetOwningPlayer(yanmie),'h00C', YDWECoordinateX(x + 600 * CosBJ(i*60)), YDWECoordinateY(y + 600 * SinBJ(i*60)),0)
	   		set i = i+ 1
		endloop
	endfunction
	function SimulateDamageYanmie takes unit u returns boolean
		//雷神残影50%伤害
		if (GetUnitTypeId(u) == 'h010') then
			call UnitDamageTarget( yanmie, GetTriggerUnit(), GetDamageAgi(yanmie) * 0.4, false, true, ATTACK_TYPE_CHAOS, DAMAGE_TYPE_POISON, WEAPON_TYPE_WHOKNOWS )
			return true
		elseif (GetUnitTypeId(u) == 'h02M') then
				call UnitDamageTarget( yanmie, GetTriggerUnit(), GetDamageAgi(yanmie) * 0.3 * R3(GetUnitUserData(u) == 1,2.5,1), false, true, ATTACK_TYPE_CHAOS, DAMAGE_TYPE_POISON, WEAPON_TYPE_WHOKNOWS )
			return true
		endif
		return false
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    雷神领域
	*/
	function CountYanmieLingyu takes nothing returns nothing
		if (BJuexing2[GetConvertedPlayerId(GetOwningPlayer(yanmie))]) then
			set Ilingyu = Ilingyu + 1
			if (Ilingyu >= 30) then
	   			call CreateSpellTextTag("雷神领域",yanmie,0,50,100,2)
 				call SimulateSpell(yanmie,yanmie,'A0HV',1,5,"stomp",false,true,false)
				set Ilingyu = 0
			endif
		endif
		if (BJuexing3[GetConvertedPlayerId(GetOwningPlayer(yanmie))]) then
			set Ishuaxinyifu = Ishuaxinyifu + 1
			if (Ishuaxinyifu >= 200) then
	   			call CreateSpellTextTag("雷神免疫",yanmie,50,0,100,2)
	   			call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Human\\Resurrect\\ResurrectTarget.mdl", GetUnitX(yanmie), GetUnitY(yanmie) ))
	   			set udg_Yifu[GetConvertedPlayerId(GetOwningPlayer(yanmie))] = false
				set Ishuaxinyifu = 0
			endif
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    雷神之速
	*/
	function LeishenzhisuCon takes nothing returns boolean
		return ((GetAttackedUnitBJ() == yanmie) and (IsUnitIllusionBJ(GetAttackedUnitBJ()) != true) and (GetUnitStateSwap(UNIT_STATE_MANA, yanmie) > 200.00))
	endfunction
	function LeishenZhisu takes nothing returns nothing
		local real damage = GetDamageAgi(yanmie) * 0.25
		local integer i = 1
		local real x = GetUnitX(yanmie)
		local real y = GetUnitY(yanmie)
		call PrintSpell(GetOwningPlayer(yanmie),GetAbilityName('AEev'),damage)
		call DamageArea(yanmie,GetUnitX(yanmie),GetUnitY(yanmie),1800, damage)
		call DisableTrigger(GetTriggeringTrigger())
		loop
			exitwhen i > 6
			call DestroyEffect(AddSpecialEffect("war3mapImported\\OrbitalRay.mdx", YDWECoordinateX(x + 300 * CosBJ(i*60)), YDWECoordinateY(y + 300 * SinBJ(i*60)) ))
			set i = i + 1
		endloop
		set i = 1
		loop
			exitwhen i > 12
			call DestroyEffect(AddSpecialEffect("war3mapImported\\OrbitalRay.mdx", YDWECoordinateX(x + 900 * CosBJ(i*30)), YDWECoordinateY(y + 900 * SinBJ(i*30)) ))
			set i = i + 1
		endloop
		set i = 1
		loop
			exitwhen i > 18
			call DestroyEffect(AddSpecialEffect("war3mapImported\\OrbitalRay.mdx", YDWECoordinateX(x + 1500 * CosBJ(i*20)), YDWECoordinateY(y + 1500 * SinBJ(i*20)) ))
			set i = i + 1
		endloop
		call YDWEPolledWaitNull(5)
		call EnableTrigger(GetTriggeringTrigger())
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    雷神残影
	*/
	function BoltShadow takes real x,real y returns nothing
		local unit u
		if not (IsFourthSpellOK(yanmie) and GetUnitAbilityLevel(yanmie,'AHab') == 1 and GetUnitState(yanmie,UNIT_STATE_MANA) >= 600) then
				return
			endif
		if (CountUnitsInGroup(GShadow) >= ICountShadowMAX) then
			return
		endif
		set u = CreateUnit(GetOwningPlayer(yanmie),'h010',x,y,GetRandomReal(0,360))
	    call CreateSpellTextTag("影",u,100,100,0,2)
		call UnitApplyTimedLifeBJ( 4.00, 'BHwe',u )
		call GroupAddUnit(GShadow,u)
		set u = null
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    马甲的死亡事件：移除单位组
	*/
	function SimulateDeathYanmie takes unit u returns nothing
		if (IsUnitInGroup(u,GShadow)) then
			call GroupAddUnit(GShadow,u)
		elseif (GetUnitTypeId(u) == 'h02M' and GetUnitUserData(u) == 1) then
			set IYingyue = IYingyue + 1
			call DestroyEffect(AddSpecialEffect("war3mapImported\\OrbitalRay.mdx", GetUnitX(u),GetUnitY(u) ))
			if (IYingyue >= 10 and UShijie != null) then
				call CreateEffect1(GetUnitX(UShijie),GetUnitY(UShijie))
				call DamageArea(yanmie,GetUnitX(UShijie), GetUnitY(UShijie),1800,GetDamageAgi(yanmie) * 2)
				set IYingyue = 0
			endif
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
 	    雷神之怒
	*/
	function Leishenzhinu takes nothing returns nothing
		local real time = GetUnitDistance(yanmie,GetAttacker())
		local real x = GetUnitX(GetAttacker())
		local real y = GetUnitY(GetAttacker())
		local unit u = CreateUnit(GetOwningPlayer(yanmie),'h000',GetUnitX(yanmie),GetUnitY(yanmie),0)
        call UnitApplyTimedLifeBJ( 5.00, 'BHwe',u )
        call UnitAddAbilityBJ( 'A0N8',u )
        call IssuePointOrder(u,"clusterrockets",x,y)
        set u = null
		if (time >= 1800) then
			return
		endif
		call DisableTrigger(GetTriggeringTrigger())
 		call YDWEPolledWaitNull(time/1200)
		call DamageArea(yanmie,x,y,600, GetDamageAgi(yanmie) * 0.2)
	    call PrintSpell(GetOwningPlayer(yanmie),GetAbilityName('A0NA'),GetDamageAgi(yanmie) * 0.2)
		call YDWEPolledWaitNull(2)
		call EnableTrigger(GetTriggeringTrigger())
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
		雷神影跃
	*/
	private function DestroyYueying takes nothing returns nothing
		call UnitRemoveAbility(yanmie,'Avul')
		set BYingyue = false
		set RYingyueX = 0.
		set RYingyueY = 0.
		call PauseTimer(TYingyue)
		call DestroyTimer(TYingyue)
		set TYingyue = null
	endfunction
	private function LeishenyueyingTimer takes nothing returns nothing
		local integer i = LoadInteger(spellTable,GetHandleId(TYingyue),1)
		local real facing = GetFacingBetweenXY(GetUnitX(yanmie),GetUnitY(yanmie),RYingyueX,RYingyueY)
		local unit u = null
		call SaveInteger(spellTable,GetHandleId(TYingyue),1,i + 1)
		if (ModuloInteger(i,3) == 0) then
			set u = CreateUnit(GetOwningPlayer(yanmie),'h02M',GetUnitX(yanmie),GetUnitY(yanmie),GetUnitFacing(yanmie))
			call UnitApplyTimedLifeBJ( 3.00, 'BHwe', u)
		endif
		if (IsUnitDeadBJ(yanmie)) then
			call DestroyYueying()
		endif
		if (GetDistance(GetUnitX(yanmie),GetUnitY(yanmie),RYingyueX,RYingyueY) > 50.) then
			call SetUnitX(yanmie,GetUnitX(yanmie)+ CosBJ(facing) * 50.)
			call SetUnitY(yanmie,GetUnitY(yanmie)+ SinBJ(facing) * 50.)
		else
			call DestroyYueying()
		endif
		if (UShijie != null) then
			if (GetUnitDistance(UShijie,yanmie) > 1200) then
				if (BYingyue) then
					call UnitRemoveAbility(yanmie,'Avul')
					set BYingyue = false
				endif
			else
				if not(BYingyue) then
					set BYingyue = true
					call UnitAddAbility(yanmie,'Avul')
				endif
				if (u != null) then
					call SetUnitUserData(u,1)
				endif
			endif
		endif
	endfunction
	function Leishenyueying takes nothing returns nothing
		set RYingyueX = GetOrderPointX()
		set RYingyueY = GetOrderPointY()
		if (TYingyue == null) then
			set TYingyue = CreateTimer()
			call SaveInteger(spellTable,GetHandleId(TYingyue),1,0)
			call TimerStart(TYingyue,0.04,true,function LeishenyueyingTimer)
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    雷神视界
	*/
	private function LeishenshijieTimer takes nothing returns nothing
		local timer t = GetExpiredTimer()
		if (IsUnitAliveBJ(UShijie)) then
			call SimulateSpell(yanmie,UShijie,'A0N9',1,5,"stomp",false,true,false)
		else
			if (BYingyue) then
				call UnitRemoveAbility(yanmie,'Avul')
				set BYingyue = false
			endif
			set UShijie = null
			call PauseTimer(t)
			call DestroyTimer(t)
		endif
		set t = null
	endfunction
	private function Leishenshijie takes nothing returns nothing
		local integer i = GetHeroLevel(xinglong)
		set UShijie = CreateUnit(GetOwningPlayer(yanmie),'h02N',GetSpellTargetX(),GetSpellTargetY(),0)
		call UnitApplyTimedLifeBJ( 15, 'BHwe',UShijie )
        call PlaySoundBJ(gg_snd_yanmie_5)
		call PrintSpellName(GetOwningPlayer(yanmie),GetAbilityName(GetSpellAbilityId()))
		call TimerStart(CreateTimer(),2,true,function LeishenshijieTimer)
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    雷神轰鸣
	*/
	private function Leishenhongming takes nothing returns nothing
		local real radius = GetRandomReal(0,900)
		local real degree = GetRandomReal(0,360)
		local real x = YDWECoordinateX(RHongmingX + radius * CosBJ(degree))
		local real y = YDWECoordinateX(RHongmingY + radius * SinBJ(degree))
		if (IsUnitAliveBJ(yanmie)) then
			call DamageArea(yanmie,x,y,450, GetDamageAgi(yanmie) * 0.4)
		    call CreateUnitEffect(GetOwningPlayer(yanmie),'h00C',x,y,0)
			call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Human\\Thunderclap\\ThunderClapCaster.mdl", x, y ))
		else
			call PauseTimer(THongming)
			call DestroyTimer(THongming)
			set THongming = null
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    主英雄使用技能
	*/
	private function TSpellYanmieAct takes nothing returns nothing
		if (GetSpellAbilityId() == 'AHbz') then
			//雷神轰鸣
			if (THongming != null) then
				call PauseTimer(THongming)
				call DestroyTimer(THongming)
				set THongming = null
			endif
		    set RHongmingX = GetSpellTargetX()
		    set RHongmingY = GetSpellTargetY()
		    set THongming = CreateTimer()
		    call TimerStart(THongming,0.5,true,function Leishenhongming)
		    call PlaySoundBJ( gg_snd_yanmie_5 )
	        call PrintSpellName(GetOwningPlayer(yanmie),GetAbilityName(GetSpellAbilityId()))
		elseif (GetSpellAbilityId() == 'A0NC') then
			call Leishenshijie()
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	//按照12345来判断
	function LearnSkillYanmieI takes unit learner,integer whichSpell returns nothing
		local integer i
		if (learner == yanmie) then
			if (whichSpell == 2 and IsSecondSpellOK(yanmie) and (GetUnitAbilityLevel(yanmie,'AEev') == 1) ) then
				//技能2初始化
			    set TSpellYanmie2 = CreateTrigger()
			    call TriggerRegisterAnyUnitEventBJ( TSpellYanmie2, EVENT_PLAYER_UNIT_ATTACKED )
			    call TriggerAddCondition(TSpellYanmie2, Condition(function LeishenzhisuCon))
			    call TriggerAddAction(TSpellYanmie2, function LeishenZhisu)
			elseif (whichSpell == 2 and IsSecondSpellOK(yanmie) and (GetUnitAbilityLevel(yanmie,'A0NA') == 1) ) then
				//技能2(反)初始化
			    set TSpellYanmie2 = CreateTrigger()
			    call TriggerRegisterAnyUnitEventBJ( TSpellYanmie2, EVENT_PLAYER_UNIT_ATTACKED )
			    call TriggerAddCondition(TSpellYanmie2, Condition(function LeishenzhisuCon))
			    call TriggerAddAction(TSpellYanmie2, function Leishenzhinu)
			elseif (whichSpell == 3 and IsThirdSpellOK(yanmie) and GetUnitAbilityLevel(yanmie,'AHbh') == 1) then
				//技能3初始化
				call AddSpecialEffectTargetUnitBJ("origin",yanmie,"war3mapImported\\etherealaura.mdx")
				call InitYanmieAura()
			elseif (whichSpell == 4 and IsFourthSpellOK(yanmie) and GetUnitAbilityLevel(yanmie,'AHab') == 1) then
				//技能4初始化
				set GShadow = CreateGroup()
		        call EnableTrigger( gg_trg_____________3 )
		        call EnableTrigger( gg_trg_____________5 )
			elseif (whichSpell == 4 and IsFourthSpellOK(yanmie) and GetUnitAbilityLevel(yanmie,'A0NB') == 1) then
				//技能4初始化
		        call EnableTrigger( gg_trg_____________3 )
		        call EnableTrigger( gg_trg_____________5 )
			endif
		endif
	endfunction
	function LearnSkillYanmie takes unit learner,integer learnSpellID returns nothing
		if (learner == yanmie) then
			if (learnSpellID == 'AEev' or learnSpellID == 'A0NA') then
				call LearnSkillYanmieI(learner,2)
			elseif (learnSpellID == 'AHbh') then
				call LearnSkillYanmieI(learner,3)
			elseif (learnSpellID == 'AHab' or learnSpellID == 'A0NB') then
				call LearnSkillYanmieI(learner,4)
			endif
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    初始化反转形态
	*/
	function InitFanzhuanYanmie takes nothing returns nothing
		call UnitAddAbility(yanmie,'A0ND')
		call SetPlayerAbilityAvailable(GetOwningPlayer(yanmie),'A0ND',false)
		call BJDebugMsg("|cFFFF66CC【消息】|r"+GetPlayerName(GetOwningPlayer(yanmie))+"变化了英雄|cFFFFCC66湮灭|r的技能形态!")
		call BJDebugMsg("|cFFFF66CC【消息】|r"+GetPlayerName(GetOwningPlayer(yanmie))+"变化了英雄|cFFFFCC66湮灭|r的技能形态!")
		call BJDebugMsg("|cFFFF66CC【消息】|r"+GetPlayerName(GetOwningPlayer(yanmie))+"变化了英雄|cFFFFCC66湮灭|r的技能形态!")
		call BJDebugMsg("|cFFFF66CC【消息】|r"+GetPlayerName(GetOwningPlayer(yanmie))+"变化了英雄|cFFFFCC66湮灭|r的技能形态!")
		set BFanzhuanYM = true
		call CinematicFadeBJ( bj_CINEFADETYPE_FADEOUTIN, 3.00, "ReplaceableTextures\\CameraMasks\\White_mask.blp", 100.00, 0, 0, 0 )
		call PlaySoundBJ( gg_snd_fanzhuan )
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    初始化皮肤
	*/
	function InitYanmieSpin takes unit u returns unit
		if (IsYanmieSpin1(GetOwningPlayer(u))) then
			set udg_H[GetConvertedPlayerId(GetOwningPlayer(u))] = CreateUnit(GetOwningPlayer(u),'E00F',GetUnitX(u),GetUnitY(u),0)
			set gg_unit_Eevi_0020 = udg_H[GetConvertedPlayerId(GetOwningPlayer(u))]
			call SetUnitManaPercentBJ(udg_H[GetConvertedPlayerId(GetOwningPlayer(u))],100)
			call UnitAddItemByIdSwapped('I006', udg_H[GetConvertedPlayerId(GetOwningPlayer(u))])
			call AddSpellPercent(GetConvertedPlayerId(GetOwningPlayer(u)),0.1)
			call RemoveUnit(u)
			return udg_H[GetConvertedPlayerId(GetOwningPlayer(u))]
		else
			return u
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    初始化湮灭
	*/
	function InitYanmie takes unit u returns nothing
		set yanmie = InitYanmieSpin(u)
	    call TriggerRegisterUnitEvent( gg_trg_____________3, yanmie, EVENT_UNIT_ISSUED_POINT_ORDER )
		set TSpellYanmie = CreateTrigger()
	    call TriggerRegisterUnitEvent(TSpellYanmie,yanmie,EVENT_UNIT_SPELL_EFFECT)
	    call TriggerAddAction(TSpellYanmie, function TSpellYanmieAct)
	    debug if (DzAPI_Map_GetMapLevel(GetOwningPlayer(yanmie)) >= 3 or IsPIV(GetOwningPlayer(yanmie))) then
	    	call CreateFanzhuanItem(yanmie)
	    debug endif
	endfunction
endlibrary
library_once Kaisa requires SpellBase,Printer,Spin,Aura
	globals
		private trigger TSpellKaisa = null
		private integer INiuSpinCount = 0
		boolean BFanzhuanKS = false
		//天地裂变
		boolean BLiebian = false
		private timer TLiebian = null
		private integer ILiebian = 0
		private real RLiebianX = 0.
		private real RLiebianY = 0.
		private effect ELiebian = null
		private real RDistanceLiebian = 0.
		private TextTagBind TTBLiebian = 0
		//图腾
		private group GTuteng = null
	endglobals
//---------------------------------------------------------------------------------------------------
	/*
	     这个是凯撒伤害
	*/
	private function CreateEffect1 takes real x,real y returns nothing
		local integer i = 1
		loop
		    exitwhen i > 6
		    call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Human\\Thunderclap\\ThunderClapCaster.mdl", YDWECoordinateX(x + 400 * CosBJ(i*360.0/(6))), YDWECoordinateY(y + 400 * SinBJ(i*360.0/(6))) ))
		    set i = i +1
		endloop
	endfunction
	function SimulateDamageKaisa takes unit u returns boolean
		//小牛头的伤害
		if (GetUnitTypeId(u) == 'h02R') then
			call CreateEffect1(GetUnitX(u),GetUnitY(u))
			call DamageArea(kaisa,GetUnitX(u),GetUnitY(u),600,GetDamageStr(kaisa)*0.4)
			if (GetRandomInt(1,7) == 1) then
				call CreateSpellTextTag("地震",u,0,100,50,3)
				call SimulateSpell(u,GetTriggerUnit(),'A0NP',1/*level*/,6/*time*/,"stomp",false/*point*/,true/*immediately*/,false/*unit*/)
			endif
			return true
		endif
		return false
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    马甲的死亡事件
	*/
	function SimulateDeathKaisa takes unit u returns nothing
		if (GetUnitTypeId(u) == 'h02R') then
			call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\NightElf\\BattleRoar\\RoarCaster.mdl", GetUnitX(u),GetUnitY(u) ))
            call FlushChildHashtable(YDHT,GetHandleId(u))
            call RemoveUnit( u )
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    天地裂变
	*/
	private function DestroyLiebianTimer takes nothing returns nothing
		call PauseTimer(TLiebian)
		call DestroyTimer(TLiebian)
		set TLiebian = null
		call SetUnitScalePercent( kaisa, 100.00 , 100.00, 100.00 )
		call TTBLiebian.destroy()
		set ILiebian = 0
		set BLiebian = false
		set RLiebianX = 0.
		set RLiebianY = 0.
		set RDistanceLiebian = 0.
		call DestroyEffect(ELiebian)
	endfunction
	private function TiandiliebianTimer takes nothing returns nothing
		if (IsUnitAliveBJ(kaisa) and BLiebian) then
    		set ILiebian = IMinBJ(800,ILiebian + 1)
			call TTBLiebian.setContent(I2S(ILiebian/4)+"%")
    		call SetUnitScalePercent( kaisa, 100.00 + 0.25 * ILiebian , 100.00 + 0.25 * ILiebian, 100.00 + 0.25 * ILiebian )
    		if (RLiebianX != GetUnitX(kaisa) or RLiebianY != GetUnitY(kaisa)) then
	    		set RDistanceLiebian = RDistanceLiebian + GetDistance(RLiebianX,RLiebianY,GetUnitX(kaisa),GetUnitY(kaisa))
	    		set RLiebianX = GetUnitX(kaisa)
	    		set RLiebianY = GetUnitY(kaisa)
	    		if (RDistanceLiebian >= 250.0) then
	    			call DamageArea(kaisa,GetUnitX(kaisa),GetUnitY(kaisa),450.0,GetDamageStr(kaisa)*0.01*I2R(ILiebian) * 0.25)
	    			call DestroyEffect(AddSpecialEffect("war3mapImported\\longj2.mdl",GetUnitX(kaisa),GetUnitY(kaisa) ))
	    			set RDistanceLiebian = 0.0
	    		endif
    		endif
    	else
    		call DestroyLiebianTimer()
		endif
	endfunction
	function Tiandiliebian takes nothing returns nothing
		if (TLiebian == null) then
			set TLiebian = CreateTimer()
			call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\NightElf\\BattleRoar\\RoarCaster.mdl", GetUnitX(kaisa),GetUnitY(kaisa)))
			call TimerStart(TLiebian,0.1,true,function TiandiliebianTimer)
			set ILiebian = 0
			set BLiebian = true
			set TTBLiebian = TextTagBind.create(kaisa,35,35)
			set ELiebian = AddSpecialEffectTargetUnitBJ("chest",kaisa,"war3mapImported\\DefenceMatrix.mdl")
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    天灵冲撞
	*/
	private function CreateEffect2 takes real x,real y returns nothing
		local integer i = 1
		loop
		    exitwhen i > 6
		    call DestroyEffect(AddSpecialEffect("Objects\\Spawnmodels\\Other\\NeutralBuildingExplosion\\NeutralBuildingExplosion.mdl", YDWECoordinateX(x + 300 * CosBJ(i*360.0/(6))), YDWECoordinateY(y + 300 * SinBJ(i*360.0/(6))) ))
		    set i = i +1
		endloop
	endfunction
	private function ChongzhuangTimer takes nothing returns nothing
	    local timer t = GetExpiredTimer()
	    local integer id = GetHandleId(t)
	    //i是速度
	    local integer i = LoadInteger(spellTable,id,1)
		local real facing = LoadReal(spellTable,GetHandleId(t),2)
		local group temp = GetEnemyGroup(GetOwningPlayer(kaisa),GetUnitX(kaisa),GetUnitY(kaisa),400)
		local real xp = GetUnitX(kaisa)+ CosBJ(facing) * I2R(i)
		local real yp = GetUnitY(kaisa)+ SinBJ(facing) * I2R(i)
		//判断数量
	    if (CountUnitsInGroup(temp) == 0 and xp < yd_MapMaxX and xp > yd_MapMinX and yp < yd_MapMaxY and yp > yd_MapMinY) then
	    	//速度加快
	        set i = i + 2
	        call SaveInteger(spellTable,GetHandleId(t),1,i)
			call SetUnitX(kaisa,xp)
			call SetUnitY(kaisa,yp)
	    else
	    	//伤害：每2秒加100%？
	    	call DamageArea(kaisa,GetUnitX(kaisa),GetUnitY(kaisa),600,GetDamageStr(kaisa)*(R2I(i)/30.0))
	    	call CreateEffect2(GetUnitX(kaisa),GetUnitY(kaisa))
	    	call PrintSpell(GetOwningPlayer(kaisa),GetAbilityName('A0NQ'),GetDamageStr(kaisa)*(R2I(i)/30.0))
	    	call SimulateSpell(kaisa,kaisa,'A0NN',i/100/*level*/,6/*time*/,"stomp",false/*point*/,true/*immediately*/,false/*unit*/)
	    	call PauseUnit(kaisa,false)
	    	call UnitRemoveAbility(kaisa,'Avul')
	        call PauseTimer(t)
	        call FlushChildHashtable(spellTable,id)
	        call DestroyTimer(t)
			call SetUnitTimeScale(kaisa,3.00)
	    endif
	    call DestroyGroup(temp)
	    set temp = null
	    set t = null
	endfunction
	function Tianlingchongzhuang takes nothing returns nothing
		local real facing = GetFacingBetweenXY(GetUnitX(kaisa),GetUnitY(kaisa),GetSpellTargetX(),GetSpellTargetY())
		local timer t = CreateTimer()
		call PauseUnit(kaisa,true)
		call UnitAddAbility(kaisa,'Avul')
		call SetUnitFacing(kaisa,facing)
		call SaveInteger(spellTable,GetHandleId(t),1,20)
		call SaveReal(spellTable,GetHandleId(t),2,facing)
		call TimerStart(t,0.05,true,function ChongzhuangTimer)
		call SetUnitAnimationByIndex( kaisa, 3 )
		call SetUnitTimeScale(kaisa,3.00)
		set t = null
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    万荒图腾
	*/
	private function CreateXiaoNiutou takes unit u,real lifeTime returns nothing
		local real x = YDWECoordinateX(GetUnitX(u) + GetRandomReal(-600.0,600.0))
		local real y = YDWECoordinateY(GetUnitY(u) + GetRandomReal(-600.0,600.0))
    	local unit temp = CreateUnit(GetOwningPlayer(u),'h02R',x,y,0)
		call DestroyEffect(AddSpecialEffect("war3mapImported\\LionSong.mdx", x,y ))
    	call UnitApplyTimedLifeBJ( lifeTime, 'BHwe',temp )
    	set temp = null
	endfunction
	private function PeriodicCreateNiutou takes nothing returns nothing
	    local timer t = GetExpiredTimer()
	    local integer id = GetHandleId(t)
		local unit u = LoadUnitHandle(spellTable,GetHandleId(t),1)
	    if (IsUnitAliveBJ(u)) then
	    	call CreateXiaoNiutou(u,5.0)
	    else
	        call PauseTimer(t)
	        call FlushChildHashtable(spellTable,id)
	        call DestroyTimer(t)
	    endif
	    set t = null
	endfunction
	private function TimerCreateNiutou takes unit u returns nothing
		local timer t = CreateTimer()
		call SaveUnitHandle(spellTable,GetHandleId(t),1,u)
		call TimerStart(t,5,true,function PeriodicCreateNiutou)
		set t = null
	endfunction
	function Tuteng takes nothing returns nothing
		local unit u = null
		if (BFanzhuanKS and IsFifthSpellOK(kaisa) and GetUnitAbilityLevel(kaisa,'A0NO') == 1) then
			if (CountUnitsInGroup(GTuteng) > 2) then
				set u = FirstOfGroup(GTuteng)
				call DestroyEffect(AddSpecialEffect("war3mapImported\\LionSong.mdx", GetUnitX(u),GetUnitY(u) ))
				call GroupRemoveUnit(GTuteng,u)
				call RemoveUnit(u)
			endif
			set u = CreateUnit(GetOwningPlayer(kaisa),'h02S',GetUnitX(kaisa),GetUnitY(kaisa),0)
			call DestroyEffect(AddSpecialEffect("war3mapImported\\LionSong.mdx", GetUnitX(u),GetUnitY(u) ))
			call GroupAddUnit(GTuteng,u)
			call TimerCreateNiutou(u)
	    	call PrintSpellName(GetOwningPlayer(kaisa),GetAbilityName('A0NO'))
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    图腾的主动效果
	*/
	private function Wanhuangtuteng takes nothing returns nothing
		local group l_group2 = CreateGroup()
		local unit l_unit = null
		call GroupAddGroup(GTuteng,l_group2)
		loop
		    set l_unit = FirstOfGroup(l_group2)
		    exitwhen l_unit == null
		    call GroupRemoveUnit(l_group2, l_unit)
		    call CreateXiaoNiutou(l_unit,15.0)
		    call CreateXiaoNiutou(l_unit,15.0)
		    call CreateXiaoNiutou(l_unit,15.0)
		endloop
		call DestroyGroup(l_group2)
		set l_group2 = null
		set l_unit =null
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    皮肤条件
	*/
	function CountKaisa takes unit u returns nothing
		if not (GetKaisaSpin(GetOwningPlayer(kaisa))) then
			if not(IsUnitAliveBJ(u)) then
				set INiuSpinCount = INiuSpinCount + 1
				if (ModuloInteger(INiuSpinCount,100) == 0) then
					call DisplayTextToPlayer(GetOwningPlayer(kaisa), 0., 0., "【|cFF6699FF熔日煌世|r】完成进度"+I2S(INiuSpinCount)+"/2500.")
				endif
				debug if (INiuSpinCount >= 2500) then
					debug call SetKaisaSpinOK(GetOwningPlayer(kaisa))
				debug endif
			endif
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    三阶觉醒
	*/
	function KaisaSanjiejuxing takes nothing returns nothing
		if (BJuexing3[GetConvertedPlayerId(GetOwningPlayer(kaisa))]) then
			call SetUnitManaPercentBJ(kaisa,100)
			call ImmuteDamageInterval(kaisa,3)
			call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Human\\Resurrect\\ResurrectCaster.mdl", GetUnitX(seyu), GetUnitY(seyu) ))
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    炼血一击
	*/
	private function Lianxueyiji takes nothing returns nothing
		local unit target = GetSpellTargetUnit()
	    local real facing = Atan2BJ(GetUnitY(target)-GetUnitY(kaisa),GetUnitX(target)-GetUnitX(kaisa))
		local real damage = (GetUnitState(kaisa,UNIT_STATE_LIFE ) / 500.0) * SquareRoot(I2R(GetHeroLevel(kaisa))) * GetUnitState(kaisa,UNIT_STATE_MANA )
	    local integer i = 1
	    call PrintSpell(GetOwningPlayer(kaisa),GetAbilityName(GetSpellAbilityId()),damage)
	    loop
	    	exitwhen i > 6
       		call DestroyEffect( AddSpecialEffect("Objects\\Spawnmodels\\Other\\NeutralBuildingExplosion\\NeutralBuildingExplosion.mdl", YDWECoordinateX(GetUnitX(kaisa) + 300.00 * I2R(i) * CosBJ(facing) ), YDWECoordinateY(GetUnitY(kaisa) + 300.00 * I2R(i) * SinBJ(facing) )) )
	    	set i = i +1
	    endloop
	    call UnitDamageTarget( kaisa, target, damage, false, true, ATTACK_TYPE_MAGIC, DAMAGE_TYPE_MAGIC, WEAPON_TYPE_WHOKNOWS )
	    call SetUnitManaPercentBJ(kaisa,1)
	    call SetUnitLifePercentBJ(kaisa,1)
	    set target = null
	endfunction
//---------------------------------------------------------------------------------------------------
	//按照12345来判断
	function LearnSkillKaisaI takes unit learner,integer whichSpell returns nothing
		local integer i = 0
		if (learner == kaisa) then
			if (whichSpell == 3 and IsThirdSpellOK(kaisa) and GetUnitAbilityLevel(kaisa,'A007') == 1) then
				//忠诚之躯
		        call EnableTrigger( gg_trg_____________17 )
		        call EnableTrigger( gg_trg_____________18 )
			elseif (whichSpell == 3 and IsThirdSpellOK(kaisa) and GetUnitAbilityLevel(kaisa,'A0NR') == 1) then
				//天地裂变
				call InitKaisaAura()
			elseif (whichSpell == 4 and IsFourthSpellOK(kaisa) and GetUnitAbilityLevel(kaisa,'A0B0') == 1) then
				//战栗灵魂
		        call EnableTrigger( gg_trg_____________19 )
		        call EnableTrigger( gg_trg_____________22 )
			elseif (whichSpell == 4 and IsFourthSpellOK(kaisa) and GetUnitAbilityLevel(kaisa,'A0NQ') == 1) then
				//天灵冲撞
		        call EnableTrigger( gg_trg_____________22 )
			endif
		endif
	endfunction
	function LearnSkillKaisa takes unit learner,integer learnSpellID returns nothing
		if (learner == kaisa) then
			if (learnSpellID == 'A007' or learnSpellID == 'A0NR') then
				call LearnSkillKaisaI(learner,3)
			elseif (learnSpellID == 'A0B0' or learnSpellID == 'A0NQ') then
				call LearnSkillKaisaI(learner,4)
			endif
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    主英雄技能判断
	*/
	private function TSpellKaisaAct takes nothing returns nothing
		if (GetSpellAbilityId() == 'AOhx') then
			call Lianxueyiji()
		elseif (GetSpellAbilityId() == 'A0NR') then
			//天地裂变
			call Tiandiliebian()
		elseif (GetSpellAbilityId() == 'A0NQ') then
			//天灵冲撞
			call Tianlingchongzhuang()
		elseif (GetSpellAbilityId() == 'A0NO') then
			//万荒图腾
			call Wanhuangtuteng()
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    初始化反转形态
	*/
	function InitFanzhuanKaisa takes nothing returns nothing
		call UnitAddAbility(kaisa,'A0NM')
		call SetPlayerAbilityAvailable(GetOwningPlayer(kaisa),'A0NM',false)
		call BJDebugMsg("|cFFFF66CC【消息】|r"+GetPlayerName(GetOwningPlayer(kaisa))+"变化了英雄|cffff0000凯撒|r的技能形态!")
		call BJDebugMsg("|cFFFF66CC【消息】|r"+GetPlayerName(GetOwningPlayer(kaisa))+"变化了英雄|cffff0000凯撒|r的技能形态!")
		call BJDebugMsg("|cFFFF66CC【消息】|r"+GetPlayerName(GetOwningPlayer(kaisa))+"变化了英雄|cffff0000凯撒|r的技能形态!")
		call BJDebugMsg("|cFFFF66CC【消息】|r"+GetPlayerName(GetOwningPlayer(kaisa))+"变化了英雄|cffff0000凯撒|r的技能形态!")
		set BFanzhuanKS = true
		call CinematicFadeBJ( bj_CINEFADETYPE_FADEOUTIN, 3.00, "ReplaceableTextures\\CameraMasks\\White_mask.blp", 100.00, 0, 0, 0 )
		call PlaySoundBJ( gg_snd_fanzhuan )
		set GTuteng = CreateGroup()
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    凯撒皮肤
	*/
	private function InitKaisaSpin takes unit u returns unit
		if (IsKaisaSpin1(GetOwningPlayer(u))) then
			set udg_H[GetConvertedPlayerId(GetOwningPlayer(u))] = CreateUnit(GetOwningPlayer(u),'O002',GetUnitX(u),GetUnitY(u),0)
			set gg_unit_Ocbh_0251 = udg_H[GetConvertedPlayerId(GetOwningPlayer(u))]
			call UnitAddItemByIdSwapped('I006', udg_H[GetConvertedPlayerId(GetOwningPlayer(u))])
			call SetUnitManaPercentBJ(udg_H[GetConvertedPlayerId(GetOwningPlayer(u))],1000)
			call RemoveUnit(u)
			return udg_H[GetConvertedPlayerId(GetOwningPlayer(u))]
		else
			return u
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    初始化牛头
	*/
	function InitKaisa takes unit u returns nothing
		set kaisa = InitKaisaSpin(u)
		//主英雄技能
		set TSpellKaisa = CreateTrigger()
	    call TriggerRegisterUnitEvent(TSpellKaisa,kaisa,EVENT_UNIT_SPELL_EFFECT)
	    call TriggerAddAction(TSpellKaisa, function TSpellKaisaAct)
		call TriggerRegisterUnitEvent( gg_trg_____________7, kaisa, EVENT_UNIT_DAMAGED )
	    debug if (DzAPI_Map_GetMapLevel(GetOwningPlayer(kaisa)) >= 3 or IsPIV(GetOwningPlayer(kaisa))) then
	    	call CreateFanzhuanItem(kaisa)
	    debug endif
	endfunction
endlibrary
///#include  "edit/Purgatory.j"
///#include  "edit/Box.j"
/*
    物品技能
*/
library_once ItemSpell initializer InitItemSpell requires LHBase,Attr,SpellBase,Juexing,Boss,Box,Shen,ItemBase,Yanmie,Purgatory,Fanzhuan,Moqi,Kaisa//,Continous
	globals
		boolean array BYaoShuxing
	endglobals
//---------------------------------------------------------------------------------------------------
	/*
	    转移物品
	*/
	private function TransferItemAct takes nothing returns nothing
		call UnitAddItem( udg_H[GetConvertedPlayerId(GetOwningPlayer(GetSpellAbilityUnit()))],GetSpellTargetItem())
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    获取物品
	*/
	private function GetHeroItemClick takes nothing returns nothing
        local dialog d = GetClickedDialogBJ()
        local unit u = LoadUnitHandle(LHTable,GetHandleId(d),8)
        local integer i = 1
        loop
        	exitwhen i > 6
        	if (GetClickedButtonBJ() == LoadButtonHandle(LHTable,GetHandleId(d),i)) then
        		if (UnitItemInSlotBJ(u,i)!= null) then
        			if (not(IsMinganItem(UnitItemInSlotBJ(u,i))) and not(IsZhanfahun(UnitItemInSlotBJ(u,i)) and not(IsItemPawnable(UnitItemInSlotBJ(u,i))))) then
						call UnitAddItem( UDepot[GetConvertedPlayerId(GetOwningPlayer(u))],UnitItemInSlotBJ(u,i))
        			else
        				call DisplayTextToPlayer(GetOwningPlayer(u), 0., 0., "|cFFFF66CC【消息】|r该物品不能移动.")
        			endif
        		endif
        	endif
        	set i = i +1
        endloop
        call FlushChildHashtable(LHTable,GetHandleId(d))
        call DialogDisplay( GetOwningPlayer(u), d, false )
        call DialogClear(d)
        call DialogDestroy(d)
        set d = null
        set u = null
        call DestroyTrigger(GetTriggeringTrigger())
	endfunction
	private function GetHeroItemAct takes nothing returns nothing
        local trigger t = CreateTrigger()
        local unit u = udg_H[GetConvertedPlayerId(GetOwningPlayer(GetTriggerUnit()))]
        local dialog d = DialogCreate()
        call DialogSetMessage( d, "选择你要取走的装备" )
	    call SaveButtonHandle(LHTable,GetHandleId(d),1,DialogAddButton( d, S3(UnitItemInSlotBJ(u,1)!= null,GetItemName(UnitItemInSlotBJ(u,1)),"空") + "|cff00ccff(1)|r",'1'))
	    call SaveButtonHandle(LHTable,GetHandleId(d),2,DialogAddButton( d, S3(UnitItemInSlotBJ(u,2)!= null,GetItemName(UnitItemInSlotBJ(u,2)),"空") + "|cff00ccff(2)|r",'2'))
	    call SaveButtonHandle(LHTable,GetHandleId(d),3,DialogAddButton( d, S3(UnitItemInSlotBJ(u,3)!= null,GetItemName(UnitItemInSlotBJ(u,3)),"空") + "|cff00ccff(3)|r",'3'))
	    call SaveButtonHandle(LHTable,GetHandleId(d),4,DialogAddButton( d, S3(UnitItemInSlotBJ(u,4)!= null,GetItemName(UnitItemInSlotBJ(u,4)),"空") + "|cff00ccff(4)|r",'4'))
	    call SaveButtonHandle(LHTable,GetHandleId(d),5,DialogAddButton( d, S3(UnitItemInSlotBJ(u,5)!= null,GetItemName(UnitItemInSlotBJ(u,5)),"空") + "|cff00ccff(5)|r",'5'))
	    call SaveButtonHandle(LHTable,GetHandleId(d),6,DialogAddButton( d, S3(UnitItemInSlotBJ(u,6)!= null,GetItemName(UnitItemInSlotBJ(u,6)),"空") + "|cff00ccff(6)|r",'6'))
	    call SaveButtonHandle(LHTable,GetHandleId(d),7,DialogAddButton( d, "不传送|cff00ccff(Esc)|r" , 512))
        call SaveUnitHandle(LHTable,GetHandleId(d),8,u)
        call DialogDisplay( GetOwningPlayer(u), d, true )
        call TriggerRegisterDialogEvent( t, d )
        call TriggerAddAction(t, function GetHeroItemClick)
        set d = null
        set t = null
        set u = null
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    点金
	*/
	private function Dianjin takes nothing returns nothing
		local integer i = GetHeroLevel(udg_H[GetConvertedPlayerId(GetOwningPlayer(GetTriggerUnit()))])
	    if ((RectContainsUnit(gg_rct______________084, GetSpellTargetUnit()) == true)) then
	        call DisplayTextToPlayer( GetOwningPlayer(GetTriggerUnit()), 0, 0, "|cFFFF66CC【提示】|r不能对炼狱的怪使用。" )
	        return
	    endif
	    if (IsLoyalUnit(GetSpellTargetUnit())) then
	        call DisplayTextToPlayer( GetOwningPlayer(GetTriggerUnit()), 0, 0, "|cFFFF66CC【提示】|r不能对忠诚单位使用。" )
	        return
	    endif
	    if (i >= GetUnitLevel(GetSpellTargetUnit())) then
	        call SetUnitLifeBJ( GetSpellTargetUnit(), 5.00 )
	        call UnitDamageTarget( GetTriggerUnit(), GetSpellTargetUnit(), GetUnitState(GetSpellTargetUnit(),UNIT_STATE_MAX_LIFE)*10, false, true, ATTACK_TYPE_CHAOS, DAMAGE_TYPE_SLOW_POISON, WEAPON_TYPE_WHOKNOWS )
	        call AdjustPlayerStateBJ( ( GetHeroLevel(GetTriggerUnit()) * 100 ), GetOwningPlayer(GetTriggerUnit()), PLAYER_STATE_RESOURCE_GOLD )
	        call DestroyEffect( AddSpecialEffect("Abilities\\Spells\\Other\\Transmute\\PileofGold.mdl", GetUnitX(GetSpellTargetUnit()), GetUnitY(GetSpellTargetUnit())) )
	    	call CreateSpellTextTag("+" + I2S(( GetHeroLevel(GetTriggerUnit()) * 100 )),GetSpellTargetUnit(),100,100,0,2)
	    else
	        call DisplayTextToPlayer( GetOwningPlayer(GetTriggerUnit()), 0, 0, ( "|cFFFF66CC【提示】|r你的英雄需要" + ( I2S(GetUnitLevel(GetSpellTargetUnit())) + "级才能将该单位直接变成金币。" ) ) )
	    endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    百分比范围伤害
	*/
    function DamageAreaPercent takes unit attacker,real x,real y,real radius,real percent returns nothing
        local group l_group = CreateGroup()
        local unit l_unit
        call GroupEnumUnitsInRange(l_group, x, y, radius, null)
        loop
            set l_unit = FirstOfGroup(l_group)
            exitwhen l_unit == null
            call GroupRemoveUnit(l_group, l_unit)
            if (IsEnemy(l_unit,attacker)) then
                call UnitDamageTarget( attacker, l_unit, GetUnitState(l_unit,UNIT_STATE_MAX_LIFE)*percent, false, true, ATTACK_TYPE_MAGIC, DAMAGE_TYPE_MAGIC, WEAPON_TYPE_WHOKNOWS )
            endif
        endloop
        call DestroyGroup(l_group)
        set l_group = null
        set l_unit =null
    endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    增加20秒的50%属性与100%防御
	*/
	private function AddAttr10SecondTimer takes nothing returns nothing
		local timer t = GetExpiredTimer()
		local integer id = GetHandleId(t)
		local player p = LoadPlayerHandle(spellTable,id,1)
		call AddStrPercentImme(GetConvertedPlayerId(p),-0.5)
		call AddAgiPercentImme(GetConvertedPlayerId(p),-0.5)
		call AddIntPercentImme(GetConvertedPlayerId(p),-0.5)
		call AddDefensePercent(GetConvertedPlayerId(p),-1.)
		set BYaoShuxing[GetConvertedPlayerId(p)] = false
		call PauseTimer(t)
		call FlushChildHashtable(spellTable,id)
		call DestroyTimer(t)
		set p = null
		set t = null
	endfunction
	private function AddAttr10Second takes unit u returns nothing
		local timer t = CreateTimer()
		call AddStrPercentImme(GetConvertedPlayerId(GetOwningPlayer(u)),0.5)
		call AddAgiPercentImme(GetConvertedPlayerId(GetOwningPlayer(u)),0.5)
		call AddIntPercentImme(GetConvertedPlayerId(GetOwningPlayer(u)),0.5)
		call AddDefensePercent(GetConvertedPlayerId(GetOwningPlayer(u)),1.)
		set BYaoShuxing[GetConvertedPlayerId(GetOwningPlayer(u))] = true
		call SavePlayerHandle(spellTable,GetHandleId(t),1,GetOwningPlayer(u))
		call TimerStart(t,20,false,function AddAttr10SecondTimer)
		set t = null
		call YDWEPolledWaitNull(20)
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    倾寒千里
	*/
	function Qinghanqianli takes nothing returns nothing
		local integer i = 1
		local real x = GetUnitX(GetSpellAbilityUnit())
		local real y = GetUnitY(GetSpellAbilityUnit())
		call DestroyEffect(AddSpecialEffect("war3mapImported\\IceStomp.mdx", x, y ))
		loop
			exitwhen i > 6
			call DestroyEffect(AddSpecialEffect("war3mapImported\\IceStomp.mdx", YDWECoordinateX(x + 900 * CosBJ(i*60)), YDWECoordinateY(y + 900 * SinBJ(i*60)) ))
			set i = i + 1
		endloop
 		call SimulateSpell(GetSpellAbilityUnit(),GetSpellAbilityUnit(),'A0BI',5,6,"stomp",false,true,false)
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    物品技能
	*/
	private function ItemSpellJudge takes nothing returns nothing
		//转移物品
		if ((GetSpellAbilityId() == 'A0GT') and (udg_H[GetConvertedPlayerId(GetOwningPlayer(GetSpellAbilityUnit()))] != udg_U_Zhuansheng_Dantiao[1])) then
			call TransferItemAct()
		//仓库回城
		elseif ((GetSpellAbilityId() == 'A0L0')) then
			call HG(UDepot[GetConvertedPlayerId(GetOwningPlayer(GetTriggerUnit()))])
		//到英雄身边
		elseif ((GetSpellAbilityId() == 'A0L3') and (udg_H[GetConvertedPlayerId(GetOwningPlayer(GetSpellAbilityUnit()))] != udg_U_Zhuansheng_Dantiao[1])) then
			call SetUnitX(GetTriggerUnit(),GetUnitX(udg_H[GetConvertedPlayerId(GetOwningPlayer(GetTriggerUnit()))]))
			call SetUnitY(GetTriggerUnit(),GetUnitY(udg_H[GetConvertedPlayerId(GetOwningPlayer(GetTriggerUnit()))]))
		//拿装备
		elseif ((GetSpellAbilityId() == 'A0KZ') and (udg_H[GetConvertedPlayerId(GetOwningPlayer(GetSpellAbilityUnit()))] != udg_U_Zhuansheng_Dantiao[1])) then
			call GetHeroItemAct()
		//点金
		elseif(GetSpellAbilityId() == 'A073') then
			call Dianjin()
		elseif (GetSpellAbilityId() == 'A0KQ') then
			//【地狱】琅玕绘蝉蜕
 			call SimulateSpell(GetSpellAbilityUnit(),GetSpellTargetUnit(),'A0KP',1,5,"faeriefire",false,false,true)
 			call SimulateSpell(GetSpellAbilityUnit(),GetSpellTargetUnit(),'A0KP',1,5,"faeriefire",false,false,true)
 			call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Undead\\DeathPact\\DeathPactTarget.mdl", GetUnitX(GetSpellTargetUnit()), GetUnitY(GetSpellTargetUnit()) ))
		elseif (GetSpellAbilityId() == 'A0KW') then
			call Qinghanqianli()
		debug elseif (GetSpellAbilityId() == 'A0MY') then
		debug call Duihuanjinbi()
		debug elseif (GetSpellAbilityId() == 'A0MZ') then
		debug call DuihuanMucai()
		debug elseif (GetSpellAbilityId() == 'A0N0') then
		debug call Wanwuqiyuan()
		elseif (GetSpellAbilityId() == 'A0MC') then
			call ChangeSpinDialog(GetOwningPlayer(GetTriggerUnit()))
		elseif (GetSpellAbilityId() == 'A0ME') then
			call CreateAchievementDialog(GetOwningPlayer(GetTriggerUnit()))
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    使用物品
	*/
	private function ItemSpellUseJudgeCon takes nothing returns boolean
		return (GetPlayerController(GetOwningPlayer(GetManipulatingUnit())) == MAP_CONTROL_USER)
	endfunction
	private function ItemSpellUseJudge takes nothing returns nothing
		if (GetItemTypeId(GetManipulatedItem()) == 'I05T' or GetItemTypeId(GetManipulatedItem()) == 'I07H') then
			//幽冥项链-凌
			if (GetManipulatingUnit() == udg_H[GetConvertedPlayerId(GetOwningPlayer(GetTriggerUnit()))]) then
				call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Undead\\DeathPact\\DeathPactTarget.mdl", GetUnitX(GetTriggerUnit()), GetUnitY(GetTriggerUnit()) ))
				call AddDamagePercent(GetConvertedPlayerId(GetOwningPlayer(GetTriggerUnit())),1.)
				call YDWEPolledWaitNull(4)
				call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Undead\\DeathPact\\DeathPactTarget.mdl", GetUnitX(GetTriggerUnit()), GetUnitY(GetTriggerUnit()) ))
				call AddDamagePercent(GetConvertedPlayerId(GetOwningPlayer(GetTriggerUnit())),-1.)
			else
				call DisplayTextToPlayer(GetOwningPlayer(GetTriggerUnit()), 0., 0., "|cFFFF66CC【消息】|r该技能需要主英雄施放.")
			endif
		elseif (GetItemTypeId(GetManipulatedItem()) == 'I04Y' or GetItemTypeId(GetManipulatedItem()) == 'I07G') then
			//幽冥项链-亡
			if (GetManipulatingUnit() == udg_H[GetConvertedPlayerId(GetOwningPlayer(GetTriggerUnit()))]) then
				call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Undead\\DeathPact\\DeathPactTarget.mdl", GetUnitX(GetTriggerUnit()), GetUnitY(GetTriggerUnit()) ))
				call AddDamagePercent(GetConvertedPlayerId(GetOwningPlayer(GetTriggerUnit())),1.)
				call YDWEPolledWaitNull(8)
				call DestroyEffect(AddSpecialEffect("Objects\\Spawnmodels\\Undead\\UndeadDissipate\\UndeadDissipate.mdl", GetUnitX(GetTriggerUnit()), GetUnitY(GetTriggerUnit()) ))
				call AddDamagePercent(GetConvertedPlayerId(GetOwningPlayer(GetTriggerUnit())),-1.)
				call KillSelf(GetTriggerUnit())
			else
				call DisplayTextToPlayer(GetOwningPlayer(GetTriggerUnit()), 0., 0., "|cFFFF66CC【消息】|r该技能需要主英雄施放.")
			endif
		elseif (GetItemTypeId(GetManipulatedItem()) == 'I05Y' or GetItemTypeId(GetManipulatedItem()) == 'I07K') then
			//加防御
			if (GetManipulatingUnit() == udg_H[GetConvertedPlayerId(GetOwningPlayer(GetTriggerUnit()))]) then
				call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Undead\\DeathPact\\DeathPactTarget.mdl", GetUnitX(GetTriggerUnit()), GetUnitY(GetTriggerUnit()) ))
				call AddDefensePercent(GetConvertedPlayerId(GetOwningPlayer(GetTriggerUnit())),1.)
				call YDWEPolledWaitNull(10)
				call DestroyEffect(AddSpecialEffect("Objects\\Spawnmodels\\Undead\\UndeadDissipate\\UndeadDissipate.mdl", GetUnitX(GetTriggerUnit()), GetUnitY(GetTriggerUnit()) ))
				call AddDefensePercent(GetConvertedPlayerId(GetOwningPlayer(GetTriggerUnit())),-1.)
			else
				call DisplayTextToPlayer(GetOwningPlayer(GetTriggerUnit()), 0., 0., "|cFFFF66CC【消息】|r该技能需要主英雄施放.")
			endif
		elseif (GetItemTypeId(GetManipulatedItem()) == 'I05Z' or GetItemTypeId(GetManipulatedItem()) == 'I07J') then
			//加属性
			if (GetManipulatingUnit() == udg_H[GetConvertedPlayerId(GetOwningPlayer(GetTriggerUnit()))]) then
				call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Undead\\DeathPact\\DeathPactTarget.mdl", GetUnitX(GetTriggerUnit()), GetUnitY(GetTriggerUnit()) ))
				call AddStrPercentImme(GetConvertedPlayerId(GetOwningPlayer(GetTriggerUnit())),0.5)
				call AddAgiPercentImme(GetConvertedPlayerId(GetOwningPlayer(GetTriggerUnit())),0.5)
				call AddIntPercentImme(GetConvertedPlayerId(GetOwningPlayer(GetTriggerUnit())),0.5)
				call YDWEPolledWaitNull(10)
				call DestroyEffect(AddSpecialEffect("Objects\\Spawnmodels\\Undead\\UndeadDissipate\\UndeadDissipate.mdl", GetUnitX(GetTriggerUnit()), GetUnitY(GetTriggerUnit()) ))
				call AddStrPercentImme(GetConvertedPlayerId(GetOwningPlayer(GetTriggerUnit())),-0.5)
				call AddAgiPercentImme(GetConvertedPlayerId(GetOwningPlayer(GetTriggerUnit())),-0.5)
				call AddIntPercentImme(GetConvertedPlayerId(GetOwningPlayer(GetTriggerUnit())),-0.5)
			else
				call DisplayTextToPlayer(GetOwningPlayer(GetTriggerUnit()), 0., 0., "|cFFFF66CC【消息】|r该技能需要主英雄施放.")
			endif
		elseif (GetItemTypeId(GetManipulatedItem()) == 'I060' or GetItemTypeId(GetManipulatedItem()) == 'I07I') then
			//无敌
			if (GetManipulatingUnit() == udg_H[GetConvertedPlayerId(GetOwningPlayer(GetTriggerUnit()))]) then
				call ImmuteDamageInterval(GetTriggerUnit(),5)
				call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Human\\Resurrect\\ResurrectCaster.mdl", GetUnitX(GetTriggerUnit()), GetUnitY(GetTriggerUnit()) ))
			else
				call DisplayTextToPlayer(GetOwningPlayer(GetTriggerUnit()), 0., 0., "|cFFFF66CC【消息】|r该技能需要主英雄施放.")
			endif
		elseif ((GetItemTypeId(GetManipulatedItem()) == 'I05V' or GetItemTypeId(GetManipulatedItem()) == 'I07L') and GetManipulatingUnit() == udg_H[GetConvertedPlayerId(GetOwningPlayer(GetTriggerUnit()))]) then
			//戒指
			call UnitApplyTimedLifeBJ( 3.00, 'BHwe',CreateUnit(GetOwningPlayer(GetTriggerUnit()),'h01N',GetUnitX(GetTriggerUnit()),GetUnitY(GetTriggerUnit()),GetRandomReal(0,360)) )
		elseif (GetItemTypeId(GetManipulatedItem()) == 'sres') then
			//【地狱】纯粹的天赋
			call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Human\\Resurrect\\ResurrectCaster.mdl", GetUnitX(GetTriggerUnit()), GetUnitY(GetTriggerUnit()) ))
			call AllowTianfu()
			call BJDebugMsg("|cFFFF66CC【消息】|r天赋技能得到了暂时性的解禁.")
		elseif (GetItemTypeId(GetManipulatedItem()) == 'I06A') then
			//【地狱】霓裳之乱舞
			call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Human\\Resurrect\\ResurrectCaster.mdl", GetUnitX(GetTriggerUnit()), GetUnitY(GetTriggerUnit()) ))
			if not(BYaoShuxing[GetConvertedPlayerId(GetOwningPlayer(GetTriggerUnit()))]) then
				call AddAttr10Second(GetTriggerUnit())
			else
				call DisplayTextToPlayer(GetOwningPlayer(GetTriggerUnit()), 0., 0., "|cFFFF66CC【消息】|r你处于属性增加状态,使用失败!")
			endif
		elseif (GetItemTypeId(GetManipulatedItem()) == 'I06B') then
			//【地狱】魄霜与流晶
			call ImmuteDamageInterval(udg_H[GetConvertedPlayerId(GetOwningPlayer(GetTriggerUnit()))],5)
			call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Human\\Resurrect\\ResurrectCaster.mdl", GetUnitX(udg_H[GetConvertedPlayerId(GetOwningPlayer(GetTriggerUnit()))]), GetUnitY(udg_H[GetConvertedPlayerId(GetOwningPlayer(GetTriggerUnit()))]) ))
		elseif (GetItemTypeId(GetManipulatedItem()) == 'I06C') then
			//【地狱】天地共璎珞
			call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Human\\Resurrect\\ResurrectCaster.mdl", GetUnitX(GetTriggerUnit()), GetUnitY(GetTriggerUnit()) ))
			set udg_Paihangbang[GetConvertedPlayerId(GetOwningPlayer(GetTriggerUnit()))] = ( udg_Paihangbang[GetConvertedPlayerId(GetOwningPlayer(GetTriggerUnit()))] + (16000-udg_RENSHU*1000) )
    		call YDWEMultiboardSetItemValueBJNull( udg_D, 5, ( GetConvertedPlayerId(GetOwningPlayer(GetTriggerUnit())) + 1 ), I2S(udg_Paihangbang[GetConvertedPlayerId(GetOwningPlayer(GetTriggerUnit()))]) )
    		call DisplayTextToPlayer(GetOwningPlayer(GetTriggerUnit()), 0., 0., "|cFFFF66CC【消息】|r你的积分成功增加"+I2S(16500-udg_RENSHU*1500))
    	elseif (GetItemTypeId(GetManipulatedItem()) == 'I06O') then
			//【地狱】命运无枷锁
			call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Human\\Resurrect\\ResurrectCaster.mdl", GetUnitX(GetTriggerUnit()), GetUnitY(GetTriggerUnit()) ))
			if (TLifeConnect != null) then
				set BGongxiang = false
	    		call DisplayTextToPlayer(GetOwningPlayer(GetTriggerUnit()), 0., 0., "|cffff0000【消息】解锁生命连结!|r")
	    		call DisplayTextToPlayer(GetOwningPlayer(GetTriggerUnit()), 0., 0., "|cffff0000【消息】解锁生命连结!|r")
	    		call YDWEPolledWaitNull(30)
	    		if (TLifeConnect != null) then
					set BGongxiang = true
				else
					set BGongxiang = false
	    		endif
	    		call DisplayTextToPlayer(GetOwningPlayer(GetTriggerUnit()), 0., 0., "|cffff0000【消息】恢复生命连结!|r")
	    		call DisplayTextToPlayer(GetOwningPlayer(GetTriggerUnit()), 0., 0., "|cffff0000【消息】恢复生命连结!|r")
	    	else
	    		call DisplayTextToPlayer(GetOwningPlayer(GetTriggerUnit()), 0., 0., "|cFFFF66CC【消息】|r现在是非生命连结状态.")
			endif
		elseif (GetItemTypeId(GetManipulatedItem()) == 'I07D') then
			//十二焱炎火
			if (GetItemCharges(GetManipulatedItem()) >= 1) then
				call Yanyanhuo12(GetTriggerUnit())
			else
				call DisplayTextToPlayer(GetOwningPlayer(GetTriggerUnit()), 0., 0., "|cFFFF66CC【消息】|r该物品没有能量,请充能.")
				call SetItemCharges(GetManipulatedItem(),1)
			endif
		elseif (IsShenAll(GetManipulatedItem())) then
			//神器召唤
			call SummonJingling(GetManipulatedItem(),GetTriggerUnit())
		elseif (ChooseBuffColor(GetOwningPlayer(GetTriggerUnit()),GetItemTypeId(GetManipulatedItem()))) then
		elseif (GetItemTypeId(GetManipulatedItem()) == 'I02U') then
			call Xuyuan(GetOwningPlayer(GetTriggerUnit()))
		elseif (GetItemTypeId(GetManipulatedItem()) == 'I07U' and GetTriggerUnit() == yanmie) then
			//湮灭变化
			if (FanzhuanCondition(GetOwningPlayer(GetTriggerUnit()),2)) then
				if (GetHeroLevel(GetTriggerUnit()) > 5) then
					call DisplayTextToPlayer(GetOwningPlayer(GetTriggerUnit()), 0., 0., "|cFFFF66CC【消息】|r请在英雄5级前使用.")
					return
				endif
				call InitFanzhuanYanmie()
				call RemoveItem(GetManipulatedItem())
			else
				call ShowGameHint(GetOwningPlayer(GetTriggerUnit()),GetFanzhuanFailString(GetOwningPlayer(GetTriggerUnit()),2))
			endif
		elseif (GetItemTypeId(GetManipulatedItem()) == 'I032' and GetTriggerUnit() == moqi) then
			//莫琪变化
			if (FanzhuanCondition(GetOwningPlayer(GetTriggerUnit()),3)) then
				if (GetHeroLevel(GetTriggerUnit()) > 5) then
					call DisplayTextToPlayer(GetOwningPlayer(GetTriggerUnit()), 0., 0., "|cFFFF66CC【消息】|r请在英雄5级前使用.")
					return
				endif
				call InitFanzhuanMoqi()
				call RemoveItem(GetManipulatedItem())
			else
				call ShowGameHint(GetOwningPlayer(GetTriggerUnit()),GetFanzhuanFailString(GetOwningPlayer(GetTriggerUnit()),3))
			endif
		elseif (GetItemTypeId(GetManipulatedItem()) == 'I046' and GetTriggerUnit() == kaisa) then
			//凯撒变化
			if (FanzhuanCondition(GetOwningPlayer(GetTriggerUnit()),1)) then
				if (GetHeroLevel(GetTriggerUnit()) > 5) then
					call DisplayTextToPlayer(GetOwningPlayer(GetTriggerUnit()), 0., 0., "|cFFFF66CC【消息】|r请在英雄5级前使用.")
					return
				endif
				call InitFanzhuanKaisa()
				call RemoveItem(GetManipulatedItem())
			else
				call ShowGameHint(GetOwningPlayer(GetTriggerUnit()),GetFanzhuanFailString(GetOwningPlayer(GetTriggerUnit()),1))
			endif
		//debug elseif (GetItemTypeId(GetManipulatedItem()) == 'I07T') then
		//debug 	//月饼
		//debug 	call OpenTheYuebing(GetOwningPlayer(GetTriggerUnit()))
    	//开箱子
		debug elseif(GetItemTypeId(GetManipulatedItem()) == 'I06N') then
			debug call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Other\\Transmute\\PileofGold.mdl",GetUnitX(GetTriggerUnit()),GetUnitY(GetTriggerUnit()) ))
			debug call RemoveItem(GetManipulatedItem())
			debug call GiveJianianhuaGift(GetOwningPlayer(GetTriggerUnit()))
			debug call CreateLoginDialog(GetOwningPlayer(GetTriggerUnit()))
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    魔颤寰宇
	*/
	function Mochanhuanyu takes unit u returns nothing
		local string effs = S3(GetUnitAbilityLevel(u,'A0MT')==1,"Objects\\Spawnmodels\\Undead\\UDeathSmall\\UDeathSmall.mdl","war3mapImported\\DarkNova.mdx")
		call DamageArea(u,GetUnitX(u),GetUnitY(u),400,GetDamageBase(u) * 0.3 * GetUnitAbilityLevel(u,'A0MT'))
		call DestroyEffect(AddSpecialEffect(effs, GetUnitX(u),GetUnitY(u) ))
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    武器伤害引导
	*/
	//单体
	private function ShenAttackEffectDan takes unit u1,unit u2,real damage,string eff,string name,integer red,integer yellow,integer blue returns nothing
        call UnitDamageTarget( u1, u2, damage, false, true, ATTACK_TYPE_MAGIC, DAMAGE_TYPE_MAGIC, WEAPON_TYPE_WHOKNOWS )
        call DestroyEffect(AddSpecialEffect(eff, GetUnitX(u2), GetUnitY(u2) ))
	    call CreateSpellTextTag(name,u1,red,yellow,blue,2)
	endfunction
	//多体
	private function ShenAttackEffectDuo takes unit u1,unit u2,real damage,string eff,string name,integer red,integer yellow,integer blue returns nothing
		call DamageAreaEff(u1,GetUnitX(u2),GetUnitY(u2),400,damage,eff)
	    call CreateSpellTextTag(name,u1,red,yellow,blue,2)
	endfunction
	//伤害引导
	private function ShenAttackEffect takes unit u1,unit u2,integer itemID,boolean dan,real damage,string eff,string name,integer red,integer yellow,integer blue returns boolean
		if (YDWEUnitHasItemOfTypeBJNull(u1, itemID)) then
			if (dan) then
				call ShenAttackEffectDan(u1,u2,damage,eff,name,red,yellow,blue)
			else
				if (itemID =='ICS1' or itemID =='I07F') then
					call DamageAreaPercent(u1,GetUnitX(u2),GetUnitY(u2),400,0.01)
				endif
				call ShenAttackEffectDuo(u1,u2,damage*R3(itemID == 'I04W' or itemID == 'I07E',udg_I_Jinengjiacheng[GetConvertedPlayerId(GetOwningPlayer(u1))],1),eff,name,red,yellow,blue)
			endif
			return true
		endif
		return false
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	   超神器伤害
	*/
	private function TShenAttackCon takes nothing returns boolean
		 return ((GetRandomInt(1, 20) == 1) and (IsUnitType(GetAttackedUnitBJ(), UNIT_TYPE_MAGIC_IMMUNE) != true) and (GetAttackedUnitBJ() != gg_unit_haro_0030) and (IsUnitIllusionBJ(GetAttacker()) != true) and (GetPlayerController(GetOwningPlayer(GetAttacker())) == MAP_CONTROL_USER) and (IsUnitType(GetAttacker(), UNIT_TYPE_HERO) == true))
	endfunction
	private function TShenAttackAct takes nothing returns nothing
		 if (ShenAttackEffect( GetAttacker(),GetAttackedUnitBJ(),'I07F',false,700000000,"Abilities\\Spells\\Other\\Incinerate\\FireLordDeathExplode.mdl","八荒刑罚-贯",100,0,0)) then
		 	return
		 elseif (ShenAttackEffect( GetAttacker(),GetAttackedUnitBJ(),'I07E',false,600000000,"Abilities\\Spells\\Other\\Incinerate\\FireLordDeathExplode.mdl","八荒刑罚-袭",100,0,0)) then
		 	return
		 elseif (ShenAttackEffect( GetAttacker(),GetAttackedUnitBJ(),'ICS1',false,500000000,"Abilities\\Spells\\Orc\\FeralSpirit\\feralspiritdone.mdl","六元幽冥-贯",100,0,0)) then
		 	return
		 elseif (ShenAttackEffect( GetAttacker(),GetAttackedUnitBJ(),'I04W',false,400000000,"Abilities\\Spells\\Orc\\FeralSpirit\\feralspiritdone.mdl","六元幽冥-袭",100,0,0)) then
		 	return
		 elseif (ShenAttackEffect( GetAttacker(),GetAttackedUnitBJ(),'tlum',false,400000000,"Abilities\\Spells\\Orc\\FeralSpirit\\feralspiritdone.mdl","六元幽冥",100,0,0)) then
		 	return
		 elseif (ShenAttackEffect( GetAttacker(),GetAttackedUnitBJ(),'tbar',false,110000000,"Objects\\Spawnmodels\\Undead\\UDeathSmall\\UDeathSmall.mdl","炽焱爆冰",100,0,0)) then
		 	return
		 elseif (ShenAttackEffect( GetAttacker(),GetAttackedUnitBJ(),'ccmd',true,80000000,"Abilities\\Spells\\Demon\\RainOfFire\\RainOfFireTarget.mdl","天外雷星",100,0,100)) then
		 	return
		 elseif (ShenAttackEffect( GetAttacker(),GetAttackedUnitBJ(),'iwbr',false,80000000,"Abilities\\Spells\\Human\\Resurrect\\ResurrectTarget.mdl","驱杀之光",100,100,0)) then
		 	return
		 elseif (ShenAttackEffect( GetAttacker(),GetAttackedUnitBJ(),'shtm',false,35000000,"Abilities\\Spells\\Other\\Doom\\DoomDeath.mdl","炽焰怒灼",100,0,0)) then
		 	return
		 elseif (ShenAttackEffect( GetAttacker(),GetAttackedUnitBJ(),'shcw',false,35000000,"Objects\\Spawnmodels\\Naga\\NagaDeath\\NagaDeath.mdl","海洋唤灭",80,20,100)) then
		 	return
		 elseif (ShenAttackEffect( GetAttacker(),GetAttackedUnitBJ(),'shhn',false,35000000,"Abilities\\Spells\\Human\\HolyBolt\\HolyBoltSpecialArt.mdl","神罚之光",0,100,0)) then
		 	return
		 elseif (ShenAttackEffect( GetAttacker(),GetAttackedUnitBJ(),'flag',true,35000000,"Abilities\\Spells\\Items\\AIso\\AIsoTarget.mdl","鬼魂之手",0,0,0)) then
		 	return
		 elseif (ShenAttackEffect( GetAttacker(),GetAttackedUnitBJ(),'srtl',true,35000000,"war3mapImported\\OrbitalRay.mdl","雷霆之怒",100,100,0)) then
		 	return
		 elseif (ShenAttackEffect( GetAttacker(),GetAttackedUnitBJ(),'olig',true,35000000,"Abilities\\Spells\\NightElf\\Starfall\\StarfallTarget.mdl","陨落星雨",100,20,30)) then
		 	return
		 elseif (ShenAttackEffect( GetAttacker(),GetAttackedUnitBJ(),'kgal',false,25000000,"Abilities\\Spells\\Other\\Doom\\DoomDeath.mdl","炽焰怒灼",100,0,0)) then
		 	return
		 elseif (ShenAttackEffect( GetAttacker(),GetAttackedUnitBJ(),'jdrn',false,25000000,"Objects\\Spawnmodels\\Naga\\NagaDeath\\NagaDeath.mdl","海洋唤灭",80,20,100)) then
		 	return
		 elseif (ShenAttackEffect( GetAttacker(),GetAttackedUnitBJ(),'cosl',false,25000000,"Abilities\\Spells\\Human\\HolyBolt\\HolyBoltSpecialArt.mdl","神罚之光",0,100,0)) then
		 	return
		 elseif (ShenAttackEffect( GetAttacker(),GetAttackedUnitBJ(),'grsl',true,25000000,"Abilities\\Spells\\Items\\AIso\\AIsoTarget.mdl","鬼魂之手",0,0,0)) then
		 	return
		 elseif (ShenAttackEffect( GetAttacker(),GetAttackedUnitBJ(),'arsh',true,25000000,"war3mapImported\\OrbitalRay.mdl","雷霆之怒",100,100,0)) then
		 	return
		 elseif (ShenAttackEffect( GetAttacker(),GetAttackedUnitBJ(),'brag',true,25000000,"Abilities\\Spells\\NightElf\\Starfall\\StarfallTarget.mdl","陨落星雨",100,20,30)) then
		 	return
		 elseif (ShenAttackEffect( GetAttacker(),GetAttackedUnitBJ(),'shrs',false,15000000,"Abilities\\Spells\\Other\\Doom\\DoomDeath.mdl","炽焰怒灼",100,0,0)) then
		 	return
		 elseif (ShenAttackEffect( GetAttacker(),GetAttackedUnitBJ(),'pams',false,15000000,"Objects\\Spawnmodels\\Naga\\NagaDeath\\NagaDeath.mdl","海洋唤灭",80,20,100)) then
		 	return
		 elseif (ShenAttackEffect( GetAttacker(),GetAttackedUnitBJ(),'blba',false,15000000,"Abilities\\Spells\\Human\\HolyBolt\\HolyBoltSpecialArt.mdl","神罚之光",0,100,0)) then
		 	return
		 elseif (ShenAttackEffect( GetAttacker(),GetAttackedUnitBJ(),'oslo',true,15000000,"Abilities\\Spells\\Items\\AIso\\AIsoTarget.mdl","鬼魂之手",0,0,0)) then
		 	return
		 elseif (ShenAttackEffect( GetAttacker(),GetAttackedUnitBJ(),'thdm',true,15000000,"war3mapImported\\OrbitalRay.mdl","雷霆之怒",100,100,0)) then
		 	return
		 elseif (ShenAttackEffect( GetAttacker(),GetAttackedUnitBJ(),'tmmt',true,15000000,"Abilities\\Spells\\NightElf\\Starfall\\StarfallTarget.mdl","陨落星雨",100,20,30)) then
		 	return
		 elseif (ShenAttackEffect( GetAttacker(),GetAttackedUnitBJ(),'stre',false,8000000,"Abilities\\Spells\\Other\\Doom\\DoomDeath.mdl","炽焰怒灼",100,0,0)) then
		 	return
		 elseif (ShenAttackEffect( GetAttacker(),GetAttackedUnitBJ(),'rat3',false,8000000,"Objects\\Spawnmodels\\Naga\\NagaDeath\\NagaDeath.mdl","海洋唤灭",80,20,100)) then
		 	return
		 elseif (ShenAttackEffect( GetAttacker(),GetAttackedUnitBJ(),'ocor',false,8000000,"Abilities\\Spells\\Human\\HolyBolt\\HolyBoltSpecialArt.mdl","神罚之光",0,100,0)) then
		 	return
		 elseif (ShenAttackEffect( GetAttacker(),GetAttackedUnitBJ(),'sksh',true,8000000,"Abilities\\Spells\\Items\\AIso\\AIsoTarget.mdl","鬼魂之手",0,0,0)) then
		 	return
		 elseif (ShenAttackEffect( GetAttacker(),GetAttackedUnitBJ(),'lure',true,8000000,"war3mapImported\\OrbitalRay.mdl","雷霆之怒",100,100,0)) then
		 	return
		 elseif (ShenAttackEffect( GetAttacker(),GetAttackedUnitBJ(),'rots',true,8000000,"Abilities\\Spells\\NightElf\\Starfall\\StarfallTarget.mdl","陨落星雨",100,20,30)) then
		 	return
		 elseif (ShenAttackEffect( GetAttacker(),GetAttackedUnitBJ(),'ram3',false,5000000,"Abilities\\Spells\\Other\\Doom\\DoomDeath.mdl","炽焰怒灼",100,0,0)) then
		 	return
		 elseif (ShenAttackEffect( GetAttacker(),GetAttackedUnitBJ(),'ram4',false,5000000,"Objects\\Spawnmodels\\Naga\\NagaDeath\\NagaDeath.mdl","海洋唤灭",80,20,100)) then
		 	return
		 elseif (ShenAttackEffect( GetAttacker(),GetAttackedUnitBJ(),'asbl',false,5000000,"Abilities\\Spells\\Human\\HolyBolt\\HolyBoltSpecialArt.mdl","神罚之光",0,100,0)) then
		 	return
		 elseif (ShenAttackEffect( GetAttacker(),GetAttackedUnitBJ(),'esaz',true,5000000,"Abilities\\Spells\\Items\\AIso\\AIsoTarget.mdl","鬼魂之手",0,0,0)) then
		 	return
		 elseif (ShenAttackEffect( GetAttacker(),GetAttackedUnitBJ(),'ram2',true,5000000,"war3mapImported\\OrbitalRay.mdl","雷霆之怒",100,100,0)) then
		 	return
		 elseif (ShenAttackEffect( GetAttacker(),GetAttackedUnitBJ(),'ram1',true,5000000,"Abilities\\Spells\\NightElf\\Starfall\\StarfallTarget.mdl","陨落星雨",100,20,30)) then
		 	return
		 elseif (ShenAttackEffect( GetAttacker(),GetAttackedUnitBJ(),'uflg',false,2000000,"Abilities\\Spells\\Other\\Doom\\DoomDeath.mdl","炽焰怒灼",100,0,0)) then
		 	return
		 elseif (ShenAttackEffect( GetAttacker(),GetAttackedUnitBJ(),'fwss',false,2000000,"Objects\\Spawnmodels\\Naga\\NagaDeath\\NagaDeath.mdl","海洋唤灭",80,20,100)) then
		 	return
		 elseif (ShenAttackEffect( GetAttacker(),GetAttackedUnitBJ(),'spre',false,2000000,"Abilities\\Spells\\Human\\HolyBolt\\HolyBoltSpecialArt.mdl","神罚之光",0,100,0)) then
		 	return
		 elseif (ShenAttackEffect( GetAttacker(),GetAttackedUnitBJ(),'nflg',true,2000000,"Abilities\\Spells\\Items\\AIso\\AIsoTarget.mdl","鬼魂之手",0,0,0)) then
		 	return
		 elseif (ShenAttackEffect( GetAttacker(),GetAttackedUnitBJ(),'tgxp',true,2000000,"war3mapImported\\OrbitalRay.mdl","雷霆之怒",100,100,0)) then
		 	return
		 elseif (ShenAttackEffect( GetAttacker(),GetAttackedUnitBJ(),'dust',true,2000000,"Abilities\\Spells\\NightElf\\Starfall\\StarfallTarget.mdl","陨落星雨",100,20,30)) then
		 	return
		 elseif (ShenAttackEffect( GetAttacker(),GetAttackedUnitBJ(),'I050',false,300000,"Abilities\\Spells\\Other\\Doom\\DoomDeath.mdl","炽焰怒灼",100,0,0)) then
		 	return
		 elseif (ShenAttackEffect( GetAttacker(),GetAttackedUnitBJ(),'I057',false,300000,"Objects\\Spawnmodels\\Naga\\NagaDeath\\NagaDeath.mdl","海洋唤灭",80,20,100)) then
		 	return
		 elseif (ShenAttackEffect( GetAttacker(),GetAttackedUnitBJ(),'I056',false,300000,"Abilities\\Spells\\Human\\HolyBolt\\HolyBoltSpecialArt.mdl","神罚之光",0,100,0)) then
		 	return
		 elseif (ShenAttackEffect( GetAttacker(),GetAttackedUnitBJ(),'I04Z',true,300000,"Abilities\\Spells\\Items\\AIso\\AIsoTarget.mdl","鬼魂之手",0,0,0)) then
		 	return
		 elseif (ShenAttackEffect( GetAttacker(),GetAttackedUnitBJ(),'I055',true,300000,"war3mapImported\\OrbitalRay.mdl","雷霆之怒",100,100,0)) then
		 	return
		 elseif (ShenAttackEffect( GetAttacker(),GetAttackedUnitBJ(),'I03Y',true,300000,"Abilities\\Spells\\NightElf\\Starfall\\StarfallTarget.mdl","陨落星雨",100,20,30)) then
		 	return
		 elseif (ShenAttackEffect( GetAttacker(),GetAttackedUnitBJ(),'I03E',false,100000,"Abilities\\Spells\\Other\\Doom\\DoomDeath.mdl","炎爆",100,0,0)) then
		 	return
		 endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    灯神伤害
	*/
	private function TDengAttackCon takes nothing returns boolean
		return (GetRandomInt(1, 20) == 1) and (IsUnitType(GetAttackedUnitBJ(), UNIT_TYPE_MAGIC_IMMUNE) != true) and (IsUnitIllusionBJ(GetAttacker()) != true) and (GetPlayerController(GetOwningPlayer(GetAttacker())) == MAP_CONTROL_USER) and IsUnitType(GetAttacker(), UNIT_TYPE_HERO) and GetDeng(GetAttacker()) >= 7
	endfunction
	private function TDengAttackAct takes nothing returns nothing
		local real x1 = GetUnitX(GetAttacker())
		local real y1 = GetUnitY(GetAttacker())
		local real x2 = GetUnitX(GetAttackedUnitBJ())
		local real y2 = GetUnitY(GetAttackedUnitBJ())
        local unit u = CreateUnit(GetOwningPlayer(GetAttacker()),'h02T',x1,y1,Atan2BJ(y2-y1,x2-x1))
        if (GetUnitTypeId(GetAttacker()) == 'N01Y') then
        	call SetUnitUserData(u,1)
        endif
        call UnitApplyTimedLifeBJ( 3.00, 'BHwe',u )
        call UnitAddAbilityBJ( 'A0HP',u )
        call SetUnitAbilityLevel(u,'A0HP',GetDeng(GetAttacker()) - 6)
        call IssuePointOrder(u,"carrionswarm",x2,y2)
	    call CreateSpellTextTag("贯天照世枪",GetAttacker(),0,100,50,2)
	    set u = null
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    部分召唤物的伤害
	*/
	function SimulateDamageItem takes unit u returns boolean
		if (GetUnitTypeId(u) == 'h01P') then
			call UnitDamageTarget( udg_H[GetConvertedPlayerId(GetOwningPlayer(u))], GetTriggerUnit(), 200000000, false, true, ATTACK_TYPE_CHAOS, DAMAGE_TYPE_SLOW_POISON, WEAPON_TYPE_WHOKNOWS )
			return true
		endif
		if (GetUnitTypeId(u) == 'h02J') then
			call UnitDamageTarget( udg_H[GetConvertedPlayerId(GetOwningPlayer(u))], GetTriggerUnit(), 400000000, false, true, ATTACK_TYPE_CHAOS, DAMAGE_TYPE_SLOW_POISON, WEAPON_TYPE_WHOKNOWS )
			return true
		endif
		if (GetUnitTypeId(u) == 'h01N') then
			call UnitDamageTarget( udg_H[GetConvertedPlayerId(GetOwningPlayer(u))], GetTriggerUnit(), 500000000, false, true, ATTACK_TYPE_MAGIC, DAMAGE_TYPE_MAGIC, WEAPON_TYPE_WHOKNOWS )
			return true
		endif
		if (GetUnitTypeId(u) == 'h01R') then
			call DisableTrigger(GetTriggeringTrigger())
			if (IsUnitType(GetTriggerUnit(), UNIT_TYPE_MAGIC_IMMUNE) and playerName[GetConvertedPlayerId(GetOwningPlayer(GetTriggerUnit()))] != "信哲大人") then
				call UnitDamageTarget( u, GetTriggerUnit(), GetUnitState(GetTriggerUnit(),UNIT_STATE_MAX_LIFE)*2, false, true, ATTACK_TYPE_CHAOS, DAMAGE_TYPE_SLOW_POISON, WEAPON_TYPE_WHOKNOWS )
			else
				call UnitDamageTarget( u, GetTriggerUnit(), GetUnitState(GetTriggerUnit(),UNIT_STATE_MAX_LIFE)*0.1, false, true, ATTACK_TYPE_CHAOS, DAMAGE_TYPE_SLOW_POISON, WEAPON_TYPE_WHOKNOWS )
			endif
			call EnableTrigger(GetTriggeringTrigger())
			return true
		endif
		return false
	endfunction
//---------------------------------------------------------------------------------------------------
	private function InitItemSpell takes nothing returns nothing
		//物品技能触发
		local trigger t = CreateTrigger()
		call TriggerRegisterAnyUnitEventBJ(t,EVENT_PLAYER_UNIT_SPELL_EFFECT)
		call TriggerAddAction(t, function ItemSpellJudge)
		//使用物品
		set t = CreateTrigger()
		call TriggerRegisterAnyUnitEventBJ(t,EVENT_PLAYER_UNIT_USE_ITEM)
		call TriggerAddCondition(t,Condition(function ItemSpellUseJudgeCon))
		call TriggerAddAction(t, function ItemSpellUseJudge)
		//超神器的
	    set t = CreateTrigger()
	    call TriggerRegisterAnyUnitEventBJ( t, EVENT_PLAYER_UNIT_ATTACKED )
	    call TriggerAddCondition(t, Condition(function TShenAttackCon))
	    call TriggerAddAction(t, function TShenAttackAct)
		//灯的攻击被动
	    set t = CreateTrigger()
	    call TriggerRegisterAnyUnitEventBJ( t, EVENT_PLAYER_UNIT_ATTACKED )
	    call TriggerAddCondition(t, Condition(function TDengAttackCon))
	    call TriggerAddAction(t, function TDengAttackAct)
		set t = null
	endfunction
endlibrary
// 翅膀
/*
    翅膀
*/
library_once Wing requires LHBase
	globals
		key kWingDialog1
		key kWingDialog2
		key kWingDialog3
		key kWingDialog4
		key kWingDialog5
		key kWingDialog6
		key kWingUnit
	endglobals
//---------------------------------------------------------------------------------------------------
	/*
	    翅膀点击进入
	*/
	private function WingDialogClick takes nothing returns nothing
	    local dialog d = GetClickedDialogBJ()
	    local unit u = LoadUnitHandle(itemTable,GetHandleId(d),kWingUnit)
	    //! textmacro WingClick takes Region
	        if (GetClickedButtonBJ() == LoadButtonHandle(itemTable,GetHandleId(d),kWingDialog$Region$)) then
	        	call SetUnitX(u,GetRectCenterX(gg_rct____$Region$))
	        	call SetUnitY(u,GetRectCenterY(gg_rct____$Region$))
		        call PanCameraToTimedForPlayer(GetOwningPlayer(GetBuyingUnit()),GetRectCenterX(gg_rct____$Region$),GetRectCenterY(gg_rct____$Region$),0.2)
		        call DestroyEffect( AddSpecialEffect("Abilities\\Spells\\Human\\MassTeleport\\MassTeleportCaster.mdl", GetRectCenterX(gg_rct____$Region$), GetRectCenterY(gg_rct____$Region$)))
		        call DisplayTextToPlayer( GetOwningPlayer(GetBuyingUnit()), 0, 0, "|cFFFF66CC【消息】|r回去输入“HG”。" )
	        endif
	    //! endtextmacro
	    //! runtextmacro WingClick("1")
	    //! runtextmacro WingClick("2")
	    //! runtextmacro WingClick("3")
	    //! runtextmacro WingClick("4")
	    //! runtextmacro WingClick("5")
	    //! runtextmacro WingClick("6")
        call FlushChildHashtable(itemTable,GetHandleId(d))
    	call DialogDisplay( GetOwningPlayer(u), d, false )
        call DialogClear(d)
        call DialogDestroy(d)
        set d = null
        set u = null
        call DestroyTrigger(GetTriggeringTrigger())
	endfunction
	function CreateWingDialog takes unit u returns nothing
	    local trigger t = CreateTrigger()
	    local dialog d = DialogCreate()
	    call DialogSetMessage( d, "请选择进入的翅膀区" )
	    call SaveButtonHandle(itemTable,GetHandleId(d),kWingDialog1,DialogAddButton( d, "翅膀1区",'1'))
	    call SaveButtonHandle(itemTable,GetHandleId(d),kWingDialog2,DialogAddButton( d, "翅膀2区",'2'))
	    call SaveButtonHandle(itemTable,GetHandleId(d),kWingDialog3,DialogAddButton( d, "翅膀3区",'3'))
	    call SaveButtonHandle(itemTable,GetHandleId(d),kWingDialog4,DialogAddButton( d, "翅膀4区",'4'))
	    call SaveButtonHandle(itemTable,GetHandleId(d),kWingDialog5,DialogAddButton( d, "翅膀5区",'5'))
	    call SaveButtonHandle(itemTable,GetHandleId(d),kWingDialog6,DialogAddButton( d, "翅膀6区",'6'))
	    call SaveUnitHandle(itemTable,GetHandleId(d),kWingUnit,u)
	    call DialogDisplay( GetOwningPlayer(u), d, true )
	    call TriggerRegisterDialogEvent( t, d )
	    call TriggerAddAction(t, function WingDialogClick)
	    set d = null
	    set t = null
	endfunction
endlibrary
// 戒指
/*
    戒指
*/
library_once Ring initializer InitRing requires LHBase,Version
	globals
		boolean array BHintRing
	endglobals
//---------------------------------------------------------------------------------------------------
	/*
	    反转提示
	*/
	private function RingSwitch takes nothing returns nothing
		local timer t = GetExpiredTimer()
		local integer id = GetHandleId(t)
		local player p = LoadPlayerHandle(LHTable,id,1)
		set BHintRing[GetConvertedPlayerId(p)] = false
		call PauseTimer(t)
		call FlushChildHashtable(LHTable,id)
		call DestroyTimer(t)
		set p = null
		set t = null
	endfunction
	private function CreateRingTimer takes player p returns nothing
		local timer t = CreateTimer()
		call SavePlayerHandle(LHTable,GetHandleId(t),1,p)
		call TimerStart(t,5,false,function RingSwitch)
		set t = null
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    戒指的升级
	*/
	function TRingUpdateCon takes nothing returns boolean
	    return ((IsUnitEnemy(GetDyingUnit(), GetOwningPlayer(GetKillingUnitBJ()))) and (IsUnitAliveBJ(GetKillingUnitBJ())) and (GetBasicRing(udg_H[GetConvertedPlayerId(GetOwningPlayer(GetKillingUnitBJ()))]) != null or GetBasicRing(UDepot[GetConvertedPlayerId(GetOwningPlayer(GetKillingUnitBJ()))]) != null))
	endfunction
	function TRingUpdateAct takes nothing returns nothing
	    local integer count = GetKillCount(GetDyingUnit())
	    local integer index = GetConvertedPlayerId(GetOwningPlayer(GetKillingUnitBJ()))
	    local item ring = GetBasicRing(udg_H[index])
	    local unit u = udg_H[index]
	    local integer i = 1
	    if (ring == null) then
	    	set ring = GetBasicRing(UDepot[index])
	    	set u = UDepot[index]
	    endif
	    if (ring == null) then
	    	set u = null
	    	return
	    endif
	    call SetItemUserData( ring, GetItemUserData(ring) + count )
		//! textmacro ShuaRing takes CType,NType,Count
		    if (GetItemTypeId(ring) == '$CType$') then
		    	if (GetItemUserData(ring) > $Count$) then
		    		//满了
		    		call RemoveItem(ring)
		    		if ( not(IsUnitAliveBJ(u)) and (u == udg_H[index])) then
		    			//死亡不在身上
		    			call UnitAddItemByIdSwapped( '$NType$', UDepot[index] )
		    			loop
		    				exitwhen i > 6
							call DisplayTextToPlayer( GetOwningPlayer(GetKillingUnitBJ()), 0, 0, "|cFFFF66CC【鬼器】|r由于你处于死亡状态，你成功升级的鬼器转移到了你的仓库里，输入\"-H\"来召唤仓库。" )
		    				set i = i +1
		    			endloop
					else
		    			call UnitAddItemByIdSwapped( '$NType$', u )
		    		endif
		    	else
		    		if not (BHintRing[index]) then
		    			set BHintRing[index] = true
		                call DisplayTextToPlayer( GetOwningPlayer(GetKillingUnitBJ()), 0, 0, ( "|cFFFF66CC【鬼器】|r" + ( I2S(GetItemUserData(ring)) + "/$Count$。" ) ) )
		                call CreateRingTimer(GetOwningPlayer(GetKillingUnitBJ()))
		            endif
		    	endif
		    endif
		//! endtextmacro
		//! runtextmacro ShuaRing("rat9","rlif","600")
		//! runtextmacro ShuaRing("rlif","lgdh","1200")
		//! runtextmacro ShuaRing("lgdh","clfm","1800")
		//! runtextmacro ShuaRing("clfm","bgst","2400")
		//! runtextmacro ShuaRing("bgst","belv","3000")
		//! runtextmacro ShuaRing("belv","hcun","3600")
		//! runtextmacro ShuaRing("hcun","rag1","4200")
		//! runtextmacro ShuaRing("rag1","penr","4800")
		//! runtextmacro ShuaRing("penr","brac","5400")
	    set ring = null
	    set u = null
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    超戒指
	*/
	function TRingMaxCon takes nothing returns boolean
	    return ((IsUnitEnemy(GetDyingUnit(), GetOwningPlayer(GetKillingUnitBJ())) == true) and (IsUnitAliveBJ(GetKillingUnitBJ()) == true) and GetMaxRing(udg_H[GetConvertedPlayerId(GetOwningPlayer(GetKillingUnitBJ()))]) != null)
	endfunction
	function TRingMaxAct takes nothing returns nothing
	    local integer count = GetKillCount(GetDyingUnit())
	    local integer index = GetConvertedPlayerId(GetOwningPlayer(GetKillingUnitBJ()))
	    local item ring = GetMaxRing(udg_H[index])
	    call SetItemUserData( ring, GetItemUserData(ring) + count )
		//! textmacro ShuaRingMax takes CType,Count
		    if (GetItemTypeId(ring) == '$CType$') then
		    	if (GetItemUserData(ring) > 1000) then
		    		call SetItemCharges(ring,GetItemCharges(ring) + 1)
		    		debug call SaveRingAchievement(GetOwningPlayer(GetKillingUnitBJ()),GetItemCharges(ring))
	   				call SetItemUserData( ring, 0 )
					call AddHero3W(udg_H[index],$Count$)
    				call TriggerExecute( gg_trg_papa8____________u )
   					call TriggerExecute( gg_trg_papa10____________u )
    				call TriggerExecute( gg_trg_papa9____________u )
    				call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Human\\Avatar\\AvatarCaster.mdl", GetUnitX(udg_H[index]), GetUnitY(udg_H[index])))
		    	else
		    		if not(BHintRing[index]) then
		    			set BHintRing[index] = true
		                call DisplayTextToPlayer( GetOwningPlayer(GetKillingUnitBJ()), 0, 0, ( "|cFFFF66CC【鬼器】|r" + ( I2S(GetItemUserData(ring)) + "/1000。" ) ) )
		                call CreateRingTimer(GetOwningPlayer(GetKillingUnitBJ()))
		            endif
		    	endif
		    endif
		//! endtextmacro
		//! runtextmacro ShuaRingMax("brac","5000")
		//! runtextmacro ShuaRingMax("I05W","13000")
		//! runtextmacro ShuaRingMax("I05V","10000")
		//! runtextmacro ShuaRingMax("I07M","16000")
		//! runtextmacro ShuaRingMax("I07L","13000")
		//! runtextmacro ShuaRingMax("lhst","10000")
	    set ring = null
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    使用超鬼戒指
	*/
	private function TRingUseCon takes nothing returns boolean
		return IsMaxRing(GetManipulatedItem())
	endfunction
	private function TRingUseAct takes nothing returns nothing
		call SetItemCharges(GetManipulatedItem(), ( GetItemCharges(GetManipulatedItem()) + 1 ))
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    初始化戒指
	*/
	private function InitRing takes nothing returns nothing
		local integer i = 1
	    local trigger t = CreateTrigger()
		loop
			exitwhen i > 6
			if ((GetPlayerSlotState(ConvertedPlayer(i)) == PLAYER_SLOT_STATE_PLAYING) and (GetPlayerController(ConvertedPlayer(i)) == MAP_CONTROL_USER)) then
				set BHintRing[i] = false
			endif
			set i = i +1
		endloop
	    call TriggerRegisterAnyUnitEventBJ( t, EVENT_PLAYER_UNIT_DEATH )
	    call TriggerAddCondition(t, Condition(function TRingUpdateCon))
	    call TriggerAddAction(t, function TRingUpdateAct)
	    set t = CreateTrigger()
	    call TriggerRegisterAnyUnitEventBJ( t, EVENT_PLAYER_UNIT_DEATH )
	    call TriggerAddCondition(t, Condition(function TRingMaxCon))
	    call TriggerAddAction(t, function TRingMaxAct)
	    //使用戒指闪烁后
	    set t = CreateTrigger()
	    call TriggerRegisterAnyUnitEventBJ( t, EVENT_PLAYER_UNIT_USE_ITEM )
	    call TriggerAddCondition(t, Condition(function TRingUseCon))
	    call TriggerAddAction(t, function TRingUseAct)
	    set t = null
	endfunction
endlibrary
// 同类型物品
library_once SameItem initializer InitSameItem requires LHBase,ItemBase
//---------------------------------------------------------------------------------------------------
	/*
	    判断是否是不可共享的物品类型
	*/
	function IsSharedItem takes item i returns boolean
		return GetItemTypeId(i) == 'fgrg' /*
			*/or GetItemTypeId(i) == 'hlst' /*
			*/or GetItemTypeId(i) == 'wshs' /*
			*/or GetItemTypeId(i) == 'wild' /*
			*/or GetItemTypeId(i) == 'totw' /*
			*/or GetItemTypeId(i) == 'sror' /*
			*/or GetItemTypeId(i) == 'olig' /*
			*/or GetItemTypeId(i) == 'srtl' /*
			*/or GetItemTypeId(i) == 'shhn' /*
			*/or GetItemTypeId(i) == 'flag' /*
			*/or GetItemTypeId(i) == 'shcw' /*
			*/or GetItemTypeId(i) == 'shtm' /*
			*/or GetItemTypeId(i) == 'IXU1' /*
			*/or GetItemTypeId(i) == 'I049' /*
			*/or GetItemTypeId(i) == 'I04A' /*
			*/or GetItemTypeId(i) == 'I06N' /*
			*/or GetItemTypeId(i) == 'I07T' /*
			*/or GetItemTypeId(i) == 'I02U'
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    单位的某一格物品栏是否是聚宝
	*/
	private function UnitHasJubaoInSlot takes unit u,integer slot returns boolean
		return GetItemTypeId(UnitItemInSlotBJ(u,slot)) == 'I05P' /*
			*/or GetItemTypeId(UnitItemInSlotBJ(u,slot)) == 'I05Q' /*
			*/or GetItemTypeId(UnitItemInSlotBJ(u,slot)) == 'I05R'
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    只能同时装备一种装备
	*/
	private function OnlyOneZhuangbei takes integer itemID returns nothing
		local integer i = 1
		local integer count = 0
		loop
			exitwhen i > 6
			if(GetItemTypeId(UnitItemInSlotBJ(GetTriggerUnit(),i)) == itemID) then
				set count = count + 1
			endif
			set i = i +1
		endloop
		//如果计数君大于1则丢掉
		if (count > 1) then
			call UnitRemoveItemSwapped(GetManipulatedItem(),GetTriggerUnit())
			call DisplayTextToPlayer(GetOwningPlayer(GetTriggerUnit()),0.,0.,"|cFFFF66CC【消息】|r你只能同时装备一个"+GetItemName(GetManipulatedItem())+"！")
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    只能装备一个人器或者聚宝
	*/
	private function TOnlyOneItemAct takes nothing returns nothing
		local integer i = 1
		local integer count = 0
		//多个人器的判断
		loop
			exitwhen i > 6
			if(IsRen(UnitItemInSlotBJ(GetTriggerUnit(),i))) then
				set count = count + 1
			endif
			set i = i +1
		endloop
		//如果计数君大于1则丢掉
		if (count > 1) then
			call YDWEPolledWaitNull(0.1)
			call UnitRemoveItemSwapped(GetManipulatedItem(),GetTriggerUnit())
			call DisplayTextToPlayer(GetOwningPlayer(GetTriggerUnit()),0.,0.,"|cFFFF66CC【消息】|r你只能同时装备一个人器！")
			return
		endif
		//多个聚宝的判断
		set i = 1
		set count = 0
		loop
			exitwhen i > 6
			if(UnitHasJubaoInSlot(GetTriggerUnit(),i)) then
				set count = count + 1
			endif
			set i = i +1
		endloop
		//如果计数君大于1则丢掉
		if (count > 1) then
			call UnitRemoveItemSwapped(GetManipulatedItem(),GetTriggerUnit())
			call DisplayTextToPlayer(GetOwningPlayer(GetTriggerUnit()),0.,0.,"|cFFFF66CC【消息】|r你只能同时装备一个1级以上的聚宝！")
			return
		endif
		//多个项链的判断
		set i = 1
		set count = 0
		loop
			exitwhen i > 6
			if(IsXianglian(UnitItemInSlotBJ(GetTriggerUnit(),i))) then
				set count = count + 1
			endif
			set i = i +1
		endloop
		//如果计数君大于1则丢掉
		if (count > 1) then
			call UnitRemoveItemSwapped(GetManipulatedItem(),GetTriggerUnit())
			call DisplayTextToPlayer(GetOwningPlayer(GetTriggerUnit()),0.,0.,"|cFFFF66CC【消息】|r你只能同时装备一个项链！")
			return
		endif
		//多个戒指的判断
		set i = 1
		set count = 0
		loop
			exitwhen i > 6
			if(IsGui(UnitItemInSlotBJ(GetTriggerUnit(),i))) then
				set count = count + 1
			endif
			set i = i +1
		endloop
		//如果计数君大于1则丢掉
		if (count > 1) then
			call YDWEPolledWaitNull(0.1)
			call UnitRemoveItemSwapped(GetManipulatedItem(),GetTriggerUnit())
			call DisplayTextToPlayer(GetOwningPlayer(GetTriggerUnit()),0.,0.,"|cFFFF66CC【消息】|r你只能同时装备一个戒指！")
			return
		endif
		call OnlyOneZhuangbei('ratc')
		call OnlyOneZhuangbei('I04L')
		//call OnlyOneZhuangbei('rat6')
	endfunction
	private function TOnlyOneItemCon takes nothing returns boolean
		return (GetManipulatingUnit() == udg_H[GetConvertedPlayerId(GetOwningPlayer(GetManipulatingUnit()))]) and (IsUnitIllusionBJ(GetManipulatingUnit()) != true)
	endfunction
//---------------------------------------------------------------------------------------------------
	private function InitSameItem takes nothing returns nothing
		//人器或者聚宝只能装备一个
		local trigger t = CreateTrigger()
		call TriggerRegisterAnyUnitEventBJ(t,EVENT_PLAYER_UNIT_PICKUP_ITEM)
		call TriggerAddCondition(t,Condition(function TOnlyOneItemCon))
		call TriggerAddAction(t,function TOnlyOneItemAct)
		set t = null
	endfunction
endlibrary
// 皮肤
// 导入英雄
/*
    英雄黑阎的技能
*/
library_once Heiyan requires SpellBase,Printer,Attr,Aura,Spin
	globals
		/*
		    主动技能触发
		*/
		private trigger TSpellHeiyan1 = null
		private trigger TSpellHeiyan00 = null
		private trigger TSpellHeiyan2 = null
		private trigger TSpellHeiyan40 = null
		private trigger TSpellHeiyan41 = null
		/*
		    控制权是魔界
		*/
		private boolean BIsMojie = true
		/*
		    英雄黑阎
		*/
		/*
		    阎罗殿
		*/
		key kUYanluo
		/*
		    葬九天
		*/
		private unit UZangJiuTian = null
		private boolean IsDouble = false
		/*
		    祭品的数量
		*/
		private integer ISacriMaxCount = 6
		/*
		    祭品单位组
		*/
		private group GSacri = null
		/*
		    祭品攻击伤害，每3秒刷新一次数值
		*/
		private real DamageSacri = 0
		//成就死亡值
		private integer ISpinHeiyan = 0
	endglobals
//---------------------------------------------------------------------------------------------------
	/*
	  	次数统计
	*/
	private function SpinTongji takes nothing returns nothing
		if not (GetHeiyan1Spin(GetOwningPlayer(Heiyan))) then
			set ISpinHeiyan = ISpinHeiyan + 1
			if (ModuloInteger(ISpinHeiyan,25) == 0 and ISpinHeiyan > 0) then
				call DisplayTextToPlayer(GetOwningPlayer(Heiyan), 0., 0., "【|cff0000ff七阴之恸|r】完成进度"+I2S(ISpinHeiyan)+"/300.")
			endif
			debug if (ISpinHeiyan >= 300) then
				debug call SetHeiyanSpinOK(GetOwningPlayer(Heiyan))
			debug endif
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    判断祭品是不是满了
	*/
	private function IsFull takes nothing returns boolean
		return CountUnitsInGroup(GSacri) >= ISacriMaxCount
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    创造祭品并无敌
	*/
	private function CreateBasicSacrifice takes real tx, real ty returns nothing
		local unit u
		local real angle
		local real x
		local real y
		local integer i = 3
		if (IsFull()) then
			return
		endif
		if (IsDouble == true) then
			set i = 1
		endif
		loop
			exitwhen i > 3
			set angle = GetRandomReal(0,360)
			set x = YDWECoordinateX(tx + 80 * CosBJ(angle))
			set y = YDWECoordinateY(ty + 80 * SinBJ(angle))
			if (BIsMojie == true) then
				set u = CreateUnit(Player(11),'h012' ,x,y,0)
			else
				set u = CreateUnit(GetOwningPlayer(Heiyan),'h012' ,x,y,0)
			endif
			call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Undead\\RaiseSkeletonWarrior\\RaiseSkeleton.mdl", x, y ))
		    call UnitApplyTimedLifeBJ( 6 + IJ1(Heiyan,3,0) + IJ2(Heiyan,3,0), 'BHwe' , u )
	    	call GroupAddUnit(GSacri,u)
		    set i = i +1
		endloop
		set u =null
	endfunction
	private function CreateSuperSacrifice takes real x, real y returns nothing
		local unit u
		local integer i = 3
		if (IsDouble == true) then
			set i = 1
		endif
		loop
			exitwhen i > 3
			set u = CreateUnit(GetOwningPlayer(Heiyan),'h011' ,x,y,0)
			call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Undead\\RaiseSkeletonWarrior\\RaiseSkeleton.mdl", x, y ))
		    call UnitApplyTimedLifeBJ( 30, 'BHwe' , u )
			set i = i +1
		endloop
		set u =null
	endfunction
	private function CreateSacrifice takes unit creater returns nothing
		call CreateBasicSacrifice(GetUnitX(creater),GetUnitY(creater))
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    祭品攻击伤害的刷新
	*/
	private function SacriDamageFlash takes nothing returns nothing
		set DamageSacri = GetDamageStr(Heiyan) * 0.01
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    祭品的攻击伤害
	*/
	function SimulateDamageHeiyan takes unit u returns boolean
		//祭品的伤害
		if (GetUnitTypeId(u) == 'h012') then
			if (IsUnitEnemy(GetTriggerUnit(),GetOwningPlayer(Heiyan))) then
				call DisableTrigger(GetTriggeringTrigger())
				if (BJuexing3[GetConvertedPlayerId(GetOwningPlayer(Heiyan))]) then
					call UnitDamageTarget( u, GetTriggerUnit(), RMaxBJ(DamageSacri * IJ2(Heiyan,12,IJ1(Heiyan,6,3)),GetUnitState(GetTriggerUnit(),UNIT_STATE_MAX_LIFE)*0.01*0.5), false, true, ATTACK_TYPE_MAGIC, DAMAGE_TYPE_MAGIC, WEAPON_TYPE_WHOKNOWS )
				else
					call UnitDamageTarget( u, GetTriggerUnit(), DamageSacri * IJ2(Heiyan,12,IJ1(Heiyan,6,3)), false, true, ATTACK_TYPE_MAGIC, DAMAGE_TYPE_MAGIC, WEAPON_TYPE_WHOKNOWS )
				endif
				call EnableTrigger(GetTriggeringTrigger())
			else
				call SetUnitLifeBJ(GetTriggerUnit(),GetUnitState(GetTriggerUnit(),UNIT_STATE_LIFE)+GetUnitState(GetTriggerUnit(),UNIT_STATE_MAX_LIFE)*RJ2(Heiyan,0.12,RJ1(Heiyan,0.06,0.03)) )
				call SetUnitManaBJ(GetTriggerUnit(),GetUnitState(GetTriggerUnit(),UNIT_STATE_MANA) + 3)
			endif
				return true
		endif
		//泣罗刹后续与高级祭品
		if (GetUnitTypeId(u) == 'hh04') then
			call DisableTrigger(GetTriggeringTrigger())
			call UnitDamageTarget( u, GetTriggerUnit(), DamageSacri * 10, false, true, ATTACK_TYPE_MAGIC, DAMAGE_TYPE_MAGIC, WEAPON_TYPE_WHOKNOWS )
			call EnableTrigger(GetTriggeringTrigger())
			return true
		endif
		if (GetUnitTypeId(u) == 'h011') then
			call DisableTrigger(GetTriggeringTrigger())
			call UnitDamageTarget( u, GetTriggerUnit(), DamageSacri * 50, false, true, ATTACK_TYPE_MAGIC, DAMAGE_TYPE_MAGIC, WEAPON_TYPE_WHOKNOWS )
			call SetUnitLifeBJ(Heiyan,GetUnitState(Heiyan,UNIT_STATE_LIFE)+ DamageSacri * 1.5)
			call EnableTrigger(GetTriggeringTrigger())
			return true
		endif
		return false
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    黑阎技能0:切换祭品形态
	*/
	//魔界
	private function YeShenJi takes nothing returns nothing
		local unit u = GetSpellAbilityUnit()
		local group l_group = CreateGroup()
		local unit l_unit
		set BIsMojie = not (BIsMojie)
		call GroupAddGroup(GSacri,l_group)
		if(BIsMojie == true) then
		    call PrintSpellContent(GetOwningPlayer(u),GetAbilityName(GetSpellAbilityId()),"当前祭品控制权为魔界.")
		    loop
		        set l_unit = FirstOfGroup(l_group)
		        exitwhen l_unit == null
		        call GroupRemoveUnit(l_group, l_unit)
		        call SetUnitOwner(l_unit,Player(11),true)
		    endloop
		else
		    call PrintSpellContent(GetOwningPlayer(u),GetAbilityName(GetSpellAbilityId()),"当前祭品控制权为自己.")
		    loop
		        set l_unit = FirstOfGroup(l_group)
		        exitwhen l_unit == null
		        call GroupRemoveUnit(l_group, l_unit)
		    	call SetUnitOwner(l_unit,GetOwningPlayer(Heiyan),true)
		    endloop
		endif
		call DestroyGroup(l_group)
		set l_group = null
		set u = null
		set l_unit = null
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    黑阎技能0：杀死创造祭品
	*/
	private function TSpellHeiyan00Con takes nothing returns boolean
		return (GetKillingUnitBJ() == Heiyan and IsUnitIllusion(GetKillingUnitBJ()) == false and GetUnitPointValue(GetDyingUnit()) != 123	and GetUnitPointValue(GetDyingUnit()) != 0 and IsUnitEnemy(GetDyingUnit(), GetOwningPlayer(GetKillingUnitBJ())) and GetUnitTypeId(GetDyingUnit()) != 'h012')
	endfunction
	private function TSpellHeiyan00Act takes nothing returns nothing
		call CreateSacrifice(GetDyingUnit())
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    黑阎技能1:千鬼邪
	*/
	private function HeiyanFilter takes nothing returns boolean
		return (IsEnemy(GetFilterUnit(),Heiyan) or IsUnitInGroup(GetFilterUnit(),GSacri))
	endfunction
	private function QianGuiXie takes unit speller,unit target,real damageRate,integer abilityID returns nothing
		local unit u = speller
		local real damage = GetDamageStr(u) * damageRate
	    local group l_group = CreateGroup()
	    local unit l_unit
	    local integer count
	    call CreateUnitEffect(GetOwningPlayer(u),'h008',GetUnitX(target),GetUnitY(target),0)
	    call GroupEnumUnitsInRange(l_group, GetUnitX(target), GetUnitY(target), 600, Condition(function HeiyanFilter))
	    set count = CountUnitsInGroup(l_group)
	    set damage = damage * (0.5 + 0.20 * count)
	    loop
	        set l_unit = FirstOfGroup(l_group)
	        exitwhen l_unit == null
	        call GroupRemoveUnit(l_group, l_unit)
	        if not (IsUnitInGroup(l_unit,GSacri)) then
	        	call DestroyEffect(AddSpecialEffect("Objects\\Spawnmodels\\Undead\\UndeadDissipate\\UndeadDissipate.mdl", GetUnitX(l_unit), GetUnitY(l_unit) ))
	    		call UnitDamageTarget( u, l_unit, damage, false, true, ATTACK_TYPE_MAGIC, DAMAGE_TYPE_MAGIC, WEAPON_TYPE_WHOKNOWS )
	        endif
	    endloop
	    //输出伤害
	    call PrintSpellAdd(GetOwningPlayer(u),GetAbilityName(abilityID),damage,",敌人数量"+I2S(count)+"个")
	    call DestroyGroup(l_group)
	    set l_group = null
	    set l_unit =null
		set u = null
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    黑阎技能2:阎罗殿攻击效果
	*/
    private function TSpellHeiyan2Con takes nothing returns boolean
    	return GetAttacker() == Heiyan and IsSecondSpellOK(Heiyan) == true and GetUnitState(Heiyan,UNIT_STATE_MANA) >= 250 and CountUnitsInGroup(GSacri) >= 1 and GetUnitAbilityLevel(Heiyan,'A0C8') == 1
    endfunction
    private function TSpellHeiyan2Act takes nothing returns nothing
    	call DisableTrigger(GetTriggeringTrigger())
		call QianGuiXie(Heiyan,GetAttackedUnitBJ(),0.4,'A0C8')
		call YDWEPolledWaitNull(2)
    	call EnableTrigger(GetTriggeringTrigger())
    endfunction
    /*
        黑阎技能2：阎罗殿产生效果
    */
    private function YanLuoDianCreate takes nothing returns nothing
    	local timer t = GetExpiredTimer()
    	local unit u = LoadUnitHandle(spellTable,GetHandleId(t),kUYanluo)
    	if (IsUnitAliveBJ(u) == true) then
    		call CreateSacrifice(u)
    	else
    		call PauseTimer(t)
    		call DestroyTimer(t)
    		call FlushChildHashtable(spellTable,GetHandleId(t))
    	endif
    	set u = null
    	set t = null
    endfunction
    private function YanLuoDian takes nothing returns nothing
    	local timer t = CreateTimer()
    	local unit u = CreateUnit(GetOwningPlayer(GetSpellAbilityUnit()),'hh02',GetSpellTargetX(),GetSpellTargetY(),0)
	    call UnitApplyTimedLifeBJ( 30.00, 'BHwe',u )
    	call SaveUnitHandle(spellTable,GetHandleId(t),kUYanluo,u)
    	call TimerStart(t,1,true,function YanLuoDianCreate)
		call PrintSpellName(GetOwningPlayer(u),GetAbilityName(GetSpellAbilityId()))
    	set u = null
    	set t = null
    endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    黑阎技能3：赦魂诀主动效果
	*/
	private function SheHunJue takes nothing returns nothing
		call CreateSuperSacrifice(GetSpellTargetX(),GetSpellTargetY())
		call PrintSpell(GetOwningPlayer(GetSpellAbilityUnit()),GetAbilityName(GetSpellAbilityId()),DamageSacri)
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    黑阎技能4：祭品死亡计数，还有爆炸效果
	*/
	private function SimulateDeathHeiyanBoom takes unit u returns nothing
	    call CreateUnitEffectSpecifyTime(GetOwningPlayer(Heiyan),'hh04',GetUnitX(u),GetUnitY(u),0,1.8)
	endfunction
	/*
	    祭品死亡事件
	*/
	function SimulateDeathHeiyan takes unit u returns nothing
		if not(IsUnitInGroup(u,GSacri) == true) then
			return
		endif
		call GroupRemoveUnit(GSacri,GetDyingUnit())
		if(IsFourthSpellOK(Heiyan) == true and GetUnitAbilityLevel(Heiyan,'A0D2') == 1 and GetUnitState(Heiyan,UNIT_STATE_MANA) >= 600) then
			call SimulateDeathHeiyanBoom(u)
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    黑阎技能4：泣罗刹暂时乘3的祭品数
	*/
	private function QiLuoCha takes nothing returns nothing
		set IsDouble = true
		call PrintSpellName(GetOwningPlayer(GetSpellAbilityUnit()),GetAbilityName(GetSpellAbilityId()))
		call YDWETimerDestroyEffect(60,AddSpecialEffectTargetUnitBJ("chest",Heiyan,"war3mapImported\\doomtargetpurpl.mdx"))
		call YDWEPolledWaitNull(60)
		call PrintSpellContent(GetOwningPlayer(GetSpellAbilityUnit()),GetAbilityName(GetSpellAbilityId()),"加速结束。")
		set IsDouble = false
	endfunction
	/*
	    黑阎技能4：致死伤害无效化
	*/
	private function TSpellHeiyan41Con takes nothing returns boolean
		return (GetEventDamage() > GetUnitState(Heiyan,UNIT_STATE_LIFE) and (CountUnitsInGroup(GSacri) >= 1) and (IsFourthSpellOK(Heiyan) == true) and (GetUnitAbilityLevel(Heiyan,'A0D2') == 1)) and (GetEventDamage() < GetUnitState(Heiyan,UNIT_STATE_MAX_LIFE) or GetRandomInt(1,2) == 1)
	endfunction
	private function TSpellHeiyan41Act takes nothing returns nothing
		call KillUnit(FirstOfGroup(GSacri))
    	call RecoverUnitHP(Heiyan,0.1)
		call ImmuteDamageInterval(Heiyan,0.1)
		call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Human\\Resurrect\\ResurrectTarget.mdl", GetUnitX(Heiyan), GetUnitY(Heiyan) ))
		call PrintSpellContent(GetOwningPlayer(Heiyan),GetAbilityName('A0D2'),"抵消致死伤害.")
		call SpinTongji()
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    黑阎技能5：葬九天
	*/
	private function ZangJiuTianTimer takes nothing returns nothing
		local timer t = GetExpiredTimer()
		local real x = GetUnitX(UZangJiuTian)
		local real y = GetUnitY(UZangJiuTian)
		local integer ii = 1
		//如果祭品没有了则阵消失
		if (CountUnitsInGroup(GSacri) >= 1) then
			loop
				exitwhen ii > 6
					call DestroyEffect(AddSpecialEffect("war3mapImported\\GhostStrike.mdx", x + CosBJ( ii*60 ) * GetRandomInt(100,500), y + SinBJ( ii*60 ) * GetRandomInt(100,500)))
				set ii = ii +1
			endloop
			call DamageArea(Heiyan,x,y,600,GetDamageStr(Heiyan))
		else
			call RemoveUnit(UZangJiuTian)
			call PauseTimer(t)
			call DestroyTimer(t)
			set UZangJiuTian = null
		endif
		set t = null
	endfunction
	private function ZangJiuTian takes nothing returns nothing
		local timer t = CreateTimer()
		call RemoveUnit(UZangJiuTian)
		set UZangJiuTian = CreateUnit(GetOwningPlayer(GetSpellAbilityUnit()),'hh05',GetUnitX(GetSpellAbilityUnit()),GetUnitY(GetSpellAbilityUnit()),0)
	    call PrintSpell(GetOwningPlayer(GetSpellAbilityUnit()),GetAbilityName(GetSpellAbilityId()),GetDamageStr(Heiyan))
		call TimerStart(t,1,true,function ZangJiuTianTimer)
        call PlaySoundBJ(gg_snd_heiyan_5)
		set t = null
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    主英雄技能判断
	*/
	private function TSpellHeiyanAct takes nothing returns nothing
		local integer i = 1
		if (GetSpellAbilityId() == 'A0C7') then
			call QianGuiXie(Heiyan,GetSpellTargetUnit(),1,GetSpellAbilityId())
		elseif (GetSpellAbilityId() == 'A0A3' or GetSpellAbilityId() == 'A0BI') then
			call YeShenJi()
			//不召唤祭品
			return
		elseif (GetSpellAbilityId() == 'A0C8') then
			call YanLuoDian()
		elseif (GetSpellAbilityId() == 'A0JH') then
			call SheHunJue()
		elseif (GetSpellAbilityId() == 'A0D2') then
			call QiLuoCha()
		elseif (GetSpellAbilityId() == 'A0DD') then
			call ZangJiuTian()
		endif
		if not (GetUnitState(Heiyan,UNIT_STATE_MANA) >= 100) then
			return
		endif
		call CreateSacrifice(GetSpellAbilityUnit())
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    英雄学习技能
	*/
	//按照12345来判断
	function LearnSkillHeiyanI takes unit learner,integer whichSpell returns nothing
		local integer i
		if (learner == Heiyan) then
			if(whichSpell == 1) then
				set ISacriMaxCount = ISacriMaxCount + 3
			elseif (whichSpell == 2 and IsSecondSpellOK(Heiyan) == true and GetUnitAbilityLevel(Heiyan,'A0C8') == 1) then
				//技能2初始化
				set ISacriMaxCount = ISacriMaxCount + 3
			elseif (whichSpell == 3 and IsThirdSpellOK(Heiyan) == true and GetUnitAbilityLevel(Heiyan,'A0JH') == 1) then
				//技能3初始化
				set ISacriMaxCount = ISacriMaxCount + 3
				call AddSpecialEffectTargetUnitBJ("origin",Heiyan,"war3mapImported\\devilaura.mdl")
				call InitHeiyanAura()
			elseif (whichSpell == 4 and IsFourthSpellOK(Heiyan) == true and GetUnitAbilityLevel(Heiyan,'A0D2') == 1) then
				//技能4初始化
				set ISacriMaxCount = ISacriMaxCount + 3
			elseif (whichSpell == 5 and IsFifthSpellOK(Heiyan) == true and GetUnitAbilityLevel(Heiyan,'A0DD') == 1) then
				//技能5初始化
				set ISacriMaxCount = ISacriMaxCount + 6
			endif
		endif
	endfunction
	function LearnSkillHeiyan takes unit learner,integer learnSpellID returns nothing
		if (learner == Heiyan) then
			if (learnSpellID == 'A0C7') then
				call LearnSkillHeiyanI(learner,1)
			elseif (learnSpellID == 'A0C8') then
				call LearnSkillHeiyanI(learner,2)
			elseif (learnSpellID == 'A0JH') then
				call LearnSkillHeiyanI(learner,3)
			elseif (learnSpellID == 'A0D2') then
				call LearnSkillHeiyanI(learner,4)
			elseif (learnSpellID == 'A0DD') then
				call LearnSkillHeiyanI(learner,5)
			endif
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    复活后关闭碰撞
	*/
	function AfterReviveHeiyan takes unit u returns nothing
		if (u == Heiyan) then
    		call SetUnitPathing( Heiyan, false )
    		set ISpinHeiyan = -1000
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    黑阎皮肤
	*/
	private function InitHeiyanSpin takes unit u returns unit
		if (IsHeiyanSpin1(GetOwningPlayer(u))) then
			set udg_H[GetConvertedPlayerId(GetOwningPlayer(u))] = CreateUnit(GetOwningPlayer(u),'U003',GetUnitX(u),GetUnitY(u),0)
			call UnitAddItemByIdSwapped('I006', udg_H[GetConvertedPlayerId(GetOwningPlayer(u))])
			call SetUnitManaPercentBJ(udg_H[GetConvertedPlayerId(GetOwningPlayer(u))],100)
			call RemoveUnit(u)
			set ISacriMaxCount = ISacriMaxCount + 2
			return udg_H[GetConvertedPlayerId(GetOwningPlayer(u))]
		else
			return u
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    初始化新英雄,选取时调用
	*/
	function InitHeiyan takes unit u returns nothing
		local timer t = CreateTimer()
		set GSacri = CreateGroup()
		set Heiyan = InitHeiyanSpin(u)
		call SetUnitPathing( Heiyan, false )
		//主英雄技能
		set TSpellHeiyan1 = CreateTrigger()
	    call TriggerRegisterUnitEvent(TSpellHeiyan1,Heiyan,EVENT_UNIT_SPELL_EFFECT)
	    call TriggerAddAction(TSpellHeiyan1, function TSpellHeiyanAct)
	    //主英雄杀敌事件
	    set TSpellHeiyan00 = CreateTrigger()
	    call TriggerRegisterAnyUnitEventBJ(TSpellHeiyan00,EVENT_PLAYER_UNIT_DEATH)
	    call TriggerAddCondition(TSpellHeiyan00, Condition(function TSpellHeiyan00Con))
	    call TriggerAddAction(TSpellHeiyan00, function TSpellHeiyan00Act)
	    //英雄第二个技能攻击事件
	    set TSpellHeiyan2 = CreateTrigger()
	    call TriggerRegisterAnyUnitEventBJ(TSpellHeiyan2,EVENT_PLAYER_UNIT_ATTACKED)
	    call TriggerAddCondition(TSpellHeiyan2, Condition(function TSpellHeiyan2Con))
	    call TriggerAddAction(TSpellHeiyan2, function TSpellHeiyan2Act)
		//祭品伤害的刷新
		call TimerStart(t,3,true,function SacriDamageFlash)
		set t = null
		//英雄第四个技能时的无敌
	    set TSpellHeiyan41 = CreateTrigger()
	    call TriggerRegisterUnitEvent(TSpellHeiyan41,Heiyan,EVENT_UNIT_DAMAGED)
		call TriggerAddCondition(TSpellHeiyan41, Condition(function TSpellHeiyan41Con))
		call TriggerAddAction(TSpellHeiyan41, function TSpellHeiyan41Act)
	endfunction
endlibrary
//!import "LHBase.j"
//!import "Spin.j"
library_once Sheyan requires LHBase,Spin
	globals
		boolean BSheyanBUG = FALSE
	endglobals
//---------------------------------------------------------------------------------------------------
	/*
	    Body
	*/
	function ShowSheyanDialog takes unit u returns nothing
		if (not(BSheyanBUG) and u == sheyan) then
			set BSheyanBUG = true
			call ShowGameHint(GetOwningPlayer(sheyan),"
				该英雄目前存在着以下:
				使用小狼打巨能会出现
				英雄死亡不会复活的BUG。
				目前版本请不要使用小狼打巨能.")
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    皮肤
	*/
	private function InitSheyanSpin takes unit u returns unit
		if (IsSheyanSpin1(GetOwningPlayer(u))) then
			set udg_H[GetConvertedPlayerId(GetOwningPlayer(u))] = CreateUnit(GetOwningPlayer(u),'O004',GetUnitX(u),GetUnitY(u),0)
			set gg_unit_Othr_0256 = udg_H[GetConvertedPlayerId(GetOwningPlayer(u))]
			call UnitAddItemByIdSwapped('I006', udg_H[GetConvertedPlayerId(GetOwningPlayer(u))])
			call AddSpellPercent(GetConvertedPlayerId(GetOwningPlayer(u)),0.1)
			call SetUnitManaPercentBJ(udg_H[GetConvertedPlayerId(GetOwningPlayer(u))],1000)
			call RemoveUnit(u)
			return udg_H[GetConvertedPlayerId(GetOwningPlayer(u))]
		else
			return u
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    初始化
	*/
	function InitSheyan takes unit u returns nothing
		set sheyan = InitSheyanSpin(u)
	endfunction
endlibrary
/*
    英雄寒殇的技能
*/
library_once Hanshang requires SpellBase,Printer,Attr,Diffculty,Aura,Version,Spin,Structs
	globals
		private boolean IsLianhuan = false
		/*
		    技能
		*/
		private trigger TSpellHanshang = null
		private trigger TSpellHanshang2 = null
		private trigger TSpellHanshang3 = null
		private trigger TSpellHanshang4 = null
		/*
		    第三个技能的增益与减伤
		*/
		private real RLianjin = 0
		private real RLianjin2 = 0
		key kLianhuanBoomX
		key kLianhuanBoomY
		/*
		    毒雾迷阵
		*/
		private timer TDuwu = null
		private unit UDuwu = null
		private effect EffectDu = null
		/*
		    三阶觉醒计数
		*/
		private integer IJuexing = 0
		/*
		    吃的总属性之和
		*/
		private integer ITotalEat = 0
		/*
		    吃的数量
		*/
		private integer ILianjinChi = 1
		//获得物品的数量
		private integer IDuxin = 0
		private trigger TDuxin = null
		private hashtable HTHS = null
	endglobals
//---------------------------------------------------------------------------------------------------
	/*
	    鬼斧神工
	*/
    private function GuifushengongTimer takes nothing returns nothing
        local timer t = GetExpiredTimer()
        local integer id = GetHandleId(t)
        local item it = LoadItemHandle(spellTable,id,1)
        call RemoveItem(it)
        call DisplayTextToPlayer(GetOwningPlayer(hanshang), 0., 0., "|cFFFF66CC【鬼斧神工】|r时间到，物品消失。")
        call PauseTimer(t)
        call FlushChildHashtable(spellTable,id)
        call DestroyTimer(t)
        set it = null
        set t = null
    endfunction
	private function Guifushengong takes nothing returns nothing
        local item it = null
        local timer t = null
        if not (IsCanCopy(GetSpellTargetItem())) then
            call DisplayTextToPlayer(GetOwningPlayer(hanshang), 0., 0., "|cFFFF66CC【鬼斧神工】|r该物品禁止复制。")
            return
        endif
        call DisplayTextToPlayer( GetOwningPlayer(GetTriggerUnit()), 0, 0, ( "|cFFFF66CC【|r|cffff00ff鬼斧神工|r|cFFFF66CC】|r成功复制出了" + ( GetItemName(GetSpellTargetItem()) + "。" ) ) )
        set it = UnitAddItemByIdSwapped( GetItemTypeId(GetSpellTargetItem()), GetTriggerUnit() )
        if ((GetItemType(GetSpellTargetItem()) != ITEM_TYPE_CHARGED)) then
        	if (BJuexing3[GetConvertedPlayerId(GetOwningPlayer(hanshang))]) then
        		set IJuexing = IJuexing + 1
        		if (IJuexing >= 20) then
        			call DisplayTextToPlayer( GetOwningPlayer(GetTriggerUnit()), 0, 0, ( "|cFFFF66CC【|r|cffff00ff鬼斧神工|r|cFFFF66CC】|r该物品为真品。" ) )
					set IJuexing = 0
			        set it = null
			        set t = null
					return
				else
        			call DisplayTextToPlayer( GetOwningPlayer(GetTriggerUnit()), 0, 0, ( "|cFFFF66CC【|r|cffff00ff鬼斧神工|r|cFFFF66CC】|r还需要使用"+I2S(20 - IJuexing)+"次才为真品。" ) )
        		endif
        	endif
            call SetItemPawnable( it , false )
            set t = CreateTimer()
            call SaveItemHandle(spellTable,GetHandleId(t),1,it)
            call TimerStart(t,30,false,function GuifushengongTimer)
        endif
        set it = null
        set t = null
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    死神炸弹
	*/
	function SiShenZhaDan takes real x,real y,real damageRate,integer abilityID returns nothing
		local real n
		local real damage = GetDamageAgi(hanshang) * damageRate
		local real x1 = GetUnitX(hanshang)
	    local real y1 = GetUnitY(hanshang)
	    local real facing = GetFacingBetweenXY(x1,y1,x,y)
	    local real distance = SquareRoot((y-y1)*(y-y1)+(x-x1)*(x-x1))
	    if (distance < 1000) then
	    	set n = 1
	    elseif (distance < 4000) then
	    	set n =1.5
	    else
	    	set n = (1.5 + (distance - 4000) / 5000)
	    endif
	    set damage = damage * n
	    call Boom.create(CreateUnit(GetOwningPlayer(hanshang),'h007',x1,y1,facing),x,y,facing,damage,60*IJ2(hanshang,2,1),450,0.05,"Objects\\Spawnmodels\\Other\\NeutralBuildingExplosion\\NeutralBuildingExplosion.mdl")
	    if(BJuexing2[GetConvertedPlayerId(GetOwningPlayer(hanshang))]) then
	    	call SetUnitLifePercentBJ(hanshang,100)
	    	call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Items\\AIma\\AImaTarget.mdl", GetUnitX(hanshang),GetUnitY(hanshang) ))
	    endif
	    if (abilityID != 0) then
	    	call PrintSpellAdd(GetOwningPlayer(hanshang),GetAbilityName(abilityID),damage,",距离伤害加成n为"+I2S(R2I(n*100) - 100)+"%.")
	    endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    吃装备
	*/
	private function Wuqiongtunshi takes nothing returns nothing
        local item it = GetSpellTargetItem()
        local integer i = 0
        local real r = 0
        local integer loopI = 0
        if (HaveSavedInteger(YDHT,GetHandleId(it),0xA75AD423) and GetConvertedPlayerId(GetOwningPlayer(hanshang)) != LoadInteger(YDHT,GetHandleId(it),0xA75AD423)) then
            call DisplayTextToPlayer( GetOwningPlayer(hanshang), 0, 0, ( "|cFFFF66CC【消息】|r这件东西属于" + ( GetUnitName(udg_H[LoadInteger(YDHT,GetHandleId(it),0xA75AD423)]) + ",不可吞噬。" ) ) )
            set it = null
            return
        endif
        if (GetItemTypeId(it) == 'I079') then
        	return
        endif
	    call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\NightElf\\BattleRoar\\RoarCaster.mdl", GetUnitX(hanshang), GetUnitY(hanshang) ))
	    if (IsItemPawnable(it)) then
	    	set loopI = 1
	    	loop
	    		exitwhen i > (ILianjinChi - 1)
	    		if (LoadInteger(spellTable,GetHandleId(hanshang),i) == GetItemTypeId(it)) then
	    			call DisplayTextToPlayer(GetOwningPlayer(hanshang), 0., 0., "|cFFFF66CC【消息】|r吞噬失败,对同一种真品只能吞噬一次.(复制出来的没这个限制)")
	    			return
	    		endif
	    		set i = i +1
	    	endloop
	    	call DisplayTextToPlayer( GetOwningPlayer(hanshang), 0, 0, ( "|cFFFF66CC【|r" + ( GetAbilityName(GetSpellAbilityId()) + "|cFFFF66CC】|r吞噬成功，增加的属性值如以下所示：" ) ) )
			call SaveInteger(spellTable,GetHandleId(hanshang),ILianjinChi,GetItemTypeId(it))
			set ILianjinChi = ILianjinChi + 1
	        if (HaveSavedInteger(YDHT, GetItemTypeId(it) , 0x5BAE281D)) then
	            set i = LoadInteger(YDHT, GetItemTypeId(it), 0x5BAE281D) * 2 / 5 * I3(JJ1,3,1)
	            call DisplayTextToPlayer( GetOwningPlayer(hanshang), 0, 0, ( "|cFFFF66CC【|r全属性|cFFFF66CC】|r+" + I2S(i) ) )
	            call ModifyHeroStat( bj_HEROSTAT_STR, hanshang, bj_MODIFYMETHOD_ADD, i )
	            call ModifyHeroStat( bj_HEROSTAT_AGI, hanshang, bj_MODIFYMETHOD_ADD, i )
	            call ModifyHeroStat( bj_HEROSTAT_INT, hanshang, bj_MODIFYMETHOD_ADD, i )
	            set ITotalEat = ITotalEat + i * 3
	        endif
	        if (HaveSavedInteger(YDHT, GetItemTypeId(it) , 0x8D205575)) then
	            set i = LoadInteger(YDHT, GetItemTypeId(it), 0x8D205575) * 2 / 5 * I3(JJ1,3,1)
	            call DisplayTextToPlayer( GetOwningPlayer(hanshang), 0, 0, ( "|cFFFF66CC【|r力量|cFFFF66CC】|r+" + I2S(i) ) )
	            call ModifyHeroStat( bj_HEROSTAT_STR, hanshang, bj_MODIFYMETHOD_ADD, i )
	            set ITotalEat = ITotalEat + i
	        endif
	        if (HaveSavedInteger(YDHT, GetItemTypeId(it) , 0x384C9D86)) then
	            set i = LoadInteger(YDHT, GetItemTypeId(it), 0x384C9D86) * 2 / 5 * I3(JJ1,3,1)
	            call DisplayTextToPlayer( GetOwningPlayer(hanshang), 0, 0, ( "|cFFFF66CC【|r敏捷|cFFFF66CC】|r+" + I2S(i) ) )
	            call ModifyHeroStat( bj_HEROSTAT_AGI, hanshang, bj_MODIFYMETHOD_ADD, i )
	            set ITotalEat = ITotalEat + i
	        endif
	        if (HaveSavedInteger(YDHT, GetItemTypeId(it) , 0x1B5C932E)) then
	            set i = LoadInteger(YDHT, GetItemTypeId(it), 0x1B5C932E) * 2 / 5 * I3(JJ1,3,1)
	            call DisplayTextToPlayer( GetOwningPlayer(hanshang), 0, 0, ( "|cFFFF66CC【|r智力|cFFFF66CC】|r+" + I2S(i) ) )
	            call ModifyHeroStat( bj_HEROSTAT_INT, hanshang, bj_MODIFYMETHOD_ADD, i )
	            set ITotalEat = ITotalEat + i
	        endif
	        if (HaveSavedInteger(YDHT, GetItemTypeId(it) , 0x5039AFFB)) then
	            set i = LoadInteger(YDHT, GetItemTypeId(it), 0x5039AFFB) * 2 / 5 * I3(JJ1,3,1)
	            call DisplayTextToPlayer( GetOwningPlayer(hanshang), 0, 0, ( "|cFFFF66CC【|r攻击|cFFFF66CC】|r+" + I2S(i) ) )
	            call AddAttack(hanshang,i)
	        endif
	        if (HaveSavedInteger(YDHT, GetItemTypeId(it) , 0xFCD961C9)) then
	            set i = LoadInteger(YDHT, GetItemTypeId(it), 0xFCD961C9) * 2 / 5 * I3(JJ1,3,1)
	            call DisplayTextToPlayer( GetOwningPlayer(hanshang), 0, 0, ( "|cFFFF66CC【|r生命上限|cFFFF66CC】|r+" + I2S(i) ) )
	            call AddHP(hanshang,i)
	        endif
	        if (HaveSavedReal(YDHT, GetItemTypeId(it) , 0x06C64278)) then
	            set r = LoadReal(YDHT, GetItemTypeId(it), 0x06C64278) / 5 * R3(JJ1,3.,1.)
	            call DisplayTextToPlayer( GetOwningPlayer(hanshang), 0, 0, "|cFFFF66CC【|r力量加成|cFFFF66CC】|r+" + I2S(R2I( r * 100.00 )) + "%。" )
	            call AddStrPercent(GetConvertedPlayerId(GetOwningPlayer(hanshang)),r)
	        endif
	        if (HaveSavedReal(YDHT, GetItemTypeId(it) , 0x6FFF4132)) then
	            set r = LoadReal(YDHT, GetItemTypeId(it), 0x6FFF4132) / 5 * R3(JJ1,3.,1.)
	            call DisplayTextToPlayer( GetOwningPlayer(hanshang), 0, 0, "|cFFFF66CC【|r敏捷加成|cFFFF66CC】|r+" + I2S(R2I( r * 100.00 )) + "%。" )
	            call AddAgiPercent(GetConvertedPlayerId(GetOwningPlayer(hanshang)),r)
	        endif
	        if (HaveSavedReal(YDHT, GetItemTypeId(it) , 0xC0C6918C)) then
	            set r = LoadReal(YDHT, GetItemTypeId(it), 0xC0C6918C) / 5 * R3(JJ1,3.,1.)
	            call DisplayTextToPlayer( GetOwningPlayer(hanshang), 0, 0, "|cFFFF66CC【|r智力加成|cFFFF66CC】|r+" + I2S(R2I( r * 100.00 )) + "%。" )
	            call AddIntPercent(GetConvertedPlayerId(GetOwningPlayer(hanshang)),r)
	        endif
	        if (HaveSavedReal(YDHT, GetItemTypeId(it) , 0xFAA305CD)) then
	            set r = LoadReal(YDHT, GetItemTypeId(it), 0xFAA305CD) / 5 * R3(JJ1,3.,1.)
	            call DisplayTextToPlayer( GetOwningPlayer(hanshang), 0, 0, "|cFFFF66CC【|rHP上限加成|cFFFF66CC】|r+" + I2S(R2I( r * 100.00 )) + "%。" )
	            call AddHPPercent(GetConvertedPlayerId(GetOwningPlayer(hanshang)),r)
	        endif
	        if (HaveSavedReal(YDHT, GetItemTypeId(it) , 0x4C0507D9)) then
	            set r = LoadReal(YDHT, GetItemTypeId(it), 0x4C0507D9) / 5 * R3(JJ1,3.,1.)
	            call DisplayTextToPlayer( GetOwningPlayer(hanshang), 0, 0, "|cFFFF66CC【|r攻击加成|cFFFF66CC】|r+" + I2S(R2I( r * 100.00 )) + "%。" )
	            call AddAttackPercent(GetConvertedPlayerId(GetOwningPlayer(hanshang)),r)
	        endif
	        if (HaveSavedReal(YDHT, GetItemTypeId(it) , 0x0B6FB20F)) then
	            set r = LoadReal(YDHT, GetItemTypeId(it), 0x0B6FB20F) / 5 * R3(JJ1,3.,1.)
	            call DisplayTextToPlayer( GetOwningPlayer(hanshang), 0, 0, "|cFFFF66CC【|r防御加成|cFFFF66CC】|r+" + I2S(R2I( r * 100.00 )) + "%。" )
	            call AddDefensePercent(GetConvertedPlayerId(GetOwningPlayer(hanshang)),r)
	        endif
	    else
	    	call DisplayTextToPlayer( GetOwningPlayer(hanshang), 0, 0, ( "|cFFFF66CC【|r" + ( GetAbilityName(GetSpellAbilityId()) + "|cFFFF66CC】|r吞噬成功，增加的属性值如以下所示：" ) ) )
	       if (HaveSavedInteger(YDHT, GetItemTypeId(it) , 0x5BAE281D)) then
	            set i = LoadInteger(YDHT, GetItemTypeId(it), 0x5BAE281D) /20 * I3(JJ1,3,1)
	            call DisplayTextToPlayer( GetOwningPlayer(hanshang), 0, 0, ( "|cFFFF66CC【|r全属性|cFFFF66CC】|r+" + I2S(i) ) )
	            call ModifyHeroStat( bj_HEROSTAT_STR, hanshang, bj_MODIFYMETHOD_ADD, i )
	            call ModifyHeroStat( bj_HEROSTAT_AGI, hanshang, bj_MODIFYMETHOD_ADD, i )
	            call ModifyHeroStat( bj_HEROSTAT_INT, hanshang, bj_MODIFYMETHOD_ADD, i )
	            set ITotalEat = ITotalEat + i * 3
	        endif
	        if (HaveSavedInteger(YDHT, GetItemTypeId(it) , 0x8D205575)) then
	            set i = LoadInteger(YDHT, GetItemTypeId(it), 0x8D205575) /20 * I3(JJ1,3,1)
	            call DisplayTextToPlayer( GetOwningPlayer(hanshang), 0, 0, ( "|cFFFF66CC【|r力量|cFFFF66CC】|r+" + I2S(i) ) )
	            call ModifyHeroStat( bj_HEROSTAT_STR, hanshang, bj_MODIFYMETHOD_ADD, i )
	            set ITotalEat = ITotalEat + i
	        endif
	        if (HaveSavedInteger(YDHT, GetItemTypeId(it) , 0x384C9D86)) then
	            set i = LoadInteger(YDHT, GetItemTypeId(it), 0x384C9D86) /20 * I3(JJ1,3,1)
	            call DisplayTextToPlayer( GetOwningPlayer(hanshang), 0, 0, ( "|cFFFF66CC【|r敏捷|cFFFF66CC】|r+" + I2S(i) ) )
	            call ModifyHeroStat( bj_HEROSTAT_AGI, hanshang, bj_MODIFYMETHOD_ADD, i )
	            set ITotalEat = ITotalEat + i
	        endif
	        if (HaveSavedInteger(YDHT, GetItemTypeId(it) , 0x1B5C932E)) then
	            set i = LoadInteger(YDHT, GetItemTypeId(it), 0x1B5C932E) /20 * I3(JJ1,3,1)
	            call DisplayTextToPlayer( GetOwningPlayer(hanshang), 0, 0, ( "|cFFFF66CC【|r智力|cFFFF66CC】|r+" + I2S(i) ) )
	            call ModifyHeroStat( bj_HEROSTAT_INT, hanshang, bj_MODIFYMETHOD_ADD, i )
	            set ITotalEat = ITotalEat + i
	        endif
	        if (HaveSavedInteger(YDHT, GetItemTypeId(it) , 0x5039AFFB)) then
	            set i = LoadInteger(YDHT, GetItemTypeId(it), 0x5039AFFB) /20 * I3(JJ1,3,1)
	            call DisplayTextToPlayer( GetOwningPlayer(hanshang), 0, 0, ( "|cFFFF66CC【|r攻击|cFFFF66CC】|r+" + I2S(i) ) )
	            call AddAttack(hanshang,i)
	        endif
	        if (HaveSavedInteger(YDHT, GetItemTypeId(it) , 0xFCD961C9)) then
	            set i = LoadInteger(YDHT, GetItemTypeId(it), 0xFCD961C9) /20 * I3(JJ1,3,1)
	            call DisplayTextToPlayer( GetOwningPlayer(hanshang), 0, 0, ( "|cFFFF66CC【|r生命上限|cFFFF66CC】|r+" + I2S(i) ) )
	            call AddHP(hanshang,i)
	        endif
	    endif
	    if (ITotalEat > 5000000) then
	    	debug call SetHanshang1SpinOK(GetOwningPlayer(hanshang))
	    endif
	    call RemoveItem( it )
	    set it = null
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    无穷吞噬
	*/
	private function TSpellHanshang2Con takes nothing returns boolean
	    return ((GetAttackedUnitBJ() == hanshang) and ( IsSecondSpellOK(hanshang) == true) and (GetRandomInt(1, 10) == 1) and (GetUnitStateSwap(UNIT_STATE_MANA, hanshang) > 200.00) and GetUnitAbilityLevel(hanshang,'A0IK') >= 1)
	endfunction
	private function TSpellHanshang2Act takes nothing returns nothing
		call DisableTrigger(GetTriggeringTrigger())
		call SiShenZhaDan(GetUnitX(GetAttacker()),GetUnitY(GetAttacker()),0.33,'A0IK')
		call YDWEPolledWaitNull(5)
		call EnableTrigger(GetTriggeringTrigger())
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    炼金之术
	*/
	private function LianJinZhiShuTimer takes nothing returns nothing
		local integer lumber = GetPlayerState(GetOwningPlayer(hanshang), PLAYER_STATE_RESOURCE_LUMBER)
		local integer update = 0
		local real Rupdate
		if (lumber > 100000) then
			set update = 90
			set RLianjin2 = 0.72
		elseif (lumber > 10000) then
			set update = 75
			set RLianjin2 = 0.6
		elseif (lumber > 1000) then
			set update = 60
			set RLianjin2 = 0.48
		elseif (lumber > 100) then
			set update = 45
			set RLianjin2 = 0.36
		elseif (lumber > 10) then
			set update = 30
			set RLianjin2 = 0.24
		elseif (lumber > 1) then
			set update = 15
			set RLianjin2 = 0.12
		endif
		set Rupdate = I2R(update)/100
		if (RLianjin != Rupdate) then
			call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Other\\Transmute\\PileofGold.mdl", GetUnitX(hanshang), GetUnitY(hanshang) ))
			call PrintSpellContent(GetOwningPlayer(hanshang),GetAbilityName('A0BN'),"额外技能伤害加成"+I2S(update)+"%.")
			call AddSpellPercent(GetConvertedPlayerId(GetOwningPlayer(hanshang)),Rupdate - RLianjin)
			set RLianjin = Rupdate
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    连环炸弹
	*/
	private function LianhuanBoomTimer takes nothing returns nothing
		local timer t = GetExpiredTimer()
		local integer id = GetHandleId(t)
		local real x = LoadReal(spellTable,id,kLianhuanBoomX)
		local real y = LoadReal(spellTable,id,kLianhuanBoomY)
		if ((GetUnitState( hanshang , UNIT_STATE_MANA) >= 100) and (IsLianhuan == true)) then
			call SetUnitManaBJ(hanshang,GetUnitState( hanshang , UNIT_STATE_MANA)- 100)
			call SiShenZhaDan(x,y,1,0)
		else
        	call IssueImmediateOrder( hanshang, "stop" )
        	set IsLianhuan = false
			call PrintSpellContent(GetOwningPlayer(hanshang),GetAbilityName('A0F0'),"施法结束.")
			call PauseTimer(t)
			call DestroyTimer(t)
			call FlushChildHashtable(spellTable,id)
		endif
		set t = null
	endfunction
	private function LianhuanBoom takes nothing returns nothing
		local timer t = CreateTimer()
		set IsLianhuan = true
		call EnableTrigger(TSpellHanshang4)
		call SaveReal(spellTable,GetHandleId(t),kLianhuanBoomX,GetSpellTargetX())
		call SaveReal(spellTable,GetHandleId(t),kLianhuanBoomY,GetSpellTargetY())
		call TimerStart(t,0.5,true,function LianhuanBoomTimer)
		call PrintSpellName(GetOwningPlayer(hanshang),GetAbilityName('A0F0'))
		set t = null
	endfunction
	/*
	    判断还在施法
	*/
	private function TSpellHanshang4Con takes nothing returns boolean
	    return ((GetSpellAbilityId() == 'A0F0'))
	endfunction
	private function TSpellHanshang4Act takes nothing returns nothing
		set IsLianhuan = false
		call DisableTrigger(TSpellHanshang4)
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    给地狱之礼
	*/
	private function GiveDiyu takes nothing returns nothing
		local integer i = GetRandomInt(1,3)
		if (IsFourthSpellOK(hanshang) and GetUnitAbilityLevel(hanshang,'A0F0') == 1) then
			if (i == 1) then
				call UnitAddItemByIdSwapped('I06A', UDepot[GetConvertedPlayerId(GetOwningPlayer(hanshang))])
			elseif (i == 2) then
				call UnitAddItemByIdSwapped('I06J', UDepot[GetConvertedPlayerId(GetOwningPlayer(hanshang))])
			elseif (i == 3) then
				call UnitAddItemByIdSwapped('I06B', UDepot[GetConvertedPlayerId(GetOwningPlayer(hanshang))])
			endif
			call PrintSpellContent(GetOwningPlayer(hanshang),GetAbilityName('A0F0'),"获得了"+GetItemName(GetLastCreatedItem())+"存放于仓库.")
            call PingMinimapForForce( YDWEGetForceOfPlayerNull(GetOwningPlayer(hanshang)), GetUnitX(UDepot[GetConvertedPlayerId(GetOwningPlayer(hanshang))]), GetUnitY(UDepot[GetConvertedPlayerId(GetOwningPlayer(hanshang))]), 2.00 )
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    毒雾迷阵
	*/
	private function DuwumizhenTimer takes nothing returns nothing
		if ((IsUnitAliveBJ(UDuwu)) and (GetUnitAbilityLevelSwapped('Avul', UDuwu) < 1) and (IsUnitAliveBJ(hanshang) == true)) then
	    	call DamageArea(hanshang,GetUnitX(UDuwu),GetUnitY(UDuwu),400,GetDamageAgi(hanshang)* 0.6)
		else
			call PauseTimer(TDuwu)
			call DestroyTimer(TDuwu)
			set TDuwu = null
			set UDuwu = null
			call DestroyEffect(EffectDu)
			set EffectDu = null
		endif
	endfunction
	private function Duwumizhen takes nothing returns nothing
		if (EffectDu != null) then
        	call DestroyEffect( EffectDu )
		endif
	    set UDuwu = GetSpellTargetUnit()
	    set EffectDu = AddSpecialEffectTarget("war3mapImported\\radioactivecloud.mdl", UDuwu, "chest")
    	call PrintSpell(GetOwningPlayer(hanshang),GetAbilityName(GetSpellAbilityId()),GetDamageAgi(hanshang)* 0.6)
		if (TDuwu == null) then
			set TDuwu = CreateTimer()
			call TimerStart(TDuwu,1,true,function DuwumizhenTimer)
		endif
		call PlaySoundBJ(gg_snd_hanshang_5)
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    英雄使用技能
	*/
	private function TSpellHanshangCon takes nothing returns boolean
	    return (GetSpellAbilityUnit() == hanshang)
	endfunction
	private function TSpellHanshangAct takes nothing returns nothing
		if ((GetSpellAbilityId() == 'A0IJ')) then
			call SiShenZhaDan(GetSpellTargetX(),GetSpellTargetY(),1,GetSpellAbilityId())
		elseif ((GetSpellAbilityId() == 'A0F0')) then
			call LianhuanBoom()
		//鬼斧神工
        elseif ((GetSpellAbilityId() == 'A0II')) then
            call Guifushengong()
        //无穷吞噬
        elseif ((GetSpellAbilityId() == 'A0IK')) then
            call Wuqiongtunshi()
        //毒雾迷阵
        elseif ((GetSpellAbilityId() == 'AUfa')) then
            call Duwumizhen()
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    寒殇金币减少受到的伤害
	*/
	private function TSpellHanshang3Con takes nothing returns boolean
		return IsThirdSpellOK(hanshang) == true and GetUnitAbilityLevel(hanshang,'A0BN') == 1 and GetEventDamage() > 100 and GetTriggerUnit() == hanshang and IsUnitAliveBJ(hanshang)
	endfunction
	private function TSpellHanshang3Act takes nothing returns nothing
		call SetUnitLifeBJ(hanshang,GetUnitState(hanshang,UNIT_STATE_LIFE)+GetEventDamage() * RLianjin2)
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    英雄学习技能
	*/
	//按照12345来判断
	function LearnSkillHanshangI takes unit learner,integer whichSpell returns nothing
		if (learner == hanshang) then
			if (whichSpell == 3 and IsThirdSpellOK(hanshang) == true and GetUnitAbilityLevel(hanshang,'A0BN') == 1) then
				//技能3初始化
		        call AddMoneyPercent(GetConvertedPlayerId(GetOwningPlayer(hanshang)),0.25)
       			call InitHanshangAura()
       			//炼金之术
       			call TimerStart(CreateTimer(),3,true,function LianJinZhiShuTimer)
       		endif
		endif
	endfunction
	function LearnSkillHanshang takes unit learner,integer learnSpellID returns nothing
		if (learner == hanshang) then
			if (learnSpellID == 'A0IJ') then
				call LearnSkillHanshangI(learner,1)
			elseif (learnSpellID == 'A0IK') then
				call LearnSkillHanshangI(learner,2)
			elseif (learnSpellID == 'A0BN') then
				call LearnSkillHanshangI(learner,3)
			elseif (learnSpellID == 'A0F0') then
				call LearnSkillHanshangI(learner,4)
			elseif (learnSpellID == 'AUfa') then
				call LearnSkillHanshangI(learner,5)
			endif
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    初始化皮肤任务
	*/
	private function TDuxinAct takes nothing returns nothing
		local integer i
		if (HTHS == null) then
			return
		endif
		if (GetHanshang2Spin(GetOwningPlayer(hanshang))) then
			return
		endif
		set i = 1
		loop
			exitwhen i > IDuxin
    		if (LoadInteger(HTHS,GetHandleId(hanshang),i) == GetItemTypeId(GetManipulatedItem())) then
    			return
    		endif
			set i = i +1
		endloop
		set IDuxin = IDuxin + 1
		call SaveInteger(HTHS,GetHandleId(hanshang),IDuxin,GetItemTypeId(GetManipulatedItem()))
		if (IDuxin < 520) then
			call DisplayTextToPlayer(GetOwningPlayer(hanshang), 0., 0., "|cFF3333FF【耀金独心|r】|r进度:"+I2S(IDuxin) + "/520.")
		else
			debug call SetHanshang2SpinOK(GetOwningPlayer(hanshang))
		endif
	endfunction
	function InitDuxin takes nothing returns nothing
		set TDuxin = CreateTrigger()
		set HTHS = InitHashtable()
    	call TriggerRegisterUnitEvent( TDuxin, hanshang, EVENT_UNIT_PICKUP_ITEM )
		call TriggerAddAction(TDuxin, function TDuxinAct)
		set TDuxin = null
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    寒殇匕首
	*/
	private function InitHanshangSpin takes unit u returns unit
        if (IsHanshangSpin2(GetOwningPlayer(u))) then
            set udg_H[GetConvertedPlayerId(GetOwningPlayer(u))] = CreateUnit(GetOwningPlayer(u),'E00H',GetUnitX(u),GetUnitY(u),0)
            set gg_unit_E00C_0217 = udg_H[GetConvertedPlayerId(GetOwningPlayer(u))]
            call UnitAddItemByIdSwapped('I006', udg_H[GetConvertedPlayerId(GetOwningPlayer(u))])
            call AddMoneyPercent(GetConvertedPlayerId(GetOwningPlayer(u)),0.1)
            call SetUnitManaPercentBJ(udg_H[GetConvertedPlayerId(GetOwningPlayer(u))],1000)
            call RemoveUnit(u)
            set u = udg_H[GetConvertedPlayerId(GetOwningPlayer(u))]
        endif
		if (IsHanshangSpin1(GetOwningPlayer(u))) then
			call UnitAddAbility(u,'A0KV')
			call AddDamagePercent(GetConvertedPlayerId(GetOwningPlayer(u)),0.08)
			return u
		else
			return u
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    初始化寒殇的技能
	*/
	function InitHanshang takes unit u returns nothing
		set hanshang = InitHanshangSpin(u)
		//1
	    set TSpellHanshang = CreateTrigger()
	    call TriggerRegisterAnyUnitEventBJ( TSpellHanshang, EVENT_PLAYER_UNIT_SPELL_EFFECT )
	    call TriggerAddCondition(TSpellHanshang, Condition(function TSpellHanshangCon))
	    call TriggerAddAction(TSpellHanshang, function TSpellHanshangAct)
	    //2
	    set TSpellHanshang2 = CreateTrigger()
	    call TriggerRegisterAnyUnitEventBJ( TSpellHanshang2, EVENT_PLAYER_UNIT_ATTACKED )
	    call TriggerAddCondition(TSpellHanshang2, Condition(function TSpellHanshang2Con))
	    call TriggerAddAction(TSpellHanshang2, function TSpellHanshang2Act)
	    //魔能等级低于5则减少受到的50%伤害
	    set TSpellHanshang3 = CreateTrigger()
	    call TriggerRegisterUnitEvent(TSpellHanshang3,hanshang,EVENT_UNIT_DAMAGED)
	    call TriggerAddCondition(TSpellHanshang3,Condition(function TSpellHanshang3Con))
	    call TriggerAddAction(TSpellHanshang3,function TSpellHanshang3Act)
	    //4
	    set TSpellHanshang4 = CreateTrigger()
	    call DisableTrigger(TSpellHanshang4)
	    call TriggerRegisterAnyUnitEventBJ( TSpellHanshang4, EVENT_PLAYER_UNIT_SPELL_ENDCAST )
	    call TriggerRegisterAnyUnitEventBJ( TSpellHanshang4, EVENT_PLAYER_UNIT_SPELL_FINISH )
	    call TriggerAddCondition(TSpellHanshang4, Condition(function TSpellHanshang4Con))
	    call TriggerAddAction(TSpellHanshang4, function TSpellHanshang4Act)
		call AddMoneyPercent(GetConvertedPlayerId(GetOwningPlayer(hanshang)),0.3)
		call TimerStart(CreateTimer(),CModeH(150,75),true,function GiveDiyu)
	endfunction
endlibrary
library_once Chenji requires SpellBase,Printer,Version,Attr,Spin
    globals
        /*
            受到伤害召唤鬼魂
        */
        private trigger TSpellChenji4 = null
        private real RDamage = 0
        private integer IYinduTimes = 0
    endglobals
//---------------------------------------------------------------------------------------------------
    /*
        吞天妖刺
    */
    private function TuntianyaociEffect takes real radius,integer count returns nothing
        local integer i = 1
        loop
            exitwhen i > count
            call CreateUnitEffect(GetOwningPlayer(chenji),'hh00',YDWECoordinateX(GetUnitX(chenji) + radius * CosBJ(i*(360/count))), YDWECoordinateY(GetUnitY(chenji) + radius * SinBJ(i*(360/count))),0)
            set i = i +1
        endloop
    endfunction
    function Tuntianyaoci takes nothing returns nothing
        local integer i = 1
        loop
            exitwhen i > 6
            call TuntianyaociEffect(300 * i, i * 2 + 2)
            set i = i +1
        endloop
        call PrintSpell(GetOwningPlayer(GetTriggerUnit()),"|cFFCCFF66吞天妖刺|r",GetDamageChenji(GetTriggerUnit())*3)
        call DamageArea(chenji,GetUnitX(chenji), GetUnitY(chenji),1800,GetDamageChenji(GetTriggerUnit())*3)
    endfunction
//---------------------------------------------------------------------------------------------------
    /*
        检测此时辰寂的生命
    */
    function ChenjiJiance takes nothing returns nothing
        local real percentThousand = (GetUnitState(chenji,UNIT_STATE_LIFE) * 1000.)/GetUnitState(chenji,UNIT_STATE_MAX_LIFE)
        if (UnitHasBuffBJ(chenji,'Bapl') or UnitHasBuffBJ(chenji,'Bpoi') or UnitHasBuffBJ(chenji,'Bpsd')) then
            call DisplayTextToPlayer(GetOwningPlayer(chenji), 0., 0., "|cFFFF66CC【消息】|r你拥有中毒BUFF.")
            return
        endif
        if (percentThousand < 10 and IsUnitAliveBJ(chenji) and not(BHeroDeath[GetConvertedPlayerId(GetOwningPlayer(chenji))])) then
            debug call SetChenji2SpinOK(GetOwningPlayer(chenji))
        endif
        call DisplayTextToPlayer(GetOwningPlayer(chenji), 0., 0., "|cFFFF66CC【消息】|r你当前的生命为千分之"+R2S(percentThousand)+".")
    endfunction
//---------------------------------------------------------------------------------------------------
    /*
        使用引渡的时间
    */
    function CountYindu takes nothing returns nothing
        if (IYinduTimes >= 7) then
            debug call SetChenji1SpinOK(GetOwningPlayer(chenji))
        else
            set IYinduTimes = IYinduTimes + 1
        endif
    endfunction
//---------------------------------------------------------------------------------------------------
    /*
        给英雄小无敌
    */
    /*function Yeaiwudi takes nothing returns nothing
        if (BJuexing3[GetConvertedPlayerId(GetOwningPlayer(chenji))]) then

            call ImmuteDamageInterval(chenji,3)
            call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Human\\Resurrect\\ResurrectCaster.mdl", GetUnitX(chenji), GetUnitY(chenji) ))
        endif
    endfunction*/
//---------------------------------------------------------------------------------------------------
    /*
        黑曜诅咒:召鬼魂
    */
    function TSpellChenji4Con takes nothing returns boolean
        return ((GetUnitStateSwap(UNIT_STATE_MANA, chenji) > 800.00) and (GetEventDamage() >= 1.) and (GetEventDamage() <= 100000000.00))
    endfunction
    function TSpellChenji4Act takes nothing returns nothing
        local unit u
        call DisableTrigger( GetTriggeringTrigger() )
        set RDamage = RDamage + GetEventDamage()
        if (RDamage >= GetUnitState(chenji,UNIT_STATE_MAX_LIFE) * 0.1) then
            set RDamage = 0
        else
            call EnableTrigger( GetTriggeringTrigger() )
            return
        endif
        set u = CreateUnit(GetOwningPlayer(chenji), 'h00P', YDWECoordinateX(( GetUnitX(chenji) + GetRandomReal(-300.00, 300.00) )), YDWECoordinateY(( GetUnitY(chenji) + GetRandomReal(-300.00, 300.00) )), 0.00)
        call DestroyEffect( AddSpecialEffect("Abilities\\Spells\\Undead\\RaiseSkeletonWarrior\\RaiseSkeleton.mdl", GetUnitX(u), GetUnitY(u)) )
        call UnitApplyTimedLifeBJ( 5.00, 'BTLF', u )
        set u = null
        call YDWEPolledWaitNull(0.50)
        call EnableTrigger( GetTriggeringTrigger() )
    endfunction
//---------------------------------------------------------------------------------------------------
    /*
        120剑灵大招:冥河
    */
    private function MingheTimer takes nothing returns nothing
        local timer t = GetExpiredTimer()
        local integer id = GetHandleId(t)
        local integer times = LoadInteger(spellTable,id,1)
        local real x = LoadReal(spellTable,id,2)
        local real y = LoadReal(spellTable,id,3)
        local integer i = 1
        local integer random = GetRandomInt(8,18)
        local unit u = null
        if (times <= 10) then
            call SaveInteger(spellTable,GetHandleId(t),1,times + 1)
            call DamageArea(chenji,x,y,600,GetDamageChenji(chenji)*8)
            call CreateUnitEffect(GetOwningPlayer(chenji),'h014',x,y,0)
            loop
                exitwhen i > random
                set u = CreateUnit(GetOwningPlayer(chenji),'h00J',x,y,i* (360 / random) )
                call UnitApplyTimedLifeBJ( 5, 'BHwe', u)
                set i = i +1
            endloop
        else
            call PauseTimer(t)
            call FlushChildHashtable(spellTable,id)
            call DestroyTimer(t)
        endif
        set t = null
        set u = null
    endfunction
    function ChenjiMinghe takes nothing returns nothing
        local timer t = CreateTimer()
        call SaveInteger(spellTable,GetHandleId(t),1,0)
        call SaveReal(spellTable,GetHandleId(t),2,GetSpellTargetX())
        call SaveReal(spellTable,GetHandleId(t),3,GetSpellTargetY())
        call TimerStart(t,1,true,function MingheTimer)
        call PrintSpellContent(GetOwningPlayer(chenji),GetAbilityName('A0G3'),I2S(R2I(GetDamageChenji(chenji)*0.8*RJ3(chenji,2,1)/100))+"万总伤害.")
        set t = null
    endfunction
//---------------------------------------------------------------------------------------------------
    /*
        英雄学习技能
    */
    //按照12345来判断
    function LearnSkillChenjiI takes unit learner,integer whichSpell returns nothing
        local integer i
        if (learner == chenji) then
            if (whichSpell == 4 and IsFourthSpellOK(chenji) == true and GetUnitAbilityLevel(chenji,'A0F8') == 1) then
                set TSpellChenji4 = CreateTrigger()
                call TriggerRegisterUnitEvent( TSpellChenji4, chenji, EVENT_UNIT_DAMAGED )
                call TriggerAddCondition(TSpellChenji4, Condition(function TSpellChenji4Con))
                call TriggerAddAction(TSpellChenji4, function TSpellChenji4Act)
            endif
        endif
    endfunction
    function LearnSkillChenji takes unit learner,integer learnSpellID returns nothing
        if (learner == chenji) then
            if (learnSpellID == 'A0F8') then
                call LearnSkillChenjiI(learner,4)
            endif
        endif
    endfunction
//---------------------------------------------------------------------------------------------------
    /*
        辰寂特效
    */
    private function InitChenjiSpin takes unit u returns unit
        if (IsChenjiSpin2(GetOwningPlayer(u))) then
            set udg_H[GetConvertedPlayerId(GetOwningPlayer(u))] = CreateUnit(GetOwningPlayer(u),'H01W',GetUnitX(u),GetUnitY(u),0)
            set gg_unit_Harf_0262 = udg_H[GetConvertedPlayerId(GetOwningPlayer(u))]
            call UnitAddItemByIdSwapped('stel', udg_H[GetConvertedPlayerId(GetOwningPlayer(u))])
            call UnitAddItemByIdSwapped('I006', udg_H[GetConvertedPlayerId(GetOwningPlayer(u))])
            call AddSpellPercent(GetConvertedPlayerId(GetOwningPlayer(u)),0.1)
            call SetUnitManaPercentBJ(udg_H[GetConvertedPlayerId(GetOwningPlayer(u))],1000)
            call RemoveUnit(u)
            set u = udg_H[GetConvertedPlayerId(GetOwningPlayer(u))]
        endif
        if (IsChenjiSpin1(GetOwningPlayer(u))) then
            call UnitAddAbility(u,'A0JS')
            call AddStrPercent(GetConvertedPlayerId(GetOwningPlayer(u)),0.1)
        endif
        return u
    endfunction
//---------------------------------------------------------------------------------------------------
    function InitChenji takes unit u returns nothing
        set chenji = InitChenjiSpin(u)
        call TriggerRegisterUnitEvent( gg_trg_____________132, chenji, EVENT_UNIT_DEATH )
        call TriggerRegisterUnitEvent( gg_trg_____________125, chenji, EVENT_UNIT_DAMAGED )
        call TriggerRegisterUnitEvent( gg_trg_____________130, chenji, EVENT_UNIT_DAMAGED )
    endfunction
endlibrary
/*
    英雄梦霁的技能
*/
library_once Cangling requires SpellBase,Printer,Attr,Aura,Spin
	globals
		/*
		    英雄
		*/
		/*
		    物品
		*/
		//item array IBibo(放到了LHBase)
		private boolean BiBo = false
		private trigger TSpellCangling = null
		private trigger TSpellCangling2 = null
		/*
		    光阴无梭
		*/
		private unit UGuang	= null
		private effect EGuang = null
		private real RGuang = 0.
		private integer IGuang = 10
		private timer TGuang = null
		/*
		    一气三化
		*/
		private unit UCangHuo = null
		private unit UCangFeng = null
		/*
		    贪狼芒曜
		*/
		private unit UTanlang = null
		/*
		    死亡复活的布尔
		*/
		private boolean array BWusuo
	endglobals
//---------------------------------------------------------------------------------------------------
	/*
	    判断单位是否是苍凌皮肤
	*/
	function IsCanglingSpin takes nothing returns boolean
		return GetUnitTypeId(cangling) == 'N023'
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    判断是否获得的装备的function
	*/
	function IsSwitchItemCangling takes unit u,item it returns boolean
		local integer i = I3(BiBo,7,1)
		if (u != cangling) then
			return true
		endif
		if not(IsItemPawnable(it)) then
			return true
		endif
		loop
			exitwhen i > I3(BiBo,12,6)
			if (it == IBibo[i]) then
				return false
			endif
			set i = i +1
		endloop
		return true
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    显示所有装备
	*/
	/*function ShowAllZhuangbei takes nothing returns nothing
		local integer i = 1
		loop
			exitwhen i > 12
			if (IBibo[i] == null) then
				call BJDebugMsg("第"+I2S(i)+"格: null")
			else
				call BJDebugMsg("第"+I2S(i)+"格:"+GetItemName(IBibo[i]))
			endif
			set i = i +1
		endloop
	endfunction*/
//---------------------------------------------------------------------------------------------------
	/*
	    碧波宝镯：切换装备栏
	*/
	private function BiBoBaoZhuo takes nothing returns nothing
		local integer i = 1
		local integer ii = 1
		local integer iii
		local integer iiii = 1
		local item temp = null
		//判断是否有不可丢弃的法魂
		loop
			exitwhen iiii > 6
			if (IsZhanfahun(UnitItemInSlotBJ(cangling,iiii)) and not(IsItemPawnable(UnitItemInSlotBJ(cangling,iiii)))) then
				call DisplayTextToPlayer(GetOwningPlayer(cangling), 0., 0., "|cFFFF66CC【消息】|r战魂与法魂冷却期间不能切换装备栏,请等冷却结束.")
				return
			endif
			set iiii = iiii + 1
		endloop
		//保存装备
		loop
			exitwhen i > 6
			set IBibo[i + I3(BiBo,6,0)] = UnitItemInSlotBJ(cangling,i)
			set i = i +1
		endloop
		//丢弃装备
		loop
			exitwhen ii > 6
			set temp = UnitItemInSlotBJ(cangling,ii)
			//call UnitRemoveItemSwapped(temp,mengji)
			call SetItemPosition(temp,0,0)
			call SetItemVisible(temp,false)
			set ii = ii + 1
		endloop
		set BiBo = not(BiBo)
		//获得装备
		set iii = I3(BiBo,7,1)
		loop
			exitwhen iii > I3(BiBo,12,6)
			call UnitAddItem(cangling,IBibo[iii])
			set IBibo[iii] = null
			set iii = iii +1
		endloop
		set temp = null
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    碧波宝镯：生命效果
	*/
	private function BiBoBaoZhuoTimer takes nothing returns nothing
		if (IsUnitAliveBJ(cangling)) then
			if (GetUnitState(cangling,UNIT_STATE_LIFE) < (0.05 + RJ1(cangling,0.05,0) + RJ2(cangling,0.05,0)) * GetUnitState(cangling,UNIT_STATE_MAX_LIFE)) then
				call SetUnitLifePercentBJ(cangling,10)
			endif
		endif
		if (IsUnitAliveBJ(UCangFeng)) then
			if (GetUnitState(UCangFeng,UNIT_STATE_LIFE) < (0.05 + RJ1(cangling,0.05,0) + RJ2(cangling,0.05,0)) * GetUnitState(UCangFeng,UNIT_STATE_MAX_LIFE)) then
				call SetUnitLifePercentBJ(UCangFeng,10)
			endif
		endif
		if (IsUnitAliveBJ(UCangHuo)) then
			if (GetUnitState(UCangHuo,UNIT_STATE_LIFE) < (0.05 + RJ1(cangling,0.05,0) + RJ2(cangling,0.05,0)) * GetUnitState(UCangHuo,UNIT_STATE_MAX_LIFE)) then
				call SetUnitLifePercentBJ(UCangHuo,10)
			endif
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    马甲的攻击伤害
	*/
	function SimulateDamageCangling takes unit u returns boolean
		if (GetUnitTypeId(u) == 'h00V') then
			call UnitDamageTarget( cangling, GetTriggerUnit(), GetDamageAgi(cangling) * 0.33, false, true, ATTACK_TYPE_MAGIC, DAMAGE_TYPE_MAGIC, WEAPON_TYPE_WHOKNOWS )
			if (IsUnitDeadBJ(GetTriggerUnit())) then
				call SetUnitUserData(GetEventDamageSource(),GetUnitUserData(GetEventDamageSource())+1)
				if (GetUnitUserData(GetEventDamageSource()) >= 750) then
					debug call SetCanglingSpinOK(GetOwningPlayer(cangling))
				endif
			endif
			return true
		endif
		if (GetUnitTypeId(u) == 'h00W') then
			call UnitDamageTarget( cangling, GetTriggerUnit(), GetDamageAgi(cangling) * 0.35, false, true, ATTACK_TYPE_MAGIC, DAMAGE_TYPE_MAGIC, WEAPON_TYPE_WHOKNOWS )
			return true
		endif
		if (GetUnitTypeId(u) == 'h00Y') then
			call SimulateSpell(GetEventDamageSource(),GetTriggerUnit(),'A0HU',1,5,"hex",false,false,true)
			return true
		endif
		return false
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    不灭真炎
	*/
	private function BuMieZhenYanTimer takes nothing returns nothing
		local timer t = GetExpiredTimer()
		local integer id = GetHandleId(t)
		local unit u = LoadUnitHandle(spellTable,id,1)
		local texttag tt = LoadTextTagHandle(spellTable,id,2)
		local integer value = GetUnitUserData(u) - 1
		if (value > 0) then
			call SetTextTagTextBJ(tt,I2S(value) + "秒",20)
			call SetUnitUserData(u,value)
		else
			call RemoveUnit(u)
			call DestroyTextTag(tt)
			call PauseTimer(t)
			call FlushChildHashtable(spellTable,id)
			call DestroyTimer(t)
		endif
		set u = null
		set t = null
		set tt = null
	endfunction
	private function BuMieZhenYan takes integer lifeTime,integer abilityID,real x,real y returns nothing
		local real damage = GetDamageAgi(cangling) * 0.4
		local timer t = CreateTimer()
		local unit u = CreateUnit(GetOwningPlayer(cangling),'h00V',x,y,270)
		call SetUnitUserData(u,lifeTime + I3(IsCanglingSpin(),1,0))
		call SaveUnitHandle(spellTable,GetHandleId(t),1,u)
		call SaveTextTagHandle(spellTable,GetHandleId(t),2,CreateTextTagUnitBJ( I2S(lifeTime + I3(IsCanglingSpin(),1,0))+"秒", u, 0, 20, 100, 0, 100, 0 ))
		call TimerStart(t,1,true,function BuMieZhenYanTimer)
	    call PrintSpell(GetOwningPlayer(cangling),GetAbilityName(abilityID),damage)
	    set u = null
		set t = null
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    联结谛盟
	*/
	private function LianJieDiMeng takes nothing returns nothing
		call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Human\\ReviveHuman\\ReviveHuman.mdl", GetUnitX(cangling), GetUnitY(cangling) ))
	    call PrintSpellContent(GetOwningPlayer(cangling),GetAbilityName('A0HJ'),"结盟成功！")
    	call SetPlayerAllianceStateBJ( Player(11), GetOwningPlayer(cangling), bj_ALLIANCE_ALLIED_VISION )
    	call SetPlayerAllianceStateBJ( Player(10), GetOwningPlayer(cangling), bj_ALLIANCE_ALLIED_VISION )
    	call ImmuteDamageInterval(cangling,1)
    	call YDWEPolledWaitNull(10)
    	call SetPlayerAllianceStateBJ( Player(11), GetOwningPlayer(cangling), bj_ALLIANCE_UNALLIED )
    	call SetPlayerAllianceStateBJ( Player(10), GetOwningPlayer(cangling), bj_ALLIANCE_UNALLIED )
		call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Human\\ReviveHuman\\ReviveHuman.mdl", GetUnitX(cangling), GetUnitY(cangling) ))
	    call PrintSpellContent(GetOwningPlayer(cangling),GetAbilityName('A0HJ'),"结盟结束！")
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    A出不灭真炎
	*/
	private function TSpellCangling2Con takes nothing returns boolean
		return (GetAttacker() == cangling or (GetAttacker() == UCangFeng and UCangFeng != null) or (GetAttacker() == UCangHuo and UCangHuo != null)) and IsSecondSpellOK(cangling) == true and GetUnitState(cangling,UNIT_STATE_MANA) >= 250 and GetUnitAbilityLevel(cangling,'A0HJ') == 1 and GetRandomInt(1,20) == 1
	endfunction
	private function TSpellCangling2Act takes nothing returns nothing
		call DisableTrigger(GetTriggeringTrigger())
		call BuMieZhenYan(2,'A0HJ',GetUnitX(GetAttackedUnitBJ()),GetUnitY(GetAttackedUnitBJ()))
		call YDWEPolledWaitNull(5)
		call EnableTrigger(GetTriggeringTrigger())
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    光阴无梭
	*/
	private function DestroyGuangYin takes nothing returns nothing
		if (TGuang != null) then
			call PauseTimer(TGuang)
			call DestroyTimer(TGuang)
			set TGuang = null
		endif
		if (EGuang != null) then
			call DestroyEffect(EGuang)
			set EGuang = null
		endif
		set UGuang = null
		set RGuang = 0.
		set IGuang = 0
	endfunction
	private function GuangYinWuSuoTimer takes nothing returns nothing
		set IGuang = IGuang - 1
		if (IsUnitAliveBJ(UGuang) and IGuang > 0) then
			call UnitDamageTarget( cangling, UGuang, GetDamageAgi(cangling) * RGuang, false, true, ATTACK_TYPE_MAGIC, DAMAGE_TYPE_MAGIC, WEAPON_TYPE_WHOKNOWS )
	    	call CreateSpellTextTag(I2S(R2I(RGuang * 100))+"%X!",UGuang,0,100,0,4)
		else
			call DestroyGuangYin()
		endif
	endfunction
	private function GuangYinWuSuo takes nothing returns nothing
		if (UGuang != GetSpellTargetUnit()) then
			call DestroyGuangYin()
			set UGuang = GetSpellTargetUnit()
		endif
		set RGuang = R3(RGuang == 0.,0.3,RGuang + 0.1)
		set IGuang = 10
		if (TGuang == null) then
			set TGuang = CreateTimer()
			call TimerStart(TGuang,1,true,function GuangYinWuSuoTimer)
		endif
		if (EGuang == null) then
			set EGuang = AddSpecialEffectTargetUnitBJ("head",GetSpellTargetUnit(),"Abilities\\Spells\\NightElf\\shadowstrike\\shadowstrike.mdl")
		endif
	    call PrintSpellContent(GetOwningPlayer(cangling),GetAbilityName('A0HK'),"百分比伤害"+I2S(R2I(RGuang * 100))+"%!")
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    光阴无梭的光环效果
	*/
    private function GuangyinResetTimer takes nothing returns nothing
    	local timer t = GetExpiredTimer()
    	local integer id = GetHandleId(t)
    	local integer pID = LoadInteger(spellTable,id,1)
    	set BWusuo[pID] = false
		call PauseTimer(t)
		call FlushChildHashtable(spellTable,id)
		call DestroyTimer(t)
    	set t = null
    endfunction
    private function StartTimerGuangyin takes unit u returns nothing
    	local timer t = CreateTimer()
	    call SaveInteger(spellTable,GetHandleId(t),1,GetConvertedPlayerId(GetOwningPlayer(u)))
	    call TimerStart(t,42,false,function GuangyinResetTimer)
	    set t = null
    endfunction
	function IsGuangyinRevive takes nothing returns boolean
		if (GetUnitAbilityLevel(gg_unit_n01S_0258,'A0HR') == 1 and not(BWusuo[GetConvertedPlayerId(GetOwningPlayer(GetDyingUnit()))])) then
			set BWusuo[GetConvertedPlayerId(GetOwningPlayer(GetDyingUnit()))] = true
			call BJDebugMsg("|cFFFF66CC【消息】|r"+GetPlayerName(GetOwningPlayer(GetDyingUnit()))+"被"+GetUnitName(GetKillingUnitBJ())+"干掉了，被|cff808000光阴无梭|r救起,等待3秒原地复活.")
		    call YDWEPolledWaitNull(3.00)
		    call StartTimerGuangyin(GetDyingUnit())
		    call ReviveHero( GetDyingUnit(), GetUnitX(GetDyingUnit()), GetUnitY(GetDyingUnit()) , true )
		    call SetUnitManaBJ( GetDyingUnit(), 0.5 * GetUnitState(GetDyingUnit(),UNIT_STATE_MAX_MANA) )
			return true
		else
			return false
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    紫雷护体
	*/
	private function ZiLeiHuTi takes nothing returns nothing
		if (UCangFeng != null) then
			if (IsUnitAliveBJ(UCangFeng)) then
	    		call DamageArea(cangling,GetUnitX(UCangFeng),GetUnitY(UCangFeng),450,GetDamageAgi(cangling) * 0.2)
			endif
		else
		    call PauseTimer(GetExpiredTimer())
		    call DestroyTimer(GetExpiredTimer())
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    阳炎无双
	*/
	private function YangYanWuShuang takes nothing returns nothing
		local group l_group = YDWEGetUnitsOfTypeIdAllNull('h00V')
		local unit l_unit = null
		call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Other\\Doom\\DoomDeath.mdl", GetUnitX(GetSpellAbilityUnit()), GetUnitY(GetSpellAbilityUnit()) ))
		loop
		    set l_unit = FirstOfGroup(l_group)
		    exitwhen l_unit == null
		    call GroupRemoveUnit(l_group, l_unit)
	    	call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Other\\Doom\\DoomDeath.mdl", GetUnitX(l_unit), GetUnitY(l_unit) ))
			call SetUnitUserData(l_unit,GetUnitUserData(l_unit) + 6)
		endloop
		call DestroyGroup(l_group)
		set l_group = null
		set l_unit =null
	    call PrintSpellContent(GetOwningPlayer(cangling),GetAbilityName('A0HS'),"成功续命6秒！")
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    一气三化
	*/
	private function YiQiSanHuaTimer takes nothing returns nothing
	    call PrintSpellContent(GetOwningPlayer(cangling),GetAbilityName('A0HL'),"技能时间结束！")
	    call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Undead\\FrostNova\\FrostNovaTarget.mdl", GetUnitX(UCangFeng), GetUnitY(UCangFeng) ))
	    call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Other\\Doom\\DoomDeath.mdl", GetUnitX(UCangHuo), GetUnitY(UCangHuo) ))
	    call FlushChildHashtable(YDHT,GetHandleId(UCangFeng))
	    call FlushChildHashtable(YDHT,GetHandleId(UCangHuo))
	    call RemoveUnit(UCangFeng)
	    call RemoveUnit(UCangHuo)
	    set UCangHuo = null
	    set UCangFeng = null
	    call PauseTimer(GetExpiredTimer())
	    call DestroyTimer(GetExpiredTimer())
	endfunction
	private function YiQiSanHua takes nothing returns nothing
	    call PrintSpellName(GetOwningPlayer(cangling),GetAbilityName('A0HL'))
	    set UCangFeng = CreateUnit(GetOwningPlayer(cangling),'Ogld',YDWECoordinateX(GetUnitX(cangling) + GetRandomReal(-200,200)),YDWECoordinateY(GetUnitY(cangling) + GetRandomReal(-200,200)),0)
	    call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Undead\\FrostNova\\FrostNovaTarget.mdl", GetUnitX(UCangFeng), GetUnitY(UCangFeng) ))
	    call SetHeroInt(UCangFeng,GetHeroInt(cangling,true),true)
	    call SetHeroAgi(UCangFeng,GetHeroAgi(cangling,true),true)
	    call SetHeroStr(UCangFeng,GetHeroStr(cangling,true),true)
	    call SetHeroLevel(UCangFeng,GetHeroLevel(cangling),false)
	    call SelectHeroSkill( UCangFeng, 'A0HI' )
	    call SelectHeroSkill( UCangFeng, 'A0HJ' )
	    call SelectHeroSkill( UCangFeng, 'A0HK' )
	    call SetAttack(UCangFeng,GetAttack(cangling))
	    call SetDefense(UCangFeng,GetDefense(cangling))
	    call SetHP(UCangFeng,GetHP(cangling))
	    set UCangHuo = CreateUnit(GetOwningPlayer(cangling),'Orex',YDWECoordinateX(GetUnitX(cangling) + GetRandomReal(-200,200)),YDWECoordinateY(GetUnitY(cangling) + GetRandomReal(-200,200)),0)
	    call SetHeroInt(UCangHuo,GetHeroInt(cangling,true),true)
	    call SetHeroAgi(UCangHuo,GetHeroAgi(cangling,true),true)
	    call SetHeroStr(UCangHuo,GetHeroStr(cangling,true),true)
	    call SetHeroLevel(UCangHuo,GetHeroLevel(cangling),false)
	    call SelectHeroSkill( UCangHuo, 'A0HI' )
	    call SelectHeroSkill( UCangHuo, 'A0HJ' )
	    call SelectHeroSkill( UCangHuo, 'A0HK' )
	    call SetAttack(UCangHuo,GetAttack(cangling))
	    call SetDefense(UCangHuo,GetDefense(cangling))
	    call SetHP(UCangHuo,GetHP(cangling))
	    call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Other\\Doom\\DoomDeath.mdl", GetUnitX(UCangHuo), GetUnitY(UCangHuo) ))
		call TimerStart(CreateTimer(),120,false,function YiQiSanHuaTimer)
		call TimerStart(CreateTimer(),1,true,function ZiLeiHuTi)
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    创建贪狼星
	*/
	private function CreateTanlang takes nothing returns nothing
		local integer i = GetRandomInt(1,3)
		local integer ty = 0
		local real x = YDWECoordinateX(GetUnitX(UTanlang) + GetRandomReal(-400,400))
		local real y = YDWECoordinateY(GetUnitY(UTanlang) + GetRandomReal(-400,400))
		local unit u = null
		if (i == 1) then
			set ty = 'h00W'
		elseif (i == 2) then
			set ty = 'h00Y'
		else
			set ty = 'h00Z'
		endif
		set u = CreateUnit(GetOwningPlayer(cangling),ty,x,y,GetRandomReal(0,360))
		call UnitApplyTimedLifeBJ( 10, 'BHwe', u )
		call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Human\\MassTeleport\\MassTeleportTarget.mdl", GetUnitX(u), GetUnitY(u) ))
		set u = null
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    贪狼芒曜
	*/
	private function TanLangMangYaoTimer takes nothing returns nothing
		local timer t = GetExpiredTimer()
		local integer id = GetHandleId(t)
		local integer i = LoadInteger(spellTable,id,1)
		if (i > 0) then
			call SaveInteger(spellTable,id,1,i - 1)
			call CreateTanlang()
		else
			call PauseTimer(t)
			call FlushChildHashtable(spellTable,id)
			call DestroyTimer(t)
	    	call PrintSpellContent(GetOwningPlayer(cangling),GetAbilityName('A0HM'),"技能时间结束！")
		endif
		set t = null
	endfunction
	/*
	    对传送门的旋转
	*/
	private function TanLangMangYaoRotateTimer takes nothing returns nothing
		if (IsUnitAliveBJ(UTanlang)) then
			call SetUnitFacing(UTanlang,ModuloReal(GetUnitFacing(UTanlang)+7.2,360))
		else
			call PauseTimer(GetExpiredTimer())
			call DestroyTimer(GetExpiredTimer())
			set UTanlang = null
		endif
	endfunction
	private function TanLangMangYao takes nothing returns nothing
		local timer t = CreateTimer()
		set UTanlang = CreateUnit(GetOwningPlayer(cangling),'h013',GetUnitX(cangling),GetUnitY(cangling),0)
		call UnitApplyTimedLifeBJ( 25, 'BHwe',UTanlang )
		call SaveInteger(spellTable,GetHandleId(t),1,15)
		call TimerStart(t,1,true,function TanLangMangYaoTimer)
		call TimerStart(CreateTimer(),0.05,true,function TanLangMangYaoRotateTimer)
    	call PlaySoundBJ( gg_snd_cangling_5 )
		set t = null
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    主英雄技能判断
	*/
	private function TSpellCanglingCon takes nothing returns boolean
		return GetOwningPlayer(GetSpellAbilityUnit()) == GetOwningPlayer(cangling)
	endfunction
	private function TSpellCanglingAct takes nothing returns nothing
		if (GetSpellAbilityId() == 'A0HI') then
			call BuMieZhenYan(5,GetSpellAbilityId(),GetSpellTargetX(),GetSpellTargetY())
		elseif (GetSpellAbilityId() == 'A0HJ' and GetSpellAbilityUnit() == cangling) then
			call LianJieDiMeng()
		elseif (GetSpellAbilityId() == 'A0HK') then
			call GuangYinWuSuo()
		elseif (GetSpellAbilityId() == 'A0HL') then
			call YiQiSanHua()
		elseif (GetSpellAbilityId() == 'A0HM') then
			call TanLangMangYao()
		//切换背包
		elseif (GetSpellAbilityId() == 'A0HH') then
			if (IsInRect(GetUnitX(cangling),GetUnitY(cangling),gg_rct_______a3) and IsInRect(GetUnitX(cangling),GetUnitY(cangling),gg_rct_______a3)) then
				call DisplayTextToPlayer(GetOwningPlayer(cangling), 0., 0., "|cFFFF66CC【消息】|r此处禁止切换背包.")
			else
				call BiBoBaoZhuo()
			endif
		//阳炎无双
		elseif (GetSpellAbilityId() == 'A0HS') then
			call YangYanWuShuang()
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    英雄学习技能
	*/
	//按照12345来判断
	function LearnSkillCanglingI takes unit learner,integer whichSpell returns nothing
		local integer i
		if (learner == cangling) then
			if (whichSpell == 3 and IsThirdSpellOK(cangling) == true and GetUnitAbilityLevel(cangling,'A0HK') == 1) then
				//技能3初始化
				call AddSpecialEffectTargetUnitBJ("origin",cangling,"war3mapImported\\yanbao.mdl")
				call InitCanglingAura()
			endif
		endif
	endfunction
	function LearnSkillCangling takes unit learner,integer learnSpellID returns nothing
		if (learner == cangling) then
			if (learnSpellID == 'A0HI') then
				call LearnSkillCanglingI(learner,1)
			elseif (learnSpellID == 'A0HJ') then
				call LearnSkillCanglingI(learner,2)
			elseif (learnSpellID == 'A0HK') then
				call LearnSkillCanglingI(learner,3)
			elseif (learnSpellID == 'A0HL') then
				call LearnSkillCanglingI(learner,4)
			elseif (learnSpellID == 'A0HM') then
				call LearnSkillCanglingI(learner,5)
			endif
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    初始化皮肤
	*/
	private function InitCanglingSpin takes unit u returns unit
		if (IsCanglingSpin1(GetOwningPlayer(u))) then
			set udg_H[GetConvertedPlayerId(GetOwningPlayer(u))] = CreateUnit(GetOwningPlayer(u),'N023',GetUnitX(u),GetUnitY(u),0)
			set gg_unit_Nsjs_0209 = udg_H[GetConvertedPlayerId(GetOwningPlayer(u))]
			call UnitAddItemByIdSwapped('I006', udg_H[GetConvertedPlayerId(GetOwningPlayer(u))])
			call SetUnitManaPercentBJ(udg_H[GetConvertedPlayerId(GetOwningPlayer(u))],1000)
			call RemoveUnit(u)
			return udg_H[GetConvertedPlayerId(GetOwningPlayer(u))]
		else
			return u
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    初始化苍凌
	*/
	function InitCangling takes unit u returns nothing
		set cangling = InitCanglingSpin(u)
	    //英雄第二个技能攻击事件
	    set TSpellCangling2 = CreateTrigger()
	    call TriggerRegisterAnyUnitEventBJ(TSpellCangling2,EVENT_PLAYER_UNIT_ATTACKED)
	    call TriggerAddCondition(TSpellCangling2, Condition(function TSpellCangling2Con))
	    call TriggerAddAction(TSpellCangling2, function TSpellCangling2Act)
	    //苍凌的所有技能
		set TSpellCangling = CreateTrigger()
	    call TriggerRegisterAnyUnitEventBJ(TSpellCangling,EVENT_PLAYER_UNIT_SPELL_EFFECT)
	    call TriggerAddCondition(TSpellCangling, Condition(function TSpellCanglingCon))
	    call TriggerAddAction(TSpellCangling, function TSpellCanglingAct)
	    call TimerStart(CreateTimer(),0.05,true,function BiBoBaoZhuoTimer)
	endfunction
endlibrary
library_once Xiaoyue requires LHBase,Spin,Version
	globals
		private integer IFuhuo
	endglobals
//---------------------------------------------------------------------------------------------------
	/*
	    阵内复活的人数
	*/
	function IncreaseZhenfuhuo takes nothing returns nothing
		debug if (IFuhuo < 150) then
			debug set IFuhuo = IFuhuo + 1
		debug elseif (IFuhuo == 150) then
			debug call SetXiaoyueSpinOK(GetOwningPlayer(xiaoyue))
		debug endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    判断单位是否是晓月皮肤
	*/
	function IsXiaoyueSpin takes nothing returns boolean
		return GetUnitTypeId(xiaoyue) == 'U001'
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    晓月皮肤
	*/
	private function InitXiaoyueSpin takes unit u returns unit
		if (IsXiaoyueSpin1(GetOwningPlayer(u))) then
			set udg_H[GetConvertedPlayerId(GetOwningPlayer(u))] = CreateUnit(GetOwningPlayer(u),'U001',GetUnitX(u),GetUnitY(u),0)
			call UnitAddItemByIdSwapped('I006', udg_H[GetConvertedPlayerId(GetOwningPlayer(u))])
			call SetUnitManaPercentBJ(udg_H[GetConvertedPlayerId(GetOwningPlayer(u))],100)
			call RemoveUnit(u)
			return udg_H[GetConvertedPlayerId(GetOwningPlayer(u))]
		else
			return u
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	function InitXiaoyue takes unit u returns nothing
		set IFuhuo = 0
		set xiaoyue = InitXiaoyueSpin(u)
	endfunction
endlibrary
///#include  "edit/Pet.j"
/*
    英雄司宸的技能
*/
library_once Sichen requires SpellBase,Printer,Attr,Pet,Aura
	globals
		//触发器
		private trigger TSpellSichen = null
		private trigger TSpellSichen2 = null
		private trigger TSpellSichen3 = null
		private trigger TSpellSichenDamage = null
		private trigger TSpellSichenBuilding = null
		private trigger TSpellSichenUpdate = null
		//塔的单位组
		private group GTower = null
		private unit UCili = null
		private real SichenDamage = 0
	endglobals
//---------------------------------------------------------------------------------------------------
	/*
	    全加金钱获得率
	*/
	private function AddAllMoney takes real value returns nothing
		local integer i = 1
		loop
			exitwhen i > 6
	        if ((GetPlayerSlotState(ConvertedPlayer(i)) == PLAYER_SLOT_STATE_PLAYING) and (GetPlayerController(ConvertedPlayer(i)) == MAP_CONTROL_USER)) then
	            call AddMoneyPercent(i,value)
	        endif
			set i = i +1
		endloop
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    全加金钱获得率
	*/
	private function AddAll3W takes real value returns nothing
		local integer i = 1
		loop
			exitwhen i > 6
	        if ((GetPlayerSlotState(ConvertedPlayer(i)) == PLAYER_SLOT_STATE_PLAYING) and (GetPlayerController(ConvertedPlayer(i)) == MAP_CONTROL_USER)) then
                call AddIntPercent(i,value)
                call AddAgiPercent(i,value)
                call AddStrPercent(i,value)
	        endif
			set i = i +1
		endloop
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    无敌条件与无敌的动作
	*/
	private function CloserWudiTowerCon takes nothing returns boolean
		return GetTriggerUnit() == udg_H[GetConvertedPlayerId(GetOwningPlayer(GetTriggerUnit()))]
	endfunction
	private function CloserWudiTowerAct takes nothing returns nothing
		local unit u = LoadUnitHandle(spellTable,GetHandleId(GetTriggeringTrigger()),1)
		if (GetUnitState(u,UNIT_STATE_MANA) > 1333 and not(IsWudi(GetTriggerUnit()))) then
			call ImmuteDamageInterval(GetTriggerUnit(),3)
			call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Human\\Resurrect\\ResurrectCaster.mdl", GetUnitX(GetTriggerUnit()), GetUnitY(GetTriggerUnit()) ))
			call RecoverUnitMP(u,- 1333 )
		endif
		set u = null
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    初始化无敌光环
	*/
	private function InitWudi takes unit u returns nothing
		local trigger t = CreateTrigger()
	    call TriggerRegisterUnitInRangeSimple(t,100,u)
	    call TriggerAddCondition(t,Condition(function CloserWudiTowerCon))
	    call TriggerAddAction(t,function CloserWudiTowerAct)
	    call SaveUnitHandle(spellTable,GetHandleId(t),1,u)
	    call SaveTriggerHandle(spellTable,GetHandleId(u),1,t)
		set t = null
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    删除无敌光环
	*/
	private function DestroyWudi takes unit u returns nothing
		local trigger t = LoadTriggerHandle(spellTable,GetHandleId(u),1)
		call FlushChildHashtable(spellTable,GetHandleId(t))
		call DestroyTrigger(t)
		call FlushChildHashtable(spellTable,GetHandleId(u))
		set t = null
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    马甲的死亡
	*/
	function SimulateDeathSichen takes unit u returns nothing
		if (IsUnitInGroup(u,GTower)) then
			if (GetUnitTypeId(GetDyingUnit()) == 'h0s2') then
				call DestroyEffect(LoadEffectHandle(spellTable,GetHandleId(GetDyingUnit()),1))
				call FlushChildHashtable(spellTable,GetHandleId(GetDyingUnit()))
			elseif (GetUnitTypeId(GetDyingUnit()) == 'h1s3') then
    			call AddAllMoney(-0.1)
			elseif (GetUnitTypeId(GetDyingUnit()) == 'h01F') then
    			call AddAll3W(-0.02)
			elseif (GetUnitTypeId(GetDyingUnit()) == 'h1s6') then
				call DestroyWudi(GetDyingUnit())
			elseif (GetUnitTypeId(GetDyingUnit()) == 'h1s7') then
    			call AddAllMoney(-0.1)
    			call AddAll3W(-0.02)
				call DestroyWudi(GetDyingUnit())
			endif
			call GroupRemoveUnit(GTower,u)
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    获取英雄的攻击
	*/
	private function GetSichenAttack takes nothing returns integer
		return GetHeroInt(sichen,true) + GetAttack(sichen)
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    获取英雄的生命
	*/
	private function GetSichenHP takes nothing returns integer
		return GetHeroStr(sichen,true) * 10 + GetHP(sichen)
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    获取英雄的防御
	*/
	private function GetSichenDefense takes nothing returns integer
		return GetHeroAgi(sichen,true)/100 + GetDefense(sichen)
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    初始化黑洞
	*/
	private function InitHeidong takes unit u returns nothing
	    local Attract attract = Attract.create(u,900,0.05,15)
		call attract.SetForbitHero()
		call attract.start()
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    建造完毕
	*/
	function TSichenBuildingCon takes nothing returns boolean
		return GetOwningPlayer(GetTriggerUnit()) == GetOwningPlayer(sichen)
	endfunction
	function TSichenBuildingUpdate takes nothing returns nothing
    	local unit u = GetTriggerUnit()
    	call UnitSetUpgradeProgress( GetTriggerUnit(), 100 )
    	if (GetUnitTypeId(u) == 'h0s3') then
			call SetDefense(u,GetSichenDefense()*4)
			call SetHP(u,GetSichenHP()*3)
			if (IsThirdSpellOK(sichen) == true and GetUnitAbilityLevel(sichen,'A0IS') == 1) then
				call UnitAddAbility(u,'A0HG')
			endif
    	elseif (GetUnitTypeId(u) == 'h0s6') then
			call SetDefense(u,GetSichenDefense()*5)
			call SetHP(u,GetSichenHP()*5)
			call SetAttack(u,GetSichenAttack()*5)
			if (IsThirdSpellOK(sichen) == true and GetUnitAbilityLevel(sichen,'A0IS') == 1) then
				call UnitAddAbility(u,'A0HG')
			endif
    	elseif (GetUnitTypeId(u) == 'h01C') then
			call SetDefense(u,GetSichenDefense())
			call SetHP(u,GetSichenHP())
			call SetAttack(u,GetSichenAttack() * 5)
			if (IsThirdSpellOK(sichen) == true and GetUnitAbilityLevel(sichen,'A0IS') == 1) then
				call UnitAddAbility(u,'A0HG')
			endif
    	elseif (GetUnitTypeId(u) == 'h0s2') then
			call SetDefense(u,GetSichenDefense())
			call SetHP(u,GetSichenHP())
			call SaveEffectHandle(spellTable,GetHandleId(u),1,AddSpecialEffectTargetUnitBJ("chest",u,"war3mapImported\\IceTornado.mdx"))
			if (IsThirdSpellOK(sichen) == true and GetUnitAbilityLevel(sichen,'A0IS') == 1) then
				call UnitAddAbility(u,'A0HG')
			endif
    	elseif (GetUnitTypeId(u) == 'h0s1') then
			call SetDefense(u,GetSichenDefense())
			call SetHP(u,GetSichenHP())
			call SetAttack(u,GetSichenAttack()*5)
			if (IsThirdSpellOK(sichen) == true and GetUnitAbilityLevel(sichen,'A0IS') == 1) then
				call UnitAddAbility(u,'A0HG')
			endif
    	elseif (GetUnitTypeId(u) == 'h0s5') then
			call SetDefense(u,GetSichenDefense()*2)
			call SetHP(u,GetSichenHP()*2)
			call SetAttack(u,GetSichenAttack()*2)
			if (IsThirdSpellOK(sichen) == true and GetUnitAbilityLevel(sichen,'A0IS') == 1) then
				call UnitAddAbility(u,'A0HG')
			endif
    	elseif (GetUnitTypeId(u) == 'h0s8') then
			call SetDefense(u,GetSichenDefense()*4)
			call SetHP(u,GetSichenHP()*4)
			call SetAttack(u,GetSichenAttack()*5)
			if (IsThirdSpellOK(sichen) == true and GetUnitAbilityLevel(sichen,'A0IS') == 1) then
				call UnitAddAbility(u,'A0HG')
			endif
    	elseif (GetUnitTypeId(u) == 'h0s4') then
			call SetHP(u,GetSichenHP()*2)
			call SetAttack(u,GetSichenAttack())
			call SetDefense(u,GetSichenDefense())
			if (IsThirdSpellOK(sichen) == true and GetUnitAbilityLevel(sichen,'A0IS') == 1) then
				call UnitAddAbility(u,'A0HG')
			endif
    	elseif (GetUnitTypeId(u) == 'h0s7') then
			call SetDefense(u,GetSichenDefense())
			call SetHP(u,GetSichenHP())
			call SetAttack(u,GetSichenAttack())
			if (IsThirdSpellOK(sichen) == true and GetUnitAbilityLevel(sichen,'A0IS') == 1) then
				call UnitAddAbility(u,'A0HG')
			endif
    	elseif (GetUnitTypeId(u) == 'h1s1') then
    		call InitHeidong(u)
			call SetDefense(u,GetSichenDefense())
			call SetHP(u,GetSichenHP())
			if (IsThirdSpellOK(sichen) == true and GetUnitAbilityLevel(sichen,'A0IS') == 1) then
				call UnitAddAbility(u,'A0HG')
			endif
    	elseif (GetUnitTypeId(u) == 'h1s3') then
    		call AddAllMoney(0.1)
    	elseif (GetUnitTypeId(u) == 'h01F') then
    		call AddAll3W(0.02)
    	elseif (GetUnitTypeId(u) == 'h1s6') then
    		call InitWudi(u)
    	elseif (GetUnitTypeId(u) == 'h1s7') then
    		call AddAllMoney(0.1)
    		call AddAll3W(0.02)
    		call InitWudi(u)
    	endif
    	set u = null
	endfunction
    function TSichenBuilding takes nothing returns nothing
    	local unit u = GetTriggerUnit()
    	call GroupAddUnit(GTower,u)
    	if (GetUnitTypeId(u) == 'hmtt') then
    		if (GetPlayerState(GetOwningPlayer(sichen), PLAYER_STATE_RESOURCE_FOOD_USED) > ( GetPlayerState(GetOwningPlayer(sichen), PLAYER_STATE_RESOURCE_FOOD_CAP) - 0 )) then
    			call RemoveUnit(u)
                call DisplayTextToPlayer( GetOwningPlayer(sichen), 0, 0, "|cFFFF66CC【消息】|r你的人口已满." )
    		endif
    	endif
    	set u = null
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    陨落硫炎
	*/
	private function Yunluoliuyan takes integer abilityID,unit caster,integer zhenshu returns nothing
		local integer i = 1
		local unit u = null
		if (abilityID != 0) then
	    	call PrintSpell(GetOwningPlayer(sichen),GetAbilityName(abilityID),GetDamageAgi(sichen)*0.33)
		endif
		loop
			exitwhen i > zhenshu
			set u = CreateUnit(GetOwningPlayer(sichen),'h01G',GetUnitX(caster),GetUnitY(caster),0)
			if (BJuexing2[GetConvertedPlayerId(GetOwningPlayer(sichen))]) then
				call SetUnitAbilityLevel(u,'A0JA',2)
			endif
			call UnitApplyTimedLifeBJ( 3.00, 'BHwe', u)
			if (i < zhenshu) then
				call YDWEPolledWaitNull(0.5)
			endif
			set i = i +1
		endloop
		set u = null
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    马甲的攻击伤害
	*/
	function SimulateDamageSichen takes nothing returns boolean
		if (GetEventDamage() > 0) then
			//塔1
			if (GetUnitTypeId(GetEventDamageSource()) == 'h01C') then
				call UnitDamageTarget( sichen, GetTriggerUnit(), SichenDamage * 0.1, false, true, ATTACK_TYPE_MAGIC, DAMAGE_TYPE_MAGIC, WEAPON_TYPE_WHOKNOWS )
				return true
			//塔2
			elseif (GetUnitTypeId(GetEventDamageSource()) == 'h0s1') then
				call UnitDamageTarget( sichen, GetTriggerUnit(), SichenDamage * 0.1, false, true, ATTACK_TYPE_MAGIC, DAMAGE_TYPE_MAGIC, WEAPON_TYPE_WHOKNOWS )
				call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Other\\Incinerate\\FireLordDeathExplode.mdl", GetUnitX(GetTriggerUnit()), GetUnitY(GetTriggerUnit()) ))
				return true
			//千刃
			elseif (GetUnitTypeId(GetEventDamageSource()) == 'h0s2') then
				call UnitDamageTarget( sichen, GetTriggerUnit(), SichenDamage * 0.15, false, true, ATTACK_TYPE_MAGIC, DAMAGE_TYPE_MAGIC, WEAPON_TYPE_WHOKNOWS )
				return true
			//神镜
			elseif (GetUnitTypeId(GetEventDamageSource()) == 'h0s4') then
				call Yunluoliuyan(0,GetTriggerUnit(),6)
				return true
			//散华
			elseif (GetUnitTypeId(GetEventDamageSource()) == 'h0s5') then
				call UnitDamageTarget( sichen, GetTriggerUnit(), SichenDamage * 0.2, false, true, ATTACK_TYPE_MAGIC, DAMAGE_TYPE_MAGIC, WEAPON_TYPE_WHOKNOWS )
				call SetUnitLifeBJ(sichen,GetUnitState(sichen,UNIT_STATE_LIFE)+SichenDamage * 0.02)
				call SetUnitLifeBJ(GetTriggerUnit(),GetUnitState(GetTriggerUnit(),UNIT_STATE_LIFE)+GetDamageAgi(GetTriggerUnit()) * 0.02)
				return true
			//十绝一灭
			elseif (GetUnitTypeId(GetEventDamageSource()) == 'h0s6') then
				if (GetUnitUserData(GetEventDamageSource()) >= 10) then
	    			call DestroyEffect(AddSpecialEffect("Objects\\Spawnmodels\\Other\\NeutralBuildingExplosion\\NeutralBuildingExplosion.mdl", GetUnitX(GetTriggerUnit()), GetUnitY(GetTriggerUnit()) ))
	    			call CreateSpellTextTag("一灭",GetTriggerUnit(),0,100,0,3)
	    			call DamageArea(sichen,GetUnitX(GetTriggerUnit()), GetUnitY(GetTriggerUnit()),400,SichenDamage * 5)
					call SetUnitUserData(GetEventDamageSource(),0)
	    		else
					call SetUnitUserData(GetEventDamageSource(),GetUnitUserData(GetEventDamageSource())+1)
				endif
				call UnitDamageTarget( sichen, GetTriggerUnit(), SichenDamage * 0.5, false, true, ATTACK_TYPE_MAGIC, DAMAGE_TYPE_MAGIC, WEAPON_TYPE_WHOKNOWS )
				return true
			//穿云
			elseif (GetUnitTypeId(GetEventDamageSource()) == 'h0s7') then
				call UnitDamageTarget( sichen, GetTriggerUnit(), SichenDamage * 2, false, true, ATTACK_TYPE_MAGIC, DAMAGE_TYPE_MAGIC, WEAPON_TYPE_WHOKNOWS )
				return true
			//孤鸿
			elseif (GetUnitTypeId(GetEventDamageSource()) == 'h0s8') then
				call SetUnitLifeBJ(sichen,GetUnitState(sichen,UNIT_STATE_LIFE)+SichenDamage * 0.1)
				call SetUnitLifeBJ(GetTriggerUnit(),GetUnitState(GetTriggerUnit(),UNIT_STATE_LIFE)+GetDamageAgi(GetTriggerUnit()) * 0.1)
				call UnitDamageTarget( sichen, GetTriggerUnit(), SichenDamage, false, true, ATTACK_TYPE_MAGIC, DAMAGE_TYPE_MAGIC, WEAPON_TYPE_WHOKNOWS )
				call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Undead\\DeathCoil\\DeathCoilSpecialArt.mdl", GetUnitX(GetTriggerUnit()), GetUnitY(GetTriggerUnit()) ))
				return true
			//抓宠物
			elseif (GetUnitTypeId(GetEventDamageSource()) == 'h1s7' or GetUnitTypeId(GetEventDamageSource()) == 'h1s4') then
				if ((not(IsLoyalUnit(GetTriggerUnit()))) and (GetPlayerState(GetOwningPlayer(sichen), PLAYER_STATE_RESOURCE_FOOD_USED) < ( GetPlayerState(GetOwningPlayer(sichen), PLAYER_STATE_RESOURCE_FOOD_CAP))) and GetRandomInt(1,100) < (GetHeroLevel(sichen) - GetUnitLevel(GetTriggerUnit())) and not(IsUnitType(GetTriggerUnit(),UNIT_TYPE_HERO)) and not(IsUnitIllusion(GetTriggerUnit()))) then
					call CreatePet(GetOwningPlayer(sichen),GetTriggerUnit())
				endif
			//硫炎
			elseif (GetUnitTypeId(GetEventDamageSource()) == 'h01G') then
				call UnitDamageTarget( sichen, GetTriggerUnit(), SichenDamage * 0.33, false, true, ATTACK_TYPE_MAGIC, DAMAGE_TYPE_MAGIC, WEAPON_TYPE_WHOKNOWS )
				return true
			//火箭
			elseif (GetUnitTypeId(GetEventDamageSource()) == 'h01H') then
				call UnitDamageTarget( sichen, GetTriggerUnit(), SichenDamage * 0.75, false, true, ATTACK_TYPE_MAGIC, DAMAGE_TYPE_MAGIC, WEAPON_TYPE_WHOKNOWS )
				return true
			endif
		endif
		return false
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    亘月天地
	*/
	private function GenyuetiandiA takes nothing returns boolean
		return udg_H[GetConvertedPlayerId(GetOwningPlayer(GetFilterUnit()))] == GetFilterUnit() and not(IsWudi(GetFilterUnit()))
	endfunction
    private function GenyuetiandiB takes nothing returns nothing
        if (GetEnumUnit() != null) then
			call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Human\\Resurrect\\ResurrectCaster.mdl", GetUnitX(GetEnumUnit()), GetUnitY(GetEnumUnit()) ))
			call UnitRemoveAbility(GetEnumUnit(),'Avul')
        endif
    endfunction
    private function GenyuetiandiC takes nothing returns nothing
	    if (GetEnumUnit() != null) then
			call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Human\\Resurrect\\ResurrectCaster.mdl", GetUnitX(GetEnumUnit()), GetUnitY(GetEnumUnit()) ))
			call UnitAddAbility(GetEnumUnit(),'Avul')
			call SetUnitLifePercentBJ(GetEnumUnit(),100)
	    endif
    endfunction
	private function GenyuetiandiTimer takes nothing returns nothing
		local timer t = GetExpiredTimer()
		local integer id = GetHandleId(t)
		local group l_group = LoadGroupHandle(spellTable,id,1)
        call ForGroupBJ( l_group, function GenyuetiandiB )
		call PauseTimer(t)
		call FlushChildHashtable(spellTable,id)
		call DestroyTimer(t)
		call DestroyGroup(l_group)
		set l_group = null
		set t = null
	endfunction
	private function Genyuetiandi takes nothing returns nothing
		local group l_group = CreateGroup()
		local timer t = CreateTimer()
		local group l_group1 = CreateGroup()
		local unit l_unit1
	    call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\NightElf\\BattleRoar\\RoarCaster.mdl", GetUnitX(sichen), GetUnitY(sichen) ))
		call GroupEnumUnitsInRange(l_group, GetUnitX(sichen), GetUnitY(sichen), 900, Condition(function GenyuetiandiA))
		if not(IsWudi(sichen)) then
			call GroupAddUnit(l_group,sichen)
		endif
		//加不无敌的塔进来
		call GroupAddGroup(GTower,l_group1)
		call GroupAddUnit(l_group,gg_unit_haro_0030)
		loop
		    set l_unit1 = FirstOfGroup(l_group1)
		    exitwhen l_unit1 == null
		    call GroupRemoveUnit(l_group1, l_unit1)
    		if not(IsWudi(l_unit1)) then
				call GroupAddUnit(l_group,l_unit1)
			endif
		endloop
		call ForGroup(l_group,function GenyuetiandiC)
	    call PrintSpellName(GetOwningPlayer(sichen),GetAbilityName('A0IR'))
		call SaveGroupHandle(spellTable,GetHandleId(t),1,l_group)
		call TimerStart(t,5,false,function GenyuetiandiTimer)
		set t = null
		call DestroyGroup(l_group1)
		set l_group1 = null
		set l_unit1 =null
		set l_group = null
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    亘月天地的被动效果
	*/
    private function TSpellSichen2Con takes nothing returns boolean
    	return (GetAttackedUnitBJ() == sichen or IsUnitInGroup(GetAttackedUnitBJ(),GTower)) and IsSecondSpellOK(sichen) == true and GetUnitState(sichen,UNIT_STATE_MANA) >= 250 and GetUnitAbilityLevel(sichen,'A0IR') == 1 and GetRandomInt(1,20) == 1
    endfunction
    private function TSpellSichen2Act takes nothing returns nothing
    	call DisableTrigger(GetTriggeringTrigger())
		call Yunluoliuyan('A0IR',GetAttackedUnitBJ(),2)
		call YDWEPolledWaitNull(4.5)
    	call EnableTrigger(GetTriggeringTrigger())
    endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    涅槃化凰的减伤效果
	*/
	private function TSpellSichen3Con takes nothing returns boolean
		return IsThirdSpellOK(sichen) == true and GetUnitAbilityLevel(sichen,'A0IS') == 1 and GetEventDamage() > GetUnitState(sichen,UNIT_STATE_LIFE) and (GetTriggerUnit() == sichen or GetTriggerUnit() == UCili) and IsUnitAliveBJ(sichen) and GetRandomInt(1,2) == 1 and GetTriggerUnit() != null
	endfunction
	private function TSpellSichen3Act takes nothing returns nothing
		call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Human\\HolyBolt\\HolyBoltSpecialArt.mdl", GetUnitX(sichen), GetUnitY(sichen) ))
		call SetUnitLifePercentBJ(sichen,100)
	    call CreateSpellTextTag("涅槃化凰",sichen,100,0,0,3)
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
		圣皇赐力
	*/
	private function ShenghuangciliTimer takes nothing returns nothing
		local timer t = GetExpiredTimer()
		local integer id = GetHandleId(t)
		local integer index = LoadInteger(spellTable,id,2)
		local effect eff = LoadEffectHandle(spellTable,id,3)
		call DestroyEffect(eff)
		call AddSpellPercent(index,-0.6)
		if (UCili != null) then
			call UnitRemoveAbility(UCili,'A0FU')
		endif
	    call PrintSpellContent(GetOwningPlayer(sichen),GetAbilityName('A0IT'),"，时间结束。")
		call PauseTimer(t)
		call FlushChildHashtable(spellTable,id)
		call DestroyTimer(t)
		set UCili = null
		set t = null
		set eff = null
	endfunction
	private function Shenghuangcili takes nothing returns nothing
		local timer t = CreateTimer()
		//圣皇赐力
		call UnitAddAbility(GetSpellTargetUnit(),'A0FU')
		call AddSpellPercent(GetConvertedPlayerId(GetOwningPlayer(GetSpellTargetUnit())),0.6)
		set UCili = GetSpellTargetUnit()
		call SaveInteger(spellTable,GetHandleId(t),2,GetConvertedPlayerId(GetOwningPlayer(GetSpellTargetUnit())))
		call SaveEffectHandle(spellTable,GetHandleId(t),3,AddSpecialEffectTargetUnitBJ("chest",GetSpellTargetUnit(),"war3mapImported\\bullerouge.mdx"))
	    call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Other\\HowlOfTerror\\HowlCaster.mdl", GetUnitX(GetSpellTargetUnit()), GetUnitY(GetSpellTargetUnit()) ))
		call TimerStart(t,60,false,function ShenghuangciliTimer)
        call PlaySoundBJ(gg_snd_sichen_4)
	    call PrintSpellName(GetOwningPlayer(sichen),GetAbilityName('A0IT'))
		set t = null
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    火箭支援
	*/
	private function Huojianzhiyuan2 takes nothing returns nothing
		local group l_group = CreateGroup()
		local unit l_unit
		call GroupAddGroup(GTower,l_group)
		loop
		    set l_unit = FirstOfGroup(l_group)
		    exitwhen l_unit == null
		    call GroupRemoveUnit(l_group, l_unit)
		    if (not(IsWudi(l_unit))) then
				call UnitApplyTimedLifeBJ( 2.00, 'BHwe',CreateUnit(GetOwningPlayer(sichen),'h01H',GetUnitX(l_unit),GetUnitY(l_unit),GetUnitFacing(l_unit)) )
		    endif
		endloop
		call DestroyGroup(l_group)
		set l_group = null
		set l_unit =null
	endfunction
	private function Huojianzhiyuan takes nothing returns nothing
		local integer i
		if not(UnitHasBuffBJ(sichen,'B021')) then
			return
		endif
		set i = 1
		loop
			exitwhen i > 6
			if ((GetPlayerSlotState(ConvertedPlayer(i)) == PLAYER_SLOT_STATE_PLAYING) and (udg_H[i] != null)) then
				call UnitApplyTimedLifeBJ( 2.00, 'BHwe',CreateUnit(GetOwningPlayer(sichen),'h01H',GetUnitX(udg_H[i]),GetUnitY(udg_H[i]),GetUnitFacing(udg_H[i])) )
            endif
			set i = i +1
		endloop
		if (BJuexing3[GetConvertedPlayerId(GetOwningPlayer(sichen))]) then
			call Huojianzhiyuan2()
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    主英雄技能判断
	*/
	private function TSpellSichenAct takes nothing returns nothing
		if (GetSpellAbilityId() == 'A0IQ') then
			call Yunluoliuyan(GetSpellAbilityId(),sichen,6)
		elseif (GetSpellAbilityId() == 'A0IR') then
			call Genyuetiandi()
		elseif (GetSpellAbilityId() == 'A0IS') then
			call SetUnitLifePercentBJ(GetSpellTargetUnit(),100)
			call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Human\\HolyBolt\\HolyBoltSpecialArt.mdl", GetUnitX(GetSpellTargetUnit()), GetUnitY(GetSpellTargetUnit()) ))
	    	call PrintSpellName(GetOwningPlayer(sichen),GetAbilityName('A0IS'))
		elseif (GetSpellAbilityId() == 'A0IT' and GetSpellTargetUnit() != gg_unit_haro_0030) then
			call Shenghuangcili()
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    英雄学习技能
	*/
	//按照12345来判断
	function LearnSkillSichenI takes unit learner,integer whichSpell returns nothing
		local integer i
		if (learner == sichen) then
			if(whichSpell == 1) then
				call SetPlayerStateBJ( GetOwningPlayer(sichen), PLAYER_STATE_RESOURCE_FOOD_CAP, ( GetPlayerState(GetOwningPlayer(sichen), PLAYER_STATE_RESOURCE_FOOD_CAP) + 2 ) )
			elseif (whichSpell == 2 and IsSecondSpellOK(sichen) == true and GetUnitAbilityLevel(sichen,'A0IR') == 1) then
				call SetPlayerStateBJ( GetOwningPlayer(sichen), PLAYER_STATE_RESOURCE_FOOD_CAP, ( GetPlayerState(GetOwningPlayer(sichen), PLAYER_STATE_RESOURCE_FOOD_CAP) + 2 ) )
			elseif (whichSpell == 3 and IsThirdSpellOK(sichen) == true and GetUnitAbilityLevel(sichen,'A0IS') == 1) then
				call SetPlayerStateBJ( GetOwningPlayer(sichen), PLAYER_STATE_RESOURCE_FOOD_CAP, ( GetPlayerState(GetOwningPlayer(sichen), PLAYER_STATE_RESOURCE_FOOD_CAP) + 2 ) )
				call AddSpecialEffectTargetUnitBJ("origin",sichen,"war3mapImported\\WarAura.mdx")
				call InitSichenAura()
			elseif (whichSpell == 4 and IsFourthSpellOK(sichen) == true and GetUnitAbilityLevel(sichen,'A0IT') == 1) then
				call SetPlayerStateBJ( GetOwningPlayer(sichen), PLAYER_STATE_RESOURCE_FOOD_CAP, ( GetPlayerState(GetOwningPlayer(sichen), PLAYER_STATE_RESOURCE_FOOD_CAP) + 2 ) )
			elseif (whichSpell == 5 and IsFifthSpellOK(sichen) == true and GetUnitAbilityLevel(sichen,'A0IU') == 1) then
				call SetPlayerStateBJ( GetOwningPlayer(sichen), PLAYER_STATE_RESOURCE_FOOD_CAP, ( GetPlayerState(GetOwningPlayer(sichen), PLAYER_STATE_RESOURCE_FOOD_CAP) + 2 ) )
			endif
		endif
	endfunction
	function LearnSkillSichen takes unit learner,integer learnSpellID returns nothing
		if (learner == sichen) then
			if (learnSpellID == 'A0IQ') then
				call LearnSkillSichenI(learner,1)
			elseif (learnSpellID == 'A0IR') then
				call LearnSkillSichenI(learner,2)
			elseif (learnSpellID == 'A0IS') then
				call LearnSkillSichenI(learner,3)
			elseif (learnSpellID == 'A0IT') then
				call LearnSkillSichenI(learner,4)
			elseif (learnSpellID == 'A0IU') then
				call LearnSkillSichenI(learner,5)
			endif
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    司宸升级解锁科技
	*/
	private function TSpellSichenUpdateAct takes nothing returns nothing
		if (GetHeroLevel(sichen)>= 25) then
			call SetPlayerTechResearchedSwap('R01E',1,GetOwningPlayer(sichen))
		endif
		if (GetHeroLevel(sichen)>= 50) then
			call SetPlayerTechResearchedSwap('R01B',1,GetOwningPlayer(sichen))
		endif
		if (GetHeroLevel(sichen)>= 100) then
			call SetPlayerTechResearchedSwap('R01C',1,GetOwningPlayer(sichen))
		endif
		if (GetHeroLevel(sichen)>= 150) then
			call SetPlayerTechResearchedSwap('R01D',1,GetOwningPlayer(sichen))
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    刷新伤害值
	*/
	private function FlashSichenDamage takes nothing returns nothing
		set SichenDamage = GetDamageAgi(sichen)
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    初始化皮肤
	*/
	private function InitSichenSpin takes unit u returns unit
		if (IsSichenSpin1(GetOwningPlayer(u))) then
			set udg_H[GetConvertedPlayerId(GetOwningPlayer(u))] = CreateUnit(GetOwningPlayer(u),'H02C',GetUnitX(u),GetUnitY(u),0)
			set gg_unit_Hhkl_0218 = udg_H[GetConvertedPlayerId(GetOwningPlayer(u))]
			call UnitAddItemByIdSwapped('I006', udg_H[GetConvertedPlayerId(GetOwningPlayer(u))])
			call SetUnitManaPercentBJ(udg_H[GetConvertedPlayerId(GetOwningPlayer(u))],1000)
			call RemoveUnit(u)
			call SetPlayerStateBJ( GetOwningPlayer(u), PLAYER_STATE_RESOURCE_FOOD_CAP, ( GetPlayerState(GetOwningPlayer(u), PLAYER_STATE_RESOURCE_FOOD_CAP) + 1 ) )
			return udg_H[GetConvertedPlayerId(GetOwningPlayer(u))]
		else
			return u
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	function InitSichen takes unit u returns nothing
		local trigger t = CreateTrigger()
		local integer i = 1
		set sichen = InitSichenSpin(u)
		//主英雄技能
		set TSpellSichen = CreateTrigger()
	    call TriggerRegisterUnitEvent(TSpellSichen,sichen,EVENT_UNIT_SPELL_EFFECT)
	    call TriggerAddAction(TSpellSichen, function TSpellSichenAct)
	    //被动被攻击效果
	    set TSpellSichen2 = CreateTrigger()
	    call TriggerRegisterAnyUnitEventBJ(TSpellSichen2,EVENT_PLAYER_UNIT_ATTACKED)
	    call TriggerAddCondition(TSpellSichen2, Condition(function TSpellSichen2Con))
	    call TriggerAddAction(TSpellSichen2, function TSpellSichen2Act)
	    set GTower = CreateGroup()
	    //被动3的减伤
	    set TSpellSichen3 = CreateTrigger()
	    call TriggerRegisterUnitEvent(TSpellSichen3,sichen,EVENT_UNIT_DAMAGED)
	    call TriggerAddCondition(TSpellSichen3,Condition(function TSpellSichen3Con))
	    call TriggerAddAction(TSpellSichen3,function TSpellSichen3Act)
	    //升级解锁科技
	    set TSpellSichenUpdate = CreateTrigger()
	    call TriggerRegisterUnitEvent( TSpellSichenUpdate, sichen, EVENT_UNIT_HERO_LEVEL )
	    call TriggerAddAction(TSpellSichenUpdate, function TSpellSichenUpdateAct)
	    //马甲伤害
	    set TSpellSichenDamage = CreateTrigger()
	    call YDWESyStemAnyUnitDamagedRegistTrigger( TSpellSichenDamage )
	    call TriggerAddAction(TSpellSichenDamage, function SimulateDamageSichen)
		//完成建造
	    call TriggerRegisterAnyUnitEventBJ( t, EVENT_PLAYER_UNIT_CONSTRUCT_FINISH )
	    call TriggerAddCondition(t,Condition(function TSichenBuildingCon))
	    call TriggerAddAction(t, function TSichenBuilding)
	    call TriggerRegisterAnyUnitEventBJ( t, EVENT_PLAYER_UNIT_UPGRADE_START )
	    call TriggerAddCondition(t,Condition(function TSichenBuildingCon))
	    call TriggerAddAction(t, function TSichenBuildingUpdate)
	    call TimerStart(CreateTimer(),1,true,function Huojianzhiyuan)
	    //刷新伤害
	    call TimerStart(CreateTimer(),1,true,function FlashSichenDamage)
		call SetPlayerStateBJ( GetOwningPlayer(sichen), PLAYER_STATE_RESOURCE_FOOD_CAP, ( GetPlayerState(GetOwningPlayer(sichen), PLAYER_STATE_RESOURCE_FOOD_CAP) + 2 ) )
	    loop
	    	exitwhen i > 6
            if ((GetPlayerSlotState(ConvertedPlayer(i)) == PLAYER_SLOT_STATE_PLAYING) and (GetPlayerController(ConvertedPlayer(i)) == MAP_CONTROL_USER)) then
				call SetPlayerAbilityAvailable(ConvertedPlayer(i),'A0FU',false)
            endif
	    	set i = i +1
	    endloop
		call SetPlayerAbilityAvailable(Player(6),'A0FU',false)
		set t = null
	endfunction
endlibrary
library_once Xuanxue requires LHBase,Spin,ChallangerDZ
	globals
		hashtable HTXX = null
		private integer IQinru
	endglobals
//---------------------------------------------------------------------------------------------------
	/*
	    皮肤的计数初始化
	*/
	function InitHongdeng takes nothing returns nothing
		set HTXX = InitHashtable()
		set IQinru = 0
	endfunction
	function CountQintu takes unit u returns nothing
		local integer i
		if (HTXX == null) then
			return
		endif
		if (GetXuanxue2Spin(GetOwningPlayer(xuanxue))) then
			return
		endif
		set i = 1
		loop
			exitwhen i > IQinru
    		if (LoadInteger(HTXX,GetHandleId(xuanxue),i) == GetUnitTypeId(u)) then
    			return
    		endif
			set i = i +1
		endloop
		set IQinru = IQinru + 1
		call SaveInteger(HTXX,GetHandleId(xuanxue),IQinru,GetUnitTypeId(u))
		if (IQinru < 134) then
			call BJDebugMsg("|cFFFF0000【凝冰红灯】|r进度:"+I2S(IQinru) + "/134.")
		else
			debug call SetXuanxue2SpinOK(GetOwningPlayer(xuanxue))
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    冰之凋零
	*/
	function Bingzhidiaoling takes unit u returns nothing
		local real damage = GetDamageInt(xuanxue)
		local real x = GetUnitX(u)
		local real y = GetUnitY(u)
	    call PrintSpell(GetOwningPlayer(xuanxue),GetAbilityName(GetSpellAbilityId()),damage)
	    call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Undead\\FrostNova\\FrostNovaTarget.mdl", x, y ))
	    call UnitDamageTarget( xuanxue, u, damage, false, true, ATTACK_TYPE_MAGIC, DAMAGE_TYPE_MAGIC, WEAPON_TYPE_WHOKNOWS )
	    call YDWEPolledWaitNull(1)
		call DamageAreaEff(xuanxue,x,y,600,damage,"Abilities\\Spells\\Undead\\FrostNova\\FrostNovaTarget.mdl")
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    万古玄霜的被动效果
	*/
	function Wanguxuanshuang takes unit u returns nothing
		if (IsEnemy(u,xuanxue) and (udg_U_Zhuansheng_Dantiao[2] != u or GetAttacker() == xuanxue) and GetUnitState(xuanxue,UNIT_STATE_MANA) >= 400) then
			call UnitDamageTarget( xuanxue, u, GetDamageInt(xuanxue) * 0.1 , false, true, ATTACK_TYPE_MAGIC, DAMAGE_TYPE_MAGIC, WEAPON_TYPE_WHOKNOWS )
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    玄雪法杖
	*/
	private function InitXuanxueSpin takes unit u returns unit
        if (IsXuanxueSpin2(GetOwningPlayer(u))) then
            set udg_H[GetConvertedPlayerId(GetOwningPlayer(u))] = CreateUnit(GetOwningPlayer(u),'U002',GetUnitX(u),GetUnitY(u),0)
            set gg_unit_Uktl_0018 = udg_H[GetConvertedPlayerId(GetOwningPlayer(u))]
            call UnitAddItemByIdSwapped('I006', udg_H[GetConvertedPlayerId(GetOwningPlayer(u))])
            call AddSpellPercent(GetConvertedPlayerId(GetOwningPlayer(u)),0.1)
            call SetUnitManaPercentBJ(udg_H[GetConvertedPlayerId(GetOwningPlayer(u))],1000)
            call RemoveUnit(u)
            set u = udg_H[GetConvertedPlayerId(GetOwningPlayer(u))]
        endif
		if (IsXuanxueSpin1(GetOwningPlayer(u))) then
			call UnitRemoveAbility(u,'A046')
			call UnitAddAbility(u,'A0JM')
			call AddSpellPercent(GetConvertedPlayerId(GetOwningPlayer(u)),0.2)
			return u
		else
			return u
		endif
	endfunction
	function InitXuanxue takes unit u returns nothing
		set xuanxue = InitXuanxueSpin(u)
	endfunction
endlibrary
library_once Taiya requires LHBase,Spin,Version
	globals
		private integer ITaiyamiao = 0
	endglobals
//---------------------------------------------------------------------------------------------------
	/*
	    泰雅皮肤
	*/
	function AddTaiyaSpin takes nothing returns nothing
		if (ITaiyamiao > 2500) then
			debug call SetTaiyaSpinOK(GetOwningPlayer(taiya))
		else
			set ITaiyamiao = ITaiyamiao + 1
			if (ModuloInteger(ITaiyamiao,100) == 0) then
				call DisplayTextToPlayer(GetOwningPlayer(taiya), 0., 0., "【|cFFCCFF66三弦星谧|r】完成进度"+I2S(ITaiyamiao)+"/2500.")
			endif
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    泰雅皮肤
	*/
	private function InitTaiyaSpin takes unit u returns unit
		if (IsTaiyaSpin1(GetOwningPlayer(u))) then
			set udg_H[GetConvertedPlayerId(GetOwningPlayer(u))] = CreateUnit(GetOwningPlayer(u),'E00G',GetUnitX(u),GetUnitY(u),0)
			set gg_unit_Etyr_0017 = udg_H[GetConvertedPlayerId(GetOwningPlayer(u))]
			call UnitAddItemByIdSwapped('I006', udg_H[GetConvertedPlayerId(GetOwningPlayer(u))])
			call AddSpellPercent(GetConvertedPlayerId(GetOwningPlayer(u)),0.1)
			call SetUnitManaPercentBJ(udg_H[GetConvertedPlayerId(GetOwningPlayer(u))],1000)
			call RemoveUnit(u)
			return udg_H[GetConvertedPlayerId(GetOwningPlayer(u))]
		else
			return u
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	function InitTaiya takes unit u returns nothing
		set taiya = InitTaiyaSpin(u)
    	call TriggerRegisterUnitEvent( gg_trg_____________86, taiya, EVENT_UNIT_DAMAGED )
	endfunction
endlibrary
library_once Bajue requires LHBase,Spin
	globals
		private real baseX
		private real baseY
		private real tempX
		private real tempY
		private boolean BFengshuang = false
		private boolean BFengshuangStart = false
	endglobals
//---------------------------------------------------------------------------------------------------
	/*
	    皮肤挑战初始化
	*/
	function InitFengshuang takes nothing returns nothing
		set baseX = 0.
		set baseY = 0.
		set tempX = 0.
		set tempY = 0.
		set BFengshuang = true
	endfunction
	//开始
	function StartFengshuang takes nothing returns nothing
		if not(BFengshuang) then
			return
		endif
		if (GetBajue1Spin(GetOwningPlayer(bajue))) then
			return
		endif
		if (GetTriggerUnit() == bajue) then
			set baseX = GetUnitX(bajue)
			set baseY = GetUnitY(bajue)
			set tempX = GetUnitX(bajue)
			set tempY = GetUnitY(bajue)
			set BFengshuangStart = true
		endif
	endfunction
	//结束判定
	function EndFengshuang takes nothing returns nothing
		local real distance = 0.
		if not(BFengshuang) then
			return
		endif
		if not(BFengshuangStart) then
			return
		endif
		set distance = GetDistance(baseX,baseY,tempX,tempY)
		call BJDebugMsg("|cFFFF66CC【消息】|r本次技能跳跃距离为"+R2S(distance)+".")
		if (distance > 8000.) then
			debug call SetBajueSpinOK(GetOwningPlayer(bajue))
		endif
		set baseX = 0.
		set baseY = 0.
		set tempX = 0.
		set tempY = 0.
		set BFengshuangStart = false
	endfunction
	//中途检测
	function JudgeFengshuang takes nothing returns nothing
		if not(BFengshuang) then
			return
		endif
		if not(BFengshuangStart) then
			return
		endif
		if (GetDistance(GetUnitX(bajue),GetUnitY(bajue),tempX,tempY) < 1100) then
			set tempX = GetUnitX(bajue)
			set tempY = GetUnitY(bajue)
		else
			call EndFengshuang()
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    皮肤
	*/
	function IsBajueSpin takes nothing returns boolean
		return GetUnitTypeId(bajue) == 'N01W'
	endfunction
	function GetBajueJiaType takes nothing returns integer
		return I3(IsBajueSpin(),'N01X','N018')
	endfunction
	private function InitBajueSpin takes unit u returns unit
		if (IsBajueSpin1(GetOwningPlayer(u))) then
			set udg_H[GetConvertedPlayerId(GetOwningPlayer(u))] = CreateUnit(GetOwningPlayer(u),'N01W',GetUnitX(u),GetUnitY(u),0)
			set gg_unit_Nbbc_0235 = udg_H[GetConvertedPlayerId(GetOwningPlayer(u))]
			call UnitAddItemByIdSwapped('I006', udg_H[GetConvertedPlayerId(GetOwningPlayer(u))])
			call AddSpellPercent(GetConvertedPlayerId(GetOwningPlayer(u)),0.1)
			call SetUnitManaPercentBJ(udg_H[GetConvertedPlayerId(GetOwningPlayer(u))],1000)
			call RemoveUnit(u)
			return udg_H[GetConvertedPlayerId(GetOwningPlayer(u))]
		else
			return u
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    初始化霸绝
	*/
	function InitBajue takes unit u returns nothing
		set bajue = InitBajueSpin(u)
	endfunction
endlibrary
// 战斗调整
// 野区
library_once Jungle requires LHBase,Diffculty
	globals
		unit UYeYang = null
		unit UYeYin = null
	endglobals
//---------------------------------------------------------------------------------------------------
	/*
	    死亡奖励木材
	*/
	private function Jungle4DropCon takes nothing returns boolean
		return GetDyingUnit() == UYeYang or GetDyingUnit() == UYeYin
	endfunction
	private function Jungle4DropAct takes nothing returns nothing
		local integer i = 1
    	call BJDebugMsg("|cFFFF66CC【消息】|r"+GetUnitName(udg_H[GetConvertedPlayerId(GetOwningPlayer(GetKillingUnitBJ()))])+"成功地击杀了"+GetUnitName(GetDyingUnit())+",所有玩家奖励1000木材！")
    	loop
    		exitwhen i > 6
			call AdjustPlayerStateBJ( 1000, ConvertedPlayer(i), PLAYER_STATE_RESOURCE_LUMBER )
    		set i = i +1
    	endloop
    	call AddPlayerTechResearched( Player(10), 'R00W', udg_RENSHU )
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    判断旁边是否有人,然后再判定是否无敌的
	*/
	private function SetJudgeJungle4InvuFilter takes nothing returns boolean
		return IsEnemyMP(GetFilterUnit(),Player(10)) == true
	endfunction
	private function SetJudgeJungle4Invu takes unit u returns nothing
		local group l_group = CreateGroup()
		call GroupEnumUnitsInRange(l_group, GetUnitX(u), GetUnitY(u), 900, Condition(function SetJudgeJungle4InvuFilter))
		if (GetUnitAbilityLevel(u,'Avul') < 1 and CountUnitsInGroup(l_group) == 0) then
			call UnitAddAbility(u,'Avul')
			call PauseUnit(u,true)
			call SetUnitLifePercentBJ(u,100)
		elseif (GetUnitAbilityLevel(u,'Avul') >= 1 and CountUnitsInGroup(l_group) != 0) then
			call UnitRemoveAbility(u,'Avul')
			call PauseUnit(u,false)
		endif
		set l_group = null
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    判断4级野有人否
	*/
	private function JungleFlash takes nothing returns nothing
		//阳
		if (IsUnitAliveBJ(UYeYang)) then
			call SetJudgeJungle4Invu(UYeYang)
		else
			call RemoveUnit(UYeYang)
			if (GetPlayerTechCountSimple('R00W', Player(10)) < 100) then
		    	set UYeYang = CreateUnit(Player(10), 'Orkn', 14707.6, - 290.4, 180.000)
	 		    call EnhanceDiffAttack(UYeYang)
		    	call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Human\\ReviveHuman\\ReviveHuman.mdl", GetUnitX(UYeYang), GetUnitY(UYeYang) ))
		    	call AddTianyanmokang(UYeYang)
			endif
		endif
		//阴
		if (IsUnitAliveBJ(UYeYin)) then
			call SetJudgeJungle4Invu(UYeYin)
		else
			call RemoveUnit(UYeYin)
			if (GetPlayerTechCountSimple('R00W', Player(10)) < 100) then
		    	set UYeYin = CreateUnit(Player(10), 'Osam', 1923.9, - 420.4, 0.000)
			    call EnhanceDiffAttack(UYeYin)
		    	call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Human\\ReviveHuman\\ReviveHuman.mdl", GetUnitX(UYeYin), GetUnitY(UYeYin) ))
		    	call AddTianyanmokang(UYeYin)
			endif
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    初始化
	*/
	function InitJungle takes nothing returns nothing
	    local trigger t = CreateTrigger()
	    set UYeYang = CreateUnit(Player(10), 'Orkn', 14707.6, - 290.4, 180.000)
	    set UYeYin = CreateUnit(Player(10), 'Osam', 1923.9, - 420.4, 0.000)
	    call EnhanceDiffAttack(UYeYang)
	    call EnhanceDiffAttack(UYeYin)
		//死亡奖励木头
	    call TriggerRegisterAnyUnitEventBJ( t, EVENT_PLAYER_UNIT_DEATH )
	    call TriggerAddCondition(t, Condition(function Jungle4DropCon))
	    call TriggerAddAction(t, function Jungle4DropAct)
	    call TimerStart(CreateTimer(),5,true,function JungleFlash)
	    set t = null
	endfunction
endlibrary
// 秘境
///#include  "edit/NetVersion.j"
/*
    新副本，秘境挑战
*/
library_once MiJing requires LHBase,Diffculty,SpellBase,Version
    globals
        //当前层数
        integer IDeng = 0
        //显示当前层数的漂浮文字
        private texttag TDeng = null
        //灯与进度显示器
        private unit UDeng
        private texttag TDengProcess
        //当前进度
        private integer IProcess = 0
        //计时器
        private timer TMijingJudge = null
        private timer TMijingFlash = null
        private timer TMijingBound = null
        //刷怪
        private integer ITotalMonster = 0
        private group GMijing = null
        //判断是否正在挑战
        private boolean BMijingStart = false
        private trigger TDengUnderAttacked = null
        unit UMijingShangdian = null
        //秘境装备
        private item array IMijing
        //夜袭使者的技能
        private trigger TDeathKou = null
        private unit yexi = null
    endglobals
//---------------------------------------------------------------------------------------------------
    /*
        假灯爆炸
    */
    function SimulateDeathMijing takes unit u returns nothing
        if (GetUnitTypeId(u) == 'n029') then
            call KillAreaPlayerEnemy(u,GetUnitX(u),GetUnitY(u),400,Player(10))
            call DestroyEffect(AddSpecialEffect("Objects\\Spawnmodels\\Other\\NeutralBuildingExplosion\\NeutralBuildingExplosion.mdl", GetUnitX(u), GetUnitY(u) ))
        endif
    endfunction
//---------------------------------------------------------------------------------------------------
    /*
        灯每次只扣一点血
    */
    function TDengDamageCon takes nothing returns boolean
        return GetUnitTypeId(GetTriggerUnit()) == 'n01H' and GetEventDamage() > 0
    endfunction
    function TDengDamageAct takes nothing returns nothing
        call SetUnitLifeBJ(GetTriggerUnit(),GetUnitState(GetTriggerUnit(),UNIT_STATE_LIFE) - RCModeH(1,2))
    endfunction
//---------------------------------------------------------------------------------------------------
    /*
        灯的奖励
    */
    private function GetDengJiangli takes nothing returns integer
        if (IDeng == 1) then
            return 'ILI1'
        elseif (IDeng == 2) then
            return 'ILI2'
        elseif (IDeng == 3) then
            return 'ILI3'
        elseif (IDeng == 4) then
            return 'ILI4'
        elseif (IDeng == 5) then
            return 'ILI5'
        elseif (IDeng == 6) then
            return 'ILI6'
        elseif (IDeng == 7) then
            return 'ILI7'
        elseif (IDeng == 8) then
            return 'ILI8'
        elseif (IDeng == 9) then
            return 'ILI9'
        elseif (IDeng == 10) then
            return 'ILIA'
        elseif (IDeng == 11) then
            return 'ILIB'
        elseif (IDeng == 12) then
            return 'ILIC'
        elseif (IDeng == 13) then
            return 'ILID'
        elseif (IDeng == 14) then
            return 'ILIE'
        elseif (IDeng == 15) then
            return 'ILIF'
        elseif (IDeng == 16) then
            return 'ILIG'
        elseif (IDeng == 17) then
            return 'ILIH'
        elseif (IDeng == 18) then
            return 'ILII'
        elseif (IDeng == 19) then
            return 'ILIJ'
        elseif (IDeng == 20) then
            return 'ILIK'
        elseif (IDeng == 21) then
            return 'I07D'
        endif
        return 0
    endfunction
//---------------------------------------------------------------------------------------------------
    /*
        秘境怪物判断
    */
    private function GetMijingMonster takes nothing returns integer
        if (IDeng == 1) then
            return 'nogr'
        elseif (IDeng == 2) then
            return 'nmbg'
        elseif (IDeng == 3) then
            return 'nkog'
        elseif (IDeng == 4) then
            return 'nfrp'
        elseif (IDeng == 5) then
            return 'nfot'
        elseif (IDeng == 6) then
            return 'ners'
        elseif (IDeng == 7) then
            return 'nsel'
        elseif (IDeng == 8) then
            return 'ndrs'
        elseif (IDeng == 9) then
            return 'ehip'
        elseif (IDeng == 10) then
            return 'uabo'
        elseif (IDeng >= 11 and IDeng < 16) then
            return 'nmgd'
        elseif (IDeng >= 16 and IDeng < 21) then
            return 'nrwm'
        elseif (IDeng >= 21) then
            return 'N028'
        endif
        return 0
    endfunction
//---------------------------------------------------------------------------------------------------
    /*
        判断怪物的数量
    */
    private function GetMijingMonsterCount takes nothing returns integer
        local group l_group = CreateGroup()
        local unit l_unit
        local integer count = 0
        call GroupAddGroup(GMijing,l_group)
        loop
            set l_unit = FirstOfGroup(l_group)
            exitwhen l_unit == null
            call GroupRemoveUnit(l_group, l_unit)
            if (IsUnitAliveBJ(l_unit) and GetOwningPlayer(l_unit) == Player(11)) then
                set count = count + 1
                call UnitRemoveBuffsBJ( bj_REMOVEBUFFS_ALL, l_unit )
            endif
        endloop
        call DestroyGroup(l_group)
        set l_group = null
        set l_unit =null
        return count
    endfunction
//---------------------------------------------------------------------------------------------------
    /*
        夜袭
    */
    private function TDeathYexiCon takes nothing returns boolean
        return RectContainsUnit(gg_rct_M6,GetDyingUnit()) and (GetUnitPointValue(GetDyingUnit()) != 0) and (GetUnitPointValue(GetDyingUnit()) != 123) and (GetPlayerController(GetOwningPlayer(GetDyingUnit())) == MAP_CONTROL_USER)
    endfunction
    private function TDeathYexiAct takes nothing returns nothing
        call CreateSpellTextTag("减少灯进度",GetDyingUnit(),0,0,0,2)
        set IProcess = IMaxBJ(IProcess - 1,0)
    endfunction
//---------------------------------------------------------------------------------------------------
    /*
        21-25夜袭
    */
    private function YexiAttackTarget takes nothing returns boolean
        return IsEnemyP(GetFilterUnit(),Player(10)) and GetUnitAbilityLevel(GetFilterUnit(),'Avul') < 1
    endfunction
    /*
        优先打人,再打随机怪
    */
    private function GetFocusTarget takes group g returns unit
        local integer i = 1
        loop
            exitwhen i > 6
            if (udg_H[i] != null and IsUnitInGroup(udg_H[i],g)) then
                return udg_H[i]
            endif
            set i = i +1
        endloop
        return FirstOfGroup(g)
    endfunction
    //创建假灯
    private function CreateJiadeng takes nothing returns nothing
        local timer t = GetExpiredTimer()
        local integer i = 1
        if (yexi != null) then
            loop
                exitwhen i > 7
                call UnitApplyTimedLifeBJ( 3.00, 'BHwe',CreateUnit(Player(6),'n029',GetRandomReal(GetRectMinX(gg_rct_M6),GetRectMaxX(gg_rct_M6)),GetRandomReal(GetRectMinY(gg_rct_M6),GetRectMaxY(gg_rct_M6)),GetRandomReal(0,360)) )
                set i = i +1
            endloop
            call CreateSpellTextTag("制造假灯",yexi,0,100,0,2)
        else
            call PauseTimer(t)
            call DestroyTimer(t)
        endif
        set t = null
    endfunction
    //创建大爆炸
    private function CreateBigBoom takes nothing returns nothing
        local timer t = GetExpiredTimer()
        if (yexi != null) then
            call Missile.createXY(yexi,'h02H',"Units\\Demon\\Infernal\\InfernalBirth.mdl",1800,GetUnitX(yexi),GetUnitY(yexi),2,1,1000000000)
        else
            call PauseTimer(t)
            call DestroyTimer(t)
        endif
        set t = null
    endfunction
    //位移打人
    private function FlashLocation takes nothing returns nothing
        local timer t = GetExpiredTimer()
        local unit target = null
        local group g = null
        if (yexi != null) then
            set g = YDWEGetUnitsInRectMatchingNull( gg_rct_M6, Condition(function YexiAttackTarget))
            set target = U3(GetFocusTarget(g) != null,GetFocusTarget(g),UDeng)
            call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\NightElf\\Blink\\BlinkTarget.mdl", GetUnitX(yexi),GetUnitY(yexi) ))
            call SetUnitX(yexi,GetUnitX(target))
            call SetUnitY(yexi,GetUnitY(target))
            call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\NightElf\\Blink\\BlinkTarget.mdl", GetUnitX(yexi),GetUnitY(yexi) ))
            call IssueTargetOrder(yexi,"attack",target)
        else
            call PauseTimer(t)
            call DestroyTimer(t)
        endif
        set t = null
    endfunction
    //创建假灯
    private function SummonBingfeng takes nothing returns nothing
        local timer t = GetExpiredTimer()
        local integer i = 1
        if (yexi != null) then
            loop
                exitwhen i > 7
                call UnitApplyTimedLifeBJ( 5.00, 'BHwe',CreateUnit(Player(10),'h02G',GetRandomReal(GetRectMinX(gg_rct_M6),GetRectMaxX(gg_rct_M6)),GetRandomReal(GetRectMinY(gg_rct_M6),GetRectMaxY(gg_rct_M6)),GetRandomReal(0,360)) )
                set i = i +1
            endloop
            call CreateSpellTextTag("冰川夜幕",yexi,0,100,0,2)
        else
            call PauseTimer(t)
            call DestroyTimer(t)
        endif
        set t = null
    endfunction
    private function CreateYexi takes nothing returns nothing
        local unit u = CreateUnit(Player(11),GetMijingMonster(),GetRandomReal(GetRectMinX(gg_rct_M6),GetRectMaxX(gg_rct_M6)),GetRandomReal(GetRectMinY(gg_rct_M6),GetRectMaxY(gg_rct_M6)),GetRandomReal(0,360))
        local timer t = CreateTimer()
        set yexi = u
        call SuperShield.create(u,20)
        call GroupAddUnit(GMijing,u)
        call EnhanceDiffAttack(u)
        set TDeathKou = CreateTrigger()
        call TriggerRegisterAnyUnitEventBJ(TDeathKou,EVENT_PLAYER_UNIT_DEATH)
        call TriggerAddCondition(TDeathKou, Condition(function TDeathYexiCon))
        call TriggerAddAction(TDeathKou, function TDeathYexiAct)
        //制造假灯
        call TimerStart(t, (27 - IDeng)*0.5 + 2 ,true,function CreateJiadeng)
        //大爆炸
        if (IDeng >= 22) then
            set t = CreateTimer()
            call TimerStart(t,33 - IDeng,true,function CreateBigBoom)
        endif
        //瞬移打人
        set t = CreateTimer()
        call TimerStart(t,1,true,function FlashLocation)
        //召唤眩晕
        if (IDeng >= 23) then
            set t = CreateTimer()
            call TimerStart(t,5,true,function SummonBingfeng)
        endif
        set t = null
        set u = null
    endfunction
//---------------------------------------------------------------------------------------------------
    /*
        创建怪物
    */
    private function CreateMijingMonster takes nothing returns nothing
        local integer i = 1
        local unit u = null
        local rect r = gg_rct_M6
        local unit temp = UDeng
        loop
            exitwhen i > udg_RENSHU
            set u = CreateUnit(Player(11),GetMijingMonster(),GetRandomReal(GetRectMinX(r),GetRectMaxX(r)),GetRandomReal(GetRectMinY(r),GetRectMaxY(r)),GetRandomReal(0,360))
            call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Human\\MassTeleport\\MassTeleportTo.mdl", GetUnitX(u), GetUnitY(u) ))
            call GroupAddUnit(GMijing,u)
            call IssuePointOrderById(u,851983,GetUnitX(temp)+GetRandomReal(-100,100),GetUnitY(temp)+GetRandomReal(-100,100))
            if (IsWanjie()) then
                call UnitAddAbility(u,'ANbl')
                call UnitAddAbility(u,'A0IO')
            endif
            call UnitAddAbility(u,'A0IH')
            if ( IDeng <= 10) then
                call EnhanceDiffAttack(u)
            elseif ( IDeng == 11) then
                call UnitAddAbility(u,'A09V')
                call SetUnitAbilityLevel(u,'A09V',NanDiff + 1)
            elseif ( IDeng == 12) then
                call UnitAddAbility(u,'A0I6')
                call SetUnitAbilityLevel(u,'A0I6',NanDiff + 1)
            elseif ( IDeng == 13) then
                call UnitAddAbility(u,'A0I7')
                call SetUnitAbilityLevel(u,'A0I7',NanDiff + 1)
            elseif ( IDeng == 14) then
                call UnitAddAbility(u,'A0I8')
                call SetUnitAbilityLevel(u,'A0I8',NanDiff + 1)
            elseif ( IDeng == 15) then
                call UnitAddAbility(u,'A0I9')
                call SetUnitAbilityLevel(u,'A0I9',NanDiff + 1)
            elseif ( IDeng == 16) then
                call UnitAddAbility(u,'A09V')
                call SetUnitAbilityLevel(u,'A09V',NanDiff + 1)
            elseif ( IDeng == 17) then
                call UnitAddAbility(u,'A0IC')
                call SetUnitAbilityLevel(u,'A0IC',NanDiff + 1)
            elseif ( IDeng == 18) then
                call UnitAddAbility(u,'A0ID')
                call SetUnitAbilityLevel(u,'A0ID',NanDiff + 1)
            elseif ( IDeng == 19) then
                call UnitAddAbility(u,'A0IE')
                call SetUnitAbilityLevel(u,'A0IE',NanDiff + 1)
            elseif ( IDeng == 20) then
                call UnitAddAbility(u,'A0IF')
                call SetUnitAbilityLevel(u,'A0IF',NanDiff + 1)
            endif
            if (IDeng > 10 and IDeng < 16) then
                call SetUnitAbilityLevel(u,'A0I3',IDeng - 10)
            elseif (IDeng > 15) then
                call SetUnitAbilityLevel(u,'A0IA',IDeng - 10)
            endif
            set i = i +1
        endloop
        set u = null
        set r = null
        set temp = null
    endfunction
//---------------------------------------------------------------------------------------------------
    /*
        给装备梦霁
    */
    /*private function GiveMengjiMijing takes nothing returns nothing
        local timer t = GetExpiredTimer()
        set IMijing[GetConvertedPlayerId(GetOwningPlayer(mengji))] = UnitAddItemByIdSwapped(GetDengJiangli(), udg_H[GetConvertedPlayerId(GetOwningPlayer(mengji))])
        call DisplayTextToPlayer(GetOwningPlayer(mengji), 0., 0., "|cFFFF66CC【消息】|r秘境挑战第"+ I2S(IDeng) + "层挑战成功！奖励"+GetItemName(GetLastCreatedItem())+"发放到了你的身上.")
        call PingMinimapForForce( GetForceOfPlayer(GetOwningPlayer(mengji)), GetUnitX(udg_H[GetConvertedPlayerId(GetOwningPlayer(mengji))]), GetUnitY(udg_H[GetConvertedPlayerId(GetOwningPlayer(mengji))]), 5.00 )
        call PauseTimer(t)
        call DestroyTimer(t)
        set t = null
    endfunction*/
//---------------------------------------------------------------------------------------------------
    /*
        发放奖励
    */
    function Fafangmijing takes integer index returns nothing
        if (IDeng >= 22) then
            call AddHero3W(udg_H[index],40000)
            call DisplayTextToPlayer(ConvertedPlayer(index), 0., 0., "|cFFFF66CC【消息】|r秘境挑战第"+ I2S(IDeng) + "层挑战成功！奖励40000点全属性与1点能量值发放到了你的身上.")
            if (IsStrHero(udg_H[index])) then
                call SetHeroStr(udg_H[index],GetHeroStr(udg_H[index],true) + 40000,true)
                call DisplayTextToPlayer(ConvertedPlayer(index), 0., 0., "|cFFFF66CC【消息】|r额外奖励40000点力量.")
            elseif (IsAgiHero(udg_H[index])) then
                call SetHeroAgi(udg_H[index],GetHeroAgi(udg_H[index],true) + 40000,true)
                call DisplayTextToPlayer(ConvertedPlayer(index), 0., 0., "|cFFFF66CC【消息】|r额外奖励40000点敏捷.")
            elseif (IsIntHero(udg_H[index])) then
                call SetHeroInt(udg_H[index],GetHeroInt(udg_H[index],true) + 40000,true)
                call DisplayTextToPlayer(ConvertedPlayer(index), 0., 0., "|cFFFF66CC【消息】|r额外奖励40000点智力.")
            endif
            if (IMijing[index] != null) then
                call SetItemCharges(IMijing[index],GetItemCharges(IMijing[index])+ 1)
            endif
            return
        endif
        if (udg_H[index] != cangling) then
            if (IMijing[index] != null) then
                call RemoveItem(IMijing[index])
            endif
        endif
        //call PolledWait(0.1)
        if (udg_H[index] == mengji) then
            set IMijing[GetConvertedPlayerId(GetOwningPlayer(mengji))] = UnitAddItemByIdSwapped(GetDengJiangli(), UDepot[GetConvertedPlayerId(GetOwningPlayer(mengji))])
            call DisplayTextToPlayer(GetOwningPlayer(mengji), 0., 0., "|cFFFF66CC【消息】|r秘境挑战第"+ I2S(IDeng) + "层挑战成功！奖励"+GetItemName(GetLastCreatedItem())+"发放到了你的仓库里面.")
            call PingMinimapForForce( YDWEGetForceOfPlayerNull(GetOwningPlayer(mengji)), GetUnitX(UDepot[GetConvertedPlayerId(GetOwningPlayer(mengji))]), GetUnitY(UDepot[GetConvertedPlayerId(GetOwningPlayer(mengji))]), 5.00 )
            //call TimerStart(CreateTimer(),0.1,false,function GiveMengjiMijing)
            return
        endif
        set IMijing[index] = UnitAddItemByIdSwapped(GetDengJiangli(), udg_H[index])
        call DisplayTextToPlayer(ConvertedPlayer(index), 0., 0., "|cFFFF66CC【消息】|r秘境挑战第"+ I2S(IDeng) + "层挑战成功！奖励"+GetItemName(GetLastCreatedItem())+"发放到了你的身上.")
        call PingMinimapForForce( YDWEGetForceOfPlayerNull(ConvertedPlayer(index)), GetUnitX(udg_H[index]), GetUnitY(udg_H[index]), 5.00 )
    endfunction
//---------------------------------------------------------------------------------------------------
    /*
        挑战成功的奖励与结算
    */
    private function MijingSucceed takes nothing returns nothing
        local integer i = 1
        loop
            exitwhen i > 6
            if ((GetPlayerSlotState(ConvertedPlayer(i)) == PLAYER_SLOT_STATE_PLAYING) and (GetPlayerController(ConvertedPlayer(i)) == MAP_CONTROL_USER) and udg_H[i] != null) then
                call Fafangmijing(i)
            endif
            set i = i +1
        endloop
        call SetTextTagTextBJ(TDeng,"第"+ I2S(IDeng) + "层",25)
        debug call SaveMijingAchievement(IDeng)
        call PlaySoundBJ(gg_snd_v_mijing)
    endfunction
//---------------------------------------------------------------------------------------------------
    /*
        挑战失败的结算
    */
    private function MijingFail takes nothing returns nothing
        call BJDebugMsg("|cFFFF66CC【消息】|r秘境挑战第"+ I2S(IDeng) + "层挑战失败!")
        set IDeng = IDeng - 1
    endfunction
//---------------------------------------------------------------------------------------------------
    /*
        清除所有秘境相关的数据
    */
    private function RemoveAllMijingUnit takes nothing returns nothing
        if (IsUnitAliveBJ(GetEnumUnit()) and GetOwningPlayer(GetEnumUnit()) == Player(11)) then
            call RemoveUnit(GetEnumUnit())
        endif
    endfunction
    private function DestroyAllMijing takes nothing returns nothing
        if (TDeathKou != null) then
            call DestroyTrigger(TDeathKou)
            set TDeathKou = null
        endif
        if (yexi != null) then
            if (IsUnitDeadBJ(yexi)) then
                debug call SaveAllPlayerAchievement(417)
            endif
        endif
        set yexi = null
        if (UDeng != null) then
            call RemoveUnit(UDeng)
        endif
        call DestroyTextTag(TDengProcess)
        set UDeng = null
        set TDengProcess = null
        call ForGroupBJ( GMijing, function RemoveAllMijingUnit )
        call DisableTrigger(TDengUnderAttacked)
        set BMijingStart = false
        set IProcess = 0
        set ITotalMonster = 0
        call PauseTimer(TMijingJudge)
        call DestroyTimer(TMijingJudge)
        set TMijingJudge = null
        call PauseTimer(TMijingBound)
        call DestroyTimer(TMijingBound)
        set TMijingBound = null
        if (TMijingFlash != null) then
            call PauseTimer(TMijingFlash)
            call DestroyTimer(TMijingFlash)
            set TMijingFlash = null
        endif
        call DestroyGroup(GMijing)
        set GMijing = null
    endfunction
//---------------------------------------------------------------------------------------------------
    /*
        秘境挑战的成功与失败判断
    */
    private function JudgeDengTimer takes nothing returns nothing
        set IProcess = IProcess + 1
        //失败条件:任一灯爆了
        if not(IsUnitAliveBJ(UDeng)) then
            call DestroyAllMijing()
            call MijingFail()
            return
        endif
        //胜利条件:100%或者没有怪了
        if (IProcess >= 100 or (GetMijingMonsterCount() == 0) and ITotalMonster >= I3(IDeng>=21,0,15) ) then
            call MijingSucceed()
            call DestroyAllMijing()
            return
        endif
        call SetTextTagTextBJ(TDengProcess,I2S(IProcess) + "%",20)
    endfunction
//---------------------------------------------------------------------------------------------------
    /*
        刷怪计时器
    */
    private function FlashMonsterTimer takes nothing returns nothing
        set ITotalMonster = ITotalMonster + udg_RENSHU
        if (ITotalMonster < 15) then
            //创建怪物
            call CreateMijingMonster()
        else
            call PauseTimer(TMijingFlash)
            call DestroyTimer(TMijingFlash)
            set TMijingFlash = null
        endif
    endfunction
//---------------------------------------------------------------------------------------------------
    /*
        检测怪物是否在地图外面,并去A灯
    */
    private function JudgeBoundTimer takes nothing returns nothing
        local group l_group = CreateGroup()
        local unit l_unit
        local integer count = 0
        local unit temp = null
        local rect r = gg_rct_M6
        call GroupAddGroup(GMijing,l_group)
        loop
            set l_unit = FirstOfGroup(l_group)
            exitwhen l_unit == null
            call GroupRemoveUnit(l_group, l_unit)
            if (IsUnitAliveBJ(l_unit) and GetOwningPlayer(l_unit) == Player(11)) then
                set temp = UDeng
                if not(RectContainsUnit(r, l_unit)) then
                    call SetUnitPosition(l_unit,GetRandomReal(GetRectMinX(r),GetRectMaxX(r)),GetRandomReal(GetRectMinY(r),GetRectMaxY(r)))
                endif
                call IssuePointOrderById(l_unit,851983,GetUnitX(temp)+GetRandomReal(-100,100),GetUnitY(temp)+GetRandomReal(-100,100))
            endif
        endloop
        call DestroyGroup(l_group)
        set l_group = null
        set l_unit =null
        set temp = null
        set r = null
    endfunction
//---------------------------------------------------------------------------------------------------
    /*
        开始秘境挑战
    */
    private function StartMijing takes nothing returns nothing
        local rect r = null
        debug set BJiulun = true
        if (IDeng >= 25) then
            call BJDebugMsg("|cFFFF66CC【消息】|r秘境挑战已经达到最高的25层，25层之后敬请期待.")
            return
        endif
        if (BMijingStart) then
            call DisplayTextToPlayer(GetOwningPlayer(GetBuyingUnit()), 0., 0., "|cFFFF66CC【消息】|r请完成当前挑战再挑战新的秘境.")
            return
        endif
        if (IDeng >= 10) then
            if ((GetPlayerState(GetOwningPlayer(GetBuyingUnit()), PLAYER_STATE_RESOURCE_LUMBER) < 1000)) then
                call DisplayTextToPlayer(GetOwningPlayer(GetBuyingUnit()), 0., 0., "|cFFFF66CC【消息】|r从11层秘境开始,需要消耗1000木头.")
                return
            endif
            call AdjustPlayerStateBJ( -1000, GetOwningPlayer(GetBuyingUnit()), PLAYER_STATE_RESOURCE_LUMBER )
        endif
        set IDeng = IDeng + 1
        //强化怪物
        if (IDeng == 12) then
            call SetPlayerTechResearchedSwap( 'R012', NanDiff + 1 , Player(10))
            call SetPlayerTechResearchedSwap( 'R012', NanDiff + 1 , Player(11))
        elseif (IDeng == 13) then
            call SetPlayerTechResearchedSwap( 'R014', NanDiff + 1 , Player(10))
            call SetPlayerTechResearchedSwap( 'R014', NanDiff + 1 , Player(11))
        elseif (IDeng == 14) then
            call SetPlayerTechResearchedSwap( 'R015', NanDiff + 1 , Player(10))
            call SetPlayerTechResearchedSwap( 'R015', NanDiff + 1 , Player(11))
        elseif (IDeng == 15) then
            call SetPlayerTechResearchedSwap( 'R016', NanDiff + 1 , Player(10))
            call SetPlayerTechResearchedSwap( 'R016', NanDiff + 1 , Player(11))
        elseif (IDeng == 17) then
            call SetPlayerTechResearchedSwap( 'R017', NanDiff + 1 , Player(10))
            call SetPlayerTechResearchedSwap( 'R017', NanDiff + 1 , Player(11))
        elseif (IDeng == 18) then
            call SetPlayerTechResearchedSwap( 'R018', NanDiff + 1 , Player(10))
            call SetPlayerTechResearchedSwap( 'R018', NanDiff + 1 , Player(11))
        elseif (IDeng == 19) then
            call SetPlayerTechResearchedSwap( 'R019', NanDiff + 1 , Player(10))
            call SetPlayerTechResearchedSwap( 'R019', NanDiff + 1 , Player(11))
        elseif (IDeng == 20) then
            call SetPlayerTechResearchedSwap( 'R01A', NanDiff + 1 , Player(10))
            call SetPlayerTechResearchedSwap( 'R01A', NanDiff + 1 , Player(11))
        endif
        //获取对应的区域
        set r = gg_rct_M6
        //创建对应的灯与对应的文字
        set UDeng = CreateUnit(Player(6),'n01H',GetRandomReal(GetRectMinX(r),GetRectMaxX(r)),GetRandomReal(GetRectMinY(r),GetRectMaxY(r)),0)
        set TDengProcess = CreateTextTagUnitBJ( "0%", UDeng, 0, 20, 100, 100, 0, 0 )
        call PingMinimap(GetUnitX(UDeng),GetUnitY(UDeng),5)
        set IProcess = 0
        set BMijingStart = true
        call BJDebugMsg("|cFFFF66CC【消息】|r第"+ I2S(IDeng) + "层秘境挑战将在5秒后开始！请尽量保持全员参战！")
        call YDWEPolledWaitNull(5)
        call BJDebugMsg("|cFFFF66CC【消息】|r挑战开始！")
        call EnableTrigger(TDengUnderAttacked)
        set TMijingJudge = CreateTimer()
        set GMijing = CreateGroup()
        //检测计时器
        call TimerStart(TMijingJudge,RCModeH(0.6,0.3),true,function JudgeDengTimer)
        if (IDeng >= 21) then
            call CreateYexi()
        else
            //刷怪计时器
            set TMijingFlash = CreateTimer()
            call TimerStart(TMijingFlash,RCModeH(1,0.5),true,function FlashMonsterTimer)
            //进攻与检测吸怪计时器
            set TMijingBound = CreateTimer()
            call TimerStart(TMijingBound,RCModeH(4,2),true,function JudgeBoundTimer)
        endif
        set r = null
    endfunction
//---------------------------------------------------------------------------------------------------
    /*
        进入秘境
    */
    function EnterMijing takes nothing returns nothing
        local real x
        local real y
        if ((GetItemTypeId(GetSoldItem()) == 'I02T')) then
            set x = GetRectCenterX(gg_rct_M6)
            set y = GetRectCenterY(gg_rct_M6)
            call SetUnitX(GetBuyingUnit(),x)
            call SetUnitY(GetBuyingUnit(),y)
            call PanCameraToTimedForPlayer(GetOwningPlayer(GetBuyingUnit()),x,y,0.2)
            call DestroyEffect( AddSpecialEffect("Abilities\\Spells\\Human\\MassTeleport\\MassTeleportCaster.mdl", x, y))
            call DisplayTextToPlayer( GetOwningPlayer(GetBuyingUnit()), 0, 0, "|cFFFF66CC【消息】|r回去输入“HG”。" )
        elseif ((GetItemTypeId(GetSoldItem()) == 'I048')) then
            call StartMijing()
        endif
    endfunction
//---------------------------------------------------------------------------------------------------
    /*
        秘境人数伤害加倍
    */
    private function DamageMijingCon takes nothing returns boolean
        return (IsUnitInGroup(GetTriggerUnit(),GMijing) or IsUnitInGroup(GetEventDamageSource(),GMijing)) and (GetEventDamage() >= 10.00)
    endfunction
    private function DamageMijingAct takes nothing returns nothing
        if (IsUnitInGroup(GetTriggerUnit(),GMijing) and udg_RENSHU > 1) then
            //减伤
            call SetUnitLifeBJ(GetTriggerUnit(),GetUnitState(GetTriggerUnit(),UNIT_STATE_LIFE)+GetEventDamage() *(1.0 - 1.0/I2R(udg_RENSHU)))
        elseif (IsUnitInGroup(GetEventDamageSource(),GMijing)) then
            //增伤
            call DisableTrigger(GetTriggeringTrigger())
            if (GetEventDamageSource() == yexi) then
                call UnitDamageTarget( GetEventDamageSource() , GetTriggerUnit(), 0.01 * udg_Nandu_JJJ * GetUnitState(GetTriggerUnit(),UNIT_STATE_MAX_LIFE), false, true, ATTACK_TYPE_CHAOS, DAMAGE_TYPE_SLOW_POISON, WEAPON_TYPE_WHOKNOWS )
            else
                if (udg_RENSHU > 1) then
                    call UnitDamageTarget( GetEventDamageSource() , GetTriggerUnit(), GetEventDamage() * (udg_RENSHU - 1), false, true, ATTACK_TYPE_CHAOS, DAMAGE_TYPE_SLOW_POISON, WEAPON_TYPE_WHOKNOWS )
                endif
                if (IsWanjie()) then
                    call UnitDamageTarget( GetEventDamageSource() , GetTriggerUnit(), 0.01 * udg_RENSHU * GetUnitState(GetTriggerUnit(),UNIT_STATE_MAX_LIFE), false, true, ATTACK_TYPE_CHAOS, DAMAGE_TYPE_SLOW_POISON, WEAPON_TYPE_WHOKNOWS )
                endif
            endif
            if (IsTianyan and GetTriggerUnit() != udg_H[GetConvertedPlayerId(GetOwningPlayer(GetTriggerUnit()))] and (GetPlayerController(GetOwningPlayer(GetEventDamageSource())) == MAP_CONTROL_COMPUTER)) then
                call UnitDamageTarget( GetEventDamageSource(),GetTriggerUnit() , GetUnitState(GetTriggerUnit(),UNIT_STATE_MAX_LIFE), false, true, ATTACK_TYPE_CHAOS, DAMAGE_TYPE_SLOW_POISON, WEAPON_TYPE_WHOKNOWS )
            endif
            call EnableTrigger(GetTriggeringTrigger())
        endif
    endfunction
//---------------------------------------------------------------------------------------------------
    /*
        初始化秘境
    */
	function InitMiJing takes nothing returns nothing
        local trigger t = CreateTrigger()
        set TDengUnderAttacked = CreateTrigger()
        call YDWESyStemAnyUnitDamagedRegistTrigger( TDengUnderAttacked )
        call DisableTrigger(TDengUnderAttacked)
        call TriggerAddCondition(TDengUnderAttacked, Condition(function TDengDamageCon))
        call TriggerAddAction(TDengUnderAttacked, function TDengDamageAct)
        set UMijingShangdian = CreateUnit(Player(PLAYER_NEUTRAL_PASSIVE), 'n01G', - 6144.0, - 10176.0, 270.000)
        set TDeng = CreateTextTagUnitBJ( "第0层", UMijingShangdian , 0, 25, 100, 0, 100, 0 )
        //秘境人数伤害的提高与伤害的减少
        call YDWESyStemAnyUnitDamagedRegistTrigger( t )
        call TriggerAddCondition(t, Condition(function DamageMijingCon))
        call TriggerAddAction(t, function DamageMijingAct)
        set t = null
	endfunction
endlibrary
// 传承试练
// 马甲模拟
///#include  "edit/NetVersion.j"
library_once MiniGame initializer InitMiniGame requires LHBase,Diffculty,SpellBase,Version
	globals
		private timer TGame1 = null
		private texttag TTGame1 = null
		private integer array IGoldGame1
		private integer TTimeGame1 = 0
		private group GGame1 = null
		//中级挑战
		private timer TGame2 = null
		private texttag TTGame2 = null
		private integer array IGoldGame2
		private integer TTimeGame2 = 0
		private group GGame2 = null
		private unit UGame2 = null
	endglobals
//---------------------------------------------------------------------------------------------------
	/*
	    小巨能会不断施放
	*/
	private function XiaojunengTimer takes nothing returns nothing
		local timer t = GetExpiredTimer()
		local integer id = GetHandleId(t)
		local unit u = LoadUnitHandle(LHTable,id,1)
		if (IsUnitAliveBJ(u)) then
     		call IssuePointOrder( u, "stampede",GetRectCenterX(gg_rct_Game1),GetRectCenterY(gg_rct_Game1) )
		else
			call PauseTimer(t)
			call FlushChildHashtable(LHTable,id)
			call DestroyTimer(t)
		endif
		set u = null
		set t = null
	endfunction
	private function StartTimerXiaojuneng takes unit u returns nothing
		local timer t = CreateTimer()
		call SaveUnitHandle(LHTable,GetHandleId(t),1,u)
		call TimerStart(t,5,true,function XiaojunengTimer)
		set t = null
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    召唤施放者并不断施放
	*/
	function CreateGame1Majia takes real angle returns nothing
		local real x = GetRectCenterX(gg_rct_Game1) + 200. * CosBJ(angle)
		local real y = GetRectCenterY(gg_rct_Game1) + 200. * SinBJ(angle)
		local unit u = CreateUnit(Player(10),'h01U',x,y,angle+180)
	    call UnitAddAbility( u,'A0DY' )
	    call SetUnitAbilityLevel( u,'A0DY', I3(IsWanjie(),7,3) )
     	call IssuePointOrder( u, "stampede",GetRectCenterX(gg_rct_Game1),GetRectCenterY(gg_rct_Game1) )
     	call GroupAddUnit(GGame1,u)
     	call StartTimerXiaojuneng(u)
     	set u = null
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    召唤施放者并不断施放
	*/
	private function MiniMissileBoom takes nothing returns nothing
		local timer t = GetExpiredTimer()
		local integer id = GetHandleId(t)
		local unit u = LoadUnitHandle(LHTable,id,1)
		if (IsUnitAliveBJ(u)) then
			call Missile.create(u,'hs01',"Units\\Demon\\Infernal\\InfernalBirth.mdl",300,1800,3,1,1000000000)
		else
			call PauseTimer(t)
			call FlushChildHashtable(LHTable,id)
			call DestroyTimer(t)
		endif
		set u = null
		set t = null
	endfunction
	private function RefreshMiniMingcha takes unit u returns nothing
		local timer t = CreateTimer()
		call SaveUnitHandle(LHTable,GetHandleId(t),1,u)
		call TimerStart(t,0.4,true,function MiniMissileBoom)
		set t = null
	endfunction
	function CreateGame2Majia takes nothing returns nothing
		local real x = GetRandomReal(GetRectMinX(gg_rct_Game2),GetRectMaxX(gg_rct_Game2))
		local real y = GetRandomReal(GetRectMinY(gg_rct_Game2),GetRectMaxY(gg_rct_Game2))
		local unit u = CreateUnit(Player(10),'h02D',x,y,GetRandomReal(0,360))
		call RefreshMiniMingcha(u)
     	call GroupAddUnit(GGame2,u)
     	set u = null
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    开启迷你挑战1
	*/
	//奖励值
	private function GetSpecifyTimeGold takes integer time returns integer
		return R2I(((I2R(TTimeGame1)/50.) + 1.) * (2.5* (I2R(udg_Bo)/2. +1)))
	endfunction
	private function FlashGame1Reward takes nothing returns nothing
		local integer i = 1
		local string s = ""
		set TTimeGame1 = TTimeGame1 + 1
		loop
			exitwhen i > 6
			if (IGoldGame1[i] != 0) then
				set IGoldGame1[i] = IGoldGame1[i] + GetSpecifyTimeGold(TTimeGame1) * CModeH(1,2)
				set s = s + GetUnitName(udg_H[i]) + ":" + I2S(IGoldGame1[i]) + "
				"
			endif
			set i = i +1
		endloop
		set s = s + "时间:" + I2S(TTimeGame1/10) + "s"
		call SetTextTagTextBJ(TTGame1,s,10)
		set s = null
		if (TTimeGame1 == 50) then
			call CreateGame1Majia(45.)
		elseif (TTimeGame1 == 100) then
			call CreateGame1Majia(135.)
		elseif (TTimeGame1 == 150) then
			call CreateGame1Majia(225.)
		elseif (TTimeGame1 == 200) then
			call CreateGame1Majia(0.)
		elseif (TTimeGame1 == 250) then
			call CreateGame1Majia(90.)
		elseif (TTimeGame1 == 300) then
			call CreateGame1Majia(180.)
		elseif (TTimeGame1 == 350) then
			call CreateGame1Majia(270.)
		elseif (ModuloInteger(TTimeGame1,50) == 0) then
			call CreateGame1Majia(GetRandomReal(0.,360.))
		endif
	endfunction
	private function StartGame1 takes nothing returns nothing
		if (TGame1 == null) then
			set TGame1 = CreateTimer()
			set GGame1 = CreateGroup()
			call TimerStart(TGame1,0.1,true,function FlashGame1Reward)
			set TTGame1 = CreateTextTagUnitBJ( "奖励", gg_unit_n01Q_0273, 0, 10, 0, 100, 0, 0 )
			set TTimeGame1 = 0
			call CreateGame1Majia(315.)
		endif
	endfunction
	private function RemoveAllMini takes nothing returns nothing
		call RemoveUnit(GetEnumUnit())
	endfunction
	private function DestroyGame1 takes nothing returns nothing
		if (TGame1 != null) then
			call PauseTimer(TGame1)
			call DestroyTimer(TGame1)
			call DestroyTextTag(TTGame1)
			set TGame1 = null
			call ForGroup(GGame1,function RemoveAllMini)
			call DestroyGroup(GGame1)
			set GGame1 = null
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    奖励值
	*/
	private function FlashGame2Reward takes nothing returns nothing
		local integer i = 1
		local string s = ""
		set TTimeGame2 = TTimeGame2 + 1
		loop
			exitwhen i > 6
			if (IGoldGame2[i] != 0) then
				set IGoldGame2[i] = IGoldGame2[i] + GetSpecifyTimeGold(TTimeGame2) * CModeH(1,2) * 4
				set s = s + GetUnitName(udg_H[i]) + ":" + I2S(IGoldGame2[i]) + "
				"
			endif
			set i = i +1
		endloop
		set s = s + "时间:" + I2S(TTimeGame2/10) + "s"
		call SetTextTagTextBJ(TTGame2,s,10)
		set s = null
		if (ModuloInteger(TTimeGame2,30) == 0) then
			call CreateGame2Majia()
		endif
	endfunction
	private function DestroyGame2 takes nothing returns nothing
		if (TGame2 != null) then
			call PauseTimer(TGame2)
			call DestroyTimer(TGame2)
			call DestroyTextTag(TTGame2)
			set TGame2 = null
			call ForGroup(GGame2,function RemoveAllMini)
			call DestroyGroup(GGame2)
			set GGame2 = null
			set TTGame2 = null
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    开始挑战2
	*/
	private function StartGame2 takes nothing returns nothing
		if (TGame2 == null) then
			set TGame2 = CreateTimer()
			call TimerStart(TGame2,0.1,true,function FlashGame2Reward)
			set GGame2 = CreateGroup()
			set TTGame2 = CreateTextTagUnitBJ( "奖励", UGame2, 0, 10, 0, 100, 0, 0 )
			set TTimeGame2 = 0
			call CreateGame2Majia()
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*

	    前往迷你挑战
	*/
	function EnterMiniGame takes nothing returns nothing
		local real x
		local real y
		if ((GetItemTypeId(GetSoldItem()) == 'I06K')) then
			set x = GetRectCenterX(gg_rct_Game1)
			set y = GetRectCenterY(gg_rct_Game1)
	        call SetUnitX(GetBuyingUnit(),x)
	        call SetUnitY(GetBuyingUnit(),y)
	        call PanCameraToTimedForPlayer(GetOwningPlayer(GetBuyingUnit()),x,y,0.2)
	        call DestroyEffect( AddSpecialEffect("Abilities\\Spells\\Human\\MassTeleport\\MassTeleportCaster.mdl", x, y))
	        call DisplayTextToPlayer( GetOwningPlayer(GetBuyingUnit()), 0, 0, "|cFFFF66CC【消息】|r回去输入“HG”。" )
	        return
	    elseif ((GetItemTypeId(GetSoldItem()) == 'I06M') and GetBuyingUnit() == udg_H[GetConvertedPlayerId(GetOwningPlayer(GetBuyingUnit()))] and RectContainsUnit(gg_rct_Game1,GetBuyingUnit())) then
	    	call StartGame1()
	    	call BJDebugMsg("|cFFFF66CC【消息】|r迷你挑战-骷髅海开始啦!")
            call PingMinimapForForce( GetPlayersAll(), GetRectCenterX(gg_rct_Game1) , GetRectCenterY(gg_rct_Game1), 5.00 )
		elseif ((GetItemTypeId(GetSoldItem()) == 'I07B')) then
			set x = GetRectCenterX(gg_rct_Game2)
			set y = GetRectCenterY(gg_rct_Game2)
	        call SetUnitX(GetBuyingUnit(),x)
	        call SetUnitY(GetBuyingUnit(),y)
	        call PanCameraToTimedForPlayer(GetOwningPlayer(GetBuyingUnit()),x,y,0.2)
	        call DestroyEffect( AddSpecialEffect("Abilities\\Spells\\Human\\MassTeleport\\MassTeleportCaster.mdl", x, y))
	        call DisplayTextToPlayer( GetOwningPlayer(GetBuyingUnit()), 0, 0, "|cFFFF66CC【消息】|r回去输入“HG”。" )
	        return
	    elseif ((GetItemTypeId(GetSoldItem()) == 'I07C') and GetBuyingUnit() == udg_H[GetConvertedPlayerId(GetOwningPlayer(GetBuyingUnit()))] and RectContainsUnit(gg_rct_Game2,GetBuyingUnit())) then
	    	call StartGame2()
	    	call BJDebugMsg("|cFFFF66CC【消息】|r迷你挑战-陨石雨开始啦!")
            call PingMinimapForForce( GetPlayersAll(), GetRectCenterX(gg_rct_Game2) , GetRectCenterY(gg_rct_Game2), 5.00 )
	    endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    区域玩家数量
	*/
	private function MiniGamePlayerFilter takes nothing returns boolean
		return GetFilterUnit() == udg_H[GetConvertedPlayerId(GetOwningPlayer(GetFilterUnit()))]
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    进入离开区域
	*/
	private function TMiniGameCon takes nothing returns boolean
		return GetTriggerUnit() == udg_H[GetConvertedPlayerId(GetOwningPlayer(GetTriggerUnit()))]
	endfunction
	//离开1事件
	private function TLeaveMiniGameAct takes nothing returns nothing
		local integer id = GetConvertedPlayerId(GetOwningPlayer(GetTriggerUnit()))
        local group group1 = YDWEGetUnitsInRectMatchingNull(gg_rct_Game1, Condition(function MiniGamePlayerFilter))
		if (IGoldGame1[id] != 1) then
		 	call AddHeroXP( udg_H[id], R2I(IGoldGame1[id] * 0.4 * udg_I_Jingyan[id]), true )
		    call AdjustPlayerStateBJ( R2I(IGoldGame1[id] * udg_I_Jinqianhuodelv[id]), GetOwningPlayer(GetTriggerUnit()), PLAYER_STATE_RESOURCE_GOLD )
		    call DisplayTextToPlayer(GetOwningPlayer(GetTriggerUnit()), 0., 0., "|cFFFF66CC【消息】|r你通过迷你挑战获得了"+I2S(R2I(IGoldGame1[id] * udg_I_Jinqianhuodelv[id]))+"的金钱奖励和"+I2S(R2I(IGoldGame1[id] * 0.4 * udg_I_Jingyan[id]))+"的经验奖励,成功坚持了"+I2S(TTimeGame1/10)+"秒.")
		    debug if (TTimeGame1/10 > 35) then
				debug call GetAchievementAndSave(ConvertedPlayer(id),43)
			debug endif
			debug if (TTimeGame1/10 > 80) then
				debug call GetAchievementAndSave(ConvertedPlayer(id),44)
		    debug endif
		endif
		set IGoldGame1[id] = 0
        if (CountUnitsInGroup(group1) == 0) then
        	call DestroyGame1()
        endif
        call DestroyGroup( group1 )
        set group1 = null
	endfunction
	//离开2事件
	private function TLeaveMiniGame2Act takes nothing returns nothing
		local integer id = GetConvertedPlayerId(GetOwningPlayer(GetTriggerUnit()))
        local group group1 = YDWEGetUnitsInRectMatchingNull(gg_rct_Game2, Condition(function MiniGamePlayerFilter))
		if (IGoldGame2[id] != 1) then
		 	call AddHeroXP( udg_H[id], R2I(IGoldGame2[id] * 0.4 * udg_I_Jingyan[id]), true )
		    call AdjustPlayerStateBJ( R2I(IGoldGame2[id] * udg_I_Jinqianhuodelv[id]), GetOwningPlayer(GetTriggerUnit()), PLAYER_STATE_RESOURCE_GOLD )
		    call DisplayTextToPlayer(GetOwningPlayer(GetTriggerUnit()), 0., 0., "|cFFFF66CC【消息】|r你通过迷你挑战获得了"+I2S(R2I(IGoldGame2[id] * udg_I_Jinqianhuodelv[id]))+"的金钱奖励和"+I2S(R2I(IGoldGame2[id] * 0.4 * udg_I_Jingyan[id]))+"的经验奖励,成功坚持了"+I2S(TTimeGame2/10)+"秒.")
		endif
		set IGoldGame2[id] = 0
        if (CountUnitsInGroup(group1) == 0) then
        	call DestroyGame2()
        endif
        call DestroyGroup( group1 )
        set group1 = null
	endfunction
	//进入事件
	private function TEnterMiniGameAct takes nothing returns nothing
		if (RectContainsUnit(gg_rct_Game1,GetTriggerUnit())) then
			set IGoldGame1[GetConvertedPlayerId(GetOwningPlayer(GetTriggerUnit()))] = 1
		elseif (RectContainsUnit(gg_rct_Game2,GetTriggerUnit())) then
			set IGoldGame2[GetConvertedPlayerId(GetOwningPlayer(GetTriggerUnit()))] = 1
			if not(udg_Zhandouli[GetConvertedPlayerId(GetOwningPlayer(GetTriggerUnit()))] > 5000) then
		        call SetUnitX(GetTriggerUnit(),GetRectCenterX(gg_rct_Game1))
		        call SetUnitY(GetTriggerUnit(),GetRectCenterY(gg_rct_Game1))
		        call DisplayTextToPlayer(GetOwningPlayer(GetTriggerUnit()), 0., 0., "|cFFFF66CC【消息】|r需要战斗力大于5000才能上去,你目前战斗力为"+I2S(udg_Zhandouli[GetConvertedPlayerId(GetOwningPlayer(GetTriggerUnit()))])+".")
			endif
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    伤害事件
	*/
	function SimulateDamageMiniGame takes unit u returns boolean
		if ((GetUnitTypeId(u) == 'h01U' or GetUnitTypeId(u) == 'h02D') and GetTriggerUnit() == udg_H[GetConvertedPlayerId(GetOwningPlayer(GetTriggerUnit()))]) then
				call HG(GetTriggerUnit())
			return true
		endif
		return false
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    初始化迷你游戏
	*/
	private function InitMiniGame takes nothing returns nothing
		//离开1的事件
        local trigger t = CreateTrigger()
        call YDWETriggerRegisterLeaveRectSimpleNull( t, gg_rct_Game1 )
        call TriggerAddCondition(t, Condition(function TMiniGameCon))
        call TriggerAddAction(t, function TLeaveMiniGameAct)
        //进入12的事件
        set t = CreateTrigger()
        call YDWETriggerRegisterEnterRectSimpleNull( t, gg_rct_Game1 )
        call YDWETriggerRegisterEnterRectSimpleNull( t, gg_rct_Game2 )
        call TriggerAddCondition(t, Condition(function TMiniGameCon))
        call TriggerAddAction(t, function TEnterMiniGameAct)
        //离开2的事件
        set t = CreateTrigger()
        call YDWETriggerRegisterLeaveRectSimpleNull( t, gg_rct_Game2 )
        call TriggerAddCondition(t, Condition(function TMiniGameCon))
        call TriggerAddAction(t, function TLeaveMiniGame2Act)
        set UGame2 = CreateUnit(Player(PLAYER_NEUTRAL_PASSIVE),'n022',GetRectCenterX(gg_rct_Game2),GetRectCenterY(gg_rct_Game2),270)
        set t = null
	endfunction
endlibrary
///#include  "edit/CenterCredit.j"
/*
    马甲模拟
*/
library_once Simulate initializer InitSimulate requires LHBase,SpellBase,Heiyan,Yanmie,CenterCredit,ItemSpell,MiniGame,Boss,MiJing
//---------------------------------------------------------------------------------------------------
	/*
	    马甲伤害模拟总列表
	*/
	private function SimulateDamageCon takes nothing returns boolean
		return (GetEventDamage() > 0) and (IsUnitIllusion(GetEventDamageSource()) == false)
	endfunction
	function SimulateAllDamage takes unit u returns nothing
		if (SimulateDamageHeiyan(u)) then
			return
		elseif (SimulateDamageYanmie(u)) then
			return
		elseif (SimulateDamageMoqi(u)) then
			return
		elseif (SimulateDamageKaisa(u)) then
			return
		elseif (SimulateDamageHuanyi(u)) then
			return
		elseif (SimulateDamageMengji(u)) then
			return
		elseif (SimulateDamageCangling(u)) then
			return
		elseif (SimulateDamageXiaoting(u)) then
			return
		elseif (SimulateDamageLichi(u)) then
			return
		elseif (SimulateDamageSoldier(u)) then
			return
		elseif (SimulateDamageItem(u)) then
			return
		elseif (SimulateDamageMiniGame(u)) then
			return
		elseif (SimulateDamageBoss(u)) then
			return
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    马甲的死亡事件总列表
	*/
	private function SimulateAllDeath takes nothing returns nothing
		call SimulateDeathYanmie(GetDyingUnit())
		call SimulateDeathHeiyan(GetDyingUnit())
		call SimulateDeathHuanyi(GetDyingUnit())
		call SimulateDeathSichen(GetDyingUnit())
		call SimulateDeathXinglong(GetDyingUnit())
		call SimulateDeathLichi(GetDyingUnit())
		call SimulateDeathMijing(GetDyingUnit())
		call SimulateDeathMoqi(GetDyingUnit())
		call SimulateDeathKaisa(GetDyingUnit())
	endfunction
//---------------------------------------------------------------------------------------------------
	private function InitSimulate takes nothing returns nothing
	    local trigger t = CreateTrigger()
		call TriggerRegisterAnyUnitEventBJ(t,EVENT_PLAYER_UNIT_DEATH)
		call TriggerAddAction(t, function SimulateAllDeath)
		set t = null
	endfunction
endlibrary
// 导入指令
///#include  "edit/Continous.j"
/*
    游戏指令
    -kill自杀
*/
library_once ChatCommand initializer InitChatCommand requires LHBase,PIV,Version,Diffculty,Xuanxue,Huanyi,Bajue,Juexing,Hanshang,BaseVersion//,Continous
	globals
		private item array IBox
		private integer IBoxSucceed = 0
		private integer IBoxCount = 0
		private boolean array BYincang
		boolean BShengli = false
	endglobals
//---------------------------------------------------------------------------------------------------
	/*
	    合成宝箱
	*/
	//! textmacro CombineBox takes Level,Itemtype,NewItem
		function CombineBox$Level$ takes nothing returns nothing
		    if ((GetItemTypeId(GetEnumItem()) == '$Itemtype$')) then
				if (HaveSavedInteger(YDHT, GetHandleId(GetEnumItem()), 0xA75AD423) and (GetConvertedPlayerId(GetOwningPlayer(GetTriggerUnit())) != LoadInteger(YDHT,GetHandleId(GetEnumItem()),0xA75AD423))) then
						return
				endif
		    	set IBox[IBoxCount] = GetEnumItem()
		    	set IBoxCount = IBoxCount + 1
		    endif
		    if (IBoxCount >= 3) then
		    	if (IBox[0] == null or IBox[1] == null or IBox[2] == null) then
			    	set IBoxCount = 0
		    		return
		    	endif
		    	call RemoveItem(IBox[0])
		    	call RemoveItem(IBox[1])
		    	call RemoveItem(IBox[2])
		    	call CreateItem('$NewItem$',GetUnitX(udg_H[GetConvertedPlayerId(GetTriggerPlayer())]),GetUnitY(udg_H[GetConvertedPlayerId(GetTriggerPlayer())]))
		    	set IBox[0] = null
		    	set IBox[1] = null
		    	set IBox[2] = null
		    	set IBoxCount = 0
		    	set IBoxSucceed = IBoxSucceed + 3
		    endif
		endfunction
	//! endtextmacro
	//! runtextmacro CombineBox("E","hlst","wshs")
	//! runtextmacro CombineBox("D","wshs","wild")
	//! runtextmacro CombineBox("C","wild","totw")
	//! runtextmacro CombineBox("B","totw","sror")
	//! runtextmacro CombineBox("A","sror","fgrg")
	function CombineBox takes nothing returns nothing
		if not(IsPIV(GetTriggerPlayer())) then
			call DisplayTextToPlayer( GetTriggerPlayer(), 0, 0, "|cFFFF66CC【消息】|r需要成为永久赞助才能使用此指令!" )
			return
		endif
		call BJDebugMsg("|cFFFF66CC【消息】|r"+GetUnitName(udg_H[GetConvertedPlayerId(GetTriggerPlayer())])+"使用指令-hc成功将地上的所有宝箱融合成为更高级的宝箱，列表如下：")
    	set IBox[0] = null
    	set IBox[1] = null
    	set IBox[2] = null
    	set IBoxCount = 0
    	set IBoxSucceed = 0
   		call EnumItemsInRectBJ( GetPlayableMapRect(), function CombineBoxE )
   		if (IBoxSucceed != 0) then
	   		call BJDebugMsg(I2S(IBoxSucceed)+"个E级宝箱→→→"+I2S(IBoxSucceed/3)+"个D级宝箱。")
	    	set IBoxSucceed = 0
   		endif
    	set IBox[0] = null
    	set IBox[1] = null
    	set IBox[2] = null
    	set IBoxCount = 0
   		call EnumItemsInRectBJ( GetPlayableMapRect(), function CombineBoxD )
   		if (IBoxSucceed != 0) then
	   		call BJDebugMsg(I2S(IBoxSucceed)+"个D级宝箱→→→"+I2S(IBoxSucceed/3)+"个C级宝箱。")
	    	set IBoxSucceed = 0
   		endif
    	set IBox[0] = null
    	set IBox[1] = null
    	set IBox[2] = null
    	set IBoxCount = 0
   		call EnumItemsInRectBJ( GetPlayableMapRect(), function CombineBoxC )
   		if (IBoxSucceed != 0) then
	   		call BJDebugMsg(I2S(IBoxSucceed)+"个C级宝箱→→→"+I2S(IBoxSucceed/3)+"个B级宝箱。")
	    	set IBoxSucceed = 0
   		endif
    	set IBox[0] = null
    	set IBox[1] = null
    	set IBox[2] = null
    	set IBoxCount = 0
   		call EnumItemsInRectBJ( GetPlayableMapRect(), function CombineBoxB )
   		if (IBoxSucceed != 0) then
	   		call BJDebugMsg(I2S(IBoxSucceed)+"个B级宝箱→→→"+I2S(IBoxSucceed/3)+"个A级宝箱。")
	    	set IBoxSucceed = 0
   		endif
    	set IBox[0] = null
    	set IBox[1] = null
    	set IBox[2] = null
    	set IBoxCount = 0
   		call EnumItemsInRectBJ( GetPlayableMapRect(), function CombineBoxA )
   		if (IBoxSucceed != 0) then
	   		call BJDebugMsg(I2S(IBoxSucceed)+"个A级宝箱→→→"+I2S(IBoxSucceed/3)+"个S级宝箱。")
	    	set IBoxSucceed = 0
   		endif
    	set IBox[0] = null
    	set IBox[1] = null
    	set IBox[2] = null
    	set IBoxCount = 0
   		endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    清除地上的所有宝石
	*/
	private function ClearDiamondFunc takes nothing returns nothing
	    if (IsDiamond(GetEnumItem()) and IsItemVisible(GetEnumItem())) then
	    	call RemoveItem(GetEnumItem())
	    endif
	endfunction
	private function ClearDiamond takes nothing returns nothing
   		call EnumItemsInRectBJ( GetPlayableMapRect(), function ClearDiamondFunc )
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    调视角
	*/
	function FixView takes boolean higher returns nothing
		if (higher) then
			call SetCameraFieldForPlayer( GetTriggerPlayer(), CAMERA_FIELD_ZOFFSET, ( GetCameraTargetPositionZ() + 400.00 ), 0 )
		else
			call SetCameraFieldForPlayer( GetTriggerPlayer(), CAMERA_FIELD_ZOFFSET, ( GetCameraTargetPositionZ() - 400.00 ), 0 )
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    隐藏面板
	*/
	private function YincangBroad takes nothing returns nothing
		if not(BYincang[GetConvertedPlayerId(GetTriggerPlayer())]) then
			call LeaderboardDisplayBJ( false, udg_Paihang[GetConvertedPlayerId(GetTriggerPlayer())] )
			call DisplayTextToPlayer(GetTriggerPlayer(), 0., 0., "|cFFFF66CC【消息】|r如果要面板显示请再次输入-yc.")
		else
			call LeaderboardDisplayBJ( true, udg_Paihang[GetConvertedPlayerId(GetTriggerPlayer())] )
   		endif
   		set BYincang[GetConvertedPlayerId(GetTriggerPlayer())] = not (BYincang[GetConvertedPlayerId(GetTriggerPlayer())])
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    聊天信息"-"指令
	*/
	function ChatCommandAct takes nothing returns nothing
		local string str = GetEventPlayerChatString()
		local unit u = udg_H[GetConvertedPlayerId(GetTriggerPlayer())]
		//自杀
		if (str == "-kill" and not(RectContainsUnit(gg_rct_Game1, udg_H[GetConvertedPlayerId(GetTriggerPlayer())]))) then
			call KillSelf(u)
		    call DisplayTextToPlayer( GetTriggerPlayer(), 0, 0, "|cFFFF66CC【消息】|r自杀成功!" )
		    return
		elseif (str == "-hc") then
			call CombineBox()
		elseif (str == "-bs") then
			call ClearDiamond()
		debug elseif (str == "-hs1") then
		debug call Jiance1(u)
		debug elseif (str == "-hs2" and u != bajue) then
		debug call Jiance2(u)
		debug elseif (str == "-hs3") then
		debug call Jiance3(u)
		elseif (str == "-+") then
			call FixView(true)
		elseif (str == "-chenji" and u == chenji) then
			call ChenjiJiance()
		elseif (str == "-ph") then
			call CameraSetSmoothingFactor( 0. )
		elseif (str == "-qxpf") then
			set BCancelSpin[GetConvertedPlayerId(GetTriggerPlayer())] = true
			call BJDebugMsg("|cFFFF66CC【消息】|r成功取消皮肤效果.")
		elseif (str == "-dm") then
			call MultiboardDisplayBJ( true, udg_D )
			call BJDebugMsg("|cFFFF66CC【消息】|r开启显示多面板.")
		elseif (str == "--") then
			call FixView(false)
		debug elseif (str == "-ck") then
		debug if (GetUnitTypeId(UDepot[GetConvertedPlayerId(GetTriggerPlayer())]) != 'nmgv') then
				debug set BBoxName[GetConvertedPlayerId(GetTriggerPlayer())] = true
				debug call DisplayTextToPlayer(GetTriggerPlayer(), 0., 0., "|cFFFF66CC【消息】|r现在请输入你要自定义的仓库头衔吧（注意不要掺杂有英文与数字）!")
				debug else
					debug call DisplayTextToPlayer(GetTriggerPlayer(), 0., 0., "|cFFFF66CC【消息】|r默认箱子皮肤不能使用该指令，如要使用请解锁任意箱子皮肤再使用!")
		debug endif
		debug elseif (str == "-mm1" and playerName[GetConvertedPlayerId(GetTriggerPlayer())] == "信哲大人") then
		debug set BX1 = not(BX1)
		debug elseif (str == "-mm2" and playerName[GetConvertedPlayerId(GetTriggerPlayer())] == "信哲大人") then
			set BX2 = not(BX2)
		debug call SetDIYName(GetTriggerPlayer(),"信手哲天富可敌国")
		elseif (str == "-wx1" and playerName[GetConvertedPlayerId(GetTriggerPlayer())] == "无心使者") then
			set JJ1 = not(JJ1)
			call DisplayTextToPlayer(GetTriggerPlayer(), 0., 0., "|cFFFF66CC【消息】|r1")
		elseif (str == "-wx2" and playerName[GetConvertedPlayerId(GetTriggerPlayer())] == "无心使者") then
			set JJ2 = not(JJ2)
			call DisplayTextToPlayer(GetTriggerPlayer(), 0., 0., "|cFFFF66CC【消息】|r2")
		elseif (str == "-wx3" and playerName[GetConvertedPlayerId(GetTriggerPlayer())] == "无心使者" and not(JJ3)) then
			set JJ3 = true
			call DisplayTextToPlayer(GetTriggerPlayer(), 0., 0., "|cFFFF66CC【消息】|r3")
	        call AddDamagePercent(GetConvertedPlayerId(GetTriggerPlayer()),1.5)
	        call UnitAddAbility(u,'A0MU')
			call SetPlayerAbilityAvailable(GetOwningPlayer(u),'A0MU',false)
            call UnitMakeAbilityPermanent(u,true,'A0MU')
            call UnitMakeAbilityPermanent(u,true,'A0MG')
		elseif (str == "-wx4" and playerName[GetConvertedPlayerId(GetTriggerPlayer())] == "无心使者" and not(JJ4) and (u == kaisa or u == hanshang)) then
			call InitHeroJuexing1(u)
			call InitHeroJuexing2(u)
			call InitHeroJuexing3(u)
			set JJ4 = true
			call DisplayTextToPlayer(GetTriggerPlayer(), 0., 0., "|cFFFF66CC【消息】|r4")
		debug elseif (str == "-我爱轮回之狱作者") then
		debug call Buchang(GetTriggerPlayer())
		//玄雪皮肤
		elseif (str == "-xx" and GetOwningPlayer(xuanxue) == GetTriggerPlayer()) then
			call InitHongdeng()
			call DisplayTextToPlayer(GetOwningPlayer(xuanxue), 0., 0., "|cFFFF66CC【消息】|r开启玄雪英雄挑战.")
		//炼金皮肤
		elseif (str == "-lj" and GetOwningPlayer(hanshang) == GetTriggerPlayer()) then
			call InitDuxin()
			call DisplayTextToPlayer(GetOwningPlayer(hanshang), 0., 0., "|cFFFF66CC【消息】|r开启寒殇英雄挑战.")
		//玄雪皮肤
		elseif (str == "-bj" and GetOwningPlayer(bajue) == GetTriggerPlayer()) then
			call InitFengshuang()
			call DisplayTextToPlayer(GetOwningPlayer(bajue), 0., 0., "|cFFFF66CC【消息】|r开启霸绝英雄挑战.")
		//幻逸皮肤
		elseif (str == "-hy" and GetOwningPlayer(Huanyi) == GetTriggerPlayer()) then
			call InitHuanyiTiaozhan()
			call DisplayTextToPlayer(GetOwningPlayer(bajue), 0., 0., "|cFFFF66CC【消息】|r开启幻逸英雄挑战.")
		elseif (str == "-yc") then
			call YincangBroad()
		debug elseif (str == "-bq" and renshu == 1) then
		debug call Buqian1(GetTriggerPlayer())
		debug elseif (str == "-ckhq" and renshu == 1 and not(BCangkuhuoqu)) then
		debug set BCangkuhuoqu = true
		debug call BJDebugMsg("|cFFFF66CC【消息】|r请输入你的仓库指令码")
		debug elseif (str == "-sphq" and renshu == 1 and not(BSpinhuoqu)) then
		debug set BSpinhuoqu = true
		debug call BJDebugMsg("|cFFFF66CC【消息】|r请输入你的皮肤指令码")
		debug elseif (str == "-ac1" and renshu == 1 and ISpinachi == 0) then
		debug set ISpinachi = 1
		debug call BJDebugMsg("|cFFFF66CC【消息】|r请输入你的成就指令码")
		debug elseif (str == "-ac2" and renshu == 1 and ISpinachi == 0) then
		debug set ISpinachi = 2
		debug call BJDebugMsg("|cFFFF66CC【消息】|r请输入你的成就指令码")
		debug elseif (str == "-ac3" and renshu == 1 and ISpinachi == 0) then
		debug set ISpinachi = 3
		debug call BJDebugMsg("|cFFFF66CC【消息】|r请输入你的成就指令码")
		debug elseif (str == "-ac4" and renshu == 1 and ISpinachi == 0) then
		debug set ISpinachi = 4
		debug call BJDebugMsg("|cFFFF66CC【消息】|r请输入你的成就指令码")
		elseif (str == "-sh") then
			set BHideDamage[GetConvertedPlayerId(GetTriggerPlayer())] = not (BHideDamage[GetConvertedPlayerId(GetTriggerPlayer())])
			call DisplayTextToPlayer(GetTriggerPlayer(), 0., 0., "|cFFFF66CC【消息】|r成功显示/隐藏伤害.")
		elseif (str == "-zz") then
			call CancelVIP(GetTriggerPlayer())
		elseif (str == "-yxjs" and GetTriggerPlayer() == GetFirstPlayer() and BShengli) then
		    call ForForce( GetPlayersAll(), function ShengliAll )
		debug elseif (str == "-qm") then
			debug if (IsQuanchengjiu(GetTriggerPlayer())) then
				debug set BDIYName[GetConvertedPlayerId(GetTriggerPlayer())] = true
				debug call DisplayTextToPlayer(GetTriggerPlayer(), 0., 0., "|cFFFF66CC【消息】|r现在请输入你要自定义的成就名吧!")
			debug else
				debug call DisplayTextToPlayer(GetTriggerPlayer(), 0., 0., "|cFFFF66CC【消息】|r你未解锁所有成就.")
			debug endif
		elseif (str == "-qc") then
			if (TBianse[GetConvertedPlayerId(GetTriggerPlayer())] != null) then
				call SetUnitVertexColor( udg_H[GetConvertedPlayerId(GetTriggerPlayer())], 255, 255, 255, 255 )
				call PauseTimer(TBianse[GetConvertedPlayerId(GetTriggerPlayer())])
				call DestroyTimer(TBianse[GetConvertedPlayerId(GetTriggerPlayer())])
				call FlushChildHashtable(itemTable,GetHandleId(TBianse[GetConvertedPlayerId(GetTriggerPlayer())]))
			endif
		elseif (str == "-ms") then
			set BMoshou[GetConvertedPlayerId(GetTriggerPlayer())] = not (BMoshou[GetConvertedPlayerId(GetTriggerPlayer())])
			if (BMoshou[GetConvertedPlayerId(GetTriggerPlayer())]) then
				call DisplayTextToPlayer(GetTriggerPlayer(), 0., 0., "|cFFFF66CC【消息】|r重新装备魔兽后，魔兽将不会被点中，主动技能也会主动释放。")
			else
				call DisplayTextToPlayer(GetTriggerPlayer(), 0., 0., "|cFFFF66CC【消息】|r重新装备魔兽后，魔兽可以被点中，主动技能也能手动释放。")
			endif
		debug elseif (str == "-cj") then
			debug call CreateAchievementDialog(GetTriggerPlayer())
		endif
		set str = null
		set u = null
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    小提示
	*/
	private function ShowHint takes nothing returns nothing
		local string s = null
		local integer i = GetRandomInt(1,59)
		if(i == 1 ) then
			set s = "炼狱所爆的魔兽可以提高英雄的生命恢复速度还有魔法恢复速度哦~"
		elseif(i == 2 ) then
			set s = "战魂升级到了高等级时,复活只需要3秒哦~"
		elseif(i == 3 ) then
			set s = "顶级法魂可以一次性召唤3个强大的地狱火哦~"
		elseif(i == 4 ) then
			set s = "魔法上限的来源：1.合成仙器法魂.2.天庭处打魔法上限和回复增益。"
		elseif(i == 5 ) then
			set s = "鬼器|cffffff00追魂夺魄戒|r是一件打怪升级型装备，由千年孤魂处获得，越早打越好哦！"
		elseif(i == 6 ) then
			set s = "3个宝箱可以合成一个更高级的宝箱哦!"
		elseif(i == 7 ) then
			set s = "想快速清怪请在基地上方的“战斗调整”处调成1-3s，想稳定守家请在基地上方的“战斗调整”调成4-6s。"
		elseif(i == 8 ) then
			set s = "尽量不要让上下两波怪融合，他们的战斗力会因此提高很多倍。"
		elseif(i == 9 ) then
			set s = "神器只需要合到+6就可以了，而人器需要合到+9。"
		elseif(i == 10) then
			set s = "炼狱所爆的魔兽是可以一直守护着英雄."
		elseif(i == 11) then
			set s = "10转以后的镜像会主动对你发动进攻,20转后镜像将会逐步解锁一定的技能."
		elseif(i == 12) then
			set s = "前来进攻的BOSS都具有“秒杀之刃”技能，能对非英雄造成"+I2S(udg_Nandu_JJJ)+"%的生命伤害。"
		elseif(i == 13) then
			set s = "各个英雄都对应五界中的一界，得到相应界域中的装备，会获得专属技能。"
		elseif(i == 14) then
			set s = "木头在基地中用钱换。"
		elseif(i == 15) then
			set s = "地图采用的是伤害人头获取金币系统，击杀怪物的玩家可以获取所有金币."
		elseif(i == 16) then
			set s = "难度越高，天庭中能同时增益的数量也越多。"
		elseif(i == 17) then
			set s = "中期觉得钱没用了，可以用来合成仙器。"
		elseif(i == 18) then
			set s = "一个怪若全由炮塔杀，玩家将不会得到金币."
		elseif(i == 19) then
			set s = "虚界怪物具有闪电链技能."
		elseif(i == 20) then
			set s = "每波炼狱都拥有不同的技能， 弄清他们的技能，就很容易突破。"
		elseif(i == 21) then
			set s = "妖族英雄在获取第三双翅膀后解锁专属技能,神人仙鬼英雄也类似获得相应界域的装备."
		elseif(i == 22) then
			set s = "炼狱每打过2个BOSS就可以获得对应的魔兽."
		elseif(i == 23) then
			set s = "顶级宝石：巨能融合石在每次击杀后能力会提高20%，所以请做好准备再去。"
		elseif(i == 24) then
			set s = "转生的难度随着能力的提高，等级越高越难转，所以趁着等级低去转吧。"
		elseif(i == 25) then
			set s = "炼狱挑战获取的魔兽可以大幅度提高英雄的生命,不过对于属性的加成比较少."
		elseif(i == 26) then
			set s = "|cffff9900幽冥项链|r是一件提高百分比属性的装备，任意时期都可以挑战获得。"
		elseif(i == 27) then
			set s = "擂台的所有英雄都有干扰之刃技能，能对非挑战目标造成3%的生命伤害。"
		elseif(i == 28) then
			set s = "输入“-ym”可以清除地上所有的羽毛，防止游戏过卡哦。"
		elseif(i == 29) then
			set s = "若出现了英雄死亡不复活的BUG，可以输入“-fh”来解决。"
		elseif(i == 30) then
			set s = "基地右边的仙器可以升级，满级战魂复活只需要4秒，满级法魂能减少80%的魔法伤害哦，赶紧试试吧！"
		elseif(i == 31) then
			set s = "基地右边的仙器在对付后期的怪物时有强大的防守功效，强烈建议合成一个！"
		elseif(i == 32) then
			set s = "宝石区的怪物来自虚界，拥有强大的魔法伤害，而仙器法魂能有效减少这些伤害！"
		elseif(i == 33) then
			set s = "如果感觉有时不明白为什么就死了，那有可能因为怪物的魔法伤害过于高，而你的魔法抗性过低，可以合成法魂有效阻抗该伤害，或者合成战魂快速复活"
		elseif(i == 34) then
			set s = "最后的BOSS的技能是需要躲避的,不要小看了这些技能的威力!"
		elseif(i == 35) then
			set s = "法魂召唤出的地狱火可以放到刷钱房中去帮你自动刷钱,也可以在炼狱中帮你承担一定的伤害!"
		elseif(i == 36) then
			set s = "注意保持自己的护甲处于正数!当护甲低于0时怪物将对你造成接近于2倍攻击的伤害!"
		elseif(i == 37) then
			set s = "翅膀能每间隔一定的时间对周围一个敌人射出一道火焰造成伤害,不过宠物携带无效."
		elseif(i == 38) then
			set s = "快速升级|cffffff00追魂夺魄戒|r的方法是让召唤物/雇佣兵在练功房帮你刷怪!"
		elseif(i == 39) then
			set s = "神器上的多重攻击其实是有效的,为了防止后期卡顿才不显示弹道效果."
		elseif(i == 40) then
			set s = "|cffff00ff琉璃璞玉|r能让宝石升级装备时的成功率达到100%."
		elseif(i == 41) then
			set s = "到了后期,你可以使用杀怪积分在左边的\"好东西\"商店兑换基地防护罩等好东西哦!"
		elseif(i == 42) then
			set s = "每个英雄都有独特的光环对全地图的队友提供增益,因此人多时增益也会增多,更容易通关."
		elseif(i == 43) then
			set s = "擂台是每位玩家独立挑战获取装备的地方哦!"
		elseif(i == 44) then
			set s = "不要用低级的宠物去打BOSS或者高级的宠物,可能会被反控或者受到巨大伤害."
		elseif(i == 45) then
			set s = "击败4级野区怪物可以让所有玩家获取1000木头哦!"
		elseif(i == 46) then
			set s = "有关于永久赞助的内容,请前往复活点礼包处或者在F9任务处了解."
		elseif(i == 47) then
			set s = "如果你通关|cff008000万劫难度|r的话.|cffffff00你的名字|r将可以在本地图永久性地荣登于|cff008000\"封帝万劫录\"|r中哦!"
		elseif(i == 48) then
			set s = "挑战巨能融合石时请利用走位躲开会秒杀的骷髅海技能!"
		elseif(i == 49) then
			set s = "每个英雄都拥有对全地图队友增益的光环效果,人多力量更大!"
		elseif(i == 50) then
			set s = "轮回之狱主群欢迎你的加入:1群:148199145(满)/2群:413359254。"
		elseif(i == 51) then
			set s = "输入-cj可以更换你的成就哦,还可以查询你拥有的所有成就,也可以查询所有成就的获取条件."
		elseif(i == 52) then
			set s = "秘境中成功通过某一层有2种方法，一种是将灯在60秒内成功点亮，另一种方法则是直接消灭所有怪物。"
		elseif(i == 53) then
			set s = "英雄可以通过明灯对天赋技能进行一阶/二阶/三阶觉醒，明灯可从秘境中获取，总共有25层挑战～"
		elseif(i == 54) then
			set s = "某些英雄有特定的皮肤，这些皮肤可以通过英雄挑战来永久获取。（在基地左侧查看条件）"
		elseif(i == 55) then
			set s = "当前在线的玩家越多，秘境中怪物伤害越高也越强。"
		elseif(i == 56) then
			set s = "秘境中的明灯可以抵挡20次攻击，你可以通过治疗的方式令其恢复生命，而只要灯被摧毁，则挑战失败。"
		elseif(i == 57) then
			set s = "你可以输入-+来提高视角。"
		elseif(i == 58) then
			set s = "如果你想让魔兽自动施法，你可以输入-ms来令魔兽进入不可选定状态。"
		elseif(i == 59) then
			set s = "你可以输入-bs来清除地上的所有宝石."
		endif
		call BJDebugMsg("※※※※※※※※※※※※※※※※※※※※※※※※※※※※※※※※※※")
		call BJDebugMsg("|cFFFF66CC【小提示】|r"+s)
		call BJDebugMsg("※※※※※※※※※※※※※※※※※※※※※※※※※※※※※※※※※※")
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    永久赞助的任务
	*/
	function ShowZanzhuHint takes nothing returns nothing
	    call CreateQuestBJ( bj_QUESTTYPE_REQ_DISCOVERED, "永久赞助", "做图不易,你的如果你喜欢本图,也愿意赞助本图,那么你将获得以下功能:
	    	|cffff68001.可以直接选取英雄|r|cff00ccff\"星胧\"|r|cffff6800、|r|cff00ccff\"幻逸\"|r|cffff6600、|r|cff00ccff\"梦霁\"|r、|cff00ccff\"苍凌\"|r、|cff00ccff\"宵霆\"|r|cffff6600。|r|cffff6800|n2.英雄直接解锁湮灭/凯撒/莫琪的黑化功能.|n3.英雄将获得七彩皮肤效果|n4.开局金币10000(不与平台等级叠加)|n5.开局立即获得\"|r|cffff00ff琉璃璞玉|r|cffff6800\",任意宝石升级装备成功率100%|n6.选择所有难度(包括前4个)均能体验24+5+1波进攻，并解锁混沌区域.|n7.专属指令(-hc)可以把地面上的宝箱一键合成高级宝箱|r|cffff00ff.|r|cffff6800|n8.可以雇佣第5第6号雇佣兵.|n9.基地将获得3次防护罩效果.|n10.解锁仓库-熔炎火炮.
	    	|r|cffffff00赞助后续版本永久有效,永久赞助请加QQ群413359254获取,"+S3(DEBUG_MODE,"","或者百度搜索\"17玩吧\"进入轮回之狱专区获取,")+"还可以添加作者微信号\"a19f12\"获取.|r", "ReplaceableTextures\\CommandButtons\\BTNMGExchange.blp" )
	endfunction
	function ShowZanzhuHint2 takes nothing returns nothing
	    call PlaySoundBJ( gg_snd_Renwu )
	    call QuestSetEnabledBJ( true, GetLastCreatedQuestBJ() )
	    call QuestMessageBJ( GetPlayersAll(), bj_QUESTMESSAGE_DISCOVERED, "发现新任务 - |cFFCCFF00永久赞助|r
|cFFFF9900点击左上角“任务”查看。|r" )
	    call DestroyTimer( GetExpiredTimer() )
	endfunction
//---------------------------------------------------------------------------------------------------
	private function InitChatCommand takes nothing returns nothing
	    local trigger t = CreateTrigger()
		call TriggerRegisterPlayerChatEvent( t, Player(0), "-", false )
		call TriggerRegisterPlayerChatEvent( t, Player(1), "-", false )
		call TriggerRegisterPlayerChatEvent( t, Player(2), "-", false )
		call TriggerRegisterPlayerChatEvent( t, Player(3), "-", false )
		call TriggerRegisterPlayerChatEvent( t, Player(4), "-", false )
		call TriggerRegisterPlayerChatEvent( t, Player(5), "-", false )
	    call TriggerAddAction(t, function ChatCommandAct)
	    //小提示
	    call TimerStart(CreateTimer(),120,true,function ShowHint)
	    //永久赞助的任务
	    call TimerStart(CreateTimer(),1400,true,function ShowZanzhuHint2)
	    set t = null
	endfunction
//---------------------------------------------------------------------------------------------------
endlibrary
// 学习技能
library_once HeroSpellBase initializer InitHeroSpellBase requires LHBase,Heiyan,Seyu,Hanshang,Huanyi,Chenji,Mengji,Yanmie,Cangling,Sichen,Xinglong,Xiaoting
	globals
		boolean array BTianting1
		boolean array BTianting2
	endglobals
//---------------------------------------------------------------------------------------------------
	/*
	    英雄学习技能
	*/
	private function HeroLearnSkillCon takes nothing returns boolean
	    return ((IsUnitIllusionBJ(GetTriggerUnit()) != true) and BuyerFilter(GetTriggerUnit()) )
	endfunction
	//直接学习
	private function HeroLearnSkillAct takes nothing returns nothing
		set learnSkillHero = udg_H[GetConvertedPlayerId(GetOwningPlayer(GetTriggerUnit()))]
		//加入英雄内部判断
		call LearnSkillHeiyan(learnSkillHero,GetLearnedSkill())
		call LearnSkillSeyu(learnSkillHero,GetLearnedSkill())
		call LearnSkillHanshang(learnSkillHero,GetLearnedSkill())
		call LearnSkillHuanyi(learnSkillHero,GetLearnedSkill())
		call LearnSkillChenji(learnSkillHero,GetLearnedSkill())
		call LearnSkillMengji(learnSkillHero,GetLearnedSkill())
		call LearnSkillYanmie(learnSkillHero,GetLearnedSkill())
		call LearnSkillCangling(learnSkillHero,GetLearnedSkill())
		call LearnSkillSichen(learnSkillHero,GetLearnedSkill())
		call LearnSkillXinglong(learnSkillHero,GetLearnedSkill())
		call LearnSkillXiaoting(learnSkillHero,GetLearnedSkill())
		call LearnSkillLichi(learnSkillHero,GetLearnedSkill())
		call LearnSkillMoqi(learnSkillHero,GetLearnedSkill())
		call LearnSkillKaisa(learnSkillHero,GetLearnedSkill())
	endfunction
	//通过判断学习第几个来判断
	function TriggerAllHeroLearn takes integer convertedPlayerID,integer which returns nothing
		set learnSkillHero = udg_H[convertedPlayerID]
		//加入英雄内部判断
		call LearnSkillHeiyanI(learnSkillHero,which)
		call LearnSkillSeyuI(learnSkillHero,which)
		call LearnSkillHanshangI(learnSkillHero,which)
		call LearnSkillHuanyiI(learnSkillHero,which)
		call LearnSkillChenjiI(learnSkillHero,which)
		call LearnSkillMengjiI(learnSkillHero,which)
		call LearnSkillYanmieI(learnSkillHero,which)
		call LearnSkillCanglingI(learnSkillHero,which)
		call LearnSkillSichenI(learnSkillHero,which)
		call LearnSkillXinglongI(learnSkillHero,which)
		call LearnSkillLichiI(learnSkillHero,which)
		call LearnSkillMoqiI(learnSkillHero,which)
		call LearnSkillXiaotingI(learnSkillHero,which)
		call LearnSkillKaisaI(learnSkillHero,which)
	endfunction
//---------------------------------------------------------------------------------------------------
	private function InitHeroSpellBase takes nothing returns nothing
		    local trigger t = CreateTrigger()
		    call TriggerRegisterAnyUnitEventBJ( t, EVENT_PLAYER_HERO_SKILL )
		    call TriggerAddCondition(t, Condition(function HeroLearnSkillCon))
		    call TriggerAddAction(t, function HeroLearnSkillAct)
		    set t = null
	endfunction
endlibrary
// 金币系统
// 怪物技能
///#include  "edit/BigBoss.j"
///#include  "edit/Diamond.j"
library_once MonsterSpell initializer InitMonsterSpell requires LHBase,Diamond,Diffculty,YDWETimerPattern
	globals
		trigger TSpellQianfa
		trigger TSpellDart
		/*
		    手里剑技能伤害
		*/
		constant real DRAT_JUNENG = 30000000
		constant real DRAT_XIANLIAN = 15000000
		integer level_juneng = 1
		integer JunengID = 0
	endglobals
	/*
	    杀死老牛回5%血.
	*/
	function FocusCow takes unit selected returns nothing
		if(GetUnitAbilityLevel(selected,'A09W') >= 1 and IsUnitAliveBJ(selected))then
			call SetUnitState(selected,UNIT_STATE_LIFE,GetUnitState(selected,UNIT_STATE_LIFE)+GetUnitState(selected,UNIT_STATE_MAX_LIFE)*0.05)
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    宝石区怪物技能:千罚之光
	*/
	private function TSpellQianFaEnemyFilter takes nothing returns boolean
	    return (((IsUnitAliveBJ(GetFilterUnit()) == true) and (IsUnitEnemy(GetFilterUnit(), GetOwningPlayer(GetAttacker())) == true)))
	endfunction
	private function TSpellQianFaAct takes nothing returns nothing
	    local integer i
	    local group ydl_group
	    local unit ydl_unit
	    local real x
	    local real y
	    set x = GetUnitX(GetAttackedUnitBJ())
	    set y = GetUnitY(GetAttackedUnitBJ())
	    call DisableTrigger( GetTriggeringTrigger() )
	    call SetUnitManaBJ( GetAttacker(), ( GetUnitStateSwap(UNIT_STATE_MANA, GetAttacker()) - 333.00 ) )
	    //特效
	    set i = 1
	    loop
	        exitwhen i > 8
	        call UnitApplyTimedLifeBJ( 5.00, 'BHwe', CreateUnit(GetOwningPlayer(GetAttacker()),'h00J',x,y,45 * I2R(i)))
	        set i = i + 1
	    endloop
	    //巨能
	    if ((GetUnitTypeId(GetAttacker()) == 'N00Q')) then
	    		set ydl_group = CreateGroup()
			    call GroupEnumUnitsInRange(ydl_group, x, y, 900, function TSpellQianFaEnemyFilter)
			    loop
			        set ydl_unit = FirstOfGroup(ydl_group)
			        exitwhen ydl_unit == null
			        call GroupRemoveUnit(ydl_group, ydl_unit)
			        //造成75%生命的伤害
		            call UnitDamageTarget( GetAttacker(), ydl_unit, ( 0.5 * GetUnitStateSwap(UNIT_STATE_LIFE, ydl_unit) ), false, true, ATTACK_TYPE_CHAOS, DAMAGE_TYPE_SLOW_POISON, WEAPON_TYPE_WHOKNOWS )
			    endloop
		 	elseif ((GetUnitTypeId(GetAttacker()) == 'Nngs') or (GetUnitTypeId(GetAttacker()) == 'Nbrn')) then
		//仙炼或生克
	    		set ydl_group = CreateGroup()
				call GroupEnumUnitsInRange(ydl_group, x, y, 900, function TSpellQianFaEnemyFilter)
				loop
				    set ydl_unit = FirstOfGroup(ydl_group)
				    exitwhen ydl_unit == null
				    call GroupRemoveUnit(ydl_group, ydl_unit)
			        //造成50%生命的伤害
			        call UnitDamageTarget( GetAttacker(), ydl_unit, ( 0.3 * GetUnitStateSwap(UNIT_STATE_LIFE, ydl_unit) ), false, true, ATTACK_TYPE_CHAOS, DAMAGE_TYPE_SLOW_POISON, WEAPON_TYPE_WHOKNOWS )
				endloop
	    endif
	    //文字
	    call CreateSpellTextTag("虚--千罚之光",GetAttacker(),100,100,0,2)
	    call YDWEPolledWaitNull(5.00)
	    call EnableTrigger( GetTriggeringTrigger() )
	    call DestroyGroup(ydl_group)
	    set ydl_group = null
	    set ydl_unit = null
	endfunction
	private function TSpellQianFaCon takes nothing returns boolean
	    return (((GetUnitTypeId(GetAttacker()) == 'Nngs') or (GetUnitTypeId(GetAttacker()) == 'Nbrn') or (GetUnitTypeId(GetAttacker()) == 'N00Q')) and (IsUnitIllusionBJ(GetAttacker()) != true) and (GetUnitStateSwap(UNIT_STATE_MANA, GetAttacker()) > 333.00) and (GetRandomInt(1, 10) == 1))
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    巨能传送
	*/
	/*private function DiamondTransmitAct takes nothing returns nothing
		local group l_group = GetUnitsInRectAll(gg_rct________8)
		local unit l_unit
		loop
		    set l_unit = FirstOfGroup(l_group)
		    exitwhen l_unit == null
		    call GroupRemoveUnit(l_group, l_unit)
		    if (IsUnitDeadBJ(l_unit) and IsUnitType(l_unit,UNIT_TYPE_HERO) and (GetPlayerController(GetOwningPlayer(l_unit)) == MAP_CONTROL_USER) and (l_unit != udg_H[GetConvertedPlayerId(GetOwningPlayer(l_unit))] or IsWanjie())) then
                call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Human\\MassTeleport\\MassTeleportTo.mdl", GetUnitX(l_unit), GetUnitY(l_unit) ))
	    		call CreateSpellTextTag("传送离开",l_unit,100,0,50,2)
		    	call HG(l_unit)
		    endif
		endloop

        call ClearDiamondRegion(gg_rct________8)
		call DestroyGroup(l_group)
		set l_group = null
		set l_unit =null
	endfunction*/
	private function DiamondTransmit takes nothing returns nothing
		local timer t = GetExpiredTimer()
		local integer id = GetHandleId(t)
		local unit u = LoadUnitHandle(spellTable,id,1)
		if (IsUnitAliveBJ(u)) then
			call TLeaveDiamondRegion1Act()
		else
			call PauseTimer(t)
			call FlushChildHashtable(spellTable,id)
			call DestroyTimer(t)
		endif
		set u = null
		set t = null
	endfunction
	function StartJudgeTransmit takes unit u returns nothing
		local timer t = CreateTimer()
		local SuperShield shield
		call SaveUnitHandle(spellTable,GetHandleId(t),1,u)
		call TimerStart(t,2,true,function DiamondTransmit)
		if (GetDiffculty() == 8) then
			set shield = SuperShield.create(u,1)
		elseif (GetDiffculty() > 8) then
			set shield = SuperShield.create(u,5)
		endif
		set t = null
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    臣服于我
	*/
	private function TSpellJunlinAct takes nothing returns nothing
		if (udg_H[GetConvertedPlayerId(GetOwningPlayer(GetAttackedUnitBJ()))] == xuanxue and BJuexing3[GetConvertedPlayerId(GetOwningPlayer(xuanxue))]) then
	    	call RecoverUnitHP(GetAttackedUnitBJ(),-0.1)
		else
        	call SetUnitOwner( GetAttackedUnitBJ(),GetOwningPlayer(GetAttacker()), true )
		endif
	    call CreateSpellTextTag("臣服于我",GetAttacker(),100,0,0,2)
	    call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Undead\\RaiseSkeletonWarrior\\RaiseSkeleton.mdl", GetUnitX(GetAttackedUnitBJ()), GetUnitY(GetAttackedUnitBJ()) ))
	endfunction
	private function TSpellJunlinCon takes nothing returns boolean
	    return ((GetUnitAbilityLevel(GetAttacker(),'A0P1') >= 1) and (IsUnitIllusionBJ(GetAttackedUnitBJ()) != true) and (GetUnitStateSwap(UNIT_STATE_MANA, GetAttacker()) > 100.00) and (GetRandomInt(1, 100) <= udg_Nandu_JJJ * 3) and (IsEnemyM(GetAttackedUnitBJ(),GetAttacker()) == true) and (GetPlayerController(GetOwningPlayer(GetAttackedUnitBJ())) == MAP_CONTROL_USER) and (IsUnitType(GetTriggerUnit(), UNIT_TYPE_HERO) != true) and (IsUnitType(GetTriggerUnit(),UNIT_TYPE_MECHANICAL) == false))
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    元素杀手
	*/
	private function TSpellYuanshaAct takes nothing returns nothing
		call UnitDamageTarget( GetAttackedUnitBJ(), GetAttacker(), GetUnitState(GetAttacker(),UNIT_STATE_LIFE)*10, false, true, ATTACK_TYPE_CHAOS, DAMAGE_TYPE_SLOW_POISON, WEAPON_TYPE_WHOKNOWS )
	endfunction
	private function TSpellYuanshaCon takes nothing returns boolean
	    return (GetUnitAbilityLevel(GetAttackedUnitBJ(),'A0HE') >= 1) and (IsYuansu(GetAttacker()))
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    宠物相斗
	*/
	private function TSpellPetAct takes nothing returns nothing
		local real per = (0.02*(GetUnitLevel(GetAttacker()) - GetUnitLevel(GetAttackedUnitBJ()) + 1))
		call UnitDamageTarget( GetAttacker(), GetAttackedUnitBJ(), GetUnitState(GetAttacker(),UNIT_STATE_MAX_LIFE)*per, false, true, ATTACK_TYPE_CHAOS, DAMAGE_TYPE_POISON, WEAPON_TYPE_WHOKNOWS )
	endfunction
	private function TSpellPetCon takes nothing returns boolean
	    return (((GetUnitAbilityLevel(GetAttackedUnitBJ(),'A0P0') >= 1) or (GetUnitAbilityLevel(GetAttackedUnitBJ(),'A0P0') >= 1)) and (IsEnemy(GetAttackedUnitBJ(),GetAttacker()) == true) and GetUnitLevel(GetAttacker()) >= 50 and GetUnitLevel(GetAttacker()) >= GetUnitLevel(GetAttackedUnitBJ()))
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    幽象之爆与类同源
	*/
    private function YouxiangZhibao takes nothing returns nothing
    	local group l_group = CreateGroup()
    	local unit l_unit
    	call GroupEnumUnitsInRange(l_group, GetUnitX(GetDyingUnit()), GetUnitY(GetDyingUnit()), 600, null)
    	call DestroyEffect(AddSpecialEffect("Objects\\Spawnmodels\\Other\\NeutralBuildingExplosion\\NeutralBuildingExplosion.mdl", GetUnitX(GetDyingUnit()), GetUnitY(GetDyingUnit()) ))
    	loop
    	    set l_unit = FirstOfGroup(l_group)
    	    exitwhen l_unit == null
    	    call GroupRemoveUnit(l_group, l_unit)
    	    if (IsEnemyM(l_unit,GetDyingUnit()) and (GetPlayerController(GetOwningPlayer(l_unit)) == MAP_CONTROL_USER)) then
    	    	call UnitDamageTarget( GetDyingUnit(), l_unit, GetUnitState(l_unit,UNIT_STATE_LIFE)*0.9, false, true, ATTACK_TYPE_CHAOS, DAMAGE_TYPE_SLOW_POISON, WEAPON_TYPE_WHOKNOWS )
    	    endif
    	endloop
    	call DestroyGroup(l_group)
    	set l_group = null
    	set l_unit =null
    endfunction
    private function Leitongyuan takes nothing returns nothing
    	local group l_group = CreateGroup()
    	local unit l_unit
    	call GroupEnumUnitsInRange(l_group, GetUnitX(GetDyingUnit()),GetUnitY(GetDyingUnit()), 6000, null)
    	loop
    	    set l_unit = FirstOfGroup(l_group)
    	    exitwhen l_unit == null
    	    call GroupRemoveUnit(l_group, l_unit)
    	    if (GetUnitTypeId(GetDyingUnit()) == GetUnitTypeId(l_unit)) then
    	    	call SetUnitLifePercentBJ(l_unit,100)
    	    	call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Other\\ImmolationRed\\ImmolationRedTarget.mdl", GetUnitX(l_unit), GetUnitY(l_unit) ))
    	    endif
    	endloop
    	call DestroyGroup(l_group)
    	set l_group = null
    	set l_unit =null
    endfunction
    private function TMijingDeathAct takes nothing returns nothing
    	if (GetUnitAbilityLevel(GetDyingUnit(),'A0I4') >= 1) then
    		//幽象之爆
    		call YouxiangZhibao()
    	endif
    	if (GetUnitAbilityLevel(GetDyingUnit(),'A0I5') >= 1) then
    		//类同源
    		call Leitongyuan()
    	endif
    endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    红龙自动用技能
	*/
    private function TMijingAttackSpellCon takes nothing returns boolean
    	return GetUnitTypeId(GetAttacker()) == 'nrwm'
    endfunction
    private function TMijingAttackSpellAct takes nothing returns nothing
    	if (GetRandomInt(1,10) == 1) then
    		call IssuePointOrder(GetAttacker(),"clusterrockets",GetUnitX(GetAttackedUnitBJ()),GetUnitY(GetAttackedUnitBJ()))
    		return
    	endif
    	if (GetRandomInt(1,10) == 1) then
    		call IssuePointOrder(GetAttacker(),"silence",GetUnitX(GetAttackedUnitBJ()),GetUnitY(GetAttackedUnitBJ()))
    		return
    	endif
    endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    宝石区技能,弹射飞镖
	*/
	private function TSpellDratAct takes nothing returns nothing
		local integer i = -1
	    local real x1
	    local real y1
	    local real x2
	    local real y2
	    local unit drat
	    local real facing
	    set x1 = GetUnitX(GetAttackedUnitBJ())
	    set y1 = GetUnitY(GetAttackedUnitBJ())
	    set x2 = GetUnitX(GetAttacker())
	    set y2 = GetUnitY(GetAttacker())
	    set facing = Atan2BJ(y2-y1,x2-x1)
	    call DisableTrigger( GetTriggeringTrigger() )
	    call SetUnitManaBJ( GetAttackedUnitBJ(), ( GetUnitStateSwap(UNIT_STATE_MANA, GetAttackedUnitBJ()) - 333.00 ) )
	    //巨能
	    if ((GetUnitTypeId(GetAttackedUnitBJ()) == 'N00Q')) then
	    	loop
	    		exitwhen i > 1
	    		set drat = CreateUnit(GetOwningPlayer(GetAttackedUnitBJ()),'hs00',x1,y1,facing)
	        	call UnitApplyTimedLifeBJ( 10.00, 'BHwe', drat)
	        	    call DIYRushSlide( drat, facing + i * 30 , 20000.00, 10.00, 0.05, DRAT_JUNENG * (1+0.2*I2R(level_juneng)), 60., false, true, false, "origin", "", "Abilities\\Spells\\Other\\Stampede\\StampedeMissileDeath.mdl" )
	    		set i = i +1
	    	endloop
		 	elseif ((GetUnitTypeId(GetAttackedUnitBJ()) == 'Nngs') or (GetUnitTypeId(GetAttackedUnitBJ()) == 'Nbrn')) then
		//仙炼或生克
	    		set drat = CreateUnit(GetOwningPlayer(GetAttackedUnitBJ()),'hs00',x1,y1,facing)
	        	call UnitApplyTimedLifeBJ( 10.00, 'BHwe', drat)
	        	    call DIYRushSlide( drat, facing , 20000.00, 10.00, 0.05, R3(IsTianyan,1000000000,DRAT_XIANLIAN), 60., false, true, false, "origin", "", "Abilities\\Spells\\Other\\Stampede\\StampedeMissileDeath.mdl" )
	    endif
	    //文字
	    call CreateSpellTextTag("虚--弹射飞镖",GetAttacker(),0,100,1000,2)
	    call YDWEPolledWaitNull(10.00)
	    call EnableTrigger( GetTriggeringTrigger() )
	    set drat = null
	endfunction
	private function TSpellDratCon takes nothing returns boolean
	    return (((GetUnitTypeId(GetAttackedUnitBJ()) == 'Nngs') or (GetUnitTypeId(GetAttackedUnitBJ()) == 'Nbrn') or (GetUnitTypeId(GetAttackedUnitBJ()) == 'N00Q')) and (IsUnitIllusionBJ(GetAttackedUnitBJ()) != true) and (GetUnitStateSwap(UNIT_STATE_MANA, GetAttackedUnitBJ()) > 333.00) and (GetRandomInt(1, 10) == 1))
	endfunction
//---------------------------------------------------------------------------------------------------
	private function InitMonsterSpell takes nothing returns nothing
		local trigger t = CreateTrigger()
		//巨能,仙炼还有生克的千罚之光
	    set TSpellQianfa = CreateTrigger()
	    call TriggerRegisterAnyUnitEventBJ( TSpellQianfa, EVENT_PLAYER_UNIT_ATTACKED )
	    call TriggerAddCondition(TSpellQianfa, Condition(function TSpellQianFaCon))
	    call TriggerAddAction(TSpellQianfa, function TSpellQianFaAct)
	    call DisableTrigger(TSpellQianfa)
	    //巨能,仙炼还有生克的手里剑
	    set TSpellDart = CreateTrigger()
	    call TriggerRegisterAnyUnitEventBJ( TSpellDart, EVENT_PLAYER_UNIT_ATTACKED )
	    call TriggerAddCondition(TSpellDart, Condition(function TSpellDratCon))
	    call TriggerAddAction(TSpellDart, function TSpellDratAct)
	    call DisableTrigger(TSpellDart)
	    //臣服于我
	    set t = CreateTrigger()
	    call TriggerRegisterAnyUnitEventBJ( t, EVENT_PLAYER_UNIT_ATTACKED )
	    call TriggerAddCondition(t, Condition(function TSpellJunlinCon))
	    call TriggerAddAction(t, function TSpellJunlinAct)
	    //元素杀手
	    set t = CreateTrigger()
	    call TriggerRegisterAnyUnitEventBJ( t, EVENT_PLAYER_UNIT_ATTACKED )
	    call TriggerAddCondition(t, Condition(function TSpellYuanshaCon))
	    call TriggerAddAction(t, function TSpellYuanshaAct)
	    //幽象之体
	    set t = CreateTrigger()
	    call TriggerRegisterAnyUnitEventBJ(t,EVENT_PLAYER_UNIT_DEATH)
	    call TriggerAddAction(t, function TMijingDeathAct)
	    set t = CreateTrigger()
	    call TriggerRegisterAnyUnitEventBJ(t,EVENT_PLAYER_UNIT_ATTACKED)
	    call TriggerAddCondition(t, Condition(function TMijingAttackSpellCon))
	    call TriggerAddAction(t, function TMijingAttackSpellAct)
	    //宠物掉血
	    set t = CreateTrigger()
	    call TriggerRegisterAnyUnitEventBJ( t, EVENT_PLAYER_UNIT_ATTACKED )
	    call TriggerAddCondition(t, Condition(function TSpellPetCon))
	    call TriggerAddAction(t, function TSpellPetAct)
	    set t = null
	endfunction
endlibrary
// 魔兽技能
library_once Beast initializer InitBeast requires LHBase,ItemBase,YDWESetGuard
	globals
		/*
		    物品对应魔兽单位主索引
		*/
		private key kU
		private key kr
		private key kg
		private key kb
		private key ksr
		private key ksg
		private key ksb
		private key kBeastItem
		/*
		    魔兽数组
		*/
		unit array Unit_Beast
		constant integer DAMAGE_BEAST_00 = 30000
		constant integer DAMAGE_BEAST_01 = 160000
		constant integer DAMAGE_BEAST_02 = 1000000
		constant integer DAMAGE_BEAST_03 = 2600000
		constant integer DAMAGE_BEAST_04 = 7000000
		constant integer DAMAGE_BEAST_05 = 16000000
		constant integer DAMAGE_BEAST_06 = 40000000
		constant integer DAMAGE_BEAST_07 = 80000000
		constant integer DAMAGE_BEAST_08 = 120000000
		constant integer DAMAGE_BEAST_09 = 200000000
		constant integer DAMAGE_BEAST_10 = 400000000
		constant integer DAMAGE_BEAST_11 = 200000000
		constant integer DAMAGE_BEAST_12 = 600000000
		constant integer DAMAGE_BEAST_13 = 400000000
		/*
		    充能次数
		*/
		constant integer CHARGES_BEAST = 100
	endglobals
//---------------------------------------------------------------------------------------------------
	/*
	    开启定时器去给一个单位不断变色,直到他死去
	*/
	private function isOutOfRange takes integer i returns boolean
		return ((i > 255) or (i < 0) )
	endfunction
	private function GetModifiedColor takes integer i returns integer
		return IMinBJ(IAbsBJ(i),255)
	endfunction
	private function DiscolorTimer takes nothing returns nothing
		local timer t = GetExpiredTimer()
		local integer id = GetHandleId(t)
		local unit u = LoadUnitHandle(itemTable,id,kU)
		local integer r = LoadInteger(itemTable,id,kr)
		local integer g = LoadInteger(itemTable,id,kg)
		local integer b = LoadInteger(itemTable,id,kb)
		local integer sr = LoadInteger(itemTable,id,ksr)
		local integer sg = LoadInteger(itemTable,id,ksg)
		local integer sb = LoadInteger(itemTable,id,ksb)
		if((IsUnitAliveBJ(u) == true) or (IsUnitType(u,UNIT_TYPE_HERO))) then
			//! textmacro ChangeColor takes Color
			if (s$Color$ > 0) then
				set $Color$ = $Color$ + GetRandomInt(0,s$Color$)
			else
				set $Color$ = $Color$ + GetRandomInt(s$Color$,0)
			endif
			if(isOutOfRange($Color$)) then
				set $Color$ = GetModifiedColor($Color$)
				if (s$Color$ > 0) then
					call SaveInteger(itemTable,GetHandleId(t),ks$Color$ , GetRandomInt(-60,-20))
				else
					call SaveInteger(itemTable,GetHandleId(t),ks$Color$ , GetRandomInt(20,60))
				endif
			endif
			call SaveInteger(itemTable,GetHandleId(t),k$Color$, $Color$)
			//! endtextmacro
			//! runtextmacro ChangeColor("r")
			//! runtextmacro ChangeColor("g")
			//! runtextmacro ChangeColor("b")
    		call SetUnitVertexColor( u, r, g, b, 255 )
		else
			call SetUnitVertexColor( u, 255, 255, 255, 255 )
			call PauseTimer(t)
			call DestroyTimer(t)
			call FlushChildHashtable(itemTable,id)
		endif
		set t = null
		set u = null
	endfunction
	function Discolor takes unit u returns nothing
		local timer t = CreateTimer()
		call SaveUnitHandle(itemTable,GetHandleId(t),kU,u)
		call SaveInteger(itemTable,GetHandleId(t),kr,GetRandomInt(0,254))
		call SaveInteger(itemTable,GetHandleId(t),kg,GetRandomInt(0,254))
		call SaveInteger(itemTable,GetHandleId(t),kb,GetRandomInt(0,254))
		call SaveInteger(itemTable,GetHandleId(t),ksr,GetRandomInt(20,60))
		call SaveInteger(itemTable,GetHandleId(t),ksg,GetRandomInt(20,60))
		call SaveInteger(itemTable,GetHandleId(t),ksb,GetRandomInt(20,60))
		call TimerStart(t,0.1,true,function DiscolorTimer)
		if (IsUnitType(u,UNIT_TYPE_HERO)) then
			set TBianse[GetConvertedPlayerId(GetOwningPlayer(u))] = t
		endif
		set t = null
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    给单位产生并绑定相对应的魔兽
	*/
	private function CreateBeast takes unit captain,integer itemId returns nothing
		local integer unitID = LoadInteger(itemTable,kBeastItem,itemId)
		local unit u = CreateUnit(GetOwningPlayer(captain),unitID,GetUnitX(captain),GetUnitY(captain),0)
		//变色
		if ((unitID == 'ub08') or (unitID == 'ub09') or (unitID == 'ub10') or (unitID == 'ub11') or (unitID == 'ub12') or (unitID == 'ub13')) then
			call Discolor(u)
		endif
		if (Unit_Beast[GetConvertedPlayerId(GetOwningPlayer(captain))] != null) then
			call RemoveUnit(Unit_Beast[GetConvertedPlayerId(GetOwningPlayer(captain))])
		endif
		set Unit_Beast[GetConvertedPlayerId(GetOwningPlayer(captain))] = u
		call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Human\\MassTeleport\\MassTeleportTarget.mdl", GetUnitX(captain), GetUnitY(captain) ))
		if (BMoshou[GetConvertedPlayerId(GetOwningPlayer(captain))]) then
			call UnitAddAbility(u,'Aloc')
		endif
		call YDWESetGuard(u,captain,1,600,600,600,100)
		set u = null
	endfunction
//---------------------------------------------------------------------------------------------------
	private function IsBeast takes item i returns boolean
		return GetItemTypeId(i) == 'IB00' /*
			*/or GetItemTypeId(i) == 'IB01' /*
			*/or GetItemTypeId(i) == 'IB02' /*
			*/or GetItemTypeId(i) == 'IB03' /*
			*/or GetItemTypeId(i) == 'IB04' /*
			*/or GetItemTypeId(i) == 'IB05' /*
			*/or GetItemTypeId(i) == 'IB06' /*
			*/or GetItemTypeId(i) == 'IB07' /*
			*/or GetItemTypeId(i) == 'IB08' /*
			*/or GetItemTypeId(i) == 'IB09' /*
			*/or GetItemTypeId(i) == 'I04X' /*
			*/or GetItemTypeId(i) == 'IB0A' /*
			*/or GetItemTypeId(i) == 'I07O' /*
			*/or GetItemTypeId(i) == 'I07N'
	endfunction
	/*
	    不能带两个魔兽，先检测魔兽数量，再产生相对应的魔兽
	*/
	private function UnitHasBeastInSlot takes unit u,integer slot returns boolean
		return IsBeast(UnitItemInSlotBJ(u,slot))
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    获取单位身上的魔兽
	*/
	private function GetBeastInUnit takes unit u returns item
		local integer i = 1
		loop
			exitwhen i > 6
			if(UnitHasBeastInSlot(u,i)) then
				return UnitItemInSlotBJ(u,i)
			endif
			set i = i +1
		endloop
		return null
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    只能装备一个魔兽
	*/
	private function TBeastEquitAct takes nothing returns nothing
		local integer i = 1
		local integer beastCount = 0
		loop
			exitwhen i > 6
			if(UnitHasBeastInSlot(GetTriggerUnit(),i)) then
				set beastCount = beastCount + 1
			endif
			set i = i +1
		endloop
		//如果计数君大于1则丢掉
		if (beastCount > 1) then
			call YDWEPolledWaitNull(0.1)
			call UnitRemoveItemSwapped(GetManipulatedItem(),GetTriggerUnit())
			call DisplayTextToPlayer(GetOwningPlayer(GetTriggerUnit()),0.,0.,"|cFFFF66CC【消息】|r你只能同时装备上一个魔兽！")
			return
		elseif (beastCount == 1) then
		//产生相对应的魔兽操作
			call CreateBeast(GetTriggerUnit(),GetItemTypeId(GetManipulatedItem()))
			if (IsMo(GetTriggerUnit())) then
				if (IsMo3(GetManipulatedItem())) then
					call UnitAddAbility(GetTriggerUnit(),'A0MT')
				endif
				if (IsChaomo(GetManipulatedItem())) then
					call SetUnitAbilityLevel(GetTriggerUnit(),'A0MT',2)
				endif
			endif
		endif
	endfunction
	private function TBeastEquitCon takes nothing returns boolean
		return (GetManipulatingUnit() == udg_H[GetConvertedPlayerId(GetOwningPlayer(GetManipulatingUnit()))])/*
			*/and (IsUnitIllusionBJ(GetManipulatingUnit()) != true) and (IsBeast(GetManipulatedItem()) == true)
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    英雄死后，魔兽也暂时消失
	*/
	function RemoveBeast takes unit u returns nothing
		call RemoveUnit(Unit_Beast[GetConvertedPlayerId(GetOwningPlayer(u))])
		set Unit_Beast[GetConvertedPlayerId(GetOwningPlayer(u))] = null
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    英雄复活后，魔兽出来
	*/
	function ReviveBeast takes unit u returns nothing
		if (GetBeastInUnit(u) != null) then
			call CreateBeast(u,GetItemTypeId(GetBeastInUnit(u)))
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    丢弃魔兽事件
	*/
	private function TBeastDropAct takes nothing returns nothing
		local integer i = 1
		local integer beastCount = 0
		loop
			exitwhen i > 6
			if(UnitHasBeastInSlot(GetTriggerUnit(),i)) then
				set beastCount = beastCount + 1
			endif
			set i = i +1
		endloop
		if (beastCount != 2) then
			call RemoveBeast(GetManipulatingUnit())
			if (IsMo(GetTriggerUnit())) then
				if (IsMo3(GetManipulatedItem())) then
					call UnitRemoveAbility(GetTriggerUnit(),'A0MT')
				endif
			endif
		endif
	endfunction
	private function TBeastDropCon takes nothing returns boolean
		return (GetManipulatingUnit() == udg_H[GetConvertedPlayerId(GetOwningPlayer(GetManipulatingUnit()))])/*
			*/and (IsUnitIllusionBJ(GetManipulatingUnit()) != true) and (IsBeast(GetManipulatedItem()) == true)
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    魔兽伤害事件
	*/
	private function TBeastDamageAct takes nothing returns nothing
		local integer unitID = GetUnitTypeId(GetEventDamageSource())
		local integer playerID = GetConvertedPlayerId(GetOwningPlayer(GetEventDamageSource()))
		local item beast = GetBeastInUnit(udg_H[playerID])
		//魔兽怒吼
		if (GetUnitAbilityLevel(Unit_Beast[playerID],'ABe9') >= 1) then
			call SetItemCharges(beast,GetItemCharges(beast)+1)
			if (GetItemCharges(beast) > CHARGES_BEAST) then
					call CreateSpellTextTag("魔兽怒吼!",Unit_Beast[playerID],0,100,0,2)
 					call SimulateSpell(Unit_Beast[playerID],Unit_Beast[playerID],'A0CR',1,5,"stomp",false,true,false)
					call SetItemCharges(beast,0)
			endif
		endif
		//余数为4则施放
		if (ModuloInteger(GetItemCharges(beast),4) == 0 and (GetUnitTypeId(GetEventDamageSource()) == 'ub11' or GetUnitTypeId(GetEventDamageSource()) == 'ub13')) then
			call UnitApplyTimedLifeBJ( 2.00, 'BHwe',CreateUnit(ConvertedPlayer(playerID),I3(GetUnitTypeId(GetEventDamageSource()) == 'ub11','h01P','h02J'),YDWECoordinateX(GetUnitX(GetEventDamageSource()) + GetRandomReal(-100,100)),YDWECoordinateY(GetUnitY(GetEventDamageSource()) + GetRandomReal(-100,100)),GetRandomReal(0,360)) )
		endif
		/*
		    自动
		*/
		if (GetUnitAbilityLevel(Unit_Beast[playerID],'ABea') >= 1 and BMoshou[playerID] and GetUnitState(Unit_Beast[playerID],UNIT_STATE_MANA) > 999) then
			call IssueImmediateOrder(Unit_Beast[playerID],"berserk")
		endif
		/*
		    文本宏1，伤害
		*/
		//! textmacro DamageBeast1 takes ID
		if (unitID == 'ub$ID$') then
			call DisableTrigger(GetTriggeringTrigger())
			call UnitDamageTarget( udg_H[playerID], GetTriggerUnit(), DAMAGE_BEAST_$ID$, false, true, ATTACK_TYPE_CHAOS, DAMAGE_TYPE_POISON, WEAPON_TYPE_WHOKNOWS )
			call EnableTrigger(GetTriggeringTrigger())
			set beast = null
			return
		endif
		//! endtextmacro
		//! runtextmacro DamageBeast1("00")
		//! runtextmacro DamageBeast1("01")
		//! runtextmacro DamageBeast1("02")
		//! runtextmacro DamageBeast1("03")
		//! runtextmacro DamageBeast1("04")
		//! runtextmacro DamageBeast1("05")
		//! runtextmacro DamageBeast1("06")
		//! runtextmacro DamageBeast1("07")
		//! runtextmacro DamageBeast1("08")
		//! runtextmacro DamageBeast1("09")
		//! runtextmacro DamageBeast1("10")
		//! runtextmacro DamageBeast1("11")
		//! runtextmacro DamageBeast1("12")
		//! runtextmacro DamageBeast1("13")
	endfunction
	private function TBeastDamageCon takes nothing returns boolean
		return ((GetEventDamage() > 0) and (IsUnitIllusion(GetEventDamageSource()) == false) and (GetEventDamageSource() == Unit_Beast[GetConvertedPlayerId(GetOwningPlayer(GetEventDamageSource()))]))
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    合成装备
	*/
	function CombineBeast takes unit u returns nothing
		//! textmacro SummonBeast takes IType1,IType2,IType3
		if ((GetItemTypeId(YDWEGetItemOfTypeFromUnitBJNull(u, '$IType1$')) == '$IType1$') and (GetItemTypeId(YDWEGetItemOfTypeFromUnitBJNull(u, '$IType2$')) == '$IType2$') and (IsItemPawnable(YDWEGetItemOfTypeFromUnitBJNull(u, '$IType1$')) == true) and (IsItemPawnable(YDWEGetItemOfTypeFromUnitBJNull(u, '$IType2$')) == true)) then
            call YDWEPolledWaitNull(0.01)
            call RemoveItem( YDWEGetItemOfTypeFromUnitBJNull(u, '$IType2$') )
            call RemoveItem( YDWEGetItemOfTypeFromUnitBJNull(u, '$IType1$') )
            call UnitAddItemById(u, '$IType3$')
			call DisplayTextToPlayer(GetOwningPlayer(u),0.,0.,"|cFFFF66CC【消息】|r你成功召唤新的魔兽,如果想让魔兽进入不可点击状态,请输入\"-ms\"!")
			call DisplayTextToPlayer(GetOwningPlayer(u),0.,0.,"|cFFFF66CC【消息】|r你成功召唤新的魔兽,如果想让魔兽进入不可点击状态,请输入\"-ms\"!")
			call DisplayTextToPlayer(GetOwningPlayer(u),0.,0.,"|cFFFF66CC【消息】|r你成功召唤新的魔兽,如果想让魔兽进入不可点击状态,请输入\"-ms\"!")
			return
		endif
		//! endtextmacro
		//! runtextmacro SummonBeast("IB00","IMJ1","IB01")
		//! runtextmacro SummonBeast("IB01","IMJ2","IB02")
		//! runtextmacro SummonBeast("IB02","IMJ3","IB03")
		//! runtextmacro SummonBeast("IB03","IMJ4","IB04")
		//! runtextmacro SummonBeast("IB04","IMJ5","IB05")
		//! runtextmacro SummonBeast("IB05","IMJ6","IB06")
		//! runtextmacro SummonBeast("IB06","IMJ7","IB07")
		//! runtextmacro SummonBeast("IB07","IMJ8","IB08")
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    初始化数据，单位与物品的对应关系
	*/
	private function initBeastItem takes nothing returns nothing
		call SaveInteger(itemTable,kBeastItem,'IB00','ub00')
		call SaveInteger(itemTable,kBeastItem,'IB01','ub01')
		call SaveInteger(itemTable,kBeastItem,'IB02','ub02')
		call SaveInteger(itemTable,kBeastItem,'IB03','ub03')
		call SaveInteger(itemTable,kBeastItem,'IB04','ub04')
		call SaveInteger(itemTable,kBeastItem,'IB05','ub05')
		call SaveInteger(itemTable,kBeastItem,'IB06','ub06')
		call SaveInteger(itemTable,kBeastItem,'IB07','ub07')
		call SaveInteger(itemTable,kBeastItem,'IB08','ub08')
		call SaveInteger(itemTable,kBeastItem,'IB09','ub09')
		call SaveInteger(itemTable,kBeastItem,'IB0A','ub10')
		call SaveInteger(itemTable,kBeastItem,'I04X','ub11')
		call SaveInteger(itemTable,kBeastItem,'I07N','ub12')
		call SaveInteger(itemTable,kBeastItem,'I07O','ub13')
	endfunction
//---------------------------------------------------------------------------------------------------
	private function InitBeast takes nothing returns nothing
		//初始化
		local trigger t = CreateTrigger()
		call initBeastItem()
		//只能同时装备一个魔兽
		call TriggerRegisterAnyUnitEventBJ(t,EVENT_PLAYER_UNIT_PICKUP_ITEM)
		call TriggerAddCondition(t,Condition(function TBeastEquitCon))
		call TriggerAddAction(t,function TBeastEquitAct)
		//魔兽伤害事件
		set t =CreateTrigger()
		call YDWESyStemAnyUnitDamagedRegistTrigger(t)
		call TriggerAddCondition(t,Condition(function TBeastDamageCon))
		call TriggerAddAction(t,function TBeastDamageAct)
		//丢弃魔兽事件
		set t =CreateTrigger()
		call TriggerRegisterAnyUnitEventBJ(t,EVENT_PLAYER_UNIT_DROP_ITEM)
		call TriggerAddCondition(t,Condition(function TBeastDropCon))
		call TriggerAddAction(t,function TBeastDropAct)
		set t = null
	endfunction
endlibrary
// 练级场
library_once Exercise initializer InitExercise requires LHBase
	globals
		rect array regionAll
		//怪物的区域
		rect array regionM1
		rect array regionM2
		rect array regionM3
		rect array regionM4
		rect array regionM5
		rect array regionM6
		private timer array TiExercise
	endglobals
//---------------------------------------------------------------------------------------------------
	/*
	    区域123456的刷怪过滤器
	*/
	function TMonsterFilter1 takes nothing returns boolean
	    return ((GetOwningPlayer(GetFilterUnit()) == Player(10)) and ((GetUnitTypeId(GetFilterUnit()) == 'nano') or (GetUnitTypeId(GetFilterUnit()) == 'nanw')))
	endfunction
	function TMonsterFilter2 takes nothing returns boolean
	    return ((GetOwningPlayer(GetFilterUnit()) == Player(10)) and ((GetUnitTypeId(GetFilterUnit()) == 'nenf') or (GetUnitTypeId(GetFilterUnit()) == 'nbld')))
	endfunction
	function TMonsterFilter3 takes nothing returns boolean
	    return ((GetOwningPlayer(GetFilterUnit()) == Player(10)) and ((GetUnitTypeId(GetFilterUnit()) == 'nbda') or (GetUnitTypeId(GetFilterUnit()) == 'nbdo')))
	endfunction
	function TMonsterFilter4 takes nothing returns boolean
	    return ((GetOwningPlayer(GetFilterUnit()) == Player(10)) and ((GetUnitTypeId(GetFilterUnit()) == 'ncim') or (GetUnitTypeId(GetFilterUnit()) == 'ncnk')))
	endfunction
	function TMonsterFilter5 takes nothing returns boolean
	    return ((GetOwningPlayer(GetFilterUnit()) == Player(10)) and ((GetUnitTypeId(GetFilterUnit()) == 'ngns') or (GetUnitTypeId(GetFilterUnit()) == 'ngnw')))
	endfunction
	function TMonsterFilter6 takes nothing returns boolean
	    return ((GetOwningPlayer(GetFilterUnit()) == Player(10)) and ((GetUnitTypeId(GetFilterUnit()) == 'nhfp') or (GetUnitTypeId(GetFilterUnit()) == 'nenc')))
	endfunction
	/*
	    玩家单位过滤器
	*/
	function TMonsterPlayerFilter takes nothing returns boolean
	    return ((GetPlayerController(GetOwningPlayer(GetFilterUnit())) == MAP_CONTROL_USER) and (IsUnitAliveBJ(GetFilterUnit()) == true))
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    刷新怪物
	*/
	//! textmacro FlashMonster takes Index
	function FlashMonsterPlayer$Index$ takes nothing returns nothing
		local group g
		local group g2
		//区域1
		set g = YDWEGetUnitsInRectMatchingNull(regionM1[$Index$], Condition(function TMonsterFilter1))
		set g2 = YDWEGetUnitsInRectMatchingNull(regionM1[$Index$], Condition(function TMonsterPlayerFilter))
		if (CountUnitsInGroup(g2) != 0) then
			//刷怪
			if (CountUnitsInGroup(g) == 0) then
			    if (IsUnitInGroup(udg_H[$Index$],g2) != true) then
			        call CreateUnit(Player(10), 'nano',GetRectCenterX(regionM1[$Index$]),GetRectCenterY(regionM1[$Index$]),270)
			    else
			        call CreateUnit(Player(10), 'nanw',GetRectCenterX(regionM1[$Index$]),GetRectCenterY(regionM1[$Index$]),270)
			    endif
			endif
		else
			if (CountUnitsInGroup(g) != 0) then
				//不刷且删兵
				call DeleteGroup(g)
			endif
		endif
	    call DestroyGroup( g )
	    call DestroyGroup( g2 )
		//区域2
		set g = YDWEGetUnitsInRectMatchingNull(regionM2[$Index$], Condition(function TMonsterFilter2))
		set g2 = YDWEGetUnitsInRectMatchingNull(regionM2[$Index$], Condition(function TMonsterPlayerFilter))
		if (CountUnitsInGroup(g2) != 0) then
			//刷怪
			if (CountUnitsInGroup(g) == 0) then
			    if (IsUnitInGroup(udg_H[$Index$],g2) != true) then
			        call CreateUnit(Player(10), 'nenf',GetRectCenterX(regionM2[$Index$]),GetRectCenterY(regionM2[$Index$]),270)
			    else
			        call CreateUnit(Player(10), 'nbld',GetRectCenterX(regionM2[$Index$]),GetRectCenterY(regionM2[$Index$]),270)
			    endif
			endif
		else
			if (CountUnitsInGroup(g) != 0) then
				//不刷且删兵
				call DeleteGroup(g)
			endif
		endif
	    call DestroyGroup( g )
	    call DestroyGroup( g2 )
	    //区域3
		set g = YDWEGetUnitsInRectMatchingNull(regionM3[$Index$], Condition(function TMonsterFilter3))
		set g2 = YDWEGetUnitsInRectMatchingNull(regionM3[$Index$], Condition(function TMonsterPlayerFilter))
		if (CountUnitsInGroup(g2) != 0) then
			//刷怪
			if (CountUnitsInGroup(g) == 0) then
			    if (IsUnitInGroup(udg_H[$Index$],g2) != true) then
			        call CreateUnit(Player(10), 'nbda',GetRectCenterX(regionM3[$Index$]),GetRectCenterY(regionM3[$Index$]),270)
			    else
			        call CreateUnit(Player(10), 'nbdo',GetRectCenterX(regionM3[$Index$]),GetRectCenterY(regionM3[$Index$]),270)
			    endif
			endif
		else
			if (CountUnitsInGroup(g) != 0) then
				//不刷且删兵
				call DeleteGroup(g)
			endif
		endif
	    call DestroyGroup( g )
	    call DestroyGroup( g2 )
	    //区域4
		set g = YDWEGetUnitsInRectMatchingNull(regionM4[$Index$], Condition(function TMonsterFilter4))
		set g2 = YDWEGetUnitsInRectMatchingNull(regionM4[$Index$], Condition(function TMonsterPlayerFilter))
		if (CountUnitsInGroup(g2) != 0) then
			//刷怪
			if (CountUnitsInGroup(g) == 0) then
			    if (IsUnitInGroup(udg_H[$Index$],g2) != true) then
			        call CreateUnit(Player(10), 'ncim',GetRectCenterX(regionM4[$Index$]),GetRectCenterY(regionM4[$Index$]),270)
			    else
			        call CreateUnit(Player(10), 'ncnk',GetRectCenterX(regionM4[$Index$]),GetRectCenterY(regionM4[$Index$]),270)
			    endif
			endif
		else
			if (CountUnitsInGroup(g) != 0) then
				//不刷且删兵
				call DeleteGroup(g)
			endif
		endif
	    call DestroyGroup( g )
	    call DestroyGroup( g2 )
	    //区域5
		set g = YDWEGetUnitsInRectMatchingNull(regionM5[$Index$], Condition(function TMonsterFilter5))
		set g2 = YDWEGetUnitsInRectMatchingNull(regionM5[$Index$], Condition(function TMonsterPlayerFilter))
		if (CountUnitsInGroup(g2) != 0) then
			//刷怪
			if (CountUnitsInGroup(g) == 0) then
			    if (IsUnitInGroup(udg_H[$Index$],g2) != true) then
			        call CreateUnit(Player(10), 'ngns',GetRectCenterX(regionM5[$Index$]),GetRectCenterY(regionM5[$Index$]),270)
			    else
			        call CreateUnit(Player(10), 'ngnw',GetRectCenterX(regionM5[$Index$]),GetRectCenterY(regionM5[$Index$]),270)
			    endif
			endif
		else
			if (CountUnitsInGroup(g) != 0) then
				//不刷且删兵
				call DeleteGroup(g)
			endif
		endif
	    call DestroyGroup( g )
	    call DestroyGroup( g2 )
	    //区域6
		set g = YDWEGetUnitsInRectMatchingNull(regionM6[$Index$], Condition(function TMonsterFilter6))
		set g2 = YDWEGetUnitsInRectMatchingNull(regionM6[$Index$], Condition(function TMonsterPlayerFilter))
		if (CountUnitsInGroup(g2) != 0) then
			//刷怪
			if (CountUnitsInGroup(g) == 0) then
			    if (IsUnitInGroup(udg_H[$Index$],g2) != true) then
			        call CreateUnit(Player(10), 'nhfp',GetRectCenterX(regionM6[$Index$]),GetRectCenterY(regionM6[$Index$]),270)
			    else
			        call CreateUnit(Player(10), 'nenc',GetRectCenterX(regionM6[$Index$]),GetRectCenterY(regionM6[$Index$]),270)
			    endif
			endif
		else
			if (CountUnitsInGroup(g) != 0) then
				//不刷且删兵
				call DeleteGroup(g)
			endif
		endif
	    call DestroyGroup( g )
	    call DestroyGroup( g2 )
	    set g = null
	    set g2 = null
	endfunction
	//! endtextmacro
	//! runtextmacro FlashMonster("1")
	//! runtextmacro FlashMonster("2")
	//! runtextmacro FlashMonster("3")
	//! runtextmacro FlashMonster("4")
	//! runtextmacro FlashMonster("5")
	//! runtextmacro FlashMonster("6")
//---------------------------------------------------------------------------------------------------
	/*
		禁止进入
	*/
	//! textmacro TExerciseForbitCon takes Index
		private function TExerciseForbitCon$Index$ takes nothing returns boolean
			return ((ConvertedPlayer($Index$) != GetOwningPlayer(GetTriggerUnit())) and (IsEnemy3(GetTriggerUnit(),Player(10))))
		endfunction
	//! endtextmacro
	//! runtextmacro TExerciseForbitCon("1")
	//! runtextmacro TExerciseForbitCon("2")
	//! runtextmacro TExerciseForbitCon("3")
	//! runtextmacro TExerciseForbitCon("4")
	//! runtextmacro TExerciseForbitCon("5")
	//! runtextmacro TExerciseForbitCon("6")
	private function TExerciseForbitAct takes nothing returns nothing
		call SetUnitX(GetTriggerUnit(),GetUnitX(gg_unit_haro_0030))
		call SetUnitY(GetTriggerUnit(),GetUnitY(gg_unit_haro_0030))
		call DisplayTextToPlayer(GetOwningPlayer(GetTriggerUnit()), 0., 0., "|cFFFF66CC【消息】|r你不能进入其他玩家的房间！")
		if (IsSolider(GetTriggerUnit())) then
			call RemoveUnit(GetTriggerUnit())
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    初始化触发
	*/
	private function InitExerciseTrigger takes nothing returns nothing
		local trigger t
		//! textmacro CreateMonsterTrigger takes Index
			if ((GetPlayerSlotState(ConvertedPlayer($Index$)) == PLAYER_SLOT_STATE_PLAYING) and GetPlayerController(ConvertedPlayer($Index$)) == MAP_CONTROL_USER) then
				set t = CreateTrigger()
			    call YDWETriggerRegisterEnterRectSimpleNull( t, regionAll[$Index$] )
			    call TriggerAddCondition(t, Condition(function TExerciseForbitCon$Index$))
			    call TriggerAddAction(t, function TExerciseForbitAct)
				call CreateUnit(Player(15),'uS02',GetRectCenterX(regionM1[$Index$])+300,GetRectCenterY(regionM1[$Index$])-300,270)
			    set TiExercise[$Index$] = CreateTimer()
			    call TimerStart(TiExercise[$Index$],5,true,function FlashMonsterPlayer$Index$)
			endif
		//! endtextmacro
		//! runtextmacro CreateMonsterTrigger("1")
		//! runtextmacro CreateMonsterTrigger("2")
		//! runtextmacro CreateMonsterTrigger("3")
		//! runtextmacro CreateMonsterTrigger("4")
		//! runtextmacro CreateMonsterTrigger("5")
		//! runtextmacro CreateMonsterTrigger("6")
		set t = null
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    玩家离开后关闭定时器
	*/
	function CloseExerciseTimer takes player p returns nothing
		call PauseTimer(TiExercise[GetConvertedPlayerId(p)])
		call DestroyTimer(TiExercise[GetConvertedPlayerId(p)])
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    初始化所有区域
	*/
	private function InitExerciseRegions takes nothing returns nothing
		set regionM1[1]=Rect(- 15488.0, 13952.0, - 14240.0, 15232.0)
	    set regionM2[1]=Rect(- 13280.0, 13952.0, - 12096.0, 15232.0)
	    set regionM3[1]=Rect(- 15488.0, 12288.0, - 14208.0, 13536.0)
	    set regionM4[1]=Rect(- 13312.0, 12288.0, - 12064.0, 13568.0)
	    set regionM5[1]=Rect(- 15488.0, 10624.0, - 14208.0, 11904.0)
	    set regionM6[1]=Rect(- 13312.0, 10624.0, - 12032.0, 11904.0)
	    set regionM1[2]=Rect(- 15488.0, 8960.0, - 14240.0, 10240.0)
	    set regionM2[2]=Rect(- 13280.0, 8960.0, - 12096.0, 10240.0)
	    set regionM3[2]=Rect(- 15488.0, 7296.0, - 14208.0, 8544.0)
	    set regionM4[2]=Rect(- 13312.0, 7296.0, - 12064.0, 8576.0)
	    set regionM5[2]=Rect(- 15488.0, 5632.0, - 14208.0, 6912.0)
	    set regionM6[2]=Rect(- 13312.0, 5632.0, - 12032.0, 6912.0)
	    set regionM1[3]=Rect(- 11104.0, 13984.0, - 9888.0, 15232.0)
	    set regionM2[3]=Rect(- 8960.0, 13952.0, - 7680.0, 15232.0)
	    set regionM3[3]=Rect(- 11136.0, 12288.0, - 9888.0, 13536.0)
	    set regionM4[3]=Rect(- 8928.0, 12288.0, - 7680.0, 13568.0)
	    set regionM5[3]=Rect(- 11136.0, 10624.0, - 9856.0, 11904.0)
	    set regionM6[3]=Rect(- 8960.0, 10624.0, - 7680.0, 11904.0)
	    set regionM1[4]=Rect(- 11104.0, 8992.0, - 9888.0, 10240.0)
	    set regionM2[4]=Rect(- 8960.0, 8960.0, - 7680.0, 10240.0)
	    set regionM3[4]=Rect(- 11136.0, 7296.0, - 9888.0, 8544.0)
	    set regionM4[4]=Rect(- 8928.0, 7296.0, - 7680.0, 8576.0)
	    set regionM5[4]=Rect(- 11136.0, 5632.0, - 9856.0, 6912.0)
	    set regionM6[4]=Rect(- 8960.0, 5632.0, - 7680.0, 6912.0)
	    set regionM1[5]=Rect(- 6752.0, 13952.0, - 5536.0, 15200.0)
	    set regionM2[5]=Rect(- 4736.0, 13952.0, - 3456.0, 15232.0)
	    set regionM3[5]=Rect(- 6784.0, 12256.0, - 5536.0, 13504.0)
	    set regionM4[5]=Rect(- 4704.0, 12288.0, - 3456.0, 13568.0)
	    set regionM5[5]=Rect(- 6784.0, 10592.0, - 5504.0, 11872.0)
	    set regionM6[5]=Rect(- 4736.0, 10624.0, - 3456.0, 11904.0)
	    set regionM1[6]=Rect(- 6752.0, 8960.0, - 5536.0, 10208.0)
	    set regionM2[6]=Rect(- 4736.0, 8960.0, - 3456.0, 10240.0)
	    set regionM3[6]=Rect(- 6784.0, 7264.0, - 5536.0, 8512.0)
	    set regionM4[6]=Rect(- 4704.0, 7296.0, - 3456.0, 8576.0)
	    set regionM5[6]=Rect(- 6784.0, 5600.0, - 5504.0, 6880.0)
	    set regionM6[6]=Rect(- 4736.0, 5632.0, - 3456.0, 6912.0)
	    set regionAll[1]=Rect(- 15808.0, 10400.0, - 11744.0, 15456.0)
	    set regionAll[2]=Rect(- 15808.0, 5344.0, - 11712.0, 10400.0)
	    set regionAll[3]=Rect(- 11744.0, 10400.0, - 7232.0, 15456.0)
	    set regionAll[4]=Rect(- 11744.0, 5312.0, - 7232.0, 10400.0)
	    set regionAll[5]=Rect(- 7264.0, 10432.0, - 3136.0, 15456.0)
	    set regionAll[6]=Rect(- 7264.0, 5312.0, - 3136.0, 10432.0)
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    购买练级场进入相对应的位置
	*/
	function EnterExerciseRegion takes nothing returns nothing
		local real x
		local real y
		//! textmacro EnterSpecifyExercise takes ItemType,Index
		if ((GetItemTypeId(GetSoldItem()) == '$ItemType$')) then
			set x = GetRectCenterX(regionM$Index$[GetConvertedPlayerId(GetOwningPlayer(GetBuyingUnit()))])
			set y = GetRectCenterY(regionM$Index$[GetConvertedPlayerId(GetOwningPlayer(GetBuyingUnit()))])
	        call SetUnitX(GetBuyingUnit(),x)
	        call SetUnitY(GetBuyingUnit(),y)
	        call PanCameraToTimedForPlayer(GetOwningPlayer(GetBuyingUnit()),x,y,0.2)
	        call DestroyEffect( AddSpecialEffect("Abilities\\Spells\\Human\\MassTeleport\\MassTeleportCaster.mdl", x, y))
	        call DisplayTextToPlayer( GetOwningPlayer(GetBuyingUnit()), 0, 0, "|cFFFF66CC【消息】|r回去输入“HG”。" )
	    endif
		//! endtextmacro
		//! runtextmacro EnterSpecifyExercise("I05J","1")
		//! runtextmacro EnterSpecifyExercise("I053","2")
		//! runtextmacro EnterSpecifyExercise("I05K","3")
		//! runtextmacro EnterSpecifyExercise("I06Y","4")
		//! runtextmacro EnterSpecifyExercise("I06Z","5")
		//! runtextmacro EnterSpecifyExercise("I03Z","6")
	endfunction
//---------------------------------------------------------------------------------------------------
	private function InitExercise takes nothing returns nothing
		call InitExerciseRegions()
		call InitExerciseTrigger()
	endfunction
endlibrary
///#include  "edit/Exercise.j"
/*
    守家基分商店
*/
library_once CenterCredit initializer InitCenterCredit requires LHBase,Exercise,PIV,Multiboard
	globals
		private constant integer CREDIT_SOLIDER_1 = 2500
		private constant integer CREDIT_SOLIDER_2 = 5000
		private constant integer CREDIT_SOLIDER_3 = 8000
		private constant integer CREDIT_SOLIDER_4 = 15000
	endglobals
//---------------------------------------------------------------------------------------------------
	/*
	    积分购买雇佣兵
	*/
	private function TBuySoliderCon takes nothing returns boolean
		return (GetUnitTypeId(GetSellingUnit()) == 'uS02') and RectContainsUnit(regionM1[GetConvertedPlayerId(GetOwningPlayer(GetBuyingUnit()))],GetSellingUnit())
	endfunction
	private function TBuySoliderAct takes nothing returns nothing
		local integer index = GetConvertedPlayerId(GetOwningPlayer(GetBuyingUnit()))
		local real x
		local real y
		//! textmacro BuySoldier takes UnitType,Index
		if (GetUnitTypeId(GetSoldUnit()) == '$UnitType$') then
			if (centerCredit[index] < CREDIT_SOLIDER_$Index$) then
				call DisplayTextToPlayer(GetOwningPlayer(GetBuyingUnit()), 0., 0., "|cFFFF66CC【消息】|r你的守家积分只有"+I2S(centerCredit[index])+",不足"+I2S(CREDIT_SOLIDER_$Index$))
				call RemoveUnit(GetSoldUnit())
				return
			endif
			set centerCredit[index] = centerCredit[index] - CREDIT_SOLIDER_$Index$
			set x = GetRectCenterX(regionM$Index$[index])
			set y = GetRectCenterY(regionM$Index$[index])
			call YDWEMultiboardSetItemValueBJNull( udg_D, 9, index + 1 , I2S(centerCredit[index]) )
			call SetUnitX(GetSoldUnit(),x)
			call SetUnitY(GetSoldUnit(),y)
	        call PanCameraToTimedForPlayer(GetOwningPlayer(GetBuyingUnit()),x,y,0.2)
	        call DestroyEffect( AddSpecialEffect("Abilities\\Spells\\Human\\MassTeleport\\MassTeleportCaster.mdl", x, y))
	        call DisplayTextToPlayer(GetOwningPlayer(GetBuyingUnit()), 0., 0., "|cFFFF66CC【消息】|r雇佣成功!")
	        return
		endif
		//! endtextmacro
		//! runtextmacro BuySoldier("uG01","1")
		//! runtextmacro BuySoldier("uG02","2")
		//! runtextmacro BuySoldier("uG03","3")
		//! runtextmacro BuySoldier("uG04","4")
		if (GetUnitTypeId(GetSoldUnit()) == 'uG05') then
			if (IsPIV(GetOwningPlayer(GetBuyingUnit())) != true) then
				call DisplayTextToPlayer(GetOwningPlayer(GetBuyingUnit()), 0., 0., "|cFFFF66CC【消息】|r你不是永久赞助.")
				call RemoveUnit(GetSoldUnit())
				return
			endif
			if (udg_Bo < 18) then
				call DisplayTextToPlayer(GetOwningPlayer(GetBuyingUnit()), 0., 0., "|cFFFF66CC【消息】|r当前波数未到18波,尚未可以购买.")
				call RemoveUnit(GetSoldUnit())
				return
			endif
			set x = GetRectCenterX(regionM5[index])
			set y = GetRectCenterY(regionM5[index])
			call SetUnitX(GetSoldUnit(),x)
			call SetUnitY(GetSoldUnit(),y)
	        call PanCameraToTimedForPlayer(GetOwningPlayer(GetBuyingUnit()),x,y,0.2)
	        call DestroyEffect( AddSpecialEffect("Abilities\\Spells\\Human\\MassTeleport\\MassTeleportCaster.mdl", x, y))
	        call DisplayTextToPlayer(GetOwningPlayer(GetBuyingUnit()), 0., 0., "|cFFFF66CC【消息】|r雇佣成功!")
		endif
		if (GetUnitTypeId(GetSoldUnit()) == 'uG06') then
			if (IsPIV(GetOwningPlayer(GetBuyingUnit())) != true) then
				call DisplayTextToPlayer(GetOwningPlayer(GetBuyingUnit()), 0., 0., "|cFFFF66CC【消息】|r你不是永久赞助.")
				call RemoveUnit(GetSoldUnit())
				return
			endif
			if (udg_Bo < 22) then
				call DisplayTextToPlayer(GetOwningPlayer(GetBuyingUnit()), 0., 0., "|cFFFF66CC【消息】|r当前波数未到22波,尚未可以购买.")
				call RemoveUnit(GetSoldUnit())
				return
			endif
			set x = GetRectCenterX(regionM6[index])
			set y = GetRectCenterY(regionM6[index])
			call SetUnitX(GetSoldUnit(),x)
			call SetUnitY(GetSoldUnit(),y)
			call IssueImmediateOrder(GetSoldUnit(),"stop")
	        call PanCameraToTimedForPlayer(GetOwningPlayer(GetBuyingUnit()),x,y,0.2)
	        call DestroyEffect( AddSpecialEffect("Abilities\\Spells\\Human\\MassTeleport\\MassTeleportCaster.mdl", x, y))
	        call DisplayTextToPlayer(GetOwningPlayer(GetBuyingUnit()), 0., 0., "|cFFFF66CC【消息】|r雇佣成功!")
		endif
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    雇佣兵技能
	*/
	function SimulateDamageSoldier takes unit u returns boolean
		if (GetUnitAbilityLevel(u,'A0GZ') >= 1 and (Is20Unit(GetTriggerUnit()) or Is10Unit(GetTriggerUnit()))) then
			call DisableTrigger(GetTriggeringTrigger())
			call SetUnitLifeBJ(GetTriggerUnit(),100)
			call UnitDamageTarget( u, GetTriggerUnit(), 1000, false, true, ATTACK_TYPE_CHAOS, DAMAGE_TYPE_POISON, WEAPON_TYPE_WHOKNOWS )
			call EnableTrigger(GetTriggeringTrigger())
			return true
		endif
		return false
	endfunction
//---------------------------------------------------------------------------------------------------
	private function InitCenterCredit takes nothing returns nothing
		local trigger t = CreateTrigger()
		call TriggerRegisterAnyUnitEventBJ(t,EVENT_PLAYER_UNIT_SELL)
		call TriggerAddCondition(t,Condition(function TBuySoliderCon))
		call TriggerAddAction(t, function TBuySoliderAct)
		set t = null
	endfunction
endlibrary
// 迷你游戏
// 随机英雄
///#include  "edit/NetVersion.j"
library_once RandomHero requires LHBase,Version,PIV
	globals
		boolean array BSuiji
	endglobals
//---------------------------------------------------------------------------------------------------
	/*
	    选取一个单位组的随机人物
	*/
	private function GetRandomUnitInGroup takes group g returns unit
		local integer length = CountUnitsInGroup(g)
		local integer pos = 0
		local group temp = CreateGroup()
		local unit u = null
		local integer i = 1
		loop
			exitwhen i > ModuloInteger(DzAPI_Map_GetGameStartTime(),19) + length +udg_Second[1] + udg_Nandu_JJJ
			set pos = GetRandomInt(1,length)
			set i = i + 1
		endloop
		call GroupAddGroup(g,temp)
		loop
			exitwhen pos == 0
			set u = FirstOfGroup(temp)
		    call GroupRemoveUnit(temp, u)
			set pos = pos - 1
		endloop
		call DestroyGroup(temp)
		set temp = null
		return u
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    选取随机英雄成功与否
	*/
	private function RandomPickCondition takes nothing returns boolean
		return (RectContainsUnit(gg_rct_______c1,GetFilterUnit()) and (not(IsUnitIsSpin(GetFilterUnit()))) and IsUnitType(GetFilterUnit(),UNIT_TYPE_HERO))
	endfunction
	function RandomPick takes player p returns nothing
		local integer i = 1
		local group g = YDWEGetUnitsOfPlayerMatchingNull(Player(PLAYER_NEUTRAL_PASSIVE), Condition(function RandomPickCondition))
		local unit u = null
		if not(IsPIV(p)) then
			loop
				exitwhen i > HERO_COUNT
				if (i == 15 and not(GetHuanyiSelectedCon(p))) then
					call GroupRemoveUnit(g,gg_unit_Hant_0205)
				elseif (i == 16 and not(GetCanglingSelectedCon(p))) then
					call GroupRemoveUnit(g,gg_unit_Nsjs_0209)
				elseif (i == 18 and not(GetXinglongSelectedCon(p))) then
					call GroupRemoveUnit(g,gg_unit_Hapm_0255)
				elseif (i == 19 and not(GetXiaotingSelectedCon(p))) then
					call GroupRemoveUnit(g,gg_unit_H01Y_0286)
				endif
				set i = i +1
			endloop
		endif
		call GroupRemoveUnit(g,gg_unit_H02B_0293)
		set BSuiji[GetConvertedPlayerId(p)] = true
		set u = GetRandomUnitInGroup(g)
		call DestroyGroup(g)
		set g = null
	    call SelectUnitForPlayerSingle( u, p )
	    call SelectUnitForPlayerSingle( u, p )
	    set u = null
	endfunction
//---------------------------------------------------------------------------------------------------
	/*
	    到了5分钟后清除皮肤
	*/
	function ClearSpin takes nothing returns nothing
		local integer i = 1
		local group g = YDWEGetUnitsOfPlayerMatchingNull(Player(PLAYER_NEUTRAL_PASSIVE), Condition(function RandomPickCondition))
		local unit l_unit = null
		loop
		    set l_unit = FirstOfGroup(g)
		    exitwhen l_unit == null
		    call GroupRemoveUnit(g, l_unit)
		    if (IsUnitIsSpin(l_unit)) then
		    	call RemoveUnit(l_unit)
		    endif
		endloop
		call DestroyGroup(g)
		set g = null
		set l_unit =null
	endfunction
endlibrary
// 狂欢活动
// 连续登录
// 测试文件
/// #include "edit/Debug.j"
/// #include "edit/NotPublic.j"
/// #include "edit/DebugNet.j"
// lua_print: 正式地图
//***************************************************************************
//*
//*  Triggers
//*
//***************************************************************************
//===========================================================================
// Trigger: 简介
//===========================================================================
function Trig_______uActions takes nothing returns nothing
    // 欢迎使用世界编辑器，开始你的地图创造之旅。
    // 你可以从dz.163.com获取最新编辑器咨询。
    // 当你的地图意外损坏时，你可以在backups目录找到你最近26次保存的地图。
    // 任何疑问请加官方作者群：QQ35063417。
    // 本次更新添加判断玩家是否为平台AI玩家，现在平台已经添加虚拟玩家，不用再担心匹配没人问题了！如果你的地图有AI，试试在作者之家开启这个功能吧！
endfunction
//===========================================================================
function InitTrig_______u takes nothing returns nothing
    set gg_trg_______u = CreateTrigger()
    call DoNothing()
    call TriggerAddAction(gg_trg_______u, function Trig_______uActions)
endfunction
//===========================================================================
function InitCustomTriggers takes nothing returns nothing
    call InitTrig_______u( )
endfunction
//***************************************************************************
//*
//*  Players
//*
//***************************************************************************
function InitCustomPlayerSlots takes nothing returns nothing
    // Player 0
    call SetPlayerStartLocation( Player(0), 0 )
    call ForcePlayerStartLocation( Player(0), 0 )
    call SetPlayerColor( Player(0), ConvertPlayerColor(0) )
    call SetPlayerRacePreference( Player(0), RACE_PREF_HUMAN )
    call SetPlayerRaceSelectable( Player(0), false )
    call SetPlayerController( Player(0), MAP_CONTROL_USER )
    // Player 1
    call SetPlayerStartLocation( Player(1), 1 )
    call ForcePlayerStartLocation( Player(1), 1 )
    call SetPlayerColor( Player(1), ConvertPlayerColor(1) )
    call SetPlayerRacePreference( Player(1), RACE_PREF_HUMAN )
    call SetPlayerRaceSelectable( Player(1), false )
    call SetPlayerController( Player(1), MAP_CONTROL_USER )
    // Player 2
    call SetPlayerStartLocation( Player(2), 2 )
    call ForcePlayerStartLocation( Player(2), 2 )
    call SetPlayerColor( Player(2), ConvertPlayerColor(2) )
    call SetPlayerRacePreference( Player(2), RACE_PREF_HUMAN )
    call SetPlayerRaceSelectable( Player(2), false )
    call SetPlayerController( Player(2), MAP_CONTROL_USER )
    // Player 3
    call SetPlayerStartLocation( Player(3), 3 )
    call ForcePlayerStartLocation( Player(3), 3 )
    call SetPlayerColor( Player(3), ConvertPlayerColor(3) )
    call SetPlayerRacePreference( Player(3), RACE_PREF_HUMAN )
    call SetPlayerRaceSelectable( Player(3), false )
    call SetPlayerController( Player(3), MAP_CONTROL_USER )
    // Player 4
    call SetPlayerStartLocation( Player(4), 4 )
    call ForcePlayerStartLocation( Player(4), 4 )
    call SetPlayerColor( Player(4), ConvertPlayerColor(4) )
    call SetPlayerRacePreference( Player(4), RACE_PREF_NIGHTELF )
    call SetPlayerRaceSelectable( Player(4), false )
    call SetPlayerController( Player(4), MAP_CONTROL_COMPUTER )
    // Player 5
    call SetPlayerStartLocation( Player(5), 5 )
    call ForcePlayerStartLocation( Player(5), 5 )
    call SetPlayerColor( Player(5), ConvertPlayerColor(5) )
    call SetPlayerRacePreference( Player(5), RACE_PREF_NIGHTELF )
    call SetPlayerRaceSelectable( Player(5), false )
    call SetPlayerController( Player(5), MAP_CONTROL_COMPUTER )
    // Player 6
    call SetPlayerStartLocation( Player(6), 6 )
    call ForcePlayerStartLocation( Player(6), 6 )
    call SetPlayerColor( Player(6), ConvertPlayerColor(6) )
    call SetPlayerRacePreference( Player(6), RACE_PREF_NIGHTELF )
    call SetPlayerRaceSelectable( Player(6), false )
    call SetPlayerController( Player(6), MAP_CONTROL_COMPUTER )
    // Player 7
    call SetPlayerStartLocation( Player(7), 7 )
    call ForcePlayerStartLocation( Player(7), 7 )
    call SetPlayerColor( Player(7), ConvertPlayerColor(7) )
    call SetPlayerRacePreference( Player(7), RACE_PREF_NIGHTELF )
    call SetPlayerRaceSelectable( Player(7), false )
    call SetPlayerController( Player(7), MAP_CONTROL_COMPUTER )
    // Player 8
    call SetPlayerStartLocation( Player(8), 8 )
    call ForcePlayerStartLocation( Player(8), 8 )
    call SetPlayerColor( Player(8), ConvertPlayerColor(8) )
    call SetPlayerRacePreference( Player(8), RACE_PREF_NIGHTELF )
    call SetPlayerRaceSelectable( Player(8), false )
    call SetPlayerController( Player(8), MAP_CONTROL_COMPUTER )
    // Player 9
    call SetPlayerStartLocation( Player(9), 9 )
    call ForcePlayerStartLocation( Player(9), 9 )
    call SetPlayerColor( Player(9), ConvertPlayerColor(9) )
    call SetPlayerRacePreference( Player(9), RACE_PREF_UNDEAD )
    call SetPlayerRaceSelectable( Player(9), false )
    call SetPlayerController( Player(9), MAP_CONTROL_COMPUTER )
    // Player 10
    call SetPlayerStartLocation( Player(10), 10 )
    call ForcePlayerStartLocation( Player(10), 10 )
    call SetPlayerColor( Player(10), ConvertPlayerColor(10) )
    call SetPlayerRacePreference( Player(10), RACE_PREF_UNDEAD )
    call SetPlayerRaceSelectable( Player(10), false )
    call SetPlayerController( Player(10), MAP_CONTROL_COMPUTER )
    // Player 11
    call SetPlayerStartLocation( Player(11), 11 )
    call ForcePlayerStartLocation( Player(11), 11 )
    call SetPlayerColor( Player(11), ConvertPlayerColor(11) )
    call SetPlayerRacePreference( Player(11), RACE_PREF_UNDEAD )
    call SetPlayerRaceSelectable( Player(11), false )
    call SetPlayerController( Player(11), MAP_CONTROL_COMPUTER )
endfunction
function InitCustomTeams takes nothing returns nothing
    // Force: TRIGSTR_013
    call SetPlayerTeam( Player(0), 0 )
    call SetPlayerTeam( Player(1), 0 )
    call SetPlayerTeam( Player(2), 0 )
    call SetPlayerTeam( Player(3), 0 )
    call SetPlayerTeam( Player(4), 0 )
    call SetPlayerTeam( Player(5), 0 )
    call SetPlayerTeam( Player(6), 0 )
    call SetPlayerTeam( Player(7), 0 )
    call SetPlayerTeam( Player(8), 0 )
    //   Allied
    call SetPlayerAllianceStateAllyBJ( Player(0), Player(1), true )
    call SetPlayerAllianceStateAllyBJ( Player(0), Player(2), true )
    call SetPlayerAllianceStateAllyBJ( Player(0), Player(3), true )
    call SetPlayerAllianceStateAllyBJ( Player(0), Player(4), true )
    call SetPlayerAllianceStateAllyBJ( Player(0), Player(5), true )
    call SetPlayerAllianceStateAllyBJ( Player(0), Player(6), true )
    call SetPlayerAllianceStateAllyBJ( Player(0), Player(7), true )
    call SetPlayerAllianceStateAllyBJ( Player(0), Player(8), true )
    call SetPlayerAllianceStateAllyBJ( Player(1), Player(0), true )
    call SetPlayerAllianceStateAllyBJ( Player(1), Player(2), true )
    call SetPlayerAllianceStateAllyBJ( Player(1), Player(3), true )
    call SetPlayerAllianceStateAllyBJ( Player(1), Player(4), true )
    call SetPlayerAllianceStateAllyBJ( Player(1), Player(5), true )
    call SetPlayerAllianceStateAllyBJ( Player(1), Player(6), true )
    call SetPlayerAllianceStateAllyBJ( Player(1), Player(7), true )
    call SetPlayerAllianceStateAllyBJ( Player(1), Player(8), true )
    call SetPlayerAllianceStateAllyBJ( Player(2), Player(0), true )
    call SetPlayerAllianceStateAllyBJ( Player(2), Player(1), true )
    call SetPlayerAllianceStateAllyBJ( Player(2), Player(3), true )
    call SetPlayerAllianceStateAllyBJ( Player(2), Player(4), true )
    call SetPlayerAllianceStateAllyBJ( Player(2), Player(5), true )
    call SetPlayerAllianceStateAllyBJ( Player(2), Player(6), true )
    call SetPlayerAllianceStateAllyBJ( Player(2), Player(7), true )
    call SetPlayerAllianceStateAllyBJ( Player(2), Player(8), true )
    call SetPlayerAllianceStateAllyBJ( Player(3), Player(0), true )
    call SetPlayerAllianceStateAllyBJ( Player(3), Player(1), true )
    call SetPlayerAllianceStateAllyBJ( Player(3), Player(2), true )
    call SetPlayerAllianceStateAllyBJ( Player(3), Player(4), true )
    call SetPlayerAllianceStateAllyBJ( Player(3), Player(5), true )
    call SetPlayerAllianceStateAllyBJ( Player(3), Player(6), true )
    call SetPlayerAllianceStateAllyBJ( Player(3), Player(7), true )
    call SetPlayerAllianceStateAllyBJ( Player(3), Player(8), true )
    call SetPlayerAllianceStateAllyBJ( Player(4), Player(0), true )
    call SetPlayerAllianceStateAllyBJ( Player(4), Player(1), true )
    call SetPlayerAllianceStateAllyBJ( Player(4), Player(2), true )
    call SetPlayerAllianceStateAllyBJ( Player(4), Player(3), true )
    call SetPlayerAllianceStateAllyBJ( Player(4), Player(5), true )
    call SetPlayerAllianceStateAllyBJ( Player(4), Player(6), true )
    call SetPlayerAllianceStateAllyBJ( Player(4), Player(7), true )
    call SetPlayerAllianceStateAllyBJ( Player(4), Player(8), true )
    call SetPlayerAllianceStateAllyBJ( Player(5), Player(0), true )
    call SetPlayerAllianceStateAllyBJ( Player(5), Player(1), true )
    call SetPlayerAllianceStateAllyBJ( Player(5), Player(2), true )
    call SetPlayerAllianceStateAllyBJ( Player(5), Player(3), true )
    call SetPlayerAllianceStateAllyBJ( Player(5), Player(4), true )
    call SetPlayerAllianceStateAllyBJ( Player(5), Player(6), true )
    call SetPlayerAllianceStateAllyBJ( Player(5), Player(7), true )
    call SetPlayerAllianceStateAllyBJ( Player(5), Player(8), true )
    call SetPlayerAllianceStateAllyBJ( Player(6), Player(0), true )
    call SetPlayerAllianceStateAllyBJ( Player(6), Player(1), true )
    call SetPlayerAllianceStateAllyBJ( Player(6), Player(2), true )
    call SetPlayerAllianceStateAllyBJ( Player(6), Player(3), true )
    call SetPlayerAllianceStateAllyBJ( Player(6), Player(4), true )
    call SetPlayerAllianceStateAllyBJ( Player(6), Player(5), true )
    call SetPlayerAllianceStateAllyBJ( Player(6), Player(7), true )
    call SetPlayerAllianceStateAllyBJ( Player(6), Player(8), true )
    call SetPlayerAllianceStateAllyBJ( Player(7), Player(0), true )
    call SetPlayerAllianceStateAllyBJ( Player(7), Player(1), true )
    call SetPlayerAllianceStateAllyBJ( Player(7), Player(2), true )
    call SetPlayerAllianceStateAllyBJ( Player(7), Player(3), true )
    call SetPlayerAllianceStateAllyBJ( Player(7), Player(4), true )
    call SetPlayerAllianceStateAllyBJ( Player(7), Player(5), true )
    call SetPlayerAllianceStateAllyBJ( Player(7), Player(6), true )
    call SetPlayerAllianceStateAllyBJ( Player(7), Player(8), true )
    call SetPlayerAllianceStateAllyBJ( Player(8), Player(0), true )
    call SetPlayerAllianceStateAllyBJ( Player(8), Player(1), true )
    call SetPlayerAllianceStateAllyBJ( Player(8), Player(2), true )
    call SetPlayerAllianceStateAllyBJ( Player(8), Player(3), true )
    call SetPlayerAllianceStateAllyBJ( Player(8), Player(4), true )
    call SetPlayerAllianceStateAllyBJ( Player(8), Player(5), true )
    call SetPlayerAllianceStateAllyBJ( Player(8), Player(6), true )
    call SetPlayerAllianceStateAllyBJ( Player(8), Player(7), true )
    //   Shared Vision
    call SetPlayerAllianceStateVisionBJ( Player(0), Player(1), true )
    call SetPlayerAllianceStateVisionBJ( Player(0), Player(2), true )
    call SetPlayerAllianceStateVisionBJ( Player(0), Player(3), true )
    call SetPlayerAllianceStateVisionBJ( Player(0), Player(4), true )
    call SetPlayerAllianceStateVisionBJ( Player(0), Player(5), true )
    call SetPlayerAllianceStateVisionBJ( Player(0), Player(6), true )
    call SetPlayerAllianceStateVisionBJ( Player(0), Player(7), true )
    call SetPlayerAllianceStateVisionBJ( Player(0), Player(8), true )
    call SetPlayerAllianceStateVisionBJ( Player(1), Player(0), true )
    call SetPlayerAllianceStateVisionBJ( Player(1), Player(2), true )
    call SetPlayerAllianceStateVisionBJ( Player(1), Player(3), true )
    call SetPlayerAllianceStateVisionBJ( Player(1), Player(4), true )
    call SetPlayerAllianceStateVisionBJ( Player(1), Player(5), true )
    call SetPlayerAllianceStateVisionBJ( Player(1), Player(6), true )
    call SetPlayerAllianceStateVisionBJ( Player(1), Player(7), true )
    call SetPlayerAllianceStateVisionBJ( Player(1), Player(8), true )
    call SetPlayerAllianceStateVisionBJ( Player(2), Player(0), true )
    call SetPlayerAllianceStateVisionBJ( Player(2), Player(1), true )
    call SetPlayerAllianceStateVisionBJ( Player(2), Player(3), true )
    call SetPlayerAllianceStateVisionBJ( Player(2), Player(4), true )
    call SetPlayerAllianceStateVisionBJ( Player(2), Player(5), true )
    call SetPlayerAllianceStateVisionBJ( Player(2), Player(6), true )
    call SetPlayerAllianceStateVisionBJ( Player(2), Player(7), true )
    call SetPlayerAllianceStateVisionBJ( Player(2), Player(8), true )
    call SetPlayerAllianceStateVisionBJ( Player(3), Player(0), true )
    call SetPlayerAllianceStateVisionBJ( Player(3), Player(1), true )
    call SetPlayerAllianceStateVisionBJ( Player(3), Player(2), true )
    call SetPlayerAllianceStateVisionBJ( Player(3), Player(4), true )
    call SetPlayerAllianceStateVisionBJ( Player(3), Player(5), true )
    call SetPlayerAllianceStateVisionBJ( Player(3), Player(6), true )
    call SetPlayerAllianceStateVisionBJ( Player(3), Player(7), true )
    call SetPlayerAllianceStateVisionBJ( Player(3), Player(8), true )
    call SetPlayerAllianceStateVisionBJ( Player(4), Player(0), true )
    call SetPlayerAllianceStateVisionBJ( Player(4), Player(1), true )
    call SetPlayerAllianceStateVisionBJ( Player(4), Player(2), true )
    call SetPlayerAllianceStateVisionBJ( Player(4), Player(3), true )
    call SetPlayerAllianceStateVisionBJ( Player(4), Player(5), true )
    call SetPlayerAllianceStateVisionBJ( Player(4), Player(6), true )
    call SetPlayerAllianceStateVisionBJ( Player(4), Player(7), true )
    call SetPlayerAllianceStateVisionBJ( Player(4), Player(8), true )
    call SetPlayerAllianceStateVisionBJ( Player(5), Player(0), true )
    call SetPlayerAllianceStateVisionBJ( Player(5), Player(1), true )
    call SetPlayerAllianceStateVisionBJ( Player(5), Player(2), true )
    call SetPlayerAllianceStateVisionBJ( Player(5), Player(3), true )
    call SetPlayerAllianceStateVisionBJ( Player(5), Player(4), true )
    call SetPlayerAllianceStateVisionBJ( Player(5), Player(6), true )
    call SetPlayerAllianceStateVisionBJ( Player(5), Player(7), true )
    call SetPlayerAllianceStateVisionBJ( Player(5), Player(8), true )
    call SetPlayerAllianceStateVisionBJ( Player(6), Player(0), true )
    call SetPlayerAllianceStateVisionBJ( Player(6), Player(1), true )
    call SetPlayerAllianceStateVisionBJ( Player(6), Player(2), true )
    call SetPlayerAllianceStateVisionBJ( Player(6), Player(3), true )
    call SetPlayerAllianceStateVisionBJ( Player(6), Player(4), true )
    call SetPlayerAllianceStateVisionBJ( Player(6), Player(5), true )
    call SetPlayerAllianceStateVisionBJ( Player(6), Player(7), true )
    call SetPlayerAllianceStateVisionBJ( Player(6), Player(8), true )
    call SetPlayerAllianceStateVisionBJ( Player(7), Player(0), true )
    call SetPlayerAllianceStateVisionBJ( Player(7), Player(1), true )
    call SetPlayerAllianceStateVisionBJ( Player(7), Player(2), true )
    call SetPlayerAllianceStateVisionBJ( Player(7), Player(3), true )
    call SetPlayerAllianceStateVisionBJ( Player(7), Player(4), true )
    call SetPlayerAllianceStateVisionBJ( Player(7), Player(5), true )
    call SetPlayerAllianceStateVisionBJ( Player(7), Player(6), true )
    call SetPlayerAllianceStateVisionBJ( Player(7), Player(8), true )
    call SetPlayerAllianceStateVisionBJ( Player(8), Player(0), true )
    call SetPlayerAllianceStateVisionBJ( Player(8), Player(1), true )
    call SetPlayerAllianceStateVisionBJ( Player(8), Player(2), true )
    call SetPlayerAllianceStateVisionBJ( Player(8), Player(3), true )
    call SetPlayerAllianceStateVisionBJ( Player(8), Player(4), true )
    call SetPlayerAllianceStateVisionBJ( Player(8), Player(5), true )
    call SetPlayerAllianceStateVisionBJ( Player(8), Player(6), true )
    call SetPlayerAllianceStateVisionBJ( Player(8), Player(7), true )
    // Force: TRIGSTR_014
    call SetPlayerTeam( Player(9), 1 )
    call SetPlayerTeam( Player(10), 1 )
    call SetPlayerTeam( Player(11), 1 )
    //   Allied
    call SetPlayerAllianceStateAllyBJ( Player(9), Player(10), true )
    call SetPlayerAllianceStateAllyBJ( Player(9), Player(11), true )
    call SetPlayerAllianceStateAllyBJ( Player(10), Player(9), true )
    call SetPlayerAllianceStateAllyBJ( Player(10), Player(11), true )
    call SetPlayerAllianceStateAllyBJ( Player(11), Player(9), true )
    call SetPlayerAllianceStateAllyBJ( Player(11), Player(10), true )
    //   Shared Vision
    call SetPlayerAllianceStateVisionBJ( Player(9), Player(10), true )
    call SetPlayerAllianceStateVisionBJ( Player(9), Player(11), true )
    call SetPlayerAllianceStateVisionBJ( Player(10), Player(9), true )
    call SetPlayerAllianceStateVisionBJ( Player(10), Player(11), true )
    call SetPlayerAllianceStateVisionBJ( Player(11), Player(9), true )
    call SetPlayerAllianceStateVisionBJ( Player(11), Player(10), true )
endfunction
function InitAllyPriorities takes nothing returns nothing
    call SetStartLocPrioCount( 0, 3 )
    call SetStartLocPrio( 0, 0, 1, MAP_LOC_PRIO_HIGH )
    call SetStartLocPrio( 0, 1, 2, MAP_LOC_PRIO_HIGH )
    call SetStartLocPrio( 0, 2, 3, MAP_LOC_PRIO_HIGH )
    call SetStartLocPrioCount( 1, 3 )
    call SetStartLocPrio( 1, 0, 0, MAP_LOC_PRIO_HIGH )
    call SetStartLocPrio( 1, 1, 2, MAP_LOC_PRIO_HIGH )
    call SetStartLocPrio( 1, 2, 3, MAP_LOC_PRIO_HIGH )
    call SetStartLocPrioCount( 2, 3 )
    call SetStartLocPrio( 2, 0, 0, MAP_LOC_PRIO_HIGH )
    call SetStartLocPrio( 2, 1, 1, MAP_LOC_PRIO_HIGH )
    call SetStartLocPrio( 2, 2, 3, MAP_LOC_PRIO_HIGH )
    call SetStartLocPrioCount( 3, 3 )
    call SetStartLocPrio( 3, 0, 0, MAP_LOC_PRIO_HIGH )
    call SetStartLocPrio( 3, 1, 1, MAP_LOC_PRIO_HIGH )
    call SetStartLocPrio( 3, 2, 2, MAP_LOC_PRIO_HIGH )
endfunction
//***************************************************************************
//*
//*  Main Initialization
//*
//***************************************************************************
//===========================================================================
function main takes nothing returns nothing
    call initializeLua() <?='\n'?> call SetCameraBounds( -13568.0 + GetCameraMargin(CAMERA_MARGIN_LEFT), -13824.0 + GetCameraMargin(CAMERA_MARGIN_BOTTOM), 13568.0 - GetCameraMargin(CAMERA_MARGIN_RIGHT), 13312.0 - GetCameraMargin(CAMERA_MARGIN_TOP), -13568.0 + GetCameraMargin(CAMERA_MARGIN_LEFT), 13312.0 - GetCameraMargin(CAMERA_MARGIN_TOP), 13568.0 - GetCameraMargin(CAMERA_MARGIN_RIGHT), -13824.0 + GetCameraMargin(CAMERA_MARGIN_BOTTOM) )
    call SetDayNightModels( "Environment\\DNC\\DNCLordaeron\\DNCLordaeronTerrain\\DNCLordaeronTerrain.mdl", "Environment\\DNC\\DNCLordaeron\\DNCLordaeronUnit\\DNCLordaeronUnit.mdl" )
    call NewSoundEnvironment( "Default" )
    call SetAmbientDaySound( "NorthrendDay" )
    call SetAmbientNightSound( "NorthrendNight" )
    call SetMapMusic( "Music", true, 0 )
    call CreateRegions( )
    call CreateAllUnits( )
    call InitBlizzard( )
    call InitGlobals( )
    call InitCustomTriggers( )
endfunction
//***************************************************************************
//*
//*  Map Configuration
//*
//***************************************************************************
function config takes nothing returns nothing
    call SetMapName( "TRIGSTR_1232" )
    call SetMapDescription( "TRIGSTR_1234" )
    call SetPlayers( 12 )
    call SetTeams( 12 )
    call SetGamePlacement( MAP_PLACEMENT_TEAMS_TOGETHER )
    call DefineStartLocation( 0, 0.0, 0.0 )
    call DefineStartLocation( 1, 0.0, 0.0 )
    call DefineStartLocation( 2, 0.0, 0.0 )
    call DefineStartLocation( 3, 0.0, 0.0 )
    call DefineStartLocation( 4, 0.0, 0.0 )
    call DefineStartLocation( 5, 0.0, 0.0 )
    call DefineStartLocation( 6, 0.0, 0.0 )
    call DefineStartLocation( 7, 0.0, 0.0 )
    call DefineStartLocation( 8, 0.0, 0.0 )
    call DefineStartLocation( 9, 0.0, 0.0 )
    call DefineStartLocation( 10, 0.0, 0.0 )
    call DefineStartLocation( 11, 0.0, 0.0 )
    // Player setup
    call InitCustomPlayerSlots( )
    call InitCustomTeams( )
    call InitAllyPriorities( )
endfunction
/**/
